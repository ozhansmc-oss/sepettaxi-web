<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi – Canlı Takip</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
:root{
  --y:#f5c400; --line:rgba(255,255,255,.10);
  --ok:#3ddc97; --bad:#ff5a5f;
}
#map{position:absolute;inset:0}
.leaflet-control-zoom,.leaflet-control-attribution{display:none!important}

/* overlay */
.overlay{
  position:fixed;inset:0;z-index:2000;
  background:rgba(0,0,0,.65);
  display:none;align-items:center;justify-content:center
}
.overlay.on{display:flex}
.card{
  background:#141416;border-radius:18px;padding:16px;
  border:1px solid var(--line);text-align:center
}
.spin{
  width:44px;height:44px;border-radius:50%;
  border:4px solid rgba(255,255,255,.2);
  border-top-color:var(--y);
  animation:rot 1s linear infinite;margin:0 auto 10px
}
@keyframes rot{to{transform:rotate(360deg)}}

/* marker */
.iconWrap{
  width:34px;height:34px;border-radius:16px;
  display:grid;place-items:center;
  background:rgba(15,15,16,.95);
  border:1px solid rgba(255,255,255,.2)
}
</style>
</head>

<body>

<div id="map"></div>

<div class="overlay on" id="wait">
  <div class="card">
    <div class="spin"></div>
    <b>Sürücü aranıyor</b>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API="https://script.google.com/macros/s/AKfycbz5Qk4OSBwQ1NCf09EGfczk7I8d3pRUSihE6xpb69mFRSf-MfNactwUxEQrNBYh6GcM/exec";
const job_id = new URLSearchParams(location.search).get("job_id");

/* ================= API ================= */
async function api(action,p){
  const r = await fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({action,...p})
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error||"API_ERROR");
  return j;
}

/* ================= MAP ================= */
const map = L.map("map",{zoomControl:false}).setView([40.195,29.06],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ================= ICONS ================= */
function icon(svg){
  return L.divIcon({
    className:"",
    html:`<div class="iconWrap">${svg}</div>`,
    iconSize:[34,34],
    iconAnchor:[17,17]
  });
}
const taxiSVG = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none">
<path d="M7 16h10l1-5-2-4H8l-2 4 1 5Z" stroke="white" stroke-width="2"/>
<circle cx="8.5" cy="18.5" r="1.5" fill="white"/>
<circle cx="15.5" cy="18.5" r="1.5" fill="white"/></svg>`;
const motoSVG = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none">
<path d="M7 16h4l2-6h5l2 6" stroke="white" stroke-width="2"/>
<circle cx="7" cy="16" r="2" stroke="white" stroke-width="2"/>
<circle cx="19" cy="16" r="2" stroke="white" stroke-width="2"/></svg>`;

/* ================= STATE ================= */
let driverMarker=null;
let lastLatLng=null;

/* smooth move */
function moveMarker(marker, to, duration=800){
  const from = marker.getLatLng();
  const start = performance.now();
  function anim(t){
    const p = Math.min((t-start)/duration,1);
    const lat = from.lat + (to.lat-from.lat)*p;
    const lng = from.lng + (to.lng-from.lng)*p;
    marker.setLatLng([lat,lng]);
    if(p<1) requestAnimationFrame(anim);
  }
  requestAnimationFrame(anim);
}

/* ================= POLLING ================= */
async function tick(){
  try{
    const s = await api("getJobStatus",{ job_id });
    if(s.status==="open"){
      wait.classList.add("on");
      return;
    }
    wait.classList.remove("on");

    const live = await api("getLiveLocation",{ job_id });
    if(!live.has_driver || !live.lat) return;

    const pos = { lat:live.lat, lng:live.lng };
    if(!driverMarker){
      driverMarker = L.marker(pos,{ icon:icon(taxiSVG) }).addTo(map);
      map.setView(pos,15);
      lastLatLng = pos;
    }else{
      moveMarker(driverMarker, pos);
      lastLatLng = pos;
    }
  }catch(e){
    console.error(e);
  }
}

setInterval(tick,3000);
tick();
</script>

</body>
</html>
