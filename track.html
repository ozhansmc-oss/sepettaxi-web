<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222
}
header span{color:#f5c400}
#map{height:calc(100vh - 56px)}
.status{
  position:fixed;top:70px;left:50%;transform:translateX(-50%);
  background:#111;border:1px solid #333;
  padding:6px 14px;border-radius:999px;
  font-size:13px;z-index:1000
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> – Takip</header>
<div class="status" id="status">Yükleniyor…</div>
<div id="map"></div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const urlParams = new URLSearchParams(location.search);
const JOB_ID = urlParams.get("job_id");

if(!JOB_ID){
  alert("job_id bulunamadı");
  throw new Error("job_id yok");
}

let map;
let pickupM, dropM, driverM;
let routeLine;

function initMap(){
  map = L.map("map",{zoomControl:true}).setView([41,29],12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  setTimeout(()=>map.invalidateSize(),200);
}

async function loadJob(){
  const job = await fetch(
    `${BACKEND}?action=checkJob&job_id=${JOB_ID}`
  ).then(r=>r.json());

  if(!job || job.error){
    document.getElementById("status").innerText="İş bulunamadı";
    return;
  }

  document.getElementById("status").innerText =
    job.status==="on_route" ? "Sürücü yolda" :
    job.status==="assigned" ? "Sürücü atandı" :
    job.status==="completed" ? "İş tamamlandı" : job.status;

  const jobs = await fetch(`${BACKEND}?action=getJobs`).then(r=>r.json());
  const j = jobs.find(x=>x.job_id===JOB_ID);
  if(!j) return;

  // Pickup
  if(!pickupM){
    pickupM = L.marker([j.pickup_lat,j.pickup_lng])
      .addTo(map).bindPopup("Alış Noktası");
  }

  // Dropoff
  if(!dropM){
    dropM = L.marker([j.dropoff_lat,j.dropoff_lng])
      .addTo(map).bindPopup("Varış Noktası");
  }

  // Driver
  if(j.driver_lat && j.driver_lng){
    if(!driverM){
      driverM = L.marker([j.driver_lat,j.driver_lng])
        .addTo(map).bindPopup("Sürücü");
    }else{
      driverM.setLatLng([j.driver_lat,j.driver_lng]);
    }
  }

  drawRoute(j);
}

function drawRoute(j){
  if(!driverM) return;

  const points = [
    [j.pickup_lat,j.pickup_lng],
    [j.driver_lat,j.driver_lng],
    [j.dropoff_lat,j.dropoff_lng]
  ];

  if(routeLine){
    routeLine.setLatLngs(points);
  }else{
    routeLine = L.polyline(points,{
      color:"#f5c400",
      weight:5,
      dashArray:"8,6"
    }).addTo(map);
  }

  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}

initMap();
loadJob();
setInterval(loadJob,4000);
</script>

</body>
</html>
