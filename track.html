<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi ‚Äì Takip</title>
<meta name="theme-color" content="#050506" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;overflow:hidden;background:#050506;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
:root{
  --y:#f5c400; --line:rgba(255,255,255,.10);
  --mut:rgba(255,255,255,.62); --mut2:rgba(255,255,255,.42);
}
#app{position:fixed;inset:0;display:flex;flex-direction:column}
#topbar{
  height:56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#0b0b0c,#070708);
}
.logo{font-weight:950;font-size:18px}
.logo span{color:var(--y)}
.iconBtn{
  width:38px;height:38px;border-radius:12px;display:grid;place-items:center;
  border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.03);opacity:.92;
  user-select:none;
}
#stage{position:relative;flex:1}
#map{width:100%;height:100%}
#mapVignette{
  position:absolute;inset:0;pointer-events:none;z-index:3;
  background:
    radial-gradient(120% 80% at 50% 0%, rgba(0,0,0,.55), rgba(0,0,0,.08) 55%, rgba(0,0,0,.45)),
    linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,0) 55%);
}
.overlay{
  position:absolute;left:50%;transform:translateX(-50%);
  z-index:5;
  background:rgba(15,15,16,.80);
  border:1px solid rgba(255,255,255,.12);
  border-radius:999px;padding:8px 12px;
  backdrop-filter:blur(14px);
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  font-size:13px;color:#fff;font-weight:900;
  display:flex;align-items:center;gap:8px;
}
.badge{width:10px;height:10px;border-radius:50%;background:var(--y);
  box-shadow:0 0 0 0 rgba(245,196,0,.35);animation:pulse 1.25s ease infinite}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(245,196,0,.35)}
  70%{box-shadow:0 0 0 18px rgba(245,196,0,0)}
  100%{box-shadow:0 0 0 0 rgba(245,196,0,0)}
}
#status{top:16px}
#eta{top:60px;opacity:.9;font-weight:800;color:rgba(255,255,255,.9)}
#eta b{color:#fff}

#bottom{
  position:absolute;left:12px;right:12px;bottom:12px;z-index:6;
  background:rgba(15,15,16,.86);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;padding:12px;
  backdrop-filter:blur(16px);
  box-shadow:0 24px 80px rgba(0,0,0,.65);
}
.row{display:flex;justify-content:space-between;gap:10px;align-items:center}
.k{font-size:12px;color:var(--mut2)}
.v{font-weight:950}
.small{font-size:12px;color:var(--mut);margin-top:6px;line-height:1.35}
</style>
</head>

<body>
<div id="app">
  <div id="topbar">
    <div class="iconBtn" id="backBtn">‚Üê</div>
    <div class="logo">Sepet<span>Taxi</span></div>
    <div class="iconBtn" id="helpBtn">?</div>
  </div>

  <div id="stage">
    <div id="map"></div>
    <div id="mapVignette"></div>

    <div class="overlay" id="status"><div class="badge"></div><span id="statusTxt">Takip ba≈ülatƒ±lƒ±yor‚Ä¶</span></div>
    <div class="overlay" id="eta"><span id="etaTxt">ETA: <b>‚Äî</b></span></div>

    <div id="bottom">
      <div class="row">
        <div>
          <div class="k">ƒ∞≈ü No</div>
          <div class="v" id="jobId">‚Äî</div>
        </div>
        <div style="text-align:right">
          <div class="k">Hizmet</div>
          <div class="v" id="svc">‚Äî</div>
        </div>
      </div>
      <div class="small" id="hint">Konum g√ºncelleniyor‚Ä¶</div>
    </div>
  </div>
</div>

<script>
const API =
  "https://script.google.com/macros/s/AKfycbxoeXl9XfxWtsqqCfftNV578KD_woNSKfT3KmSYwZuCv8iPSPd8-cZXNoYMh6Qx-yrlWA/exec";

const qs = new URLSearchParams(location.search);
const job_id = qs.get("job_id") || "";
const service = (qs.get("service") || "taxi").toLowerCase();

document.getElementById("jobId").textContent = job_id || "‚Äî";
document.getElementById("svc").textContent = (service==="courier") ? "Kurye" : "Taksi";

document.getElementById("backBtn").onclick = ()=>history.back();

async function apiGet(action, params={}){
  const q = new URLSearchParams({action, ...params}).toString();
  const r = await fetch(API + "?" + q, { method:"GET" });
  return await r.json().catch(()=> ({}));
}
async function apiPost(action, data={}){
  const r = await fetch(API, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action, ...data })
  });
  return await r.json().catch(()=> ({}));
}
async function api(action, data){
  try{
    const g = await apiGet(action, data || {});
    if(!g || g.error) throw new Error(g?.error || "GET failed");
    return g;
  }catch(e){
    const p = await apiPost(action, data || {});
    if(p && !p.error) return p;
    throw new Error(p?.error || e.message || "API failed");
  }
}

const map = L.map("map",{zoomControl:false}).setView([41.0369,28.9850],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:""}).addTo(map);

const pickupMarker = L.circleMarker([0,0], {radius:7,color:"#f5c400",weight:2,fillColor:"#f5c400",fillOpacity:1});
const dropMarker   = L.circleMarker([0,0], {radius:7,color:"#7CFF9B",weight:2,fillColor:"#7CFF9B",fillOpacity:1});
let routeLine = null;

// Vehicle icon (taksi: üöï, kurye: üèçÔ∏è)
const vehicleIcon = L.divIcon({
  className:"veh",
  html:`<div style="
    width:34px;height:34px;border-radius:16px;
    display:grid;place-items:center;
    background:rgba(15,15,16,.78);
    border:1px solid rgba(255,255,255,.12);
    backdrop-filter:blur(12px);
    box-shadow:0 18px 50px rgba(0,0,0,.55);
    font-size:18px
  ">${service==="courier"?"üèçÔ∏è":"üöï"}</div>`,
  iconSize:[34,34],
  iconAnchor:[17,17]
});
let vehicleMarker = L.marker([0,0], {icon:vehicleIcon});

let pickup=null, drop=null;
let driver=null;
let animT=0;
let lastAnimTs=0;

function setStatus(txt){
  document.getElementById("statusTxt").textContent = txt;
}
function setEtaMinutes(min){
  if(min==null || !isFinite(min)) document.getElementById("etaTxt").innerHTML = `ETA: <b>‚Äî</b>`;
  else document.getElementById("etaTxt").innerHTML = `ETA: <b>${Math.max(1, Math.round(min))} dk</b>`;
}

function drawRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  if(!(pickup && drop)) return;

  const pts = [[pickup.lat,pickup.lng],[drop.lat,drop.lng]];
  routeLine = L.polyline(pts,{color:"#f5c400",weight:4,opacity:.95,dashArray:"10 10"}).addTo(map);
  map.fitBounds(L.latLngBounds(pts).pad(0.25), {animate:true, duration:0.55});
}

function lerp(a,b,t){ return a + (b-a)*t; }
function animateVehicle(ts){
  if(!(pickup && drop)) return requestAnimationFrame(animateVehicle);
  if(!lastAnimTs) lastAnimTs = ts;
  const dt = (ts - lastAnimTs)/1000;
  lastAnimTs = ts;

  // Eƒüer driver konumu geliyorsa onu kullan (direct)
  if(driver && isFinite(driver.lat) && isFinite(driver.lng)){
    vehicleMarker.setLatLng([driver.lat, driver.lng]);
    requestAnimationFrame(animateVehicle);
    return;
  }

  // Yoksa demo animasyon: pickup->drop boyunca yava≈ü hareket
  animT += dt * 0.04; // hƒ±z
  if(animT > 1) animT = 1;

  const lat = lerp(pickup.lat, drop.lat, animT);
  const lng = lerp(pickup.lng, drop.lng, animT);
  vehicleMarker.setLatLng([lat,lng]);

  requestAnimationFrame(animateVehicle);
}

async function refresh(){
  if(!job_id){
    setStatus("job_id bulunamadƒ±");
    return;
  }
  try{
    const j = await api("getJob", { job_id });
    const job = j.job || j.data || j;

    const st = (job.status || "searching").toLowerCase();
    const hint =
      st==="searching" ? "S√ºr√ºc√º aranƒ±yor‚Ä¶" :
      st==="assigned" ? "S√ºr√ºc√º atandƒ±." :
      st==="on_the_way" ? "S√ºr√ºc√º yolda." :
      st==="arrived" ? "S√ºr√ºc√º geldi." :
      st==="completed" ? "ƒ∞≈ü tamamlandƒ±." :
      "Durum g√ºncelleniyor‚Ä¶";
    setStatus(hint);
    document.getElementById("hint").textContent = "Durum: " + st;

    // pickup / drop
    const pLat = Number(job.pickup_lat ?? job.pickupLat);
    const pLng = Number(job.pickup_lng ?? job.pickupLng);
    const dLat = Number(job.dropoff_lat ?? job.dropoffLat);
    const dLng = Number(job.dropoff_lng ?? job.dropoffLng);

    if(isFinite(pLat) && isFinite(pLng) && (!pickup || pickup.lat!==pLat || pickup.lng!==pLng)){
      pickup = {lat:pLat,lng:pLng};
      pickupMarker.setLatLng([pLat,pLng]).addTo(map);
      if(!vehicleMarker._map){
        vehicleMarker.setLatLng([pLat,pLng]).addTo(map);
      }
    }
    if(isFinite(dLat) && isFinite(dLng) && (!drop || drop.lat!==dLat || drop.lng!==dLng)){
      drop = {lat:dLat,lng:dLng};
      dropMarker.setLatLng([dLat,dLng]).addTo(map);
    }
    if(pickup && drop && !routeLine) drawRoute();

    // live driver (optional)
    // Eƒüer backend live endpoint saƒülƒ±yorsa: getLive(job_id) veya getDriverLocation(driver_id)
    // Burada esnek deniyoruz:
    try{
      const live = await api("getLive", { job_id });
      const lat = Number(live.lat ?? live.driver_lat ?? live.data?.lat);
      const lng = Number(live.lng ?? live.driver_lng ?? live.data?.lng);
      if(isFinite(lat) && isFinite(lng)){
        driver = {lat,lng};
        // ETA rough: distance driver->pickup / 0.4km/min (25km/h)
        if(pickup){
          const km = (()=>{
            const R=6371;
            const dLat=(pickup.lat-lat)*Math.PI/180;
            const dLng=(pickup.lng-lng)*Math.PI/180;
            const sa=Math.sin(dLat/2)**2 + Math.cos(lat*Math.PI/180)*Math.cos(pickup.lat*Math.PI/180)*Math.sin(dLng/2)**2;
            return 2*R*Math.asin(Math.min(1,Math.sqrt(sa)));
          })();
          setEtaMinutes(km/0.4);
        }
      }
    }catch(_){ /* live yoksa sorun deƒüil */ }

  }catch(e){
    setStatus("Baƒülantƒ± g√ºncelleniyor‚Ä¶");
  }
}

refresh();
setInterval(refresh, 2500);
requestAnimationFrame(animateVehicle);
</script>
</body>
</html>
