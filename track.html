<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi ‚Äì Takip</title>
<meta name="theme-color" content="#000000" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
  header{
    position:fixed;left:0;right:0;top:0;height:62px;z-index:900;
    display:flex;align-items:center;justify-content:center;
    background:linear-gradient(180deg,rgba(0,0,0,.92),rgba(0,0,0,.55));
    border-bottom:1px solid rgba(255,255,255,.08);
    backdrop-filter: blur(10px);
    font-weight:900;
  }
  header span{color:#f5c400}
  #map{position:fixed;left:0;right:0;top:62px;bottom:0}
  .chip{
    position:fixed;left:50%;transform:translateX(-50%);
    z-index:950;
    padding:10px 14px;border-radius:999px;
    background:rgba(15,15,16,.92);border:1px solid rgba(255,255,255,.12);
    box-shadow:0 18px 60px rgba(0,0,0,.55);
    font-weight:800;
  }
  #status{top:78px}
  #eta{top:124px;opacity:.9;font-size:13.5px;font-weight:700}
</style>
</head>
<body>
  <header>Sepet<span>Taxi</span> ‚Ä¢ Canlƒ± Takip</header>
  <div id="map"></div>
  <div class="chip" id="status">Baƒülanƒ±yor‚Ä¶</div>
  <div class="chip" id="eta">Konum g√ºncelleniyor‚Ä¶</div>

<script>
const API = "https://script.google.com/macros/s/AKfycby1ekP3NTaDt0AtRiQG3CrA4iiz9MYLSsWko4mIPsjdUwBWbAJpCp-k250W3O_GnoBxzg/exec"; // aynƒ± URL
const qs = new URLSearchParams(location.search);
const jobId = qs.get("job_id");

let map, drvMarker=null, pickMarker=null, dropMarker=null;
let lastPos = null;
let serviceType="taxi";

init();

function init(){
  map = L.map("map", { zoomControl:false, attributionControl:false });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19 }).addTo(map);
  map.setView([41.015, 28.979], 13);

  if (!jobId){
    setText("status","job_id yok");
    return;
  }
  poll();
  setInterval(poll, 2000);
}

async function poll(){
  const res = await getJSON({action:"getLiveStatus", job_id: jobId});
  if (!res.ok){
    setText("status","Takip alƒ±namadƒ±");
    return;
  }
  serviceType = res.service_type || "taxi";
  const st = res.status || "";
  setText("status", statusText(st));

  // pickup/drop pins
  const p = res.pickup, d = res.dropoff;
  if (p && !pickMarker){
    pickMarker = L.marker([p.lat,p.lng], {icon: pinIcon("#f5c400")}).addTo(map);
    map.setView([p.lat,p.lng], 15);
  }
  if (d && !dropMarker){
    dropMarker = L.marker([d.lat,d.lng], {icon: pinIcon("#31d07b")}).addTo(map);
  }

  // driver
  if (res.driver && isFinite(res.driver.lat) && isFinite(res.driver.lng)){
    const pos = [res.driver.lat, res.driver.lng];
    if (!drvMarker){
      drvMarker = L.marker(pos, {icon: driverIcon(serviceType)}).addTo(map);
    }else{
      smoothMove(drvMarker, pos);
      drvMarker.setIcon(driverIcon(serviceType));
    }
    lastPos = pos;
    setText("eta", "S√ºr√ºc√º konumu g√ºncellendi");
  }else{
    setText("eta", st==="assigned" ? "S√ºr√ºc√º baƒülanƒ±yor‚Ä¶" : "S√ºr√ºc√º bekleniyor‚Ä¶");
  }

  if (st==="completed"){
    setText("eta","ƒ∞≈ü tamamlandƒ±");
  }
}

function statusText(st){
  if (st==="searching") return "S√ºr√ºc√º aranƒ±yor‚Ä¶";
  if (st==="assigned") return "S√ºr√ºc√º yolda";
  if (st==="picked_up") return (serviceType==="courier") ? "G√∂nderi alƒ±ndƒ±" : "Yolculuk ba≈üladƒ±";
  if (st==="completed") return "Tamamlandƒ±";
  if (st==="cancelled") return "ƒ∞ptal edildi";
  return "Durum: " + st;
}

function pinIcon(color){
  const html = `<div style="width:18px;height:18px;border-radius:50%;background:${color};border:2px solid rgba(0,0,0,.6);box-shadow:0 10px 24px rgba(0,0,0,.45)"></div>`;
  return L.divIcon({html, className:"", iconSize:[18,18], iconAnchor:[9,9]});
}
function driverIcon(mode){
  const sym = (mode==="courier") ? "üèçÔ∏è" : "üöï";
  const html = `
    <div style="width:34px;height:34px;border-radius:14px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.20);display:grid;place-items:center;box-shadow:0 18px 40px rgba(0,0,0,.45)"> ${sym} </div>
  `;
  return L.divIcon({html, className:"", iconSize:[34,34], iconAnchor:[17,17]});
}
function smoothMove(marker, pos){
  const start = marker.getLatLng();
  const end = L.latLng(pos[0], pos[1]);
  const steps=12; let i=0;
  const t=setInterval(()=>{
    i++;
    const k=i/steps;
    marker.setLatLng([start.lat+(end.lat-start.lat)*k, start.lng+(end.lng-start.lng)*k]);
    if(i>=steps) clearInterval(t);
  },35);
}

function setText(id,t){ document.getElementById(id).textContent=t; }

function buildQS(obj){
  const u = new URLSearchParams();
  Object.keys(obj).forEach(k => u.set(k, obj[k]));
  return u.toString();
}
async function getJSON(params){
  if (!API || API.includes("PASTE_")) return {ok:false, error:"API URL missing"};
  const url = API + "?" + buildQS(params);
  const r = await fetch(url, { method:"GET" });
  return await r.json();
}
</script>
</body>
</html>
