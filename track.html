<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Canlı Takip</title>
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
:root{--y:#f5c400}

#map{position:fixed;inset:0}

.top{
position:fixed;top:12px;left:12px;right:12px;z-index:20;
background:rgba(20,20,22,.85);
border:1px solid rgba(255,255,255,.12);
border-radius:18px;
padding:12px;
backdrop-filter:blur(10px)
}
.badge{
display:inline-block;padding:6px 10px;border-radius:999px;
font-size:12px;font-weight:900;
background:rgba(245,196,0,.15);border:1px solid rgba(245,196,0,.35)
}
.small{font-size:12px;color:rgba(255,255,255,.6)}
.row{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}

.overlay{
position:fixed;inset:0;display:none;z-index:50;
background:rgba(0,0,0,.55);backdrop-filter:blur(10px);
align-items:center;justify-content:center
}
.card{
background:#141416;border:1px solid rgba(255,255,255,.12);
border-radius:22px;padding:18px;width:min(92vw,360px)
}
.btn{
width:100%;padding:12px;border-radius:14px;
border:0;font-weight:900;
background:linear-gradient(135deg,#f5c400,#ffd34d);
color:#1a1400;margin-top:10px
}
</style>
</head>

<body>

<div id="map"></div>

<div class="top">
  <div class="badge" id="statusTxt">Yükleniyor…</div>
  <div class="row">
    <div class="small" id="addrTxt">—</div>
  </div>
  <div class="row">
    <div class="small">Mesafe:</div>
    <div class="small" id="distTxt">—</div>
  </div>
</div>

<div class="overlay" id="doneOverlay">
  <div class="card">
    <b>İş Tamamlandı</b>
    <div class="small" style="margin-top:6px">Sürücüyü değerlendirmek ister misiniz?</div>
    <button class="btn" onclick="location.replace('index.html')">Ana Sayfaya Dön</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbzXbm934CXIjTSL9RxmL8kkCjGERoeiQPDfY-OUk2Lexqqr_UvppoJ2yT0t562aJZdxRg/exec";
const POLL_MS = 3000;

/* ================= STATE ================= */
const params = new URLSearchParams(location.search);
const JOB_ID = params.get("job_id");
if(!JOB_ID) location.replace("index.html");

let map, pickupMarker, dropMarker, driverMarker, line;
let pollTimer = null;

/* ================= MAP ================= */
map = L.map("map",{zoomControl:false}).setView([40.195,29.060],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:""}).addTo(map);

/* ================= HELPERS ================= */
function postForm(d){
  return fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:Object.keys(d).map(k=>k+"="+encodeURIComponent(d[k])).join("&")
  }).then(r=>r.json());
}

function haversineKm(aLat,aLng,bLat,bLng){
  if(!aLat||!aLng||!bLat||!bLng) return null;
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(bLat-aLat),dLng=toRad(bLng-aLng);
  const q=Math.sin(dLat/2)**2 + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(q));
}

/* ================= POLL ================= */
async function pollJob(){
  const r = await postForm({ action:"getJob", job_id:JOB_ID });
  if(!r || !r.job) return;

  const j = r.job;

  document.getElementById("statusTxt").textContent = j.status || "—";
  document.getElementById("addrTxt").textContent =
    (j.from_address||"") + " → " + (j.to_address||"");

  // markers
  if(!pickupMarker && j.pickup_lat && j.pickup_lng){
    pickupMarker = L.marker([j.pickup_lat,j.pickup_lng]).addTo(map);
  }
  if(!dropMarker && j.dropoff_lat && j.dropoff_lng){
    dropMarker = L.marker([j.dropoff_lat,j.dropoff_lng]).addTo(map);
  }
  if(j.driver_lat && j.driver_lng){
    if(!driverMarker){
      driverMarker = L.marker([j.driver_lat,j.driver_lng]).addTo(map);
    }else{
      driverMarker.setLatLng([j.driver_lat,j.driver_lng]);
    }
  }

  if(j.driver_lat && j.driver_lng && j.pickup_lat && j.pickup_lng){
    const km = haversineKm(j.driver_lat,j.driver_lng,j.pickup_lat,j.pickup_lng);
    if(km!==null) document.getElementById("distTxt").textContent = km.toFixed(2)+" km";
  }

  if(j.status==="completed"){
    clearInterval(pollTimer);
    document.getElementById("doneOverlay").style.display="flex";
  }
}

/* ================= INIT ================= */
pollJob();
pollTimer = setInterval(pollJob, POLL_MS);
</script>

</body>
</html>
