<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Canlı Takip</title>
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;overflow:hidden}
:root{--y:#f5c400}

.top{padding:12px 16px}
.badge{display:inline-block;padding:8px 12px;border-radius:999px;font-size:12px;font-weight:900;background:rgba(245,196,0,.15);border:1px solid rgba(245,196,0,.35)}
.sub{font-size:12px;color:rgba(255,255,255,.6);margin-top:6px}

#map{height:52vh}
.panel{padding:12px 16px}
.card{background:#141416;border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:12px;margin-bottom:10px}
.small{font-size:12px;color:rgba(255,255,255,.65)}
.btn{width:100%;padding:14px;border-radius:16px;border:0;font-weight:900;background:linear-gradient(135deg,#f5c400,#ffd34d);color:#1a1400}
.btn.sec{background:#222;color:#fff;border:1px solid rgba(255,255,255,.15)}
</style>
</head>

<body>

<div class="top">
  <div id="statusBadge" class="badge">Yükleniyor…</div>
  <div id="statusText" class="sub">İş bilgisi alınıyor</div>
</div>

<div id="map"></div>

<div class="panel">
  <div class="card">
    <b>İş Bilgileri</b>
    <div class="small" id="jobInfo">—</div>
  </div>

  <div class="card" id="driverCard" style="display:none">
    <b>Sürücü</b>
    <div class="small" id="driverInfo">—</div>
  </div>

  <button class="btn sec" id="backBtn">Ana Sayfaya Dön</button>
</div>

<script>
/* ================= KİLİTLİ KURAL ================= */
const qs=new URLSearchParams(location.search);
const JOB_ID=qs.get("job_id");
if(!JOB_ID){ location.replace("index.html"); }

/* ================= CONFIG ================= */
const API="https://script.google.com/macros/s/AKfycbxxvr6OPG5R-emW8WlquzZ1psFEn6Lbvt4dDHpdN8XWO494N7uCv3s4DhLreIhO59b-/exec";

/* ================= HELPERS ================= */
const $=i=>document.getElementById(i);
function postForm(d){
  return fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:Object.keys(d).map(k=>k+"="+encodeURIComponent(d[k])).join("&")
  }).then(r=>r.json());
}

/* ================= MAP ================= */
let map=L.map("map",{zoomControl:false}).setView([40.195,29.060],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:""}).addTo(map);

let mPickup,mDrop,mDriver;
function setPickup(lat,lng){
  if(mPickup) mPickup.remove();
  mPickup=L.marker([lat,lng]).addTo(map);
}
function setDrop(lat,lng){
  if(mDrop) mDrop.remove();
  mDrop=L.marker([lat,lng]).addTo(map);
}
function setDriver(lat,lng){
  if(mDriver){ mDriver.setLatLng([lat,lng]); return; }
  mDriver=L.marker([lat,lng]).addTo(map);
}

/* ================= STATUS UI ================= */
function setStatus(s){
  const m={
    searching:["Sürücü aranıyor","Yakındaki sürücüler eşleştiriliyor…"],
    assigned:["Sürücü bulundu","Sürücü yolculuğa hazırlanıyor"],
    onroute:["Yolda","Sürücü adresine geliyor"],
    completed:["Tamamlandı","İş başarıyla tamamlandı"]
  };
  const o=m[s]||["Bilinmeyen",""];
  $("statusBadge").textContent=o[0];
  $("statusText").textContent=o[1];
}

/* ================= LOAD ================= */
async function loadJob(){
  try{
    const r=await postForm({action:"getJob",job_id:JOB_ID});
    if(!r||!r.ok){ $("statusBadge").textContent="Hata"; return; }

    const j=r.job;
    setStatus(j.status);

    $("jobInfo").innerHTML=`
      <div>${j.from_address||""} → ${j.to_address||""}</div>
      <div>${j.distance_km||""} km · ${j.price||""} ₺</div>
    `;

    if(j.pickup_lat&&j.pickup_lng){ setPickup(j.pickup_lat,j.pickup_lng); }
    if(j.dropoff_lat&&j.dropoff_lng){ setDrop(j.dropoff_lat,j.dropoff_lng); }

    if(j.driver_lat&&j.driver_lng){
      setDriver(j.driver_lat,j.driver_lng);
      $("driverCard").style.display="block";
      $("driverInfo").textContent=(j.driver_name||"")+" "+(j.driver_phone||"");
    }

    const bounds=[];
    if(mPickup) bounds.push(mPickup.getLatLng());
    if(mDrop) bounds.push(mDrop.getLatLng());
    if(mDriver) bounds.push(mDriver.getLatLng());
    if(bounds.length){ map.fitBounds(bounds,{padding:[40,40]}); }

    if(j.status==="completed"){
      setTimeout(()=>location.replace("index.html"),2500);
      return;
    }
    setTimeout(loadJob,5000);
  }catch(_){
    $("statusText").textContent="Bağlantı hatası";
    setTimeout(loadJob,5000);
  }
}

/* ================= EVENTS ================= */
$("backBtn").onclick=()=>location.replace("index.html");

/* ================= BOOT ================= */
loadJob();
</script>

</body>
</html>
