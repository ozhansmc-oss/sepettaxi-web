<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ CanlÄ± Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:#050506;
  color:#fff;
}
header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:20px;
  border-bottom:1px solid rgba(255,255,255,.1);
}
header span{color:#f5c400}

#map{
  height:calc(100vh - 56px);
}

.status{
  position:fixed;
  top:70px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.7);
  border:1px solid rgba(255,255,255,.15);
  border-radius:999px;
  padding:8px 16px;
  font-size:14px;
  z-index:500;
}

.driverMarker{
  width:36px;height:36px;border-radius:16px;
  background:rgba(0,0,0,.6);
  border:1px solid rgba(255,255,255,.25);
  display:grid;place-items:center;
  animation:floaty 2.6s ease-in-out infinite;
  font-size:20px;
}
@keyframes floaty{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-3px)}
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> CanlÄ± Takip</header>
<div class="status" id="status">SÃ¼rÃ¼cÃ¼ atanÄ±yorâ€¦</div>
<div id="map"></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzy0x7OIHjQsNhg_dJ_L9SgD6CjZgIE9PKyyXuABFyTr-DG6bTrtXyX0nJbpdP0MWA5Og/exec";

const params = new URLSearchParams(location.search);
const jobId = params.get("job_id");

if(!jobId){
  alert("job_id bulunamadÄ±");
}

let map;
let pickupMarker, dropMarker, driverMarker;
let job = null;

/* INIT */
initMap();
pollJob();

/* MAP */
function initMap(){
  map = L.map("map",{zoomControl:false});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  map.setView([41.01,28.97],13);
}

/* JOB POLL */
async function pollJob(){
  const res = await fetch(`${API}?action=getJobStatus&job_id=${jobId}`);
  const data = await res.json();

  if(!data.ok) return;

  if(data.status === "assigned"){
    document.getElementById("status").textContent = "SÃ¼rÃ¼cÃ¼ yolda";
    loadJobDetails();
    startLiveDriver();
  }else{
    setTimeout(pollJob,2000);
  }
}

/* LOAD JOB */
async function loadJobDetails(){
  // Basit yaklaÅŸÄ±m: jobs sheet bilgisi frontendâ€™de yok
  // pickup & drop sadece ilk defa indexâ€™te biliniyor
  // burada markerâ€™larÄ± sembolik koyuyoruz
}

/* DRIVER LIVE */
function startLiveDriver(){
  setInterval(async ()=>{
    const res = await fetch(`${API}?action=getNearbyDrivers&lat=41.01&lng=28.97&radius_km=50`);
    const data = await res.json();
    if(!data.ok) return;

    if(data.drivers.length === 0) return;

    const d = data.drivers[0]; // assigned driver ilk sÄ±rada

    const latlng = [d.lat, d.lng];

    if(!driverMarker){
      driverMarker = L.marker(latlng,{
        icon:L.divIcon({
          html:`<div class="driverMarker">${d.vehicle_type==="courier"?"ğŸï¸":"ğŸš•"}</div>`,
          className:"",
          iconSize:[36,36],
          iconAnchor:[18,18]
        })
      }).addTo(map);
      map.setView(latlng,15);
    }else{
      smoothMove(driverMarker, latlng);
    }
  },3000);
}

function smoothMove(marker, latlng){
  const start = marker.getLatLng();
  const end = L.latLng(latlng[0],latlng[1]);
  let i=0, steps=12;
  const t = setInterval(()=>{
    i++;
    const k=i/steps;
    const lat=start.lat+(end.lat-start.lat)*k;
    const lng=start.lng+(end.lng-start.lng)*k;
    marker.setLatLng([lat,lng]);
    if(i>=steps) clearInterval(t);
  },30);
}
</script>

</body>
</html>
