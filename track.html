<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi â€“ Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}
#map{height:calc(100vh - 56px)}

.overlay{
  position:fixed;left:50%;transform:translateX(-50%);
  z-index:1000;border-radius:999px;padding:7px 14px;font-size:13px;
  border:1px solid #333;background:#111;backdrop-filter: blur(6px);
  max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}
.status{top:70px}
.eta{top:110px;background:#f5c400;color:#000;font-weight:900;border-color:#f5c400}

/* === SÃœRÃœCÃœ YAKLAÅžIYOR ANÄ°MASYONU === */
.pulse{
  position:fixed;top:150px;left:50%;transform:translateX(-50%);
  padding:10px 18px;border-radius:999px;
  background:rgba(245,196,0,.12);
  border:1px solid #f5c400;color:#f5c400;
  font-weight:900;display:none;
  animation:pulse 1.4s infinite;
  z-index:1000;
  max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}
@keyframes pulse{
  0%{transform:translateX(-50%) scale(1)}
  50%{transform:translateX(-50%) scale(1.06)}
  100%{transform:translateX(-50%) scale(1)}
}

/* === DRIVER CARD === */
.driver-card{
  position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
  background:#111;border:1px solid #333;padding:14px 16px;
  border-radius:18px;min-width:280px;z-index:1000;
  max-width:92vw;
}
.driver-card b{color:#f5c400}
.badge{display:inline-block;margin-top:6px;padding:4px 10px;border-radius:999px;background:#222;color:#aaa;font-size:12px}
.actions{display:flex;gap:8px;margin-top:10px}
.btn{flex:1;text-align:center;padding:10px 0;border-radius:999px;font-weight:900;font-size:13px;text-decoration:none}
.call{background:#f5c400;color:#000}
.wa{background:#1ebe5d;color:#000}
.hidden{display:none!important}
</style>
</head>

<body>
<header>Sepet<span>Taxi</span> â€“ Takip</header>

<div id="status" class="overlay status">YÃ¼kleniyorâ€¦</div>
<div id="eta" class="overlay eta">ETA: â€”</div>
<div id="pulse" class="pulse">ðŸš— SÃ¼rÃ¼cÃ¼ YaklaÅŸÄ±yor</div>

<div id="driverCard" class="driver-card" style="display:none">
  <div><b>SÃ¼rÃ¼cÃ¼</b>: <span id="drvId">â€”</span></div>
  <div class="badge" id="drvStatus">â€”</div>
  <div class="actions">
    <a id="callBtn" class="btn call hidden" href="#">ðŸ“ž Ara</a>
    <a id="waBtn" class="btn wa hidden" href="#" target="_blank" rel="noopener">ðŸ’¬ WhatsApp</a>
  </div>
</div>

<div id="map"></div>

<script>
/* =========================
   CONFIG
========================= */
// EÄŸer config.js kullanÄ±yorsan, onu da track.html'e ekleyebilirsin.
// Åžimdilik bu sabit URL ile devam:
const BACKEND_URL =
  "https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const qs = new URLSearchParams(location.search);

// job_id: URL -> sessionStorage
const JOB_ID = qs.get("job_id") || sessionStorage.getItem("SEPT_job_id") || "";

// track_token: URL -> sessionStorage
const TRACK_TOKEN = qs.get("track_token") || sessionStorage.getItem("SEPT_track_token") || "";

// Pickup/Drop: URL -> sessionStorage (index tarafÄ±nda ayrÄ±ca yazdÄ±racaÄŸÄ±z)
function numOrNull(v){
  const n = parseFloat(String(v));
  return isFinite(n) ? n : null;
}
let pickupLat = numOrNull(qs.get("pickup_lat")) ?? numOrNull(sessionStorage.getItem("SEPT_pickup_lat"));
let pickupLng = numOrNull(qs.get("pickup_lng")) ?? numOrNull(sessionStorage.getItem("SEPT_pickup_lng"));
let dropLat   = numOrNull(qs.get("drop_lat"))   ?? numOrNull(sessionStorage.getItem("SEPT_drop_lat"));
let dropLng   = numOrNull(qs.get("drop_lng"))   ?? numOrNull(sessionStorage.getItem("SEPT_drop_lng"));

/* =========================
   STATE
========================= */
let map, pickupM, dropM, driverM, routeLine;
let firstFit=false;
let lastDriverPos=null;        // {lat,lng} in degrees
let lastRouteKey="";           // to prevent redundant OSRM calls
let pollTimer=null;
let startedAt=Date.now();
let failures=0;

/* =========================
   DOM
========================= */
const $ = (id)=>document.getElementById(id);
const statusEl = $("status");
const etaEl = $("eta");
const pulseEl = $("pulse");
const driverCard = $("driverCard");
const drvIdEl = $("drvId");
const drvStatusEl = $("drvStatus");
const callBtn = $("callBtn");
const waBtn = $("waBtn");

/* =========================
   MAP
========================= */
function initMap(){
  map = L.map("map",{zoomControl:true}).setView([40.195,29.060],12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
    attribution:"&copy; OpenStreetMap"
  }).addTo(map);
}

/* =========================
   DRIVER ICON (ROTATE)
========================= */
function carIcon(angle=0){
  return L.divIcon({
    html:`<div style="width:32px;height:32px;transform:rotate(${angle}deg);font-size:26px;color:#f5c400;line-height:32px;text-align:center">ðŸš—</div>`,
    className:"",
    iconSize:[32,32],
    iconAnchor:[16,16]
  });
}
function toRad(d){ return d*Math.PI/180; }
function bearingDeg(a,b){
  // a,b: {lat,lng} degrees
  const lat1=toRad(a.lat), lat2=toRad(b.lat);
  const dLon=toRad(b.lng-a.lng);
  const y=Math.sin(dLon)*Math.cos(lat2);
  const x=Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
  return (Math.atan2(y,x)*180/Math.PI + 360) % 360;
}

/* =========================
   BACKEND CALLS (token guarded)
========================= */
async function apiGet(action, params){
  const url = new URL(BACKEND_URL);
  url.searchParams.set("action", action);
  Object.entries(params||{}).forEach(([k,v])=>{
    if(v!==undefined && v!==null && String(v).length) url.searchParams.set(k, v);
  });
  const res = await fetch(url.toString(), { method:"GET" });
  const txt = await res.text();
  try{ return JSON.parse(txt); }catch(_){ return { ok:false, error:"JSON parse", raw:txt }; }
}

function statusLabel(st){
  if(st==="assigned") return "SÃ¼rÃ¼cÃ¼ atandÄ±, geliyor";
  if(st==="on_route") return "VarÄ±ÅŸa gidiliyor";
  if(st==="completed") return "TamamlandÄ±";
  if(st==="cancelled") return "Ä°ptal edildi";
  if(st==="pending") return "SÃ¼rÃ¼cÃ¼ bekleniyor";
  return "Durum gÃ¼ncelleniyor";
}

/* =========================
   OSRM ROUTE
========================= */
async function getRoute(aLat,aLng,bLat,bLng){
  const url =
    `https://router.project-osrm.org/route/v1/driving/`+
    `${aLng},${aLat};${bLng},${bLat}?overview=full&geometries=geojson`;
  const r = await fetch(url).then(r=>r.json());
  if(!r || !r.routes || !r.routes[0]) throw new Error("OSRM route yok");
  const g = r.routes[0];
  return {
    pts: (g.geometry.coordinates||[]).map(c=>[c[1],c[0]]),
    eta: Math.max(2, Math.round((g.duration||0)/60))
  };
}

/* =========================
   RENDER HELPERS
========================= */
function ensurePickupDropMarkers(){
  if(pickupLat!=null && pickupLng!=null){
    if(!pickupM) pickupM=L.marker([pickupLat,pickupLng]).addTo(map);
    else pickupM.setLatLng([pickupLat,pickupLng]);
  }
  if(dropLat!=null && dropLng!=null){
    if(!dropM) dropM=L.marker([dropLat,dropLng]).addTo(map);
    else dropM.setLatLng([dropLat,dropLng]);
  }
}

function updateDriverMarker(lat,lng){
  const nowPos = {lat, lng};
  let angle=0;
  if(lastDriverPos){
    angle = bearingDeg(lastDriverPos, nowPos);
  }
  lastDriverPos = nowPos;

  if(!driverM) driverM = L.marker([lat,lng],{icon:carIcon(angle)}).addTo(map);
  else{
    driverM.setLatLng([lat,lng]);
    driverM.setIcon(carIcon(angle));
  }
}

function fitOnce(){
  if(firstFit) return;
  const items = [];
  if(pickupLat!=null && pickupLng!=null) items.push([pickupLat,pickupLng]);
  if(dropLat!=null && dropLng!=null) items.push([dropLat,dropLng]);
  if(driverM) items.push(driverM.getLatLng());
  if(items.length>=1){
    map.fitBounds(L.latLngBounds(items).pad(0.25),{padding:[40,40]});
    firstFit=true;
  }
}

/* =========================
   MAIN LOAD LOOP
========================= */
async function loadOnce(){
  if(!JOB_ID){
    statusEl.textContent = "job_id yok (takip linki eksik).";
    etaEl.textContent = "ETA: â€”";
    pulseEl.style.display="none";
    return;
  }

  // 1) checkJob
  const job = await apiGet("checkJob", { job_id: JOB_ID, track_token: TRACK_TOKEN });
  if(!job || !job.ok){
    failures++;
    statusEl.textContent = (job && job.error) ? `BaÄŸlantÄ±: ${job.error}` : "BaÄŸlantÄ± hatasÄ±";
    // failure toleransÄ±: sayfayÄ± bozma, sadece status gÃ¶ster
    return;
  }

  failures=0;

  const st = String(job.status||"pending");
  drvStatusEl.textContent = st;
  statusEl.textContent = statusLabel(st);
  pulseEl.style.display = (st==="assigned") ? "block" : "none";

  drvIdEl.textContent = job.driver_id ? String(job.driver_id) : "â€”";
  driverCard.style.display = job.driver_id ? "block" : "none";

  // 2) pickup/drop markerlarÄ±
  ensurePickupDropMarkers();

  // Koordinatlar yoksa net uyarÄ± (ama status devam)
  if(pickupLat==null || pickupLng==null || dropLat==null || dropLng==null){
    etaEl.textContent = "ETA: â€”";
    if(st==="assigned" || st==="on_route"){
      statusEl.textContent = statusLabel(st) + " (rota iÃ§in koordinat eksik)";
    }
  }

  // 3) getLive (driver location)
  const live = await apiGet("getLive", { job_id: JOB_ID, track_token: TRACK_TOKEN });

  let drvLat=null, drvLng=null;
  if(live && live.ok && live.has){
    drvLat = numOrNull(live.lat);
    drvLng = numOrNull(live.lng);
    if(drvLat!=null && drvLng!=null){
      updateDriverMarker(drvLat, drvLng);
      // driver kart iletiÅŸim butonlarÄ±: elimizde telefon yok -> gizli kalÄ±r
      callBtn.classList.add("hidden");
      waBtn.classList.add("hidden");
    }
  }

  // 4) Route logic (OSRM)
  // pending: rota yok
  // assigned: driver -> pickup (driver konumu varsa)
  // on_route: driver -> drop (driver konumu varsa)
  // completed/cancelled: rota sabit kalabilir ama ETA durur
  let fromLat=null, fromLng=null, toLat=null, toLng=null;

  if(st==="assigned"){
    if(drvLat!=null && drvLng!=null && pickupLat!=null && pickupLng!=null){
      fromLat=drvLat; fromLng=drvLng; toLat=pickupLat; toLng=pickupLng;
    }
  }else if(st==="on_route"){
    if(drvLat!=null && drvLng!=null && dropLat!=null && dropLng!=null){
      fromLat=drvLat; fromLng=drvLng; toLat=dropLat; toLng=dropLng;
    }
  }else{
    // pending/completed/cancelled
    etaEl.textContent = "ETA: â€”";
  }

  // Rota Ã§aÄŸrÄ±sÄ± sadece veriler tam ve deÄŸiÅŸmiÅŸse
  if(fromLat!=null && fromLng!=null && toLat!=null && toLng!=null){
    const key = `${st}|${fromLat.toFixed(5)},${fromLng.toFixed(5)}->${toLat.toFixed(5)},${toLng.toFixed(5)}`;
    // Ã§ok sÄ±k OSRM Ã§aÄŸrÄ±sÄ±nÄ± azaltmak iÃ§in kÃ¼Ã§Ã¼k hareketlerde Ã§aÄŸÄ±rma
    if(key !== lastRouteKey){
      lastRouteKey = key;
      try{
        const r = await getRoute(fromLat,fromLng,toLat,toLng);
        etaEl.textContent = `ETA: ${r.eta} dk`;

        if(r.pts && r.pts.length){
          if(routeLine) routeLine.setLatLngs(r.pts);
          else routeLine = L.polyline(r.pts,{color:"#f5c400",weight:5}).addTo(map);
          if(!firstFit){
            map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
            firstFit=true;
          }
        }
      }catch(e){
        // OSRM geÃ§ici sorunlarÄ±nda UIâ€™yÄ± bozma
        etaEl.textContent = "ETA: â€”";
      }
    }
  }

  // 5) Ä°lk gÃ¶rÃ¼nÃ¼m
  fitOnce();

  // 6) Timeout bilgilendirme (opsiyonel)
  const elapsed = Date.now()-startedAt;
  if(st==="pending" && elapsed>90000){
    statusEl.textContent = "SÃ¼rÃ¼cÃ¼ bekleniyor (90sn+). LÃ¼tfen biraz sonra tekrar deneyin.";
  }
}

/* =========================
   START
========================= */
initMap();
loadOnce();
pollTimer = setInterval(loadOnce, 3000);
</script>

</body>
</html>
