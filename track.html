<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi – Takip</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;overflow:hidden}
  :root{--y:#f5c400;--line:rgba(255,255,255,.10);--mut:rgba(255,255,255,.65)}
  .top{
    position:fixed;left:0;right:0;top:0;height:56px;
    display:flex;align-items:center;justify-content:space-between;
    padding:0 12px;z-index:30;
    background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.10));
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .title{font-weight:900}
  .btn{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#fff;
    padding:10px 12px;border-radius:14px;
    font-weight:900;
  }
  .wrap{position:fixed;inset:56px 0 0 0;display:flex;flex-direction:column}
  #map{flex:1 1 60%}
  .panel{
    flex:1 1 40%;
    padding:12px;
    background:linear-gradient(180deg, rgba(20,20,22,.92), rgba(10,10,12,.98));
    border-top:1px solid rgba(255,255,255,.08);
  }
  .card{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    border-radius:18px;
    padding:12px;
  }
  .k{font-size:12px;color:rgba(255,255,255,.58)}
  .v{margin-top:4px;font-size:14px;font-weight:900}
  .row{display:flex;gap:10px;margin-top:10px}
  .col{flex:1}
  .status{
    margin-top:10px;
    display:flex;align-items:center;gap:10px;
    padding:12px;border-radius:18px;
    border:1px solid rgba(245,196,0,.22);
    background:rgba(245,196,0,.10);
    font-weight:900;
  }
  .dot{width:10px;height:10px;border-radius:50%;background:var(--y);box-shadow:0 0 0 4px rgba(245,196,0,.18)}
  .mut{color:rgba(255,255,255,.62);font-size:12px;margin-top:10px}
</style>
</head>
<body>

<div class="top">
  <div class="title">Canlı Takip</div>
  <button class="btn" id="refreshBtn">Yenile</button>
</div>

<div class="wrap">
  <div id="map"></div>
  <div class="panel">
    <div class="card">
      <div class="k">İş ID</div>
      <div class="v" id="jobId">—</div>

      <div class="row">
        <div class="col">
          <div class="k">Nereden</div>
          <div class="v" id="fromTxt">—</div>
        </div>
        <div class="col">
          <div class="k">Nereye</div>
          <div class="v" id="toTxt">—</div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <div class="k">Mesafe</div>
          <div class="v" id="kmTxt">—</div>
        </div>
        <div class="col">
          <div class="k">Ücret</div>
          <div class="v" id="priceTxt">—</div>
        </div>
      </div>

      <div class="status">
        <div class="dot"></div>
        <div>
          <div id="statusTxt">Durum: —</div>
          <div class="mut" id="statusSub">Sürücü eşleştirme / kabul / teslim…</div>
        </div>
      </div>

      <div class="mut" id="autoInfo">Otomatik yenileme: 3 sn</div>
    </div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxxvr6OPG5R-emW8WlquzZ1psFEn6Lbvt4dDHpdN8XWO494N7uCv3s4DhLreIhO59b-/exec";

const $ = id => document.getElementById(id);
function qp(name){
  const u=new URL(location.href);
  return u.searchParams.get(name);
}
const job_id = qp("job_id") || "";
$("jobId").textContent = job_id || "—";

let map, mFrom, mTo, mDriver, line;
function initMap(){
  map = L.map("map", { zoomControl:false }).setView([40.195,29.060], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution:"" }).addTo(map);
}
initMap();

async function apiGet(params){
  const u = new URL(API);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const r = await fetch(u.toString());
  return await r.json();
}

function place(fromLat, fromLng, toLat, toLng){
  if(mFrom) mFrom.remove();
  if(mTo) mTo.remove();
  if(line) line.remove();
  mFrom = L.marker([fromLat, fromLng]).addTo(map);
  mTo = L.marker([toLat, toLng]).addTo(map);
  line = L.polyline([[fromLat,fromLng],[toLat,toLng]], { weight:5, opacity:.9 }).addTo(map);
  map.fitBounds(line.getBounds(), { padding:[40,40] });
}

function setStatus(s){
  const st = String(s||"").toUpperCase();
  $("statusTxt").textContent = "Durum: " + st;
  const mapTxt = {
    "SEARCHING":"Sürücü aranıyor…",
    "ASSIGNED":"Sürücü atandı…",
    "ACCEPTED":"Sürücü kabul etti.",
    "PICKED":"Yola çıktı / aldı.",
    "COMPLETED":"Tamamlandı.",
    "CANCELED":"İptal edildi."
  };
  $("statusSub").textContent = mapTxt[st] || "Güncelleniyor…";
}

async function refresh(){
  if(!job_id) return;
  try{
    const res = await apiGet({ action:"getJob", job_id });
    if(!res.ok) throw new Error(res.error || "API error");
    const j = res.job;

    $("fromTxt").textContent = j.from_address || "—";
    $("toTxt").textContent = j.to_address || "—";
    $("kmTxt").textContent = (j.distance_km ? Number(j.distance_km).toFixed(2) : "—") + " km";
    $("priceTxt").textContent = (j.final_price || j.price || "—") + " ₺";
    setStatus(j.status);

    const pLat = Number(j.pickup_lat), pLng = Number(j.pickup_lng);
    const dLat = Number(j.dropoff_lat), dLng = Number(j.dropoff_lng);
    if(isFinite(pLat)&&isFinite(pLng)&&isFinite(dLat)&&isFinite(dLng)){
      place(pLat,pLng,dLat,dLng);
    }
  }catch(e){
    $("statusSub").textContent = "Hata: " + (e && e.message ? e.message : e);
  }
}

$("refreshBtn").onclick = refresh;

refresh();
setInterval(refresh, 3000);
</script>
</body>
</html>
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>SepetTaxi – Canlı Takip</title>
  <meta name="theme-color" content="#0b0b0c" />

  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="config.js"></script>

  <style>
    *{box-sizing:border-box}
    :root{
      --y:#f5c400; --bg:#060607; --line:rgba(255,255,255,.10);
      --panel:rgba(12,12,14,.92); --mut:rgba(255,255,255,.66); --shadow:0 12px 40px rgba(0,0,0,.55);
    }
    html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
    #map{position:fixed;inset:0}
    .leaflet-control-container{display:none}
    .bar{
      position:fixed;left:12px;right:12px;top:12px;z-index:20;
      background:linear-gradient(180deg, rgba(20,22,26,.92), rgba(12,12,14,.92));
      border:1px solid var(--line);border-radius:18px;padding:12px;box-shadow:var(--shadow);
      display:flex;align-items:center;gap:10px;backdrop-filter: blur(12px);
    }
    .dot{width:10px;height:10px;border-radius:99px;background:var(--y);box-shadow:0 0 0 8px rgba(245,196,0,.12)}
    .t{min-width:0}
    .t b{display:block;font-size:13px}
    .t span{display:block;margin-top:3px;font-size:11px;color:var(--mut)}
    .btn{
      margin-left:auto;padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:#fff;font-weight:900;cursor:pointer;
    }
    .card{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:20;
      background:linear-gradient(180deg, rgba(20,22,26,.92), rgba(12,12,14,.95));
      border:1px solid var(--line);border-radius:20px;padding:12px;box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .row{display:flex;gap:10px}
    .pill{
      flex:1;padding:10px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .pill b{display:block;font-size:14px}
    .pill span{display:block;margin-top:4px;font-size:11px;color:var(--mut)}
  </style>
</head>
<body>
<div id="map"></div>

<div class="bar">
  <div class="dot"></div>
  <div class="t">
    <b id="title">Canlı takip</b>
    <span id="subtitle">Bağlantı kuruluyor…</span>
  </div>
  <button class="btn" id="back">Ana Ekran</button>
</div>

<div class="card">
  <div class="row">
    <div class="pill"><b id="km">–</b><span>Mesafe</span></div>
    <div class="pill"><b id="price">–</b><span>Ücret</span></div>
  </div>
</div>

<script>
const CFG = window.SEPETTAXI || {};
const API = (CFG.API_BASE || "https://script.google.com/macros/s/AKfycbyUDK7nZCPLw6R6ml1mGeUyuNCZCuZ2hPWtjmrsBwXm7JFyHKwr_MKZqDjsoT9jVoJGsg/exec").trim();
const $ = (id)=>document.getElementById(id);

function qs(){
  const u = new URL(location.href);
  return Object.fromEntries(u.searchParams.entries());
}
function apiGet(action, params={}){
  return new Promise((resolve, reject)=>{
    if(!API || API.includes("PASTE_YOUR")) return reject(new Error("API_BASE yok / yanlış"));
    const cb = "cb_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    window[cb] = (payload)=>{
      try{ delete window[cb]; }catch(_){ window[cb]=undefined; }
      script.remove();
      if(payload && payload.ok) resolve(payload); else reject(new Error((payload && payload.error) || "API error"));
    };
    const p = new URLSearchParams({action, callback: cb, ...params}).toString();
    const script = document.createElement("script");
    script.src = API + "?" + p;
    script.onerror = ()=>{ try{ delete window[cb]; }catch(_){ } reject(new Error("Network/JSONP error")); };
    document.body.appendChild(script);
  });
}

let map, pickupMarker, dropMarker, driverMarker, line;
function initMap(){
  map = L.map("map", {zoomControl:false, attributionControl:false});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19}).addTo(map);
  map.setView([40.2, 29.06], 13);
}
function icon(letter, accent){
  return L.divIcon({
    className:"",
    html:`<div style="width:34px;height:34px;border-radius:14px;background:rgba(10,10,12,.80);border:1px solid rgba(255,255,255,.18);display:grid;place-items:center;box-shadow:0 10px 22px rgba(0,0,0,.55)">
      <div style="width:18px;height:18px;border-radius:8px;background:${accent};color:#111;display:grid;place-items:center;font-weight:900;font-size:11px">${letter}</div>
    </div>`,
    iconSize:[34,34], iconAnchor:[17,17]
  });
}
function setMarkers(job){
  const p = [Number(job.pickup_lat), Number(job.pickup_lng)];
  const d = [Number(job.dropoff_lat), Number(job.dropoff_lng)];
  if(!pickupMarker) pickupMarker = L.marker(p, {icon: icon("A","rgba(245,196,0,.95)")}).addTo(map);
  else pickupMarker.setLatLng(p);
  if(!dropMarker) dropMarker = L.marker(d, {icon: icon("B","rgba(255,255,255,.92)")}).addTo(map);
  else dropMarker.setLatLng(d);

  if(line) map.removeLayer(line);
  line = L.polyline([p,d], {weight:4, opacity:.7}).addTo(map);
  map.fitBounds(line.getBounds(), {padding:[40,40]});

  $("km").textContent = (job.distance_km ? Number(job.distance_km).toFixed(1) + " km" : "–");
  $("price").textContent = (job.price ? "₺" + job.price : "–");
}
function setDriver(lat,lng){
  const pos=[Number(lat), Number(lng)];
  if(!driverMarker) driverMarker = L.marker(pos, {icon: icon("S","rgba(52,199,89,.95)")}).addTo(map);
  else driverMarker.setLatLng(pos);
}

$("back").onclick = ()=>location.href="index.html";

(async function boot(){
  initMap();
  const {job_id} = qs();
  if(!job_id){ $("subtitle").textContent="job_id yok"; return; }

  $("subtitle").textContent="Job yükleniyor…";

  async function tick(){
    try{
      const r = await apiGet("getJob", {job_id});
      const job = r.job;
      if(!job){ $("subtitle").textContent="Job bulunamadı"; return; }

      setMarkers(job);

      if(job.status === "assigned"){
        $("subtitle").textContent = "Sürücü atandı. Konum bekleniyor…";
      }else if(job.status === "onroute"){
        $("subtitle").textContent = "Sürücü yolda";
      }else if(job.status === "completed"){
        $("subtitle").textContent = "Tamamlandı";
      }else if(job.status === "canceled"){
        $("subtitle").textContent = "İptal";
      }else{
        $("subtitle").textContent = "Durum: " + job.status;
      }

      if(job.driver_lat && job.driver_lng){
        setDriver(job.driver_lat, job.driver_lng);
      }else{
        // driver_live ayrı da olabilir
        if(r.driver_live && r.driver_live.lat) setDriver(r.driver_live.lat, r.driver_live.lng);
      }
    }catch(e){
      $("subtitle").textContent="Bağlantı hatası…";
    }
  }

  await tick();
  setInterval(tick, 2000);
})();
</script>
</body>
</html>
