<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Canlı Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial;background:#000;color:#fff}

header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  border-bottom:1px solid #222
}
header span{color:#f5c400}

#map{height:calc(100vh - 56px)}

.badge{
  position:fixed;
  top:70px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  border:1px solid #333;
  border-radius:999px;
  padding:8px 16px;
  font-size:14px;
  z-index:1000
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> Canlı Takip</header>
<div id="map"></div>
<div id="status" class="badge">Bağlanıyor…</div>

<script>
/* ================= CONFIG ================= */
const API =
"https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

const qs = new URLSearchParams(location.search);
const jobId = qs.get("job_id");
const isDriver = qs.get("driver") === "1";

if(!jobId){
  alert("job_id yok");
  throw "job_id missing";
}

/* ================= MAP ================= */
const map = L.map("map").setView([40.195, 29.060], 14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  maxZoom:19
}).addTo(map);

const customerIcon = L.icon({
  iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png",
  iconSize:[32,32],
  iconAnchor:[16,32]
});
const driverIcon = L.icon({
  iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png",
  iconSize:[32,32],
  iconAnchor:[16,32]
});

let customerMarker=null;
let driverMarker=null;

/* ================= STATUS ================= */
const statusBox=document.getElementById("status");
function setStatus(t){ statusBox.innerText=t; }

/* ================= API ================= */
async function post(body){
  const r=await fetch(API,{
    method:"POST",
    body:JSON.stringify(body)
  });
  return r.json();
}
async function get(p){
  const r=await fetch(API+"?"+new URLSearchParams(p));
  return r.json();
}

/* ================= JOB WATCH ================= */
async function watchJob(){
  const j = await get({action:"getJob",job_id:jobId});
  if(j.status) setStatus("Durum: "+j.status);
  if(j.from_lat && j.from_lng){
    if(!customerMarker){
      customerMarker=L.marker(
        [j.from_lat,j.from_lng],
        {icon:customerIcon}
      ).addTo(map);
      map.setView([j.from_lat,j.from_lng],15);
    }
  }
}
setInterval(watchJob,3000);

/* ================= LIVE LOCATION ================= */
navigator.geolocation.watchPosition(pos=>{
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;

  post({
    action:"updateLocation",
    job_id:jobId,
    who:isDriver?"driver":"customer",
    lat,lng
  });

  if(isDriver){
    if(!driverMarker){
      driverMarker=L.marker([lat,lng],{icon:driverIcon}).addTo(map);
    }else{
      driverMarker.setLatLng([lat,lng]);
    }
  }else{
    if(!customerMarker){
      customerMarker=L.marker([lat,lng],{icon:customerIcon}).addTo(map);
    }else{
      customerMarker.setLatLng([lat,lng]);
    }
  }
},{
  enableHighAccuracy:true
});
</script>

</body>
</html>
