<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SepetTaxi – Canlı Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}

header{
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  font-weight:bold;
}
header span{color:#f5c400}

#map{
  height:calc(100vh - 56px);
  width:100vw;
}

/* STATUS BADGE */
.status{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  padding:10px 18px;
  border-radius:24px;
  border:1px solid #333;
  font-size:14px;
  z-index:999;
}
.status.pending{border-color:#777}
.status.assigned{border-color:#f5c400}
.status.active{border-color:#2ecc71}
.status.completed{border-color:#3498db}
.status.error{border-color:#e74c3c}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> • Canlı Takip</header>
<div id="map"></div>
<div id="status" class="status">Bağlanıyor…</div>

<script>
/************ CONFIG ************/
const API_URL = "https://script.google.com/macros/s/AKfycbys0kfPST4tTxCmnhiCqjk8DeKDnUbSLvnL4h8k2IYGOjD9Kgjk-w2CVxRsNCVFZwvpKA/exec";

/************ PARAM ************/
const params = new URLSearchParams(window.location.search);
const JOB_ID = params.get("job_id");

/************ MAP ************/
let map = L.map("map").setView([41,29],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

let driverMarker = null;
let pickupMarker = null;
let dropMarker = null;

/************ UI ************/
function setStatus(text, cls){
  status.textContent = text;
  status.className = "status " + cls;
}

/************ TRACK ************/
function poll(){
  if(!JOB_ID){
    setStatus("Job ID bulunamadı", "error");
    return;
  }

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      action: "getJobTrack",
      job_id: JOB_ID
    })
  })
  .then(r=>r.json())
  .then(d=>{
    if(!d || d.error){
      setStatus("Takip bilgisi yok", "error");
      return;
    }

    // STATUS
    setStatus("Durum: " + d.status, d.status);

    // PICKUP / DROP (ilk sefer)
    if(!pickupMarker && d.from_address){
      pickupMarker = L.marker([41,29]).addTo(map).bindPopup("Alış Noktası");
    }
    if(!dropMarker && d.to_address){
      dropMarker = L.marker([41,29]).addTo(map).bindPopup("Varış Noktası");
    }

    // DRIVER
    if(d.driver_lat && d.driver_lng){
      const pos = [Number(d.driver_lat), Number(d.driver_lng)];

      if(!driverMarker){
        driverMarker = L.marker(pos,{
          icon: L.icon({
            iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
            iconSize: [25,41],
            iconAnchor: [12,41]
          })
        }).addTo(map).bindPopup("Sürücü");

        map.setView(pos,15);
      }else{
        driverMarker.setLatLng(pos);
      }
    }

    // JOB BİTTİ
    if(d.status === "completed"){
      setStatus("İş tamamlandı", "completed");
    }
  })
  .catch(()=>{
    setStatus("Bağlantı hatası", "error");
  });
}

/************ LOOP ************/
poll();
setInterval(poll, 3000);
</script>

</body>
</html>
