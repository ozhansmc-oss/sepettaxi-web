<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Takip</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>/* … minimal styling … */</style>
</head>
<body>

<header>Sepet<span>Taxi</span> – Takip</header>
<div id="map" style="height:50vh"></div>

<div>
  <div>Durum: <span id="status">—</span></div>
  <div>Brüt: <span id="brut">—</span></div>
</div>

<div id="driverActions" style="display:none">
  <button onclick="setStatus('arrived')">GELDİM</button>
  <button onclick="setStatus('picked')">ALDIM</button>
  <button onclick="setStatus('completed')">TAMAMLANDI</button>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";
const params=new URLSearchParams(location.search);
const jobId=params.get("job_id");
const role=params.get("role")||"customer";
const driverId=params.get("driver_id")||"";

let map, markers={};

function init(){
  map=L.map("map").setView([41,29],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  poll();
  setInterval(poll,4000);
}

async function poll(){
  const url=new URL(BACKEND_URL);
  url.searchParams.set("action","getJob");
  url.searchParams.set("job_id",jobId);
  const r=await fetch(url.toString());
  const j=await r.json();
  if(!j.ok) return;

  document.getElementById("status").textContent=j.status;
  document.getElementById("brut").textContent=j.price_brut;

  const a=[j.from_lat,j.from_lng];
  const b=[j.to_lat,j.to_lng];
  if(!markers.start) markers.start=L.marker(a).addTo(map);
  if(!markers.end) markers.end=L.marker(b).addTo(map);

  if(j.driver_lat && j.driver_lng){
    if(!markers.driver) markers.driver=L.marker([j.driver_lat,j.driver_lng]).addTo(map);
    else markers.driver.setLatLng([j.driver_lat,j.driver_lng]);
  }

  if(role==="driver") document.getElementById("driverActions").style.display="block";
}

function setStatus(st){
  fetch(BACKEND_URL,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"updateStatus",job_id:jobId,status:st,driver_id:driverId})
  });
}

window.onload=init;
</script>

</body>
</html>
