<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Canlı Takip</title>
<meta name="theme-color" content="#f5c400">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
:root{--y:#f5c400}

.wrap{padding:16px;max-width:560px;margin:0 auto}
h1{font-size:18px;margin:6px 0 12px}

.card{
background:#141416;
border:1px solid rgba(255,255,255,.12);
border-radius:20px;
padding:16px;
margin-bottom:12px
}

.badge{
display:inline-block;padding:8px 12px;border-radius:999px;
font-size:12px;font-weight:900;
background:rgba(245,196,0,.15);
border:1px solid rgba(245,196,0,.35)
}

.small{font-size:12px;color:rgba(255,255,255,.6)}

.mapbox{
height:260px;border-radius:16px;
background:rgba(255,255,255,.05);
display:flex;align-items:center;justify-content:center;
color:rgba(255,255,255,.4);margin-bottom:12px
}

.btn{
width:100%;padding:14px;border-radius:16px;
border:0;font-weight:900;
background:linear-gradient(135deg,#f5c400,#ffd34d);
color:#1a1400;margin-top:10px
}
.btn.sec{
background:#222;color:#fff;border:1px solid rgba(255,255,255,.15)
}
</style>
</head>

<body>

<div class="wrap">

  <h1>Canlı Takip</h1>

  <div class="card">
    <div id="statusBadge" class="badge">Yükleniyor…</div>
    <div class="small" id="statusText" style="margin-top:6px">İş bilgisi alınıyor</div>
  </div>

  <div class="mapbox" id="mapBox">
    Harita / Canlı konum
  </div>

  <div class="card">
    <b>İş Bilgileri</b>
    <div class="small" id="jobInfo" style="margin-top:6px">—</div>
  </div>

  <div class="card" id="driverCard" style="display:none">
    <b>Sürücü</b>
    <div class="small" id="driverInfo" style="margin-top:6px">—</div>
  </div>

  <button class="btn sec" id="backBtn">Ana Sayfaya Dön</button>

</div>

<script>
/* ================= KİLİTLİ KURAL ================= */
const qs = new URLSearchParams(location.search);
const JOB_ID = qs.get("job_id");

if(!JOB_ID){
  window.location.replace("index.html");
}

/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbxxvr6OPG5R-emW8WlquzZ1psFEn6Lbvt4dDHpdN8XWO494N7uCv3s4DhLreIhO59b-/exec";

/* ================= HELPERS ================= */
const $ = i => document.getElementById(i);

function postForm(d){
  return fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:Object.keys(d).map(k=>k+"="+encodeURIComponent(d[k])).join("&")
  }).then(r=>r.json());
}

/* ================= STATUS UI ================= */
function setStatus(status){
  const map = {
    searching:{t:"Sürücü aranıyor",s:"Yakındaki sürücüler eşleştiriliyor…"},
    assigned:{t:"Sürücü bulundu",s:"Sürücü yolculuğa hazırlanıyor"},
    onroute:{t:"Yolda",s:"Sürücü adresine geliyor"},
    completed:{t:"Tamamlandı",s:"İş başarıyla tamamlandı"}
  };
  const o = map[status] || {t:"Bilinmeyen",s:""};
  $("statusBadge").textContent=o.t;
  $("statusText").textContent=o.s;
}

/* ================= LOAD JOB ================= */
async function loadJob(){
  try{
    const r = await postForm({
      action:"getJob",
      job_id:JOB_ID
    });

    if(!r || !r.ok){
      $("statusBadge").textContent="Hata";
      $("statusText").textContent="İş bulunamadı";
      return;
    }

    const j = r.job;
    setStatus(j.status);

    $("jobInfo").innerHTML = `
      <div>${j.from_address || ""} → ${j.to_address || ""}</div>
      <div>${j.distance_km || ""} km · ${j.price || ""} ₺</div>
    `;

    if(j.driver_name || j.driver_phone){
      $("driverCard").style.display="block";
      $("driverInfo").textContent =
        (j.driver_name||"") + " " + (j.driver_phone||"");
    }

    if(j.status === "completed"){
      setTimeout(()=>{
        window.location.replace("index.html");
      }, 2500);
      return;
    }

    setTimeout(loadJob, 5000);

  }catch(e){
    $("statusText").textContent="Bağlantı hatası";
  }
}

/* ================= EVENTS ================= */
$("backBtn").onclick = ()=> window.location.replace("index.html");

/* ================= BOOT ================= */
loadJob();
</script>

</body>
</html>
