<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SepetTaxi – Canlı Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html,body,#map{height:100%;margin:0}
.info{position:absolute;top:10px;left:10px;
background:#fff;padding:8px;border-radius:6px;z-index:1000}
</style>
</head>
<body>

<div class="info" id="info">Bağlanıyor...</div>
<div id="map"></div>

<script>
const API_URL = "<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SepetTaxi – Canlı Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html,body,#map{height:100%;margin:0}
.info{position:absolute;top:10px;left:10px;
background:#fff;padding:8px;border-radius:6px;z-index:1000}
</style>
</head>
<body>

<div class="info" id="info">Bağlanıyor...</div>
<div id="map"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzpRty4fID0Z_J9d0Y6JeA4UIlFgn_SHc9cppaG2pnSfMhkbfi3t6VfVqBeZvY4k-OH/exec";
const jobId = new URLSearchParams(location.search).get("job_id");

if(!jobId){
  alert("Job ID yok");
}

const map = L.map("map").setView([40.195,29.060],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker = null;

function load(){
  fetch(API_URL+"?action=getJobs")
    .then(r=>r.json())
    .then(list=>{
      const job = list.find(j=>j.job_id===jobId);
      if(!job || !job.driver_lat) return;

      const lat = parseFloat(job.driver_lat);
      const lng = parseFloat(job.driver_lng);

      if(!marker){
        marker = L.marker([lat,lng]).addTo(map);
        map.setView([lat,lng],15);
      }else{
        marker.setLatLng([lat,lng]);
      }

      document.getElementById("info").innerText =
        "Sürücü Konumu: "+lat.toFixed(5)+", "+lng.toFixed(5);
    });
}

setInterval(load,2000);
load();
</script>

</body>
</html>
";
const jobId = new URLSearchParams(location.search).get("job_id");

if(!jobId){
  alert("Job ID yok");
}

const map = L.map("map").setView([40.195,29.060],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let marker = null;

function load(){
  fetch(API_URL+"?action=getJobs")
    .then(r=>r.json())
    .then(list=>{
      const job = list.find(j=>j.job_id===jobId);
      if(!job || !job.driver_lat) return;

      const lat = parseFloat(job.driver_lat);
      const lng = parseFloat(job.driver_lng);

      if(!marker){
        marker = L.marker([lat,lng]).addTo(map);
        map.setView([lat,lng],15);
      }else{
        marker.setLatLng([lat,lng]);
      }

      document.getElementById("info").innerText =
        "Sürücü Konumu: "+lat.toFixed(5)+", "+lng.toFixed(5);
    });
}

setInterval(load,2000);
load();
</script>

</body>
</html>
