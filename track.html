<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>SepetTaxi – Canlı Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="config.js"></script>
<script src="log.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial;background:#000;color:#fff}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222
}
header span{color:#f5c400}
#map{height:calc(100vh - 56px)}
.badge{
  position:fixed;top:70px;left:50%;transform:translateX(-50%);
  background:#111;border:1px solid #333;border-radius:999px;
  padding:8px 16px;font-size:14px;z-index:1000
}
</style>
</head>

<body>
<header>Sepet<span>Taxi</span> Canlı Takip</header>
<div id="map"></div>
<div id="status" class="badge">Bağlanıyor…</div>

<script>
const API = window.SEPT && SEPT.BACKEND_URL ? SEPT.BACKEND_URL : "";
const qs = new URLSearchParams(location.search);
const jobId = qs.get("job_id");
const isDriver = qs.get("driver") === "1";
const driverId = (qs.get("driver_id") || localStorage.getItem("st_driver_id") || "").toUpperCase();

if(!jobId){ alert("job_id yok"); throw "job_id missing"; }

const map = L.map("map", { zoomControl:false }).setView([40.195, 29.060], 14);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:20}).addTo(map);

const customerIcon = L.icon({ iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png", iconSize:[32,32], iconAnchor:[16,32] });
const driverIcon   = L.icon({ iconUrl:"https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png", iconSize:[32,32], iconAnchor:[16,32] });

let customerMarker=null, driverMarker=null;
const statusBox=document.getElementById("status");
function setStatus(t){ statusBox.innerText=t; }

async function get(p){
  const r=await fetch(API+"?"+new URLSearchParams(p));
  return r.json();
}
async function post(body, noCors=false){
  const opt = {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  };
  if(noCors) opt.mode="no-cors";
  const r=await fetch(API, opt);
  if(noCors) return { ok:true, opaque:true };
  return r.json();
}

let notFoundCount=0;

async function watchJob(){
  try{
    const j = await get({action:"getJob", job_id:jobId});
    Log.api("getJob", {job_id:jobId}, j);

    if(!j || !j.ok){
      notFoundCount++;
      setStatus(notFoundCount<8 ? "İş oluşturuluyor…" : "İş bulunamadı. (Backend yazmadı / deploy?)");
      return;
    }

    setStatus("Durum: " + (j.status || "—"));

    // pins from live
    const fl = Number(j.from_lat), fg = Number(j.from_lng);
    if(fl && fg && !customerMarker){
      customerMarker=L.marker([fl,fg],{icon:customerIcon}).addTo(map);
      map.setView([fl,fg], 15);
    }

    const dl = Number(j.driver_lat), dg = Number(j.driver_lng);
    if(dl && dg){
      if(!driverMarker) driverMarker=L.marker([dl,dg],{icon:driverIcon}).addTo(map);
      else driverMarker.setLatLng([dl,dg]);
    }

    const cl = Number(j.customer_lat), cg = Number(j.customer_lng);
    if(cl && cg){
      if(!customerMarker) customerMarker=L.marker([cl,cg],{icon:customerIcon}).addTo(map);
      else customerMarker.setLatLng([cl,cg]);
    }
  }catch(e){
    Log.error("watchJob error", e);
    setStatus("Bağlantı hatası…");
  }
}
setInterval(watchJob, SEPT.POLL_MS || 3000);
watchJob();

navigator.geolocation.watchPosition(async pos=>{
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;

  // Backend, searching iken updateLocation reddedebilir; track tarafında yine göndereceğiz.
  const body = {
    action:"updateLocation",
    job_id: jobId,
    who: isDriver ? "driver" : "customer",
    lat, lng
  };
  if(isDriver && driverId) body.driver_id = driverId;

  try{
    // normal -> fallback no-cors
    try{
      const d = await post(body, false);
      Log.api("updateLocation", body, d);
    }catch(_){
      await post(body, true);
    }
  }catch(_){}

  // local marker
  if(isDriver){
    if(!driverMarker) driverMarker=L.marker([lat,lng],{icon:driverIcon}).addTo(map);
    else driverMarker.setLatLng([lat,lng]);
  }else{
    if(!customerMarker) customerMarker=L.marker([lat,lng],{icon:customerIcon}).addTo(map);
    else customerMarker.setLatLng([lat,lng]);
  }
},{ enableHighAccuracy:true });
</script>
</body>
</html>
