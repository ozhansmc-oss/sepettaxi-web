<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}

header{
  height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222
}
header span{color:#f5c400}
#map{height:calc(100vh - 56px)}

.overlay{
  position:fixed;left:50%;transform:translateX(-50%);
  z-index:1000;border-radius:999px;padding:6px 14px;font-size:13px
}
.status{top:70px;background:#111;border:1px solid #333}
.eta{top:110px;background:#f5c400;color:#000;font-weight:900}

.driver-card{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:#111;border:1px solid #333;
  padding:14px 16px;border-radius:18px;min-width:280px;z-index:1000
}
.driver-card b{color:#f5c400}
.badge{display:inline-block;margin-top:6px;padding:4px 10px;border-radius:999px;background:#222;color:#aaa;font-size:12px}
.small{font-size:11px;color:#aaa;margin-top:4px}

.actions{display:flex;gap:8px;margin-top:10px}
.btn{
  flex:1;text-align:center;padding:10px 0;border-radius:999px;
  font-weight:900;font-size:13px;cursor:pointer;text-decoration:none
}
.call{background:#f5c400;color:#000}
.wa{background:#1ebe5d;color:#000}
.hidden{display:none}

/* RATING MODAL */
#ratingModal{
  position:fixed;inset:0;background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;z-index:2000
}
#ratingBox{
  background:#111;border:1px solid #333;border-radius:16px;
  padding:16px;width:90%;max-width:360px
}
.stars{display:flex;justify-content:center;gap:8px;margin:12px 0}
.star{
  font-size:30px;cursor:pointer;color:#333
}
.star.active{color:#f5c400}
textarea{
  width:100%;min-height:70px;border-radius:10px;
  border:0;background:#222;color:#fff;padding:10px
}
.submitBtn{
  margin-top:10px;background:#f5c400;color:#000;
  border-radius:999px;padding:12px;text-align:center;font-weight:900;cursor:pointer
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> â€“ Takip</header>

<div id="status" class="overlay status">YÃ¼kleniyorâ€¦</div>
<div id="eta" class="overlay eta">ETA: â€”</div>

<div id="driverCard" class="driver-card" style="display:none">
  <div><b>SÃ¼rÃ¼cÃ¼</b>: <span id="drvId">â€”</span></div>
  <div class="badge" id="drvStatus">â€”</div>
  <div class="small" id="etaNote">â€”</div>
  <div class="actions" id="contactBtns">
    <a id="callBtn" class="btn call" href="#">ðŸ“ž Ara</a>
    <a id="waBtn" class="btn wa" href="#" target="_blank">ðŸ’¬ WhatsApp</a>
  </div>
</div>

<div id="map"></div>

<!-- RATING -->
<div id="ratingModal">
  <div id="ratingBox">
    <div style="font-weight:900;text-align:center">Yolculuk TamamlandÄ±</div>
    <div class="stars" id="stars"></div>
    <textarea id="comment" placeholder="Yorum (isteÄŸe baÄŸlÄ±)"></textarea>
    <div class="submitBtn" onclick="submitRating()">PUANI GÃ–NDER</div>
  </div>
</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const qs=new URLSearchParams(location.search);
const JOB_ID=qs.get("job_id");
if(!JOB_ID){ alert("job_id bulunamadÄ±"); throw "job_id yok"; }

let map,pickupM,dropM,driverM,routeLine;
let rated=false, rating=0;

/* MAP */
function initMap(){
  map=L.map("map").setView([41,29],12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  setTimeout(()=>map.invalidateSize(),200);
}

/* HAVERSINE */
function hav(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

/* ETA */
function calcETA(a,b,c,d){
  const km=hav(a,b,c,d);
  return Math.max(1,Math.round((km/30)*60));
}

/* LOAD */
async function loadJob(){
  const job=await fetch(
    `${BACKEND}?action=checkJob&job_id=${JOB_ID}`
  ).then(r=>r.json());

  if(!job||job.error){
    status.innerText="Ä°ÅŸ bulunamadÄ±";
    return;
  }

  status.innerText=
    job.status==="completed"?"Ä°ÅŸ tamamlandÄ±":
    job.status==="on_route"?"SÃ¼rÃ¼cÃ¼ yolda":
    job.status==="assigned"?"SÃ¼rÃ¼cÃ¼ atandÄ±":job.status;

  const jobs=await fetch(`${BACKEND}?action=getJobs`).then(r=>r.json());
  const j=jobs.find(x=>x.job_id===JOB_ID);
  if(!j) return;

  if(!pickupM) pickupM=L.marker([j.pickup_lat,j.pickup_lng]).addTo(map);
  if(!dropM) dropM=L.marker([j.dropoff_lat,j.dropoff_lng]).addTo(map);

  if(j.driver_lat&&j.driver_lng){
    if(!driverM) driverM=L.marker([j.driver_lat,j.driver_lng]).addTo(map);
    else driverM.setLatLng([j.driver_lat,j.driver_lng]);

    const m=calcETA(j.driver_lat,j.driver_lng,j.dropoff_lat,j.dropoff_lng);
    eta.innerText="ETA: "+m+" dk";
    etaNote.innerText="â‰ˆ "+m+" dk";

    drvId.innerText=j.driver_id||"â€”";
    drvStatus.innerText=job.status;

    if(j.driver_phone){
      callBtn.href="tel:"+j.driver_phone;
      waBtn.href="https://wa.me/"+j.driver_phone.replace(/^0/,"90");
      contactBtns.classList.remove("hidden");
    }else contactBtns.classList.add("hidden");

    driverCard.style.display="block";
  }

  drawRoute(j);

  if(job.status==="completed" && !rated){
    openRating();
  }
}

/* ROUTE */
function drawRoute(j){
  if(!driverM) return;
  const pts=[
    [j.pickup_lat,j.pickup_lng],
    [j.driver_lat,j.driver_lng],
    [j.dropoff_lat,j.dropoff_lng]
  ];
  if(routeLine) routeLine.setLatLngs(pts);
  else routeLine=L.polyline(pts,{color:"#f5c400",weight:5,dashArray:"8,6"}).addTo(map);
  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}

/* RATING */
function openRating(){
  ratingModal.style.display="flex";
  stars.innerHTML="";
  for(let i=1;i<=5;i++){
    const s=document.createElement("div");
    s.className="star";
    s.innerText="â˜…";
    s.onclick=()=>setStar(i);
    stars.appendChild(s);
  }
}
function setStar(n){
  rating=n;
  [...stars.children].forEach((s,i)=>{
    s.classList.toggle("active",i<n);
  });
}
async function submitRating(){
  if(rating===0){ alert("Puan seÃ§"); return; }
  rated=true;
  ratingModal.style.display="none";

  fetch(BACKEND,{
    method:"POST",
    body:JSON.stringify({
      action:"submitRating",
      job_id:JOB_ID,
      rating,
      comment:comment.value||""
    })
  }).catch(()=>{});
}

initMap();
loadJob();
setInterval(loadJob,4000);
</script>

</body>
</html>
