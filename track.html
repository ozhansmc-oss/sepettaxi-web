<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SepetTaxi | CanlÄ± Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  body {
    margin: 0;
    background: #000;
    color: #fff;
    font-family: Arial, Helvetica, sans-serif;
  }
  header {
    padding: 14px;
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    border-bottom: 1px solid #222;
  }
  #map {
    width: 100%;
    height: calc(100vh - 50px);
  }
  .info {
    position: absolute;
    bottom: 12px;
    left: 12px;
    right: 12px;
    background: rgba(0,0,0,0.75);
    padding: 12px;
    border-radius: 10px;
    font-size: 13px;
  }
</style>
</head>

<body>

<header>ðŸš• SepetTaxi â€“ CanlÄ± Takip</header>
<div id="map"></div>
<div class="info" id="info">YÃ¼kleniyorâ€¦</div>

<script>
/* ==========================
   AYARLAR (KÄ°LÄ°TLÄ°)
========================== */
const API_URL = "https://script.google.com/macros/s/AKfycbyn8FCoEHg4R5nAFGsuFw8GNp5HfMD8RCsr_rJHvf-8_kOijkJEM5GSaYRwzmN6s4ck/exec";
const JOB_ID = new URLSearchParams(window.location.search).get("job_id");
const REFRESH_MS = 4000;

/* ==========================
   KONTROL
========================== */
if(!JOB_ID){
  document.getElementById("info").innerText = "Job ID bulunamadÄ±.";
  throw "Missing job_id";
}

/* ==========================
   HARÄ°TA
========================== */
const map = L.map("map").setView([39.92077, 32.85411], 13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19
}).addTo(map);

let driverMarker = null;

/* ==========================
   BAÅžLAT
========================== */
load();
setInterval(load, REFRESH_MS);

/* ==========================
   JOB + DRIVER OKU
========================== */
function load(){
  fetch(`${API_URL}?action=listJobs`)
    .then(r=>r.json())
    .then(res=>{
      if(!res.ok) return;

      const job = res.jobs.find(j => j.job_id === JOB_ID);
      if(!job){
        document.getElementById("info").innerText = "Ä°ÅŸ bulunamadÄ±.";
        return;
      }

      document.getElementById("info").innerHTML = `
        <b>Ä°ÅŸ No:</b> ${job.job_id}<br>
        <b>Durum:</b> ${job.status}<br>
        <b>AlÄ±m:</b> ${job.pickup_address}<br>
        <b>Teslim:</b> ${job.dropoff_address}
      `;

      if(!job.driver_id){
        document.getElementById("info").innerHTML += "<br><i>SÃ¼rÃ¼cÃ¼ bekleniyorâ€¦</i>";
        return;
      }

      loadDriver(job.driver_id);
    })
    .catch(()=>{});
}

/* ==========================
   DRIVER KONUMU OKU
========================== */
function loadDriver(driverId){
  fetch(`${API_URL}?action=listDrivers`)
    .then(r=>r.json())
    .then(res=>{
      if(!res.ok) return;

      const drv = res.drivers.find(d => d.driver_id === driverId);
      if(!drv || !drv.lat || !drv.lng) return;

      updateMarker(drv.lat, drv.lng);
    })
    .catch(()=>{});
}

/* ==========================
   MARKER
========================== */
function updateMarker(lat, lng){
  const pos = [Number(lat), Number(lng)];

  if(!driverMarker){
    driverMarker = L.marker(pos).addTo(map);
    map.setView(pos, 15);
  } else {
    driverMarker.setLatLng(pos);
  }
}
</script>

</body>
</html>
