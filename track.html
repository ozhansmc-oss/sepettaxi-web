<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi ‚Äì Takip</title>
<meta name="theme-color" content="#050506" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  *{box-sizing:border-box}
  :root{--y:#f5c400;--bg:#050506;--line:rgba(255,255,255,.10);--mut:rgba(255,255,255,.68)}
  html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
  header{
    height:56px;display:flex;align-items:center;justify-content:center;
    border-bottom:1px solid var(--line);background:rgba(5,5,6,.92);
    position:fixed;top:0;left:0;right:0;z-index:5000;backdrop-filter: blur(10px);
    font-weight:900;letter-spacing:.2px
  }
  header b{color:var(--y)}
  #map{position:fixed;inset:56px 0 0 0}
  .pill{
    position:fixed;left:50%;transform:translateX(-50%);
    z-index:7000;border-radius:999px;padding:8px 12px;
    border:1px solid var(--line);background:rgba(20,20,22,.78);
    backdrop-filter: blur(10px);
    font-size:12px;color:var(--mut)
  }
  .pill.top{top:68px}
  .pill.top2{top:108px}

  .vehIcon{
    width:34px;height:34px;border-radius:999px;
    display:grid;place-items:center;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(20,20,22,.85);
    box-shadow:0 10px 30px rgba(0,0,0,.45);
    font-size:16px;
  }
  .leaflet-control-container{display:none}
</style>
</head>
<body>
<header>Sepet<b>Taxi</b> ‚Äì Canlƒ± Takip</header>
<div id="map"></div>
<div class="pill top" id="st">Y√ºkleniyor‚Ä¶</div>
<div class="pill top2" id="st2">Job: ‚Äî</div>

<script>
const API_URL = "PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE"; // .../exec

const qs = new URLSearchParams(location.search);
const job_id = qs.get("job_id") || "";

let map, pickupMarker, dropMarker, driverMarker, line;

function $(id){ return document.getElementById(id); }

async function api(action, payload){
  const r = await fetch(API_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ action, ...payload }) });
  return await r.json();
}

function init(){
  map = L.map("map",{ zoomControl:false, attributionControl:false }).setView([40.1885,29.0610], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ maxZoom:19 }).addTo(map);

  if(!job_id){
    $("st").textContent = "Job bulunamadƒ±.";
    $("st2").textContent = "job_id parametresi eksik";
    return;
  }
  $("st2").textContent = "Job: " + job_id;

  poll();
  setInterval(poll, 2200);
}

function iconOf(serviceType){
  const em = (serviceType==="courier") ? "üèçÔ∏è" : "üöï";
  return L.divIcon({ className:"", html:'<div class="vehIcon">'+em+'</div>', iconSize:[34,34], iconAnchor:[17,17] });
}

async function poll(){
  const res = await api("getJob",{ job_id });
  if(!res || !res.ok){
    $("st").textContent = "Takip edilemiyor: " + (res && (res.error||res.message) ? (res.error||res.message) : "hata");
    return;
  }
  const job = res.job;

  $("st").textContent =
    job.status==="searching" ? ((job.service_type==="courier")?"Kurye aranƒ±yor‚Ä¶":"S√ºr√ºc√º aranƒ±yor‚Ä¶") :
    job.status==="assigned" ? "S√ºr√ºc√º atandƒ±. Kabul bekleniyor‚Ä¶" :
    job.status==="active" ? "Yolda‚Ä¶" :
    job.status==="picked_up" ? "Alƒ±ndƒ±, teslimata gidiyor‚Ä¶" :
    job.status==="done" ? "Tamamlandƒ±" :
    job.status==="cancelled" ? "ƒ∞ptal edildi" :
    ("Durum: " + job.status);

  const a = [Number(job.pickup_lat), Number(job.pickup_lng)];
  const b = [Number(job.dropoff_lat), Number(job.dropoff_lng)];

  if(!pickupMarker){
    pickupMarker = L.marker(a, { icon: L.divIcon({ className:"", html:'<div class="vehIcon">üü°</div>', iconSize:[34,34], iconAnchor:[17,17] })}).addTo(map);
    dropMarker = L.marker(b, { icon: L.divIcon({ className:"", html:'<div class="vehIcon">‚ö´</div>', iconSize:[34,34], iconAnchor:[17,17] })}).addTo(map);
    line = L.polyline([a,b], { weight:4, opacity:.65 }).addTo(map);
    map.fitBounds([a,b], { padding:[30,30] });
  }

  // live driver
  const live = res.live;
  if(live && live.lat && live.lng){
    const p = [Number(live.lat), Number(live.lng)];
    if(!driverMarker){
      driverMarker = L.marker(p, { icon: iconOf(job.service_type) }).addTo(map);
    }else{
      driverMarker.setLatLng(p);
      driverMarker.setIcon(iconOf(job.service_type));
    }
  }
}

init();
</script>
</body>
</html>
