<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Canlı Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222
}
header span{color:#f5c400}
#map{height:calc(100vh - 56px)}
.badge{
  position:fixed;top:66px;left:50%;transform:translateX(-50%);
  background:#111;border:1px solid #222;
  padding:8px 14px;border-radius:999px;font-size:13px
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> – Takip</header>
<div id="map"></div>
<div id="statusBadge" class="badge">Sürücü bekleniyor…</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const jobId = new URLSearchParams(location.search).get("job_id");
if(!jobId){ alert("job_id yok"); }

let map, driverMarker, pollTimer;

map = L.map("map").setView([41,29],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

async function poll(){
  const j = await fetch(`${BACKEND}?action=checkJob&job_id=${jobId}`)
    .then(r=>r.json());

  if(!j || j.error) return;

  if(j.status==="assigned"){
    document.getElementById("statusBadge").innerText="Sürücü atandı";
  }
  if(j.status==="on_route"){
    document.getElementById("statusBadge").innerText="Sürücü yolda";
    loadLive();
  }
  if(j.status==="completed"){
    document.getElementById("statusBadge").innerText="İş tamamlandı";
    clearInterval(pollTimer);
  }
}

async function loadLive(){
  const r = await fetch(`${BACKEND}?action=getLive&job_id=${jobId}`)
    .then(r=>r.json());

  if(!r || !r.lat) return;

  const latlng=[r.lat,r.lng];
  if(!driverMarker){
    driverMarker=L.marker(latlng).addTo(map);
    map.setView(latlng,15);
  }else{
    driverMarker.setLatLng(latlng);
  }
}

pollTimer=setInterval(poll,3000);
</script>

</body>
</html>
