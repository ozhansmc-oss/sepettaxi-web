<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>SepetTaxi – Canlı Takip</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
html,body,#map{height:100%;margin:0;background:#000}
.info{
  position:absolute;top:12px;left:12px;right:12px;
  background:#111;color:#fff;padding:10px;border-radius:12px;z-index:1000;
}
</style>
</head>
<body>

<div class="info" id="info">Takip başlatılıyor…</div>
<div id="map"></div>

<script>
const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxMLho3ZDX1R4EvZz-9MrOOq44807vH0MFd_X8ypSrYB6-vAQAR_dPa-lprAGkR1xsDxQ/exec';
const params = new URLSearchParams(location.search);
const JOB_ID = params.get('job_id');

const map = L.map('map').setView([40.195, 29.060], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let marker = null;

async function refresh(){
  const r = await fetch(BACKEND_URL + '?action=getJobs');
  const jobs = await r.json();
  const job = jobs.find(j=>j.job_id===JOB_ID);

  if(!job){
    document.getElementById('info').innerText = 'İş bulunamadı';
    return;
  }

  if(job.status === 'completed'){
    document.getElementById('info').innerText = 'İş tamamlandı';
    return;
  }

  if(job.driver_lat && job.driver_lng){
    const lat = parseFloat(job.driver_lat);
    const lng = parseFloat(job.driver_lng);

    if(!marker){
      marker = L.marker([lat,lng]).addTo(map);
      map.setView([lat,lng], 16);
    }else{
      marker.setLatLng([lat,lng]);
    }

    document.getElementById('info').innerText =
      'Sürücü yolda • Son konum: ' + (job.last_location_at || '');
  }
}

setInterval(refresh, 4000);
refresh();
</script>
</body>
</html>
