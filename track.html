<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}
#map{height:calc(100vh - 56px)}

.overlay{
  position:fixed;left:50%;transform:translateX(-50%);
  z-index:1000;border-radius:999px;padding:6px 14px;font-size:13px
}
.status{top:70px;background:#111;border:1px solid #333}
.eta{top:110px;background:#f5c400;color:#000;font-weight:900}

/* === SÃœRÃœCÃœ YAKLAÅžIYOR ANÄ°MASYONU === */
.pulse{
  position:fixed;top:150px;left:50%;transform:translateX(-50%);
  padding:10px 18px;border-radius:999px;
  background:rgba(245,196,0,.15);
  border:1px solid #f5c400;color:#f5c400;
  font-weight:900;display:none;
  animation:pulse 1.4s infinite;
}
@keyframes pulse{
  0%{transform:translateX(-50%) scale(1)}
  50%{transform:translateX(-50%) scale(1.08)}
  100%{transform:translateX(-50%) scale(1)}
}

/* === DRIVER CARD === */
.driver-card{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:#111;border:1px solid #333;padding:14px 16px;
  border-radius:18px;min-width:280px;z-index:1000
}
.driver-card b{color:#f5c400}
.badge{display:inline-block;margin-top:6px;padding:4px 10px;border-radius:999px;background:#222;color:#aaa;font-size:12px}
.actions{display:flex;gap:8px;margin-top:10px}
.btn{flex:1;text-align:center;padding:10px 0;border-radius:999px;font-weight:900;font-size:13px}
.call{background:#f5c400;color:#000}
.wa{background:#1ebe5d;color:#000}
.cancel{background:#444;color:#fff}
</style>
</head>

<body>
<header>Sepet<span>Taxi</span> â€“ Takip</header>

<div id="status" class="overlay status">YÃ¼kleniyorâ€¦</div>
<div id="eta" class="overlay eta">ETA: â€”</div>
<div id="pulse" class="pulse">ðŸš— SÃ¼rÃ¼cÃ¼ YaklaÅŸÄ±yor</div>

<div id="driverCard" class="driver-card" style="display:none">
  <div><b>SÃ¼rÃ¼cÃ¼</b>: <span id="drvId">â€”</span></div>
  <div class="badge" id="drvStatus">â€”</div>
  <div class="actions">
    <a class="btn call" href="#">ðŸ“ž Ara</a>
    <a class="btn wa" href="#" target="_blank">ðŸ’¬ WhatsApp</a>
  </div>
</div>

<div id="map"></div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL =
  "https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const JOB_ID = new URLSearchParams(location.search).get("job_id");
if(!JOB_ID){ alert("job_id yok"); }

/* ================= STATE ================= */
let map, pickupM, dropM, driverM, routeLine;
let firstFit=false;
let lastDriverPos=null;

/* ================= MAP ================= */
function initMap(){
  map = L.map("map").setView([40.195,29.060],12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
}

/* ================= DRIVER ICON (ARABA + ROTATE) ================= */
function carIcon(angle=0){
  return L.divIcon({
    html:`<div style="
      width:32px;height:32px;
      transform:rotate(${angle}deg);
      font-size:26px;
      color:#f5c400;
      ">ðŸš—</div>`,
    className:"",
    iconSize:[32,32],
    iconAnchor:[16,16]
  });
}
function bearing(a,b){
  const y=Math.sin(b.lng-a.lng)*Math.cos(b.lat);
  const x=Math.cos(a.lat)*Math.sin(b.lat)-
          Math.sin(a.lat)*Math.cos(b.lat)*Math.cos(b.lng-a.lng);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ================= OSRM ================= */
async function getRoute(aLat,aLng,bLat,bLng){
  const url =
    `https://router.project-osrm.org/route/v1/driving/`+
    `${aLng},${aLat};${bLng},${bLat}?overview=full&geometries=geojson`;

  const r = await fetch(url).then(r=>r.json());
  const g = r.routes[0];
  return {
    pts: g.geometry.coordinates.map(c=>[c[1],c[0]]),
    eta: Math.max(2, Math.round(g.duration/60))
  };
}

/* ================= LOAD ================= */
async function load(){
  const job = await fetch(
    `${BACKEND_URL}?action=checkJob&job_id=${JOB_ID}`
  ).then(r=>r.json());
  if(!job) return;

  drvStatus.innerText = job.status;
  status.innerText =
    job.status==="assigned" ? "SÃ¼rÃ¼cÃ¼ geliyor" :
    job.status==="on_route" ? "VarÄ±ÅŸa gidiliyor" :
    job.status==="completed" ? "TamamlandÄ±" :
    job.status==="cancelled" ? "Ä°ptal edildi" :
    "SÃ¼rÃ¼cÃ¼ bekleniyor";

  pulse.style.display = job.status==="assigned" ? "block" : "none";

  const pLat=+sessionStorage.getItem("SEPT_pickup_lat");
  const pLng=+sessionStorage.getItem("SEPT_pickup_lng");
  const dLat=+sessionStorage.getItem("SEPT_drop_lat");
  const dLng=+sessionStorage.getItem("SEPT_drop_lng");

  if(!pickupM && pLat) pickupM=L.marker([pLat,pLng]).addTo(map);
  if(!dropM && dLat) dropM=L.marker([dLat,dLng]).addTo(map);

  let drvLat=null, drvLng=null;
  const live = await fetch(
    `${BACKEND_URL}?action=getLive&job_id=${JOB_ID}`
  ).then(r=>r.json());

  if(live?.has){
    drvLat=+live.lat; drvLng=+live.lng;
    const pos={lat:drvLat*Math.PI/180,lng:drvLng*Math.PI/180};
    let angle=0;
    if(lastDriverPos){
      angle=bearing(lastDriverPos,pos);
    }
    lastDriverPos=pos;

    if(!driverM)
      driverM=L.marker([drvLat,drvLng],{icon:carIcon(angle)}).addTo(map);
    else{
      driverM.setLatLng([drvLat,drvLng]);
      driverM.setIcon(carIcon(angle));
    }
    driverCard.style.display="block";
  }

  let fromLat=pLat, fromLng=pLng, toLat=dLat, toLng=dLng;
  if(job.status==="assigned"){ fromLat=drvLat;fromLng=drvLng;toLat=pLat;toLng=pLng; }
  if(job.status==="on_route"){ fromLat=drvLat;fromLng=drvLng;toLat=dLat;toLng=dLng; }

  if(fromLat && toLat){
    const r = await getRoute(fromLat,fromLng,toLat,toLng);
    eta.innerText = `ETA: ${r.eta} dk`;

    if(routeLine) routeLine.setLatLngs(r.pts);
    else routeLine=L.polyline(r.pts,{color:"#f5c400",weight:5}).addTo(map);

    if(!firstFit){
      map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
      firstFit=true;
    }
  }
}

/* ================= START ================= */
initMap();
load();
setInterval(load,3000);
</script>

</body>
</html>
