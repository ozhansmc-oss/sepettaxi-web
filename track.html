<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Track</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}
#map{height:56vh}
.panel{padding:10px}
.card{background:#111;border:1px solid #222;border-radius:14px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px}
.pill{flex:1;background:#0f0f0f;border:1px solid #222;border-radius:12px;padding:10px}
.pill .t{font-size:11px;color:#aaa}
.pill .v{font-size:16px;font-weight:900;margin-top:3px}
.btn{background:#f5c400;color:#000;border-radius:16px;padding:14px;text-align:center;font-weight:900;cursor:pointer}
.btn.secondary{background:#333;color:#fff}
.small{font-size:12px;color:#aaa}
a.phone{color:#4da6ff;text-decoration:none;font-weight:900}
</style>
</head>
<body>

<header>Sepet<span>Taxi</span> – Takip</header>
<div id="map"></div>

<div class="panel">
  <div class="row">
    <div class="pill"><div class="t">Brüt</div><div class="v" id="brut">—</div></div>
    <div class="pill" id="pCom"><div class="t">Komisyon</div><div class="v" id="com">—</div></div>
    <div class="pill" id="pNet"><div class="t">Net</div><div class="v" id="net">—</div></div>
  </div>

  <div class="card">
    <div class="small">Durum</div>
    <div style="font-weight:900;font-size:16px" id="status">—</div>
  </div>

  <!-- Driver only: courier details -->
  <div class="card" id="courierBox" style="display:none">
    <div style="font-weight:900;margin-bottom:8px">Kurye Detayları</div>
    <div class="small">Paket</div><div style="font-weight:900" id="pkg">—</div>
    <div style="height:8px"></div>
    <div class="small">Not</div><div style="font-weight:900" id="note">—</div>
    <div style="height:8px"></div>
    <div class="small">Alıcı</div><div style="font-weight:900" id="recv">—</div>
    <div style="height:8px"></div>
    <div class="small">Telefon</div><div><a class="phone" id="rphone" href="#">—</a></div>
  </div>

  <div class="card" id="driverActions" style="display:none">
    <div class="btn" onclick="setStatus('arrived')">GELDİM</div>
    <div style="height:8px"></div>
    <div class="btn" onclick="setStatus('picked')">ALDIM</div>
    <div style="height:8px"></div>
    <div class="btn secondary" onclick="setStatus('completed')">TAMAMLANDI</div>
    <div class="small" style="margin-top:8px">Tahsilat sahada sürücü tarafından yapılır.</div>
  </div>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

const $=id=>document.getElementById(id);
const params=new URLSearchParams(location.search);
const jobId=params.get("job")||"";
const role=(params.get("role")||"customer").toLowerCase();
let driverId=params.get("driver")||localStorage.getItem("SEPET_DRIVER_ID")||"";

let map, meMarker, driverMarker, line;

function qs(o){
  const u=new URL(BACKEND_URL);
  Object.entries(o).forEach(([k,v])=>u.searchParams.set(k,v));
  return u.toString();
}
async function getJob(){
  const r=await fetch(qs({action:"getJob",job_id:jobId}));
  return r.json().catch(()=>({}));
}

function init(){
  if(!jobId){alert("job param yok");return;}
  map=L.map("map").setView([40.195,29.060],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  // UI role
  const isDriver = role==="driver";
  $("driverActions").style.display = isDriver ? "block" : "none";
  $("pCom").style.display = isDriver ? "" : "none";
  $("pNet").style.display = isDriver ? "" : "none";

  // GPS only for driver (optional) – update driver location
  if(isDriver){
    if(!driverId){
      driverId=prompt("Driver ID","")||"";
      if(driverId) localStorage.setItem("SEPET_DRIVER_ID",driverId);
    }
    if(driverId){
      navigator.geolocation.watchPosition(p=>{
        fetch(BACKEND_URL,{method:"POST",body:JSON.stringify({
          action:"updateLocation",job_id:jobId,who:"driver",driver_id:driverId,lat:p.coords.latitude,lng:p.coords.longitude
        })}).catch(()=>{});
      },()=>{}, {enableHighAccuracy:true,maximumAge:5000,timeout:10000});
    }
  }

  poll();
  setInterval(poll, 4000);
}

async function poll(){
  const j=await getJob();
  if(!j.ok) return;

  $("status").textContent = j.status || "—";
  $("brut").textContent = (j.price_brut!=null? Math.round(Number(j.price_brut))+" TL":"—");
  $("com").textContent  = (j.commission_amount!=null? Math.round(Number(j.commission_amount))+" TL":"—");
  $("net").textContent  = (j.price_driver_net!=null? Math.round(Number(j.price_driver_net))+" TL":"—");

  // route
  const a=[Number(j.from_lat||0), Number(j.from_lng||0)];
  const b=[Number(j.to_lat||0), Number(j.to_lng||0)];
  if(a[0] && a[1]){
    if(!meMarker) meMarker=L.marker(a).addTo(map).bindPopup("Başlangıç");
    else meMarker.setLatLng(a);
  }
  if(a[0] && b[0]){
    if(!line){ line=L.polyline([a,b]).addTo(map); map.fitBounds(line.getBounds(),{padding:[18,18]}); }
  }

  // show driver live to customer
  if(j.driver_lat && j.driver_lng){
    const d=[Number(j.driver_lat), Number(j.driver_lng)];
    if(!driverMarker) driverMarker=L.marker(d).addTo(map).bindPopup("Sürücü");
    else driverMarker.setLatLng(d);
  }

  // courier details – only visible for driver
  if(role==="driver" && String(j.service_type)==="courier"){
    $("courierBox").style.display="block";
    $("pkg").textContent = j.pkg_type || "—";
    $("note").textContent = j.content_note || "—";
    $("recv").textContent = j.recv_name || "—";
    $("rphone").textContent = j.recv_phone || "—";
    $("rphone").href = j.recv_phone ? ("tel:"+String(j.recv_phone)) : "#";
  } else {
    $("courierBox").style.display="none";
  }
}

function setStatus(st){
  if(!driverId){
    driverId=prompt("Driver ID","")||"";
    if(driverId) localStorage.setItem("SEPET_DRIVER_ID",driverId);
  }
  fetch(BACKEND_URL,{method:"POST",body:JSON.stringify({
    action:"updateStatus",job_id:jobId,status:st,driver_id:driverId
  })}).catch(()=>{});
}

init();
</script>
</body>
</html>
