<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>SepetTaxi – Canlı Takip</title>
  <meta name="theme-color" content="#0b0b0c" />

  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="config.js"></script>

  <style>
    *{box-sizing:border-box}
    :root{
      --y:#f5c400; --bg:#060607; --line:rgba(255,255,255,.10);
      --panel:rgba(12,12,14,.92); --mut:rgba(255,255,255,.66); --shadow:0 12px 40px rgba(0,0,0,.55);
    }
    html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
    #map{position:fixed;inset:0}
    .leaflet-control-container{display:none}
    .bar{
      position:fixed;left:12px;right:12px;top:12px;z-index:20;
      background:linear-gradient(180deg, rgba(20,22,26,.92), rgba(12,12,14,.92));
      border:1px solid var(--line);border-radius:18px;padding:12px;box-shadow:var(--shadow);
      display:flex;align-items:center;gap:10px;backdrop-filter: blur(12px);
    }
    .dot{width:10px;height:10px;border-radius:99px;background:var(--y);box-shadow:0 0 0 8px rgba(245,196,0,.12)}
    .t{min-width:0}
    .t b{display:block;font-size:13px}
    .t span{display:block;margin-top:3px;font-size:11px;color:var(--mut)}
    .btn{
      margin-left:auto;padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);color:#fff;font-weight:900;cursor:pointer;
    }
    .card{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:20;
      background:linear-gradient(180deg, rgba(20,22,26,.92), rgba(12,12,14,.95));
      border:1px solid var(--line);border-radius:20px;padding:12px;box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
    }
    .row{display:flex;gap:10px}
    .pill{
      flex:1;padding:10px;border-radius:16px;border:1px solid var(--line);
      background:rgba(255,255,255,.04);
    }
    .pill b{display:block;font-size:14px}
    .pill span{display:block;margin-top:4px;font-size:11px;color:var(--mut)}
  </style>
</head>
<body>
<div id="map"></div>

<div class="bar">
  <div class="dot"></div>
  <div class="t">
    <b id="title">Canlı takip</b>
    <span id="subtitle">Bağlantı kuruluyor…</span>
  </div>
  <button class="btn" id="back">Ana Ekran</button>
</div>

<div class="card">
  <div class="row">
    <div class="pill"><b id="km">–</b><span>Mesafe</span></div>
    <div class="pill"><b id="price">–</b><span>Ücret</span></div>
  </div>
</div>

<script>
const CFG = window.SEPETTAXI || {};
const API = (CFG.API_BASE || "").trim();
const $ = (id)=>document.getElementById(id);

function qs(){
  const u = new URL(location.href);
  return Object.fromEntries(u.searchParams.entries());
}
function apiGet(action, params={}){
  return new Promise((resolve, reject)=>{
    if(!API || API.includes("PASTE_YOUR")) return reject(new Error("API_BASE yok / yanlış"));
    const cb = "cb_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    window[cb] = (payload)=>{
      try{ delete window[cb]; }catch(_){ window[cb]=undefined; }
      script.remove();
      if(payload && payload.ok) resolve(payload); else reject(new Error((payload && payload.error) || "API error"));
    };
    const p = new URLSearchParams({action, callback: cb, ...params}).toString();
    const script = document.createElement("script");
    script.src = API + "?" + p;
    script.onerror = ()=>{ try{ delete window[cb]; }catch(_){ } reject(new Error("Network/JSONP error")); };
    document.body.appendChild(script);
  });
}

let map, pickupMarker, dropMarker, driverMarker, line;
function initMap(){
  map = L.map("map", {zoomControl:false, attributionControl:false});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19}).addTo(map);
  map.setView([40.2, 29.06], 13);
}
function icon(letter, accent){
  return L.divIcon({
    className:"",
    html:`<div style="width:34px;height:34px;border-radius:14px;background:rgba(10,10,12,.80);border:1px solid rgba(255,255,255,.18);display:grid;place-items:center;box-shadow:0 10px 22px rgba(0,0,0,.55)">
      <div style="width:18px;height:18px;border-radius:8px;background:${accent};color:#111;display:grid;place-items:center;font-weight:900;font-size:11px">${letter}</div>
    </div>`,
    iconSize:[34,34], iconAnchor:[17,17]
  });
}
function setMarkers(job){
  const p = [Number(job.pickup_lat), Number(job.pickup_lng)];
  const d = [Number(job.dropoff_lat), Number(job.dropoff_lng)];
  if(!pickupMarker) pickupMarker = L.marker(p, {icon: icon("A","rgba(245,196,0,.95)")}).addTo(map);
  else pickupMarker.setLatLng(p);
  if(!dropMarker) dropMarker = L.marker(d, {icon: icon("B","rgba(255,255,255,.92)")}).addTo(map);
  else dropMarker.setLatLng(d);

  if(line) map.removeLayer(line);
  line = L.polyline([p,d], {weight:4, opacity:.7}).addTo(map);
  map.fitBounds(line.getBounds(), {padding:[40,40]});

  $("km").textContent = (job.distance_km ? Number(job.distance_km).toFixed(1) + " km" : "–");
  $("price").textContent = (job.price ? "₺" + job.price : "–");
}
function setDriver(lat,lng){
  const pos=[Number(lat), Number(lng)];
  if(!driverMarker) driverMarker = L.marker(pos, {icon: icon("S","rgba(52,199,89,.95)")}).addTo(map);
  else driverMarker.setLatLng(pos);
}

$("back").onclick = ()=>location.href="index.html";

(async function boot(){
  initMap();
  const {job_id} = qs();
  if(!job_id){ $("subtitle").textContent="job_id yok"; return; }

  $("subtitle").textContent="Job yükleniyor…";

  async function tick(){
    try{
      const r = await apiGet("getJob", {job_id});
      const job = r.job;
      if(!job){ $("subtitle").textContent="Job bulunamadı"; return; }

      setMarkers(job);

      if(job.status === "assigned"){
        $("subtitle").textContent = "Sürücü atandı. Konum bekleniyor…";
      }else if(job.status === "onroute"){
        $("subtitle").textContent = "Sürücü yolda";
      }else if(job.status === "completed"){
        $("subtitle").textContent = "Tamamlandı";
      }else if(job.status === "canceled"){
        $("subtitle").textContent = "İptal";
      }else{
        $("subtitle").textContent = "Durum: " + job.status;
      }

      if(job.driver_lat && job.driver_lng){
        setDriver(job.driver_lat, job.driver_lng);
      }else{
        // driver_live ayrı da olabilir
        if(r.driver_live && r.driver_live.lat) setDriver(r.driver_live.lat, r.driver_live.lng);
      }
    }catch(e){
      $("subtitle").textContent="Bağlantı hatası…";
    }
  }

  await tick();
  setInterval(tick, 2000);
})();
</script>
</body>
</html>
