<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Canlı Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:Arial,Helvetica,sans-serif;
  background:#000;color:#fff
}
:root{--y:#f5c400}

header{
  height:56px;background:#000;border-bottom:1px solid #111;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;font-weight:900
}
header span{color:var(--y)}

#map{height:calc(100vh - 160px)}

.panel{
  padding:12px;background:#0f0f0f;border-top:1px solid #111
}
.row{margin-bottom:6px;font-size:13px}
.status{
  display:inline-block;padding:6px 12px;
  border-radius:999px;background:#111;border:1px solid #222
}
.status.assigned{border-color:#f5c400}
.status.completed{border-color:#4caf50}

.hidden{display:none}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> Takip</header>

<div id="map"></div>

<div class="panel">
  <div class="row"><b>Durum:</b> <span id="status" class="status">—</span></div>
  <div class="row"><b>Nereden:</b> <span id="from">—</span></div>
  <div class="row"><b>Nereye:</b> <span id="to">—</span></div>
  <div class="row"><b>Mesafe:</b> <span id="km">—</span></div>
</div>

<script>
const BACKEND_URL =
  "https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

const params = new URLSearchParams(location.search);
const jobId = params.get("job_id");

if(!jobId){
  alert("job_id yok");
  throw new Error("job_id missing");
}

let map, fromM, toM, driverM;

/* INIT */
document.addEventListener("DOMContentLoaded", ()=>{
  map = L.map("map").setView([41,29], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  loadJob();
  setInterval(loadJob, 5000);
});

/* LOAD JOB */
async function loadJob(){
  const r = await fetch(
    BACKEND_URL +
    "?action=getJob&job_id=" +
    encodeURIComponent(jobId)
  );
  const d = await r.json();
  if(!d || !d.ok) return;

  from.textContent = d.from_addr || "—";
  to.textContent   = d.to_addr || "—";
  km.textContent   = d.distance_km
    ? Number(d.distance_km).toFixed(2) + " km"
    : "—";

  status.textContent = d.status || "—";
  status.className = "status " + (d.status||"");

  // markers
  if(d.from_lat && d.from_lng){
    if(!fromM){
      fromM = L.marker([d.from_lat,d.from_lng]).addTo(map);
      map.setView([d.from_lat,d.from_lng], 14);
    }
  }
  if(d.to_lat && d.to_lng){
    if(!toM){
      toM = L.marker([d.to_lat,d.to_lng]).addTo(map);
    }
  }
  if(d.driver_lat && d.driver_lng){
    if(!driverM){
      driverM = L.marker([d.driver_lat,d.driver_lng],{
        title:"Sürücü"
      }).addTo(map);
    }else{
      driverM.setLatLng([d.driver_lat,d.driver_lng]);
    }
  }
}
</script>

</body>
</html>
