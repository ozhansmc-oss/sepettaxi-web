<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi ‚Äì Takip</title>
<meta name="theme-color" content="#f5c400" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;overflow:hidden;font-family:system-ui}
:root{--y:#f5c400;--line:rgba(255,255,255,.12);--mut:rgba(255,255,255,.72);--mut2:rgba(255,255,255,.45)}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  border-bottom:1px solid var(--line);font-weight:950;position:relative;
}
header .back{
  position:absolute;left:10px;top:8px;width:40px;height:40px;border-radius:12px;
  border:1px solid var(--line);display:grid;place-items:center;cursor:pointer;background:rgba(255,255,255,.03)
}
header span{color:var(--y)}
#map{height:calc(100% - 56px)}
.pill{
  position:fixed;left:50%;transform:translateX(-50%);
  z-index:200;border-radius:999px;padding:8px 12px;font-size:12px;
  border:1px solid var(--line);background:rgba(0,0,0,.45);backdrop-filter:blur(8px);color:var(--mut)
}
.p1{top:70px}
.p2{top:110px}
.badge{color:#fff;font-weight:900}
</style>
</head>
<body>
<header>
  <div class="back" onclick="location.href='index.html'">‚Üê</div>
  Sepet<span>Taxi</span> Takip
</header>

<div id="map"></div>
<div class="pill p1" id="statusPill">Durum: <span class="badge" id="st">‚Äî</span></div>
<div class="pill p2" id="metaPill">ƒ∞≈ü: <span class="badge" id="jid">‚Äî</span></div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxHqb_E0gCqHmxWuzmdHqLb_IR7pHUGixIRd3Hh3MnVqegTPJEdJ4zM5Gb0Tc96Qb8C/exec";

  const qs = new URLSearchParams(location.search);
const jobId = qs.get("job_id") || localStorage.getItem("sepettaxi_last_job_id") || "";
document.getElementById("jid").textContent = jobId || "‚Äî";

const map = L.map("map", { zoomControl:false }).setView([41.0082, 28.9784], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19 }).addTo(map);

let pickupM=null, dropM=null, vehicleM=null;
let serviceType = localStorage.getItem("sepettaxi_last_service") || "taxi";

function iconEmoji(type){
  const html = `<div style="font-size:26px;filter:drop-shadow(0 8px 18px rgba(0,0,0,.6))">${type==="courier"?"üõµ":"üöï"}</div>`;
  return L.divIcon({ className:"", html, iconSize:[26,26], iconAnchor:[13,13] });
}

function apiJSONP(params){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(16).slice(2);
    params.callback = cb;
    const u = new URLSearchParams(params);
    const s = document.createElement("script");
    window[cb] = (data)=>{
      try{ resolve(data); } finally{
        delete window[cb];
        s.remove();
      }
    };
    s.onerror = ()=>{
      delete window[cb];
      s.remove();
      reject(new Error("JSONP load failed"));
    };
    s.src = API + (API.includes("?") ? "&" : "?") + u.toString();
    document.head.appendChild(s);
  });
}


function setStatus(s){ document.getElementById("st").textContent = s || "‚Äî"; }

function ensureMarkers(j){
  const p = {lat:Number(j.pickup_lat), lng:Number(j.pickup_lng)};
  const d = {lat:Number(j.dropoff_lat), lng:Number(j.dropoff_lng)};
  if(isFinite(p.lat)&&isFinite(p.lng) && !pickupM){
    pickupM = L.marker([p.lat,p.lng]).addTo(map).bindPopup("Nereden");
  }
  if(isFinite(d.lat)&&isFinite(d.lng) && !dropM){
    dropM = L.marker([d.lat,d.lng]).addTo(map).bindPopup("Nereye");
  }
  if((pickupM||dropM) && !vehicleM){
    const start = pickupM ? pickupM.getLatLng() : (dropM ? dropM.getLatLng() : map.getCenter());
    vehicleM = L.marker(start, { icon: iconEmoji(serviceType) }).addTo(map);
  }
  if(pickupM && dropM){
    const g = L.featureGroup([pickupM, dropM]);
    map.fitBounds(g.getBounds().pad(0.25));
  }
}

function moveVehicle(j){
  // driver ping varsa oraya; yoksa pickup √ºzerinde beklesin
  const lat = Number(j.last_lat);
  const lng = Number(j.last_lng);
  if(vehicleM){
    if(isFinite(lat)&&isFinite(lng)){
      vehicleM.setLatLng([lat,lng]);
    }else if(pickupM){
      vehicleM.setLatLng(pickupM.getLatLng());
    }
  }
}
(async function boot(){
  try{
    const r = await apiJSONP({ action:"ping" });
    console.log("TRACK PING OK", r);
  }catch(e){
    alert("Backend baƒülantƒ± hatasƒ±");
    return;
  }
})();

async function tick(){
  if(!jobId){
    setStatus("JOB_ID YOK");
    return;
  }
  try{
    const resp = await apiGET({ action:"getJob", job_id: jobId });
    if(!resp || resp.ok !== true){ setStatus("BULUNAMADI"); return; }

    const j = resp.data;
    serviceType = j.service_type || serviceType;
    ensureMarkers(j);
    moveVehicle(j);

    const st = j.status || "‚Äî";
    // UX: net metin
    const pretty =
      st==="SEARCHING" ? "S√ºr√ºc√º aranƒ±yor" :
      st==="ASSIGNED"  ? "S√ºr√ºc√º atandƒ±" :
      st==="ACCEPTED"  ? "S√ºr√ºc√º kabul etti" :
      st==="PICKED_UP" ? "Yolda" :
      st==="DELIVERED" ? "Tamamlandƒ±" :
      st==="CANCELLED" ? "ƒ∞ptal" : st;

apiJSONP({ action:"ping" })
  .then(()=> {
    tick();
    setInterval(tick, 2500);
  })
  .catch(()=> alert("Backend baƒülantƒ± hatasƒ±"));

</script>
</body>
</html>
