<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>SepetTaxi – Canlı Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="config.js"></script>
<script src="log.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
#map{height:100%}
#top{
  position:fixed;left:0;right:0;top:0;height:58px;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,rgba(0,0,0,.72),rgba(0,0,0,.15));
  z-index:500;
}
#top b{font-size:18px}
#top b span{color:#f5c400}
#badge{
  position:fixed;top:70px;left:50%;transform:translateX(-50%);
  padding:10px 14px;border-radius:999px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(16,16,18,.65);
  box-shadow:0 14px 40px rgba(0,0,0,.6);
  z-index:520;
  font-size:13px;color:rgba(255,255,255,.92);
}
</style>
</head>
<body>
<div id="top"><b>Sepet<span>Taxi</span> Takip</b></div>
<div id="map"></div>
<div id="badge">Bağlanıyor…</div>

<script>
const API = (window.SEPT && SEPT.BACKEND_URL) ? SEPT.BACKEND_URL : "";
const qs = new URLSearchParams(location.search);
const jobId = qs.get("job_id");
const isDriver = qs.get("driver") === "1";
if(!jobId){ alert("job_id yok"); throw new Error("job_id missing"); }

const badge = document.getElementById("badge");
let jobStatus = "searching";

const map = L.map("map", { zoomControl:false }).setView([41.0,29.0], 14);
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", { maxZoom:19 }).addTo(map);

const custIcon = L.divIcon({ className:"", html:`<div style="width:18px;height:18px;border-radius:99px;background:#2c7dff;box-shadow:0 0 0 8px rgba(44,125,255,.18)"></div>`, iconSize:[18,18], iconAnchor:[9,9]});
const drvIcon  = L.divIcon({ className:"", html:`<div style="width:18px;height:18px;border-radius:99px;background:#f5c400;box-shadow:0 0 0 8px rgba(245,196,0,.16)"></div>`, iconSize:[18,18], iconAnchor:[9,9]});

let custM=null, drvM=null, line=null;

async function getJob(){
  const data = await fetch(API + "?" + new URLSearchParams({ action:"getJob", job_id: jobId })).then(r=>r.json());
  if(window.Log) Log.api("getJob", {job_id:jobId}, data);

  if(!data || !data.ok) {
    badge.textContent = "İş bulunamadı / bağlantı hatası";
    return;
  }

  jobStatus = String(data.status||"searching");
  badge.textContent = "Durum: " + jobStatus;

  // customer pickup marker from job (from_lat/lng)
  if(data.from_lat && data.from_lng){
    const ll = [Number(data.from_lat), Number(data.from_lng)];
    if(!custM){ custM = L.marker(ll, {icon:custIcon}).addTo(map); map.setView(ll, 15); }
  }

  // live markers
  if(data.customer_lat && data.customer_lng){
    const ll = [Number(data.customer_lat), Number(data.customer_lng)];
    if(!custM) custM = L.marker(ll, {icon:custIcon}).addTo(map);
    else custM.setLatLng(ll);
  }
  if(data.driver_lat && data.driver_lng){
    const ll = [Number(data.driver_lat), Number(data.driver_lng)];
    if(!drvM) drvM = L.marker(ll, {icon:drvIcon}).addTo(map);
    else drvM.setLatLng(ll);
  }

  // line
  if(custM && drvM){
    const a = custM.getLatLng(), b = drvM.getLatLng();
    if(line) line.remove();
    line = L.polyline([a,b], { color:"#f5c400", weight:5, opacity:.9, dashArray:"10 10" }).addTo(map);
  }
}

setInterval(getJob, (SEPT && SEPT.POLL_MS) ? SEPT.POLL_MS : 3000);
getJob();

/* CORS-safe POST */
async function postLocation(who, lat, lng){
  if(jobStatus === "searching") return; // backend rejects early updates
  const payload = JSON.stringify({
    action:"updateLocation",
    job_id: jobId,
    who,
    lat, lng
  });
  try{
    const r = await fetch(API, {
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: payload
    });
    let d=null; try{ d=await r.json(); }catch(_){}
    if(window.Log) Log.api("updateLocation", {who,lat,lng}, d);
  }catch(_){}
}

// watch location
if(navigator.geolocation){
  navigator.geolocation.watchPosition((pos)=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    postLocation(isDriver ? "driver" : "customer", lat, lng);
  }, ()=>{}, { enableHighAccuracy:true, maximumAge:2000, timeout:12000 });
}
</script>
</body>
</html>
