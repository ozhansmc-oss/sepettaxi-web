<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Canlı Takip</title>

<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;overflow:hidden}
#map{height:100%;width:100%}

.liveStatus{
  position:absolute;top:14px;left:50%;transform:translateX(-50%);
  z-index:1000;background:rgba(15,15,18,.88);
  border:1px solid rgba(255,255,255,.15);
  border-radius:999px;padding:8px 14px;
  font-size:13px;font-weight:800;backdrop-filter:blur(10px)
}

.infoBox{
  position:absolute;bottom:18px;left:50%;transform:translateX(-50%);
  z-index:1000;background:rgba(15,15,18,.88);
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;padding:10px 14px;
  font-size:14px;font-weight:800;display:flex;gap:14px
}
</style>
</head>

<body>

<div id="map"></div>
<div id="liveStatus" class="liveStatus">Sürücü aranıyor</div>
<div class="infoBox">
  <div id="distTxt">–</div>
  <div id="etaTxt">–</div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbzXbm934CXIjTSL9RxmL8kkCjGERoeiQPDfY-OUk2Lexqqr_UvppoJ2yT0t562aJZdxRg/exec";
const jobId = new URLSearchParams(location.search).get("job_id");
if(!jobId){ alert("job_id yok"); }

/* ================= MAP ================= */
const map = L.map("map",{zoomControl:false}).setView([40.195,29.060],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

/* ================= ICONS ================= */
const taxiIcon = L.icon({
  iconUrl:"icons/taxi.png", iconSize:[42,42], iconAnchor:[21,21]
});
const courierIcon = L.icon({
  iconUrl:"icons/courier.png", iconSize:[40,40], iconAnchor:[20,20]
});

/* ================= STATE ================= */
let pickupMarker=null, dropMarker=null, driverMarker=null;
let routeLine=null;
let lastDriverPos=null;

/* ================= HELPERS ================= */
function post(action,data){
  return fetch(API,{method:"POST",body:new URLSearchParams({action,...data})})
    .then(r=>r.json());
}

function haversineKm(a,b,c,d){
  const R=6371, dLat=(c-a)*Math.PI/180, dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function bearing(a,b,c,d){
  const y=Math.sin((d-b)*Math.PI/180)*Math.cos(c*Math.PI/180);
  const x=Math.cos(a*Math.PI/180)*Math.sin(c*Math.PI/180)-
          Math.sin(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.cos((d-b)*Math.PI/180);
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ================= POLLING ================= */
async function loadJob(){
  const r=await post("getJob",{job_id:jobId});
  if(!r.ok||!r.job) return;
  const j=r.job;

  // status
  const st=document.getElementById("liveStatus");
  if(j.status==="searching") st.textContent="Sürücü aranıyor";
  if(j.status==="assigned") st.textContent="Sürücü atandı, yola çıkıyor";
  if(j.status==="onroad")   st.textContent="Sürücü yolda";
  if(j.status==="completed")st.textContent="Yolculuk tamamlandı";

  // pickup / drop
  if(!pickupMarker && j.pickup_lat){
    pickupMarker=L.marker([j.pickup_lat,j.pickup_lng]).addTo(map);
    map.setView([j.pickup_lat,j.pickup_lng],15);
  }
  if(!dropMarker && j.dropoff_lat){
    dropMarker=L.marker([j.dropoff_lat,j.dropoff_lng]).addTo(map);
  }

  // driver
  if(j.driver_lat){
    const pos=[j.driver_lat,j.driver_lng];
    const icon=(j.service_type==="courier")?courierIcon:taxiIcon;

    if(!driverMarker){
      driverMarker=L.marker(pos,{icon}).addTo(map);
      map.setView(pos,16);
    }else{
      driverMarker.setLatLng(pos);
      map.panTo(pos,{animate:true,duration:0.8});
      map.invalidateSize();
    }

    // bearing (ikon yönü)
    if(lastDriverPos){
      const deg=bearing(lastDriverPos[0],lastDriverPos[1],pos[0],pos[1]);
      driverMarker.getElement().style.transform += ` rotate(${deg}deg)`;
    }
    lastDriverPos=pos;

    // route line
    if(j.pickup_lat){
      if(routeLine) map.removeLayer(routeLine);
      routeLine=L.polyline([pos,[j.pickup_lat,j.pickup_lng]],{
        color:"#f5c400", weight:4, opacity:.85
      }).addTo(map);

      // distance + ETA
      const km=haversineKm(pos[0],pos[1],j.pickup_lat,j.pickup_lng);
      document.getElementById("distTxt").textContent=km.toFixed(2)+" km";
      const min=Math.max(1,Math.round((km/30)*60));
      document.getElementById("etaTxt").textContent="≈ "+min+" dk";
    }
  }
}

setInterval(loadJob,4000);
loadJob();
</script>

</body>
</html>
