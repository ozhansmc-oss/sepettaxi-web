<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi – Canlı Takip</title>
<meta name="theme-color" content="#000000" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  *{box-sizing:border-box}
  :root{--y:#f5c400; --line:rgba(255,255,255,.10); --mut:rgba(255,255,255,.65); --ok:#2bd576}
  html,body{height:100%; margin:0; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden}
  header{
    height:56px; display:flex; align-items:center; justify-content:center;
    border-bottom:1px solid rgba(255,255,255,.08);
    position:relative;
  }
  header .t{font-weight:900}
  header .t span{color:var(--y)}
  #map{height:calc(100vh - 56px); width:100%}
  .pill{
    position:fixed; left:50%; transform:translateX(-50%);
    top:70px; z-index:1200;
    padding:10px 14px; border-radius:999px;
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.14);
    backdrop-filter:blur(10px);
    font-weight:900;
    display:flex; align-items:center; gap:10px;
  }
  .dot{width:10px; height:10px; border-radius:5px; background:rgba(255,255,255,.35)}
  .dot.ok{background:var(--ok)}
  .dot.y{background:var(--y)}
  .sub{
    position:fixed; left:50%; transform:translateX(-50%);
    top:114px; z-index:1200;
    padding:8px 12px; border-radius:999px;
    background:rgba(0,0,0,.45);
    border:1px solid rgba(255,255,255,.12);
    color:rgba(255,255,255,.75);
    font-weight:800;
  }

  /* vehicle marker container for rotation */
  .vehWrap{
    width:44px; height:44px;
    transform-origin:50% 50%;
    filter:drop-shadow(0 10px 14px rgba(0,0,0,.55));
  }
</style>
</head>
<body>
<header><div class="t">Sepet<span>Taxi</span> Takip</div></header>
<div id="map"></div>
<div class="pill"><span id="dot" class="dot y"></span><span id="status">Yükleniyor…</span></div>
<div class="sub" id="sub">Lütfen bekleyin</div>

<script>
const API = (localStorage.getItem("SEPETTAXI_API") || "https://script.google.com/macros/s/AKfycbxoeXl9XfxWtsqqCfftNV578KD_woNSKfT3KmSYwZuCv8iPSPd8-cZXNoYMh6Qx-yrlWA/exec").trim();

function qs(name){
  const u = new URL(location.href);
  return u.searchParams.get(name) || "";
}
const jobId = qs("job_id");

function ensureAPI(){
  if(!API){
    alert("API URL tanımlı değil. SEPETTAXI_API ayarlayın.");
    throw new Error("API missing");
  }
}
async function apiGet(action, params){
  ensureAPI();
  const u = new URL(API);
  u.searchParams.set("action", action);
  Object.keys(params||{}).forEach(k=> u.searchParams.set(k, params[k]));
  const r = await fetch(u.toString());
  const j = await r.json();
  if(j && j.error) throw new Error(j.error);
  return j;
}

/* Map */
const map = L.map("map", { zoomControl:false, attributionControl:false });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

let pickupMarker=null, dropMarker=null;
let vehMarker=null;
let lastVeh=null; // {lat,lng}
let animReq=null;
let currentHeading=0;

function setStatus(text, kind){
  document.getElementById("status").textContent = text;
  const dot = document.getElementById("dot");
  dot.classList.remove("ok","y");
  dot.classList.add(kind==="ok" ? "ok" : "y");
}
function setSub(text){
  document.getElementById("sub").textContent = text;
}

/* Icons */
function taxiSVG(){
  return `
  <div class="vehWrap" style="transform:rotate(${currentHeading}deg)">
    <svg viewBox="0 0 64 64" width="44" height="44" aria-hidden="true">
      <path d="M14 28c2-8 6-14 10-15h16c4 1 8 7 10 15l2 8c.6 2.5-1 5-3.6 5H15.6C13 41 11.4 38.5 12 36l2-8z" fill="#f5c400"/>
      <path d="M22 18h20c2 0 4 2 5 7H17c1-5 3-7 5-7z" fill="#111"/>
      <rect x="18" y="34" width="10" height="8" rx="2" fill="#111"/>
      <rect x="36" y="34" width="10" height="8" rx="2" fill="#111"/>
      <circle cx="18" cy="44" r="4" fill="#000"/><circle cx="46" cy="44" r="4" fill="#000"/>
      <rect x="28" y="12" width="8" height="6" rx="2" fill="#111"/>
    </svg>
  </div>`;
}
function motoSVG(){
  return `
  <div class="vehWrap" style="transform:rotate(${currentHeading}deg)">
    <svg viewBox="0 0 64 64" width="44" height="44" aria-hidden="true">
      <path d="M26 10h12c2 0 4 2 5 5l2 8c.6 2.5 2.2 4.2 4.8 6.2l2.2 1.6c2 1.4 3 3.6 3 6.0V42c0 2.2-1.8 4-4 4H13c-2.2 0-4-1.8-4-4v-4.8c0-2.4 1.1-4.6 3-6.0l2.2-1.6c2.6-2 4.2-3.7 4.8-6.2l2-8c1-3 3-5 5-5z" fill="#f5c400"/>
      <rect x="26" y="14" width="12" height="10" rx="3" fill="#111"/>
      <rect x="22" y="26" width="20" height="10" rx="5" fill="#111"/>
      <circle cx="18" cy="46" r="5" fill="#000"/>
      <circle cx="46" cy="46" r="5" fill="#000"/>
      <path d="M20 36h24" stroke="#000" stroke-width="3" opacity=".85"/>
    </svg>
  </div>`;
}

function makeVehIcon(service_type){
  const html = (service_type==="courier_moto") ? motoSVG() : taxiSVG();
  return L.divIcon({ className:"", html, iconSize:[44,44], iconAnchor:[22,22] });
}

/* Smooth move + heading */
function bearingDeg(a,b){
  const y = Math.sin((b.lng-a.lng)*Math.PI/180) * Math.cos(b.lat*Math.PI/180);
  const x = Math.cos(a.lat*Math.PI/180)*Math.sin(b.lat*Math.PI/180) -
            Math.sin(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.cos((b.lng-a.lng)*Math.PI/180);
  const brng = Math.atan2(y, x) * 180/Math.PI;
  return (brng + 360) % 360;
}

function animateVehicle(fromLL, toLL, service_type){
  if(animReq) cancelAnimationFrame(animReq);
  const start = performance.now();
  const dur = (service_type==="courier_moto") ? 900 : 1200; // moto slightly snappier
  const startHeading = currentHeading;
  const targetHeading = bearingDeg(fromLL, toLL);

  function easeOut(t){ return 1 - Math.pow(1-t, 2); }

  function step(now){
    const t = Math.min(1, (now-start)/dur);
    const k = easeOut(t);

    const lat = fromLL.lat + (toLL.lat - fromLL.lat)*k;
    const lng = fromLL.lng + (toLL.lng - fromLL.lng)*k;

    // interpolate heading shortest path
    let dh = ((targetHeading - startHeading + 540) % 360) - 180;
    currentHeading = (startHeading + dh*k + 360) % 360;

    if(vehMarker){
      vehMarker.setLatLng([lat,lng]);
      vehMarker.setIcon(makeVehIcon(service_type)); // update rotation via html
    }
    if(t < 1){
      animReq = requestAnimationFrame(step);
    }
  }
  animReq = requestAnimationFrame(step);
}

/* Polling */
let lastService="taxi";
async function tick(){
  if(!jobId){
    setStatus("Job bulunamadı", "y");
    setSub("Geçersiz bağlantı");
    return;
  }
  try{
    const j = await apiGet("getJob", { job_id: jobId });

    // markers
    const pu = {lat: Number(j.pickup_lat), lng: Number(j.pickup_lng)};
    const dr = {lat: Number(j.dropoff_lat), lng: Number(j.dropoff_lng)};
    if(!pickupMarker){
      pickupMarker = L.marker([pu.lat, pu.lng]).addTo(map).bindPopup("Alım");
      dropMarker = L.marker([dr.lat, dr.lng]).addTo(map).bindPopup("Varış");
      const b = L.latLngBounds([pu.lat,pu.lng],[dr.lat,dr.lng]);
      map.fitBounds(b.pad(0.35));
    }

    // status mapping
    const st = (j.status||"open");
    const svc = (j.service_type||"taxi");
    lastService = svc;

    if(st==="open"){
      setStatus(svc==="courier_moto" ? "Kuryeniz aranıyor" : "Sürücü aranıyor", "y");
      setSub("Yakın sürücülerle eşleşiyoruz");
    }else if(st==="assigned"){
      setStatus(svc==="courier_moto" ? "Kuryeniz yolda" : "Taksiniz yolda", "ok");
      setSub("Canlı konum güncelleniyor");
    }else if(st==="arrived"){
      setStatus(svc==="courier_moto" ? "Kuryeniz geldi" : "Taksiniz geldi", "ok");
      setSub("Varış noktasında");
    }else if(st==="completed"){
      setStatus("Tamamlandı", "ok");
      setSub("Teşekkürler");
    }else{
      setStatus("Durum güncelleniyor", "y");
      setSub("Lütfen bekleyin");
    }

    // vehicle
    const dlat = Number(j.driver_lat||0);
    const dlng = Number(j.driver_lng||0);
    if(dlat && dlng && (st==="assigned" || st==="arrived")){
      const cur = {lat:dlat, lng:dlng};
      if(!vehMarker){
        vehMarker = L.marker([cur.lat, cur.lng], { icon: makeVehIcon(svc) }).addTo(map);
        lastVeh = cur;
      }else{
        // smooth animate
        if(lastVeh){
          animateVehicle(lastVeh, cur, svc);
        }else{
          vehMarker.setLatLng([cur.lat, cur.lng]);
          vehMarker.setIcon(makeVehIcon(svc));
        }
        lastVeh = cur;
      }
    }
  }catch(e){
    setStatus("Bağlantı sorunu", "y");
    setSub(e.message || "Tekrar deneniyor");
  }finally{
    setTimeout(tick, 2500);
  }
}

tick();
</script>
</body>
</html>
