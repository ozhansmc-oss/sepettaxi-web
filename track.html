<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi ‚Äì Canlƒ± Takip</title>

<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="config.js"></script><!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi ‚Äì Takip</title>
<style>
body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Arial,Helvetica,sans-serif;
  display:flex;
  align-items:center;
  justify-content:center;
  height:100vh;
  font-size:22px;
  font-weight:900;
}
</style>
</head>
<body>
<div id="status">‚è≥ Y√ºkleniyor‚Ä¶</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";
const jobId = new URLSearchParams(location.search).get("job_id");
const box = document.getElementById("status");

if(!jobId){
  box.textContent = "‚ùå job_id yok";
}else{
  setInterval(async ()=>{
    try{
      const res = await fetch(API + "?action=getJob&job_id=" + encodeURIComponent(jobId));
      const data = await res.json();

      if(!data.ok){
        box.textContent = "‚ö†Ô∏è ƒ∞≈ü bulunamadƒ±";
        return;
      }

      if(data.job.status === "assigned"){
        box.textContent = "üöï S√ºr√ºc√º atandƒ±";
      }else{
        box.textContent = "üîç S√ºr√ºc√º aranƒ±yor‚Ä¶";
      }
    }catch(e){
      box.textContent = "‚ö†Ô∏è Baƒülantƒ± hatasƒ±";
    }
  }, 3000);
}
</script>
</body>
</html>

<script src="log.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--line:#222}
header{
  position:fixed;top:0;left:0;right:0;height:56px;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;background:rgba(0,0,0,.85);
  border-bottom:1px solid var(--line);z-index:500
}
header span{color:var(--y)}
#map{position:absolute;top:56px;bottom:120px;left:0;right:0}
#statusBar{
  position:fixed;left:0;right:0;bottom:64px;
  padding:10px 14px;background:rgba(0,0,0,.85);
  border-top:1px solid var(--line);font-size:14px;z-index:600;
  text-align:center;font-weight:900
}
#statusBar span{color:var(--y)}
#infoBar{
  position:fixed;left:0;right:0;bottom:0;height:64px;
  background:#000;border-top:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-around;z-index:600
}
.info{text-align:center;font-size:12px}
.info b{display:block;font-size:16px;font-weight:900}
</style>
</head>
<body>

<header>Sepet<span>Taxi</span> Canlƒ± Takip</header>
<div id="map"></div>

<div id="statusBar">Durum: <span id="status">Baƒülanƒ±yor‚Ä¶</span></div>

<div id="infoBar">
  <div class="info"><b id="dist">‚Äî</b>Mesafe</div>
  <div class="info"><b id="eta">‚Äî</b>Tahmini S√ºre</div>
  <div class="info"><b id="price">‚Äî</b>√úcret</div>
</div>

<script>
const qs = new URLSearchParams(location.search);
const jobId = qs.get("job_id");
const isDriver = qs.get("driver")==="1";

if(!jobId){ alert("job_id bulunamadƒ±"); throw new Error("job_id missing"); }

const $=id=>document.getElementById(id);
function setStatus(s){ $("status").textContent=s; }

async function apiGet(params){
  const url = SEPT.BACKEND_URL + "?" + new URLSearchParams(params);
  const r = await fetch(url);
  const d = await r.json();
  if(window.Log) Log.api(params.action, params, d);
  return d;
}
async function apiPost(bodyObj){
  const payload = JSON.stringify(bodyObj || {});
  const r = await fetch(SEPT.BACKEND_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: payload
  });
  let d=null;
  try{ d = await r.json(); }catch(_){}
  if(window.Log) Log.api(bodyObj.action, bodyObj, d);
  return d;
}

/* MAP */
const map=L.map("map",{zoomControl:false, attributionControl:false});
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19}).addTo(map);

let customerMarker=null, driverMarker=null, routeLine=null;
let serviceType=null;

function divIconEmoji(emoji){
  return L.divIcon({
    className:"",
    html:`<div style="width:44px;height:44px;border-radius:22px;background:rgba(245,196,0,.22);display:flex;align-items:center;justify-content:center;box-shadow:0 18px 40px rgba(0,0,0,.55)">
      <div style="width:34px;height:34px;border-radius:18px;background:#f5c400;display:flex;align-items:center;justify-content:center;font-size:18px">${emoji}</div>
    </div>`,
    iconSize:[44,44], iconAnchor:[22,36]
  });
}
const driverTaxiIcon = divIconEmoji("üöï");
const driverMotoIcon = divIconEmoji("üõµ");
const userIcon = L.divIcon({
  className:"",
  html:`<div style="width:18px;height:18px;border-radius:999px;background:#2c7dff;box-shadow:0 0 0 8px rgba(44,125,255,.18), 0 10px 20px rgba(0,0,0,.55)"></div>`,
  iconSize:[18,18], iconAnchor:[9,9]
});

function calcKm(a,b){
  const R=6371;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLon=(b.lng-a.lng)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

async function watchJob(){
  try{
    const j = await apiGet({action:"getJob",job_id:jobId});
    if(!j || !j.ok) return;

    serviceType = String(j.service_type||"") || serviceType;

    if(j.status) setStatus(String(j.status).toUpperCase());
    $("dist").textContent = j.distance_km ? Number(j.distance_km).toFixed(1)+" km" : "‚Äî";
    $("price").textContent = j.price_brut ? j.price_brut+" TL" : "‚Äî";

    if(j.from_lat && j.from_lng){
      if(!customerMarker){
        customerMarker = L.marker([j.from_lat,j.from_lng],{icon:userIcon}).addTo(map);
        map.setView([j.from_lat,j.from_lng],15);
      }else{
        customerMarker.setLatLng([j.from_lat,j.from_lng]);
      }
    }

    if(j.driver_lat && j.driver_lng){
      const drvIcon = (serviceType==="courier") ? driverMotoIcon : driverTaxiIcon;
      if(!driverMarker){
        driverMarker = L.marker([j.driver_lat,j.driver_lng],{icon:drvIcon}).addTo(map);
      }else{
        driverMarker.setLatLng([j.driver_lat,j.driver_lng]).setIcon(drvIcon);
      }
    }

    if(customerMarker && driverMarker){
      const a = customerMarker.getLatLng();
      const b = driverMarker.getLatLng();

      if(!routeLine){
        routeLine = L.polyline([a,b],{color:"#f5c400",weight:3,opacity:.85,dashArray:"10 10"}).addTo(map);
        map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
      }else{
        routeLine.setLatLngs([a,b]);
      }

      const km = calcKm(b,a);
      $("eta").textContent = Math.max(1, Math.round(km/0.5)) + " dk";
    }
  }catch(e){
    console.error(e);
  }
}

// first paint + polling
watchJob();
setInterval(watchJob, Number(SEPT.POLL_MS||3000));

/* LIVE LOCATION PUSH */
if(navigator.geolocation){
  navigator.geolocation.watchPosition(
    (pos)=>{
      apiPost({
        action:"updateLocation",
        job_id:jobId,
        who: isDriver ? "driver" : "customer",
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      }).catch(()=>{});
    },
    ()=>{},
    { enableHighAccuracy:true, maximumAge:5000, timeout:15000 }
  );
}

if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js").catch(()=>{});
}
</script>
</body>
</html>
