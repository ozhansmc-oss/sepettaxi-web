<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ CanlÄ± Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  border-bottom:1px solid #222
}
header span{color:#f5c400}

#map{height:100vh}

.info{
  position:fixed;
  top:68px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  border:1px solid #222;
  border-radius:16px;
  padding:12px 16px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,.6);
  z-index:999;
  min-width:260px
}
.info .driver{
  font-weight:900;
  margin-bottom:4px
}
.info .status{
  font-size:13px;
  color:#aaa
}
.badge{
  display:inline-block;
  margin-top:6px;
  padding:4px 10px;
  border-radius:12px;
  font-size:12px;
  background:#f5c400;
  color:#000;
  font-weight:900
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> â€“ CanlÄ± Takip</header>

<div id="map"></div>

<div class="info">
  <div class="driver" id="driverName">SÃ¼rÃ¼cÃ¼: â€”</div>
  <div class="status" id="statusText">SÃ¼rÃ¼cÃ¼ bekleniyorâ€¦</div>
  <div class="badge" id="statusBadge" style="display:none">YOLDA</div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND =
  "https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

/* ================= PARAM ================= */
const q = new URLSearchParams(location.search);
const jobId = q.get("job_id");
const token = q.get("token"); // public tracking

if(!jobId || !token){
  alert("Takip bilgisi eksik");
}

/* ================= MAP ================= */
const map = L.map("map").setView([40.195,29.060],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* ================= ICON ================= */
const carIcon = L.divIcon({
  html: "ðŸš—",
  iconSize: [30,30],
  className: ""
});

let carMarker = null;
let lastPos = null;

/* ================= UI ================= */
function setStatus(job){
  const s = job.status;
  const text = document.getElementById("statusText");
  const badge = document.getElementById("statusBadge");
  const driver = document.getElementById("driverName");

  driver.innerText = "SÃ¼rÃ¼cÃ¼: " + (job.driver_id || "â€”");

  if(s === "assigned"){
    text.innerText = "SÃ¼rÃ¼cÃ¼ kabul etti";
    badge.style.display = "none";
  }
  if(s === "on_route"){
    text.innerText = "SÃ¼rÃ¼cÃ¼ yolda";
    badge.style.display = "inline-block";
    badge.innerText = "YOLDA";
  }
  if(s === "completed"){
    text.innerText = "Teslim edildi";
    badge.style.display = "inline-block";
    badge.innerText = "TAMAMLANDI";
  }
}

/* ================= ANIMATE ================= */
function moveMarker(lat,lng){
  if(!carMarker){
    carMarker = L.marker([lat,lng],{icon:carIcon}).addTo(map);
    map.setView([lat,lng],15);
    lastPos = {lat,lng};
    return;
  }

  const steps = 20;
  let i = 0;
  const dLat = (lat - lastPos.lat) / steps;
  const dLng = (lng - lastPos.lng) / steps;

  const anim = setInterval(()=>{
    i++;
    const p = [
      lastPos.lat + dLat * i,
      lastPos.lng + dLng * i
    ];
    carMarker.setLatLng(p);
    if(i >= steps){
      clearInterval(anim);
      lastPos = {lat,lng};
    }
  }, 50);
}

/* ================= POLLING ================= */
async function poll(){
  // job status
  const j = await fetch(`${BACKEND}?action=getPublicJob&job_id=${jobId}&token=${token}`)
    .then(r=>r.json());

  if(j.error) return;

  setStatus(j);

  // live location
  if(j.status === "on_route"){
    const l = await fetch(`${BACKEND}?action=getLive&job_id=${jobId}`)
      .then(r=>r.json());

    if(!l.error){
      moveMarker(Number(l.lat), Number(l.lng));
    }
  }
}

setInterval(poll, 3000);
poll();
</script>

</body>
</html>
