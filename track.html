<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SepetTaxi ‚Äì Canlƒ± Takip</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
body{margin:0;font-family:Arial;background:#0b1220;color:#fff}
header{padding:14px;background:#111c33;font-weight:700}
#map{height:60vh}
.wrap{padding:14px}
.small{font-size:13px;color:#9ca3af}
</style>
</head>
<body>

<header>üìç SepetTaxi ‚Äì Canlƒ± Takip</header>
<div id="map"></div>
<div class="wrap">
  <div id="info" class="small">Y√ºkleniyor‚Ä¶</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzj7yAEHRbMus-F0Un-PH_9ogviUOLLplHPXR6NfWZ1c-vqHwInuOj8i5_wL8vMURqR/exec";
const jobId = new URLSearchParams(location.search).get("job_id");

if(!jobId){
  document.getElementById("info").innerText="HATA: job_id yok";
  throw "";
}

let map = L.map("map").setView([40.195,29.060],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let pM,dM,drvM;

async function api(d){
  const r = await fetch(API_URL,{method:"POST",body:JSON.stringify(d)});
  return r.json();
}

function set(ref,lat,lng,label){
  if(!ref) return L.marker([lat,lng]).addTo(map).bindPopup(label);
  ref.setLatLng([lat,lng]); return ref;
}

async function load(){
  const r = await api({action:"getJob",job_id:jobId});
  if(!r.ok){ document.getElementById("info").innerText="Job yok"; return; }

  const j = r.job;
  document.getElementById("info").innerText =
    `Fiyat: ${j.price} TL | Mesafe: ${j.distance} km | Durum: ${j.status}`;

  pM = set(pM,j.pickup_lat,j.pickup_lng,"Alƒ±≈ü");
  dM = set(dM,j.dropoff_lat,j.dropoff_lng,"Varƒ±≈ü");

  if(r.driver_loc){
    drvM = set(drvM,r.driver_loc.lat,r.driver_loc.lng,"S√ºr√ºc√º");
  }
}

setInterval(load,3000);
load();
</script>
</body>
</html>
