<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Takip</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}

html,body{
  margin:0;
  height:100%;
  font-family:Arial,Helvetica,sans-serif;
  background:#000;
  color:#fff;
}

/* HEADER */
header{
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  border-bottom:1px solid #222;
}
header span{color:#f5c400}

/* MAP â€“ ðŸ”´ KRÄ°TÄ°K */
#map{
  width:100%;
  height:calc(100vh - 56px);
}

/* STATUS BADGE */
#statusBadge{
  position:fixed;
  top:66px;
  left:50%;
  transform:translateX(-50%);
  background:#111;
  border:1px solid #222;
  padding:8px 14px;
  border-radius:999px;
  font-size:13px;
  z-index:1000;
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> â€“ Takip</header>
<div id="map"></div>
<div id="statusBadge">SÃ¼rÃ¼cÃ¼ bekleniyorâ€¦</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const jobId = new URLSearchParams(location.search).get("job_id");
if(!jobId){
  alert("job_id bulunamadÄ±");
}

/* MAP INIT */
let map = L.map("map",{zoomControl:true}).setView([41,29],13);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
  maxZoom:19,
  attribution:"Â© OpenStreetMap"
}).addTo(map);

/* ðŸ”´ LEAFLET FIX â€“ OLMAZSA HARÄ°TA GELMEZ */
setTimeout(()=>{
  map.invalidateSize(true);
},500);

let driverMarker = null;
let pollTimer = null;

/* POLL JOB STATUS */
async function pollJob(){
  try{
    const r = await fetch(`${BACKEND}?action=checkJob&job_id=${jobId}`);
    const j = await r.json();
    if(!j || j.error) return;

    if(j.status==="assigned"){
      setBadge("SÃ¼rÃ¼cÃ¼ atandÄ±");
    }

    if(j.status==="on_route"){
      setBadge("SÃ¼rÃ¼cÃ¼ yolda");
      loadLive();
    }

    if(j.status==="completed"){
      setBadge("Ä°ÅŸ tamamlandÄ±");
      clearInterval(pollTimer);
    }
  }catch(e){}
}

/* LOAD LIVE LOCATION */
async function loadLive(){
  try{
    const r = await fetch(`${BACKEND}?action=getLive&job_id=${jobId}`);
    const d = await r.json();
    if(!d || !d.lat) return;

    const latlng=[Number(d.lat),Number(d.lng)];

    if(!driverMarker){
      driverMarker = L.marker(latlng).addTo(map);
      map.setView(latlng,15);
    }else{
      driverMarker.setLatLng(latlng);
    }
  }catch(e){}
}

/* UI */
function setBadge(t){
  document.getElementById("statusBadge").innerText=t;
}

/* START */
pollTimer = setInterval(pollJob,3000);
</script>

</body>
</html>
