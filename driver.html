<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>SepetTaxi – Sürücü</title>
  <meta name="theme-color" content="#0b0b0c" />
  <script src="config.js"></script>
  <style>
    *{box-sizing:border-box}
    :root{
      --y:#f5c400; --bg:#060607; --panel:#0e0f12; --card:#14161a; --line:rgba(255,255,255,.10);
      --mut:rgba(255,255,255,.66); --mut2:rgba(255,255,255,.42); --good:#34c759; --bad:#ff3b30;
      --shadow:0 12px 40px rgba(0,0,0,.55);
    }
    html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;overflow:hidden}
    .top{
      height:56px;display:flex;align-items:center;gap:10px;padding:0 12px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(10,10,12,.92), rgba(10,10,12,.55));
      backdrop-filter: blur(10px);
    }
    .iconbtn{
      width:40px;height:40px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.04);
      display:grid;place-items:center;color:#fff;cursor:pointer;
    }
    .wrap{height:calc(100% - 56px);overflow:auto;padding:12px}
    .card{
      background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:20px;
      padding:12px;box-shadow:var(--shadow);margin-bottom:12px;
    }
    h2{margin:4px 0 10px;font-size:16px}
    .field{display:flex;align-items:center;gap:10px;padding:12px;border-radius:16px;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);margin-bottom:10px}
    .field input{width:100%;background:transparent;border:0;outline:0;color:#fff;font-size:14px}
    .row{display:flex;gap:10px}
    .btn{
      flex:1;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:#fff;font-weight:900;cursor:pointer;
    }
    .btn.primary{border-color:rgba(245,196,0,.25);background:rgba(245,196,0,.14)}
    .hint{font-size:12px;color:var(--mut2);line-height:1.35}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);font-size:12px;color:var(--mut)}
    .dot{width:8px;height:8px;border-radius:99px;background:rgba(255,255,255,.18)}
    .dot.on{background:var(--good);box-shadow:0 0 0 8px rgba(52,199,89,.12)}
    .job{padding:12px;border-radius:18px;border:1px solid var(--line);background:rgba(255,255,255,.03);margin-top:10px}
    .job b{display:block}
    .job small{display:block;margin-top:4px;color:var(--mut2);line-height:1.3}
    .job .row{margin-top:10px}
  </style>
</head>
<body>
  <div class="top">
    <div class="iconbtn" id="back">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </div>
    <div style="min-width:0">
      <b>Sürücü Paneli</b>
      <div style="font-size:11px;color:rgba(255,255,255,.55)" id="status">Bağlantı…</div>
    </div>
    <div style="margin-left:auto" class="chip">
      <span class="dot" id="liveDot"></span>
      <span id="liveTxt">Offline</span>
    </div>
  </div>

  <div class="wrap">
    <div class="card" id="authCard">
      <h2>Kayıt / Giriş</h2>
      <div class="hint">MVP: telefon + plaka ile sürücü hesabı. Onay otomatik (aktif). İstersen backend’de manuel onay açılır.</div>
      <div class="field"><input id="dName" placeholder="Ad Soyad"></div>
      <div class="field"><input id="dPhone" placeholder="Telefon" inputmode="tel"></div>
      <div class="field"><input id="dPlate" placeholder="Plaka (ör. 16 ABC 123)"></div>
      <div class="row">
        <button class="btn" id="btnRegister">Kayıt Ol</button>
        <button class="btn primary" id="btnLogin">Giriş Yap</button>
      </div>
      <div class="hint" style="margin-top:10px">Giriş sonrası otomatik olarak konum paylaşımı başlar ve yakın iş listesi görünür.</div>
    </div>

    <div class="card" id="panelCard" style="display:none">
      <h2>İş Havuzu</h2>
      <div class="hint">Yakındaki (radius) işler otomatik listelenir. “Kabul Et” ile job atanır ve müşteri track’e geçer.</div>
      <div id="jobs"></div>
    </div>
  </div>

<script>
const CFG = window.SEPETTAXI || {};
const API = (CFG.API_BASE || "https://script.google.com/macros/s/AKfycbyUDK7nZCPLw6R6ml1mGeUyuNCZCuZ2hPWtjmrsBwXm7JFyHKwr_MKZqDjsoT9jVoJGsg/exec").trim();
const $ = (id)=>document.getElementById(id);

function apiGet(action, params={}){
  return new Promise((resolve, reject)=>{
    if(!API || API.includes("PASTE_YOUR")) return reject(new Error("API_BASE yok / yanlış"));
    const cb = "cb_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    window[cb] = (payload)=>{
      try{ delete window[cb]; }catch(_){ window[cb]=undefined; }
      script.remove();
      if(payload && payload.ok) resolve(payload); else reject(new Error((payload && payload.error) || "API error"));
    };
    const p = new URLSearchParams({action, callback: cb, ...params}).toString();
    const script = document.createElement("script");
    script.src = API + "?" + p;
    script.onerror = ()=>{ try{ delete window[cb]; }catch(_){ } reject(new Error("Network/JSONP error")); };
    document.body.appendChild(script);
  });
}

function saveDriver(d){ localStorage.setItem("sepettaxi_driver", JSON.stringify(d)); }
function loadDriver(){ try{ const s=localStorage.getItem("sepettaxi_driver"); return s?JSON.parse(s):null;}catch(_){return null;} }

$("back").onclick = ()=>location.href="index.html";

let driver = loadDriver();
let hbTimer=null, poolTimer=null;

function setLive(on){
  $("liveDot").classList.toggle("on", on);
  $("liveTxt").textContent = on ? "Online" : "Offline";
}
function setStatus(t){ $("status").textContent = t; }

async function startLiveLoop(){
  if(!driver) return;

  $("authCard").style.display="none";
  $("panelCard").style.display="block";
  setStatus("Konum izni bekleniyor…");

  async function heartbeat(){
    if(!navigator.geolocation){ setStatus("Konum yok"); return; }
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      try{
        const lat=pos.coords.latitude, lng=pos.coords.longitude;
        await apiGet("driverHeartbeat", {
          driver_id: driver.driver_id,
          lat, lng
        });
        setLive(true);
        setStatus("Online – konum paylaşılıyor");
      }catch(e){
        setLive(false);
        setStatus("Bağlantı hatası");
      }
    }, ()=>{
      setLive(false);
      setStatus("Konum izni gerekli");
    }, {enableHighAccuracy:true, timeout:9000, maximumAge:2000});
  }

  async function refreshPool(){
    try{
      const r = await apiGet("driverGetJobs", {driver_id: driver.driver_id});
      renderJobs(r.jobs || []);
    }catch(e){
      // sessiz
    }
  }

  await heartbeat();
  await refreshPool();

  const hbSec = (CFG.DRIVER && CFG.DRIVER.heartbeat_sec) ? CFG.DRIVER.heartbeat_sec : 8;
  hbTimer = setInterval(heartbeat, hbSec*1000);
  poolTimer = setInterval(refreshPool, 2500);
}

function renderJobs(list){
  const root = $("jobs");
  if(!list.length){
    root.innerHTML = `<div class="job"><b>Yakın iş yok</b><small>Bir iş oluştuğunda burada görünecek.</small></div>`;
    return;
  }
  root.innerHTML = "";
  list.forEach(j=>{
    const el = document.createElement("div");
    el.className="job";
    el.innerHTML = `
      <b>${(j.service_type==="courier") ? "Kurye" : "TAG/Taksi"} • ₺${j.price || "-"}</b>
      <small><b>Nereden:</b> ${escapeHtml(j.from_address||"-")}</small>
      <small><b>Nereye:</b> ${escapeHtml(j.to_address||"-")}</small>
      <small><b>Mesafe:</b> ${(j.distance_km? Number(j.distance_km).toFixed(1):"-")} km</small>
      <div class="row">
        <button class="btn primary" data-accept="${j.job_id}">Kabul Et</button>
      </div>
    `;
    root.appendChild(el);
  });

  root.querySelectorAll("[data-accept]").forEach(btn=>{
    btn.onclick = async ()=>{
      const job_id = btn.getAttribute("data-accept");
      btn.disabled = true;
      btn.textContent = "İşleniyor…";
      try{
        const r = await apiGet("driverAcceptJob", {driver_id: driver.driver_id, job_id});
        btn.textContent = "Atandı";
        alert("İş atandı. Müşteri canlı takibe geçecek.");
      }catch(e){
        btn.disabled = false;
        btn.textContent = "Kabul Et";
        alert("Kabul hatası: " + e.message);
      }
    };
  });
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

/* ========= AUTH ========= */
$("btnRegister").onclick = async ()=>{
  const name = $("dName").value.trim();
  const phone = $("dPhone").value.trim();
  const plate = $("dPlate").value.trim();
  if(!name || phone.length<10 || plate.length<3){
    alert("Ad/Telefon/Plaka gir.");
    return;
  }
  try{
    setStatus("Kayıt…");
    const r = await apiGet("driverRegister", {name, phone, plate});
    driver = {driver_id:r.driver_id, name, phone, plate};
    saveDriver(driver);
    await startLiveLoop();
  }catch(e){
    alert("Kayıt hatası: " + e.message);
    setStatus("Hata");
  }
};
$("btnLogin").onclick = async ()=>{
  const phone = $("dPhone").value.trim();
  const plate = $("dPlate").value.trim();
  if(phone.length<10 || plate.length<3){
    alert("Telefon + Plaka gir.");
    return;
  }
  try{
    setStatus("Giriş…");
    const r = await apiGet("driverLogin", {phone, plate});
    driver = {driver_id:r.driver_id, name:r.name||"", phone, plate};
    saveDriver(driver);
    await startLiveLoop();
  }catch(e){
    alert("Giriş hatası: " + e.message);
    setStatus("Hata");
  }
};

(async function boot(){
  if(driver){
    setStatus("Oturum bulundu");
    await startLiveLoop();
  }else{
    setStatus("Hazır");
  }
})();
</script>
</body>
</html>
