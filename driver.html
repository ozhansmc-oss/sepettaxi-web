<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi – Sürücü</title>
<meta name="theme-color" content="#050506" />
<style>
  *{box-sizing:border-box}
  :root{--y:#f5c400;--bg:#050506;--panel:#0f0f10;--line:rgba(255,255,255,.10);--mut:rgba(255,255,255,.66)}
  html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
  header{
    height:56px;display:flex;align-items:center;justify-content:center;
    border-bottom:1px solid var(--line);background:rgba(5,5,6,.92);
    position:fixed;top:0;left:0;right:0;z-index:5000;backdrop-filter: blur(10px);
    font-weight:900;
  }
  header b{color:var(--y)}
  .wrap{position:fixed;inset:56px 0 0 0;padding:12px;display:flex;flex-direction:column;gap:10px}
  .card{border:1px solid var(--line);background:rgba(255,255,255,.04);border-radius:18px;padding:12px}
  .label{font-size:11px;color:rgba(255,255,255,.42);margin-bottom:6px}
  .input{width:100%;height:44px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:#fff;padding:0 12px;outline:none}
  .row{display:flex;gap:10px}
  .btn{height:46px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:#fff;font-weight:900;cursor:pointer;flex:1}
  .btn.primary{background:linear-gradient(180deg, rgba(245,196,0,.98), rgba(245,196,0,.78));color:#090909;border-color:rgba(0,0,0,.25)}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .list{overflow:auto;flex:1;padding-bottom:10px}
  .job{padding:10px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.04);margin-bottom:10px}
  .job b{display:block}
  .job small{color:var(--mut)}
</style>
</head>
<body>
<header>Sürücü <b>Paneli</b></header>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div style="flex:1">
        <div class="label">Ad Soyad</div>
        <input class="input" id="name" placeholder="Örn: Ali Kaya" />
      </div>
      <div style="flex:1">
        <div class="label">Telefon</div>
        <input class="input" id="phone" placeholder="05xx..." inputmode="tel" />
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <button class="btn" id="btnLogout">Çıkış</button>
      <button class="btn primary" id="btnLogin">Giriş / Kaydol</button>
    </div>
    <div style="margin-top:8px;color:var(--mut);font-size:12px" id="st">Durum: —</div>
  </div>

  <div class="card">
    <div class="row">
      <button class="btn" id="btnTaxi">Taksi İşleri</button>
      <button class="btn" id="btnCourier">Kurye İşleri</button>
      <button class="btn primary" id="btnRefresh">Yenile</button>
    </div>
  </div>

  <div class="list" id="list"></div>
</div>

<script>
const API_URL = "PASTE_YOUR_APPS_SCRIPT_WEBAPP_URL_HERE";

let driver = loadDriver();
let filterService = ""; // taxi/courier

function $(id){ return document.getElementById(id); }

function saveDriver(d){ localStorage.setItem("sepettaxi_driver", JSON.stringify(d)); }
function loadDriver(){ try{ const s=localStorage.getItem("sepettaxi_driver"); return s?JSON.parse(s):null; }catch(_){ return null; } }

async function api(action, payload){
  const r = await fetch(API_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ action, ...payload }) });
  return await r.json();
}

function render(){
  $("name").value = driver?.name || "";
  $("phone").value = driver?.phone || "";
  $("st").textContent = driver ? ("Durum: Aktif (ID: "+driver.driver_id+")") : "Durum: Giriş yap";
}

async function login(){
  const name = $("name").value.trim();
  const phone = $("phone").value.trim();
  if(!name || !phone){ alert("Ad Soyad ve telefon zorunlu"); return; }

  const res = await api("registerDriver",{ name, phone, role:"driver" });
  if(!res || !res.ok){ alert("Giriş hatası: "+(res.error||res.message||"")); return; }

  driver = { driver_id: res.driver_id, name, phone };
  saveDriver(driver);
  render();
  refresh();
  startLiveWatcher(); // start sending live only when job accepted/active; watcher is safe anyway
}

function logout(){
  driver = null;
  localStorage.removeItem("sepettaxi_driver");
  render();
  $("list").innerHTML = "";
}

function jobCard(j){
  const div = document.createElement("div");
  div.className = "job";
  div.innerHTML = `
    <b>${j.service_type==="courier" ? "Kurye" : "Taksi"} – ${Number(j.price).toFixed(0)} ₺</b>
    <small>${j.from_address}</small>
    <small style="display:block;margin-top:4px">${j.to_address}</small>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn primary">İşi Al</button>
      <button class="btn">Takip</button>
    </div>
  `;
  const btnTake = div.querySelectorAll("button")[0];
  const btnTrack = div.querySelectorAll("button")[1];

  btnTake.onclick = async ()=>{
    if(!driver){ alert("Önce giriş yap"); return; }
    const res = await api("assignJob",{ job_id: j.job_id, driver_id: driver.driver_id });
    if(!res || !res.ok){ alert("Atama başarısız: "+(res.error||res.message||"")); return; }

    // driver accepts immediately (simple flow)
    await api("driverSetStatus",{ job_id: j.job_id, driver_id: driver.driver_id, status:"accepted" });

    alert("İş alındı. Takip ekranına yönlenebilirsin.");
    window.location.href = "track.html?job_id=" + encodeURIComponent(j.job_id);
  };

  btnTrack.onclick = ()=> window.location.href = "track.html?job_id=" + encodeURIComponent(j.job_id);

  return div;
}

async function refresh(){
  $("list").innerHTML = "Yükleniyor…";
  const res = await api("listOpenJobs", { service_type: filterService });
  if(!res || !res.ok){
    $("list").innerHTML = "Liste alınamadı: " + (res.error||res.message||"");
    return;
  }
  const jobs = res.jobs || [];
  $("list").innerHTML = "";
  if(!jobs.length){
    $("list").innerHTML = "<div style='color:rgba(255,255,255,.65)'>Açık iş yok.</div>";
    return;
  }
  jobs.forEach(j=> $("list").appendChild(jobCard(j)));
}

/* Live tracking: send last position if driver has accepted job (we keep simple and send always when available) */
let watchId = null;
function startLiveWatcher(){
  if(watchId !== null) return;
  if(!navigator.geolocation) return;

  watchId = navigator.geolocation.watchPosition(async (pos)=>{
    if(!driver) return;
    // Driver live is tied to a job_id normally; here we don't know current job.
    // In your next step we can store current_job_id on accept and send exact.
    // For now: no-op unless you implement driver current job in UI.
  }, ()=>{}, { enableHighAccuracy:true, maximumAge:2000, timeout:8000 });
}

$("btnLogin").onclick = login;
$("btnLogout").onclick = logout;
$("btnRefresh").onclick = refresh;
$("btnTaxi").onclick = ()=>{ filterService="taxi"; refresh(); };
$("btnCourier").onclick = ()=>{ filterService="courier"; refresh(); };

render();
refresh();
</script>
</body>
</html>
