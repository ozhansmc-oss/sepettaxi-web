<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Sürücü</title>
<meta name="theme-color" content="#f5c400">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
:root{--y:#f5c400}

.wrap{padding:16px}
.card{
background:#141416;
border:1px solid rgba(255,255,255,.12);
border-radius:18px;
padding:14px;
margin-bottom:12px
}
h1{font-size:18px;margin:0 0 10px}
h2{font-size:15px;margin:0 0 8px}
.inp{
width:100%;padding:12px;border-radius:14px;
border:1px solid rgba(255,255,255,.12);
background:rgba(255,255,255,.04);
color:#fff;margin-bottom:10px
}
.btn{
width:100%;padding:12px;border-radius:14px;
border:0;font-weight:900;
background:linear-gradient(135deg,#f5c400,#ffd34d);
color:#1a1400
}
.btn.sec{
background:#222;color:#fff;margin-top:6px
}
.job{
border:1px solid rgba(255,255,255,.10);
border-radius:14px;
padding:12px;margin-bottom:10px
}
.job b{display:block;margin-bottom:4px}
.small{font-size:12px;color:rgba(255,255,255,.6)}
.active{border-color:var(--y)}
</style>
</head>

<body>

<div class="wrap">

  <!-- LOGIN -->
  <div class="card" id="loginCard">
    <h1>Sürücü Girişi</h1>
    <input class="inp" id="driverId" placeholder="Sürücü ID / Telefon">
    <button class="btn" id="loginBtn">Giriş Yap</button>
  </div>

  <!-- ACTIVE JOB -->
  <div class="card" id="activeCard" style="display:none">
    <h2>Aktif İş</h2>
    <div id="activeJob">—</div>
    <button class="btn sec" id="finishBtn">İşi Bitir</button>
  </div>

  <!-- JOB LIST -->
  <div class="card" id="jobsCard" style="display:none">
    <h2>Uygun İşler</h2>
    <div id="jobs"></div>
  </div>

</div>

<script>
/* ========= CONFIG ========= */
const API = "https://script.google.com/macros/s/AKfycbxxvr6OPG5R-emW8WlquzZ1psFEn6Lbvt4dDHpdN8XWO494N7uCv3s4DhLreIhO59b-/exec";

/* ========= STATE ========= */
let driverId = null;
let heartbeatTimer = null;
let activeJobId = null;

/* ========= HELPERS ========= */
const $ = i => document.getElementById(i);

function postForm(d){
  const b = Object.keys(d).map(k=>k+"="+encodeURIComponent(d[k])).join("&");
  return fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:b
  }).then(r=>r.json());
}

/* ========= LOGIN ========= */
$("loginBtn").onclick = async ()=>{
  const id = $("driverId").value.trim();
  if(!id) return alert("Sürücü ID gir");
  driverId = id;
  localStorage.setItem("sepettaxi_driver", driverId);
  $("loginCard").style.display="none";
  $("jobsCard").style.display="block";
  startHeartbeat();
  loadJobs();
};

(function boot(){
  const saved = localStorage.getItem("sepettaxi_driver");
  if(saved){
    driverId = saved;
    $("loginCard").style.display="none";
    $("jobsCard").style.display="block";
    startHeartbeat();
    loadJobs();
  }
})();

/* ========= HEARTBEAT ========= */
function startHeartbeat(){
  sendHeartbeat();
  heartbeatTimer = setInterval(sendHeartbeat, 5000);
}

async function sendHeartbeat(){
  if(!driverId) return;
  if(!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(async pos=>{
    const r = await postForm({
      action:"driverHeartbeat",
      driver_id:driverId,
      lat:pos.coords.latitude,
      lng:pos.coords.longitude,
      can_taxi:"true",
      can_courier:"true"
    });
    if(r.active_job_id){
      activeJobId = r.active_job_id;
      showActiveJob();
    }
  });
}

/* ========= JOB LIST ========= */
async function loadJobs(){
  if(!driverId) return;
  const r = await postForm({
    action:"listAvailableJobs",
    driver_id:driverId
  });
  renderJobs(r.jobs || []);
  setTimeout(loadJobs, 6000);
}

function renderJobs(list){
  const box = $("jobs");
  box.innerHTML = "";
  if(!list.length){
    box.innerHTML = `<div class="small">Uygun iş yok</div>`;
    return;
  }
  list.forEach(j=>{
    const d = document.createElement("div");
    d.className = "job";
    d.innerHTML = `
      <b>${j.service_type==="courier"?"Kurye":"Taksi"}</b>
      <div class="small">${j.from_address||"Konum"} → ${j.to_address||""}</div>
      <div class="small">Ücret: ${j.price||"—"} ₺</div>
      <button class="btn sec">Kabul Et</button>
    `;
    d.querySelector("button").onclick = ()=> acceptJob(j.job_id);
    box.appendChild(d);
  });
}

/* ========= ACCEPT ========= */
async function acceptJob(jobId){
  const r = await postForm({
    action:"acceptJob",
    driver_id:driverId,
    job_id:jobId
  });
  if(r.ok){
    activeJobId = jobId;
    showActiveJob();
  }else{
    alert("İş alınamadı");
  }
}

/* ========= ACTIVE JOB ========= */
function showActiveJob(){
  $("jobsCard").style.display="none";
  $("activeCard").style.display="block";
  $("activeJob").textContent = "Aktif iş ID: " + activeJobId;
}

$("finishBtn").onclick = async ()=>{
  if(!activeJobId) return;
  await postForm({
    action:"driverUpdateStatus",
    driver_id:driverId,
    job_id:activeJobId,
    status:"completed"
  });
  activeJobId = null;
  $("activeCard").style.display="none";
  $("jobsCard").style.display="block";
};
</script>

</body>
</html>
