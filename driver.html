<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi ‚Äì S√ºr√ºc√º</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,Arial;
  background:#050506;
  color:#fff;
}
header{
  height:60px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:900;
  font-size:22px;
  border-bottom:1px solid rgba(255,255,255,.1);
}
header span{color:#f5c400}

#login,#panel{
  max-width:720px;
  margin:20px auto;
  padding:16px;
}

input,button{
  width:100%;
  height:48px;
  margin-top:10px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.15);
  background:#000;
  color:#fff;
  font-size:16px;
}
button{
  background:linear-gradient(#ffd84a,#f5c400);
  color:#000;
  font-weight:900;
  cursor:pointer;
}

.switch{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
}

.jobs{
  margin-top:16px;
}

.card{
  border:1px solid rgba(255,255,255,.12);
  border-radius:14px;
  padding:12px;
  margin-bottom:12px;
}

.small{font-size:13px;opacity:.7}
.btn{
  margin-top:10px;
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> S√ºr√ºc√º</header>

<div id="login">
  <h3>S√ºr√ºc√º Giri≈ü</h3>
  <input id="phone" placeholder="Telefon">
  <button onclick="login()">Giri≈ü</button>
</div>

<div id="panel" style="display:none">
  <div class="switch">
    <strong>Durum:</strong>
    <span id="statusText">Offline</span>
    <button onclick="toggleOnline()" id="onlineBtn">Online Ol</button>
  </div>

  <div class="jobs">
    <h3>Yakƒ±n ƒ∞≈üler (5 km)</h3>
    <div id="jobList"></div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbz5Qk4OSBwQ1NCf09EGfczk7I8d3pRUSihE6xpb69mFRSf-MfNactwUxEQrNBYh6GcM/exec";

let driver = null;
let online = false;
let locTimer = null;
let poolTimer = null;

/* LOGIN */
async function login(){
  const phone = document.getElementById("phone").value.trim();
  if(!phone){ alert("Telefon girin"); return; }

  const res = await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"driverLogin", phone})
  });
  const data = await res.json();

  if(!data.ok){
    alert("Giri≈ü reddedildi (Onay bekleniyor olabilir)");
    return;
  }

  driver = data;
  document.getElementById("login").style.display="none";
  document.getElementById("panel").style.display="block";
}

/* ONLINE / OFFLINE */
async function toggleOnline(){
  online = !online;

  const res = await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"driverSetOnline",
      driver_id:driver.driver_id,
      online:online
    })
  });
  const data = await res.json();
  if(!data.ok){
    alert("Durum deƒüi≈ümedi");
    return;
  }

  document.getElementById("statusText").textContent = online ? "Online" : "Offline";
  document.getElementById("onlineBtn").textContent = online ? "Offline Ol" : "Online Ol";

  if(online){
    startLocation();
    startPool();
  }else{
    stopTimers();
  }
}

/* LOCATION */
function startLocation(){
  locTimer = setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      fetch(API,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          action:"updateDriverLocation",
          driver_id:driver.driver_id,
          lat:pos.coords.latitude,
          lng:pos.coords.longitude
        })
      });
    });
  },5000);
}

/* JOB POOL */
function startPool(){
  poolTimer = setInterval(loadJobs,4000);
  loadJobs();
}

async function loadJobs(){
  navigator.geolocation.getCurrentPosition(async pos=>{
    const res = await fetch(`${API}?action=getJobPool&driver_id=${driver.driver_id}&lat=${pos.coords.latitude}&lng=${pos.coords.longitude}`);
    const data = await res.json();

    if(!data.ok) return;

    const list = document.getElementById("jobList");
    list.innerHTML = "";

    if(data.jobs.length === 0){
      list.innerHTML = "<p class='small'>Yakƒ±n i≈ü yok.</p>";
      return;
    }

    data.jobs.forEach(j=>{
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML = `
        <strong>${j.service_type === "courier" ? "üèçÔ∏è Kurye" : "üöï Taksi"}</strong><br>
        <span class="small">${j.from_address}</span><br>
        <span class="small">Mesafe: ${j.distance_to_pickup_km} km</span><br>
        <strong>${j.price} TL</strong>
        <button class="btn" onclick="acceptJob('${j.job_id}')">ƒ∞≈üi Al</button>
      `;
      list.appendChild(div);
    });
  });
}

/* ACCEPT JOB */
async function acceptJob(jobId){
  if(!confirm("Bu i≈üi almak istiyor musun?")) return;

  const res = await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"driverAcceptJob",
      driver_id:driver.driver_id,
      job_id:jobId
    })
  });
  const data = await res.json();

  if(data.ok){
    alert("ƒ∞≈ü alƒ±ndƒ±! M√º≈üteri y√∂nlendirildi.");
    loadJobs();
  }else{
    alert("Hata: " + data.error);
  }
}

function stopTimers(){
  clearInterval(locTimer);
  clearInterval(poolTimer);
}
</script>

</body>
</html>
