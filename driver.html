<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Driver Panel</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222
}
header span{color:#f5c400}
.wrap{padding:14px;max-width:760px;margin:auto}
.card{background:#111;border-radius:16px;padding:14px;margin-bottom:12px}
input{
  width:100%;padding:12px;border-radius:12px;
  border:0;background:#222;color:#fff
}
button{
  width:100%;padding:14px;border-radius:22px;border:0;
  font-weight:900;background:#f5c400;color:#000;cursor:pointer
}
button.secondary{background:#222;color:#ddd;margin-top:6px}
.small{font-size:12px;color:#aaa}
.big{font-size:26px;font-weight:900}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{
  display:inline-block;padding:4px 10px;border-radius:999px;
  background:#222;color:#aaa;font-size:12px
}
.auth-only{display:none}
hr{border:0;border-top:1px solid #222;margin:10px 0}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> – Driver</header>

<div class="wrap">

<!-- LOGIN -->
<div class="card" id="loginCard">
  <b>Sürücü Girişi</b>
  <div style="height:8px"></div>
  <input id="did" placeholder="Driver ID (örn: DRV-001)">
  <div style="height:10px"></div>
  <button onclick="login()">Panele Gir</button>
</div>

<!-- SUMMARY -->
<div class="card auth-only">
  <b>Sürücü Özeti</b>
  <div class="grid" style="margin-top:10px">
    <div>
      <div class="small">Bugünkü Kazanç</div>
      <div class="big" id="todayEarn">—</div>
    </div>
    <div>
      <div class="small">Toplam Kazanç</div>
      <div class="big" id="totalEarn">—</div>
    </div>
    <div>
      <div class="small">Toplam Komisyon</div>
      <div class="big" id="totalComm">—</div>
    </div>
    <div>
      <div class="small">Net Kazanç</div>
      <div class="big" id="netEarn">—</div>
    </div>
  </div>
</div>

<!-- ACTIVE JOB -->
<div class="card auth-only">
  <b>Aktif İş</b>
  <div id="activeJob" class="small">Aktif iş yok.</div>
</div>

<!-- HISTORY -->
<div class="card auth-only">
  <b>Geçmiş İşler</b>
  <div id="history"></div>
</div>

</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const COMMISSION = 0.15;

let DRIVER_ID = null;
let LIVE_TIMER = null;

const $ = id => document.getElementById(id);

/* LOGIN */
async function login(){
  const did = $("did").value.trim();
  if(!did){ alert("Driver ID gir"); return; }

  DRIVER_ID = did;
  document.querySelectorAll(".auth-only").forEach(e=>e.style.display="block");
  $("loginCard").style.display="none";

  loadData();
}

/* LOAD ALL */
async function loadData(){
  const jobs = await fetch(`${BACKEND}?action=getJobs`).then(r=>r.json());
  const mine = jobs.filter(j=>j.driver_id===DRIVER_ID);

  renderSummary(mine);
  renderActive(mine);
  renderHistory(mine);
}

/* SUMMARY */
function renderSummary(jobs){
  const today = new Date().toISOString().slice(0,10);
  let todaySum=0,total=0,comm=0;

  jobs.forEach(j=>{
    if(j.status==="completed"){
      const p = Number(j.final_price||0);
      total += p;
      comm  += p*COMMISSION;
      if(String(j.completed_at||"").startsWith(today)) todaySum+=p;
    }
  });

  $("todayEarn").innerText = todaySum.toFixed(0)+" TL";
  $("totalEarn").innerText = total.toFixed(0)+" TL";
  $("totalComm").innerText = comm.toFixed(0)+" TL";
  $("netEarn").innerText = (total-comm).toFixed(0)+" TL";
}

/* ACTIVE JOB */
function renderActive(jobs){
  const box = $("activeJob");
  const j = jobs.find(x=>x.status==="assigned"||x.status==="on_route");
  if(!j){ box.innerHTML="Aktif iş yok."; stopLivePing(); return; }

  let btn="";
  if(j.status==="assigned")
    btn=`<button onclick="setStatus('${j.job_id}','on_route')">YOLA ÇIKTIM</button>`;
  if(j.status==="on_route")
    btn=`<button onclick="setStatus('${j.job_id}','completed')">İŞİ BİTİR</button>`;

  box.innerHTML=`
    <b>${j.from_address} → ${j.to_address}</b><br>
    <span class="small">Ücret: ${j.final_price} TL</span><br>
    <span class="badge">${j.status}</span>
    <div style="height:8px"></div>
    ${btn}
  `;

  if(j.status==="on_route") startLivePing(j.job_id);
}

/* HISTORY */
function renderHistory(jobs){
  const box = $("history");
  box.innerHTML="";
  jobs.filter(j=>j.status==="completed")
    .slice(-10).reverse()
    .forEach(j=>{
      const c = j.final_price*COMMISSION;
      box.innerHTML+=`
        <div class="small">
          ${j.from_address} → ${j.to_address}<br>
          Ücret: ${j.final_price} TL · Komisyon: ${c.toFixed(0)} TL
        </div><hr>`;
    });
}

/* STATUS UPDATE */
async function setStatus(jobId,status){
  await fetch(`${BACKEND}?action=updateStatus&job_id=${jobId}&status=${status}&driver_id=${DRIVER_ID}`);

  if(status==="on_route") startLivePing(jobId);
  if(status==="completed") stopLivePing();

  loadData();
}

/* LIVE LOCATION PING */
function startLivePing(jobId){
  if(!navigator.geolocation) return;

  if(LIVE_TIMER) return;

  LIVE_TIMER = setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      fetch(`${BACKEND}?action=ping&job_id=${jobId}&driver_id=${DRIVER_ID}&lat=${pos.coords.latitude}&lng=${pos.coords.longitude}`);
    });
  },5000);
}

function stopLivePing(){
  if(LIVE_TIMER){
    clearInterval(LIVE_TIMER);
    LIVE_TIMER=null;
  }
}
</script>

</body>
</html>
