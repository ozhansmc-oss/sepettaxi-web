<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Sürücü</title>
<meta name="theme-color" content="#f5c400">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
:root{--y:#f5c400}

.wrap{padding:16px;max-width:560px;margin:0 auto}
h1{font-size:18px;margin:6px 0 12px}
h2{font-size:15px;margin:0 0 8px}

.card{
background:#141416;
border:1px solid rgba(255,255,255,.12);
border-radius:20px;
padding:16px;
margin-bottom:12px
}

.job{
border:1px solid rgba(255,255,255,.12);
border-radius:16px;
padding:12px;
margin-bottom:10px
}
.job b{display:block;margin-bottom:4px}
.small{font-size:12px;color:rgba(255,255,255,.6)}

.btn{
width:100%;padding:12px;border-radius:14px;
border:0;font-weight:900;
background:linear-gradient(135deg,#f5c400,#ffd34d);
color:#1a1400;margin-top:8px
}
.btn.sec{
background:#222;color:#fff;border:1px solid rgba(255,255,255,.15)
}
.badge{
display:inline-block;padding:6px 10px;border-radius:999px;
font-size:11px;font-weight:900;
background:rgba(245,196,0,.15);border:1px solid rgba(245,196,0,.35)
}
</style>
</head>

<body>

<div class="wrap">
  <h1>Sürücü Paneli</h1>

  <!-- ACTIVE JOB -->
  <div class="card" id="activeCard" style="display:none">
    <h2>Aktif İş</h2>
    <div id="activeJob">—</div>
    <button class="btn sec" id="finishBtn">İşi Bitir</button>
  </div>

  <!-- JOB LIST -->
  <div class="card" id="jobsCard">
    <h2>Uygun İşler</h2>
    <div id="jobs"></div>
  </div>
</div>

<script>
/* ================= KİLİTLİ KURAL ================= */
const DRIVER_ID = localStorage.getItem("sepettaxi_driver");
if(!DRIVER_ID){
  window.location.replace("driver-register.html");
}

/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbzXbm934CXIjTSL9RxmL8kkCjGERoeiQPDfY-OUk2Lexqqr_UvppoJ2yT0t562aJZdxRg/exec";

/* ================= STATE ================= */
let driverId = DRIVER_ID;
let activeJobId = null;
let heartbeatTimer = null;

/* ================= HELPERS ================= */
const $ = i => document.getElementById(i);

function postForm(d){
  return fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:Object.keys(d).map(k=>k+"="+encodeURIComponent(d[k])).join("&")
  }).then(r=>r.json());
}

/* ================= HEARTBEAT (TEK VE DOĞRU) ================= */
function startDriverHeartbeat(){
  if(heartbeatTimer) return;

  heartbeatTimer = setInterval(()=>{
    if(!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(pos=>{
      postForm({
        action:"driverHeartbeat",
        driver_id:driverId,
        lat:pos.coords.latitude,
        lng:pos.coords.longitude
      }).catch(()=>{});
    });

  }, 3000);
}

window.addEventListener("beforeunload", ()=>{
  if(heartbeatTimer) clearInterval(heartbeatTimer);
});

/* ================= JOB LIST ================= */
async function loadJobs(){
  if(!driverId) return;

  const r = await postForm({
    action:"listAvailableJobs",
    driver_id:driverId
  });

  renderJobs(r.jobs || []);
  setTimeout(loadJobs, 7000);
}

function renderJobs(list){
  const box = $("jobs");
  box.innerHTML = "";

  if(!list.length){
    box.innerHTML = `<div class="small">Uygun iş yok</div>`;
    return;
  }

  list.forEach(j=>{
    const d = document.createElement("div");
    d.className = "job";
    d.innerHTML = `
      <b>${j.service_type==="courier"?"Kurye":"Taksi"} · ${j.price||"—"} ₺</b>
      <div class="small">${j.from_address||""} → ${j.to_address||""}</div>
      <button class="btn sec">Kabul Et</button>
    `;
    d.querySelector("button").onclick = ()=> acceptJob(j.job_id);
    box.appendChild(d);
  });
}

/* ================= ACCEPT ================= */
async function acceptJob(jobId){
  const r = await postForm({
    action:"acceptJob",
    driver_id:driverId,
    job_id:jobId
  });

  if(r && r.ok){
    activeJobId = jobId;
    showActiveJob();
  }else{
    alert("İş alınamadı");
  }
}

/* ================= ACTIVE JOB ================= */
function showActiveJob(){
  $("jobsCard").style.display="none";
  $("activeCard").style.display="block";
  $("activeJob").innerHTML = `
    <div class="badge">Aktif</div>
    <div class="small" style="margin-top:6px">İş ID: ${activeJobId}</div>
  `;
}

$("finishBtn").onclick = async ()=>{
  if(!activeJobId) return;

  await postForm({
    action:"driverUpdateStatus",
    driver_id:driverId,
    job_id:activeJobId,
    status:"completed"
  });

  activeJobId = null;
  $("activeCard").style.display="none";
  $("jobsCard").style.display="block";
};

/* ================= INIT ================= */
startDriverHeartbeat();
loadJobs();
<script>
/* ======================================================
   SepetTaxi – DRIVER HEARTBEAT (ADIM D)
   API URL dosyadan okunur – çakışma yok
   ====================================================== */

(function(){
  // ⚠️ API driver.html içinde zaten tanımlı olmalı
  if(typeof API === "undefined"){
    console.warn("SepetTaxi: API tanımlı değil, heartbeat iptal");
    return;
  }

  // ⚠️ driverId de driver.html içinde olmalı
  if(typeof driverId === "undefined"){
    console.warn("SepetTaxi: driverId yok, heartbeat iptal");
    return;
  }

  const HEARTBEAT_INTERVAL = 6000; // 6 sn
  let hbTimer = null;

  function post(action, data){
    const body = new URLSearchParams(Object.assign({ action }, data));
    return fetch(API, { method:"POST", body })
      .then(r=>r.json())
      .catch(()=>null);
  }

  function startHeartbeat(){
    if(hbTimer) return;

    hbTimer = setInterval(()=>{
      if(!navigator.geolocation) return;

      navigator.geolocation.getCurrentPosition(pos=>{
        post("driverHeartbeat",{
          driver_id: driverId,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        });
      });
    }, HEARTBEAT_INTERVAL);

    console.log("SepetTaxi: heartbeat başladı");
  }

  function stopHeartbeat(){
    if(hbTimer){
      clearInterval(hbTimer);
      hbTimer = null;
      console.log("SepetTaxi: heartbeat durdu");
    }
  }

  /* === ÇALIŞMA STRATEJİSİ ===
     driver panel açıkken heartbeat çalışır
     iş biterse durdurmak istersek event bağlarız
  */

  startHeartbeat();

  // İleride istersek:
  // document.addEventListener("jobCompleted", stopHeartbeat);

})();
</script>

</body>
</html>
