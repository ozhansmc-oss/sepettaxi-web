<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Driver</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#000;
  color:#fff
}
header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-bottom:1px solid #222;
  font-size:18px;
  font-weight:900
}
header span{color:#f5c400}

.wrap{
  max-width:720px;
  margin:0 auto;
  padding:14px
}
.card{
  background:#121212;
  border:1px solid #222;
  border-radius:14px;
  padding:14px;
  margin-bottom:12px
}
input,button{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:0;
  font-size:15px
}
input{
  background:#1b1b1b;
  color:#fff;
  margin-bottom:10px
}
button{
  background:#f5c400;
  color:#000;
  font-weight:900;
  cursor:pointer
}
button.secondary{
  background:#333;
  color:#fff;
  margin-top:8px
}
.err{
  background:#3a0000;
  border:1px solid #ff4d4d;
  color:#ffb3b3;
  padding:10px;
  border-radius:10px;
  margin-bottom:12px;
  display:none
}
.muted{color:#aaa;font-size:13px}
.jobTitle{font-weight:900;margin-bottom:6px}
.sep{height:8px}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> â€“ Driver</header>

<div class="wrap">

  <div id="err" class="err"></div>

  <div class="card">
    <input id="driverId" placeholder="Driver ID (Ã¶rn: DRV001)">
    <button onclick="loadJobs()">Ä°ÅŸleri Getir</button>
    <div class="muted">Son gÃ¼ncelleme: <span id="last">â€”</span></div>
  </div>

  <div id="jobs"></div>

</div>

<script>
/* ================== CONFIG ================== */
const BACKEND_URL =
  "https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

/* ================== STATE ================== */
let pingTimer = null;

/* ================== UTIL ================== */
const $ = id => document.getElementById(id);

function showErr(msg){
  $("err").innerText = msg;
  $("err").style.display = "block";
}
function clearErr(){
  $("err").style.display = "none";
}

/* ================== LOAD JOBS ================== */
async function loadJobs(){
  clearErr();
  stopPing();

  const did = $("driverId").value.trim();
  if(!did) return showErr("Driver ID girilmedi");

  try{
    const r = await fetch(`${BACKEND_URL}?action=getJobs`);
    const jobs = await r.json();

    const box = $("jobs");
    box.innerHTML = "";

    /* ðŸ”‘ B MODU FÄ°LTRE:
       - pending â†’ herkes gÃ¶rÃ¼r
       - assigned / on_route â†’ sadece kendi driverâ€™Ä±
    */
    const visible = jobs.filter(j =>
      j.status === "pending" ||
      (String(j.driver_id) === did && (j.status === "assigned" || j.status === "on_route"))
    );

    if(visible.length === 0){
      box.innerHTML = `<div class="muted">Uygun iÅŸ yok.</div>`;
    }

    visible.forEach(j=>{
      const c = document.createElement("div");
      c.className = "card";

      let actionBtn = "";
      if(j.status === "pending"){
        actionBtn = `<button onclick="acceptJob('${j.job_id}')">KABUL ET</button>`;
      }else if(j.status === "assigned"){
        actionBtn = `<button onclick="startJob('${j.job_id}')">YOLA Ã‡IK</button>`;
      }else if(j.status === "on_route"){
        actionBtn = `<button class="secondary" onclick="finishJob('${j.job_id}')">TAMAMLA</button>`;
      }

      c.innerHTML = `
        <div class="jobTitle">${j.service || j.service_type}</div>
        <div class="muted">${j.pickup_address || j.from_address}</div>
        <div class="muted">â†’ ${j.dropoff_address || j.to_address}</div>
        <div class="sep"></div>
        <div>Durum: <b>${j.status}</b></div>
        <div class="sep"></div>
        ${actionBtn}
      `;

      box.appendChild(c);

      if(j.status === "on_route"){
        startPing(j.job_id);
      }
    });

    $("last").innerText = new Date().toLocaleTimeString();

  }catch(e){
    showErr("Ä°ÅŸler yÃ¼klenemedi");
  }
}

/* ================== ACTIONS ================== */
async function acceptJob(jobId){
  const did = $("driverId").value.trim();
  await fetch(`${BACKEND_URL}?action=updateStatus&job_id=${jobId}&status=assigned&driver_id=${did}`);
  loadJobs();
}

async function startJob(jobId){
  await fetch(`${BACKEND_URL}?action=updateStatus&job_id=${jobId}&status=on_route`);
  loadJobs();
}

async function finishJob(jobId){
  stopPing();
  await fetch(`${BACKEND_URL}?action=updateStatus&job_id=${jobId}&status=completed`);
  loadJobs();
}

/* ================== LIVE LOCATION PING ================== */
function startPing(jobId){
  if(pingTimer || !navigator.geolocation) return;

  pingTimer = setInterval(()=>{
    navigator.geolocation.getCurrentPosition(
      pos=>{
        fetch(
          `${BACKEND_URL}?action=ping` +
          `&job_id=${jobId}` +
          `&driver_id=${$("driverId").value}` +
          `&lat=${pos.coords.latitude}` +
          `&lng=${pos.coords.longitude}`
        );
      },
      ()=>{ showErr("Konum izni gerekli"); }
    );
  }, 7000);
}

function stopPing(){
  clearInterval(pingTimer);
  pingTimer = null;
}
</script>

</body>
</html>
