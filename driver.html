<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Driver Panel</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}
.wrap{padding:14px;max-width:760px;margin:auto}
.card{background:#111;border-radius:16px;padding:14px;margin-bottom:12px}
input{width:100%;padding:12px;border-radius:12px;border:0;background:#222;color:#fff}
button{width:100%;padding:14px;border-radius:22px;border:0;font-weight:900;background:#f5c400;color:#000;cursor:pointer}
.small{font-size:12px;color:#aaa}
.big{font-size:22px;font-weight:900}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#222;color:#aaa;font-size:12px}
.auth-only{display:none}
.navBtn{background:#0f0f0f;color:#fff;border:1px solid #333;margin-bottom:8px}
</style>
</head>

<body>
<header>Sepet<span>Taxi</span> â€“ Driver</header>

<div class="wrap">

<!-- LOGIN -->
<div class="card" id="loginCard">
  <b>SÃ¼rÃ¼cÃ¼ GiriÅŸi</b>
  <div style="height:8px"></div>
  <input id="dname" placeholder="Ad Soyad">
  <div style="height:10px"></div>
  <input id="dphone" placeholder="Telefon (0XXXXXXXXXX)" maxlength="11">
  <div style="height:10px"></div>
  <button onclick="login()">Panele Gir</button>
</div>

<!-- ACTIVE JOB -->
<div class="card auth-only">
  <b>Aktif Ä°ÅŸ</b>
  <div id="activeJob" class="small">Aktif iÅŸ yok.</div>
</div>

</div>

<script src="config.js"></script>
<script src="log.js"></script>

<script>
const DRIVER_KEY = "SEPT_driver";
let driver = JSON.parse(localStorage.getItem(DRIVER_KEY) || "null");
let liveTimer = null;

const $ = id => document.getElementById(id);

/* ================= LOGIN ================= */
async function login(){
  const name = $("dname").value.trim();
  const phone = $("dphone").value.trim();
  if(!name || !phone) return alert("Ad ve telefon gerekli");

  const res = await apiPost(SEPT.ACTIONS.REGISTER_DRIVER,{
    name, phone, vehicle_type:"taxi"
  });

  if(!res.ok) return alert(res.error || "KayÄ±t baÅŸarÄ±sÄ±z");

  driver = { driver_id: res.driver_id, name, phone };
  localStorage.setItem(DRIVER_KEY, JSON.stringify(driver));

  await apiPost(SEPT.ACTIONS.SET_DRIVER_STATUS,{
    driver_id: driver.driver_id,
    status: "available"
  });

  onAuth();
}

/* ================= AUTH ================= */
function onAuth(){
  $("loginCard").style.display="none";
  document.querySelectorAll(".auth-only").forEach(e=>e.style.display="block");
  poll();
  setInterval(poll, 5000);
}

/* ================= API ================= */
async function apiPost(action,payload){
  payload.action = action;
  const r = await fetch(SEPT.BACKEND_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  });
  const j = await r.json();
  Log.api(action,payload,j);
  return j;
}

/* ================= POLL ================= */
async function poll(){
  if(!driver) return;

  const res = await apiPost(SEPT.ACTIONS.DRIVER_GET_JOB,{
    driver_id: driver.driver_id
  });

  if(!res.ok) return;

  renderActive(res.job);
}

/* ================= ACTIVE ================= */
function renderActive(j){
  const box = $("activeJob");
  if(!j){
    box.textContent="Aktif iÅŸ yok.";
    stopLive();
    return;
  }

  let btns = "";

  if(j.status==="assigned"){
    btns = `
      <button class="navBtn" onclick="navTo(${j.pickup_lat},${j.pickup_lng})">ðŸ§­ Pickupâ€™a Git</button>
      <button onclick="startJob('${j.job_id}')">YOLA Ã‡IKTIM</button>
    `;
  }

  if(j.status==="active"){
    btns = `
      <button class="navBtn" onclick="navTo(${j.dropoff_lat},${j.dropoff_lng})">ðŸ§­ Teslimata Git</button>
      <button onclick="completeJob('${j.job_id}')">Ä°ÅžÄ° BÄ°TÄ°R</button>
    `;
    startLive(j.job_id);
  }

  box.innerHTML = `
    <b>${j.from_address} â†’ ${j.to_address}</b><br>
    <span class="badge">${j.status}</span><br><br>${btns}
  `;
}

/* ================= ACTIONS ================= */
async function startJob(jobId){
  await apiPost(SEPT.ACTIONS.START_JOB,{
    job_id:jobId,
    driver_id:driver.driver_id
  });
  poll();
}

async function completeJob(jobId){
  await apiPost(SEPT.ACTIONS.COMPLETE_JOB,{
    job_id:jobId,
    driver_id:driver.driver_id
  });
  stopLive();
  poll();
}

/* ================= LIVE ================= */
function startLive(jobId){
  if(liveTimer) return;
  liveTimer = setInterval(()=>{
    navigator.geolocation.getCurrentPosition(p=>{
      apiPost(SEPT.ACTIONS.UPDATE_LIVE,{
        job_id:jobId,
        driver_id:driver.driver_id,
        lat:p.coords.latitude,
        lng:p.coords.longitude
      });
    });
  }, SEPT.DRIVER_PING_MS || 5000);
}

function stopLive(){
  if(liveTimer){
    clearInterval(liveTimer);
    liveTimer=null;
  }
}

/* ================= NAV ================= */
function navTo(lat,lng){
  const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`;
  window.open(url,"_blank");
}

/* ================= AUTO ================= */
if(driver) onAuth();
</script>

</body>
</html>
