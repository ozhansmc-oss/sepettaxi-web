<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ SÃ¼rÃ¼cÃ¼</title>

<style>
*{box-sizing:border-box}
body{margin:0;background:#000;color:#fff;font-family:Arial}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222
}
header span{color:#f5c400}
.wrap{padding:14px;max-width:520px;margin:auto}
.card{
  background:#111;border-radius:16px;padding:14px;margin-bottom:12px;
  border:1px solid #222
}
input,button{
  width:100%;padding:14px;border-radius:14px;
  border:0;font-size:14px
}
input{background:#222;color:#fff}
button{
  background:#f5c400;color:#000;font-weight:900;cursor:pointer
}
.badge{
  display:inline-block;padding:4px 10px;border-radius:999px;
  background:#222;font-size:12px;margin-top:6px
}
.hidden{display:none}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> â€“ SÃ¼rÃ¼cÃ¼</header>

<div class="wrap">

<div id="loginCard" class="card">
  <b>SÃ¼rÃ¼cÃ¼ GiriÅŸi</b><br><br>
  <input id="did" placeholder="Driver ID (DRV-001)">
  <button onclick="login()">GÄ°RÄ°Åž</button>
</div>

<div id="jobCard" class="card hidden">
  <b>Aktif Ä°ÅŸ</b><br><br>
  <div id="jobInfo">â€”</div>
  <div id="jobStatus" class="badge">â€”</div><br><br>

  <button id="btnStart" onclick="startJob()" class="hidden">ðŸš— YOLA Ã‡IKTIM</button>
  <button id="btnFinish" onclick="finishJob()" class="hidden">âœ… Ä°ÅžÄ° BÄ°TÄ°R</button>
</div>

</div>

<script>
const BACKEND_URL =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

let DRIVER_ID = sessionStorage.getItem("SEPT_driver_id") || "";
let ACTIVE_JOB = null;

const $=id=>document.getElementById(id);

function login(){
  DRIVER_ID=$("did").value.trim();
  if(!DRIVER_ID) return alert("Driver ID gir");
  sessionStorage.setItem("SEPT_driver_id",DRIVER_ID);
  $("loginCard").classList.add("hidden");
  $("jobCard").classList.remove("hidden");
  loadJob();
  setInterval(loadJob,4000);
}

async function loadJob(){
  const jobs = await fetch(BACKEND_URL+"?action=getJobs").then(r=>r.json());
  const j = jobs.find(x=>x.driver_id===DRIVER_ID && x.status!=="completed");
  if(!j){
    $("jobInfo").innerText="Aktif iÅŸ yok";
    $("jobStatus").innerText="â€”";
    $("btnStart").classList.add("hidden");
    $("btnFinish").classList.add("hidden");
    return;
  }

  ACTIVE_JOB=j;
  $("jobInfo").innerText = j.from_address+" â†’ "+j.to_address;
  $("jobStatus").innerText = j.status;

  $("btnStart").classList.toggle("hidden",j.status!=="assigned");
  $("btnFinish").classList.toggle("hidden",j.status!=="on_route");
}

async function updateStatus(status){
  if(!ACTIVE_JOB) return;
  await fetch(BACKEND_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({
      action:"updateStatus",
      job_id:ACTIVE_JOB.job_id,
      status,
      driver_id:DRIVER_ID
    })
  });
  loadJob();
}

function startJob(){ updateStatus("on_route"); }
function finishJob(){ updateStatus("completed"); }

if(DRIVER_ID){
  $("loginCard").classList.add("hidden");
  $("jobCard").classList.remove("hidden");
  loadJob();
  setInterval(loadJob,4000);
}
</script>

</body>
</html>
