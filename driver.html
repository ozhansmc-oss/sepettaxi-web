<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi ‚Äì S√ºr√ºc√º</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:15px; }
h2 { margin-top:0; }
.card { background:#fff; padding:12px; margin-bottom:10px; border-radius:8px; }
button { padding:8px 12px; border:none; border-radius:6px; cursor:pointer; }
.accept { background:#27ae60; color:#fff; }
.gps { background:#2980b9; color:#fff; margin-top:6px; }
.debug { font-size:12px; color:#555; margin-top:6px; }
</style>
</head>

<body>

<h2>üöï S√ºr√ºc√º ‚Äì ƒ∞≈ü Havuzu</h2>

<div id="status">Baƒülanƒ±yor‚Ä¶</div>
<div id="jobs"></div>

<script>
/* ===============================
   AYAR
================================ */
const API_URL = "https://script.google.com/macros/s/AKfycbw_5YZ423wGwaZ6bu3F0a_oxrX_i_ycLS9-DQb0lRDcVCTOwvIGWFKpIPaWVAxVP9jx/exec";
const DRIVER_ID = "DRV-001";

/* ===============================
   JOB Lƒ∞STELE
================================ */
function loadJobs(){
  fetch(API_URL + "?action=listJobs")
    .then(r => r.json())
    .then(data => {
      document.getElementById("status").innerText = "Baƒülandƒ± ‚úî";
      renderJobs(data.jobs || []);
    })
    .catch(err => {
      document.getElementById("status").innerText = "Baƒülantƒ± HATASI ‚ùå";
      console.error(err);
    });
}

function renderJobs(jobs){
  const box = document.getElementById("jobs");
  box.innerHTML = "";

  if(jobs.length === 0){
    box.innerHTML = "<div class='card'>Bekleyen i≈ü yok</div>";
    return;
  }

  jobs.forEach(j => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>Job:</b> ${j.job_id}<br>
      <b>Fiyat:</b> ${j.price}<br>
      <button class="accept" onclick="acceptJob('${j.job_id}')">Kabul Et</button>
      <div class="debug">status=${j.status}</div>
    `;
    box.appendChild(div);
  });
}

/* ===============================
   JOB KABUL
================================ */
function acceptJob(jobId){
  fetch(API_URL, {
    method:"POST",
    body:JSON.stringify({
      action:"acceptJob",
      job_id:jobId,
      driver_id:DRIVER_ID
    })
  })
  .then(r => r.json())
  .then(res => {
    alert("ƒ∞≈ü kabul edildi");
    startGPS(jobId);
    loadJobs();
  });
}

/* ===============================
   GPS G√ñNDER
================================ */
function startGPS(jobId){
  navigator.geolocation.watchPosition(pos => {
    fetch(API_URL, {
      method:"POST",
      body:JSON.stringify({
        action:"updateDriverLocation",
        job_id:jobId,
        lat:pos.coords.latitude,
        lng:pos.coords.longitude
      })
    });
  });
}

/* ===============================
   BA≈ûLAT
================================ */
loadJobs();
</script>

</body>
</html>
