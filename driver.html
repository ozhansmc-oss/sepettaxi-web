<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Driver</title>
<style>/* â€¦ minimal styling â€¦ */</style>
</head>
<body>

<header>Sepet<span>Taxi</span> â€“ SÃ¼rÃ¼cÃ¼</header>

<div>
  Driver ID: <input id="driverId">
  <button onclick="saveDriver()">Kaydet</button>
</div>

<div>
  Hizmet: <button onclick="pick('taxi')">ðŸš•</button><button onclick="pick('courier')">ðŸ“¦</button>
  <button onclick="startSearch()">Ä°Åž ARA</button>
  <button onclick="stopSearch()">DURDUR</button>
</div>

<div id="status">Durum: â€”</div>

<div id="jobCard" style="display:none">
  <div id="jobInfo"></div>
  <button onclick="accept()">KABUL</button>
  <button onclick="reject()">REDDET</button>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";
let service=null,driverId="",timer=null,found=null;

function pick(s){ service=s; }

function saveDriver(){
  driverId=document.getElementById("driverId").value;
  fetch(BACKEND_URL,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"upsertDriver",driver_id:driverId})
  });
  document.getElementById("status").textContent="Driver kaydedildi";
}

function startSearch(){
  if(!service||!driverId) return;
  stopSearch();
  timer=setInterval(async()=>{
    const url=new URL(BACKEND_URL);
    url.searchParams.set("action","getOpenJob");
    url.searchParams.set("service_type",service);
    const r=await fetch(url.toString());
    const j=await r.json();
    if(j.job_id){ found=j; showJob(j); stopSearch(); }
  },3000);
}

function stopSearch(){ if(timer){clearInterval(timer);timer=null;} }

function showJob(j){
  document.getElementById("jobCard").style.display="block";
  document.getElementById("jobInfo").textContent=`${j.service_type} â€¢ ${j.price_brut} TL`;
}

function accept(){
  fetch(BACKEND_URL,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ action:"assignJob",job_id:found.job_id,driver_id:driverId })
  })
  .then(()=>location.href=`track.html?role=driver&job_id=${encodeURIComponent(found.job_id)}&driver_id=${encodeURIComponent(driverId)}`);
}

function reject(){ document.getElementById("jobCard").style.display="none"; }
</script>

</body>
</html>
