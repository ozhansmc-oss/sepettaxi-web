<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Sürücü</title>
<meta name="theme-color" content="#050506">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:system-ui,Arial}
body{overflow:hidden}

:root{
  --y:#f5c400;
  --line:rgba(255,255,255,.1);
}

.top{
  height:56px;
  display:flex;align-items:center;justify-content:center;
  border-bottom:1px solid var(--line);
  background:#0f0f10;
  font-weight:900;
}
.top span{color:var(--y)}

.main{
  height:calc(100vh - 56px);
  overflow-y:auto;
  padding:12px;
}

.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  background:#0f0f10;
}

input,select,button{
  width:100%;
  height:44px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#141416;
  color:#fff;
  margin-bottom:10px;
  padding:0 12px;
  font-weight:800;
}

button.primary{
  background:var(--y);
  color:#111;
}

.job{
  border:1px solid rgba(245,196,0,.3);
  background:rgba(245,196,0,.1);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.job b{color:var(--y)}
</style>
</head>

<body>
<div class="top">Sepet<span>Taxi</span> • Sürücü</div>

<div class="main">

  <!-- LOGIN / REGISTER -->
  <div id="authCard" class="card">
    <h3>Sürücü Girişi</h3>
    <input id="drvName" placeholder="Ad Soyad">
    <input id="drvPhone" placeholder="Telefon">
    <input id="drvPlate" placeholder="Plaka">
    <select id="drvType">
      <option value="taxi">Taksi</option>
      <option value="courier">Kurye</option>
    </select>
    <button id="btnLogin" class="primary">Giriş / Kayıt</button>
  </div>

  <!-- ACTIVE -->
  <div id="activeCard" class="card" style="display:none">
    <h3>Hoş geldin <span id="drvHello"></span></h3>
    <button id="btnLogout">Çıkış</button>
  </div>

  <!-- JOBS -->
  <div id="jobsCard" class="card" style="display:none">
    <h3>Açık İşler</h3>
    <div id="jobs"></div>
  </div>

</div>

<script>
/* BACKEND */
const API="https://script.google.com/macros/s/AKfycbwAKdSbXtKupy7Bp0gRIrB68bScvIvVjpSPFUYrDf6marNE43qm_DEHO_dPdTTroIDC/exec";

/* JSONP */
function apiJSONP(p){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(16).slice(2);
    p.callback=cb;
    window[cb]=(d)=>{res(d);delete window[cb];s.remove();}
    const s=document.createElement("script");
    s.src=API+(API.includes("?")?"&":"?")+new URLSearchParams(p);
    s.onerror=()=>{delete window[cb];s.remove();rej();}
    document.head.appendChild(s);
  });
}

/* STATE */
let driver=null;
let heartbeatTimer=null;

/* STORAGE */
function saveDriver(d){ localStorage.setItem("sepettaxi_driver", JSON.stringify(d)); }
function loadDriver(){
  try{ return JSON.parse(localStorage.getItem("sepettaxi_driver")); }
  catch(_){ return null; }
}
function clearDriver(){ localStorage.removeItem("sepettaxi_driver"); }

/* UI */
function showAuth(on){
  authCard.style.display = on?"block":"none";
  activeCard.style.display = on?"none":"block";
  jobsCard.style.display = on?"none":"block";
}

/* LOGIN */
btnLogin.onclick=()=>{
  const name=drvName.value.trim();
  const phone=drvPhone.value.trim();
  const plate=drvPlate.value.trim();
  const vehicle_type=drvType.value;

  if(name.length<3 || phone.length<10){
    alert("Bilgileri düzgün gir");
    return;
  }

  apiJSONP({
    action:"driverUpsert",
    name, phone, plate, vehicle_type
  }).then(r=>{
    if(!r.ok){ alert("Giriş başarısız"); return; }
    driver={ driver_id:r.data.driver_id, token:r.data.token, name };
    saveDriver(driver);
    initDriver();
  });
};

btnLogout.onclick=()=>{
  clearDriver();
  location.reload();
};

/* INIT */
function initDriver(){
  drvHello.textContent = driver.name;
  showAuth(false);
  refreshJobs();
  startHeartbeat();
}

/* JOBS */
function refreshJobs(){
  apiJSONP({ action:"listOpenJobs" })
    .then(r=>{
      if(!r.ok){ jobs.innerHTML="Hata"; return; }
      jobs.innerHTML="";
      r.data.jobs.forEach(j=>{
        const d=document.createElement("div");
        d.className="job";
        d.innerHTML=`
          <div><b>${j.service_type}</b></div>
          <div>${j.from_address || ""}</div>
          <div>${j.to_address || ""}</div>
          <button>İşi Kabul Et</button>
        `;
        d.querySelector("button").onclick=()=>acceptJob(j.job_id);
        jobs.appendChild(d);
      });
    });
}

function acceptJob(job_id){
  apiJSONP({
    action:"acceptJob",
    job_id,
    driver_id:driver.driver_id,
    token:driver.token
  }).then(r=>{
    if(r.ok){
      alert("İş kabul edildi");
      refreshJobs();
    }else{
      alert("Kabul edilemedi");
    }
  });
}

/* HEARTBEAT */
function startHeartbeat(){
  if(!navigator.geolocation) return;
  heartbeatTimer=setInterval(()=>{
    navigator.geolocation.getCurrentPosition(p=>{
      apiJSONP({
        action:"driverHeartbeat",
        driver_id:driver.driver_id,
        token:driver.token,
        lat:p.coords.latitude,
        lng:p.coords.longitude
      });
    });
  }, 5000);
}

/* BOOT */
const saved=loadDriver();
if(saved){
  driver=saved;
  initDriver();
}
</script>
</body>
</html>
