<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>SepetTaxi – Driver</title>

<script src="config.js"></script>
<script src="log.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
:root{--y:#f5c400}
header{
  height:56px;background:#000;border-bottom:1px solid #111;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:900
}
header span{color:var(--y)}
.container{padding:14px}
.card{background:#0f0f0f;border:1px solid #222;border-radius:16px;padding:14px;margin-bottom:14px}
.card b{display:block;margin-bottom:8px}
.input{width:100%;padding:12px;border-radius:14px;border:1px solid #222;background:#000;color:#fff}
.btn{width:100%;padding:14px;border-radius:14px;border:0;background:var(--y);color:#000;font-weight:900;font-size:16px;cursor:pointer}
.btn.dark{background:#111;color:#fff;border:1px solid #222}
.small{font-size:12px;color:#aaa}
.hidden{display:none}
</style>
</head>

<body>
<header>Sepet<span>Taxi</span> Driver</header>

<div class="container">
  <div id="loginCard" class="card hidden">
    <b>Driver Girişi</b>
    <input id="drvId" class="input" placeholder="Driver ID (DRV-XXXX)">
    <div style="height:10px"></div>
    <button class="btn" onclick="login()">GİRİŞ</button>
    <div class="small" style="margin-top:8px">Driver ID, “Sürücü Ol” başvurusunda verilir.</div>
  </div>

  <div id="jobCard" class="card hidden">
    <b>Açık İş</b>
    <div id="jobInfo" class="small">Yükleniyor…</div>
    <div style="height:12px"></div>
    <button class="btn" onclick="acceptJob()">KABUL ET</button>
  </div>

  <div id="emptyCard" class="card hidden">
    <b>Açık İş Yok</b>
    <div class="small">Şu anda bekleyen iş bulunmuyor.</div>
    <div style="height:12px"></div>
    <button class="btn dark" onclick="loadJob()">Yenile</button>
  </div>
</div>

<script>
const API = window.SEPT && SEPT.BACKEND_URL ? SEPT.BACKEND_URL : "";
let driverId = (localStorage.getItem("st_driver_id") || "").toUpperCase() || null;
let currentJob = null;

const loginCard = document.getElementById("loginCard");
const jobCard   = document.getElementById("jobCard");
const emptyCard = document.getElementById("emptyCard");
const jobInfo   = document.getElementById("jobInfo");

document.addEventListener("DOMContentLoaded", ()=>{
  if(!driverId){ loginCard.classList.remove("hidden"); }
  else{ loadJob(); }
});

function login(){
  const id = (drvId.value || "").trim().toUpperCase();
  if(!id || !/^DRV-/.test(id)) return alert("Geçerli Driver ID gir");
  localStorage.setItem("st_driver_id", id);
  driverId = id;
  loginCard.classList.add("hidden");
  loadJob();
}

async function loadJob(){
  jobCard.classList.add("hidden");
  emptyCard.classList.add("hidden");
  jobInfo.textContent="Yükleniyor…";

  const res = await fetch(API + "?action=getOpenJob");
  const d = await res.json();
  Log.api("getOpenJob", {}, d);

  if(d && d.ok && d.job_id){
    currentJob = d;
    jobInfo.innerHTML = `
      <b>Mesafe:</b> ${Number(d.distance_km||0).toFixed(2)} km<br>
      <b>Ücret (Net):</b> ${d.price_driver_net || "—"} TL<br>
      <b>Nereden:</b> ${d.from_addr || "—"}<br>
      <b>Nereye:</b> ${d.to_addr || "—"}
    `;
    jobCard.classList.remove("hidden");
  }else{
    currentJob=null;
    emptyCard.classList.remove("hidden");
  }
}

async function acceptJob(){
  if(!currentJob) return;

  const body = { action:"assignJob", job_id: currentJob.job_id, driver_id: driverId };

  try{
    // normal -> fallback no-cors
    try{
      const res = await fetch(API,{
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(body)
      });
      const d = await res.json();
      Log.api("assignJob", body, d);

      if(d && d.ok){
        location.href = "track.html?driver=1&driver_id="+encodeURIComponent(driverId)+"&job_id="+encodeURIComponent(currentJob.job_id);
        return;
      }
    }catch(_){
      await fetch(API,{
        method:"POST", mode:"no-cors",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(body)
      });
      location.href = "track.html?driver=1&driver_id="+encodeURIComponent(driverId)+"&job_id="+encodeURIComponent(currentJob.job_id);
      return;
    }
  }catch(_){}

  alert("İş alınamadı. Başkası almış olabilir.");
  loadJob();
}
</script>
</body>
</html>
