<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SepetTaxi – Driver</title>
<style>
body{font-family:Arial;background:#f6f7f9;padding:20px}
.job{background:#fff;padding:15px;border-radius:8px;margin-bottom:10px}
button{padding:10px;width:100%;cursor:pointer}
</style>
</head>
<body>

<h2>Uygun Çağrılar</h2>
<div id="jobs"></div>

<script>
/* ================== AYAR ================== */
const API_URL = "https://script.google.com/macros/s/AKfycbxmjbl9o0881xyp8EV4IgKFI72GDpAw8GtT4OS-uOnMzkGloQn8C_C6A9q5mMIEsBSy/exec";
const DRIVER_ID = "DRV-001";
/* ========================================= */

let activeJobId = null;

/* Job listele */
fetch(API_URL + "?action=getJobs&status=pending")
  .then(r => r.json())
  .then(data => {
    if (!data.length) {
      jobs.innerHTML = "Uygun çağrı yok";
      return;
    }

    data.forEach(j => {
      jobs.innerHTML += `
        <div class="job">
          <b>${j.service_type}</b> – ${j.job_id}<br><br>
          <button onclick="acceptJob('${j.job_id}')">Kabul Et</button>
        </div>`;
    });
  });

/* Job kabul */
function acceptJob(jobId) {
  activeJobId = jobId;

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "updateStatus",
      job_id: jobId,
      status: "accepted",
      driver_id: DRIVER_ID
    })
  });

  startLiveLocation();
  alert("Çağrı kabul edildi, konum gönderiliyor");
}

/* Canlı konum */
function startLiveLocation() {
  if (!navigator.geolocation) {
    alert("Konum desteği yok");
    return;
  }

  setInterval(() => {
    navigator.geolocation.getCurrentPosition(pos => {
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "updateDriverLocation",
          job_id: activeJobId,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        })
      });
    });
  }, 5000);
}
</script>

</body>
</html>
