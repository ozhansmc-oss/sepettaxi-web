<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi ‚Äì S√ºr√ºc√º</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
.card{background:#fff;padding:12px;margin-bottom:10px;border-radius:8px}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
.accept{background:#27ae60;color:#fff}
  let gpsTimer = null;

function startGPS(jobId){
  if(gpsTimer) clearInterval(gpsTimer);

  gpsTimer = setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
          action:"updateDriverLocation",
          job_id: jobId,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        })
      });
    });
  }, 3000);
}

function accept(id){
  post({action:"acceptJob", job_id:id, driver_id:DRIVER_ID});
  startGPS(id);
}

.complete{background:#e67e22;color:#fff;margin-left:6px}
</style>
</head>
<body>

<h2>üöï S√ºr√ºc√º ‚Äì ƒ∞≈ü Havuzu</h2>
<div id="status">Baƒülanƒ±yor‚Ä¶</div>
<div id="jobs"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbx8el5RvTxWIWZfAIdvhm8q8AYOejPPYRmzFbIoD5mCMUVhT-p2XCH3ixm-gXl23jKv/exec";
const DRIVER_ID = "DRV-001";

fetch(API_URL + "?action=listJobs")
  .then(r => r.json())
  .then(d => {
    document.getElementById("status").innerText = "Baƒülandƒ± ‚úî";
    render(d.jobs || []);
  })
  .catch(() => {
    document.getElementById("status").innerText = "Baƒülantƒ± HATASI ‚ùå";
  });

function render(jobs){
  const box = document.getElementById("jobs");
  box.innerHTML = "";
  if(!jobs.length){
    box.innerHTML = "<div class='card'>Bekleyen i≈ü yok</div>";
    return;
  }
  jobs.forEach(j=>{
    box.innerHTML += `
      <div class="card">
        <b>${j.job_id}</b><br>
        <button class="accept" onclick="accept('${j.job_id}')">Kabul</button>
        <button class="complete" onclick="completeJob('${j.job_id}')">Tamamla</button>
      </div>`;
  });
}

function accept(id){
  post({action:"acceptJob", job_id:id, driver_id:DRIVER_ID});
}

function completeJob(id){
  post({action:"completeJob", job_id:id});
}

function post(data){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify(data)
  }).then(()=>location.reload());
}
</script>

</body>
</html>
