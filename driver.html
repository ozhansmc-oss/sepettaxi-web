<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi â€“ SÃ¼rÃ¼cÃ¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
h2{margin-top:0}
.card{background:#fff;padding:12px;margin-bottom:10px;border-radius:10px}
.small{font-size:12px;color:#666}
.row{display:flex;gap:10px;margin-top:8px}
.row>div{flex:1}
button{padding:9px 12px;border:none;border-radius:8px;cursor:pointer}
.accept{background:#27ae60;color:#fff}
.complete{background:#e67e22;color:#fff;margin-left:6px}
</style>
</head>
<body>

<h2>ğŸš• SÃ¼rÃ¼cÃ¼ â€“ Ä°ÅŸ Havuzu</h2>
<div id="status">BaÄŸlanÄ±yorâ€¦</div>
<div id="jobs"></div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzFQSArFEb9l94C3aF6q3254xe3ncBsMhxfn4ezodaJg4oRXeNcImn-LiJ_hAtrsUdb/exec";
const DRIVER_ID = "DRV-001";

let gpsTimer = null;
let activeJobId = null;

load();

function load(){
  fetch(API_URL + "?action=listJobs")
    .then(r=>r.json())
    .then(d=>{
      document.getElementById("status").innerText="BaÄŸlandÄ± âœ“";
      render(d.jobs || []);
    })
    .catch(()=> document.getElementById("status").innerText="BaÄŸlantÄ± HATASI âŒ");
}

function render(jobs){
  const box = document.getElementById("jobs");
  box.innerHTML = "";
  if(!jobs.length){
    box.innerHTML = "<div class='card'>Bekleyen iÅŸ yok</div>";
    return;
  }

  // sadece pending gÃ¶sterelim (accepted iÅŸleri ayrÄ±ca yÃ¶netebiliriz)
  const pending = jobs.filter(j => j.status === "pending");
  if(!pending.length){
    box.innerHTML = "<div class='card'>Bekleyen iÅŸ yok</div>";
    return;
  }

  pending.forEach(j=>{
    box.innerHTML += `
      <div class="card">
        <b>${j.job_id}</b>
        <div class="small">Hizmet: ${j.service} â€¢ Durum: ${j.status}</div>

        <div class="row">
          <div>
            <div class="small">Mesafe</div>
            <b>${j.distance_km || "-"} km</b>
          </div>
          <div>
            <div class="small">Net Fiyat</div>
            <b>${j.price || "-"} TL</b>
          </div>
        </div>

        <div class="small" style="margin-top:8px;">
          <b>Pickup:</b> ${j.pickup_address || "â€”"}<br>
          <b>Dropoff:</b> ${j.dropoff_address || "â€”"}
        </div>

        <div style="margin-top:10px;">
          <button class="accept" onclick="acceptJob('${j.job_id}')">Kabul</button>
          <button class="complete" onclick="completeJob('${j.job_id}')">Tamamla</button>
        </div>
      </div>`;
  });
}

function acceptJob(jobId){
  // âœ… Konum iznini mutlaka kullanÄ±cÄ± tÄ±klamasÄ±nda iste
  navigator.geolocation.getCurrentPosition(()=>{
    fetch(API_URL,{
      method:"POST",
      body: JSON.stringify({
        action:"acceptJob",
        job_id: jobId,
        driver_id: DRIVER_ID
      })
    })
    .then(r=>r.json())
    .then(d=>{
      if(d.error){
        alert("Kabul edilemedi: " + d.error);
        return;
      }
      activeJobId = jobId;
      startGPS(jobId);
      load();
    });
  },()=>{
    alert("Konum izni verilmeden iÅŸ kabul edilemez.");
  });
}

function startGPS(jobId){
  if(gpsTimer) clearInterval(gpsTimer);

  gpsTimer = setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      fetch(API_URL,{
        method:"POST",
        body: JSON.stringify({
          action:"updateDriverLocation",
          job_id: jobId,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        })
      });
    });
  }, 3000);
}

function completeJob(jobId){
  if(gpsTimer && activeJobId === jobId){
    clearInterval(gpsTimer);
    gpsTimer = null;
    activeJobId = null;
  }

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({
      action:"completeJob",
      job_id: jobId
    })
  }).then(()=> load());
}
</script>

</body>
</html>
