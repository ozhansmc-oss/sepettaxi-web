<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Driver Panel</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}
.wrap{padding:14px;max-width:760px;margin:auto}
.card{background:#111;border-radius:16px;padding:14px;margin-bottom:12px}
input{width:100%;padding:12px;border-radius:12px;border:0;background:#222;color:#fff}
button{width:100%;padding:14px;border-radius:22px;border:0;font-weight:900;background:#f5c400;color:#000;cursor:pointer}
.small{font-size:12px;color:#aaa}
.big{font-size:26px;font-weight:900}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#222;color:#aaa;font-size:12px}
.auth-only{display:none}
hr{border:0;border-top:1px solid #222;margin:10px 0}
.navBtn{background:#0f0f0f;color:#fff;border:1px solid #333;margin-bottom:8px}
</style>
</head>

<body>
<header>Sepet<span>Taxi</span> â€“ Driver</header>

<div class="wrap">

<div class="card" id="loginCard">
  <b>SÃ¼rÃ¼cÃ¼ GiriÅŸi</b>
  <div style="height:8px"></div>
  <input id="did" placeholder="Driver ID (Ã¶rn: DRV-001)">
  <div style="height:10px"></div>
  <input id="dname" placeholder="Ad Soyad (opsiyonel)">
  <div style="height:10px"></div>
  <input id="dphone" placeholder="Telefon (05XXXXXXXXX)" maxlength="11">
  <div style="height:10px"></div>
  <button onclick="login()">Panele Gir</button>
</div>

<div class="card auth-only">
  <b>SÃ¼rÃ¼cÃ¼ Ã–zeti</b>
  <div class="grid" style="margin-top:10px">
    <div><div class="small">BugÃ¼nkÃ¼ KazanÃ§</div><div class="big" id="todayEarn">â€”</div></div>
    <div><div class="small">Toplam KazanÃ§</div><div class="big" id="totalEarn">â€”</div></div>
    <div><div class="small">Toplam Komisyon</div><div class="big" id="totalComm">â€”</div></div>
    <div><div class="small">Net KazanÃ§</div><div class="big" id="netEarn">â€”</div></div>
  </div>
</div>

<div class="card auth-only">
  <b>Aktif Ä°ÅŸ</b>
  <div id="activeJob" class="small">Aktif iÅŸ yok.</div>
</div>

<div class="card auth-only">
  <b>GeÃ§miÅŸ Ä°ÅŸler</b>
  <div id="history"></div>
</div>

</div>

<script src="config.js"></script>

<script>
const BACKEND_URL = window.SEPT.BACKEND_URL;
const COMMISSION = window.SEPT.COMMISSION || 0.15;

let DRIVER_ID = sessionStorage.getItem("SEPT_driver_id");
let LIVE_TIMER=null;

const $=id=>document.getElementById(id);

/* ================= LOGIN ================= */
async function login(){
  DRIVER_ID=$("did").value.trim();
  if(!DRIVER_ID) return alert("Driver ID gir");

  sessionStorage.setItem("SEPT_driver_id",DRIVER_ID);

  await fetch(BACKEND_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({
      action:"ensureDriver",
      driver_id:DRIVER_ID,
      name:$("dname").value,
      phone:$("dphone").value,
      status:"available"
    })
  });

  onAuth();
}

/* ================= AUTH ================= */
function onAuth(){
  document.querySelectorAll(".auth-only").forEach(e=>e.style.display="block");
  $("loginCard").style.display="none";
  loadData();
  setInterval(loadData,5000);
}

/* ================= DATA ================= */
async function loadData(){
  const jobs=await fetch(`${BACKEND_URL}?action=getJobs`).then(r=>r.json());
  const mine=jobs.filter(j=>String(j.driver_id)===String(DRIVER_ID));
  renderSummary(mine);
  renderActive(mine);
  renderHistory(mine);
}

function priceOf(j){
  const p=Number(String(j.final_price||j.price||0).replace(/[^\d.]/g,""));
  return isFinite(p)?p:0;
}

function renderSummary(jobs){
  let total=0,comm=0;
  jobs.forEach(j=>{
    if(j.status==="completed"){
      const p=priceOf(j);
      total+=p; comm+=p*COMMISSION;
    }
  });
  $("totalEarn").innerText=total.toFixed(0)+" TL";
  $("totalComm").innerText=comm.toFixed(0)+" TL";
  $("netEarn").innerText=(total-comm).toFixed(0)+" TL";
}

/* ================= NAV ================= */
function openNav(fromLat,fromLng,toLat,toLng){
  const url=
    `https://www.google.com/maps/dir/?api=1`+
    `&origin=${fromLat},${fromLng}`+
    `&destination=${toLat},${toLng}`+
    `&travelmode=driving`;
  window.open(url,"_blank");
}

async function navTo(jobId,type){
  const jobs=await fetch(`${BACKEND_URL}?action=getJobs`).then(r=>r.json());
  const j=jobs.find(x=>x.job_id===jobId);
  if(!j) return;

  navigator.geolocation.getCurrentPosition(p=>{
    if(type==="pickup"){
      openNav(p.coords.latitude,p.coords.longitude,j.pickup_lat,j.pickup_lng);
    }else{
      openNav(p.coords.latitude,p.coords.longitude,j.dropoff_lat,j.dropoff_lng);
    }
  });
}

/* ================= ACTIVE ================= */
function renderActive(jobs){
  const box=$("activeJob");
  const j=jobs.find(x=>x.status==="assigned"||x.status==="on_route");
  if(!j){ box.innerText="Aktif iÅŸ yok."; stopLive(); return; }

  let btns="";
  if(j.status==="assigned"){
    btns=`
      <button class="navBtn" onclick="navTo('${j.job_id}','pickup')">ðŸ§­ Pickupâ€™a Git</button>
      <button onclick="setStatus('${j.job_id}','on_route')">YOLA Ã‡IKTIM</button>
    `;
  }
  if(j.status==="on_route"){
    btns=`
      <button class="navBtn" onclick="navTo('${j.job_id}','dropoff')">ðŸ§­ Teslimata Git</button>
      <button onclick="setStatus('${j.job_id}','completed')">Ä°ÅžÄ° BÄ°TÄ°R</button>
    `;
  }

  box.innerHTML=`
    <b>${j.from_address} â†’ ${j.to_address}</b><br>
    <span class="badge">${j.status}</span><br><br>${btns}
  `;

  if(j.status==="on_route") startLive(j.job_id);
  else stopLive();
}

/* ================= HISTORY ================= */
function renderHistory(jobs){
  $("history").innerHTML="";
  jobs.filter(j=>j.status==="completed").slice(-10).reverse().forEach(j=>{
    $("history").innerHTML+=`<div class="small">${j.from_address} â†’ ${j.to_address}</div><hr>`;
  });
}

/* ================= ACTIONS ================= */
async function setStatus(jobId,status){
  await fetch(BACKEND_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({
      action:"updateStatus",
      job_id:jobId,
      status,
      driver_id:DRIVER_ID
    })
  });
  loadData();
}

function startLive(jobId){
  if(LIVE_TIMER) return;
  LIVE_TIMER=setInterval(()=>{
    navigator.geolocation.getCurrentPosition(p=>{
      fetch(BACKEND_URL,{
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body:JSON.stringify({
          action:"ping",
          job_id:jobId,
          driver_id:DRIVER_ID,
          lat:p.coords.latitude,
          lng:p.coords.longitude
        })
      });
    });
  },5000);
}

function stopLive(){
  if(LIVE_TIMER){ clearInterval(LIVE_TIMER); LIVE_TIMER=null; }
}

/* ================= AUTO ================= */
if(DRIVER_ID) onAuth();
</script>

</body>
</html>
