<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Sürücü</title>
<meta name="theme-color" content="#f5c400">
<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;overflow:hidden}
:root{--y:#f5c400;--card:#141416;--line:rgba(255,255,255,.12);--mut:rgba(255,255,255,.65)}
.wrap{height:100%;display:flex;flex-direction:column}
.top{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:1000}
.pill{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:#fff;font-weight:900;font-size:12px}
.main{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.card{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:18px;padding:12px}
.h{font-size:12px;color:var(--mut);font-weight:900}
.v{font-size:14px;font-weight:1000;margin-top:6px}
.tabs{display:flex;gap:8px}
.tab{flex:1;padding:10px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03);text-align:center;font-weight:1000;cursor:pointer}
.tab.active{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.10)}
.btn{width:100%;padding:12px;border-radius:16px;border:0;font-weight:1000;background:linear-gradient(135deg,#f5c400,#ffd34d);color:#1a1400;cursor:pointer}
.btn.secondary{background:rgba(255,255,255,.06);border:1px solid var(--line);color:#fff}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.input,select{width:100%;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:#fff;outline:none}
.row{display:flex;gap:10px}
.small{font-size:12px;color:var(--mut)}
.list{display:flex;flex-direction:column;gap:10px}
.item{padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
.itemTop{display:flex;justify-content:space-between;gap:10px}
.badge{padding:6px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;font-weight:1000;color:#fff}
.badge.y{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.10)}
.hr{height:1px;background:var(--line);margin:10px 0}
</style>
</head>
<body>
<script>
/* ===== CONFIG ===== */
const API = "https://script.google.com/macros/s/AKfycbzXbm934CXIjTSL9RxmL8kkCjGERoeiQPDfY-OUk2Lexqqr_UvppoJ2yT0t562aJZdxRg/exec";

/* ===== HELPERS ===== */
function postForm(data){
  const body = new URLSearchParams(data);
  return fetch(API,{method:"POST",body}).then(r=>r.json());
}
function money(n){ return (Number(n)||0).toFixed(2).replace(".00","") + " ₺"; }
</script>

<div class="wrap">
  <div class="top">
    <div class="brand">SepetTaxi · Sürücü</div>
    <div class="pill" id="rolePill">—</div>
  </div>

  <div class="main" id="main"></div>
</div>

<script>
/* ===== STATE ===== */
let driver = null;
let driverId = localStorage.getItem("sepettaxi_driver_id") || "";
let role = localStorage.getItem("sepettaxi_driver_role") || "";
let heartbeatTimer = null;

function viewLogin(){
  document.getElementById("rolePill").textContent = "Giriş";
  main.innerHTML = `
    <div class="card">
      <div class="h">Sürücü ID ile giriş</div>
      <div class="small" style="margin-top:6px">Admin onayı sonrası size verilen <b>DRV_...</b> ID ile giriş yapın.</div>
      <div style="margin-top:10px">
        <input class="input" id="drvId" placeholder="Örn: DRV_1700000000000" value="${driverId||""}">
      </div>
      <div style="margin-top:10px">
        <button class="btn" id="btnLogin">Giriş Yap</button>
      </div>
      <div class="small" id="loginHint" style="margin-top:10px"></div>
    </div>
  `;
  btnLogin.onclick = async ()=>{
    const id = drvId.value.trim();
    loginHint.textContent = "Kontrol ediliyor…";
    const res = await postForm({action:"driverLogin", driver_id:id});
    if(!res.ok){
      loginHint.textContent =
        res.message==="pending" ? "Başvurunuz onay bekliyor."
        : res.message==="rejected" ? ("Başvurunuz reddedildi: "+(res.reason||""))
        : ("Giriş başarısız: "+res.message);
      return;
    }
    driver = res.driver;
    driverId = driver.driver_id;
    role = driver.role || "taxi";
    localStorage.setItem("sepettaxi_driver_id", driverId);
    localStorage.setItem("sepettaxi_driver_role", role);
    viewHome();
  };
}

function viewHome(){
  document.getElementById("rolePill").textContent = (role==="courier"?"Kurye":"Taksi");
  main.innerHTML = `
    <div class="card">
      <div class="h">Profil</div>
      <div class="v">${driver.first||""} ${driver.last||""}</div>
      <div class="small">${driverId} · ${driver.phone||""}</div>
      <div class="hr"></div>
      <div class="tabs">
        <div class="tab active" id="tabPool">İş Havuzu</div>
        <div class="tab" id="tabActive">Aktif İş</div>
        <div class="tab" id="tabEarn">Kazanç</div>
      </div>
      <div class="hr"></div>
      <div id="panel"></div>
    </div>
    <div class="card">
      <button class="btn secondary" id="btnLogout">Çıkış</button>
    </div>
  `;

  btnLogout.onclick=()=>{
    stopDriverHeartbeat();
    localStorage.removeItem("sepettaxi_driver_id");
    localStorage.removeItem("sepettaxi_driver_role");
    driver=null; driverId=""; role="";
    viewLogin();
  };

  tabPool.onclick = ()=>{ setTab("pool"); };
  tabActive.onclick = ()=>{ setTab("active"); };
  tabEarn.onclick = ()=>{ setTab("earn"); };

  setTab("pool");
}

function setTab(name){
  ["tabPool","tabActive","tabEarn"].forEach(id=>document.getElementById(id).classList.remove("active"));
  if(name==="pool"){ tabPool.classList.add("active"); renderPool(); }
  if(name==="active"){ tabActive.classList.add("active"); renderActive(); }
  if(name==="earn"){ tabEarn.classList.add("active"); renderEarnings(); }
}

/* ===== HEARTBEAT (tek ve doğru) ===== */
function startDriverHeartbeat(){
  if(heartbeatTimer) return;

  heartbeatTimer = setInterval(()=>{
    if(!navigator.geolocation) return;
    navigator.geolocation.getCurrentPosition(pos=>{
      postForm({
        action:"driverHeartbeat",
        driver_id:driverId,
        lat:pos.coords.latitude,
        lng:pos.coords.longitude
      }).catch(()=>{});
    });
  }, 6000); // 6 sn (kilitli)
}
function stopDriverHeartbeat(){
  if(heartbeatTimer){
    clearInterval(heartbeatTimer);
    heartbeatTimer=null;
  }
}

/* ===== POOL ===== */
async function renderPool(){
  panel.innerHTML = `<div class="small">Yükleniyor…</div>`;
  const res = await postForm({action:"listAvailableJobs", service_type:role});
  if(!res.ok){ panel.innerHTML = `<div class="small">Hata: ${res.message}</div>`; return; }

  const jobs = res.jobs || [];
  if(!jobs.length){
    panel.innerHTML = `<div class="small">Şu an havuzda iş yok.</div>`;
    return;
  }

  panel.innerHTML = `
    <div class="small">Havuz: ${jobs.length} iş</div>
    <div class="list" id="poolList" style="margin-top:10px"></div>
  `;

  poolList.innerHTML = jobs.map(j=>`
    <div class="item">
      <div class="itemTop">
        <div>
          <div style="font-weight:1000">${(j.service_type||"").toUpperCase()} · ${money(j.price)}</div>
          <div class="small">${(j.from_address||"—")}</div>
          <div class="small">${(j.to_address||"—")}</div>
        </div>
        <div class="badge y">${j.status}</div>
      </div>
      <div style="margin-top:10px">
        <button class="btn" onclick="accept('${j.job_id}')">İşi Kabul Et</button>
      </div>
    </div>
  `).join("");
}

async function accept(jobId){
  const res = await postForm({action:"acceptJob", job_id:jobId, driver_id:driverId});
  if(!res.ok){ alert("Kabul edilemedi: "+res.message); return; }
  startDriverHeartbeat();
  setTab("active");
}

/* ===== ACTIVE JOB ===== */
async function renderActive(){
  panel.innerHTML = `<div class="small">Aktif iş aranıyor…</div>`;

  const res = await postForm({action:"listDriverJobs", driver_id:driverId});
  if(!res.ok){ panel.innerHTML = `<div class="small">Hata: ${res.message}</div>`; return; }

  const jobs = (res.jobs||[]).slice().reverse();
  const active = jobs.find(j=>{
    const st = String(j.status||"").toLowerCase();
    return st!=="completed" && st!=="cancelled" && st!=="";
  });

  if(!active){
    panel.innerHTML = `<div class="small">Aktif iş yok.</div>`;
    stopDriverHeartbeat();
    return;
  }

  const st = String(active.status||"").toLowerCase();
  panel.innerHTML = `
    <div class="item">
      <div class="itemTop">
        <div>
          <div style="font-weight:1000">${active.job_id}</div>
          <div class="small">${(active.from_address||"—")}</div>
          <div class="small">${(active.to_address||"—")}</div>
        </div>
        <div class="badge y">${active.status}</div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="card" style="padding:10px">
          <div class="h">Ücret</div>
          <div class="v">${money(active.price)}</div>
        </div>
        <div class="card" style="padding:10px">
          <div class="h">Komisyon</div>
          <div class="v">${active.commission_amount?money(active.commission_amount):"—"}</div>
        </div>
      </div>

      <div style="margin-top:10px" class="row">
        <button class="btn secondary" onclick="setStatus('${active.job_id}','pickup')" ${st==="pickup"||st==="onroad"||st==="completed"?"disabled":""}>Alıma Gidiyorum</button>
        <button class="btn secondary" onclick="setStatus('${active.job_id}','onroad')" ${st==="onroad"||st==="completed"?"disabled":""}>Yoldayım</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn" onclick="setStatus('${active.job_id}','completed')">Tamamlandı</button>
      </div>
      <div class="small" style="margin-top:10px">Not: Konum güncelleme aktif. Track ekranı sürücüyü canlı takip eder.</div>
    </div>
  `;

  startDriverHeartbeat();
}

async function setStatus(jobId,status){
  const res = await postForm({action:"driverUpdateStatus", job_id:jobId, status});
  if(!res.ok){ alert("Durum güncellenemedi: "+res.message); return; }
  renderActive();
}

/* ===== EARNINGS ===== */
async function renderEarnings(){
  panel.innerHTML = `<div class="small">Yükleniyor…</div>`;
  const res = await postForm({action:"listDriverJobs", driver_id:driverId});
  if(!res.ok){ panel.innerHTML = `<div class="small">Hata: ${res.message}</div>`; return; }

  const jobs = (res.jobs||[]);
  const done = jobs.filter(j=>String(j.status||"").toLowerCase()==="completed");

  let total=0, comm=0, net=0;
  done.forEach(j=>{
    total += Number(j.price)||0;
    comm  += Number(j.commission_amount)||0;
    net   += Number(j.driver_net)||0;
  });

  panel.innerHTML = `
    <div class="row">
      <div class="metric card">
        <div class="h">Toplam</div>
        <div class="v">${money(total)}</div>
      </div>
      <div class="metric card">
        <div class="h">Komisyon</div>
        <div class="v">${money(comm)}</div>
      </div>
      <div class="metric card">
        <div class="h">Net</div>
        <div class="v">${money(net)}</div>
      </div>
    </div>

    <div class="hr"></div>
    <div class="small">Tamamlanan işler: ${done.length}</div>
    <div class="list" style="margin-top:10px">
      ${done.slice().reverse().slice(0,30).map(j=>`
        <div class="item">
          <div class="itemTop">
            <div>
              <div style="font-weight:1000">${(j.service_type||"").toUpperCase()} · ${money(j.price)}</div>
              <div class="small">Komisyon: ${money(j.commission_amount)} · Net: ${money(j.driver_net)}</div>
            </div>
            <div class="badge">${j.status}</div>
          </div>
        </div>
      `).join("")}
    </div>
  `;
}

/* ===== BOOT ===== */
(async function boot(){
  if(!driverId){
    viewLogin(); return;
  }
  const res = await postForm({action:"driverLogin", driver_id:driverId});
  if(!res.ok){
    viewLogin(); return;
  }
  driver = res.driver;
  role = (driver.role||localStorage.getItem("sepettaxi_driver_role")||"taxi");
  localStorage.setItem("sepettaxi_driver_role", role);
  viewHome();
})();
</script>
</body>
</html>
