<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Driver</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}
.container{padding:12px}
.card{background:#111;border:1px solid #222;border-radius:14px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px}
.btn{background:#f5c400;color:#000;border-radius:16px;padding:14px;text-align:center;font-weight:900;cursor:pointer}
.btn.secondary{background:#333;color:#fff}
.input{width:100%;padding:10px;border-radius:12px;border:1px solid #222;background:#000;color:#fff}
.small{font-size:12px;color:#aaa}
.pill{flex:1;border:1px solid #222;border-radius:12px;padding:10px;text-align:center;background:#0f0f0f;color:#aaa;cursor:pointer}
.pill.active{border-color:#f5c400;color:#fff}
</style>
</head>
<body>

<header>Sepet<span>Taxi</span> â€“ SÃ¼rÃ¼cÃ¼</header>

<div class="container">
  <div class="card">
    <div class="small">Driver ID</div>
    <input id="driverId" class="input" placeholder="Ã–rn: DRV001">
    <div class="small" style="margin-top:8px">Ä°sim (opsiyonel)</div>
    <input id="name" class="input" placeholder="Ad Soyad">
    <div class="small" style="margin-top:8px">Telefon (opsiyonel)</div>
    <input id="phone" class="input" placeholder="05XXXXXXXXX">
    <div class="btn" style="margin-top:10px" onclick="saveDriver()">KAYDET</div>
  </div>

  <div class="card">
    <div class="small">Hizmet SeÃ§</div>
    <div class="row" style="margin-top:8px">
      <div id="tTaxi" class="pill" onclick="pick('taxi')">ðŸš• Taksi</div>
      <div id="tCourier" class="pill" onclick="pick('courier')">ðŸ“¦ Kurye</div>
    </div>
    <div class="btn" style="margin-top:10px" onclick="startSearch()">Ä°Åž ARA</div>
    <div class="btn secondary" style="margin-top:8px" onclick="stopSearch()">DURDUR</div>
    <div class="small" style="margin-top:8px" id="status">Durum: â€”</div>
  </div>

  <div class="card" id="jobCard" style="display:none">
    <div style="font-weight:900;margin-bottom:6px">Yeni Ä°ÅŸ</div>
    <div class="small" id="jobInfo">â€”</div>
    <div class="small" style="margin-top:8px">BrÃ¼t / Komisyon / Net</div>
    <div style="font-weight:900;margin-top:4px" id="money">â€”</div>

    <div id="courierDetails" style="display:none;margin-top:10px">
      <div class="small">Paket</div><div style="font-weight:900" id="pkg">â€”</div>
      <div class="small" style="margin-top:6px">Not</div><div style="font-weight:900" id="note">â€”</div>
      <div class="small" style="margin-top:6px">AlÄ±cÄ±</div><div style="font-weight:900" id="recv">â€”</div>
      <div class="small" style="margin-top:6px">Telefon</div><div style="font-weight:900" id="rphone">â€”</div>
    </div>

    <div class="btn" style="margin-top:12px" onclick="accept()">KABUL ET</div>
    <div class="btn secondary" style="margin-top:8px" onclick="reject()">REDDET</div>
  </div>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

const $=id=>document.getElementById(id);
let service=null, timer=null, found=null;

function qs(o){
  const u=new URL(BACKEND_URL);
  Object.entries(o).forEach(([k,v])=>u.searchParams.set(k,v));
  return u.toString();
}

function pick(s){
  service=s;
  tTaxi.classList.toggle("active",s==="taxi");
  tCourier.classList.toggle("active",s==="courier");
}

function load(){
  const id=localStorage.getItem("SEPET_DRIVER_ID")||"";
  driverId.value=id;
  name.value=localStorage.getItem("SEPET_DRIVER_NAME")||"";
  phone.value=localStorage.getItem("SEPET_DRIVER_PHONE")||"";
}
function saveDriver(){
  if(!driverId.value.trim()){ alert("Driver ID gerekli"); return; }
  localStorage.setItem("SEPET_DRIVER_ID", driverId.value.trim());
  localStorage.setItem("SEPET_DRIVER_NAME", name.value.trim());
  localStorage.setItem("SEPET_DRIVER_PHONE", phone.value.trim());

  // backend upsert
  fetch(BACKEND_URL,{method:"POST",body:JSON.stringify({
    action:"upsertDriver",
    driver_id: driverId.value.trim(),
    name: name.value.trim(),
    phone: phone.value.trim(),
    approved: "true"
  })}).catch(()=>{});

  status.textContent="Durum: Kaydedildi";
}

async function startSearch(){
  if(!service){ alert("Hizmet seÃ§"); return; }
  if(!driverId.value.trim()){ alert("Driver ID kaydet"); return; }
  stopSearch();
  status.textContent="Durum: Ä°ÅŸ aranÄ±yorâ€¦";

  timer=setInterval(async()=>{
    const r=await fetch(qs({action:"getOpenJob",service_type:service}));
    const j=await r.json().catch(()=>({}));
    if(j && j.job_id){
      found=j;
      showJob(j);
      stopSearch();
    }
  }, 3000);
}
function stopSearch(){
  if(timer){ clearInterval(timer); timer=null; }
}

function showJob(j){
  jobCard.style.display="block";
  jobInfo.textContent = `${j.service_type} â€¢ ${Number(j.distance_km||0).toFixed(2)} km`;
  money.textContent = `${Math.round(Number(j.price_brut||0))} / ${Math.round(Number(j.commission_amount||0))} / ${Math.round(Number(j.price_driver_net||0))} TL`;

  if(String(j.service_type)==="courier"){
    courierDetails.style.display="block";
    pkg.textContent=j.pkg_type||"â€”";
    note.textContent=j.content_note||"â€”";
    recv.textContent=j.recv_name||"â€”";
    rphone.textContent=j.recv_phone||"â€”";
  } else {
    courierDetails.style.display="none";
  }
  status.textContent="Durum: Yeni iÅŸ bulundu";
}

async function accept(){
  if(!found) return;
  await fetch(BACKEND_URL,{method:"POST",body:JSON.stringify({
    action:"assignJob", job_id: found.job_id, driver_id: driverId.value.trim()
  })});
  location.href = `track.html?role=driver&job=${encodeURIComponent(found.job_id)}&driver=${encodeURIComponent(driverId.value.trim())}`;
}
function reject(){
  found=null;
  jobCard.style.display="none";
  status.textContent="Durum: Reddedildi";
}

load();
</script>
</body>
</html>
