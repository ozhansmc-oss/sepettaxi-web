<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SepetTaxi – Driver</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0f0f0f;color:#fff}
header{height:56px;background:#000;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:bold}
header span{color:#f5c400}
.container{padding:16px;max-width:800px;margin:auto}

.card{background:#1b1b1b;border-radius:14px;padding:14px;margin-bottom:12px}
.label{font-size:12px;color:#aaa}
.value{font-size:14px;margin-top:4px}

input,button{width:100%;padding:12px;border-radius:10px;border:none;margin-top:8px}
input{background:#0f0f0f;color:#fff;border:1px solid #333}
button{background:#f5c400;color:#000;font-weight:bold;cursor:pointer}
button.secondary{background:#333;color:#fff}

.hidden{display:none}
.footer-note{text-align:center;color:#777;font-size:12px;margin:20px 0}
</style>
</head>

<body>
<header>Sepet<span>Taxi</span> Driver</header>

<div class="container">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <div class="label">Driver ID</div>
    <input id="driverIdInput" placeholder="driver_id">
    <button onclick="login()">Giriş Yap</button>
  </div>

  <!-- JOBS -->
  <div id="jobsArea" class="hidden"></div>

  <div class="footer-note">SepetTaxi • Driver Panel</div>
</div>

<script>
/************ CONFIG ************/
const API_URL = "https://script.google.com/macros/s/AKfycbxMLho3ZDX1R4EvZz-9MrOOq44807vH0MFd_X8ypSrYB6-vAQAR_dPa-lprAGkR1xsDxQ/exec";

/************ STATE ************/
let driverId = "";
let allJobs = [];
let activeJobId = null;
let locationTimer = null;

/************ LOGIN ************/
async function login(){
  driverId = driverIdInput.value.trim();
  if(!driverId){ alert("driver_id gir"); return; }

  const r = await fetch(API_URL+"?action=listDrivers");
  const drivers = await r.json();
  const me = drivers.find(d=>d.driver_id===driverId && d.status==="approved");
  if(!me){ alert("Onaylı driver bulunamadı"); return; }

  loginCard.classList.add("hidden");
  jobsArea.classList.remove("hidden");
  loadJobs();
}

/************ JOBS ************/
async function loadJobs(){
  const r = await fetch(API_URL+"?action=listJobs");
  allJobs = await r.json();

  const myJobs = allJobs.filter(j => j.driver_id === driverId);
  renderJobs(myJobs);

  const active = myJobs.find(j => j.status === "active");
  if(active){
    startLocationTracking(active.job_id);
  }else{
    stopLocationTracking();
  }
}

function renderJobs(list){
  jobsArea.innerHTML="";
  if(!list.length){
    jobsArea.innerHTML="<div class='card'>Aktif / atanmış iş yok</div>";
    return;
  }

  list.forEach(j=>{
    const c=document.createElement("div");
    c.className="card";
    c.innerHTML=`
      <b>${j.from_address}</b> → <b>${j.to_address}</b><br><br>

      <div class="label">Mesafe</div>
      <div class="value">${j.distance_km} km</div>

      <div class="label">Ücret</div>
      <div class="value">${j.final_price || j.price} TL</div>

      <div class="label">Status</div>
      <div class="value">${j.status}</div><br>

      ${actionButtons(j)}
    `;
    jobsArea.appendChild(c);
  });
}

function actionButtons(j){
  if(j.status==="assigned"){
    return `<button onclick="updateStatus('${j.job_id}','active')">İşi Başlat</button>`;
  }
  if(j.status==="active"){
    return `<button class="secondary" onclick="updateStatus('${j.job_id}','completed')">İşi Tamamla</button>`;
  }
  return "";
}

/************ STATUS ************/
async function updateStatus(jobId,status){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"updateStatus",job_id:jobId,status})
  });
  await loadJobs();
}

/************ LIVE LOCATION ************/
function startLocationTracking(jobId){
  if(activeJobId === jobId && locationTimer) return;

  activeJobId = jobId;
  stopLocationTracking();

  locationTimer = setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      fetch(API_URL,{
        method:"POST",
        body: JSON.stringify({
          action:"updateDriverLocation",
          job_id: activeJobId,
          driver_id: driverId,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        })
      });
    });
  }, 5000); // 5 sn
}

function stopLocationTracking(){
  if(locationTimer){
    clearInterval(locationTimer);
    locationTimer = null;
  }
  activeJobId = null;
}
</script>

</body>
</html>
