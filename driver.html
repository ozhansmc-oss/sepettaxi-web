<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi â€“ SÃ¼rÃ¼cÃ¼</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:Arial;background:#f4f4f4;padding:15px}
h2{margin-top:0}
.card{background:#fff;padding:12px;margin-bottom:10px;border-radius:8px}
button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer}
.accept{background:#27ae60;color:#fff}
.complete{background:#e67e22;color:#fff;margin-left:6px}
</style>
</head>

<body>

<h2>ğŸš• SÃ¼rÃ¼cÃ¼ â€“ Ä°ÅŸ Havuzu</h2>
<div id="status">BaÄŸlanÄ±yorâ€¦</div>
<div id="jobs"></div>

<script>
/* ===== AYAR ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbx8el5RvTxWIWZfAIdvhm8q8AYOejPPYRmzFbIoD5mCMUVhT-p2XCH3ixm-gXl23jKv/exec";
const DRIVER_ID = "DRV-001";

/* ===== JOB LÄ°STE ===== */
fetch(API_URL + "?action=listJobs")
  .then(r=>r.json())
  .then(d=>{
    document.getElementById("status").innerText="BaÄŸlandÄ± âœ“";
    renderJobs(d.jobs||[]);
  })
  .catch(()=>{
    document.getElementById("status").innerText="BaÄŸlantÄ± HATASI âŒ";
  });

function renderJobs(jobs){
  const box=document.getElementById("jobs");
  box.innerHTML="";
  if(!jobs.length){
    box.innerHTML="<div class='card'>Bekleyen iÅŸ yok</div>";
    return;
  }
  jobs.forEach(j=>{
    box.innerHTML+=`
      <div class="card">
        <b>${j.job_id}</b><br><br>
        <button class="accept" onclick="acceptJob('${j.job_id}')">Kabul</button>
        <button class="complete" onclick="completeJob('${j.job_id}')">Tamamla</button>
      </div>`;
  });
}

/* ===== GPS ===== */
let gpsTimer=null;

function startGPS(jobId){
  if(gpsTimer) clearInterval(gpsTimer);

  gpsTimer=setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      fetch(API_URL,{
        method:"POST",
        body:JSON.stringify({
          action:"updateDriverLocation",
          job_id:jobId,
          lat:pos.coords.latitude,
          lng:pos.coords.longitude
        })
      });
    });
  },3000);
}

/* ===== AKIÅ ===== */
function acceptJob(jobId){

  // ğŸ” KONUM Ä°ZNÄ° MUTLAKA BURADA SORULUR
  navigator.geolocation.getCurrentPosition(()=>{

    fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({
        action:"acceptJob",
        job_id:jobId,
        driver_id:DRIVER_ID
      })
    }).then(()=>{
      startGPS(jobId);
    });

  },()=>{
    alert("Konum izni verilmeden iÅŸ kabul edilemez");
  });
}

function completeJob(jobId){
  if(gpsTimer) clearInterval(gpsTimer);
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"completeJob",
      job_id:jobId
    })
  }).then(()=>location.reload());
}
</script>

</body>
</html>
