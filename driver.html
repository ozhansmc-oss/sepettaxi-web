<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Sürücü</title>
<meta name="theme-color" content="#f5c400">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
:root{--y:#f5c400}

.wrap{padding:16px;max-width:560px;margin:0 auto}
h1{font-size:18px;margin:6px 0 12px}
h2{font-size:15px;margin:0 0 8px}

.card{
background:#141416;
border:1px solid rgba(255,255,255,.12);
border-radius:20px;
padding:16px;
margin-bottom:12px
}

.job{
border:1px solid rgba(255,255,255,.12);
border-radius:16px;
padding:12px;
margin-bottom:10px
}
.job b{display:block;margin-bottom:4px}
.small{font-size:12px;color:rgba(255,255,255,.6)}

.btn{
width:100%;padding:12px;border-radius:14px;
border:0;font-weight:900;
background:linear-gradient(135deg,#f5c400,#ffd34d);
color:#1a1400;margin-top:8px
}
.btn.sec{
background:#222;color:#fff;border:1px solid rgba(255,255,255,.15)
}
.badge{
display:inline-block;padding:6px 10px;border-radius:999px;
font-size:11px;font-weight:900;
background:rgba(245,196,0,.15);border:1px solid rgba(245,196,0,.35)
}
</style>
</head>

<body>

<div class="wrap">

  <h1>Sürücü Paneli</h1>

  <!-- ACTIVE JOB -->
  <div class="card" id="activeCard" style="display:none">
    <h2>Aktif İş</h2>
    <div id="activeJob">—</div>
    <button class="btn sec" id="finishBtn">İşi Bitir</button>
  </div>

  <!-- JOB LIST -->
  <div class="card" id="jobsCard">
    <h2>Uygun İşler</h2>
    <div id="jobs"></div>
  </div>

</div>

<script>
/* ================= KİLİTLİ KURAL ================= */
// Kayıtlı sürücü yoksa → kayıt ekranına yönlendir
const DRIVER_ID = localStorage.getItem("sepettaxi_driver");
if(!DRIVER_ID){
  window.location.replace("driver-register.html");
}

/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbzXbm934CXIjTSL9RxmL8kkCjGERoeiQPDfY-OUk2Lexqqr_UvppoJ2yT0t562aJZdxRg/exec";

/* ================= STATE ================= */
let driverId = DRIVER_ID;
let heartbeatTimer = null;
let activeJobId = null;

/* ================= HELPERS ================= */
const $ = i => document.getElementById(i);

function postForm(d){
  return fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:Object.keys(d).map(k=>k+"="+encodeURIComponent(d[k])).join("&")
  }).then(r=>r.json());
}

/* ================= HEARTBEAT ================= */
function startHeartbeat(){
  sendHeartbeat();
  heartbeatTimer = setInterval(sendHeartbeat, 6000);
}

async function sendHeartbeat(){
  if(!driverId || !navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(async pos=>{
    const r = await postForm({
      action:"driverHeartbeat",
      driver_id:driverId,
      lat:pos.coords.latitude,
      lng:pos.coords.longitude,
      can_taxi:"true",
      can_courier:"true"
    });

    if(r && r.active_job_id){
      activeJobId = r.active_job_id;
      showActiveJob();
    }
  });
}

/* ================= JOB LIST ================= */
async function loadJobs(){
  if(!driverId) return;

  const r = await postForm({
    action:"listAvailableJobs",
    driver_id:driverId
  });

  renderJobs(r.jobs || []);
  setTimeout(loadJobs, 7000);
}

function renderJobs(list){
  const box = $("jobs");
  box.innerHTML = "";

  if(!list.length){
    box.innerHTML = `<div class="small">Uygun iş yok</div>`;
    return;
  }

  list.forEach(j=>{
    const d = document.createElement("div");
    d.className = "job";
    d.innerHTML = `
      <b>${j.service_type==="courier"?"Kurye":"Taksi"} · ${j.price||"—"} ₺</b>
      <div class="small">${j.from_address||""} → ${j.to_address||""}</div>
      <button class="btn sec">Kabul Et</button>
    `;
    d.querySelector("button").onclick = ()=> acceptJob(j.job_id);
    box.appendChild(d);
  });
}

/* ================= ACCEPT ================= */
async function acceptJob(jobId){
  const r = await postForm({
    action:"acceptJob",
    driver_id:driverId,
    job_id:jobId
  });

  if(r && r.ok){
    activeJobId = jobId;
    showActiveJob();
  }else{
    alert("İş alınamadı");
  }
}

/* ================= ACTIVE JOB ================= */
function showActiveJob(){
  $("jobsCard").style.display="none";
  $("activeCard").style.display="block";
  $("activeJob").innerHTML = `
    <div class="badge">Aktif</div>
    <div class="small" style="margin-top:6px">İş ID: ${activeJobId}</div>
  `;
}

$("finishBtn").onclick = async ()=>{
  if(!activeJobId) return;

  await postForm({
    action:"driverUpdateStatus",
    driver_id:driverId,
    job_id:activeJobId,
    status:"completed"
  });

  activeJobId = null;
  $("activeCard").style.display="none";
  $("jobsCard").style.display="block";
};

/* ================= BOOT ================= */
startHeartbeat();
loadJobs();
  <script>
/* =========================
   DRIVER HEARTBEAT (LIVE)
========================= */

let hbTimer = null;

function startDriverHeartbeat(driverId){
  if(hbTimer) return; // zaten çalışıyorsa tekrar başlatma

  hbTimer = setInterval(()=>{
    if(!navigator.geolocation) return;

    navigator.geolocation.getCurrentPosition(pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      const body = [
        "action=driverHeartbeat",
        "driver_id=" + encodeURIComponent(driverId),
        "lat=" + encodeURIComponent(lat),
        "lng=" + encodeURIComponent(lng)
      ].join("&");

      fetch(API,{
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body
      }).catch(()=>{});

    }, _=>{}, { enableHighAccuracy:true, maximumAge:0, timeout:5000 });

  }, 3000); // 3 sn
}

function stopDriverHeartbeat(){
  if(hbTimer){
    clearInterval(hbTimer);
    hbTimer = null;
  }
}

/* Sayfa kapanırken durdur */
window.addEventListener("beforeunload", stopDriverHeartbeat);
</script>

</body>
</html>
