<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Driver</title>

<script src="config.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}

.wrap{padding:14px;max-width:720px;margin:auto}
.card{background:#111;border-radius:18px;padding:16px;margin-bottom:14px;
  border:1px solid #222}
.hidden{display:none}

input{
  width:100%;padding:14px;border-radius:14px;border:0;
  background:#222;color:#fff;margin-top:8px
}
button{
  width:100%;padding:14px;border-radius:18px;border:0;
  font-weight:900;background:#f5c400;color:#000;
  margin-top:10px;cursor:pointer
}
button.ghost{
  background:#111;color:#fff;border:1px solid #222
}

.badge{
  display:inline-block;padding:4px 10px;border-radius:999px;
  font-size:12px;margin-top:6px
}
.pending{background:#444}
.available{background:#1f6f3f;color:#9fffc7}
.busy{background:#f39c12;color:#000}
.rejected{background:#6f1f1f;color:#ffb0b0}

.small{font-size:12px;color:#aaa}
.big{font-size:22px;font-weight:900}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> – Driver</header>

<div class="wrap">

<!-- LOGIN -->
<div class="card" id="loginCard">
  <b>Driver Girişi</b>
  <div class="small">Admin tarafından verilen Driver ID ile giriş yap</div>
  <input id="driverIdInput" placeholder="Driver ID (örn: DRV-123456)">
  <button onclick="login()">Giriş Yap</button>
  <div id="loginMsg" class="small" style="margin-top:8px"></div>
</div>

<!-- STATUS -->
<div class="card hidden" id="statusCard">
  <b>Sürücü Durumu</b>
  <div id="drvName" class="big">—</div>
  <div id="drvPhone" class="small">—</div>
  <div id="drvStatus" class="badge">—</div>

  <div id="statusMsg" class="small" style="margin-top:10px"></div>

  <button id="goOnlineBtn" class="hidden" onclick="goOnline()">MÜSAİTİM</button>
  <button id="logoutBtn" class="ghost" onclick="logout()">Çıkış</button>
</div>

<!-- ACTIVE JOB -->
<div class="card hidden" id="jobCard">
  <b>Aktif İş</b>
  <div id="jobRoute" class="small">—</div>
  <div id="jobStatus" class="badge busy">Aktif</div>

  <button id="startBtn" onclick="startJob()">YOLA ÇIKTIM</button>
  <button id="finishBtn" class="hidden" onclick="finishJob()">İŞİ BİTİR</button>
</div>

</div>

<script>
const DRIVER_KEY = "SEPT_driver";
let driver = null;
let activeJobId = null;
let liveTimer = null;

const $ = id => document.getElementById(id);

/* ================= LOGIN ================= */
async function login(){
  const id = $("driverIdInput").value.trim();
  if(!id){
    $("loginMsg").innerText="Driver ID gerekli.";
    return;
  }

  $("loginMsg").innerText="Kontrol ediliyor…";

  const res = await apiPost("adminListDrivers",{});
  if(!res.ok){
    $("loginMsg").innerText="Bağlantı hatası.";
    return;
  }

  const d = (res.drivers||[]).find(x=>x.driver_id===id);
  if(!d){
    $("loginMsg").innerText="Driver ID bulunamadı.";
    return;
  }

  driver = d;
  localStorage.setItem(DRIVER_KEY,JSON.stringify(driver));
  showDriver();
}

/* ================= UI ================= */
function showDriver(){
  $("loginCard").classList.add("hidden");
  $("statusCard").classList.remove("hidden");

  $("drvName").innerText = driver.name || "—";
  $("drvPhone").innerText = driver.phone || "—";

  renderStatus();
}

function renderStatus(){
  $("drvStatus").className = "badge " + driver.status;
  $("drvStatus").innerText = driver.status.toUpperCase();

  $("statusMsg").innerText = "";
  $("goOnlineBtn").classList.add("hidden");
  $("jobCard").classList.add("hidden");

  if(driver.status==="pending"){
    $("statusMsg").innerText =
      "Başvurun admin onayı bekliyor. Onaylandığında SMS alacaksın.";
  }

  if(driver.status==="rejected"){
    $("statusMsg").innerText =
      "Başvurun reddedildi. Detaylı bilgi için destekle iletişime geç.";
  }

  if(driver.status==="available"){
    $("statusMsg").innerText =
      "Müsait durumdasın. İş atandığında otomatik bildirileceksin.";
  }

  if(driver.status==="busy"){
    $("statusMsg").innerText =
      "Aktif işin var.";
    loadActiveJob();
  }
}

/* ================= STATUS ================= */
async function goOnline(){
  await apiPost("setDriverStatus",{
    driver_id:driver.driver_id,
    status:"available"
  });
  driver.status="available";
  renderStatus();
}

/* ================= JOB ================= */
async function loadActiveJob(){
  // MVP: aktif job bilgisi backend’den henüz gelmiyor
  // Bu alan, bir sonraki fazda bağlanacak
  $("jobCard").classList.remove("hidden");
  $("jobRoute").innerText="Aktif iş bilgisi yükleniyor…";
}

/* ================= ACTIONS ================= */
async function startJob(){
  $("startBtn").classList.add("hidden");
  $("finishBtn").classList.remove("hidden");
}

async function finishJob(){
  $("jobStatus").innerText="Tamamlandı";
  $("finishBtn").classList.add("hidden");
}

/* ================= API ================= */
async function apiPost(action,payload){
  payload.action = action;
  const r = await fetch(SEPT.BACKEND_URL,{
    method:"POST",
    body:JSON.stringify(payload)
  });
  return r.json();
}

/* ================= LOGOUT ================= */
function logout(){
  localStorage.removeItem(DRIVER_KEY);
  location.reload();
}

/* ================= AUTO ================= */
const saved = localStorage.getItem(DRIVER_KEY);
if(saved){
  driver = JSON.parse(saved);
  showDriver();
}
</script>

</body>
</html>
