<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Driver B2.1</title>
<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid #222}
header span{color:#f5c400;font-weight:900}
.wrap{max-width:720px;margin:0 auto;padding:16px}
.card{background:#121212;border:1px solid #222;border-radius:14px;padding:14px;margin-bottom:12px}
input,button{width:100%;padding:14px;border-radius:12px;border:0;font-size:15px}
input{background:#1b1b1b;color:#fff;margin-bottom:10px}
button{background:#f5c400;color:#000;font-weight:900}
.err{background:#3a0000;border:1px solid #ff4d4d;color:#ffb3b3;padding:10px;border-radius:10px;margin-bottom:12px;display:none}
.muted{color:#aaa;font-size:13px}
</style>
</head>
<body>

<header>Sepet<span>Taxi</span> – Driver B2.1</header>

<div class="wrap">
  <div id="err" class="err"></div>

  <div class="card">
    <div class="muted">Driver ID ile giriş (MVP)</div>
    <input id="driverId" placeholder="Driver ID">
    <button onclick="loadJobs()">İşi Getir</button>
    <div class="muted" style="margin-top:8px">
      Son güncelleme: <span id="last">—</span>
    </div>
  </div>

  <div id="jobs"></div>

  <div class="card muted">
    assigned = admin atadı • on_route = yolda • completed = bitti
  </div>
</div>

<script>
// ✅ TEK DOĞRU BACKEND
const BACKEND =
"https://script.google.com/macros/s/AKfycbxMLho3ZDX1R4EvZz-9MrOOq44807vH0MFd_X8ypSrYB6-vAQAR_dPa-lprAGkR1xsDxQ/exec";

// ================= UTIL =================
function showErr(msg){
  const e=document.getElementById("err");
  e.innerText=msg; e.style.display="block";
}
function hideErr(){ document.getElementById("err").style.display="none"; }

// ================= GPS =================
let gpsTimer = null;

function startGPS(jobId){
  if(!navigator.geolocation){
    alert("GPS desteklenmiyor");
    return;
  }
  if(gpsTimer) clearInterval(gpsTimer);

  gpsTimer = setInterval(()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      fetch(BACKEND,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({
          action:"updateLocation",   // ✅ BACKEND İLE AYNI
          job_id:jobId,
          lat:pos.coords.latitude,
          lng:pos.coords.longitude
        })
      });
    });
  },5000);
}

function stopGPS(){
  if(gpsTimer){
    clearInterval(gpsTimer);
    gpsTimer=null;
  }
}

// ================= JOBS =================
async function loadJobs(){
  hideErr();
  const driverId=document.getElementById("driverId").value.trim();
  if(!driverId) return showErr("Driver ID gir");

  try{
    const r=await fetch(`${BACKEND}?action=getJobs`);
    const jobs=await r.json();

    const mine=jobs.filter(j =>
      String(j.driver_id)===driverId &&
      (j.status==="assigned"||j.status==="on_route")
    );

    const box=document.getElementById("jobs");
    box.innerHTML="";

    if(mine.length===0){
      box.innerHTML='<div class="card muted">Aktif iş yok</div>';
      return;
    }

    mine.forEach(j=>{
      const c=document.createElement("div");
      c.className="card";
      c.innerHTML=`
        <b>${j.service_type}</b><br>
        <div class="muted">${j.from_address} → ${j.to_address}</div><br>
        <div>Durum: <b>${j.status}</b></div><br>
        ${
          j.status==="assigned"
          ? `<button onclick="accept('${j.job_id}')">Kabul Et</button>`
          : `<button onclick="complete('${j.job_id}')">Tamamlandı</button>`
        }
      `;
      box.appendChild(c);
    });

    document.getElementById("last").innerText=new Date().toLocaleTimeString();
  }catch(e){
    showErr("Failed to fetch");
  }
}

// ================= STATUS =================
async function accept(job_id){
  await fetch(BACKEND,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"updateStatus",
      job_id:job_id,
      status:"on_route"
    })
  });
  startGPS(job_id);
  loadJobs();
}

async function complete(job_id){
  await fetch(BACKEND,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"updateStatus",
      job_id:job_id,
      status:"completed"
    })
  });
  stopGPS();
  loadJobs();
}
</script>

</body>
</html>
