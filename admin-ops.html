<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Operasyon Özeti</title>
<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid #222}
header span{color:#f5c400;font-weight:900}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.card{background:#121212;border:1px solid #222;border-radius:14px;padding:16px}
.big{font-size:32px;font-weight:900}
.muted{color:#aaa}
table{width:100%;border-collapse:collapse;margin-top:10px}
td,th{border-top:1px solid #222;padding:8px;text-align:left}
</style>
</head>
<body>

<header>Sepet<span>Taxi</span> – Operasyon Özeti</header>

<div class="wrap">
  <div class="grid">
    <div class="card"><div class="muted">Bugün İş</div><div id="t1" class="big">—</div></div>
    <div class="card"><div class="muted">Aktif</div><div id="t2" class="big">—</div></div>
    <div class="card"><div class="muted">Bugün Tamamlanan</div><div id="t3" class="big">—</div></div>
    <div class="card"><div class="muted">Toplam Sürücü</div><div id="t4" class="big">—</div></div>
  </div>

  <div class="card">
    <b>Canlı İşler</b>
    <table id="activeTbl">
      <thead>
        <tr>
          <th>Job</th>
          <th>Sürücü</th>
          <th>Hizmet</th>
          <th>Başlangıç</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <b>Sürücü Başına (Bugün)</b>
    <table id="drvTbl">
      <thead>
        <tr>
          <th>Sürücü</th>
          <th>Tamamlanan</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* === BACKEND (GÖMÜLÜ) === */
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

async function load(){
  // OPS SUMMARY
  const s = await (await fetch(`${BACKEND}?action=getOpsSummary`)).json();

  t1.innerText = s.today_total ?? "—";
  t2.innerText = s.active_total ?? "—";
  t3.innerText = s.completed_today ?? "—";
  t4.innerText = s.drivers_total ?? "—";

  // ACTIVE JOBS
  const a = await (await fetch(`${BACKEND}?action=getActiveJobs`)).json();
  const tb = document.querySelector("#activeTbl tbody");
  tb.innerHTML = "";

  (a || []).forEach(j=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${j.job_id || "—"}</td>
      <td>${j.driver_id || "—"}</td>
      <td>${j.service_type || "—"}</td>
      <td>${j.active_at || "—"}</td>
    `;
    tb.appendChild(tr);
  });

  // COMPLETED BY DRIVER
  const db = document.querySelector("#drvTbl tbody");
  db.innerHTML = "";

  const byDrv = s.completed_by_driver || {};
  Object.keys(byDrv).forEach(k=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${k}</td><td>${byDrv[k]}</td>`;
    db.appendChild(tr);
  });
}

// ilk yükleme + otomatik yenileme
load();
setInterval(load, 15000);
</script>

</body>
</html>
