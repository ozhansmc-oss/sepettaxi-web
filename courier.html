<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport"
      content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Kurye</title>

<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="config.js"></script>
<script src="log.js"></script>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  font-family:Arial,Helvetica,sans-serif;
  background:#000;color:#fff;overflow:hidden
}
:root{
  --y:#f5c400;
  --panel:#0f0f0f;
  --line:#222;
}

/* HEADER */
header{
  height:56px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;
  border-bottom:1px solid var(--line);
}
header b span{color:var(--y)}
header .back{cursor:pointer;font-size:18px}

/* MAP */
#map{height:30vh}

/* FORM */
#content{
  height:calc(70vh - 90px);
  overflow:auto;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.card{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px
}
.input,select,textarea{
  width:100%;
  background:#000;
  border:1px solid var(--line);
  border-radius:14px;
  padding:12px;
  color:#fff;
  font-size:14px
}
textarea{resize:none;min-height:70px}
.label{font-size:12px;color:#aaa;margin-bottom:6px}

/* BOTTOM BAR */
#bottomBar{
  position:fixed;left:0;right:0;bottom:0;
  background:#000;
  border-top:1px solid var(--line);
  padding:10px 12px;
}
#summary{
  display:flex;justify-content:space-between;
  font-weight:900;margin-bottom:8px
}
#callBtn{
  width:100%;
  background:var(--y);color:#000;
  border-radius:16px;
  padding:14px;
  font-weight:900;
  text-align:center;
  cursor:pointer
}
.small{font-size:11px;color:#aaa;margin-top:6px}
</style>
</head>

<body>

<header>
  <div class="back" onclick="history.back()">←</div>
  <b>Sepet<span>Taxi</span> Kurye</b>
  <div style="width:20px"></div>
</header>

<div id="map"></div>

<div id="content">

  <div class="card">
    <div class="label">Gönderi Türü</div>
    <select id="pkgType">
      <option value="">Seçiniz</option>
      <option>Zarf</option>
      <option>Paket</option>
      <option>Koli</option>
      <option>Diğer</option>
    </select>
  </div>

  <div class="card">
    <div class="label">Gönderi İçeriği (Zorunlu)</div>
    <textarea id="contentNote"
      placeholder="Gönderinin içeriğini kısaca yazın"></textarea>
  </div>

  <div class="card">
    <div class="label">Alıcı Bilgileri</div>
    <input id="recvName" class="input" placeholder="Ad Soyad">
    <div style="height:8px"></div>
    <input id="recvPhone" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <div style="height:8px"></div>
    <textarea id="recvAddr" placeholder="Açık adres"></textarea>
  </div>

</div>

<div id="bottomBar">
  <div id="summary">
    <div><span id="km">—</span> km</div>
    <div><span id="price">—</span> TL</div>
  </div>
  <div id="callBtn">Kurye Çağır</div>
  <div class="small">
    Gönderi alındığında alıcıya bilgilendirme yapılır.
  </div>
</div>

<script>
/* ========== STATE ========== */
let map, from, to;
let km=0, price=0;

/* ========== INIT ========== */
const $=id=>document.getElementById(id);

const route = JSON.parse(localStorage.getItem("st_temp_route")||"{}");

if(!route.from||!route.to){
  alert("Rota bilgisi bulunamadı");
  history.back();
}

km=route.km||0;
price=route.price||0;

$("km").textContent=km;
$("price").textContent=price;

/* MAP */
map=L.map("map",{zoomControl:false});
L.tileLayer(
  "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
  {maxZoom:19}
).addTo(map);

from=L.marker([route.from.lat,route.from.lng]).addTo(map);
to=L.marker([route.to.lat,route.to.lng]).addTo(map);
map.fitBounds(L.latLngBounds([from.getLatLng(),to.getLatLng()]),{padding:[40,40]});

/* CALL */
$("callBtn").onclick=async()=>{
  const pkg=$("pkgType").value;
  const note=$("contentNote").value.trim();
  const rn=$("recvName").value.trim();
  const rp=$("recvPhone").value.replace(/\D/g,"");
  const ra=$("recvAddr").value.trim();

  if(!pkg||note.length<3||rn.length<2||!/^05\d{9}$/.test(rp)||ra.length<5){
    alert("Lütfen tüm alanları doğru doldurun");
    return;
  }

  const payload={
    action:"createJob",
    service_type:"courier",
    from_lat:route.from.lat,
    from_lng:route.from.lng,
    to_lat:route.to.lat,
    to_lng:route.to.lng,
    distance_km:Number(km),
    price_brut:Number(price),
    courier:{
      pkg_type:pkg,
      content_note:note,
      recv_name:rn,
      recv_phone:rp,
      recv_addr:ra
    }
  };

  $("callBtn").textContent="Gönderiliyor...";
  $("callBtn").style.pointerEvents="none";

  try{
    const r=await fetch(SEPT.BACKEND_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });
    const d=await r.json();
    if(!d||!d.ok||!d.job_id) throw "fail";
    location.href="track.html?job_id="+encodeURIComponent(d.job_id);
  }catch(e){
    alert("Kurye oluşturulamadı");
    $("callBtn").textContent="Kurye Çağır";
    $("callBtn").style.pointerEvents="auto";
  }
};

/* PWA */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("/service-worker.js");
}
</script>

</body>
</html>
