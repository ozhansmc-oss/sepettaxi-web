<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi ‚Äì Kurye</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
:root{--y:#f5c400;--line:#222;--muted:#9a9a9a}
header{height:56px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;border-bottom:1px solid var(--line)}
header span{color:var(--y)}
#map{height:30vh;border-bottom:1px solid var(--line)}
#panel{padding:12px;display:flex;flex-direction:column;gap:10px;padding-bottom:140px}
.card{background:#0f0f0f;border-radius:16px;padding:12px;border:1px solid rgba(255,255,255,.06)}
.card b{font-size:14px}
.input{width:100%;padding:12px;border-radius:12px;border:1px solid #1f1f1f;background:#000;color:#fff;font-size:13px}
.input::placeholder{color:#666}
.helper{font-size:11px;color:var(--muted);margin-top:6px}
.statRow{display:flex;gap:10px}
.stat{flex:1;background:#0b0b0b;border-radius:14px;padding:12px;text-align:center;border:1px solid rgba(255,255,255,.06)}
.stat .lbl{font-size:11px;color:#aaa}
.stat .val{font-size:18px;font-weight:900;margin-top:4px}
#ctaBar{position:fixed;left:0;right:0;bottom:0;padding:12px;background:linear-gradient(180deg,rgba(0,0,0,.6),#000);border-top:1px solid var(--line)}
#cta{border-radius:30px;padding:16px;text-align:center;font-weight:900}
#cta.disabled{background:#2a2a2a;color:#999}
#cta.enabled{background:var(--y);color:#000;cursor:pointer}
#searching{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:50}
#searching .small{font-size:12px;color:#888;margin-top:6px;text-align:center}
#toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#111;padding:10px 12px;border-radius:999px;font-size:12px;display:none;border:1px solid var(--line);z-index:1200}
</style>
</head>

<body>

<div id="toast"></div>
<header>Sepet<span>Taxi</span> ‚Äì Kurye</header>
<div id="map"></div>

<div id="panel">
  <div class="card">
    <b>üì¶ Paket Bilgisi</b>
    <input id="pkgType" class="input" placeholder="Paket T√ºr√º">
  </div>

  <div class="card">
    <b>üë§ Alƒ±cƒ± Bilgisi</b>
    <input id="rcvName" class="input" placeholder="Alƒ±cƒ± Adƒ±">
    <div style="height:8px"></div>
    <input id="rcvPhone" class="input" placeholder="05XXXXXXXXX" maxlength="11">
  </div>

  <div class="card">
    <b>üìç Adres</b>
    <input id="fromAddr" class="input" readonly placeholder="Nereden">
    <div style="height:8px"></div>
    <input id="toAddr" class="input" readonly placeholder="Nereye (haritaya dokun)">
  </div>

  <div class="statRow">
    <div class="stat"><div class="lbl">Mesafe</div><div id="dist" class="val">‚Äî</div></div>
    <div class="stat"><div class="lbl">√úcret</div><div id="price" class="val">‚Äî</div></div>
  </div>
</div>

<div id="ctaBar">
  <div id="cta" class="disabled">KURYECƒ∞ √áAƒûIR</div>
</div>

<div id="searching">
  <div style="font-size:18px;font-weight:900">Kurye aranƒ±yor‚Ä¶</div>
  <div class="small" id="searchInfo">Talebiniz olu≈üturuluyor</div>
</div>

<script>
/* ===== CONFIG (EMBED) ===== */
window.SEPT={
  BACKEND_URL:"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec",
  POLL_MS:3000
};

const BACKEND_URL=window.SEPT.BACKEND_URL;
const $=i=>document.getElementById(i);
let map,fromM,toM,routeLine;
let lastKm=0,lastPrice=0;

/* ===== MAP ===== */
map=L.map("map").setView([40.195,29.060],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

navigator.geolocation.getCurrentPosition(p=>{
  fromM=L.marker([p.coords.latitude,p.coords.longitude]).addTo(map);
  map.setView([p.coords.latitude,p.coords.longitude],15);
  reverse(p.coords.latitude,p.coords.longitude,$("fromAddr"));
});

map.on("click",async e=>{
  toM?toM.setLatLng(e.latlng):(toM=L.marker(e.latlng).addTo(map));
  await reverse(e.latlng.lat,e.latlng.lng,$("toAddr"));
  calcRoute();
});

/* ===== OSRM ===== */
async function calcRoute(){
  if(!fromM||!toM) return;
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const url=`https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
  const r=await fetch(url).then(r=>r.json());
  const rt=r.routes[0];

  lastKm=rt.distance/1000;
  lastPrice=Math.max(80,40+lastKm*15)|0;

  $("dist").innerText=lastKm.toFixed(2)+" km";
  $("price").innerText=lastPrice+" TL";

  const pts=rt.geometry.coordinates.map(c=>[c[1],c[0]]);
  if(routeLine) routeLine.setLatLngs(pts);
  else routeLine=L.polyline(pts,{color:"#f5c400",weight:5}).addTo(map);

  $("cta").className=valid()?"enabled":"disabled";
}

/* ===== FLOW ===== */
function valid(){
  return $("pkgType").value&&$("rcvName").value&&/^05\d{9}$/.test($("rcvPhone").value)&&fromM&&toM;
}

$("cta").onclick=async()=>{
  if(!valid())return;
  $("searching").style.display="flex";

  const a=fromM.getLatLng(),b=toM.getLatLng();
  await fetch(BACKEND_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"createJob",
      service_type:"courier",
      package_type:$("pkgType").value,
      receiver_name:$("rcvName").value,
      receiver_phone:$("rcvPhone").value,
      from_address:$("fromAddr").value,
      to_address:$("toAddr").value,
      pickup_lat:a.lat,pickup_lng:a.lng,
      dropoff_lat:b.lat,dropoff_lng:b.lng,
      distance_km:lastKm,price:lastPrice,final_price:lastPrice
    })
  });
};

async function reverse(lat,lng,input){
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
  const d=await r.json();
  if(d?.display_name)input.value=d.display_name;
}
</script>
</body>
</html>
