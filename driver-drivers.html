<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Sürücü Performansı</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#0b0b0b;color:#fff}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222
}
header span{color:#f5c400}
.wrap{padding:14px;max-width:1200px;margin:auto}

.card{
  background:#111;border-radius:16px;padding:14px;margin-bottom:14px;
  border:1px solid #222
}

table{
  width:100%;border-collapse:collapse;font-size:12px
}
th,td{
  padding:8px;border-bottom:1px solid #222;text-align:left
}
th{color:#f5c400;font-weight:900}
tr:hover{background:#151515}

.badge{
  padding:4px 8px;border-radius:999px;font-size:11px
}
.good{background:#1f6f3f;color:#9fffc7}
.mid{background:#6f5a1f;color:#ffe9a8}
.bad{background:#6f1f1f;color:#ffb0b0}

.small{font-size:11px;color:#aaa}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> – Sürücü Performansı</header>

<div class="wrap">

<div class="card">
  <b>Sürücü Bazlı Performans</b>
  <div style="overflow:auto;margin-top:10px">
    <table>
      <thead>
        <tr>
          <th>Sürücü</th>
          <th>Toplam İş</th>
          <th>Tamamlanan</th>
          <th>İptal</th>
          <th>Ort. Puan</th>
          <th>Ciro</th>
          <th>Skor</th>
          <th>Durum</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

load();

async function load(){
  const jobs = await fetch(`${BACKEND}?action=getJobs`).then(r=>r.json());

  const drivers = {};

  // 1️⃣ Topla
  jobs.forEach(j=>{
    if(!j.driver_id) return;
    if(!drivers[j.driver_id]){
      drivers[j.driver_id]={
        id:j.driver_id,
        total:0,done:0,cancel:0,
        ratingSum:0,ratingCnt:0,
        revenue:0
      };
    }
    const d = drivers[j.driver_id];
    d.total++;

    if(j.status==="completed"){
      d.done++;
      d.revenue+=Number(j.final_price||0);
    }
    if(j.status==="cancelled") d.cancel++;

    if(j.rating){
      d.ratingSum+=Number(j.rating);
      d.ratingCnt++;
    }
  });

  // max ciro
  const maxRev = Math.max(...Object.values(drivers).map(d=>d.revenue),1);

  rows.innerHTML="";

  // 2️⃣ Hesapla & yaz
  Object.values(drivers).forEach(d=>{
    const completion = d.total ? d.done/d.total : 0;
    const avgRating = d.ratingCnt ? d.ratingSum/d.ratingCnt : 0;

    const score =
      completion*50 +
      (avgRating/5)*30 +
      (d.revenue/maxRev)*20;

    let cls="mid", label="Normal";
    if(score>=75){ cls="good"; label="Öncelikli"; }
    if(score<40){ cls="bad"; label="Riskli"; }

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${d.id}</td>
      <td>${d.total}</td>
      <td>${d.done}</td>
      <td>${d.cancel}</td>
      <td>${avgRating.toFixed(2)}</td>
      <td>${d.revenue.toFixed(0)} TL</td>
      <td><b>${score.toFixed(0)}</b></td>
      <td><span class="badge ${cls}">${label}</span></td>
    `;
    rows.appendChild(tr);
  });
}
</script>

</body>
</html>
