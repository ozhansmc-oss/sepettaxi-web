<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SepetTaxi ‚Äì Hƒ±zlƒ± Hesaplama</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --black:#000;
  --white:#fff;
  --yellow:#FFD400;
  --gray:#f4f4f4;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:#fff;
  color:#000;
}

/* HEADER */
header{
  padding:14px 16px;
  font-size:20px;
  font-weight:800;
  border-bottom:1px solid #eee;
}
header span{color:var(--yellow)}

/* MAP */
#map{
  height:42vh;
  width:100%;
}

/* CONTENT */
.content{
  padding:16px;
  background:#fff;
  border-top-left-radius:22px;
  border-top-right-radius:22px;
  margin-top:-20px;
  position:relative;
  z-index:2;
}

/* CARD */
.card{
  background:#fff;
  border:1px solid #eee;
  border-radius:18px;
  padding:14px;
  margin-bottom:12px;
}

/* SERVICES */
.services{
  display:flex;
  gap:10px;
}
.service{
  flex:1;
  padding:14px;
  border-radius:14px;
  text-align:center;
  border:1px solid #ddd;
  cursor:pointer;
  font-weight:700;
}
.service.active{
  background:#000;
  color:#fff;
  border-color:#000;
}

/* ROW */
.row{
  display:flex;
  justify-content:space-between;
  margin-top:8px;
  font-size:15px;
  gap:10px;
}
.row div:last-child{
  text-align:right;
  max-width:65%;
}

/* PRICE */
.price{
  font-size:26px;
  font-weight:900;
}

/* BUTTON */
button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:18px;
  font-size:17px;
  font-weight:800;
  cursor:pointer;
  background:var(--yellow);
  color:#000;
}
button:disabled{
  background:#ccc;
  cursor:not-allowed;
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span></header>

<div id="map"></div>

<div class="content">

  <!-- SERVICES -->
  <div class="card">
    <div class="services">
      <div class="service active" data-service="taxi">Taksi</div>
      <div class="service" data-service="motor">Motor Kurye</div>
      <div class="service" data-service="carCourier">Ara√ßlƒ± Kurye</div>
    </div>
  </div>

  <!-- ADDRESSES -->
  <div class="card">
    <div class="row">
      <div>üìç Nereden</div>
      <div id="fromText">Konum alƒ±nƒ±yor‚Ä¶</div>
    </div>
    <div class="row">
      <div>üèÅ Nereye</div>
      <div id="toText">Haritadan se√ß</div>
    </div>
  </div>

  <!-- DISTANCE & PRICE -->
  <div class="card">
    <div class="row">
      <div>üìè Mesafe</div>
      <div id="distance">‚Äì</div>
    </div>
    <div class="row">
      <div>üí∞ √úcret</div>
      <div class="price" id="price">‚Äì</div>
    </div>
  </div>

  <button id="continueBtn" disabled>Devam Et</button>

</div>

<script>
/* ---------------- STATE ---------------- */
let pickup = null;
let dropoff = null;
let selectedService = "taxi";
let pickupMarker = null;
let dropoffMarker = null;

/* ---------------- MAP ---------------- */
const map = L.map('map');
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution:'¬© OpenStreetMap'
}).addTo(map);

/* ---------------- GEOLOCATION ---------------- */
map.locate({setView:true,maxZoom:16});

map.on('locationfound', async e=>{
  pickup = e.latlng;

  if(pickupMarker) map.removeLayer(pickupMarker);
  pickupMarker = L.marker(pickup).addTo(map);

  const address = await reverseGeocode(pickup.lat, pickup.lng);
  document.getElementById("fromText").innerText = address;
});

/* ---------------- MAP CLICK ---------------- */
map.on('click', async e=>{
  if(!pickup) return;

  dropoff = e.latlng;

  if(dropoffMarker) map.removeLayer(dropoffMarker);
  dropoffMarker = L.marker(dropoff).addTo(map);

  const address = await reverseGeocode(dropoff.lat, dropoff.lng);
  document.getElementById("toText").innerText = address;

  calculate();
});

/* ---------------- SERVICE SELECT ---------------- */
document.querySelectorAll('.service').forEach(el=>{
  el.onclick=()=>{
    document.querySelectorAll('.service').forEach(s=>s.classList.remove('active'));
    el.classList.add('active');
    selectedService = el.dataset.service;
    if(dropoff) calculate();
  }
});

/* ---------------- GEO FUNCTIONS ---------------- */
async function reverseGeocode(lat, lng){
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
  const res = await fetch(url,{headers:{"Accept-Language":"tr"}});
  const data = await res.json();
  return data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

function haversine(lat1, lon1, lat2, lon2){
  const R = 6371;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

/* ---------------- PRICE ---------------- */
function calculatePrice(service, km){
  const table={
    taxi:{base:40,perKm:18},
    motor:{base:35,perKm:12},
    carCourier:{base:50,perKm:15}
  };
  const p = table[service];
  return Math.round(p.base + (km * p.perKm));
}

/* ---------------- CALCULATE ---------------- */
function calculate(){
  const rawKm = haversine(
    pickup.lat,pickup.lng,
    dropoff.lat,dropoff.lng
  );

  const km = Number(rawKm.toFixed(1));
  const price = calculatePrice(selectedService, km);

  document.getElementById("distance").innerText = km + " km";
  document.getElementById("price").innerText = price + " ‚Ç∫";
  document.getElementById("continueBtn").disabled = false;
}
</script>

</body>
</html>
