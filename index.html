<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--line:#222;--muted:#9a9a9a;--card1:#141414;--card2:#0f0f0f}

/* LANDING */
#landing{position:fixed;inset:0;background:#000 url("assets/landing.png") center/cover no-repeat;z-index:1000}
#landing .overlay{position:absolute;inset:0;background:rgba(0,0,0,.65);display:flex;flex-direction:column;align-items:center;justify-content:center}
#landing h1{font-size:40px;margin:0 0 18px 0}
#landing span{color:var(--y)}
#landing button{background:var(--y);color:#000;border:0;border-radius:28px;padding:14px 46px;font-size:17px;font-weight:900;cursor:pointer}

/* HEADER */
header{
  position:relative;
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:900;
  border-bottom:1px solid var(--line)
}
header span{color:var(--y)}

#driverCtas{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  display:flex;
  gap:8px;
  align-items:center;
}
.pill{
  background:#0f0f0f;
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  opacity:.8;
  display:flex;
  gap:6px;
  align-items:center;
  white-space:nowrap;
}
.pill a{color:#aaa;text-decoration:none}
.pill:hover{opacity:1}

/* MAP & PANEL */
#app{display:none;height:100%}

/* Harita boÅŸ kalmasÄ±n: Leaflet init yoksa siyah boÅŸluk olur; initâ€™ten sonra gÃ¶rÃ¼nÃ¼r hale gelir */
#map{height:40vh; border-bottom:1px solid var(--line)}
@media(min-width:900px){
  #map{height:45vh}
}

#panel{height:calc(60vh - 56px);padding:10px;display:flex;flex-direction:column;gap:8px;padding-bottom:220px}
@media(min-width:900px){
  #panel{height:calc(55vh - 56px)}
}

.card{background:linear-gradient(180deg,var(--card1),var(--card2));border-radius:14px;padding:10px;border:1px solid rgba(255,255,255,.04)}
.cardTitle{display:flex;justify-content:space-between;align-items:center}
.badge{font-size:11px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px}

.serviceRow{display:flex;gap:8px}
.serviceBtn{
  flex:1;padding:11px;border-radius:12px;border:1px solid var(--line);
  background:#0b0b0b;color:#bdbdbd;cursor:pointer;user-select:none;
}
.serviceBtn.active{border-color:var(--y);color:#fff;background:rgba(245,196,0,.1)}

.input{width:100%;padding:11px;border-radius:12px;border:1px solid #1f1f1f;background:#000;color:#fff}
.helper{font-size:11px;color:var(--muted)}
#courierBox{display:none}

.stats{display:flex;gap:8px}
.stat{flex:1;background:#0b0b0b;border-radius:14px;padding:12px;text-align:center}
.stat .lbl{font-size:11px;color:#aaa}
.stat .val{font-size:18px;font-weight:900}

#stickyBar{position:fixed;left:0;right:0;bottom:0;padding:10px;background:#000;border-top:1px solid var(--line)}
#ctaBtn{border-radius:30px;padding:16px;text-align:center;font-weight:900;user-select:none}
#ctaBtn.enabled{background:var(--y);color:#000;cursor:pointer}
#ctaBtn.disabled{background:#2a2a2a;color:#999}

#searching{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:600}
#searching .spin{margin-top:10px;opacity:.8;font-size:12px;color:#bbb}

#toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#111;padding:10px 12px;border-radius:999px;font-size:12px;display:none;border:1px solid var(--line);z-index:1200}
</style>
</head>

<body>
<div id="toast"></div>

<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button id="startBtn" type="button">BAÅLA</button>
  </div>
</div>

<div id="app">
  <header>
    <div id="driverCtas">
      <div class="pill">ğŸš— <a href="driver.html">SÃ¼rÃ¼cÃ¼ mÃ¼sÃ¼n?</a></div>
      <div class="pill">ğŸ“ <a href="driver-register.html">SÃ¼rÃ¼cÃ¼ Ol</a></div>
    </div>
    Sepet<span>Taxi</span>
  </header>

  <div id="map"></div>

  <div id="panel">
    <div class="card">
      <div class="cardTitle">
        <b>Hizmet SeÃ§</b>
        <div id="regBadge" class="badge">KayÄ±t: Bekliyor</div>
      </div>
      <div class="serviceRow">
        <div id="btnTaxi" class="serviceBtn active">ğŸš• Taksi</div>
        <div id="btnCourier" class="serviceBtn">ğŸ“¦ Kurye</div>
      </div>
      <div id="helperText" class="helper">Haritada varÄ±ÅŸ noktasÄ±na dokun.</div>
    </div>

    <div id="taxiBox">
      <div class="card">
        <input id="fromInput" class="input" placeholder="Nereden (otomatik konum)" readonly>
        <div class="helper">BaÅŸlangÄ±Ã§ konumu otomatik alÄ±nÄ±r.</div>
      </div>

      <div class="card">
        <input id="toInput" class="input" placeholder="Nereye (haritadan seÃ§)" readonly>
        <div class="helper">VarÄ±ÅŸ iÃ§in haritaya dokun.</div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="lbl">Mesafe</div>
          <div id="distVal" class="val">â€”</div>
        </div>
        <div class="stat">
          <div class="lbl">Ãœcret</div>
          <div id="priceVal" class="val">â€”</div>
        </div>
      </div>
    </div>

    <div id="courierBox">
      <div class="card">
        <b>Kurye</b>
        <div class="helper">Kurye akÄ±ÅŸÄ± ayrÄ± sayfada Ã§alÄ±ÅŸÄ±r. Devam iÃ§in aÅŸaÄŸÄ±dan seÃ§.</div>
      </div>
    </div>
  </div>
</div>

<div id="stickyBar">
  <div id="ctaBtn" class="disabled">TAKSÄ° Ã‡AÄIR</div>
</div>

<div id="searching">
  <div><b>SÃ¼rÃ¼cÃ¼ aranÄ±yorâ€¦</b></div>
  <div class="spin">Atama bekleniyor</div>
</div>

<!-- Global config -->
<script src="config.js"></script>

<script>
/* ====== STATE ====== */
let map, userMarker, destMarker, routeLine;
let userLatLng = null;
let destLatLng = null;
let service = "taxi"; // taxi | courier

const $ = (id)=>document.getElementById(id);

function toast(msg, ms=2200){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>{ t.style.display="none"; }, ms);
}

/* ====== UI HELPERS ====== */
function setCTAEnabled(on){
  const cta = $("ctaBtn");
  cta.className = on ? "enabled" : "disabled";
}
function setCTALabel(){
  $("ctaBtn").textContent = (service==="taxi") ? "TAKSÄ° Ã‡AÄIR" : "KURYE DEVAM";
}
function setService(next){
  service = next;

  $("btnTaxi").classList.toggle("active", service==="taxi");
  $("btnCourier").classList.toggle("active", service==="courier");

  $("taxiBox").style.display   = (service==="taxi") ? "block" : "none";
  $("courierBox").style.display= (service==="courier") ? "block" : "none";

  $("helperText").textContent = (service==="taxi")
    ? "Haritada varÄ±ÅŸ noktasÄ±na dokun."
    : "Kurye akÄ±ÅŸÄ± iÃ§in devam et.";

  setCTALabel();

  // Taxi: hedef yoksa disable
  if(service==="taxi"){
    setCTAEnabled(!!(userLatLng && destLatLng));
  }else{
    setCTAEnabled(true);
  }
}

/* ====== MAP INIT ====== */
function initMap(){
  if(map) return;

  map = L.map("map", { zoomControl:true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  // Default view (Bursa civarÄ± fallback)
  map.setView([40.195, 29.060], 12);

  // Map click = destination select (Taxi)
  map.on("click", (e)=>{
    if(service!=="taxi") return;
    destLatLng = e.latlng;
    if(!destMarker){
      destMarker = L.marker(destLatLng).addTo(map);
    }else{
      destMarker.setLatLng(destLatLng);
    }
    $("toInput").value = `${destLatLng.lat.toFixed(5)}, ${destLatLng.lng.toFixed(5)}`;
    computeDistanceAndPrice();
  });
}

function fitIfReady(){
  if(!map) return;
  if(userLatLng && destLatLng){
    const bounds = L.latLngBounds([userLatLng, destLatLng]);
    map.fitBounds(bounds.pad(0.25));
  }else if(userLatLng){
    map.setView(userLatLng, 15);
  }
}

/* ====== GEOLOCATION ====== */
function getLocation(){
  if(!navigator.geolocation){
    toast("TarayÄ±cÄ± konum desteÄŸi yok.");
    return;
  }
  toast("Konum alÄ±nÄ±yorâ€¦");

  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
      $("fromInput").value = `${userLatLng.lat.toFixed(5)}, ${userLatLng.lng.toFixed(5)}`;

      if(!userMarker){
        userMarker = L.marker(userLatLng).addTo(map);
      }else{
        userMarker.setLatLng(userLatLng);
      }
      $("regBadge").textContent = "KayÄ±t: HazÄ±r";
      toast("Konum alÄ±ndÄ±. VarÄ±ÅŸ iÃ§in haritaya dokun.");

      fitIfReady();
    },
    (err)=>{
      console.warn(err);
      $("regBadge").textContent = "KayÄ±t: Bekliyor";
      toast("Konum izni verilmedi veya alÄ±namadÄ±.");
      // fallback view zaten ayarlÄ±
    },
    { enableHighAccuracy:true, timeout:12000, maximumAge:8000 }
  );
}

/* ====== DISTANCE & PRICE (demo hesap) ====== */
function haversineKm(a,b){
  const R = 6371;
  const dLat = (b.lat-a.lat) * Math.PI/180;
  const dLon = (b.lng-a.lng) * Math.PI/180;
  const lat1 = a.lat*Math.PI/180, lat2 = b.lat*Math.PI/180;
  const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

function computeDistanceAndPrice(){
  if(!(userLatLng && destLatLng)) return;

  // Ã§izgi (demo route)
  if(routeLine) routeLine.remove();
  routeLine = L.polyline([userLatLng, destLatLng]).addTo(map);

  const km = haversineKm(userLatLng, destLatLng);
  const kmRounded = Math.max(0.1, km);

  $("distVal").textContent = `${kmRounded.toFixed(1)} km`;

  // Kilitli algoritmayÄ± backend dosyasÄ± gelince aynen geri koyacaÄŸÄ±z.
  // Åimdilik sadece UIâ€™nÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶stermek iÃ§in demo fiyat:
  const base = 35;          // aÃ§Ä±lÄ±ÅŸ
  const perKm = 18;         // km baÅŸÄ±
  const price = Math.round(base + kmRounded * perKm);

  $("priceVal").textContent = `${price} â‚º`;
  setCTAEnabled(true);
  fitIfReady();
}

/* ====== CTA ACTIONS ====== */
function onCTA(){
  if(service==="courier"){
    // Kurye akÄ±ÅŸÄ± ayrÄ± sayfadaysa doÄŸrudan yÃ¶nlendir
    window.location.href = "courier.html";
    return;
  }

  // Taxi: hedef yoksa uyar
  if(!(userLatLng && destLatLng)){
    toast("LÃ¼tfen varÄ±ÅŸ noktasÄ± seÃ§in.");
    return;
  }

  // Backend createJob wiring: backend .gs gelince burada net endpointâ€™e baÄŸlayacaÄŸÄ±z.
  // Åimdilik â€œaranÄ±yorâ€ overlayâ€™i UI testi iÃ§in aÃ§Ä±lÄ±r.
  $("searching").style.display = "flex";
  setTimeout(()=>{ $("searching").style.display = "none"; toast("Backend baÄŸlandÄ±ktan sonra burada atama baÅŸlayacak."); }, 1500);
}

/* ====== START ====== */
function start(){
  $("landing").style.display = "none";
  $("app").style.display = "block";

  initMap();

  // display:none -> block sonrasÄ± Leaflet size fix
  setTimeout(()=>{ map.invalidateSize(); }, 50);

  // Konum al
  getLocation();

  // default service
  setService("taxi");
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("startBtn").addEventListener("click", start);
  $("btnTaxi").addEventListener("click", ()=>setService("taxi"));
  $("btnCourier").addEventListener("click", ()=>setService("courier"));
  $("ctaBtn").addEventListener("click", onCTA);
});
</script>

</body>
</html>
