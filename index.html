<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  background:#050506;color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  overflow:hidden
}
:root{
  --y:#f5c400;
  --panel:#0f0f10;
  --card:#141416;
  --line:rgba(255,255,255,.1);
  --mut:rgba(255,255,255,.6)
}

/* TOPBAR */
#topbar{
  position:fixed;top:0;left:0;right:0;height:56px;
  background:#000;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;z-index:50;
  border-bottom:1px solid var(--line)
}
.iconBtn{
  width:40px;height:40px;border-radius:12px;
  border:1px solid var(--line);
  background:#111;color:#fff;
  display:grid;place-items:center
}
#brand{font-weight:900}

/* MAP */
#mapWrap{
  position:fixed;top:56px;left:0;right:0;
  height:50vh;background:#000;z-index:1
}
#map{width:100%;height:100%}
.leaflet-control-zoom,.leaflet-control-attribution{display:none}

/* SHEET */
#sheet{
  position:fixed;left:0;right:0;bottom:0;
  height:95vh;background:var(--panel);
  border-radius:20px 20px 0 0;
  transform:translateY(32vh);
  transition:.3s cubic-bezier(.22,.61,.36,1);
  z-index:10
}
#sheet.collapsed{transform:translateY(58vh)}
#sheet.expanded{transform:translateY(6vh)}
.handle{
  width:38px;height:4px;border-radius:99px;
  background:#666;margin:10px auto
}
#content{padding:10px 14px 20px}

/* CARDS */
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:12px;margin-bottom:10px
}
.row{display:flex;gap:10px}
.row>*{flex:1}
.label{font-size:12px;color:var(--mut);margin-bottom:6px}
input{
  width:100%;padding:12px;border-radius:14px;
  border:1px solid var(--line);
  background:#000;color:#fff
}
button{
  width:100%;padding:14px;border-radius:16px;
  border:0;font-weight:900
}
.primary{background:var(--y);color:#000}
.ghost{
  background:#111;color:#fff;
  border:1px solid var(--line)
}
.hidden{display:none}

/* PRICE */
#priceBox{
  text-align:center;
  font-size:26px;font-weight:900;
  padding:14px
}
#priceBox span{display:block;font-size:13px;color:var(--mut)}
</style>
</head>

<body>

<div id="topbar">
  <div class="iconBtn">‚ò∞</div>
  <div id="brand">‚óè Sepet<span style="color:var(--y)">Taxi</span></div>
  <div class="iconBtn">üîî</div>
</div>

<div id="mapWrap"><div id="map"></div></div>

<div id="sheet">
  <div class="handle"></div>
  <div id="content">

    <!-- SERVICE -->
    <div class="card row">
      <button id="svcTaxi" class="primary">Taksi</button>
      <button id="svcCourier" class="ghost">Kurye</button>
    </div>

    <!-- ADDRESS -->
    <div class="card">
      <div class="label">Adresler</div>
      <div class="row">
        <input id="fromAddr" placeholder="Nereden" readonly>
        <input id="toAddr" placeholder="Nereye" readonly>
      </div>
    </div>

    <!-- PRICE (KAYIT SONRASI) -->
    <div id="priceCard" class="card hidden">
      <div id="priceBox">
        <span>Mesafe</span>
        <div id="kmText">‚Äî</div>
        <span style="margin-top:8px">Tahmini √úcret</span>
        <div id="priceText">‚Äî</div>
      </div>
    </div>

    <!-- REGISTER -->
    <div id="registerCard" class="card hidden">
      <div class="label">Zorunlu Kayƒ±t</div>
      <div class="row">
        <input id="fname" placeholder="Ad">
        <input id="lname" placeholder="Soyad">
      </div>
      <input id="phone" placeholder="Telefon" style="margin-top:10px">
    </div>

    <button id="cta" class="primary" disabled>Devam Et</button>

  </div>
</div>

<script>
/* ===== CANLI API ===== */
const API = "https://script.google.com/macros/s/AKfycbwXKzBcvA5xRpvGqJSWCq7vzrOGxG1KplHq1vCHTb4j5auQ1G0ySNSfn9der1um4MsMug/exec";

/* MAP */
const map = L.map("map",{zoomControl:false}).setView([40.195,29.06],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* STATE */
let pick="from", from={}, to={}, registered=false;
let service="taxi", km=0, price=0;

/* UI */
const cta=document.getElementById("cta");
const registerCard=document.getElementById("registerCard");
const priceCard=document.getElementById("priceCard");

/* GEO */
function haversine(a,b){
  const R=6371,dLat=(b.lat-a.lat)*Math.PI/180,dLng=(b.lng-a.lng)*Math.PI/180;
  const s1=Math.sin(dLat/2),s2=Math.sin(dLng/2);
  return 2*R*Math.asin(Math.sqrt(s1*s1+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2));
}
function estimate(km){
  return service==="taxi"? Math.round(55+km*18) : Math.round(65+km*22);
}

/* MAP CLICK */
map.on("click",async e=>{
  const lat=e.latlng.lat,lng=e.latlng.lng;
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
  const j=await r.json();
  if(pick==="from"){
    from={lat,lng,addr:j.display_name};
    fromAddr.value=j.display_name; pick="to";
  }else{
    to={lat,lng,addr:j.display_name};
    toAddr.value=j.display_name; pick="from";
  }
  if(from.lat&&to.lat) cta.disabled=false;
});

/* CTA FLOW */
cta.onclick=async()=>{
  if(!registered){
    sheet.classList.add("expanded");
    registerCard.classList.remove("hidden");
    cta.textContent="Kaydƒ± Tamamla";
    registered=true;
    return;
  }
  if(priceCard.classList.contains("hidden")){
    km=haversine(from,to);
    price=estimate(km);
    kmText.textContent=km.toFixed(1)+" km";
    priceText.textContent=price+" ‚Ç∫";
    priceCard.classList.remove("hidden");
    cta.textContent=service==="taxi"?"Taksi √áaƒüƒ±r":"Kurye √áaƒüƒ±r";
    return;
  }

  /* CREATE JOB */
  const payload={
    action:"createJob",
    service_type:service,
    customer_first:fname.value,
    customer_last:lname.value,
    customer_phone:phone.value,
    from_address:from.addr,
    to_address:to.addr,
    pickup_lat:from.lat,
    pickup_lng:from.lng,
    dropoff_lat:to.lat,
    dropoff_lng:to.lng,
    distance_km:km,
    price:price
  };

  const res=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const out=await res.json();
  const jobId=out.job_id||out.id;
  if(jobId) location.href="track.html?job_id="+jobId;
};
</script>

</body>
</html>
