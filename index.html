<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui;background:#f5f6fa}
.app{height:100vh;display:flex;flex-direction:column}
header{height:56px;display:flex;align-items:center;padding:0 16px;font-weight:700;background:#fff;border-bottom:1px solid #ddd}
#map{height:40vh;min-height:220px}
.cards{flex:1;padding:12px;display:flex;flex-direction:column;gap:10px}
.card{background:#fff;border-radius:14px;padding:12px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
.row{display:flex;gap:8px}
.btn{flex:1;padding:12px;border-radius:12px;border:none;font-weight:600;cursor:pointer}
.btn.primary{background:#000;color:#fff}
.btn.light{background:#f0f0f0}
.btn.active{background:#000;color:#fff}
input{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd}
.notice{position:absolute;top:70px;left:50%;transform:translateX(-50%);background:#fff;padding:12px 16px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);z-index:1000}
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:2000}
.modal{background:#fff;border-radius:16px;padding:16px;width:90%;max-width:360px}
</style>
</head>

<body>
<div class="app">

<header>SepetTaxi</header>
<div id="map"></div>

<div id="locationNotice" class="notice">
  Konum izni gerekli
  <button class="btn light" onclick="acceptLocation()">AnladÄ±m</button>
</div>

<div class="cards">

  <div class="card">
    <b>Hizmet</b>
    <div class="row" style="margin-top:8px">
      <button class="btn light" id="btnTaxi" onclick="selectService('taxi')">ðŸš• Taxi</button>
      <button class="btn light" id="btnCourier" onclick="selectService('courier')">ðŸ“¦ Kurye</button>
    </div>
  </div>

  <div class="card"><input id="fromInput" placeholder="Nereden"></div>
  <div class="card"><input id="toInput" placeholder="Nereye"></div>

  <div class="card" id="priceBox" style="font-weight:700">
    Mesafe: â€” | Ãœcret: â€”
  </div>

  <button class="btn primary" id="callBtn" disabled onclick="createJob()">Ã‡aÄŸÄ±r</button>
</div>
</div>

<!-- ZORUNLU KAYIT -->
<div class="modal-bg" id="registerModal">
  <div class="modal">
    <h3>KayÄ±t Ol</h3>
    <input id="regName" placeholder="Ad Soyad">
    <input id="regPhone" placeholder="Telefon" style="margin-top:8px">
    <button class="btn primary" style="margin-top:12px" onclick="saveUser()">Devam Et</button>
  </div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbz6HVW0LeOgkXr9cihJsf3MVu7RL5rj74k_Zl9WeW9PXCyYWl_FqxsVF28OidgI2gGg/exec";

/* MAP */
const map = L.map("map",{zoomControl:false});
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
map.setView([39.92,32.85],13);

/* STATE */
let user = JSON.parse(localStorage.getItem("sepettaxi_user")||"null");
let service = null;
let pickup=null, dropoff=null;
let pMarker,dMarker,routeLine;
let distanceKm = 0;

/* LOCATION */
function acceptLocation(){
  document.getElementById("locationNotice").remove();
  navigator.geolocation.getCurrentPosition(pos=>{
    pickup={lat:pos.coords.latitude,lng:pos.coords.longitude};
    map.setView([pickup.lat,pickup.lng],15);
    pMarker=L.marker([pickup.lat,pickup.lng]).addTo(map);
    fillAddress(pickup.lat,pickup.lng,"fromInput");
    updateCallState();
  });
}

/* MAP CLICK */
map.on("click",e=>{
  const {lat,lng}=e.latlng;
  if(!pickup){
    pickup={lat,lng};
    if(pMarker)map.removeLayer(pMarker);
    pMarker=L.marker([lat,lng]).addTo(map);
    fillAddress(lat,lng,"fromInput");
  }else if(!dropoff){
    dropoff={lat,lng};
    if(dMarker)map.removeLayer(dMarker);
    dMarker=L.marker([lat,lng]).addTo(map);
    fillAddress(lat,lng,"toInput");
    calculateRoute();
  }else{
    resetRoute();
    pickup={lat,lng};
    pMarker=L.marker([lat,lng]).addTo(map);
    fillAddress(lat,lng,"fromInput");
  }
  updateCallState();
});

/* ADDRESS */
function fillAddress(lat,lng,id){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
    .then(r=>r.json())
    .then(d=>document.getElementById(id).value=d.display_name);
}

/* ROUTE + PRICE */
function calculateRoute(){
  const url=`https://router.project-osrm.org/route/v1/driving/${pickup.lng},${pickup.lat};${dropoff.lng},${dropoff.lat}?overview=full&geometries=geojson`;
  fetch(url).then(r=>r.json()).then(d=>{
    const route=d.routes[0];
    distanceKm=(route.distance/1000).toFixed(2);
    if(routeLine)map.removeLayer(routeLine);
    routeLine=L.geoJSON(route.geometry).addTo(map);
    const price=Math.round(50+distanceKm*15);
    priceBox.innerHTML=`Mesafe: ${distanceKm} km | Ãœcret: ${price} â‚º`;
  });
}

/* SERVICE */
function selectService(s){
  service=s;
  btnTaxi.classList.remove("active");
  btnCourier.classList.remove("active");
  if(s==="taxi")btnTaxi.classList.add("active");
  if(s==="courier")btnCourier.classList.add("active");

  if(!user){
    registerModal.style.display="flex";
  }
  updateCallState();
}

/* REGISTER */
function saveUser(){
  if(!regName.value||!regPhone.value)return alert("Ad ve telefon zorunlu");
  user={name:regName.value,phone:regPhone.value};
  localStorage.setItem("sepettaxi_user",JSON.stringify(user));
  registerModal.style.display="none";
  updateCallState();
}

/* CALL STATE */
function updateCallState(){
  callBtn.disabled = !(service && pickup && dropoff && user);
}

/* CREATE JOB */
function createJob(){
  const q=new URLSearchParams({
    path:"createJob",
    service_type:service,
    user_name:user.name,
    user_phone:user.phone,
    pickup_lat:pickup.lat,
    pickup_lng:pickup.lng,
    pickup_address:fromInput.value,
    dropoff_address:toInput.value
  });
  fetch(`${API_URL}?${q}`, { mode: "no-cors" });
alert("Talep alÄ±ndÄ±");
}

/* RESET */
function resetRoute(){
  pickup=null;dropoff=null;
  if(pMarker)map.removeLayer(pMarker);
  if(dMarker)map.removeLayer(dMarker);
  if(routeLine)map.removeLayer(routeLine);
  priceBox.innerHTML="Mesafe: â€” | Ãœcret: â€”";
}
</script>
</body>
</html>
