<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>SepetTaxi</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2e;
      --card2:#101f38;
      --text:#e8eefc;
      --muted:#9fb2d7;
      --line:rgba(255,255,255,.08);
      --brand:#2dd4bf;
      --brand2:#60a5fa;
      --warn:#fbbf24;
      --danger:#fb7185;
      --ok:#34d399;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:20px;
      --max:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 20% -10%, rgba(96,165,250,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(45,212,191,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:18px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 0 14px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: var(--shadow);
      display:grid; place-items:center; font-weight:800; color:#071019;
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px;}
    .brand .sub{margin:0; font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
      user-select:none;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.15s transform ease, .15s background ease, .15s border-color ease;
      font-weight:600;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.14);}
    .btn.primary{
      background: linear-gradient(135deg, rgba(45,212,191,.22), rgba(96,165,250,.18));
      border-color: rgba(96,165,250,.25);
    }
    .btn.danger{border-color: rgba(251,113,133,.25); background: rgba(251,113,133,.08);}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:stretch;
    }
    .banner{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: var(--radius2);
      padding:16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .banner::after{
      content:"";
      position:absolute; inset:-60px -40px auto auto;
      width:260px; height:260px;
      background: radial-gradient(circle at 30% 30%, rgba(45,212,191,.35), transparent 62%);
      filter: blur(1px);
      transform: rotate(10deg);
      pointer-events:none;
    }
    .banner h2{margin:0 0 6px; font-size:20px;}
    .banner p{margin:0; color:var(--muted); line-height:1.5; font-size:13px;}
    .banner .row{
      display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; align-items:center;
    }
    .hint{
      font-size:12px; color:var(--muted);
      border-left:3px solid rgba(45,212,191,.55);
      padding-left:10px;
    }
    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding:14px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 120px;
    }
    .panel h3{margin:0; font-size:14px;}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color: rgba(45,212,191,.35);
      background: rgba(45,212,191,.10);
    }

    /* MAP BELOW BANNER */
    .mapWrap{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius: var(--radius2);
      overflow:hidden;
      background: rgba(255,255,255,.02);
      box-shadow: var(--shadow);
    }
    #map{width:100%; height: 46vh; min-height: 340px;}
    .mapBar{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .mapBar .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .kv{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      font-size:12px; color:var(--muted);
      max-width:100%;
    }
    .kv b{color:var(--text); font-weight:800}
    .services{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding:14px;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 180px;
    }
    .card .title{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .badge{
      font-size:11px; padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(255,255,255,.02);
      white-space:nowrap;
    }
    .card h4{margin:0; font-size:15px;}
    .card p{margin:0; color:var(--muted); font-size:12px; line-height:1.5}
    .form{
      display:grid; gap:10px;
    }
    .row2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    label{font-size:12px; color:var(--muted); display:block; margin:0 0 6px;}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(6,10,20,.55);
      color: var(--text);
      outline:none;
    }
    textarea{min-height: 76px; resize: vertical;}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(96,165,250,.35);
      box-shadow: 0 0 0 3px rgba(96,165,250,.12);
    }
    .info{
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:10px 12px;
      color: var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .info strong{color:var(--text)}
    .hr{height:1px; background: var(--line); margin:8px 0;}
    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      max-width: 520px;
      z-index: 9999;
      display:grid; gap:10px;
    }
    .toast .t{
      border:1px solid var(--line);
      background: rgba(10,18,34,.92);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: var(--shadow);
      color: var(--text);
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
    }
    .t .msg{font-size:13px; line-height:1.4}
    .t .x{cursor:pointer; opacity:.8}
    .t.ok{border-color: rgba(52,211,153,.25)}
    .t.warn{border-color: rgba(251,191,36,.25)}
    .t.bad{border-color: rgba(251,113,133,.28)}
    .modal{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index: 99999;
    }
    .modal.on{display:flex;}
    .modal .box{
      width:min(720px, 100%);
      border:1px solid var(--line);
      background: rgba(12,18,35,.92);
      backdrop-filter: blur(12px);
      border-radius: 22px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .modal .boxHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 6px 6px 12px;
    }
    .modal .boxHeader h3{margin:0; font-size:16px;}
    .modal .boxBody{padding: 0 6px 8px;}
    .checkbox{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12px;
      line-height:1.45;
    }
    .checkbox input{width:auto; margin-top:2px;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .footer{
      margin:16px 0 6px;
      color: var(--muted);
      font-size:12px;
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .linkBtn{
      background: transparent;
      border: none;
      color: var(--muted);
      cursor:pointer;
      padding:0;
      text-decoration: underline;
    }

    /* Responsive */
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
      .services{grid-template-columns: 1fr;}
      #map{height: 44vh; min-height: 320px;}
    }
    @media (max-width: 520px){
      .row2,.row3{grid-template-columns: 1fr;}
      .logo{width:40px;height:40px;}
      .banner h2{font-size:18px;}
      #map{height: 42vh; min-height: 300px;}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- TOP -->
    <div class="topbar">
      <div class="brand">
        <div class="logo" title="SepetTaxi">ST</div>
        <div>
          <h1>SepetTaxi</h1>
          <p class="sub">Taksi â€¢ Kurye â€¢ HavalimanÄ± Transferi</p>
        </div>
      </div>

      <div class="actions">
        <div class="pill" id="pillUser">ğŸ‘¤ <span class="muted">KayÄ±tlÄ± deÄŸil</span></div>
        <button class="btn" id="btnOpenRegister">KayÄ±t / Profil</button>
        <button class="btn primary" id="btnGetGPS">Konum Al</button>
      </div>
    </div>

    <!-- BANNER + SIDE PANEL -->
    <div class="grid">
      <div class="banner">
        <h2>Tek uygulamada 3 hizmet</h2>
        <p>
          SepetTaxi ile <b>Taksi</b>, <b>Kurye</b> ve <b>HavalimanÄ± Transferi</b> Ã§aÄŸrÄ±larÄ±nÄ± hÄ±zlÄ±ca oluÅŸtur.
          Konumu GPS ile al, istersen haritadan seÃ§, mesafe ve Ã¼cret hesabÄ±nÄ± anÄ±nda gÃ¶r.
        </p>
        <div class="row">
          <div class="pill">ğŸ“ GPS + Haritadan seÃ§im</div>
          <div class="pill">ğŸ“¦ Motorlu / AraÃ§lÄ± kurye</div>
          <div class="pill">âœˆï¸ Transfer (Binek / VIP / MinibÃ¼s)</div>
        </div>
        <div class="hr"></div>
        <div class="hint">
          Not: TarayÄ±cÄ± GPS izni iÃ§in sayfanÄ±n <b>HTTPS</b> Ã¼zerinden aÃ§Ä±lmasÄ± gerekir. (GitHub Pages uygundur.)
          Yerel dosyada (Ã§ift tÄ±k) GPS Ã§alÄ±ÅŸmayabilir; haritadan konum seÃ§erek devam edebilirsin.
        </div>
      </div>

      <div class="panel">
        <div class="tabs">
          <div class="tab active" id="tabCustomer">MÃ¼ÅŸteri</div>
          <div class="tab" id="tabDriver">Kurye / SÃ¼rÃ¼cÃ¼</div>
        </div>

        <div id="customerPanel">
          <h3>SeÃ§im ve Konum</h3>
          <div class="info">
            <strong>NasÄ±l Ã§alÄ±ÅŸÄ±r?</strong><br/>
            1) KayÄ±t ol (ad-soyad + 11 hane telefon + KVKK/SÃ¶zleÅŸme)<br/>
            2) Haritada <b>AlÄ±nacak</b> ve <b>Gidilecek</b> noktalarÄ± seÃ§<br/>
            3) Hizmeti seÃ§, detaylarÄ± gir, <b>Ã‡aÄŸrÄ± OluÅŸtur</b>
          </div>
          <div class="hr"></div>
          <div class="kv"><b>Pickup:</b> <span id="pickupText" class="muted">seÃ§ilmedi</span></div>
          <div class="kv"><b>Dropoff:</b> <span id="dropoffText" class="muted">seÃ§ilmedi</span></div>
          <div class="kv"><b>Mesafe:</b> <span id="distanceText" class="muted">â€”</span></div>
          <div class="kv"><b>Tahmini Ãœcret:</b> <span id="priceText" class="muted">â€”</span></div>
        </div>

        <div id="driverPanel" style="display:none;">
          <h3>Kurye / SÃ¼rÃ¼cÃ¼ â€“ Ä°ÅŸ Teklifleri</h3>
          <div class="info">
            <strong>Kilit mantÄ±k:</strong> SÃ¼rÃ¼cÃ¼ iÅŸi kabul etmeden Ã¶nce <b>fiyat + mesafe</b> gÃ¶rÃ¼r.
            Kabul ederse mÃ¼ÅŸteri detaylarÄ± aÃ§Ä±lÄ±r. Bu ekranda demo amaÃ§lÄ± listeleme vardÄ±r.
          </div>
          <div class="row2">
            <div>
              <label>SÃ¼rÃ¼cÃ¼ ID (demo)</label>
              <input id="driverId" placeholder="Ã–rn: DRV-001" value="DRV-001"/>
            </div>
            <div>
              <label>Durum</label>
              <select id="driverStatus">
                <option value="available" selected>available</option>
                <option value="busy">busy</option>
                <option value="offline">offline</option>
              </select>
            </div>
          </div>
          <div class="row2">
            <button class="btn primary" id="btnRefreshJobs">Ä°ÅŸleri Yenile</button>
            <button class="btn" id="btnDriverUpdate">SÃ¼rÃ¼cÃ¼ Durum GÃ¼ncelle</button>
          </div>
          <div class="hr"></div>
          <div id="jobsList" class="info">HenÃ¼z liste yok.</div>
        </div>
      </div>
    </div>

    <!-- MAP (BANNER'IN HEMEN ALTINDA) -->
    <div class="mapWrap">
      <div id="map"></div>
      <div class="mapBar">
        <div class="left">
          <button class="btn" id="btnModePickup">AlÄ±nacak Konum SeÃ§</button>
          <button class="btn" id="btnModeDropoff">Gidilecek Konum SeÃ§</button>
          <button class="btn" id="btnClearPins">SeÃ§imleri SÄ±fÄ±rla</button>
        </div>
        <div class="pill">
          Mod: <span id="pinModeText" style="color:var(--text); font-weight:800;">AlÄ±nacak</span>
        </div>
      </div>
    </div>

    <!-- SERVICES -->
    <div class="services">
      <!-- TAXI -->
      <div class="card" id="cardTaxi">
        <div class="title">
          <h4>ğŸš• Taksi</h4>
          <div class="badge">CanlÄ± Takip: Taksi</div>
        </div>
        <p>AlÄ±nacak ve gidilecek konumu seÃ§. Sistem mesafe ve tahmini Ã¼creti hesaplar.</p>

        <div class="form">
          <div class="row2">
            <div>
              <label>Åehir BÃ¶lgesi (opsiyonel)</label>
              <input id="taxiZone" placeholder="Ã–rn: NilÃ¼fer / YÄ±ldÄ±rÄ±m"/>
            </div>
            <div>
              <label>Not (opsiyonel)</label>
              <input id="taxiNote" placeholder="Ã–rn: KapÄ± Ã¶nÃ¼, zil..."/>
            </div>
          </div>
          <button class="btn primary" id="btnCallTaxi">Taksi Ã‡aÄŸÄ±r (JOB OluÅŸtur)</button>
        </div>
      </div>

      <!-- COURIER -->
      <div class="card" id="cardCourier">
        <div class="title">
          <h4>ğŸ“¦ Kurye</h4>
          <div class="badge">Motorlu / AraÃ§lÄ±</div>
        </div>
        <p>Kurye tipi ve paket bilgilerini gir. SÃ¼rÃ¼cÃ¼, kabul Ã¶ncesi fiyat + mesafe gÃ¶rÃ¼r.</p>

        <div class="form">
          <div class="row2">
            <div>
              <label>Kurye Tipi</label>
              <select id="courierType">
                <option value="motorlu" selected>Motorlu Kurye</option>
                <option value="aracli">AraÃ§lÄ± Kurye</option>
              </select>
            </div>
            <div>
              <label>Paket Ä°Ã§eriÄŸi</label>
              <input id="packageContent" placeholder="Ã–rn: evrak / kÃ¼Ã§Ã¼k paket"/>
            </div>
          </div>

          <div class="row3">
            <div>
              <label>AÄŸÄ±rlÄ±k (kg)</label>
              <input id="packageKg" type="number" min="0" step="0.1" placeholder="Ã–rn: 2.5"/>
            </div>
            <div>
              <label>Hacim (opsiyonel)</label>
              <input id="packageVolume" placeholder="Ã–rn: 30x20x10 cm"/>
            </div>
            <div>
              <label>GÃ¶nderici AdÄ± (opsiyonel)</label>
              <input id="senderName" placeholder="Ã–rn: Ahmet Y."/>
            </div>
          </div>

          <div class="row2">
            <div>
              <label>AlÄ±cÄ± Ad Soyad (zorunlu)</label>
              <input id="receiverName" placeholder="Ã–rn: Mehmet Kaya"/>
            </div>
            <div>
              <label>AlÄ±cÄ± Telefon (zorunlu, 11 hane)</label>
              <input id="receiverPhone" inputmode="numeric" placeholder="05xxxxxxxxx" maxlength="11"/>
            </div>
          </div>

          <button class="btn primary" id="btnCallCourier">Kurye Ã‡aÄŸÄ±r (JOB OluÅŸtur)</button>
        </div>
      </div>

      <!-- TRANSFER -->
      <div class="card" id="cardTransfer">
        <div class="title">
          <h4>âœˆï¸ HavalimanÄ± Transferi</h4>
          <div class="badge">Hemen / Ä°leri Tarih</div>
        </div>
        <p>AraÃ§ ve havalimanÄ± seÃ§. Ä°leri tarih rezervasyonda %10 Ã¶n provizyon mantÄ±ÄŸÄ± kilitlidir (demo).</p>

        <div class="form">
          <div class="row2">
            <div>
              <label>HavalimanÄ±</label>
              <select id="airportName">
                <option value="Bursa YeniÅŸehir (YEI)" selected>Bursa YeniÅŸehir (YEI)</option>
                <option value="Ä°stanbul (IST)">Ä°stanbul (IST)</option>
                <option value="Sabiha GÃ¶kÃ§en (SAW)">Sabiha GÃ¶kÃ§en (SAW)</option>
                <option value="Ä°zmir Adnan Menderes (ADB)">Ä°zmir Adnan Menderes (ADB)</option>
              </select>
            </div>
            <div>
              <label>AraÃ§ Tipi</label>
              <select id="vehicleType">
                <option value="binek" selected>Binek</option>
                <option value="vip">VIP</option>
                <option value="minibus">MinibÃ¼s</option>
              </select>
            </div>
          </div>

          <div class="row3">
            <div>
              <label>Valiz SayÄ±sÄ±</label>
              <input id="luggageCount" type="number" min="0" step="1" value="1"/>
            </div>
            <div>
              <label>Rezervasyon</label>
              <select id="transferWhen">
                <option value="now" selected>Hemen</option>
                <option value="later">Ä°leri Tarih</option>
              </select>
            </div>
            <div>
              <label>Tarih/Saat (ileri tarihse)</label>
              <input id="transferDateTime" type="datetime-local" />
            </div>
          </div>

          <div class="info" id="transferPricingInfo">
            <strong>Fiyat:</strong> SeÃ§imlerinize gÃ¶re hesaplanacaktÄ±r.
          </div>

          <button class="btn primary" id="btnCallTransfer">Transfer OluÅŸtur (JOB)</button>
        </div>
      </div>
    </div>

    <div class="footer">
      <div>Â© <span id="year"></span> SepetTaxi â€¢ Demo / MVP</div>
      <div>
        <button class="linkBtn" id="btnOpenKvkk">KVKK</button>
        <span class="muted"> â€¢ </span>
        <button class="linkBtn" id="btnOpenContract">Hizmet SÃ¶zleÅŸmesi</button>
        <span class="muted"> â€¢ </span>
        <span class="mono muted">API:</span> <span class="mono muted" id="apiLabel">yÃ¼klendi</span>
      </div>
    </div>
  </div>

  <!-- REGISTER / PROFILE MODAL -->
  <div class="modal" id="modalRegister">
    <div class="box">
      <div class="boxHeader">
        <h3>KayÄ±t / Profil</h3>
        <button class="btn" id="btnCloseRegister">Kapat</button>
      </div>
      <div class="boxBody">
        <div class="row2">
          <div>
            <label>Ad Soyad (zorunlu)</label>
            <input id="regName" placeholder="Ã–rn: Ã–zhan Samurcu" />
          </div>
          <div>
            <label>Telefon (zorunlu, 11 hane, sadece rakam)</label>
            <input id="regPhone" inputmode="numeric" placeholder="05xxxxxxxxx" maxlength="11" />
          </div>
        </div>

        <div style="margin-top:10px" class="checkbox">
          <input type="checkbox" id="chkKvkk" />
          <div>
            <div style="color:var(--text); font-weight:800;">KVKK AydÄ±nlatma Metni onayÄ±</div>
            <div>KVKK metnini okudum, anladÄ±m ve kabul ediyorum.</div>
          </div>
        </div>

        <div style="margin-top:10px" class="checkbox">
          <input type="checkbox" id="chkContract" />
          <div>
            <div style="color:var(--text); font-weight:800;">Hizmet SÃ¶zleÅŸmesi onayÄ±</div>
            <div>Hizmet sÃ¶zleÅŸmesini okudum, anladÄ±m ve kabul ediyorum.</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="info">
          <strong>Not:</strong> CanlÄ±ya geÃ§ince OTP (SMS/e-posta doÄŸrulama) eklenecek. Åimdilik kayÄ±t localStorage ile saklanÄ±r.
        </div>

        <div class="row2" style="margin-top:10px">
          <button class="btn primary" id="btnSaveProfile">Kaydet</button>
          <button class="btn danger" id="btnClearProfile">Profili Sil</button>
        </div>
      </div>
    </div>
  </div>

  <!-- KVKK MODAL -->
  <div class="modal" id="modalKvkk">
    <div class="box">
      <div class="boxHeader">
        <h3>KVKK AydÄ±nlatma Metni (Ã–zet)</h3>
        <button class="btn" id="btnCloseKvkk">Kapat</button>
      </div>
      <div class="boxBody">
        <div class="info" style="white-space:pre-wrap">
SepetTaxi kapsamÄ±nda; hizmetin sunulmasÄ±, Ã§aÄŸrÄ± oluÅŸturma, sÃ¼rÃ¼cÃ¼ atama/iÅŸ teklifleri ve mÃ¼ÅŸteri iletiÅŸimi amaÃ§larÄ±yla ad-soyad, telefon, konum ve Ã§aÄŸrÄ± bilgileri iÅŸlenebilir.

Veriler; hukuki yÃ¼kÃ¼mlÃ¼lÃ¼kler ve hizmetin ifasÄ± kapsamÄ±nda, gerekli sÃ¼relerle sÄ±nÄ±rlÄ± olarak saklanÄ±r.
Detaylar ve haklar (eriÅŸim, dÃ¼zeltme, silme vb.) canlÄ± versiyonda tam metin olarak sunulacaktÄ±r.
        </div>
      </div>
    </div>
  </div>

  <!-- CONTRACT MODAL -->
  <div class="modal" id="modalContract">
    <div class="box">
      <div class="boxHeader">
        <h3>Hizmet SÃ¶zleÅŸmesi (Ã–zet)</h3>
        <button class="btn" id="btnCloseContract">Kapat</button>
      </div>
      <div class="boxBody">
        <div class="info" style="white-space:pre-wrap">
SepetTaxi, kullanÄ±cÄ± ile sÃ¼rÃ¼cÃ¼/kurye arasÄ±nda aracÄ±lÄ±k eden bir platformdur.
Ãœcretlendirme; mesafe, hizmet tÃ¼rÃ¼, araÃ§ tipi ve operasyonel parametrelere gÃ¶re belirlenir.
SÃ¼rÃ¼cÃ¼/kurye iÅŸi kabul etmeden Ã¶nce fiyat ve mesafeyi gÃ¶rÃ¼r; kabul sonrasÄ± iletiÅŸim ve teslimat detaylarÄ± paylaÅŸÄ±lÄ±r.
Komisyon ve Ã¶deme adÄ±mlarÄ± canlÄ± sistemde ayrÄ±ca tanÄ±mlanacaktÄ±r.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * CONFIG (KÄ°LÄ°TLÄ°)
     ***********************/
    const API_URL = "https://script.google.com/macros/s/AKfycbxp2VKTjPz9WtTy93N6bLKifCvfJSClbc7eEpysZUZ1otLqr-sXqFL1FiKSzKYSjpdw/exec";

    // Basit fiyat parametreleri (Admin panelden ayarlanabilir mantÄ±k kilit)
    const PRICING = {
      taxi:   { base: 45, perKm: 18, min: 90 },
      courier_motorlu: { base: 55, perKm: 16, min: 95 },
      courier_aracli:  { base: 75, perKm: 20, min: 120 },
      transfer: {
        binek:   { base: 650, perKm: 28 },
        vip:     { base: 950, perKm: 38 },
        minibus: { base: 1200, perKm: 44 }
      },
      // Ä°leri tarih rezervasyon provizyon oranÄ± (kilit)
      transferDepositRate: 0.10
    };

    // VarsayÄ±lan harita baÅŸlangÄ±cÄ± (Bursa Ã§evresi)
    const DEFAULT_CENTER = { lat: 40.195, lng: 29.06 };
    const DEFAULT_ZOOM = 12;

    /***********************
     * STATE
     ***********************/
    let map;
    let pinMode = "pickup"; // "pickup" | "dropoff"
    let pickup = null;  // {lat,lng}
    let dropoff = null; // {lat,lng}
    let pickupMarker = null;
    let dropoffMarker = null;

    const els = (id) => document.getElementById(id);
    const toastBox = els("toast");

    function toast(msg, type="ok"){
      const t = document.createElement("div");
      t.className = `t ${type}`;
      const left = document.createElement("div");
      left.className = "msg";
      left.textContent = msg;
      const x = document.createElement("div");
      x.className = "x";
      x.textContent = "âœ•";
      x.onclick = () => t.remove();
      t.appendChild(left);
      t.appendChild(x);
      toastBox.appendChild(t);
      setTimeout(()=>{ try{ t.remove(); }catch(e){} }, 5200);
    }

    function clampPhoneDigits(v){
      return (v || "").replace(/\D/g,"").slice(0,11);
    }

    function isValidTRPhone11(v){
      const s = clampPhoneDigits(v);
      return s.length === 11 && s.startsWith("0");
    }

    function getProfile(){
      try{
        return JSON.parse(localStorage.getItem("sepettaxi_profile") || "null");
      }catch(e){
        return null;
      }
    }
    function setProfile(p){
      localStorage.setItem("sepettaxi_profile", JSON.stringify(p));
      renderProfilePill();
    }
    function clearProfile(){
      localStorage.removeItem("sepettaxi_profile");
      renderProfilePill();
    }

    function renderProfilePill(){
      const p = getProfile();
      const pill = els("pillUser");
      if(!p){
        pill.innerHTML = "ğŸ‘¤ <span class='muted'>KayÄ±tlÄ± deÄŸil</span>";
        return;
      }
      pill.innerHTML = `ğŸ‘¤ <span style="color:var(--text);font-weight:800;">${escapeHtml(p.name)}</span> <span class="muted">(${escapeHtml(p.phone)})</span>`;
    }

    function requireProfile(){
      const p = getProfile();
      if(!p){
        toast("Ã–nce kayÄ±t olmalÄ±sÄ±n (Ad Soyad + Telefon + KVKK/SÃ¶zleÅŸme).", "warn");
        openModal("modalRegister");
        return null;
      }
      return p;
    }

    function escapeHtml(str){
      return String(str||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    function setPinMode(mode){
      pinMode = mode;
      els("pinModeText").textContent = (mode === "pickup") ? "AlÄ±nacak" : "Gidilecek";
      els("btnModePickup").classList.toggle("primary", mode==="pickup");
      els("btnModeDropoff").classList.toggle("primary", mode==="dropoff");
    }

    function setPoint(which, latlng){
      if(which === "pickup"){
        pickup = {lat: latlng.lat, lng: latlng.lng};
        if(pickupMarker) pickupMarker.remove();
        pickupMarker = L.marker([pickup.lat, pickup.lng], {draggable:true})
          .addTo(map)
          .bindPopup("AlÄ±nacak Konum")
          .openPopup();
        pickupMarker.on("dragend", () => {
          const ll = pickupMarker.getLatLng();
          pickup = {lat: ll.lat, lng: ll.lng};
          updateSummary();
        });
      }else{
        dropoff = {lat: latlng.lat, lng: latlng.lng};
        if(dropoffMarker) dropoffMarker.remove();
        dropoffMarker = L.marker([dropoff.lat, dropoff.lng], {draggable:true})
          .addTo(map)
          .bindPopup("Gidilecek Konum")
          .openPopup();
        dropoffMarker.on("dragend", () => {
          const ll = dropoffMarker.getLatLng();
          dropoff = {lat: ll.lat, lng: ll.lng};
          updateSummary();
        });
      }
      updateSummary();
    }

    function clearPins(){
      pickup = null; dropoff = null;
      if(pickupMarker){ pickupMarker.remove(); pickupMarker = null; }
      if(dropoffMarker){ dropoffMarker.remove(); dropoffMarker = null; }
      updateSummary();
    }

    // Haversine distance (km)
    function distanceKm(a,b){
      const R = 6371;
      const dLat = (b.lat-a.lat) * Math.PI/180;
      const dLon = (b.lng-a.lng) * Math.PI/180;
      const lat1 = a.lat * Math.PI/180;
      const lat2 = b.lat * Math.PI/180;
      const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
      return R*c;
    }

    function moneyTRY(x){
      if(!isFinite(x)) return "â€”";
      return new Intl.NumberFormat("tr-TR", {style:"currency", currency:"TRY", maximumFractionDigits:0}).format(x);
    }

    function computeTaxiPrice(km){
      const p = PRICING.taxi;
      const v = Math.max(p.min, p.base + km*p.perKm);
      return Math.round(v);
    }
    function computeCourierPrice(km, type){
      const p = (type === "aracli") ? PRICING.courier_aracli : PRICING.courier_motorlu;
      const v = Math.max(p.min, p.base + km*p.perKm);
      return Math.round(v);
    }
    function computeTransferPrice(km, vehicleType){
      const p = PRICING.transfer[vehicleType] || PRICING.transfer.binek;
      const v = p.base + km*p.perKm;
      return Math.round(v);
    }

    function updateSummary(){
      els("pickupText").textContent = pickup ? `${pickup.lat.toFixed(5)}, ${pickup.lng.toFixed(5)}` : "seÃ§ilmedi";
      els("dropoffText").textContent = dropoff ? `${dropoff.lat.toFixed(5)}, ${dropoff.lng.toFixed(5)}` : "seÃ§ilmedi";

      if(pickup && dropoff){
        const km = distanceKm(pickup, dropoff);
        els("distanceText").textContent = `${km.toFixed(2)} km`;

        // varsayÄ±lan olarak taksi fiyatÄ± gÃ¶ster
        const taxiPrice = computeTaxiPrice(km);
        els("priceText").textContent = moneyTRY(taxiPrice);

        // transfer info gÃ¼ncelle
        updateTransferPricing(km);
      }else{
        els("distanceText").textContent = "â€”";
        els("priceText").textContent = "â€”";
        updateTransferPricing(null);
      }
    }

    function updateTransferPricing(km){
      const vehicleType = els("vehicleType").value;
      const when = els("transferWhen").value;

      if(!km){
        els("transferPricingInfo").innerHTML = "<strong>Fiyat:</strong> Ã–nce alÄ±nacak ve gidilecek konumlarÄ± seÃ§.";
        return;
      }

      const total = computeTransferPrice(km, vehicleType);
      if(when === "later"){
        const dep = Math.round(total * PRICING.transferDepositRate);
        const rem = total - dep;
        els("transferPricingInfo").innerHTML =
          `<strong>Toplam:</strong> ${moneyTRY(total)}<br/>` +
          `<strong>Ã–n Provizyon (%10):</strong> ${moneyTRY(dep)} â€¢ ` +
          `<strong>Kalan:</strong> ${moneyTRY(rem)}`;
      }else{
        els("transferPricingInfo").innerHTML = `<strong>Toplam:</strong> ${moneyTRY(total)}`;
      }
    }

    /***********************
     * API HELPERS
     * - FarklÄ± backend sÃ¼rÃ¼mleriyle uyumluluk amaÃ§lÄ± iki format dener.
     ***********************/
    async function apiPost(payload){
      const res = await fetch(API_URL, {
        method: "POST",
        headers: {"Content-Type":"text/plain;charset=utf-8"},
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      // Apps Script bazen JSON dÃ¶ner, bazen text
      try { return JSON.parse(text); } catch { return { ok: res.ok, raw: text }; }
    }

    async function apiGet(params){
      const url = new URL(API_URL);
      Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString(), { method:"GET" });
      const text = await res.text();
      try { return JSON.parse(text); } catch { return { ok: res.ok, raw: text }; }
    }

    function makeJobId(){
      return "JOB-" + Date.now();
    }

    async function createJob(job){
      // 1) Yeni stil (action tabanlÄ±)
      const payload1 = { action: "create_job", job };

      // 2) Eski stil (sheet/row tabanlÄ±) â€“ jobs sheet beklenir
      const row = [
        job.job_id,
        job.created_at,
        job.service_type,
        job.user_name,
        job.user_phone,
        job.pickup_lat,
        job.pickup_lng,
        job.dropoff_lat,
        job.dropoff_lng,
        job.distance_km,
        job.estimated_price,
        job.airport_name || "",
        job.city_zone || "",
        job.fixed_price || "",
        job.status,
        job.driver_id || "",
        job.accepted_at || "",
        job.completed_at || ""
      ];
      const payload2 = { sheet: "jobs", row };

      // Deneme sÄ±rasÄ±: action -> sheet/row
      try{
        const r1 = await apiPost(payload1);
        if(isApiOk(r1)){
          return r1;
        }
      }catch(e){/* devam */}
      const r2 = await apiPost(payload2);
      return r2;
    }

    function isApiOk(resp){
      if(!resp) return false;
      if(resp.ok === true) return true;
      if(resp.status && String(resp.status).toLowerCase().includes("ok")) return true;
      if(resp.success === true) return true;
      if(resp.result && String(resp.result).toLowerCase().includes("ok")) return true;
      return false;
    }

    /***********************
     * MODALS
     ***********************/
    function openModal(id){ els(id).classList.add("on"); }
    function closeModal(id){ els(id).classList.remove("on"); }

    /***********************
     * INIT MAP + UI
     ***********************/
    function initMap(){
      map = L.map("map", { zoomControl: true }).setView([DEFAULT_CENTER.lat, DEFAULT_CENTER.lng], DEFAULT_ZOOM);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      map.on("click", (e) => {
        setPoint(pinMode, e.latlng);
      });

      setPinMode("pickup");
      updateSummary();
    }

    async function getGPS(){
      if(!navigator.geolocation){
        toast("Bu tarayÄ±cÄ± konum (geolocation) desteklemiyor. Haritadan seÃ§im yapabilirsin.", "warn");
        return;
      }
      toast("Konum isteniyorâ€¦ TarayÄ±cÄ± izni ver.", "ok");

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          map.setView([lat,lng], 15);
          // pickup'u otomatik doldur
          setPoint("pickup", {lat,lng});
          toast("Konum alÄ±ndÄ±. AlÄ±nacak konum gÃ¼ncellendi.", "ok");
        },
        (err) => {
          toast("Konum alÄ±namadÄ±. HTTPS/izin kontrol et veya haritadan konum seÃ§.", "warn");
        },
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
      );
    }

    /***********************
     * JOB CREATION (KÄ°LÄ°TLÄ° AKIÅ)
     ***********************/
    function ensureRouteReady(){
      if(!pickup || !dropoff){
        toast("AlÄ±nacak ve gidilecek konumlarÄ± haritadan seÃ§melisin.", "warn");
        return false;
      }
      return true;
    }

    async function callTaxi(){
      const profile = requireProfile(); if(!profile) return;
      if(!ensureRouteReady()) return;

      const km = distanceKm(pickup, dropoff);
      const price = computeTaxiPrice(km);

      const job = {
        job_id: makeJobId(),
        created_at: new Date().toISOString(),
        service_type: "taxi",
        user_name: profile.name,
        user_phone: profile.phone,
        pickup_lat: pickup.lat, pickup_lng: pickup.lng,
        dropoff_lat: dropoff.lat, dropoff_lng: dropoff.lng,
        distance_km: Number(km.toFixed(2)),
        estimated_price: price,
        city_zone: els("taxiZone").value || "",
        note: els("taxiNote").value || "",
        status: "pending"
      };

      toast("Taksi Ã§aÄŸrÄ±sÄ± oluÅŸturuluyorâ€¦", "ok");
      const resp = await createJob(job);

      if(isApiOk(resp)){
        toast(`Ã‡aÄŸrÄ± sisteme dÃ¼ÅŸtÃ¼: ${job.job_id}`, "ok");
      }else{
        toast("Ã‡aÄŸrÄ± oluÅŸturulamadÄ±. Apps Script/Sheet tarafÄ±nÄ± kontrol et.", "bad");
        console.log("API_RESP", resp);
      }
    }

    async function callCourier(){
      const profile = requireProfile(); if(!profile) return;
      if(!ensureRouteReady()) return;

      const receiverName = els("receiverName").value.trim();
      const receiverPhone = clampPhoneDigits(els("receiverPhone").value);

      if(!receiverName){
        toast("AlÄ±cÄ± Ad Soyad zorunlu.", "warn");
        return;
      }
      if(!isValidTRPhone11(receiverPhone)){
        toast("AlÄ±cÄ± telefonu 11 hane ve 0 ile baÅŸlamalÄ± (05xxxxxxxxx).", "warn");
        return;
      }

      const ctype = els("courierType").value; // motorlu/aracli
      const km = distanceKm(pickup, dropoff);
      const price = computeCourierPrice(km, ctype);

      const job = {
        job_id: makeJobId(),
        created_at: new Date().toISOString(),
        service_type: (ctype === "aracli") ? "courier_aracli" : "courier_motorlu",
        user_name: profile.name,
        user_phone: profile.phone,
        pickup_lat: pickup.lat, pickup_lng: pickup.lng,
        dropoff_lat: dropoff.lat, dropoff_lng: dropoff.lng,
        distance_km: Number(km.toFixed(2)),
        estimated_price: price,
        package_content: els("packageContent").value || "",
        package_kg: els("packageKg").value || "",
        package_volume: els("packageVolume").value || "",
        sender_name: els("senderName").value || "",
        receiver_name: receiverName,
        receiver_phone: receiverPhone,
        // kilit: sÃ¼rÃ¼cÃ¼ kabul Ã¶ncesi fiyat+mesafe gÃ¶rÃ¼r, kabul sonrasÄ± detaylar aÃ§Ä±lÄ±r (backend akÄ±ÅŸÄ±yla yÃ¶netilecek)
        status: "pending"
      };

      toast("Kurye Ã§aÄŸrÄ±sÄ± oluÅŸturuluyorâ€¦", "ok");
      const resp = await createJob(job);

      if(isApiOk(resp)){
        toast(`Kurye iÅŸi sisteme dÃ¼ÅŸtÃ¼: ${job.job_id}`, "ok");
      }else{
        toast("Kurye iÅŸi oluÅŸturulamadÄ±. Apps Script/Sheet tarafÄ±nÄ± kontrol et.", "bad");
        console.log("API_RESP", resp);
      }
    }

    async function callTransfer(){
      const profile = requireProfile(); if(!profile) return;
      if(!ensureRouteReady()) return;

      const km = distanceKm(pickup, dropoff);
      const airport = els("airportName").value;
      const vehicle = els("vehicleType").value;
      const when = els("transferWhen").value;
      const dt = els("transferDateTime").value;

      if(when === "later" && !dt){
        toast("Ä°leri tarih iÃ§in tarih/saat seÃ§melisin.", "warn");
        return;
      }

      const total = computeTransferPrice(km, vehicle);
      const fixed_price = total;

      const deposit = (when === "later") ? Math.round(total * PRICING.transferDepositRate) : 0;

      const job = {
        job_id: makeJobId(),
        created_at: new Date().toISOString(),
        service_type: "transfer",
        user_name: profile.name,
        user_phone: profile.phone,
        pickup_lat: pickup.lat, pickup_lng: pickup.lng,
        dropoff_lat: dropoff.lat, dropoff_lng: dropoff.lng,
        distance_km: Number(km.toFixed(2)),
        estimated_price: total,
        airport_name: airport,
        vehicle_type: vehicle,
        luggage_count: Number(els("luggageCount").value || 0),
        reservation_when: when,
        reservation_datetime: dt || "",
        fixed_price,
        deposit_amount: deposit,
        status: "pending"
      };

      toast("Transfer oluÅŸturuluyorâ€¦", "ok");
      const resp = await createJob(job);

      if(isApiOk(resp)){
        if(when === "later"){
          toast(`Transfer oluÅŸturuldu: ${job.job_id} â€¢ Ã–n provizyon (demo): ${moneyTRY(deposit)}`, "ok");
        }else{
          toast(`Transfer oluÅŸturuldu: ${job.job_id}`, "ok");
        }
      }else{
        toast("Transfer oluÅŸturulamadÄ±. Apps Script/Sheet tarafÄ±nÄ± kontrol et.", "bad");
        console.log("API_RESP", resp);
      }
    }

    /***********************
     * DRIVER DEMO
     ***********************/
    async function refreshJobs(){
      els("jobsList").textContent = "YÃ¼kleniyorâ€¦";
      // Action tabanlÄ± dene; yoksa raw dÃ¶ner
      const resp = await apiGet({ action: "list_jobs", status: "pending" });
      if(resp && Array.isArray(resp.jobs)){
        renderJobs(resp.jobs);
        return;
      }
      // fallback: raw
      els("jobsList").textContent =
        "Bu backend sÃ¼rÃ¼mÃ¼nde listeleme endpoint'i yok (normal). Yine de mÃ¼ÅŸteri tarafÄ±nda JOB oluÅŸturma Ã§alÄ±ÅŸÄ±r. " +
        "CanlÄ± sÃ¼rÃ¼cÃ¼ havuzu/listesi iÃ§in Apps Script'e list_jobs route ekleriz.\n\n" +
        "Ham cevap:\n" + (resp?.raw ? resp.raw.slice(0,600) : JSON.stringify(resp).slice(0,600));
    }

    function renderJobs(jobs){
      if(!jobs.length){
        els("jobsList").textContent = "Pending iÅŸ yok.";
        return;
      }
      const html = jobs.slice(0, 10).map(j => {
        const km = j.distance_km ?? j.km ?? "â€”";
        const price = j.estimated_price ?? j.price ?? "â€”";
        const svc = j.service_type ?? "â€”";
        const id = j.job_id ?? "â€”";
        const btnId = "acc_" + id.replace(/\W/g,"");
        return `
          <div style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;margin-bottom:10px;background:rgba(255,255,255,.02)">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
              <div>
                <div style="font-weight:900;color:var(--text)">${escapeHtml(id)}</div>
                <div class="muted small">Hizmet: ${escapeHtml(svc)} â€¢ Mesafe: ${escapeHtml(String(km))} â€¢ Ãœcret: ${escapeHtml(String(price))}</div>
              </div>
              <button class="btn primary" data-job="${escapeHtml(id)}">Kabul Et</button>
            </div>
            <div class="muted small" style="margin-top:8px">
              Kilit: kabul Ã¶ncesi sadece fiyat + mesafe. Kabul sonrasÄ± mÃ¼ÅŸteri/adres/telefon detaylarÄ± aÃ§Ä±lÄ±r.
            </div>
          </div>
        `;
      }).join("");
      els("jobsList").innerHTML = html;

      els("jobsList").querySelectorAll("button[data-job]").forEach(btn=>{
        btn.onclick = async () => {
          const jobId = btn.getAttribute("data-job");
          toast(`Kabul isteÄŸi gÃ¶nderiliyor (demo): ${jobId}`, "ok");
          // Action tabanlÄ± kabul denemesi (yoksa raw)
          const driver_id = els("driverId").value.trim() || "DRV-001";
          const resp = await apiPost({ action:"accept_job", job_id: jobId, driver_id });
          if(isApiOk(resp)){
            toast(`Ä°ÅŸ kabul edildi: ${jobId} (demo)`, "ok");
            refreshJobs();
          }else{
            toast("Bu backend sÃ¼rÃ¼mÃ¼nde accept_job route yok (normal). CanlÄ±ya geÃ§erken ekleyeceÄŸiz.", "warn");
            console.log("accept_job resp:", resp);
          }
        };
      });
    }

    async function updateDriver(){
      const driver_id = els("driverId").value.trim();
      if(!driver_id){
        toast("SÃ¼rÃ¼cÃ¼ ID gir.", "warn");
        return;
      }
      const status = els("driverStatus").value;
      // Action tabanlÄ± driver update denemesi
      const resp = await apiPost({ action:"upsert_driver", driver_id, status, lat: pickup?.lat ?? DEFAULT_CENTER.lat, lng: pickup?.lng ?? DEFAULT_CENTER.lng });
      if(isApiOk(resp)){
        toast("SÃ¼rÃ¼cÃ¼ durumu gÃ¼ncellendi (demo).", "ok");
      }else{
        toast("Bu backend sÃ¼rÃ¼mÃ¼nde sÃ¼rÃ¼cÃ¼ route yoksa sorun deÄŸil; canlÄ±ya geÃ§erken ekleriz.", "warn");
        console.log("upsert_driver resp:", resp);
      }
    }

    /***********************
     * EVENTS
     ***********************/
    function bindEvents(){
      els("year").textContent = new Date().getFullYear();
      els("apiLabel").textContent = API_URL;

      // tabs
      els("tabCustomer").onclick = () => {
        els("tabCustomer").classList.add("active");
        els("tabDriver").classList.remove("active");
        els("customerPanel").style.display = "";
        els("driverPanel").style.display = "none";
      };
      els("tabDriver").onclick = () => {
        els("tabDriver").classList.add("active");
        els("tabCustomer").classList.remove("active");
        els("driverPanel").style.display = "";
        els("customerPanel").style.display = "none";
      };

      // map controls
      els("btnModePickup").onclick = () => setPinMode("pickup");
      els("btnModeDropoff").onclick = () => setPinMode("dropoff");
      els("btnClearPins").onclick = () => clearPins();

      // gps
      els("btnGetGPS").onclick = () => getGPS();

      // register modal
      els("btnOpenRegister").onclick = () => {
        const p = getProfile();
        els("regName").value = p?.name || "";
        els("regPhone").value = p?.phone || "";
        els("chkKvkk").checked = !!p?.kvkk;
        els("chkContract").checked = !!p?.contract;
        openModal("modalRegister");
      };
      els("btnCloseRegister").onclick = () => closeModal("modalRegister");

      els("regPhone").addEventListener("input", (e)=>{
        e.target.value = clampPhoneDigits(e.target.value);
      });

      els("btnSaveProfile").onclick = () => {
        const name = els("regName").value.trim();
        const phone = clampPhoneDigits(els("regPhone").value);

        if(!name){
          toast("Ad Soyad zorunlu.", "warn"); return;
        }
        if(!isValidTRPhone11(phone)){
          toast("Telefon 11 hane olmalÄ± ve 0 ile baÅŸlamalÄ± (05xxxxxxxxx).", "warn"); return;
        }
        if(!els("chkKvkk").checked){
          toast("KVKK onayÄ± zorunlu.", "warn"); return;
        }
        if(!els("chkContract").checked){
          toast("Hizmet sÃ¶zleÅŸmesi onayÄ± zorunlu.", "warn"); return;
        }
        setProfile({ name, phone, kvkk:true, contract:true, saved_at: new Date().toISOString() });
        toast("Profil kaydedildi.", "ok");
        closeModal("modalRegister");
      };

      els("btnClearProfile").onclick = () => {
        clearProfile();
        toast("Profil silindi.", "warn");
      };

      // KVKK & Contract
      els("btnOpenKvkk").onclick = () => openModal("modalKvkk");
      els("btnCloseKvkk").onclick = () => closeModal("modalKvkk");
      els("btnOpenContract").onclick = () => openModal("modalContract");
      els("btnCloseContract").onclick = () => closeModal("modalContract");

      // close modals by clicking backdrop
      ["modalRegister","modalKvkk","modalContract"].forEach(id=>{
        els(id).addEventListener("click", (e)=>{
          if(e.target === els(id)) closeModal(id);
        });
      });

      // courier receiver phone
      els("receiverPhone").addEventListener("input",(e)=>{
        e.target.value = clampPhoneDigits(e.target.value);
      });

      // buttons create job
      els("btnCallTaxi").onclick = () => callTaxi();
      els("btnCallCourier").onclick = () => callCourier();
      els("btnCallTransfer").onclick = () => callTransfer();

      // transfer pricing on change
      ["vehicleType","transferWhen"].forEach(id=>{
        els(id).addEventListener("change", ()=>{
          if(pickup && dropoff){
            updateTransferPricing(distanceKm(pickup, dropoff));
          }else{
            updateTransferPricing(null);
          }
        });
      });

      // driver actions
      els("btnRefreshJobs").onclick = () => refreshJobs();
      els("btnDriverUpdate").onclick = () => updateDriver();
    }

    /***********************
     * BOOT
     ***********************/
    (function boot(){
      renderProfilePill();
      bindEvents();
      initMap();
      updateSummary();
      // Ä°lk aÃ§Ä±lÄ±ÅŸta kullanÄ±cÄ±ya pratik yÃ¶nlendirme
      setTimeout(()=> toast("Haritada Ã¶nce AlÄ±nacak, sonra Gidilecek konumu seÃ§. Ä°stersen Konum Al ile GPS kullan.", "ok"), 650);
    })();
  </script>
</body>
</html>
