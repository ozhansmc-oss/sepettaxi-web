<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* === SAME UI – DOKUNMADIM === */
*{box-sizing:border-box}
:root{
  --y:#f5c400; --bg:#050506; --panel:#0f0f10; --card:#141416;
  --line:rgba(255,255,255,.10); --mut:rgba(255,255,255,.65); --mut2:rgba(255,255,255,.42);
  --ok:#2bd576; --bad:#ff4d4d;
}
html,body{height:100%;margin:0;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
a{color:inherit}

/* layout */
#app{height:100%;display:flex;flex-direction:column}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  position:relative;background:#000;border-bottom:1px solid rgba(255,255,255,.08)
}
.brand{font-weight:900}
.brand span{color:var(--y)}
.iconBtn{
  position:absolute;top:50%;transform:translateY(-50%);
  width:42px;height:42px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)
}
#hamb{left:10px} #support{right:10px}

#main{flex:1;display:flex;flex-direction:column;min-height:0}
#mapWrap{flex:0 0 calc((100vh - 56px) * .5);position:relative}
#map{height:100%;width:100%}

/* center pin */
.centerPin{position:absolute;left:50%;top:50%;transform:translate(-50%,-100%);z-index:500;pointer-events:none}
.pinTop{width:28px;height:28px;border-radius:14px;background:var(--y);border:2px solid #000;display:flex;align-items:center;justify-content:center}
.pinDot{width:8px;height:8px;border-radius:4px;background:#000}
.pinStem{width:6px;height:16px;background:var(--y);margin:0 auto;border-radius:0 0 6px 6px;border:2px solid #000;border-top:none}

/* panel */
#panel{flex:1;background:linear-gradient(180deg,rgba(10,10,12,.86),rgba(10,10,12,.98));
border-top:1px solid rgba(255,255,255,.08);padding:12px;display:flex;flex-direction:column;gap:10px}

.seg{display:flex;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);padding:6px;border-radius:16px}
.seg button{flex:1;border:0;border-radius:12px;padding:10px;background:transparent;color:rgba(255,255,255,.7);font-weight:800}
.seg button.active{background:rgba(245,196,0,.18);border:1px solid rgba(245,196,0,.35);color:#fff}

.card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:18px;padding:12px}
.row{display:flex;justify-content:space-between;align-items:center}
.pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);font-weight:700;font-size:13px}
.pill .dot{width:10px;height:10px;border-radius:5px;background:rgba(255,255,255,.35)}
.pill.ok .dot{background:var(--ok)} .pill.warn .dot{background:var(--y)}

.field{display:flex;flex-direction:column;gap:6px}
.field label{font-size:12px;color:rgba(255,255,255,.55);font-weight:700}
.fakeInput{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:14px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.10);font-weight:800}

.btn{width:100%;padding:14px;border-radius:16px;font-weight:900;border:0;background:var(--y);color:#000}
.btn[disabled]{opacity:.4}

/* legal */
#legalBox{display:none;margin-top:8px}
#legalBox label{display:flex;gap:8px;font-size:12px;color:rgba(255,255,255,.7)}

/* register modal */
.modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(8px);display:none;align-items:flex-end;justify-content:center;z-index:3000}
.modal{width:100%;max-width:520px;background:#141416;border-radius:22px 22px 0 0;padding:14px}

/* search overlay */
#searchOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(14px);z-index:4000}
.searchCard{padding:16px;border-radius:22px;background:#141416;border:1px solid rgba(255,255,255,.1);text-align:center}
</style>
</head>

<body>
<div id="app">
<header>
  <div id="hamb" class="iconBtn">≡</div>
  <div class="brand">Sepet<span>Taxi</span></div>
  <div id="support" class="iconBtn">?</div>
</header>

<div id="main">
  <div id="mapWrap">
    <div id="map"></div>
    <div class="centerPin"><div class="pinTop"><div class="pinDot"></div></div><div class="pinStem"></div></div>
  </div>

  <div id="panel">
    <div class="seg">
      <button id="btnTaxi" class="active">Taksi</button>
      <button id="btnCourier">Kurye</button>
    </div>

    <div class="card">
      <div class="row">
        <div id="statusPill" class="pill warn"><span class="dot"></span><span id="statusText">Konum alınıyor</span></div>
      </div>
      <div style="height:8px"></div>
      <div class="field">
        <label>Nereden</label>
        <div class="fakeInput" id="fromBox"><span id="fromVal">Haritadan seç</span><small>Seç</small></div>
      </div>
      <div style="height:8px"></div>
      <div class="field">
        <label>Nereye</label>
        <div class="fakeInput" id="toBox"><span id="toVal">Haritadan seç</span><small>Seç</small></div>
      </div>
    </div>

    <!-- LEGAL – SADECE ÇAĞIR ÖNCESİ GÖRÜNÜR -->
    <div id="legalBox">
      <label>
        <input type="checkbox" id="legalAccept">
        <span>
          <a href="/legal/kvkk.html" target="_blank">KVKK</a> ve
          <a href="/legal/musteri-sozlesmesi.html" target="_blank">Müşteri Sözleşmesi</a>’ni kabul ediyorum
        </span>
      </label>
    </div>

    <button id="callBtn" class="btn" disabled>Çağır</button>
  </div>
</div>
</div>

<!-- REGISTER -->
<div id="regBackdrop" class="modalBackdrop">
  <div class="modal">
    <h3>Kayıt</h3>
    <input id="regFirst" placeholder="Ad">
    <input id="regLast" placeholder="Soyad">
    <input id="regPhone" placeholder="05xx">
    <button id="regOk" class="btn">Devam</button>
  </div>
</div>

<!-- SEARCH -->
<div id="searchOverlay">
  <div class="searchCard">Sürücü aranıyor…</div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbxoeXl9XfxWtsqqCfftNV578KD_woNSKfT3KmSYwZuCv8iPSPd8-cZXNoYMh6Qx-yrlWA/exec";

/* ================= STATE ================= */
let map, from=null, to=null, serviceType="taxi", registered=false;
const customer={first:"",last:"",phone:""};

/* ================= MAP ================= */
map=L.map("map",{zoomControl:false}).setView([41.0082,28.9784],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
map.on("move",()=>center=map.getCenter());

async function pick(){
  const c=map.getCenter();
  const addr=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${c.lat}&lon=${c.lng}`,
  {headers:{"User-Agent":"SepetTaxi/1.0"}}).then(r=>r.json()).catch(()=>({}));
  return {lat:c.lat,lng:c.lng,address:addr.display_name||"Seçilen konum"};
}

fromBox.onclick=async()=>{from=await pick();fromVal.textContent=from.address;checkReady();}
toBox.onclick=async()=>{to=await pick();toVal.textContent=to.address;checkReady();}

/* ================= READY LOGIC ================= */
function checkReady(){
  const ok=from&&to;
  callBtn.disabled=!ok;
  legalBox.style.display=ok?"block":"none";
}

/* ================= CALL ================= */
callBtn.onclick=()=>{
  if(!legalAccept.checked){alert("Sözleşmeleri kabul etmelisiniz");return;}
  if(!registered){regBackdrop.style.display="flex";return;}
  createJob();
};

/* ================= REGISTER ================= */
regOk.onclick=()=>{
  customer.first=regFirst.value;
  customer.last=regLast.value;
  customer.phone=regPhone.value;
  registered=true;
  regBackdrop.style.display="none";
  createJob();
};

/* ================= API ================= */
async function api(action,payload){
  const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},
  body:JSON.stringify({action,...payload})});
  const j=await r.json();
  if(j.error)throw j.error;
  return j;
}

async function createJob(){
  searchOverlay.style.display="flex";
  const r=await api("createJob",{
    service_type:serviceType,
    customer_first:customer.first,
    customer_last:customer.last,
    customer_phone:customer.phone,
    from_address:from.address,
    to_address:to.address,
    pickup_lat:from.lat,pickup_lng:from.lng,
    dropoff_lat:to.lat,dropoff_lng:to.lng
  });
  location.href=`track.html?job_id=${r.job_id}`;
}
</script>
</body>
</html>
