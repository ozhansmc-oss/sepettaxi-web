<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>SepetTaxi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{font-family:Arial,Helvetica,sans-serif;background:#0b0f17;color:#fff}

.screen{display:none;height:100vh}
.active{display:block}

.center{display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}

button{
  width:100%;
  padding:16px;
  border:none;
  border-radius:14px;
  font-size:16px;
  cursor:pointer;
  background:#fff;
  color:#000;
}

.topbar{
  position:fixed;top:0;left:0;right:0;height:56px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;background:#0b0f17;z-index:5
}

.footer{
  position:fixed;left:0;right:0;bottom:0;height:110px;
  background:#0b0f17;padding:12px;z-index:5
}

.cards{display:flex;gap:10px}
.card{
  flex:1;background:#161b2a;border-radius:14px;padding:14px;
  text-align:center;cursor:pointer
}

input{
  width:100%;padding:14px;margin-top:10px;border-radius:10px;border:none
}

#map{
  position:fixed;
  top:56px;
  bottom:110px;
  left:0;
  right:0;
  z-index:1;
}
</style>
</head>
<body>

<!-- SCREEN 1 : Gƒ∞Rƒ∞≈û -->
<div id="s1" class="screen active center">
  <h1>SepetTaxi</h1>
  <div style="color:#aaa;margin:8px 0">Taksi ¬∑ Kurye ¬∑ Transfer</div>
  <button onclick="go(2)" style="max-width:280px">Devam Et</button>
</div>

<!-- SCREEN 2 : HARƒ∞TA + Hƒ∞ZMET -->
<div id="s2" class="screen">
  <div class="topbar">
    <div>SepetTaxi</div>
    <div id="userState">Misafir</div>
  </div>

  <div id="map"></div>

  <div class="footer">
    <div style="margin-bottom:8px">Hizmet Se√ß</div>
    <div class="cards">
      <div class="card" onclick="selectService('taxi')">üöï Taksi</div>
      <div class="card" onclick="selectService('courier')">üõµ Kurye</div>
      <div class="card" onclick="selectService('transfer')">‚úàÔ∏è Transfer</div>
    </div>
  </div>
</div>

<!-- SCREEN 3 : KAYIT -->
<div id="s3" class="screen center">
  <h2>Kayƒ±t / Giri≈ü</h2>
  <button onclick="register()">Telefon ile Devam Et</button>
</div>

<!-- SCREEN 4 : ADRES -->
<div id="s4" class="screen" style="padding:20px">
  <h3 id="serviceTitle"></h3>
  <input id="from" placeholder="Nereden (otomatik)" />
  <input id="to" placeholder="Nereye (haritadan se√ß)" />
  <button onclick="finish()" style="margin-top:16px">Devam Et</button>
</div>

<script>
let current=1;
let user=null;
let service=null;
let map, fromMarker, toMarker;

function go(n){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('s'+n).classList.add('active');
  current=n;
  if(n===2) setTimeout(initMap,300);
}

function selectService(s){
  service=s;
  if(!user) go(3);
  else openAddress();
}

function register(){
  user={id:Date.now()};
  document.getElementById('userState').innerText="Kayƒ±tlƒ±";
  openAddress();
}

function openAddress(){
  document.getElementById('serviceTitle').innerText=
    service==='taxi'?'Taksi':service==='courier'?'Kurye':'Transfer';
  go(4);
}

function finish(){
  alert("Akƒ±≈ü burada kilitli. Backend bir sonraki adƒ±m.");
}

function initMap(){
  if(map) return;
  map=L.map('map').setView([40.195,29.06],13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

  setTimeout(()=>map.invalidateSize(),300);

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      let lat=pos.coords.latitude,lng=pos.coords.longitude;
      fromMarker=L.marker([lat,lng]).addTo(map).bindPopup("Mevcut Konum").openPopup();
      map.setView([lat,lng],14);
      document.getElementById('from').value=await reverse(lat,lng);
    });
  }

  map.on('click',async e=>{
    if(toMarker) map.removeLayer(toMarker);
    toMarker=L.marker(e.latlng).addTo(map);
    document.getElementById('to').value=await reverse(e.latlng.lat,e.latlng.lng);
  });
}

async function reverse(lat,lng){
  try{
    let r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    let d=await r.json();
    return d.display_name||lat+","+lng;
  }catch{
    return lat+","+lng;
  }
}
</script>

</body>
</html>
