<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;overflow:hidden}
:root{
  --y:#f5c400;
  --panel:#0f0f10;
  --card:#141416;
  --line:rgba(255,255,255,.12);
  --mut:rgba(255,255,255,.65);
  --mut2:rgba(255,255,255,.42);
  --shadow:0 18px 60px rgba(0,0,0,.55);
}

/* ====== TOPBAR ====== */
.topbar{
  position:fixed;top:10px;left:10px;right:10px;z-index:50;
  height:54px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;
  background:rgba(12,12,14,.72);
  border:1px solid rgba(255,255,255,.10);
  border-radius:18px;
  backdrop-filter:blur(12px);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.brand{display:flex;align-items:center;gap:10px;font-weight:950;letter-spacing:.2px}
.logo{
  width:30px;height:30px;border-radius:10px;
  background:linear-gradient(135deg,#f5c400,#ffd34d);
  box-shadow:0 10px 28px rgba(245,196,0,.22);
  position:relative;overflow:hidden;
}
.logo:after{
  content:"";position:absolute;inset:-40%;
  background:linear-gradient(120deg,rgba(255,255,255,.0),rgba(255,255,255,.25),rgba(255,255,255,.0));
  transform:rotate(25deg);
  animation:shine 3.6s linear infinite;
}
@keyframes shine{0%{transform:translateX(-60%) rotate(25deg)}100%{transform:translateX(60%) rotate(25deg)}}

.iconbtn{
  width:42px;height:42px;border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  color:#fff;font-size:18px;font-weight:900;
  display:flex;align-items:center;justify-content:center;
}
.iconbtn:active{transform:scale(.98)}

/* ====== MAP ====== */
#map{position:fixed;inset:0;z-index:1}
.leaflet-control-container{display:none} /* zoom +/- kapalÄ± */

/* ====== DRAWER MENU ====== */
.drawerMask{
  position:fixed;inset:0;z-index:80;
  background:rgba(0,0,0,.55);
  opacity:0;pointer-events:none;
  transition:opacity .18s ease;
}
.drawer{
  position:fixed;top:10px;right:10px;z-index:90;
  width:min(360px,calc(100vw - 20px));
  border-radius:22px;
  background:rgba(18,18,20,.90);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter:blur(14px);
  box-shadow:var(--shadow);
  transform:translateY(-6px) scale(.98);
  opacity:0;pointer-events:none;
  transition:transform .18s ease, opacity .18s ease;
  overflow:hidden;
}
.drawerHead{
  padding:14px 14px 10px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid rgba(255,255,255,.10);
}
.drawerHead .t{font-weight:950}
.drawerBody{padding:10px}
.drawerItem{
  display:flex;align-items:center;justify-content:space-between;
  gap:10px;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04);
  margin-bottom:10px;
  color:#fff;text-decoration:none;
}
.drawerItem small{color:var(--mut2);font-weight:700}
.drawerItem:active{transform:scale(.99)}
.drawerSep{margin:10px 0 12px;color:var(--mut2);font-size:12px;font-weight:800}

.drawerOpen .drawerMask{opacity:1;pointer-events:auto}
.drawerOpen .drawer{opacity:1;pointer-events:auto;transform:translateY(0) scale(1)}

/* ====== BOTTOM SHEET ====== */
.sheet{
  position:fixed;left:0;right:0;bottom:0;z-index:60;
  height:86vh; /* expanded high watermark */
  transform:translateY(var(--sheetY, 36vh)); /* default HALF */
  transition:transform .18s ease;
  will-change:transform;
}
.sheetInner{
  height:100%;
  background:linear-gradient(180deg, rgba(20,20,22,.92), rgba(9,9,11,.98));
  border-top:1px solid rgba(255,255,255,.10);
  border-top-left-radius:24px;
  border-top-right-radius:24px;
  box-shadow:0 -18px 50px rgba(0,0,0,.55);
  backdrop-filter:blur(12px);
  display:flex;flex-direction:column;
  overflow:hidden;
}
.handleWrap{padding:10px 14px 8px;cursor:grab;touch-action:none}
.handle{
  width:46px;height:5px;border-radius:99px;margin:0 auto;
  background:rgba(255,255,255,.18);
}
.sheetContent{
  padding:10px 14px 14px;
  overflow:hidden;
  display:flex;flex-direction:column;gap:10px;
}

/* compact cards */
.row{display:flex;gap:10px}
.pill{
  flex:1;
  padding:10px 12px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  min-width:0;
}
.tag{font-size:11px;color:var(--mut2);font-weight:800}
.val{font-weight:950;font-size:13px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.tabs{display:flex;gap:10px}
.tab{
  flex:1;text-align:center;
  padding:12px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  font-weight:950;
  user-select:none;
}
.tab.active{
  background:rgba(245,196,0,.14);
  border-color:rgba(245,196,0,.45);
  color:#fff;
}
.metrics{display:flex;gap:10px}
.metric{
  flex:1;
  padding:12px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04)
}
.metric .k{font-size:11px;color:var(--mut2);font-weight:850}
.metric .v{font-size:18px;font-weight:1000;margin-top:4px;letter-spacing:.2px}
.muted{color:var(--mut);font-size:12px;line-height:1.35}
.warn{color:#ffd34d;font-weight:900}

.btn{
  width:100%;padding:14px;border-radius:18px;
  border:0;font-weight:1000;
  background:linear-gradient(135deg,#f5c400,#ffd34d);
  color:#1a1400;
}
.btn[disabled]{opacity:.45}

/* ====== REG MODAL ====== */
.modalMask{
  position:fixed;inset:0;z-index:120;
  background:rgba(0,0,0,.62);
  display:none;align-items:center;justify-content:center;
  padding:18px;
}
.modal{
  width:min(420px,100%);
  border-radius:22px;
  background:rgba(18,18,20,.92);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter:blur(14px);
  box-shadow:var(--shadow);
  overflow:hidden;
}
.modalHead{
  padding:14px 14px 10px;
  border-bottom:1px solid rgba(255,255,255,.10);
  display:flex;align-items:center;justify-content:space-between;
}
.modalHead .t{font-weight:1000}
.modalBody{padding:14px;display:flex;flex-direction:column;gap:10px}
.inp{
  width:100%;padding:12px 12px;border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  color:#fff;outline:none;
}
.modalFoot{padding:0 14px 14px}

/* ====== SEARCHING OVERLAY ====== */
.overlay{
  position:fixed;inset:0;z-index:140;
  display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.52);
  backdrop-filter:blur(10px);
}
.ovCard{
  width:min(520px,calc(100vw - 30px));
  border-radius:26px;
  border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(18,18,20,.88), rgba(10,10,12,.94));
  box-shadow:var(--shadow);
  padding:18px;
}
.badge{
  display:inline-flex;align-items:center;gap:10px;
  padding:10px 12px;border-radius:999px;
  border:1px solid rgba(245,196,0,.38);
  background:rgba(245,196,0,.12);
  font-weight:1000;
}
.pulseDot{
  width:10px;height:10px;border-radius:50%;
  background:var(--y);
  box-shadow:0 0 0 rgba(245,196,0,.55);
  animation:pulse 1.2s ease-in-out infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(245,196,0,.55); transform:scale(.98)}
  70%{box-shadow:0 0 0 18px rgba(245,196,0,0); transform:scale(1)}
  100%{box-shadow:0 0 0 0 rgba(245,196,0,0); transform:scale(.98)}
}
.ovTitle{font-size:18px;font-weight:1000;margin:12px 0 6px}
.ovSub{color:var(--mut);font-size:13px;line-height:1.4}
.ovLine{
  margin-top:14px;
  height:10px;border-radius:999px;
  background:rgba(255,255,255,.06);
  overflow:hidden;
}
.ovLine > i{
  display:block;height:100%;width:38%;
  background:linear-gradient(90deg,rgba(245,196,0,.0),rgba(245,196,0,.7),rgba(245,196,0,.0));
  animation:shimmer 1.1s linear infinite;
}
@keyframes shimmer{0%{transform:translateX(-120%)}100%{transform:translateX(320%)}}

.smallhint{margin-top:10px;color:var(--mut2);font-size:12px;font-weight:800}

/* ====== MAP MARKERS ====== */
.pin{
  width:34px;height:34px;border-radius:12px;
  display:flex;align-items:center;justify-content:center;
  background:rgba(20,20,22,.90);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter:blur(6px);
  box-shadow:0 12px 26px rgba(0,0,0,.40);
  font-size:18px;
}
.pin.pick{border-color:rgba(245,196,0,.45)}
.pin.drop{border-color:rgba(255,255,255,.18)}
.pin .ring{
  position:absolute;inset:-14px;border-radius:999px;
  border:1px solid rgba(245,196,0,.18);
  animation:ring 1.8s ease-out infinite;
}
@keyframes ring{
  0%{transform:scale(.55);opacity:.0}
  25%{opacity:.65}
  100%{transform:scale(1.2);opacity:0}
}
</style>
</head>

<body>

<div class="topbar">
  <div class="brand"><div class="logo"></div>SepetTaxi</div>
  <button class="iconbtn" id="menuBtn" aria-label="MenÃ¼">â‰¡</button>
</div>

<div id="map" aria-label="Harita"></div>

<!-- Drawer -->
<div class="drawerMask" id="drawerMask"></div>
<div class="drawer" id="drawer">
  <div class="drawerHead">
    <div class="t">MenÃ¼</div>
    <button class="iconbtn" id="drawerClose" aria-label="Kapat">âœ•</button>
  </div>
  <div class="drawerBody">
    <a class="drawerItem" href="driver.html"><div><strong>SÃ¼rÃ¼cÃ¼ GiriÅŸi</strong><br><small>Ä°ÅŸ havuzunu gÃ¶r, kabul et</small></div><div>â€º</div></a>
    <a class="drawerItem" href="driver-register.html"><div><strong>SÃ¼rÃ¼cÃ¼ Ol</strong><br><small>BaÅŸvuru formu</small></div><div>â€º</div></a>
    <a class="drawerItem" href="admin.html"><div><strong>Admin</strong><br><small>PIN ile giriÅŸ</small></div><div>â€º</div></a>

    <div class="drawerSep">Bilgilendirme</div>
    <a class="drawerItem" href="legal/hakkimizda.htm"><div><strong>HakkÄ±mÄ±zda</strong><br><small>Åirket ve hizmet</small></div><div>â€º</div></a>
    <a class="drawerItem" href="legal/kvkk.html"><div><strong>KVKK</strong><br><small>AydÄ±nlatma metni</small></div><div>â€º</div></a>
    <a class="drawerItem" href="legal/musteri-sozlesmesi.html"><div><strong>MÃ¼ÅŸteri SÃ¶zleÅŸmesi</strong><br><small>KullanÄ±m ÅŸartlarÄ±</small></div><div>â€º</div></a>
    <a class="drawerItem" href="legal/surucu-sozlesmesi.html"><div><strong>SÃ¼rÃ¼cÃ¼ SÃ¶zleÅŸmesi</strong><br><small>Ã‡alÄ±ÅŸma ÅŸartlarÄ±</small></div><div>â€º</div></a>

    <div class="drawerSep">Destek</div>
    <a class="drawerItem" id="waLink" href="#"><div><strong>WhatsApp</strong><br><small>HÄ±zlÄ± destek</small></div><div>â€º</div></a>
    <a class="drawerItem" id="mailLink" href="#"><div><strong>E-posta</strong><br><small>support@â€¦</small></div><div>â€º</div></a>
  </div>
</div>

<!-- Bottom sheet -->
<div class="sheet" id="sheet">
  <div class="sheetInner">
    <div class="handleWrap" id="handleWrap"><div class="handle"></div></div>

    <div class="sheetContent">
      <div class="row">
        <div class="pill" id="fromPill">
          <div class="tag">Nereden</div>
          <div class="val" id="fromTxt">Konum alÄ±nÄ±yorâ€¦</div>
        </div>
        <div class="pill" id="toPill">
          <div class="tag">Nereye</div>
          <div class="val" id="toTxt">Haritadan seÃ§</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Hizmet">
        <div class="tab active" id="tabTaxi" role="tab" aria-selected="true">Taksi</div>
         <div class="tab" id="tabCourier" onclick="goCourier()">Kurye</div>
      </div>

      <div class="metrics">
        <div class="metric">
          <div class="k">Mesafe</div>
          <div class="v" id="distTxt">â€”</div>
        </div>
        <div class="metric">
          <div class="k">Ãœcret</div>
          <div class="v" id="priceTxt">â€”</div>
        </div>
      </div>

      <div class="muted" id="hint">
        Haritada bir noktaya dokunarak <span class="warn">â€œNereyeâ€</span> seÃ§. Konum otomatik alÄ±nÄ±r.
      </div>

      <button class="btn" id="callBtn" disabled>Ã‡aÄŸÄ±r</button>

      <div class="muted" style="margin-top:2px">
        Not: Ãœcret bilgisi kayÄ±t tamamlandÄ±ktan sonra gÃ¶rÃ¼nÃ¼r. Ä°ÅŸ oluÅŸturma anÄ±nda sistem hesaplamayÄ± arka planda yapar.
      </div>
    </div>
  </div>
</div>

<!-- Register modal -->
<div class="modalMask" id="regMask">
  <div class="modal" role="dialog" aria-modal="true" aria-label="KayÄ±t">
    <div class="modalHead">
      <div class="t">KayÄ±t</div>
      <button class="iconbtn" id="regClose" aria-label="Kapat">âœ•</button>
    </div>
    <div class="modalBody">
      <input class="inp" id="cFirst" placeholder="Ad">
      <input class="inp" id="cLast" placeholder="Soyad">
      <input class="inp" id="cPhone" placeholder="Telefon">
      <div class="muted">Bilgileriniz sadece hizmeti sunmak iÃ§in kullanÄ±lÄ±r.</div>
    </div>
    <div class="modalFoot">
      <button class="btn" id="regOk">Kaydet</button>
    </div>
  </div>
</div>

<!-- Searching overlay -->
<div class="overlay" id="overlay">
  <div class="ovCard">
    <div class="badge"><span class="pulseDot"></span> SÃ¼rÃ¼cÃ¼ aranÄ±yor</div>
    <div class="ovTitle" id="ovTitle">EÅŸleÅŸme yapÄ±lÄ±yorâ€¦</div>
    <div class="ovSub" id="ovSub">YakÄ±ndaki uygun sÃ¼rÃ¼cÃ¼ler kontrol ediliyor. LÃ¼tfen bekleyin.</div>
    <div class="ovLine"><i></i></div>
    <div class="smallhint" id="ovHint">Ä°pucu: Harita canlÄ± takibe otomatik geÃ§eceÄŸiz.</div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const API = "https://script.google.com/macros/s/AKfycbzXbm934CXIjTSL9RxmL8kkCjGERoeiQPDfY-OUk2Lexqqr_UvppoJ2yT0t562aJZdxRg/exec";
const SUPPORT_WHATSAPP = "905555555555"; // kendi numaranla deÄŸiÅŸtir
const SUPPORT_EMAIL = "support@sepettaxi.com"; // kendi mailinle deÄŸiÅŸtir

/* ================== STATE ================== */
let map;
let service = "taxi"; // taxi | courier
let from = null; // {lat,lng, address}
let to = null;   // {lat,lng, address}
let distKm = 0;
let price = 0;

let pickMarker = null;
let dropMarker = null;

let sheetState = "half"; // collapsed | half | expanded
let pendingCallAfterRegister = false;

const $ = (id)=>document.getElementById(id);

/* ================== STORAGE ================== */
function saveCustomer(o){ localStorage.setItem("sepettaxi_customer", JSON.stringify(o)); }
function loadCustomer(){
  try{
    const s = localStorage.getItem("sepettaxi_customer");
    return s ? JSON.parse(s) : null;
  }catch(_){ return null; }
}
function hasCustomer(){
  const c = loadCustomer();
  return !!(c && c.first && c.last && c.phone);
}

/* ================== UI HELPERS ================== */
function setText(id, t){ $(id).textContent = t; }
function openReg(){
  $("regMask").style.display = "flex";
  setTimeout(()=>{ $("cFirst").focus(); }, 50);
}
function closeReg(){ $("regMask").style.display = "none"; }
function openOverlay(){
  $("overlay").style.display = "flex";
}
function closeOverlay(){
  $("overlay").style.display = "none";
}

function setService(next){
  service = next;
  $("tabTaxi").classList.toggle("active", service==="taxi");
  $("tabCourier").classList.toggle("active", service==="courier");
  $("tabTaxi").setAttribute("aria-selected", service==="taxi" ? "true":"false");
  $("tabCourier").setAttribute("aria-selected", service==="courier" ? "true":"false");
  updateEstimate();
}

function updateHint(){
  if(!from){
    $("hint").innerHTML = 'Konum alÄ±nÄ±yorâ€¦ Konum izni vermezsen <span class="warn">â€œNeredenâ€</span> haritada merkeze alÄ±nÄ±r.';
    return;
  }
  if(!to){
    $("hint").innerHTML = 'Haritada bir noktaya dokunarak <span class="warn">â€œNereyeâ€</span> seÃ§.';
    return;
  }
  if(!hasCustomer()){
    $("hint").innerHTML = 'HazÄ±r. <span class="warn">Ã‡aÄŸÄ±r</span> dediÄŸinde kÄ±sa kayÄ±t alacaÄŸÄ±z.';
    return;
  }
  $("hint").textContent = "HazÄ±r. Ã‡aÄŸÄ±r diyebilirsin.";
}
  function goCourier(){
  window.location.href = "courier.html";
}
/* ================== DIST / PRICE ================== */
function haversineKm(a,b){
  const R = 6371;
  const dLat = (b.lat-a.lat)*Math.PI/180;
  const dLng = (b.lng-a.lng)*Math.PI/180;
  const s1 = Math.sin(dLat/2);
  const s2 = Math.sin(dLng/2);
  const q = s1*s1 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
  return 2*R*Math.asin(Math.min(1, Math.sqrt(q)));
}
function computePrice(km, svc){
  // Basit MVP fiyat modeli (backend'e numeric gerek)
  // Taksi: aÃ§Ä±lÄ±ÅŸ 60 + 18/km
  // Kurye: aÃ§Ä±lÄ±ÅŸ 50 + 14/km
  const base = (svc==="taxi") ? 60 : 50;
  const perKm = (svc==="taxi") ? 18 : 14;
  const raw = base + perKm * Math.max(0.5, km);
  return Math.round(raw);
}
function updateEstimate(){
  if(from && to){
    distKm = haversineKm(from,to);
    price = computePrice(distKm, service);

    setText("distTxt", distKm.toFixed(1) + " km");

    if(hasCustomer()){
      setText("priceTxt", price + " â‚º");
    }else{
      setText("priceTxt", "KayÄ±t sonrasÄ±");
    }

    $("callBtn").disabled = false;
  }else{
    distKm = 0; price = 0;
    setText("distTxt","â€”");
    setText("priceTxt","â€”");
    $("callBtn").disabled = true;
  }
  updateHint();
}

/* ================== MAP ================== */
function makeIcon(type){
  const el = document.createElement("div");
  el.className = "pin " + type;
  el.style.position = "relative";
  if(type==="pick"){
    el.innerHTML = '<span class="ring"></span><span>ğŸ“</span>';
  }else{
    el.innerHTML = '<span>ğŸ¯</span>';
  }
  return L.divIcon({ className:"", html: el.outerHTML, iconSize:[34,34], iconAnchor:[17,17] });
}

async function reverseGeocode(lat,lng){
  // Nominatim (MVP). BazÄ± cihazlarda rate-limit olabilir; fallback hazÄ±r.
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}&zoom=18&addressdetails=1`;
  try{
    const r = await fetch(url, { method:"GET" });
    const j = await r.json();
    const name = (j && (j.display_name || (j.name))) ? (j.display_name || j.name) : "";
    if(name) return name;
  }catch(_){}
  return `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

function setPickup(lat,lng,address){
  from = {lat:+lat, lng:+lng, address: address || "Konum"};
  setText("fromTxt", from.address);

  if(pickMarker) pickMarker.remove();
  pickMarker = L.marker([from.lat, from.lng], {icon: makeIcon("pick")}).addTo(map);

  updateEstimate();
}

async function setDrop(lat,lng){
  const addr = await reverseGeocode(lat,lng);
  to = {lat:+lat, lng:+lng, address: addr};
  setText("toTxt", to.address);

  if(dropMarker) dropMarker.remove();
  dropMarker = L.marker([to.lat, to.lng], {icon: makeIcon("drop")}).addTo(map);

  updateEstimate();
}

function initMap(){
  map = L.map("map", { zoomControl:false, attributionControl:false });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  // Default view (Bursa fallback)
  map.setView([40.195, 29.060], 13);

  // Click to set destination
  map.on("click", (ev)=>{
    setSheetState("half");
    setDrop(ev.latlng.lat, ev.latlng.lng);
  });

  // Try geolocation
  if(navigator.geolocation){
    const opt = { enableHighAccuracy:true, timeout:8000, maximumAge:15000 };
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      map.setView([lat,lng], 16);

      const addr = await reverseGeocode(lat,lng);
      setPickup(lat,lng,addr);
    }, ()=>{
      // Permission denied or error
      setText("fromTxt","Konum izni yok");
      updateHint();
    }, opt);
  }else{
    setText("fromTxt","Konum desteklenmiyor");
  }
}

/* ================== SHEET SWIPE (3 STATE) ================== */
function yForState(st){
  // translateY from bottom sheet base (vh)
  // collapsed: mostly hidden (70vh)
  // half: 36vh (map ~50% hissi)
  // expanded: 6vh
  if(st==="collapsed") return "64vh";
  if(st==="expanded") return "6vh";
  return "36vh";
}

function setSheetState(st){
  sheetState = st;
  document.documentElement.style.setProperty("--sheetY", yForState(st));
  // Leaflet size fix
  setTimeout(()=>{ try{ map && map.invalidateSize(); }catch(_){ } }, 220);
}

(function bindSheetDrag(){
  const handle = $("handleWrap");
  const sheet = $("sheet");

  let startY = 0;
  let startTranslatePx = 0;
  let dragging = false;

  function currentTranslatePx(){
    const v = getComputedStyle(sheet).transform;
    if(!v || v==="none") return 0;
    const m = v.match(/matrix\(([^)]+)\)/);
    if(!m) return 0;
    const parts = m[1].split(",").map(s=>parseFloat(s.trim()));
    // matrix(a,b,c,d,tx,ty) -> ty index 5
    return parts[5] || 0;
  }

  function onDown(clientY){
    dragging = true;
    startY = clientY;
    startTranslatePx = currentTranslatePx();
    sheet.style.transition = "none";
  }

  function onMove(clientY){
    if(!dragging) return;
    const dy = clientY - startY;
    let next = startTranslatePx + dy;

    const max = window.innerHeight * 0.68; // collapsed clamp
    const min = window.innerHeight * 0.06; // expanded clamp
    next = Math.max(min, Math.min(max, next));
    sheet.style.transform = `translateY(${next}px)`;
  }

  function snap(){
    // decide nearest state
    const ty = currentTranslatePx();
    const vh = window.innerHeight;
    const v = ty / vh;

    // thresholds tuned
    let st = "half";
    if(v > 0.56) st = "collapsed";
    else if(v < 0.20) st = "expanded";
    else st = "half";

    sheet.style.transition = "transform .18s ease";
    setSheetState(st);
    dragging = false;
  }

  function onUp(){
    if(!dragging) return;
    snap();
  }

  // Pointer events
  handle.addEventListener("pointerdown",(e)=>{
    handle.setPointerCapture(e.pointerId);
    onDown(e.clientY);
  });
  handle.addEventListener("pointermove",(e)=>onMove(e.clientY));
  handle.addEventListener("pointerup",onUp);
  handle.addEventListener("pointercancel",onUp);

  // tap handle cycles
  handle.addEventListener("click", ()=>{
    if(dragging) return;
    if(sheetState==="half") setSheetState("expanded");
    else if(sheetState==="expanded") setSheetState("collapsed");
    else setSheetState("half");
  });
})();

/* ================== BACKEND CALL ================== */
async function post(action, data){
  const body = new URLSearchParams(Object.assign({ action }, data||{}));
  const r = await fetch(API, { method:"POST", body });
  const j = await r.json();
  return j;
}

async function createJob(){
  if(!from || !to){
    updateHint();
    return;
  }

  const c = loadCustomer();
  const payload = {
    service_type: service,
    customer_first: c.first,
    customer_last: c.last,
    customer_phone: c.phone,
    from_address: from.address,
    to_address: to.address,
    pickup_lat: from.lat,
    pickup_lng: from.lng,
    dropoff_lat: to.lat,
    dropoff_lng: to.lng,
    distance_km: distKm.toFixed(2),
    price: String(price)
  };

  openOverlay();

  try{
    const res = await post("createJob", payload);
    if(res && res.ok && res.job_id){
      // short premium pause then redirect
      setTimeout(()=>{ window.location.href = `track.html?job_id=${encodeURIComponent(res.job_id)}`; }, 850);
      return;
    }
    closeOverlay();
    alert("Ä°ÅŸ oluÅŸturulamadÄ±: " + (res && res.message ? res.message : "Bilinmeyen hata"));
  }catch(err){
    closeOverlay();
    alert("AÄŸ hatasÄ±: " + String(err));
  }
}

/* ================== MENU ================== */
function openDrawer(){ document.body.classList.add("drawerOpen"); }
function closeDrawer(){ document.body.classList.remove("drawerOpen"); }

/* ================== INIT ================== */
function boot(){
  // support links
  $("waLink").href = `https://wa.me/${SUPPORT_WHATSAPP}`;
  $("mailLink").href = `mailto:${SUPPORT_EMAIL}`;
  $("mailLink").querySelector("small").textContent = SUPPORT_EMAIL;

  // menu
  $("menuBtn").addEventListener("click", openDrawer);
  $("drawerClose").addEventListener("click", closeDrawer);
  $("drawerMask").addEventListener("click", closeDrawer);

  // service tabs
  $("tabTaxi").addEventListener("click", ()=>setService("taxi"));
  $("tabCourier").addEventListener("click", ()=>setService("courier"));

  // register
  $("regClose").addEventListener("click", ()=>{
    pendingCallAfterRegister = false;
    closeReg();
  });
  $("regOk").addEventListener("click", ()=>{
    const first = $("cFirst").value.trim();
    const last = $("cLast").value.trim();
    const phone = $("cPhone").value.trim();
    if(!first || !last || !phone){
      alert("LÃ¼tfen Ad / Soyad / Telefon gir.");
      return;
    }
    saveCustomer({ first, last, phone });
    closeReg();
    updateEstimate();
    if(pendingCallAfterRegister){
      pendingCallAfterRegister = false;
      createJob();
    }
  });

  // call
  $("callBtn").addEventListener("click", ()=>{
    if(!from || !to) return;
    // ensure map in correct state
    setSheetState("half");

    if(!hasCustomer()){
      pendingCallAfterRegister = true;
      openReg();
      return;
    }
    createJob();
  });

  // initial sheet
  setSheetState("half");
  initMap();
  updateEstimate();
}
boot();
</script>
</body>
</html>
