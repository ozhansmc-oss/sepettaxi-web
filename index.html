<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial;background:#000;color:#fff}

/* HEADER */
header{
  height:56px;background:#000;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;font-size:20px;position:relative
}
header span{color:#f5c400}
#hamburger{
  position:absolute;right:12px;top:10px;
  width:36px;height:36px;border-radius:10px;
  border:1px solid #222;display:flex;
  align-items:center;justify-content:center;
  cursor:pointer
}

/* MAP */
#map{height:32vh}

/* PANEL */
#panel{
  height:calc(68vh - 56px);
  overflow-y:auto;
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
  padding-bottom:80px
}

/* CARD */
.card{
  background:#111;border-radius:14px;
  padding:12px
}

/* SERVICE */
.service-row{display:flex;gap:10px}
.service{
  flex:1;padding:12px;border-radius:14px;
  text-align:center;border:1px solid #222;
  color:#aaa;cursor:pointer
}
.service.active{
  border-color:#f5c400;color:#fff;
  box-shadow:0 0 0 1px rgba(245,196,0,.4)
}
.service.disabled{opacity:.4;pointer-events:none}

/* INPUT */
.input{
  width:100%;padding:12px;
  background:#000;border:1px solid #222;
  border-radius:12px;color:#fff
}

/* STATS */
.stats{display:flex;gap:10px}
.stat{
  flex:1;background:#0f0f0f;
  border-radius:14px;padding:12px;
  text-align:center
}
.stat .lbl{font-size:12px;color:#aaa}
.stat .val{font-size:18px;font-weight:900}

/* CTA */
#cta{
  position:fixed;bottom:0;left:0;right:0;
  background:#000;padding:10px;z-index:100
}
#ctaBtn{
  background:#f5c400;color:#000;
  padding:14px;border-radius:28px;
  text-align:center;font-weight:900;
  cursor:pointer
}
#ctaBtn.disabled{opacity:.4;pointer-events:none}

/* REGISTER */
#register{
  position:fixed;inset:0;
  background:rgba(0,0,0,.9);
  display:none;align-items:center;
  justify-content:center;z-index:200
}
#register .box{
  width:90%;max-width:340px;
  background:#111;border-radius:16px;
  padding:16px
}
.err{color:#ff5c5c;font-size:12px;display:none}

/* DRAWER */
#drawer{
  position:fixed;top:0;right:-260px;
  width:260px;height:100%;
  background:#111;z-index:300;
  padding:16px;transition:.25s
}
#drawer.open{right:0}
.drawer-item{
  padding:14px;border-radius:12px;
  border:1px solid #222;margin-bottom:10px;
  cursor:pointer
}

/* DRIVER CARD */
#driverCard{
  position:fixed;right:10px;bottom:90px;
  background:#0f0f0f;border:1px solid #222;
  border-radius:16px;padding:10px;
  z-index:90
}
</style>
</head>

<body>

<header>
  Sepet<span>Taxi</span>
  <div id="hamburger">â˜°</div>
</header>

<div id="map"></div>

<div id="panel">
  <div class="card">
    <b>Hizmet SeÃ§</b>
    <div class="service-row">
      <div id="svcTaxi" class="service">ðŸš• Taksi</div>
      <div id="svcCourier" class="service">ðŸ“¦ Kurye</div>
    </div>
    <small style="color:#777">Hizmet seÃ§meden Ã¶nce kayÄ±t zorunludur</small>
  </div>

  <div class="card">
    <input id="fromAddr" class="input" placeholder="Nereden" readonly>
  </div>

  <div class="card">
    <input id="toAddr" class="input" placeholder="Nereye (haritadan seÃ§)" readonly>
  </div>

  <div id="courierBox" class="card" style="display:none">
    <input id="pkgType" class="input" placeholder="Paket TÃ¼rÃ¼">
    <input id="recvName" class="input" placeholder="AlÄ±cÄ± AdÄ±">
    <input id="recvPhone" class="input" placeholder="AlÄ±cÄ± Telefon (05...)">
    <input id="note" class="input" placeholder="Not (opsiyonel)">
  </div>

  <div class="stats">
    <div class="stat"><div class="lbl">Mesafe</div><div id="dist" class="val">â€”</div></div>
    <div class="stat"><div class="lbl">Ãœcret</div><div id="price" class="val">â€”</div></div>
  </div>
</div>

<div id="cta">
  <div id="ctaBtn" class="disabled">HÄ°ZMET SEÃ‡</div>
</div>

<div id="driverCard">
  ðŸš— SÃ¼rÃ¼cÃ¼ mÃ¼sÃ¼n?<br>
  <a href="driver.html" style="color:#f5c400">SÃ¼rÃ¼cÃ¼ Ol</a><br>
  <a href="driver-login.html" style="color:#f5c400">SÃ¼rÃ¼cÃ¼ GiriÅŸi</a>
</div>

<div id="register">
  <div class="box">
    <input id="fn" class="input" placeholder="Ad">
    <input id="ln" class="input" placeholder="Soyad">
    <input id="ph" class="input" placeholder="05XXXXXXXXX">
    <label><input type="checkbox" id="kvkk"> KVKK kabul</label>
    <div id="regErr" class="err">Bilgiler hatalÄ±</div>
    <div id="ctaBtnReg" style="margin-top:10px" class="service active">KAYDI TAMAMLA</div>
  </div>
</div>

<div id="drawer">
  <div class="drawer-item" onclick="location.href='driver.html'">ðŸš— SÃ¼rÃ¼cÃ¼ Ol</div>
  <div class="drawer-item" onclick="location.href='driver-login.html'">ðŸ”‘ SÃ¼rÃ¼cÃ¼ GiriÅŸi</div>
</div>

<script>
/* ========= STATE ========= */
let map,fromM,toM,service=null,registered=false;
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

/* ========= MAP ========= */
map=L.map("map").setView([40.195,29.06],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

navigator.geolocation.getCurrentPosition(p=>{
  fromM=L.marker([p.coords.latitude,p.coords.longitude]).addTo(map);
  map.setView([p.coords.latitude,p.coords.longitude],15);
  rev(p.coords.latitude,p.coords.longitude,fromAddr);
});

map.on("click",e=>{
  if(!registered){openRegister();return;}
  toM?toM.setLatLng(e.latlng):toM=L.marker(e.latlng).addTo(map);
  rev(e.latlng.lat,e.latlng.lng,toAddr);
  calc();
});

/* ========= SERVICE ========= */
svcTaxi.onclick=()=>selectService("taxi");
svcCourier.onclick=()=>selectService("courier");

function selectService(t){
  if(!registered){openRegister();return;}
  service=t;
  svcTaxi.classList.toggle("active",t==="taxi");
  svcCourier.classList.toggle("active",t==="courier");
  svcTaxi.classList.toggle("disabled",t==="courier");
  svcCourier.classList.toggle("disabled",t==="taxi");
  courierBox.style.display=t==="courier"?"block":"none";
  ctaBtn.textContent=t==="taxi"?"TAKSÄ° Ã‡AÄžIR":"KURYE Ã‡AÄžIR";
  calc();
}

/* ========= CALC ========= */
function calc(){
  if(!service||!fromM||!toM)return;
  if(service==="courier"){
    if(!pkgType.value||!recvName.value||!/^05\d{9}$/.test(recvPhone.value)){
      ctaBtn.classList.add("disabled");return;
    }
  }
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=h(a.lat,a.lng,b.lat,b.lng);
  dist.textContent=km.toFixed(2)+" km";
  price.textContent=Math.round(service==="taxi"?Math.max(120,60+km*22):Math.max(80,40+km*15))+" TL";
  ctaBtn.classList.remove("disabled");
}

/* ========= CTA ========= */
ctaBtn.onclick=()=>{
  if(ctaBtn.classList.contains("disabled"))return;
  alert("createJob â†’ backend hazÄ±r");
};

/* ========= REGISTER ========= */
function openRegister(){register.style.display="flex";}
ctaBtnReg.onclick=()=>{
  if(fn.value.length<2||ln.value.length<2||!/^05\d{9}$/.test(ph.value)||!kvkk.checked){
    regErr.style.display="block";return;
  }
  registered=true;
  register.style.display="none";
};

/* ========= DRAWER ========= */
hamburger.onclick=()=>drawer.classList.toggle("open");

/* ========= UTIL ========= */
function h(a,b,c,d){
  const R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function rev(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
  .then(r=>r.json()).then(d=>{if(d.display_name)input.value=d.display_name});
}
</script>

</body>
</html>
