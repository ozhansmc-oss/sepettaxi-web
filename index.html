<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SepetTaxi</title>

<!-- ===== LEAFLET ===== -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #000;
  color: #fff;
}

/* ===== LANDING ===== */
#landing {
  height: 100vh;
  background: url("assets/landing.png") center / cover no-repeat;
  display: flex;
  align-items: center;
  justify-content: center;
}
#landing .overlay {
  background: rgba(0,0,0,0.55);
  width: 100%;
  height: 100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
#landing h1 { font-size: 42px; margin-bottom: 24px; }
#landing h1 span { color:#f5c400; }

.primary-btn {
  background:#f5c400;
  color:#000;
  border:none;
  border-radius:28px;
  padding:16px 42px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
}

/* ===== APP ===== */
#app {
  display:none;
  min-height:100vh;
  background:#111;
}

.app-header {
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:bold;
}
.app-header span { color:#f5c400; }

.map-wrap { padding:12px 16px 0 16px; }
#map {
  width:100%;
  height:42vh;
  min-height:260px;
  border-radius:18px;
}

.container { padding:16px; }

.card {
  background:#1b1b1b;
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
}
.label { font-size:14px; opacity:0.7; margin-bottom:6px; }
.input {
  width:100%;
  background:#000;
  border:1px solid #333;
  color:#fff;
  padding:14px;
  border-radius:10px;
  font-size:15px;
}
.row { display:flex; gap:12px; }
.row .card { flex:1; text-align:center; }
.big { font-size:22px; font-weight:bold; }

.call-btn {
  margin-top:16px;
  width:100%;
  background:#f5c400;
  color:#000;
  border:none;
  border-radius:28px;
  padding:18px;
  font-size:18px;
  font-weight:bold;
}
</style>
</head>

<body>

<!-- ===== LANDING ===== -->
<section id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button class="primary-btn" id="startBtn">Başla</button>
  </div>
</section>

<!-- ===== APP ===== -->
<section id="app">
  <div class="app-header">Sepet<span>Taxi</span></div>

  <div class="map-wrap">
    <div id="map"></div>
  </div>

  <div class="container">

    <div class="card">
      <div class="label">Nereden</div>
      <input id="fromInput" class="input" placeholder="Haritadan seçin">
    </div>

    <div class="card">
      <div class="label">Nereye</div>
      <input id="toInput" class="input" placeholder="Haritadan seçin">
    </div>

    <div class="row">
      <div class="card">
        <div class="label">Mesafe</div>
        <div class="big" id="distance">— km</div>
      </div>
      <div class="card">
        <div class="label">Ücret</div>
        <div class="big" id="price">— TL</div>
      </div>
    </div>

    <button class="call-btn">Taksi Çağır</button>
  </div>
</section>

<script>
/* ===== LANDING → APP ===== */
document.getElementById("startBtn").onclick = () => {
  landing.style.display = "none";
  app.style.display = "block";
  setTimeout(initMap, 150);
};

/* ===== FAZ 2 + FAZ 3 ===== */
let map;
let fromMarker = null;
let toMarker = null;
let selecting = "from";

const fromInput = document.getElementById("fromInput");
const toInput   = document.getElementById("toInput");
const distanceEl = document.getElementById("distance");
const priceEl    = document.getElementById("price");

/* ===== FİYAT MODELİ (DEĞİŞTİRİLEBİLİR) ===== */
const PRICING = {
  baseFare: 60,     // açılış
  perKm: 22,        // km başı
  minFare: 120      // minimum
};

function initMap() {
  if (map) return;

  map = L.map("map").setView([41.0082, 28.9784], 12);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  map.invalidateSize();
  map.on("click", onMapClick);

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      map.setView([pos.coords.latitude, pos.coords.longitude], 15);
    });
  }
}

function onMapClick(e) {
  if (selecting === "from") {
    if (fromMarker) map.removeLayer(fromMarker);
    fromMarker = createMarker(e.latlng, "Nereden", fromInput);
    selecting = "to";
  } else {
    if (toMarker) map.removeLayer(toMarker);
    toMarker = createMarker(e.latlng, "Nereye", toInput);
    selecting = "from";
  }
  calculate();
}

function createMarker(latlng, label, inputEl) {
  const marker = L.marker(latlng, { draggable:true }).addTo(map);
  marker.bindPopup(label).openPopup();

  reverseGeocode(latlng, inputEl);

  marker.on("dragend", () => {
    reverseGeocode(marker.getLatLng(), inputEl);
    calculate();
  });

  return marker;
}

function reverseGeocode(latlng, inputEl) {
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}`)
    .then(r => r.json())
    .then(d => { if (d && d.display_name) inputEl.value = d.display_name; })
    .catch(()=>{});
}

/* ===== FAZ 3: MESAFE + ÜCRET ===== */
function calculate() {
  if (!fromMarker || !toMarker) {
    distanceEl.textContent = "— km";
    priceEl.textContent = "— TL";
    return;
  }

  const a = fromMarker.getLatLng();
  const b = toMarker.getLatLng();

  const km = haversine(a.lat, a.lng, b.lat, b.lng);
  const roundedKm = Math.max(0.1, km);

  const price = Math.max(
    PRICING.minFare,
    PRICING.baseFare + (roundedKm * PRICING.perKm)
  );

  distanceEl.textContent = roundedKm.toFixed(2) + " km";
  priceEl.textContent = Math.round(price) + " TL";
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI/180) *
    Math.cos(lat2 * Math.PI/180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);

  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}
</script>

</body>
</html>
