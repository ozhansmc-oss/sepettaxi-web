<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* (Senin CSS'in aynen) */
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--line:#222;--muted:#9a9a9a;--card1:#141414;--card2:#0f0f0f}
#landing{position:fixed;inset:0;background:#000 url("assets/landing.png") center/cover no-repeat;z-index:1000}
#landing .overlay{position:absolute;inset:0;background:rgba(0,0,0,.65);display:flex;flex-direction:column;align-items:center;justify-content:center}
#landing h1{font-size:40px;margin:0 0 18px 0;letter-spacing:.3px}
#landing span{color:var(--y)}
#landing button{background:var(--y);color:#000;border:0;border-radius:28px;padding:14px 46px;font-size:17px;font-weight:900;box-shadow:0 10px 30px rgba(245,196,0,.40)}
#app{display:none;height:100%}
header{height:56px;background:#000;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;border-bottom:1px solid var(--line)}
header span{color:var(--y)}
#map{height:32vh}
@media(min-width:768px){ #map{height:26vh} }
#panel{height:calc(68vh - 56px);padding:10px;display:flex;flex-direction:column;gap:8px;padding-bottom:220px}
@media(min-width:768px){ #panel{height:calc(74vh - 56px)} }
.card{background:linear-gradient(180deg,var(--card1),var(--card2));border-radius:14px;padding:10px;box-shadow:0 8px 20px rgba(0,0,0,.60);border:1px solid rgba(255,255,255,.04)}
.cardTitle{display:flex;align-items:center;justify-content:space-between}
.badge{font-size:11px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px}
.serviceRow{display:flex;gap:8px;margin-top:8px}
.serviceBtn{flex:1;padding:11px;border-radius:12px;text-align:center;font-size:13px;border:1px solid var(--line);color:#bdbdbd;background:#0b0b0b;user-select:none;transition:.18s}
.serviceBtn.active{border-color:var(--y);color:#fff;background:rgba(245,196,0,.10);box-shadow:0 0 0 1px rgba(245,196,0,.25)}
.input{width:100%;padding:11px 12px;border-radius:12px;border:1px solid #1f1f1f;background:#000;color:#fff;font-size:13px}
.input::placeholder{color:#666}
.helper{font-size:11px;color:var(--muted);margin-top:6px;line-height:1.3}
.miniBtn{border:1px solid var(--line);background:#0b0b0b;color:#ddd;border-radius:999px;padding:6px 10px;font-size:11px;user-select:none;white-space:nowrap}
.miniBtn:active{transform:scale(.98)}
#courierBox{display:none}
.sep{height:8px}
.statsWrap{margin-top:auto;background:linear-gradient(180deg,rgba(0,0,0,0),#000);padding-top:10px}
.stats{display:flex;gap:8px}
.stat{flex:1;background:#0b0b0b;border-radius:14px;padding:12px;text-align:center;border:1px solid rgba(255,255,255,.06)}
.stat .lbl{font-size:11px;color:#aaa}
.stat .val{font-size:18px;font-weight:900;margin-top:4px}
#stickyBar{position:fixed;left:0;right:0;bottom:0;padding:10px;background:linear-gradient(180deg,rgba(0,0,0,.55),#000);z-index:200}
#ctaBtn{border-radius:30px;padding:16px;text-align:center;font-weight:900;user-select:none;transition:.12s}
#ctaBtn.enabled{background:var(--y);color:#000;box-shadow:0 12px 30px rgba(245,196,0,.45)}
#ctaBtn.disabled{background:#2a2a2a;color:#999;box-shadow:none}
#ctaBtn:active{transform:scale(.98)}
#ctaSub{margin-top:6px;text-align:center;font-size:11px;color:#9a9a9a}
#driverCta{position:fixed;bottom:92px;left:50%;transform:translateX(-50%);background:#0f0f0f;border:1px solid var(--line);border-radius:18px;padding:5px 12px;font-size:11px;opacity:.65;z-index:150}
#driverCta a{color:#aaa;text-decoration:none}
#driverCta:hover{opacity:.85}
#register{position:fixed;inset:0;background:rgba(0,0,0,.90);display:none;align-items:center;justify-content:center;z-index:500}
#register .box{width:88%;max-width:340px;background:#0f0f0f;border-radius:16px;padding:14px;box-shadow:0 20px 50px rgba(0,0,0,.80);border:1px solid rgba(255,255,255,.06)}
.err{color:#ff5c5c;font-size:12px;display:none;margin-top:8px}
.app-locked{filter:blur(4px) brightness(.6);pointer-events:none;transition:.2s}
#searching{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:600}
#searching .txt{font-size:18px;font-weight:900}
#dots::after{content:"";animation:dots 1.4s infinite}
@keyframes dots{0%{content:""}33%{content:"."}66%{content:".."}100%{content:"..."}}
#toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:#111;border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:999px;font-size:12px;color:#ddd;display:none;z-index:800;box-shadow:0 10px 24px rgba(0,0,0,.65)}
#toast b{color:var(--y)}
</style>
</head>

<body>
<div id="toast"></div>

<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button onclick="start()">BA≈ûLA</button>
  </div>
</div>

<div id="app">
  <header>Sepet<span>Taxi</span></header>
  <div id="map"></div>

  <div id="panel">
    <div class="card">
      <div class="cardTitle">
        <b>Hizmet Se√ß</b>
        <div id="regBadge" class="badge">Kayƒ±t: Bekliyor</div>
      </div>
      <div class="serviceRow">
        <div id="svcTaxi" class="serviceBtn" onclick="pickService('taxi')">üöï Taksi</div>
        <div id="svcCourier" class="serviceBtn" onclick="pickService('courier')">üì¶ Kurye</div>
      </div>
      <div class="helper">Haritada varƒ±≈ü noktasƒ±na dokunarak ‚ÄúNereye‚Äù se√ß.</div>
    </div>

    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <input id="fromAddr" class="input" readonly placeholder="Nereden (konum alƒ±nƒ±yor‚Ä¶)">
        <div class="miniBtn" onclick="refreshLocation()">Konumu yenile</div>
      </div>
    </div>

    <div class="card">
      <input id="toAddr" class="input" readonly placeholder="Nereye (haritaya dokun)">
    </div>

    <div id="courierBox" class="card">
      <input id="pkgType" class="input" placeholder="Paket T√ºr√º (zorunlu)">
      <div class="sep"></div>
      <input id="rcvName" class="input" placeholder="Alƒ±cƒ± Adƒ± (zorunlu)">
      <div class="sep"></div>
      <input id="rcvPhone" class="input" placeholder="Alƒ±cƒ± Telefon (05XXXXXXXXX)" maxlength="11">
      <div class="helper">Kurye i√ßin paket, alƒ±cƒ± adƒ± ve 11 haneli telefon zorunludur.</div>
    </div>

    <div class="statsWrap">
      <div class="stats">
        <div class="stat">
          <div class="lbl">Mesafe</div>
          <div id="dist" class="val">‚Äî</div>
        </div>
        <div class="stat">
          <div class="lbl">√úcret</div>
          <div id="price" class="val">‚Äî</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="stickyBar">
  <div id="ctaBtn" class="disabled" onclick="ctaClick()">√áAƒûIR</div>
  <div id="ctaSub">Hizmet se√ß, haritadan varƒ±≈ü noktasƒ± belirle.</div>
</div>

<div id="driverCta">üöó <a href="driver.html">S√ºr√ºc√º m√ºs√ºn?</a></div>

<div id="searching">
  <div class="txt">S√ºr√ºc√º aranƒ±yor<span id="dots"></span></div>
  <div style="font-size:12px;color:#888;margin-top:6px">L√ºtfen bekleyin</div>
</div>

<div id="register">
  <div class="box">
    <div style="font-weight:900;margin-bottom:10px">Kayƒ±t</div>
    <input id="fn" class="input" placeholder="Ad">
    <div class="sep"></div>
    <input id="ln" class="input" placeholder="Soyad">
    <div class="sep"></div>
    <input id="ph" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <div style="height:10px"></div>
    <label style="font-size:12px;color:#aaa;display:flex;gap:8px;align-items:flex-start">
      <input type="checkbox" id="kvkk" style="margin-top:2px">
      KVKK kabul ediyorum.
    </label>
    <div id="regErr" class="err">Bilgiler hatalƒ±. L√ºtfen kontrol et.</div>

    <div style="margin-top:12px">
      <div id="regBtn" style="background:var(--y);color:#000;border-radius:28px;padding:14px;text-align:center;font-weight:900;user-select:none" onclick="saveUser()">
        KAYDI TAMAMLA
      </div>
    </div>
  </div>
</div>

<!-- =========================================================
     LOG.JS (INLINE) ‚Äì LOCKED
========================================================= -->
<script>
/*************************************************
 * SepetTaxi ‚Äì LOG & DEBUG CORE
 * Version: 1.0 (LOCKED)
 *************************************************/
(function(){
  const LOG_LEVEL = { INFO:'INFO', WARN:'WARN', ERROR:'ERROR', FLOW:'FLOW' };
  const DEBUG_ENABLED = true;

  function logTime(){ return new Date().toISOString(); }

  function log(level, tag, message, data){
    if(!DEBUG_ENABLED) return;
    const prefix = `[SepetTaxi][${level}][${tag}]`;
    const extra = (data !== undefined && data !== null) ? data : '';

    if(level === LOG_LEVEL.ERROR) console.error(prefix, message, extra);
    else if(level === LOG_LEVEL.WARN) console.warn(prefix, message, extra);
    else console.log(prefix, message, extra);
  }

  window.logInfo = (tag, message, data)=>log(LOG_LEVEL.INFO, tag, message, data);
  window.logWarn = (tag, message, data)=>log(LOG_LEVEL.WARN, tag, message, data);
  window.logError = (tag, message, data)=>log(LOG_LEVEL.ERROR, tag, message, data);
  window.logFlow = (tag, message, data)=>log(LOG_LEVEL.FLOW, tag, message, data);

  // Global error capture (minimum, debug i√ßin faydalƒ±)
  window.addEventListener('error', (e)=>{
    window.logError('GLOBAL', 'window.onerror', { message:e.message, filename:e.filename, lineno:e.lineno, colno:e.colno, error:String(e.error||'') });
  });
  window.addEventListener('unhandledrejection', (e)=>{
    window.logError('GLOBAL', 'unhandledrejection', { reason: String(e.reason||'') });
  });
})();
</script>

<script>
/* =========================================================
   CONFIG
========================================================= */

// BACKEND_URL: √∂nce window.SEPT?.BACKEND_URL varsa onu kullan, yoksa sabit URL'ye d√º≈ü
const BACKEND_URL =
  (window.SEPT && window.SEPT.BACKEND_URL) ||
  "https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const POLL_MS = 3000;
const POLL_TIMEOUT_MS = 90000;

let map, fromM, toM;
let service=null, registered=false, user=null;
let jobId=null, pollTimer=null, pollStartedAt=0;
let isSearching=false;
let lastKm = 0;
let lastPrice = 0;

const $ = (id)=>document.getElementById(id);

logFlow('INIT', 'index.html loaded', { BACKEND_URL });

function toast(msg){
  const t=$("toast");
  t.innerHTML=msg;
  t.style.display="block";
  clearTimeout(toast._tm);
  toast._tm=setTimeout(()=>t.style.display="none",2200);
}

function showSearching(){
  $("searching").style.display="flex";
  isSearching=true;
  $("ctaBtn").className="disabled";
  logFlow('FLOW', 'Searching screen shown');
}
function hideSearching(){
  $("searching").style.display="none";
  isSearching=false;
  setCtaState();
  logFlow('FLOW', 'Searching screen hidden');
}

function courierValid(){
  const a=$("pkgType").value.trim().length>=2;
  const b=$("rcvName").value.trim().length>=2;
  const c=/^05\d{9}$/.test($("rcvPhone").value.trim());
  return a&&b&&c;
}

function canCall(){
  if(!registered) return false;
  if(!service) return false;
  if(!fromM || !toM) return false;
  if(service==="courier" && !courierValid()) return false;
  if(isSearching) return false;
  return true;
}

function setCtaState(){
  const ok = canCall();
  const btn = $("ctaBtn");
  btn.className = ok ? "enabled" : "disabled";
  btn.textContent = service ? (service==="taxi" ? "TAKSƒ∞ √áAƒûIR" : "KURYE √áAƒûIR") : "√áAƒûIR";

  const sub = $("ctaSub");
  if(isSearching) sub.textContent = "S√ºr√ºc√º aranƒ±yor‚Ä¶";
  else if(!registered) sub.textContent = "Devam etmek i√ßin kayƒ±t gerekli.";
  else if(!service) sub.textContent = "Hizmet se√ß.";
  else if(!fromM) sub.textContent = "Konum alƒ±nƒ±yor‚Ä¶";
  else if(!toM) sub.textContent = "Haritadan varƒ±≈ü noktasƒ± se√ß.";
  else if(service==="courier" && !courierValid()) sub.textContent = "Kurye bilgilerini tamamla.";
  else sub.textContent = "√áaƒüƒ±r‚Äôa basarak talep olu≈ütur.";
}

function start(){
  $("landing").style.display="none";
  $("app").style.display="block";
  logFlow('INIT', 'Start clicked -> app shown');
  initMap();
  setCtaState();
}

function initMap(){
  logFlow('MAP', 'Map init start');
  map = L.map("map",{zoomControl:false}).setView([41,29],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  refreshLocation();

  map.on("click",(e)=>{
    logInfo('MAP', 'Map click -> set destination', { lat:e.latlng.lat, lng:e.latlng.lng });
    toM ? toM.setLatLng(e.latlng) : (toM=L.marker(e.latlng).addTo(map));
    reverse(e.latlng.lat,e.latlng.lng,$("toAddr"));
    calc();
    setCtaState();
  });
}

function refreshLocation(){
  logFlow('GPS', 'refreshLocation called');
  if(!navigator.geolocation){ toast("Konum desteklenmiyor"); logWarn('GPS','Geolocation not supported'); return; }

  navigator.geolocation.getCurrentPosition(p=>{
    const {latitude,longitude}=p.coords;
    logInfo('GPS', 'Location acquired', { latitude, longitude, accuracy:p.coords.accuracy });

    fromM ? fromM.setLatLng([latitude,longitude]) : (fromM=L.marker([latitude,longitude]).addTo(map));
    map.setView([latitude,longitude],15);
    reverse(latitude,longitude,$("fromAddr"));
    calc();
    setCtaState();
  },(err)=>{
    $("fromAddr").placeholder="Konum izni gerekli";
    toast("Konum izni verilmeli");
    logWarn('GPS', 'Location failed', { code: err && err.code, message: err && err.message });
    setCtaState();
  },{enableHighAccuracy:true,timeout:8000,maximumAge:5000});
}

function pickService(t){
  if(isSearching) return;
  if(!registered){ logInfo('USER','Service pick blocked: not registered'); openRegister(); return; }
  service=t;

  $("svcTaxi").classList.toggle("active",t==="taxi");
  $("svcCourier").classList.toggle("active",t==="courier");
  $("courierBox").style.display = (t==="courier") ? "block" : "none";

  logInfo('USER', 'Service selected', { service:t });

  calc();
  setCtaState();
  toast(`<b>${t==="taxi"?"Taksi":"Kurye"}</b> se√ßildi`);
}

["pkgType","rcvName","rcvPhone"].forEach(id=>{
  const el=$(id);
  el.addEventListener("input",()=>{
    if(id==="rcvPhone"){
      el.value = el.value.replace(/\D/g,"").slice(0,11);
    }
    calc(); setCtaState();
  });
});

function openRegister(){
  if(isSearching) return;
  $("app").classList.add("app-locked");
  $("register").style.display="flex";
  $("regErr").style.display="none";
  logFlow('FLOW', 'Register modal opened');
}
function closeRegister(){
  $("register").style.display="none";
  $("app").classList.remove("app-locked");
  logFlow('FLOW', 'Register modal closed');
}
function saveUser(){
  const fn=$("fn").value.trim();
  const ln=$("ln").value.trim();
  const ph=$("ph").value.trim();

  if(fn.length<2 || ln.length<2 || !/^05\d{9}$/.test(ph) || !$("kvkk").checked){
    $("regErr").style.display="block";
    logWarn('USER', 'Register validation failed', { fn_len:fn.length, ln_len:ln.length, phone:ph, kvkk:$("kvkk").checked });
    return;
  }
  user={name:fn+" "+ln,phone:ph};
  registered=true;

  $("regBadge").textContent="Kayƒ±t: Tamam";
  $("regBadge").style.color="#ddd";
  $("regBadge").style.borderColor="rgba(245,196,0,.35)";

  closeRegister();
  toast("Kayƒ±t tamamlandƒ±");
  logInfo('USER', 'Registered', { user });
  setCtaState();
}

function calc(){
  if(!service || !fromM || !toM) return;
  const a=fromM.getLatLng(), b=toM.getLatLng();
  const km = hav(a.lat,a.lng,b.lat,b.lng);
  lastKm = km;

  $("dist").textContent = km.toFixed(2) + " km";

  const pr = (service==="taxi")
    ? Math.max(120, 60 + km*22)
    : Math.max(80,  40 + km*15);

  lastPrice = Math.round(pr);
  $("price").textContent = lastPrice + " TL";

  logFlow('STATE', 'Pricing updated', { service, km: Number(km.toFixed(3)), price:lastPrice });
}

function ctaClick(){
  if(isSearching) return;
  if(!canCall()){
    if(!registered){ openRegister(); return; }
    toast("Eksikleri tamamla");
    logWarn('USER', 'CTA blocked: missing requirements', { registered, service, hasFrom:!!fromM, hasTo:!!toM, courierValid:(service==="courier"?courierValid():null) });
    return;
  }
  logInfo('USER', 'CTA clicked -> createJob');
  createJob();
}

async function createJob(){
  try{
    if(isSearching) return;
    showSearching();

    const payload={
      action:"createJob",
      service,
      pickup_address:$("fromAddr").value || "",
      pickup_lat:fromM.getLatLng().lat,
      pickup_lng:fromM.getLatLng().lng,
      dropoff_address:$("toAddr").value || "",
      dropoff_lat:toM.getLatLng().lat,
      dropoff_lng:toM.getLatLng().lng,
      customer_name:user.name,
      customer_phone:user.phone,
      distance_km:lastKm,
      price:lastPrice
    };

    if(service==="courier"){
      payload.receiver_name=$("rcvName").value.trim();
      payload.receiver_phone=$("rcvPhone").value.trim();
      payload.package_type=$("pkgType").value.trim();
    }

    logFlow('API', 'createJob POST', payload);

    const res=await fetch(BACKEND_URL,{
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const data=await res.json();
    logFlow('API', 'createJob response', data);

    if(!data || !data.job_id) throw new Error("createJob: job_id yok");

    jobId=data.job_id;
    toast("Talep olu≈üturuldu");
    logInfo('FLOW', 'Job created', { jobId });

    pollStartedAt=Date.now();
    clearInterval(pollTimer);
    pollTimer=setInterval(checkJob,POLL_MS);

  }catch(e){
    clearInterval(pollTimer);
    jobId=null;
    hideSearching();
    toast("Talep olu≈üturulamadƒ±");
    logError('API', 'createJob failed', { error: String(e && e.message ? e.message : e), e });
  }
}

async function checkJob(){
  try{
    if(!jobId) return;

    if(Date.now()-pollStartedAt > POLL_TIMEOUT_MS){
      clearInterval(pollTimer);
      const oldJob = jobId;
      jobId=null;
      hideSearching();
      toast("S√ºr√ºc√º bulunamadƒ±. Tekrar dene.");
      logWarn('FLOW', 'Search timeout', { jobId: oldJob, timeout_ms: POLL_TIMEOUT_MS });
      return;
    }

    const r=await fetch(`${BACKEND_URL}?action=checkJob&job_id=${encodeURIComponent(jobId)}`);
    const d=await r.json();

    if(d && d.status){
      logFlow('API', 'checkJob status', { jobId, status:d.status });
    }

    if(d && (d.status==="assigned" || d.status==="on_route")){
      clearInterval(pollTimer);
      const goJob = jobId;
      jobId=null;
      hideSearching();
      logInfo('FLOW', 'Assigned -> redirect track', { jobId: goJob, status:d.status });
      location.href=`track.html?job_id=${encodeURIComponent(goJob)}`;
    }
  }catch(e){
    // transient: ignore but log as debug
    logWarn('API', 'checkJob transient error', { error:String(e && e.message ? e.message : e) });
  }
}

function hav(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function reverse(lat,lng,input){
  logFlow('API', 'reverse geocode', { lat, lng });
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
    .then(r=>r.json())
    .then(d=>{
      if(d && d.display_name){
        input.value=d.display_name;
        logInfo('API', 'reverse geocode ok', { target: input.id, display_name: d.display_name });
      }
    })
    .catch((e)=>{
      logWarn('API', 'reverse geocode failed', { error:String(e) });
    });
}
</script>

<script>
(function () {
  const host = window.location.hostname.toLowerCase();
  const path = window.location.pathname;

  // admin subdomain
  if (host.startsWith("admin.") && !path.includes("admin.html")) {
    logFlow('FLOW', 'Domain route -> admin.html', { host, path });
    window.location.replace("/admin.html");
    return;
  }

  // driver subdomain
  if (host.startsWith("driver.") && !path.includes("driver.html")) {
    logFlow('FLOW', 'Domain route -> driver.html', { host, path });
    window.location.replace("/driver.html");
    return;
  }

  // root domain (www dahil)
  if (
    (host === "sepettaxi.com" || host === "www.sepettaxi.com") &&
    path !== "/" &&
    !path.includes("index.html")
  ) {
    logFlow('FLOW', 'Domain route -> index.html', { host, path });
    window.location.replace("/index.html");
    return;
  }
})();
</script>

</body>
</html>
