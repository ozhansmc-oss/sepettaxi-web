<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* === CSS AYNI, DOKUNMADIM === */
*{box-sizing:border-box}
:root{
  --y:#f5c400;--bg:#050506;--panel:#0f0f10;--card:#141416;
  --line:rgba(255,255,255,.10);--mut:rgba(255,255,255,.65);
  --mut2:rgba(255,255,255,.42);--good:#31d07b;--bad:#ff3b3b;
}
html,body{height:100%;margin:0;font-family:system-ui;background:#000;color:#fff;overflow:hidden}
#map{position:absolute;left:0;right:0;top:62px;height:calc(50vh - 31px);z-index:1;pointer-events:auto}
</style>
</head>

<body>

<div id="landing"><button id="startBtn">Ba≈üla</button></div>
<div id="map"></div>

<div class="modalBack" id="regBack">
  <div class="modal">
    <h3>Zorunlu Kayƒ±t</h3>
    <input id="rFirst" placeholder="Ad">
    <input id="rLast" placeholder="Soyad">
    <input id="rPhone" placeholder="Telefon">
    <button id="regOk">Devam Et</button>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const API = "https://script.google.com/macros/s/AKfycby1ekP3NTaDt0AtRiQG3CrA4iiz9MYLSsWko4mIPsjdUwBWbAJpCp-k250W3O_GnoBxzg/exec";

/* ========= STATE ========= */
let map;
let pickup=null, drop=null;
let pickupMarker=null, dropMarker=null;
let selecting="pickup";
let serviceType="";
let customer = loadCustomer();

/* ========= START ========= */
document.getElementById("startBtn").onclick = ()=>{
  document.getElementById("landing").style.display="none";
  initMap();
};

/* ========= MAP ========= */
function initMap(){
  map = L.map("map",{zoomControl:false}).setView([41.015,28.979],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  map.on("click", async (e)=>{
    const {lat,lng} = e.latlng;

    if(!serviceType){
      alert("√ñnce Taksi veya Kurye se√ßin");
      return;
    }

    if(!customer){
      showReg();
      // ‚ùó return YOK ‚Üí se√ßim devam eder
    }

    const addr = await reverseGeocode(lat,lng);

    if(selecting==="pickup"){
      pickup={lat,lng,address:addr};
      if(pickupMarker) map.removeLayer(pickupMarker);
      pickupMarker=L.marker([lat,lng]).addTo(map);
      selecting="drop";
    }else{
      drop={lat,lng,address:addr};
      if(dropMarker) map.removeLayer(dropMarker);
      dropMarker=L.marker([lat,lng]).addTo(map);
      selecting="pickup";
    }
  });
}

/* ========= REGISTER ========= */
function showReg(){
  document.getElementById("regBack").style.display="flex";
}
function hideReg(){
  document.getElementById("regBack").style.display="none";
}
document.getElementById("regOk").onclick = doRegister;

async function doRegister(){
  const first=rFirst.value.trim();
  const last=rLast.value.trim();
  const phone=rPhone.value.trim();
  if(!first||!last||!phone){alert("Eksik bilgi");return;}

  const res = await postJSON({action:"registerCustomer",first,last,phone});
  if(!res.ok){alert("Kayƒ±t hatasƒ±");return;}

  customer={customer_id:res.customer_id,first,last,phone};
  localStorage.setItem("sepettaxi_customer",JSON.stringify(customer));
  hideReg();

  // üîë KALDIƒûI YERDEN DEVAM
  if(pickup && !drop) alert("≈ûimdi NEREYE se√ßin");
  if(!pickup) alert("Haritadan NEREDEN se√ßin");
}

/* ========= HELPERS ========= */
function loadCustomer(){
  try{
    return JSON.parse(localStorage.getItem("sepettaxi_customer"));
  }catch(e){return null;}
}
async function reverseGeocode(lat,lng){
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
  const j=await r.json();
  return j.display_name || `${lat},${lng}`;
}
async function postJSON(body){
  const r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
  return await r.json();
}
</script>
</body>
</html>
