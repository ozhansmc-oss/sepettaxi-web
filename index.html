<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="config.js"></script>
<script src="log.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--panel:#0f0f0f;--line:#222}

/* HEADER */
header{
  height:56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;border-bottom:1px solid var(--line)
}
header b span{color:var(--y)}
.icon{font-size:18px;cursor:pointer}

/* MAP */
#map{height:45vh}

/* PANEL */
#panel{
  height:calc(55vh - 56px);
  background:#000;
  border-top:1px solid var(--line);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  overflow:auto
}

.cards{display:flex;gap:8px}
.card{
  flex:1;
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:14px;
  padding:10px;
  text-align:center;
  font-weight:700;
  font-size:14px;
  cursor:pointer
}
.card.active{border-color:var(--y)}

.input{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid var(--line);
  background:#000;color:#fff
}
.small{font-size:11px;color:#aaa}

/* CTA */
#cta{
  margin-top:auto;
  padding:14px;
  border-radius:16px;
  background:var(--y);
  color:#000;
  text-align:center;
  font-weight:900;
  display:none;
  cursor:pointer
}
</style>
</head>

<body>

<header>
  <div class="icon">â˜°</div>
  <b>Sepet<span>Taxi</span></b>
  <div class="icon" id="driverBtn">ðŸš—</div>
</header>

<div id="map"></div>

<div id="panel">

  <div class="cards">
    <div class="card active" id="svcTaxi">ðŸš• Taksi</div>
    <div class="card" id="svcCourier">ðŸ›µ Kurye</div>
  </div>

  <!-- KAYIT -->
  <div id="registerCard">
    <input id="custName" class="input" placeholder="Ad Soyad">
    <div style="height:6px"></div>
    <input id="custPhone" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <div class="small">Yeni mÃ¼ÅŸteriler iÃ§in zorunlu</div>
  </div>

  <input id="fromAddr" class="input" placeholder="Nereden">
  <input id="toAddr" class="input" placeholder="Nereye">

  <div class="small">
    <span id="km">â€”</span> km Â· <span id="price">â€”</span> TL
  </div>

  <div id="cta">Taksi Ã‡aÄŸÄ±r</div>
</div>

<script>
/* STATE */
let service="taxi";
let from=null,to=null,km=0,price=0;

/* MAP */
const map=L.map("map",{zoomControl:false});
L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19}).addTo(map);
navigator.geolocation.getCurrentPosition(p=>{
  map.setView([p.coords.latitude,p.coords.longitude],15);
});

/* UI */
const $=id=>document.getElementById(id);

$("svcTaxi").onclick=()=>selectSvc("taxi");
$("svcCourier").onclick=()=>selectSvc("courier");

function selectSvc(s){
  service=s;
  $("svcTaxi").classList.toggle("active",s==="taxi");
  $("svcCourier").classList.toggle("active",s==="courier");
  if(s==="courier"){
    if(!from||!to){alert("Ã–nce rota seÃ§iniz");return;}
    localStorage.setItem("st_temp_route",JSON.stringify({from,to,km,price}));
    location.href="courier.html";
  }
}

/* CTA GUARD */
function checkReady(){
  const name=$("custName").value.trim();
  const phone=$("custPhone").value.replace(/\D/g,"");
  const ok = service==="taxi" && from && to && km>0 && price>0
    && name.length>2 && /^05\d{9}$/.test(phone);
  $("cta").style.display = ok ? "block" : "none";
}

/* CTA */
$("cta").onclick=async()=>{
  const payload={
    action:"createJob",
    service_type:"taxi",
    customer_first:$("custName").value.trim(),
    customer_phone:$("custPhone").value.replace(/\D/g,""),
    from_lat:from.lat,from_lng:from.lng,
    to_lat:to.lat,to_lng:to.lng,
    distance_km:km,
    price_brut:price
  };
  $("cta").textContent="GÃ¶nderiliyor...";
  const r=await fetch(SEPT.BACKEND_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify(payload)
  });
  const d=await r.json();
  if(d&&d.ok&&d.job_id){
    location.href="track.html?job_id="+d.job_id;
  }else{
    alert("Ã‡aÄŸrÄ± baÅŸarÄ±sÄ±z");
  }
};
</script>
</body>
</html>
