<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SepetTaxi – MVP</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --fg:#e9eef5;
      --muted:#9fb0c3;
      --line:rgba(255,255,255,.12);
      --card:rgba(15,22,32,.90);
      --shadow:0 14px 38px rgba(0,0,0,.45);
      --r:18px;

      --yellow:#f7c600;
      --danger:#ff5a6a;
      --ok:#43d17a;

      --btn:#ffffff;
      --btnText:#0b0f14;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      overflow:hidden; /* scroll yok (kilit) */
    }

    /* Screens */
    .screen{position:fixed; inset:0; display:none; overflow:hidden;}
    .screen.active{display:flex;}

    /* Landing (sadece görsel) */
    #landing{
      width:100%; height:100%;
      background: url("./assets/landing.png") center center / cover no-repeat;
      display:flex; align-items:flex-end; justify-content:center;
      padding:18px;
    }
    .landingCta{
      width:min(520px, 100%);
      background: rgba(15,22,32,.35);
      border:1px solid var(--line);
      border-radius: 22px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    button{
      appearance:none; border:none; cursor:pointer;
      border-radius: 16px;
      padding:14px 14px;
      font-weight:900;
      font-size:15px;
      line-height:1;
    }
    button:disabled{opacity:.45; cursor:not-allowed;}
    .btnPrimary{background:var(--btn); color:var(--btnText); width:100%;}
    .btnGhost{background:transparent; color:var(--fg); border:1px solid var(--line);}

    /* App Layout */
    .app{width:100%; height:100%; display:flex; flex-direction:column;}
    .topbar{
      height:54px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--line);
      background: rgba(11,15,20,.70);
      backdrop-filter: blur(10px);
      flex:0 0 auto;
    }
    .brand{font-weight:950; letter-spacing:-.2px}
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      white-space:nowrap;
      display:flex; align-items:center; gap:8px;
    }
    .dot{width:7px; height:7px; border-radius:999px; background:rgba(255,255,255,.25);}
    .dot.ok{background:var(--ok);}
    .dot.warn{background:var(--yellow);}
    .dot.bad{background:var(--danger);}

    .mapWrap{flex: 1 1 auto; min-height:0;}
    #map{width:100%; height:100%; background:#0a0f16;}

    /* Bottom Panel (scroll yok, kompakt) */
    .panel{
      flex:0 0 auto;
      padding:12px 12px 14px;
      border-top:1px solid var(--line);
      background: rgba(11,15,20,.75);
      backdrop-filter: blur(10px);
    }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:12px;
    }

    .row{display:flex; gap:10px; align-items:center;}
    .row.between{justify-content:space-between;}
    .muted{color:var(--muted); font-size:12px; line-height:1.35;}

    /* Services */
    .services{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .svc{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding:12px;
      cursor:pointer;
      user-select:none;
      min-height:70px;
      display:flex; flex-direction:column; justify-content:space-between;
    }
    .svc strong{font-size:14px; letter-spacing:-.15px}
    .svc .meta{font-size:12px; color:var(--muted)}
    .svc.selected{border-color: rgba(247,198,0,.55); background: rgba(247,198,0,.10);}
    .svc.disabled{opacity:.35; cursor:not-allowed;}

    /* Address inputs */
    .addrGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .field{display:flex; flex-direction:column; gap:6px;}
    label{font-size:12px; color:var(--muted);}
    input{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      color:var(--fg);
      border-radius: 14px;
      padding:10px 10px;
      outline:none;
      font-size:13px;
    }
    .miniBtns{display:flex; gap:8px; margin-top:8px;}
    .miniBtn{
      padding:10px 10px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color:var(--fg);
      font-weight:900;
      font-size:12px;
      flex:1;
    }
    .miniBtn.yellow{
      background: var(--yellow);
      color:#101317;
      border-color: transparent;
    }

    /* Distance/Price */
    .statGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .stat{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      border-radius: 16px;
      padding:10px;
    }
    .stat .k{font-size:12px; color:var(--muted)}
    .stat .v{font-size:16px; font-weight:950; margin-top:4px;}

    /* Call */
    .callRow{display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px;}
    .callBtn{
      background: var(--btn);
      color: var(--btnText);
      border-radius: 18px;
      padding:16px 14px;
      font-weight:950;
      font-size:16px;
    }

    /* Overlay (registration modal) */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.60);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:50;
    }
    .overlay.show{display:flex;}
    .modal{
      width:min(560px, 100%);
      background: rgba(15,22,32,.96);
      border:1px solid var(--line);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .modal h3{margin:0 0 6px 0; font-size:16px;}
    .modal .muted{margin-bottom:10px;}
    .kvkk{
      display:flex; gap:10px; align-items:flex-start;
      margin-top:10px;
      padding:10px;
      border:1px solid var(--line);
      border-radius:16px;
      background: rgba(255,255,255,.04);
    }
    .kvkk input{width:18px; height:18px; margin-top:2px;}
    .err{color:var(--danger); font-size:12px; margin-top:8px; display:none;}
    .ok{color:var(--ok); font-size:12px; margin-top:8px; display:none;}

    /* Toast */
    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:14px;
      width:min(560px, calc(100% - 24px));
      z-index:100;
      background: rgba(15,22,32,.92);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:12px 14px;
      display:none;
    }
    .toast.show{display:block;}
    .toastTitle{font-weight:950; margin:0 0 4px 0;}
    .toastMsg{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}

    .spinner{
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      border-radius:50%;
      animation: spin 0.7s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Responsiveness */
    @media (max-width: 420px){
      .addrGrid{grid-template-columns:1fr;}
      .services{grid-template-columns:1fr 1fr;}
    }
  </style>
</head>
<body>

<!-- SCREEN: Landing -->
<section id="scrLanding" class="screen active">
  <div id="landing">
    <div class="landingCta">
      <button id="btnStart" class="btnPrimary">Başla</button>
    </div>
  </div>
</section>

<!-- SCREEN: Main (tek ekran) -->
<section id="scrMain" class="screen">
  <div class="app">
    <div class="topbar">
      <div class="brand">SepetTa<span style="color:var(--yellow)">x</span>i</div>
      <div class="pill" id="pillStatus">
        <span class="dot warn" id="dot"></span>
        <span id="pillText">Konum bekleniyor</span>
      </div>
    </div>

    <div class="mapWrap">
      <div id="map"></div>
    </div>

    <div class="panel">
      <div class="card">
        <div class="row between">
          <div class="muted">Hizmet</div>
          <button id="btnChangeService" class="btnGhost" style="padding:10px 12px;border-radius:14px;font-weight:950;font-size:12px;" disabled>
            Seçimi Değiştir
          </button>
        </div>

        <div class="services">
          <div class="svc" id="svcTaxi" data-svc="taxi">
            <strong>Taksi</strong>
            <div class="meta">Hızlı şehir içi</div>
          </div>
          <div class="svc" id="svcCourier" data-svc="courier">
            <strong>Kurye</strong>
            <div class="meta">Motorlu teslimat</div>
          </div>
        </div>

        <div class="addrGrid">
          <div class="field">
            <label for="fromAddr">Nereden</label>
            <input id="fromAddr" type="text" placeholder="Konum alınca dolacak" />
            <div class="miniBtns">
              <button id="btnPickFromMap" class="miniBtn">Haritadan Seç</button>
              <button id="btnUseMyLoc" class="miniBtn yellow">Konumum</button>
            </div>
          </div>

          <div class="field">
            <label for="toAddr">Nereye</label>
            <input id="toAddr" type="text" list="toHistory" placeholder="Haritadan seç veya geçmişten" />
            <datalist id="toHistory"></datalist>
            <div class="miniBtns">
              <button id="btnPickToMap" class="miniBtn">Haritadan Seç</button>
              <button id="btnSaveTo" class="miniBtn yellow">Geçmişe Ekle</button>
            </div>
          </div>
        </div>

        <div class="statGrid">
          <div class="stat">
            <div class="k">Mesafe</div>
            <div class="v" id="distText">-</div>
          </div>
          <div class="stat">
            <div class="k">Ücret</div>
            <div class="v" id="priceText">-</div>
          </div>
        </div>

        <div class="callRow">
          <button id="btnCall" class="callBtn" disabled>Taksi Çağır</button>
        </div>

        <div class="muted" id="hint" style="margin-top:8px;">
          Hizmet seç → Nereden/Nereye belirle → Mesafe/Ücret çıksın → Çağır aktif olsun.
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Registration Overlay (yalnızca yeni müşteri ise) -->
<div id="regOverlay" class="overlay" role="dialog" aria-modal="true">
  <div class="modal">
    <h3>Kayıt</h3>
    <div class="muted">Yeni müşteriyseniz kayıt zorunludur. Mevcut müşteride bu ekran açılmaz.</div>

    <label for="regPhone">Telefon (11 hane, 0 ile başlar)</label>
    <input id="regPhone" type="tel" inputmode="tel" placeholder="0XXXXXXXXXX" />

    <div id="regNameWrap" style="display:none;">
      <label for="regName">Ad Soyad</label>
      <input id="regName" type="text" placeholder="Örn: Özhan Samurcu" />
    </div>

    <div id="kvkkWrap" style="display:none;">
      <div class="kvkk">
        <input id="regKvkk" type="checkbox" />
        <div>
          <div style="font-weight:950;">KVKK & Sözleşme okudum, onaylıyorum.</div>
          <div class="muted">Onay olmadan devam edemezsiniz.</div>
        </div>
      </div>
    </div>

    <div class="err" id="regErr"></div>
    <div class="ok" id="regOk"></div>

    <div class="row" style="margin-top:12px;">
      <button id="btnRegCancel" class="btnGhost" style="flex:1;">Vazgeç</button>
      <button id="btnRegContinue" class="btnPrimary" style="flex:1;" disabled>Devam</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast" aria-live="polite">
  <div class="toastTitle" id="toastTitle">Bilgi</div>
  <p class="toastMsg" id="toastMsg"></p>
</div>

<script>
/* =========================
   CONFIG
========================= */
const DEBUG = false;
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwxZaKhAR3XTCjWXhTHjoXM2vv9AnCdGjXbAbr0Udwd3CNu8WefJIdfZbJfQUsaMbox/exec"; // /exec URL'nizi yapıştırın

const GEO_TIMEOUT_MS = 12000;
const API_TIMEOUT_MS = 15000;

// Price rules (MVP)
const SERVICE_RULES = {
  taxi:    { label:"Taksi",  base:60, perKm:18, min:90 },
  courier: { label:"Kurye",  base:55, perKm:16, min:85 }
};

// History key
const LS_TO_HISTORY = "sepettaxi_to_history_v1";

/* =========================
   STATE
========================= */
let map, markerFrom, markerTo;
let pickMode = null; // "from" | "to" | null
let selectedService = null;

let from = null; // {lat,lng,addr}
let to = null;   // {lat,lng,addr}

let computed = {km:null, price:null};

let user = {
  phone: null,
  name: null,
  exists: null,
  user_id: null
};

/* =========================
   DOM
========================= */
const $ = (id)=>document.getElementById(id);
const el = {
  scrLanding: $("scrLanding"),
  scrMain: $("scrMain"),
  btnStart: $("btnStart"),

  dot: $("dot"),
  pillText: $("pillText"),

  svcTaxi: $("svcTaxi"),
  svcCourier: $("svcCourier"),
  btnChangeService: $("btnChangeService"),

  fromAddr: $("fromAddr"),
  toAddr: $("toAddr"),
  toHistory: $("toHistory"),

  btnPickFromMap: $("btnPickFromMap"),
  btnPickToMap: $("btnPickToMap"),
  btnUseMyLoc: $("btnUseMyLoc"),
  btnSaveTo: $("btnSaveTo"),

  distText: $("distText"),
  priceText: $("priceText"),
  btnCall: $("btnCall"),
  hint: $("hint"),

  regOverlay: $("regOverlay"),
  regPhone: $("regPhone"),
  regNameWrap: $("regNameWrap"),
  regName: $("regName"),
  kvkkWrap: $("kvkkWrap"),
  regKvkk: $("regKvkk"),
  regErr: $("regErr"),
  regOk: $("regOk"),
  btnRegCancel: $("btnRegCancel"),
  btnRegContinue: $("btnRegContinue"),

  toast: $("toast"),
  toastTitle: $("toastTitle"),
  toastMsg: $("toastMsg")
};

function showToast(title, msg){
  el.toastTitle.textContent = title;
  el.toastMsg.textContent = msg;
  el.toast.classList.add("show");
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>el.toast.classList.remove("show"), 3800);
}

/* =========================
   SCREEN
========================= */
function showMain(){
  el.scrLanding.classList.remove("active");
  el.scrMain.classList.add("active");
  setTimeout(()=>map && map.invalidateSize(), 80);
}

/* =========================
   MAP + GEO
========================= */
function initMap(){
  map = L.map("map", { zoomControl:true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap" }).addTo(map);
  map.setView([40.195, 29.060], 13); // Bursa fallback

  map.on("click", async (e)=>{
    if(!pickMode) return;

    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    const addr = await reverseGeocode(lat, lng).catch(()=> "");
    if(pickMode === "from"){
      setFrom(lat, lng, addr || "Seçilen konum");
    } else if(pickMode === "to"){
      setTo(lat, lng, addr || "Seçilen hedef");
    }
    pickMode = null;
    showToast("Seçildi", "Haritadan seçim yapıldı.");
    computeAndRender();
  });
}

function setStatusDot(kind, text){
  el.dot.classList.remove("ok","warn","bad");
  el.dot.classList.add(kind);
  el.pillText.textContent = text;
}

function requestGeolocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("Konum desteği yok."));
    let done=false;
    const t=setTimeout(()=>{ if(done) return; done=true; reject(new Error("Konum alınamadı (timeout).")); }, GEO_TIMEOUT_MS);
    navigator.geolocation.getCurrentPosition(
      (pos)=>{ if(done) return; done=true; clearTimeout(t); resolve(pos); },
      (err)=>{ if(done) return; done=true; clearTimeout(t); reject(new Error(err.message||"Konum alınamadı.")); },
      { enableHighAccuracy:true, timeout:GEO_TIMEOUT_MS, maximumAge:5000 }
    );
  });
}

async function reverseGeocode(lat,lng){
  // Nominatim (OpenStreetMap) reverse geocode
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`;
  const res = await fetch(url, { headers: { "Accept":"application/json" } });
  if(!res.ok) throw new Error("Reverse geocode failed");
  const data = await res.json();
  return data && data.display_name ? data.display_name : "";
}

function setFrom(lat,lng,addr){
  from = {lat,lng,addr: addr || ""};
  el.fromAddr.value = from.addr || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;

  if(!markerFrom){
    markerFrom = L.marker([lat,lng]).addTo(map).bindPopup("Nereden");
  } else markerFrom.setLatLng([lat,lng]);

  map.setView([lat,lng], 15);
}

function setTo(lat,lng,addr){
  to = {lat,lng,addr: addr || ""};
  el.toAddr.value = to.addr || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;

  if(!markerTo){
    markerTo = L.marker([lat,lng]).addTo(map).bindPopup("Nereye");
  } else markerTo.setLatLng([lat,lng]);
}

/* =========================
   SERVICE SELECTION + REG FLOW
========================= */
function lockServices(selected){
  const all = [el.svcTaxi, el.svcCourier];
  all.forEach(card=>{
    const key = card.dataset.svc;
    card.classList.toggle("selected", key===selected);
    card.classList.toggle("disabled", key!==selected);
  });
  el.btnChangeService.disabled = false;
}

function unlockServices(){
  [el.svcTaxi, el.svcCourier].forEach(card=>{
    card.classList.remove("selected","disabled");
  });
  el.btnChangeService.disabled = true;
}

function setCallLabel(){
  if(!selectedService){
    el.btnCall.textContent = "Çağır";
    return;
  }
  el.btnCall.textContent = (selectedService==="taxi") ? "Taksi Çağır" : "Kurye Çağır";
}

function openRegOverlay(){
  el.regErr.style.display="none";
  el.regOk.style.display="none";
  el.regErr.textContent="";
  el.regOk.textContent="";
  el.regPhone.value = user.phone || "";
  el.regName.value = user.name || "";
  el.regNameWrap.style.display = "none";
  el.kvkkWrap.style.display = "none";
  el.regKvkk.checked = false;
  el.btnRegContinue.disabled = true;
  el.regOverlay.classList.add("show");
  el.regPhone.focus();
}

function closeRegOverlay(){
  el.regOverlay.classList.remove("show");
}

function isPhoneValid(v){ return /^0[0-9]{10}$/.test((v||"").trim()); }

async function checkUserByPhone(phone){
  if(!BACKEND_URL || BACKEND_URL.includes("PASTE_YOUR_EXEC_URL_HERE")){
    throw new Error("BACKEND_URL tanımlı değil.");
  }
  const data = await postJsonPlain(BACKEND_URL, { action:"check_user", phone }, API_TIMEOUT_MS);
  if(!data || !data.ok) throw new Error(data && (data.error||data.message) ? (data.error||data.message) : "check_user hata");
  return data;
}

function setRegError(msg){
  el.regErr.textContent = msg;
  el.regErr.style.display = "block";
  el.regOk.style.display = "none";
}

function setRegOk(msg){
  el.regOk.textContent = msg;
  el.regOk.style.display = "block";
  el.regErr.style.display = "none";
}

async function regFlowStartIfNeeded(){
  // Hizmet seçildiğinde, önce müşteri kontrolü yapılacak
  // Kullanıcı telefonsa var → overlay açmadan devam (spec: yeni ise kayıt)
  // Bu akış için: overlay açılır, telefon girilir, check_user ile karar verilir.
  openRegOverlay();
}

/* =========================
   HISTORY (NEREYE)
========================= */
function loadToHistory(){
  const raw = localStorage.getItem(LS_TO_HISTORY);
  let list = [];
  try { list = raw ? JSON.parse(raw) : []; } catch { list = []; }
  if(!Array.isArray(list)) list = [];
  return list;
}

function saveToHistoryItem(item){
  // item: {addr, lat, lng}
  const list = loadToHistory();
  const key = `${item.addr}|${item.lat.toFixed(5)}|${item.lng.toFixed(5)}`;
  const filtered = list.filter(x => `${x.addr}|${Number(x.lat).toFixed(5)}|${Number(x.lng).toFixed(5)}` !== key);
  filtered.unshift({ addr:item.addr, lat:item.lat, lng:item.lng });
  const out = filtered.slice(0, 8);
  localStorage.setItem(LS_TO_HISTORY, JSON.stringify(out));
  renderToHistory();
}

function renderToHistory(){
  const list = loadToHistory();
  el.toHistory.innerHTML = "";
  list.forEach(x=>{
    const opt = document.createElement("option");
    opt.value = x.addr;
    el.toHistory.appendChild(opt);
  });
}

/* =========================
   DISTANCE + PRICE
========================= */
function haversineKm(a,b){
  const R=6371;
  const toRad=(x)=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat);
  const dLon=toRad(b.lng-a.lng);
  const lat1=toRad(a.lat), lat2=toRad(b.lat);
  const s=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
  return R*c;
}

function computeAndRender(){
  computed = {km:null, price:null};

  if(selectedService && from && to){
    const km = haversineKm(from, to);
    const rule = SERVICE_RULES[selectedService];
    let price = rule.base + km * rule.perKm;
    price = Math.max(price, rule.min);
    computed = {km, price};
  }

  el.distText.textContent = computed.km==null ? "-" : `${computed.km.toFixed(2)} km`;
  el.priceText.textContent = computed.price==null ? "-" : `${Math.round(computed.price)} TL`;

  // Call active rules: service + from + to + computed + user ok
  const hasRoute = computed.km!=null && computed.price!=null;
  const hasService = !!selectedService;
  const userOk = (user.exists===true) || (user.exists===false && user.phone && user.name && user.kvkk===true);

  // Burada “çağır” butonu: mesafe+ücret çıkmadan aktif olmaz (kilit)
  el.btnCall.disabled = !(hasService && hasRoute && userOk);

  setCallLabel();
}

/* =========================
   API
========================= */
async function postJsonPlain(url, payload, timeoutMs){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const res = await fetch(url, {
      method:"POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      signal: ctrl.signal
    });
    const txt = await res.text();
    try { return JSON.parse(txt); }
    catch { return { ok:false, error:"Backend JSON dönmedi", raw:txt }; }
  } finally {
    clearTimeout(t);
  }
}

/* =========================
   CALL
========================= */
async function createRequest(){
  if(!BACKEND_URL || BACKEND_URL.includes("PASTE_YOUR_EXEC_URL_HERE")){
    showToast("Hata", DEBUG ? "BACKEND_URL tanımlı değil." : "Servis şu anda kullanılamıyor.");
    return;
  }
  if(!(selectedService && from && to && computed.km!=null && computed.price!=null)){
    showToast("Eksik", "Hizmet + nereden/nereye + mesafe/ücret gerekli.");
    return;
  }

  const payload = {
    action: "create_request",
    client: { name: user.name || "", phone: user.phone || "" },
    service: selectedService,
    from: { lat: from.lat, lng: from.lng, addr: from.addr || "" },
    to: { lat: to.lat, lng: to.lng, addr: to.addr || "" },
    distance_km: Number(computed.km.toFixed(3)),
    price: Math.round(computed.price),
    kvkk_accepted: true,
    ts: new Date().toISOString()
  };

  el.btnCall.disabled = true;
  el.btnCall.innerHTML = `<span class="spinner"></span>${selectedService==="taxi" ? "Taksi Çağır" : "Kurye Çağır"}`;

  const data = await postJsonPlain(BACKEND_URL, payload, API_TIMEOUT_MS).catch(e=>({ok:false, error:e.name==="AbortError" ? "Zaman aşımı" : (e.message||"İstek başarısız")}));

  el.btnCall.textContent = (selectedService==="taxi") ? "Taksi Çağır" : "Kurye Çağır";

  if(data && data.ok){
    showToast("Başarılı", `Çağrı oluşturuldu. Job: ${data.job_id}`);
    // nereye geçmişe ekle
    if(to && to.addr) saveToHistoryItem({addr: to.addr, lat: to.lat, lng: to.lng});
  }else{
    const err = data && (data.error||data.message) ? (data.error||data.message) : "Bilinmeyen hata";
    showToast("Hata", err);
  }

  computeAndRender();
}

/* =========================
   WIRES
========================= */
el.btnStart.addEventListener("click", async ()=>{
  showMain();
  if(!map) initMap();
  renderToHistory();

  setStatusDot("warn","Konum isteniyor");
  try{
    const pos = await requestGeolocation();
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const addr = await reverseGeocode(lat, lng).catch(()=> "");
    setFrom(lat, lng, addr || "Konumum");
    setStatusDot("ok","Konum alındı");
  }catch(_){
    setStatusDot("bad","Konum alınamadı");
    // fallback: Bursa center as from if user wants
    if(!from) setFrom(40.195, 29.060, "Bursa (varsayılan)");
  }
  computeAndRender();
});

el.svcTaxi.addEventListener("click", async ()=>{
  if(selectedService) return;
  selectedService = "taxi";
  lockServices("taxi");
  setCallLabel();
  // Hizmet seçince önce müşteri kontrol akışı (kilit)
  await regFlowStartIfNeeded();
});

el.svcCourier.addEventListener("click", async ()=>{
  if(selectedService) return;
  selectedService = "courier";
  lockServices("courier");
  setCallLabel();
  await regFlowStartIfNeeded();
});

el.btnChangeService.addEventListener("click", ()=>{
  selectedService = null;
  unlockServices();
  setCallLabel();
  computeAndRender();
});

el.btnPickFromMap.addEventListener("click", ()=>{
  pickMode = "from";
  showToast("Nereden", "Haritadan nereden noktasını seçin.");
});

el.btnPickToMap.addEventListener("click", ()=>{
  pickMode = "to";
  showToast("Nereye", "Haritadan hedef (nereye) seçin.");
});

el.btnUseMyLoc.addEventListener("click", async ()=>{
  setStatusDot("warn","Konum güncelleniyor");
  try{
    const pos = await requestGeolocation();
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const addr = await reverseGeocode(lat,lng).catch(()=> "");
    setFrom(lat,lng,addr||"Konumum");
    setStatusDot("ok","Konum alındı");
  }catch(_){
    setStatusDot("bad","Konum alınamadı");
    showToast("Konum", "Konum alınamadı.");
  }
  computeAndRender();
});

el.btnSaveTo.addEventListener("click", ()=>{
  if(to && to.addr){
    saveToHistoryItem({addr: to.addr, lat: to.lat, lng: to.lng});
    showToast("Kaydedildi", "Nereye geçmişe eklendi.");
  }else{
    showToast("Eksik", "Önce nereye seçin.");
  }
});

el.fromAddr.addEventListener("change", ()=>{
  // sadece metin değiştiyse koordinat yok; haritadan seçim öner
  if(from){
    from.addr = el.fromAddr.value.trim();
  }
  computeAndRender();
});

el.toAddr.addEventListener("change", ()=>{
  // Eğer kullanıcı geçmişten seçtiyse, listeden koordinat bulup set edelim
  const v = el.toAddr.value.trim();
  const list = loadToHistory();
  const hit = list.find(x => (x.addr||"").trim() === v);
  if(hit){
    setTo(Number(hit.lat), Number(hit.lng), hit.addr);
    computeAndRender();
  }else{
    // sadece metin girildiyse koordinat yok: haritadan seçmeli
    if(to) to.addr = v;
    computeAndRender();
  }
});

el.btnCall.addEventListener("click", createRequest);

/* =========================
   REG OVERLAY WIRES
========================= */
el.btnRegCancel.addEventListener("click", ()=>{
  // Hizmet seçilmişken kayıt iptal edilirse: hizmeti de sıfırla (akış net)
  closeRegOverlay();
  selectedService = null;
  unlockServices();
  user = { phone:null, name:null, exists:null, user_id:null };
  computeAndRender();
  showToast("İptal", "Hizmet seçimi sıfırlandı.");
});

function setRegBusy(isBusy, msg){
  if(isBusy){
    el.btnRegContinue.disabled = true;
    el.btnRegContinue.innerHTML = `<span class="spinner"></span>${msg||"Bekleyin"}`;
  }else{
    el.btnRegContinue.textContent = "Devam";
  }
}

el.regPhone.addEventListener("input", async ()=>{
  const phone = el.regPhone.value.trim();
  el.regErr.style.display="none";
  el.regOk.style.display="none";
  el.btnRegContinue.disabled = true;

  // telefon geçerli değilse form açma
  if(!phone){
    el.regNameWrap.style.display="none";
    el.kvkkWrap.style.display="none";
    return;
  }
  if(!isPhoneValid(phone)){
    setRegError("Telefon formatı hatalı. Örn: 05320000000");
    el.regNameWrap.style.display="none";
    el.kvkkWrap.style.display="none";
    return;
  }

  // check_user
  setRegBusy(true, "Kontrol ediliyor");
  try{
    const res = await checkUserByPhone(phone);
    user.phone = phone;
    user.exists = !!res.exists;
    user.user_id = res.user_id || null;

    if(res.exists){
      // mevcut müşteri: kayıt ekranı kapanır (kilit)
      user.name = res.name || "";
      user.kvkk = true; // mevcut kullanıcı için KVKK tekrar istemiyoruz (yeni müşteri şartı)
      setRegOk("Mevcut müşteri bulundu. Devam edebilirsiniz.");
      el.regNameWrap.style.display="none";
      el.kvkkWrap.style.display="none";
      el.btnRegContinue.disabled = false;
    }else{
      // yeni müşteri: ad + kvkk zorunlu
      setRegOk("Yeni müşteri. Kayıt bilgilerini tamamlayın.");
      el.regNameWrap.style.display="block";
      el.kvkkWrap.style.display="block";
      validateNewReg();
    }
  }catch(e){
    setRegError(DEBUG ? (e.message||"Kontrol edilemedi") : "Servis geçici olarak kullanılamıyor.");
  }finally{
    setRegBusy(false);
    el.btnRegContinue.textContent = "Devam";
  }
});

function validateNewReg(){
  const name = el.regName.value.trim();
  const okName = name.length >= 2;
  const okKvkk = el.regKvkk.checked;
  el.btnRegContinue.disabled = !(okName && okKvkk);
}

el.regName.addEventListener("input", ()=>{
  if(user.exists===false) validateNewReg();
});

el.regKvkk.addEventListener("change", ()=>{
  if(user.exists===false) validateNewReg();
});

el.btnRegContinue.addEventListener("click", ()=>{
  if(user.exists===true){
    closeRegOverlay();
    computeAndRender();
    return;
  }
  // new user
  const phone = el.regPhone.value.trim();
  const name = el.regName.value.trim();

  if(!isPhoneValid(phone)){
    setRegError("Telefon formatı hatalı. Örn: 05320000000");
    return;
  }
  if(name.length < 2){
    setRegError("Ad Soyad zorunlu.");
    return;
  }
  if(!el.regKvkk.checked){
    setRegError("KVKK onayı zorunlu.");
    return;
  }

  user.phone = phone;
  user.name = name;
  user.kvkk = true;
  user.exists = false;

  closeRegOverlay();
  computeAndRender();
  showToast("Hazır", "Rota ve ücret uygunsa çağırabilirsiniz.");
});

/* Init */
setCallLabel();
renderToHistory();
computeAndRender();
</script>
</body>
</html>
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SepetTaxi – MVP v1.1</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --fg:#e9eef5;
      --muted:#9fb0c3;
      --line:rgba(255,255,255,.12);
      --card:rgba(15,22,32,.72);
      --shadow: 0 16px 40px rgba(0,0,0,.40);
      --r:18px;
      --btn:#ffffff;
      --btnText:#0b0f14;
      --danger:#ff5a6a;
      --ok:#43d17a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      overflow:hidden; /* SCROLL YOK (kilit) */
    }

    /* Screens */
    .screen{
      position:fixed; inset:0;
      display:none;
      overflow:hidden; /* SCROLL YOK */
    }
    .screen.active{display:flex}

    /* Common layout helpers */
    .col{display:flex; flex-direction:column; height:100%; width:100%;}
    .topbar{
      height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--line);
      background:rgba(11,15,20,.65);
      backdrop-filter: blur(10px);
      flex:0 0 auto;
    }
    .title{font-weight:850; letter-spacing:-.2px;}
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }
    .content{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .footer{
      flex:0 0 auto;
      padding:12px 14px 16px;
      border-top:1px solid var(--line);
      background:rgba(11,15,20,.65);
      backdrop-filter: blur(10px);
      display:flex; gap:10px;
    }

    /* Buttons */
    button{
      appearance:none; border:none; cursor:pointer;
      border-radius:16px;
      padding:14px 14px;
      font-weight:800;
      font-size:15px;
      line-height:1;
    }
    .btnPrimary{background:var(--btn); color:var(--btnText); flex:1;}
    .btnGhost{background:transparent; color:var(--fg); border:1px solid var(--line); flex:1;}
    .btnSmall{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--fg);
      font-weight:850;
      font-size:13px;
      flex:0 0 auto;
    }
    button:disabled{opacity:.45; cursor:not-allowed;}

    /* Landing: only image + Başla */
    #landing{
      background:
        radial-gradient(1200px 700px at 70% 30%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(900px 600px at 20% 80%, rgba(255,255,255,.08), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      /* Kendi tanıtım görselinizi koymak isterseniz:
         background: url('YOUR_IMAGE_URL') center/cover no-repeat; */
    }
    .landingWrap{
      height:100%;
      display:flex; align-items:flex-end; justify-content:center;
      padding:18px;
    }
    .landingCTA{
      width:min(520px, 100%);
      background:rgba(15,22,32,.35);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }

    /* Maps */
    .map{
      flex:1 1 auto;
      min-height:0;
      width:100%;
      background:#0a0f16;
    }
    #mapGeo, #mapRoute{height:100%; width:100%}

    /* Center cards */
    .centerPane{
      flex:1 1 auto;
      min-height:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    .card{
      width:min(560px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    .muted{color:var(--muted); font-size:13px; line-height:1.45;}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;}
    @media (max-width:420px){ .grid2{grid-template-columns:1fr;} }

    /* Service cards */
    .svc{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.05);
      padding:14px;
      cursor:pointer;
      user-select:none;
      display:flex; flex-direction:column; gap:6px;
      min-height:84px;
    }
    .svc strong{font-size:15px; letter-spacing:-.2px;}
    .svc.disabled{opacity:.35; cursor:not-allowed;}
    .svc.selected{border-color:rgba(255,255,255,.35); background:rgba(255,255,255,.10);}

    /* Inputs */
    label{display:block; font-size:12px; color:var(--muted); margin-top:10px; margin-bottom:6px;}
    input{
      width:100%;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--fg);
      padding:12px 12px;
      font-size:14px;
      outline:none;
    }
    .err{color:var(--danger); font-size:12px; margin-top:8px;}
    .ok{color:var(--ok); font-size:12px; margin-top:8px;}
    .kvkkBox{
      display:flex; gap:10px; align-items:flex-start;
      margin-top:12px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(255,255,255,.04);
    }
    .kvkkBox input{width:18px; height:18px; margin-top:2px;}
    .chips{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:12px;
    }
    .chip{
      border:1px solid var(--line);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    .chip strong{color:var(--fg); font-weight:900;}

    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:99;
    }
    .modal.show{display:flex;}
    .modalCard{
      width:min(640px,100%);
      max-height:calc(100vh - 28px);
      overflow:auto; /* modal içinde scroll serbest (ekran değil) */
      background:rgba(15,22,32,.94);
      border:1px solid var(--line);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    .modalCard h3{margin:0 0 10px 0;}
    .modalCard p{margin:0 0 10px 0; color:var(--muted); line-height:1.5; font-size:13px;}
    .modalActions{display:flex; gap:10px; margin-top:10px;}

    /* Toast */
    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:18px;
      width:min(560px, calc(100% - 24px));
      z-index:100;
      background:rgba(15,22,32,.92);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px 14px;
      display:none;
    }
    .toast.show{display:block;}
    .toastTitle{font-weight:900; margin:0 0 4px 0;}
    .toastMsg{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}
    .spinner{
      display:inline-block; width:14px; height:14px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      border-radius:50%;
      animation: spin 0.7s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body>

<!-- SCREEN 0: Landing (ONLY IMAGE + Başla) -->
<section id="scrLanding" class="screen active">
  <div class="col" id="landing">
    <div class="landingWrap">
      <div class="landingCTA">
        <button id="btnStart" class="btnPrimary">Başla</button>
      </div>
    </div>
  </div>
</section>

<!-- SCREEN 1: Geo + Map -->
<section id="scrGeo" class="screen">
  <div class="col">
    <div class="topbar">
      <div class="title">SepetTaxi</div>
      <div class="pill" id="pillGeo">Konum: bekleniyor</div>
    </div>

    <div class="content map">
      <div id="mapGeo"></div>
    </div>

    <div class="footer">
      <button id="btnGeoBack" class="btnGhost">Geri</button>
      <button id="btnGeoNext" class="btnPrimary">Devam</button>
    </div>
  </div>
</section>

<!-- SCREEN 2: Service -->
<section id="scrService" class="screen">
  <div class="col">
    <div class="topbar">
      <div class="title">Hizmet Seç</div>
      <div class="pill" id="pillService">Seçim: -</div>
    </div>

    <div class="content">
      <div class="centerPane">
        <div class="card">
          <div class="muted">Sadece 1 seçim. Değiştirmek için “Seçimi Değiştir”.</div>

          <div class="grid2" style="margin-top:12px;">
            <div class="svc" id="svcTaxi" data-svc="taxi">
              <strong>Taksi</strong>
              <div class="muted">Şehir içi hızlı çağrı</div>
            </div>
            <div class="svc" id="svcCourier" data-svc="courier">
              <strong>Kurye</strong>
              <div class="muted">Motorlu kurye teslimat</div>
            </div>
          </div>

          <div class="row" style="margin-top:12px;">
            <button id="btnChangeService" class="btnSmall" disabled>Seçimi Değiştir</button>
          </div>

          <div class="chips">
            <div class="chip">Hizmet: <strong id="txtSvc">-</strong></div>
          </div>

          <div class="muted" style="margin-top:10px;">
            Devam edebilmek için hizmet seçmelisiniz.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <button id="btnServiceBack" class="btnGhost">Geri</button>
      <button id="btnServiceNext" class="btnPrimary" disabled>Devam</button>
    </div>
  </div>
</section>

<!-- SCREEN 3: Route (target) + compute -->
<section id="scrRoute" class="screen">
  <div class="col">
    <div class="topbar">
      <div class="title">Hedef Seç</div>
      <div class="pill" id="pillRoute">Ücret: -</div>
    </div>

    <div class="content map">
      <div id="mapRoute"></div>
    </div>

    <div class="footer">
      <button id="btnRouteBack" class="btnGhost">Geri</button>
      <button id="btnRouteNext" class="btnPrimary" disabled>Devam</button>
    </div>
  </div>
</section>

<!-- SCREEN 4: Registration + KVKK -->
<section id="scrRegister" class="screen">
  <div class="col">
    <div class="topbar">
      <div class="title">Zorunlu Kayıt</div>
      <div class="pill">KVKK: zorunlu</div>
    </div>

    <div class="content">
      <div class="centerPane">
        <div class="card">
          <div class="muted">Telefon daha önce yoksa kaydedilir; varsa tekrar yazılmaz (backend kontrol).</div>

          <label for="inpName">Ad Soyad</label>
          <input id="inpName" type="text" autocomplete="name" placeholder="Örn: Özhan Samurcu"/>

          <label for="inpPhone">Telefon (11 hane, 0 ile başlar)</label>
          <input id="inpPhone" type="tel" inputmode="tel" autocomplete="tel" placeholder="0XXXXXXXXXX"/>
          <div id="phoneErr" class="err" style="display:none;">Telefon formatı hatalı. Örn: 05320000000</div>

          <div class="row" style="margin-top:10px;">
            <button id="btnShowKvkk" class="btnSmall">KVKK / Sözleşme</button>
          </div>

          <div class="kvkkBox">
            <input id="chkKvkk" type="checkbox"/>
            <div>
              <div style="font-weight:900;">Okudum, onaylıyorum.</div>
              <div class="muted">Onay olmadan devam edemezsiniz.</div>
            </div>
          </div>

          <div id="regHint" class="muted" style="margin-top:10px;">
            Devam edebilmek için tüm alanlar + KVKK onayı gerekli.
          </div>
        </div>
      </div>
    </div>

    <div class="footer">
      <button id="btnRegBack" class="btnGhost">Geri</button>
      <button id="btnRegNext" class="btnPrimary" disabled>Devam</button>
    </div>
  </div>
</section>

<!-- SCREEN 5: Summary + Call -->
<section id="scrSummary" class="screen">
  <div class="col">
    <div class="topbar">
      <div class="title">Özet</div>
      <div class="pill" id="pillCall">Hazır</div>
    </div>

    <div class="content">
      <div class="centerPane">
        <div class="card">
          <div class="chips" style="margin-top:0;">
            <div class="chip">Hizmet: <strong id="sumSvc">-</strong></div>
            <div class="chip">Mesafe: <strong id="sumKm">-</strong></div>
            <div class="chip">Ücret: <strong id="sumPrice">-</strong></div>
          </div>
          <div class="chips">
            <div class="chip">Pickup: <strong id="sumPickup">-</strong></div>
            <div class="chip">Hedef: <strong id="sumDrop">-</strong></div>
          </div>
          <div class="muted" style="margin-top:10px;">
            “Çağır” ile talep sisteme düşer.
          </div>

          <div id="callOk" class="ok" style="display:none; margin-top:10px;"></div>
          <div id="callErr" class="err" style="display:none; margin-top:10px;"></div>
        </div>
      </div>
    </div>

    <div class="footer">
      <button id="btnSumBack" class="btnGhost">Geri</button>
      <button id="btnCall" class="btnPrimary">Çağır</button>
    </div>
  </div>
</section>

<!-- KVKK Modal -->
<div id="kvkkModal" class="modal" role="dialog" aria-modal="true" aria-label="KVKK ve Sözleşme">
  <div class="modalCard">
    <h3>KVKK Aydınlatma / Hizmet Sözleşmesi (MVP)</h3>
    <p>
      Bu MVP’de amaç, hizmet talebinizin kaydının oluşturulmasıdır. Kişisel verileriniz (ad, telefon, konum verisi)
      yalnızca çağrı kaydı ve operasyonel iletim amacıyla işlenir.
    </p>
    <p>
      SepetTaxi, hizmeti sağlayan tarafları bir araya getiren dijital bir arayüzdür. Ücret, mesafe bazlı hesaplanan
      tahmini bedeldir. Nihai sürümde metinler kurumsal olarak güncellenecektir.
    </p>
    <div class="modalActions">
      <button id="btnCloseKvkk" class="btnPrimary">Kapat</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite">
  <div class="toastTitle" id="toastTitle">Bilgi</div>
  <p class="toastMsg" id="toastMsg"></p>
</div>

<script>
/* =========================
   CONFIG
========================= */
const DEBUG = false; // canlıda false; testte true yapabilirsiniz
const BACKEND_URL = "PASTE_YOUR_EXEC_URL_HERE"; // https://script.google.com/macros/s/XXXX/exec

// Yalnızca Taksi + Kurye (kilit)
const SERVICE_RULES = {
  taxi:   { label:"Taksi",  base:60, perKm:18, min:90 },
  courier:{ label:"Kurye",  base:55, perKm:16, min:85 }
};

// No infinite wait
const GEO_TIMEOUT_MS = 12000;
const API_TIMEOUT_MS = 15000;

/* =========================
   STATE
========================= */
let pickup = null;   // {lat,lng}
let dropoff = null;  // {lat,lng}
let selectedService = null;
let computed = { km:null, price:null };

let mapGeo, mapRoute;
let markerPickupGeo, markerPickupRoute, markerDrop;

/* =========================
   ELEMENTS
========================= */
const $ = (id)=>document.getElementById(id);

const screens = {
  landing: $("scrLanding"),
  geo: $("scrGeo"),
  service: $("scrService"),
  route: $("scrRoute"),
  register: $("scrRegister"),
  summary: $("scrSummary")
};

function showScreen(key){
  Object.values(screens).forEach(s=>s.classList.remove("active"));
  screens[key].classList.add("active");

  // Leaflet hidden -> shown: invalidate size
  if(key==="geo" && mapGeo) setTimeout(()=>mapGeo.invalidateSize(), 80);
  if(key==="route" && mapRoute) setTimeout(()=>mapRoute.invalidateSize(), 80);
}

function toast(title, msg){
  $("toastTitle").textContent = title;
  $("toastMsg").textContent = msg;
  $("toast").classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>$("toast").classList.remove("show"), 3800);
}

function fmtLatLng(p){
  if(!p) return "-";
  return `${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`;
}
function fmtKm(km){ return (km==null) ? "-" : `${km.toFixed(2)} km`; }
function fmtPrice(p){ return (p==null) ? "-" : `${Math.round(p)} TL`; }

/* =========================
   GEO + MAPS
========================= */
function initGeoMap(){
  mapGeo = L.map("mapGeo", { zoomControl:true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap" }).addTo(mapGeo);
  mapGeo.setView([40.195, 29.060], 13); // Bursa fallback
}

function initRouteMap(){
  mapRoute = L.map("mapRoute", { zoomControl:true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom:19, attribution:"&copy; OpenStreetMap" }).addTo(mapRoute);
  mapRoute.setView([40.195, 29.060], 13);

  mapRoute.on("click", (e)=>{
    dropoff = {lat:e.latlng.lat, lng:e.latlng.lng};
    if(!markerDrop){
      markerDrop = L.marker([dropoff.lat, dropoff.lng]).addTo(mapRoute).bindPopup("Hedef");
    }else{
      markerDrop.setLatLng([dropoff.lat, dropoff.lng]);
    }
    computePriceIfPossible();
    syncRouteUI();
  });
}

function requestGeolocation(){
  return new Promise((resolve, reject)=>{
    if(!navigator.geolocation) return reject(new Error("Konum desteği yok."));
    let done=false;
    const t=setTimeout(()=>{ if(done) return; done=true; reject(new Error("Konum alınamadı (timeout).")); }, GEO_TIMEOUT_MS);
    navigator.geolocation.getCurrentPosition(
      (pos)=>{ if(done) return; done=true; clearTimeout(t); resolve(pos); },
      (err)=>{ if(done) return; done=true; clearTimeout(t); reject(new Error(err.message||"Konum alınamadı.")); },
      { enableHighAccuracy:true, timeout:GEO_TIMEOUT_MS, maximumAge:5000 }
    );
  });
}

function setPickup(lat,lng){
  pickup = {lat,lng};

  $("pillGeo").textContent = "Konum: alındı";
  if(mapGeo){
    if(!markerPickupGeo){
      markerPickupGeo = L.marker([lat,lng]).addTo(mapGeo).bindPopup("Siz").openPopup();
    }else markerPickupGeo.setLatLng([lat,lng]);
    mapGeo.setView([lat,lng], 15);
  }

  if(mapRoute){
    if(!markerPickupRoute){
      markerPickupRoute = L.marker([lat,lng]).addTo(mapRoute).bindPopup("Pickup");
    }else markerPickupRoute.setLatLng([lat,lng]);
    mapRoute.setView([lat,lng], 14);
  }
}

/* =========================
   SERVICE SELECTION (tek seçim + değiştir)
========================= */
function setService(svc){
  if(selectedService) return; // kilit: tek seçim
  selectedService = svc;

  const taxi = $("svcTaxi"), courier = $("svcCourier");
  const changeBtn = $("btnChangeService");

  [taxi,courier].forEach(el=>{
    const k = el.dataset.svc;
    el.classList.toggle("selected", k===svc);
    el.classList.toggle("disabled", k!==svc);
  });

  changeBtn.disabled = false;

  $("txtSvc").textContent = SERVICE_RULES[svc].label;
  $("pillService").textContent = `Seçim: ${SERVICE_RULES[svc].label}`;
  $("btnServiceNext").disabled = false;

  // service değişince compute sıfırla (route tekrar hedef bekler)
  computed = {km:null, price:null};
  $("btnRouteNext").disabled = true;
  $("pillRoute").textContent = "Ücret: -";
}

function clearService(){
  selectedService = null;
  ["svcTaxi","svcCourier"].forEach(id=>{
    const el=$(id);
    el.classList.remove("selected","disabled");
  });
  $("btnChangeService").disabled = true;
  $("txtSvc").textContent = "-";
  $("pillService").textContent = "Seçim: -";
  $("btnServiceNext").disabled = true;

  computed = {km:null, price:null};
  $("btnRouteNext").disabled = true;
  $("pillRoute").textContent = "Ücret: -";
}

/* =========================
   DISTANCE + PRICE
========================= */
function haversineKm(a, b){
  const R=6371;
  const toRad = (x)=>x*Math.PI/180;
  const dLat=toRad(b.lat-a.lat);
  const dLon=toRad(b.lng-a.lng);
  const lat1=toRad(a.lat);
  const lat2=toRad(b.lat);
  const s=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s));
  return R*c;
}

function computePriceIfPossible(){
  if(!pickup || !dropoff || !selectedService){
    computed = {km:null, price:null};
    return;
  }
  const km = haversineKm(pickup, dropoff);
  const rule = SERVICE_RULES[selectedService];
  let price = rule.base + (km*rule.perKm);
  price = Math.max(price, rule.min);
  computed = {km, price};
}

function syncRouteUI(){
  // Mesafe + ücret çıkmadan Devam yok (kilit)
  if(computed.km!=null && computed.price!=null){
    $("pillRoute").textContent = `Ücret: ${fmtPrice(computed.price)}`;
    $("btnRouteNext").disabled = false;
  }else{
    $("pillRoute").textContent = "Ücret: -";
    $("btnRouteNext").disabled = true;
  }
}

/* =========================
   VALIDATION (Register)
========================= */
function isPhoneValid(v){ return /^0[0-9]{10}$/.test((v||"").trim()); }

function validateRegister(){
  const nameOk = ($("inpName").value||"").trim().length >= 2;
  const phoneVal = ($("inpPhone").value||"").trim();
  const phoneOk = isPhoneValid(phoneVal);
  const kvkkOk = $("chkKvkk").checked;

  $("phoneErr").style.display = (!phoneOk && phoneVal.length>0) ? "block" : "none";

  const ok = nameOk && phoneOk && kvkkOk;
  $("btnRegNext").disabled = !ok;

  return ok;
}

/* =========================
   SUMMARY + API CALL
========================= */
// Preflight olmaması için: text/plain gönderiyoruz (Apps Script ile en stabil)
async function postJsonPlain(url, payload, timeoutMs){
  const ctrl = new AbortController();
  const t = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const res = await fetch(url, {
      method:"POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type":"text/plain;charset=utf-8" },
      signal: ctrl.signal
    });
    const txt = await res.text();
    try { return JSON.parse(txt); }
    catch { return { ok:false, error:"Backend JSON dönmedi", raw:txt }; }
  } finally {
    clearTimeout(t);
  }
}

function refreshSummary(){
  $("sumSvc").textContent = selectedService ? SERVICE_RULES[selectedService].label : "-";
  $("sumKm").textContent = fmtKm(computed.km);
  $("sumPrice").textContent = fmtPrice(computed.price);
  $("sumPickup").textContent = fmtLatLng(pickup);
  $("sumDrop").textContent = fmtLatLng(dropoff);

  $("callOk").style.display="none";
  $("callErr").style.display="none";
  $("callOk").textContent="";
  $("callErr").textContent="";
}

function setCallBusy(busy, msg){
  $("pillCall").innerHTML = busy ? `<span class="spinner"></span>${msg||"İşleniyor"}` : (msg||"Hazır");
}

async function doCall(){
  $("callOk").style.display="none";
  $("callErr").style.display="none";

  if(!BACKEND_URL || BACKEND_URL.includes("https://script.google.com/macros/s/AKfycbxOemUPEslzZfJk3PHS7DyONU9o8375DDgfK-29q_3HfFNw7iJonBaUo4ogLXhO-UAd/exec")){
    if(DEBUG){
      $("callErr").textContent = "BACKEND_URL tanımlı değil. /exec URL’nizi index.html içine yapıştırın.";
      $("callErr").style.display="block";
    }else{
      $("callErr").textContent = "Servis şu anda kullanılamıyor. Lütfen daha sonra tekrar deneyin.";
      $("callErr").style.display="block";
    }
    return;
  }

  // Son güvenlik kilidi: ücret/mesafe zorunlu
  if(!(computed.km!=null && computed.price!=null)){
    toast("Eksik", "Ücret/mesafe oluşmadan çağrı verilemez.");
    return;
  }
  if(!validateRegister()){
    toast("Eksik", "Kayıt bilgileri ve KVKK onayı zorunlu.");
    return;
  }

  const payload = {
    action: "create_request",
    client: {
      name: ($("inpName").value||"").trim(),
      phone: ($("inpPhone").value||"").trim()
    },
    service: selectedService,
    pickup: pickup,
    dropoff: dropoff,
    distance_km: Number(computed.km.toFixed(3)),
    price: Math.round(computed.price),
    kvkk_accepted: true,
    ts: new Date().toISOString()
  };

  $("btnCall").disabled = true;
  setCallBusy(true, "Gönderiliyor");

  try{
    const data = await postJsonPlain(BACKEND_URL, payload, API_TIMEOUT_MS);
    if(data && data.ok){
      $("callOk").textContent = `Çağrı oluşturuldu. Job: ${data.job_id}`;
      $("callOk").style.display="block";
      setCallBusy(false, "Başarılı");
      toast("Başarılı", "Çağrınız sisteme düştü.");
    }else{
      const err = (data && (data.error||data.message)) ? (data.error||data.message) : "Bilinmeyen hata";
      $("callErr").textContent = err;
      $("callErr").style.display="block";
      setCallBusy(false, "Hata");
    }
  }catch(e){
    const msg = (e && e.name==="AbortError") ? "Zaman aşımı. Tekrar deneyin." : (e.message||"İstek başarısız.");
    $("callErr").textContent = msg;
    $("callErr").style.display="block";
    setCallBusy(false, "Hata");
  }finally{
    $("btnCall").disabled = false;
  }
}

/* =========================
   WIRES / NAVIGATION
========================= */
$("btnStart").addEventListener("click", ()=>{
  showScreen("geo");
  // init map once
  if(!mapGeo){
    initGeoMap();
  }else{
    setTimeout(()=>mapGeo.invalidateSize(), 80);
  }
  // harita açıldığında konum izni (kilit)
  $("pillGeo").textContent = "Konum: isteniyor";
  requestGeolocation()
    .then(pos=>{
      setPickup(pos.coords.latitude, pos.coords.longitude);
      toast("Konum alındı", "Devam edebilirsiniz.");
    })
    .catch(_=>{
      $("pillGeo").textContent = "Konum: alınamadı";
      toast("Konum alınamadı", "Harita varsayılan merkezde açıldı.");
    });
});

$("btnGeoBack").addEventListener("click", ()=>showScreen("landing"));
$("btnGeoNext").addEventListener("click", ()=>{
  // pickup yoksa da devam edebilir (kilit: konum alınamazsa Bursa)
  // pickup yoksa, pickup'ı Bursa merkezine set edelim ki fiyat/mesafe hesaplanabilsin
  if(!pickup){
    pickup = {lat:40.195, lng:29.060};
  }
  showScreen("service");
});

$("svcTaxi").addEventListener("click", ()=>{ if(!selectedService) setService("taxi"); });
$("svcCourier").addEventListener("click", ()=>{ if(!selectedService) setService("courier"); });

$("btnChangeService").addEventListener("click", ()=>clearService());

$("btnServiceBack").addEventListener("click", ()=>showScreen("geo"));
$("btnServiceNext").addEventListener("click", ()=>{
  showScreen("route");
  if(!mapRoute){
    initRouteMap();
  }
  // pickup marker
  if(pickup){
    if(!markerPickupRoute){
      markerPickupRoute = L.marker([pickup.lat,pickup.lng]).addTo(mapRoute).bindPopup("Pickup");
    }else markerPickupRoute.setLatLng([pickup.lat,pickup.lng]);
    mapRoute.setView([pickup.lat,pickup.lng], 14);
  }
  setTimeout(()=>mapRoute.invalidateSize(), 80);

  // dropoff reset + compute reset
  dropoff = null;
  if(markerDrop){ mapRoute.removeLayer(markerDrop); markerDrop=null; }
  computed = {km:null, price:null};
  syncRouteUI();

  toast("Hedef seç", "Haritaya tıklayarak hedefi belirleyin.");
});

$("btnRouteBack").addEventListener("click", ()=>showScreen("service"));
$("btnRouteNext").addEventListener("click", ()=>{
  // kilit: ücret/mesafe çıkmadan olmaz (btn zaten disabled)
  showScreen("register");
  validateRegister();
});

$("inpName").addEventListener("input", validateRegister);
$("inpPhone").addEventListener("input", validateRegister);
$("chkKvkk").addEventListener("change", validateRegister);

$("btnShowKvkk").addEventListener("click", ()=>$("kvkkModal").classList.add("show"));
$("btnCloseKvkk").addEventListener("click", ()=>$("kvkkModal").classList.remove("show"));
$("kvkkModal").addEventListener("click", (e)=>{ if(e.target.id==="kvkkModal") $("kvkkModal").classList.remove("show"); });

$("btnRegBack").addEventListener("click", ()=>showScreen("route"));
$("btnRegNext").addEventListener("click", ()=>{
  refreshSummary();
  showScreen("summary");
});

$("btnSumBack").addEventListener("click", ()=>showScreen("register"));
$("btnCall").addEventListener("click", doCall);

/* Initial */
validateRegister();
</script>
</body>
</html>
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SepetTaxi MVP</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1620;
      --card2:#101a27;
      --text:#e9eef5;
      --muted:#9fb0c3;
      --line:rgba(255,255,255,.10);
      --accent:#ffffff;
      --danger:#ff5a6a;
      --ok:#43d17a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit}
    .hidden{display:none !important;}
    .app{min-height:100vh; display:flex; flex-direction:column;}
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}

    /* Landing */
    .landing{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .hero{
      width:min(720px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:28px;
      box-shadow:var(--shadow);
      padding:26px;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:rgba(255,255,255,.12);
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
    }
    .title{
      font-size:clamp(24px, 3.2vw, 34px);
      line-height:1.15;
      margin:8px 0 10px 0;
      letter-spacing:-0.3px;
    }
    .subtitle{
      color:var(--muted);
      margin:0 0 18px 0;
      line-height:1.5;
      font-size:15px;
    }
    .ctaRow{display:flex; gap:12px; flex-wrap:wrap;}
    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:16px;
      padding:14px 16px;
      font-weight:700;
      font-size:15px;
      width:100%;
    }
    .btnPrimary{background:var(--accent); color:#0b0f14;}
    .btnGhost{background:transparent; color:var(--text); border:1px solid var(--line);}
    .fine{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }

    /* Main layout */
    .main{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header.topbar{
      padding:14px 16px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(11,15,20,.75);
      backdrop-filter: blur(10px);
      position:sticky; top:0; z-index:5;
    }
    .topbarRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .topbarTitle{font-weight:800; letter-spacing:-.2px;}
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }

    #map{
      width:100%;
      height:40vh; /* default mobile */
      background:#0a0f16;
      border-bottom:1px solid var(--line);
    }
    @media (min-width: 700px){
      #map{height:45vh;}
      .btn{width:auto;}
      .ctaRow .btn{min-width:180px;}
    }
    @media (min-width: 1024px){
      #map{height:50vh;}
    }

    .panel{
      flex:1;
      padding:14px 14px 18px;
      overflow:auto;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      padding:14px;
      margin-bottom:12px;
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:15px;
      letter-spacing:-.2px;
    }
    .muted{color:var(--muted); font-size:13px; line-height:1.45;}
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 420px){
      .grid{grid-template-columns:1fr;}
    }

    .service{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.035);
      padding:12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .08s ease, background .08s ease;
      min-height:86px;
      display:flex; flex-direction:column; justify-content:space-between;
      user-select:none;
    }
    .service:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18);}
    .service.disabled{opacity:.35; cursor:not-allowed; transform:none;}
    .service.selected{
      border-color:rgba(255,255,255,.38);
      background:rgba(255,255,255,.08);
    }
    .serviceName{font-weight:800; font-size:14px;}
    .serviceMeta{color:var(--muted); font-size:12px; margin-top:2px;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .rowRight{margin-left:auto;}
    .miniBtn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:750;
      cursor:pointer;
    }
    .miniBtn:disabled{opacity:.45; cursor:not-allowed;}
    .miniBtn.primary{background:var(--accent); color:#0b0f14; border-color:transparent;}
    .miniBtn.danger{border-color:rgba(255,90,106,.4);}

    .field{display:flex; flex-direction:column; gap:6px; margin-top:10px;}
    label{font-size:12px; color:var(--muted);}
    input, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:74px; resize:vertical;}
    .err{color:var(--danger); font-size:12px; margin-top:6px;}
    .ok{color:var(--ok); font-size:12px; margin-top:6px;}
    .divider{height:1px; background:var(--line); margin:12px 0;}
    .kvkk{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      margin-top:12px;
    }
    .kvkk input{width:18px; height:18px; margin-top:2px;}
    details{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background:rgba(255,255,255,.03);
      margin-top:10px;
    }
    summary{cursor:pointer; font-weight:800; font-size:13px;}
    details .muted{margin-top:8px;}

    .statusBar{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      border:1px solid var(--line);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    .chip strong{color:var(--text); font-weight:800;}
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.45;
    }

    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:18px;
      width:min(560px, calc(100% - 24px));
      z-index:50;
      background:rgba(15,22,32,.92);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px 14px;
      display:none;
    }
    .toast.show{display:block;}
    .toastTitle{font-weight:850; margin:0 0 4px 0;}
    .toastMsg{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}
    .spinner{
      display:inline-block;
      width:14px; height:14px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      border-radius:50%;
      animation: spin 0.7s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body class="safe">
  <!-- LANDING -->
  <section id="landing" class="landing">
    <div class="hero">
      <div class="brand">
        <div class="logo">ST</div>
        <div class="pill">MVP v1 • Tek Endpoint</div>
      </div>
      <h1 class="title">SepetTaxi ile tek dokunuşla hizmet çağır.</h1>
      <p class="subtitle">
        Konumunu alır, mesafeyi ve ücreti net gösterir. Onay sonrası çağrın sisteme düşer.
      </p>
      <div class="ctaRow">
        <button id="btnStart" class="btn btnPrimary">Başla</button>
        <button id="btnInfo" class="btn btnGhost" type="button">Nasıl çalışır?</button>
      </div>
      <p class="fine">
        Başla’ya basınca konum izni istenir. Konum paylaşmazsan harita varsayılan merkezde açılır.
      </p>
    </div>
  </section>

  <!-- MAIN -->
  <section id="main" class="main hidden">
    <header class="topbar">
      <div class="topbarRow">
        <div class="topbarTitle">SepetTaxi</div>
        <div class="pill" id="pillGeo">Konum: bekleniyor</div>
      </div>
    </header>

    <div id="map" aria-label="Harita"></div>

    <div class="panel">
      <!-- SERVICES -->
      <div class="card">
        <h3>Hizmet Seçimi</h3>
        <div class="muted">Tek seçim. Değiştirmek için “Seçimi Değiştir”.</div>

        <div class="divider"></div>

        <div class="grid" id="serviceGrid">
          <!-- Filled by JS -->
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnChangeService" class="miniBtn danger hidden" type="button">Seçimi Değiştir</button>
          <div class="rowRight"></div>
          <span class="chip" id="chipService">Hizmet: <strong>-</strong></span>
        </div>

        <p class="hint">
          Hedef noktayı harita üzerinde seçmek için haritaya tıklayın. (Pickup = mevcut konum.)
        </p>
      </div>

      <!-- ROUTE + PRICE -->
      <div class="card">
        <h3>Mesafe & Ücret</h3>
        <div class="muted">Mesafe ve ücret oluşmadan “Çağır” aktif olmaz.</div>

        <div class="statusBar">
          <span class="chip">Pickup: <strong id="pickupText">-</strong></span>
          <span class="chip">Hedef: <strong id="dropText">-</strong></span>
          <span class="chip">Mesafe: <strong id="distText">-</strong></span>
          <span class="chip">Ücret: <strong id="priceText">-</strong></span>
        </div>

        <div class="field">
          <label for="pickupNote">Adres/Not (opsiyonel)</label>
          <textarea id="pickupNote" placeholder="Bina adı, kat, kapı no, tarif..."></textarea>
        </div>

        <p class="hint" id="calcHint">
          Hizmet seçin + haritada hedef seçin. Sistem mesafe ve ücreti otomatik hesaplar.
        </p>
      </div>

      <!-- REQUIRED REGISTRATION (only after service selected) -->
      <div id="regCard" class="card hidden">
        <h3>Zorunlu Kayıt</h3>
        <div class="muted">Hizmet seçimi sonrası görünür. Telefon daha önce yoksa kaydedilir; varsa tekrar yazılmaz.</div>

        <div class="field">
          <label for="name">Ad Soyad</label>
          <input id="name" type="text" inputmode="text" autocomplete="name" placeholder="Örn: Özhan Samurcu"/>
        </div>

        <div class="field">
          <label for="phone">Telefon (11 hane, 0 ile başlar)</label>
          <input id="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="0XXXXXXXXXX"/>
          <div id="phoneErr" class="err hidden">Telefon formatı hatalı. Örn: 05320000000</div>
        </div>

        <details>
          <summary>KVKK Aydınlatma Metni</summary>
          <div class="muted">
            Bu MVP’de amaç, hizmet talebinizi operasyonel olarak iletmektir. Kişisel verileriniz (ad, telefon, konum verisi)
            yalnızca hizmetin sağlanması ve çağrı kaydının oluşturulması amacıyla işlenir. Detaylı metin nihai sürümde
            kurumsal metinle güncellenecektir.
          </div>
        </details>

        <details>
          <summary>Hizmet Sözleşmesi</summary>
          <div class="muted">
            SepetTaxi, hizmet talebinizi sisteme ileten dijital bir aracıdır. Ücret, mesafe/parametre bazlı hesaplanan
            tahmini bedeldir. Operasyonel onay ve hizmet koşulları nihai sürümde detaylandırılacaktır.
          </div>
        </details>

        <div class="kvkk">
          <input id="kvkkCheck" type="checkbox"/>
          <div>
            <div style="font-weight:850;">Okudum, onaylıyorum.</div>
            <div class="muted">KVKK ve sözleşme onayı zorunludur.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnCall" class="miniBtn primary" type="button" disabled>Çağır</button>
          <span id="callState" class="muted"></span>
        </div>

        <div id="callOk" class="ok hidden">Çağrı başarıyla oluşturuldu.</div>
        <div id="callErr" class="err hidden"></div>
      </div>
    </div>
  </section>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="toastTitle" id="toastTitle">Bilgi</div>
    <p class="toastMsg" id="toastMsg"></p>
  </div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const BACKEND_URL = "PASTE_YOUR_EXEC_URL_HERE"; // örn: https://script.google.com/macros/s/XXXX/exec

// Hizmet fiyat parametreleri (MVP)
const SERVICE_RULES = {
  taxi:   { label: "Taksi",        base: 60, perKm: 18, min: 90, meta: "Şehir içi hızlı" },
  courier:{ label: "Kurye",        base: 55, perKm: 16, min: 85, meta: "Motorlu kurye" },
  van:    { label: "Araçlı Kurye", base: 75, perKm: 20, min: 120, meta: "Hacimli gönderi" },
  transfer:{label: "Transfer",     base: 120, perKm: 28, min: 180, meta: "Planlı / VIP" }
};

// Timeouts (sonsuz işlem yok)
const GEO_TIMEOUT_MS = 12000;
const API_TIMEOUT_MS = 15000;

let map, userMarker, dropMarker;
let pickup = null;   // {lat, lng}
let dropoff = null;  // {lat, lng}
let selectedService = null;
let computed = {distanceKm: null, price: null};

const els = {
  landing: document.getElementById("landing"),
  main: document.getElementById("main"),
  btnStart: document.getElementById("btnStart"),
  btnInfo: document.getElementById("btnInfo"),
  pillGeo: document.getElementById("pillGeo"),
  serviceGrid: document.getElementById("serviceGrid"),
  btnChangeService: document.getElementById("btnChangeService"),
  chipService: document.getElementById("chipService"),
  pickupText: document.getElementById("pickupText"),
  dropText: document.getElementById("dropText"),
  distText: document.getElementById("distText"),
  priceText: document.getElementById("priceText"),
  calcHint: document.getElementById("calcHint"),
  regCard: document.getElementById("regCard"),
  name: document.getElementById("name"),
  phone: document.getElementById("phone"),
  phoneErr: document.getElementById("phoneErr"),
  kvkkCheck: document.getElementById("kvkkCheck"),
  btnCall: document.getElementById("btnCall"),
  callState: document.getElementById("callState"),
  callOk: document.getElementById("callOk"),
  callErr: document.getElementById("callErr"),
  pickupNote: document.getElementById("pickupNote"),
  toast: document.getElementById("toast"),
  toastTitle: document.getElementById("toastTitle"),
  toastMsg: document.getElementById("toastMsg")
};

function toast(title, msg){
  els.toastTitle.textContent = title;
  els.toastMsg.textContent = msg;
  els.toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>els.toast.classList.remove("show"), 4200);
}

function setChipService(text){
  const strong = els.chipService.querySelector("strong");
  strong.textContent = text;
}

function fmtLatLng(p){
  if(!p) return "-";
  return `${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`;
}

function fmtKm(km){
  if(km == null) return "-";
  return `${km.toFixed(2)} km`;
}

function fmtPrice(p){
  if(p == null) return "-";
  return `${Math.round(p)} TL`;
}

/** =========================
 *  UI BUILD
 *  ========================= */
function buildServiceCards(){
  els.serviceGrid.innerHTML = "";
  const entries = Object.entries(SERVICE_RULES);
  for(const [key, rule] of entries){
    const div = document.createElement("div");
    div.className = "service";
    div.dataset.service = key;
    div.innerHTML = `
      <div>
        <div class="serviceName">${rule.label}</div>
        <div class="serviceMeta">${rule.meta}</div>
      </div>
      <div class="serviceMeta">Taban: ${rule.base} • km: ${rule.perKm} • min: ${rule.min}</div>
    `;
    div.addEventListener("click", () => onSelectService(key));
    els.serviceGrid.appendChild(div);
  }
}

function lockOtherServices(selectedKey){
  const cards = [...els.serviceGrid.querySelectorAll(".service")];
  for(const c of cards){
    const k = c.dataset.service;
    c.classList.toggle("selected", k === selectedKey);
    const disabled = (k !== selectedKey);
    c.classList.toggle("disabled", disabled);
  }
  els.btnChangeService.classList.remove("hidden");
}

function unlockServices(){
  const cards = [...els.serviceGrid.querySelectorAll(".service")];
  for(const c of cards){
    c.classList.remove("selected");
    c.classList.remove("disabled");
  }
  els.btnChangeService.classList.add("hidden");
}

/** =========================
 *  MAP + GEO
 *  ========================= */
function initMap(){
  map = L.map("map", { zoomControl:true });
  const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  });
  tiles.addTo(map);

  // Default center (Bursa)
  map.setView([40.195, 29.060], 13);

  map.on("click", (e) => {
    dropoff = {lat: e.latlng.lat, lng: e.latlng.lng};
    if(!dropMarker){
      dropMarker = L.marker([dropoff.lat, dropoff.lng]).addTo(map).bindPopup("Hedef").openPopup();
    }else{
      dropMarker.setLatLng([dropoff.lat, dropoff.lng]);
    }
    els.dropText.textContent = fmtLatLng(dropoff);
    computeIfPossible();
  });
}

function requestGeolocation(){
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation){
      reject(new Error("Tarayıcı konum desteği yok."));
      return;
    }

    let done = false;
    const timer = setTimeout(() => {
      if(done) return;
      done = true;
      reject(new Error("Konum alınamadı (zaman aşımı)."));
    }, GEO_TIMEOUT_MS);

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        if(done) return;
        done = true;
        clearTimeout(timer);
        resolve(pos);
      },
      (err) => {
        if(done) return;
        done = true;
        clearTimeout(timer);
        reject(new Error(err.message || "Konum alınamadı."));
      },
      { enableHighAccuracy:true, timeout:GEO_TIMEOUT_MS, maximumAge: 5000 }
    );
  });
}

function setPickup(lat, lng){
  pickup = {lat, lng};
  els.pickupText.textContent = fmtLatLng(pickup);
  els.pillGeo.textContent = "Konum: alındı";
  if(!userMarker){
    userMarker = L.marker([lat, lng]).addTo(map).bindPopup("Pickup (Siz)").openPopup();
  }else{
    userMarker.setLatLng([lat, lng]);
  }
  map.setView([lat, lng], 15);
}

/** =========================
 *  SERVICE SELECTION
 *  ========================= */
function onSelectService(serviceKey){
  if(selectedService) return; // tek seçim kilidi

  selectedService = serviceKey;
  lockOtherServices(serviceKey);
  setChipService(SERVICE_RULES[serviceKey].label);

  // Zorunlu kayıt alanları sadece hizmet seçilince görünür
  els.regCard.classList.remove("hidden");

  // Kullanıcıya yönlendirme
  toast("Hizmet seçildi", "Hedef noktayı haritada tıklayarak seçin. Mesafe ve ücret otomatik hesaplanır.");

  // hesap şartları değişti
  computed = {distanceKm:null, price:null};
  updateComputedUI();
  validateAll();
}

els.btnChangeService.addEventListener("click", () => {
  selectedService = null;
  unlockServices();
  setChipService("-");
  // kayıt alanları gizlenir (spec)
  els.regCard.classList.add("hidden");
  // hesaplar sıfırlanır
  computed = {distanceKm:null, price:null};
  updateComputedUI();
  validateAll();
});

/** =========================
 *  DISTANCE + PRICE
 *  ========================= */
function haversineKm(a, b){
  const R = 6371;
  const toRad = (x)=> x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
  return R * c;
}

function computeIfPossible(){
  if(!pickup || !dropoff || !selectedService) {
    computed = {distanceKm:null, price:null};
    updateComputedUI();
    validateAll();
    return;
  }
  const km = haversineKm(pickup, dropoff);
  const rule = SERVICE_RULES[selectedService];
  let price = rule.base + (km * rule.perKm);
  price = Math.max(price, rule.min);

  computed = {distanceKm: km, price};
  updateComputedUI();
  validateAll();
}

function updateComputedUI(){
  els.distText.textContent = fmtKm(computed.distanceKm);
  els.priceText.textContent = fmtPrice(computed.price);

  // “Ücret mesafe çıktıktan sonra çağır aktif olsun” kilidi
  if(computed.distanceKm != null && computed.price != null){
    els.calcHint.textContent = "Mesafe ve ücret hazır. Kayıt bilgilerini tamamlayın ve çağırın.";
  }else{
    els.calcHint.textContent = "Hizmet seçin + haritada hedef seçin. Sistem mesafe ve ücreti otomatik hesaplar.";
  }
}

/** =========================
 *  VALIDATION
 *  ========================= */
function isPhoneValid(v){
  return /^0[0-9]{10}$/.test((v||"").trim());
}

function validatePhone(){
  const ok = isPhoneValid(els.phone.value);
  els.phoneErr.classList.toggle("hidden", ok || els.phone.value.trim()==="");
  return ok;
}

function validateAll(){
  const hasService = !!selectedService;
  const hasComputed = computed.distanceKm != null && computed.price != null; // kilit
  const nameOk = (els.name.value || "").trim().length >= 2;
  const phoneOk = validatePhone();
  const kvkkOk = !!els.kvkkCheck.checked;

  // reg card only exists after service selection per spec; but still gate call button
  const canCall = hasService && hasComputed && nameOk && phoneOk && kvkkOk;

  els.btnCall.disabled = !canCall;
  return canCall;
}

els.phone.addEventListener("input", () => { validatePhone(); validateAll(); });
els.name.addEventListener("input", validateAll);
els.kvkkCheck.addEventListener("change", validateAll);

/** =========================
 *  API CALL (single endpoint)
 *  ========================= */
async function postJsonWithTimeout(url, payload, timeoutMs){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { data = { ok:false, error:"Backend JSON dönmedi", raw:text }; }
    return data;
  } finally {
    clearTimeout(t);
  }
}

function setCallLoading(isLoading, msg){
  if(isLoading){
    els.callState.innerHTML = `<span class="spinner"></span>${msg||"İşleniyor..."}`;
  }else{
    els.callState.textContent = msg||"";
  }
}

els.btnCall.addEventListener("click", async () => {
  els.callOk.classList.add("hidden");
  els.callErr.classList.add("hidden");
  els.callErr.textContent = "";

  if(!validateAll()){
    toast("Eksik bilgi", "Çağır için hizmet + hedef + ücret/mesafe + kayıt + KVKK gerekli.");
    return;
  }
  if(!BACKEND_URL || BACKEND_URL.includes("https://script.google.com/macros/s/AKfycbwIwaxcYtzl7pOCUJvXwCxjKBlJUBwV3m6akrP7MmFsynmXMqymjxdIxWbpqSWqfYzJ/exec")){
    els.callErr.textContent = "BACKEND_URL tanımlı değil. /exec URL’nizi index.html içine yapıştırın.";
    els.callErr.classList.remove("hidden");
    return;
  }

  // Payload (tek çağrı: create_request)
  const payload = {
    action: "create_request",
    client: { name: els.name.value.trim(), phone: els.phone.value.trim() },
    service: selectedService,
    pickup: { lat: pickup.lat, lng: pickup.lng },
    dropoff: { lat: dropoff.lat, lng: dropoff.lng },
    distance_km: Number(computed.distanceKm.toFixed(3)),
    price: Math.round(computed.price),
    note: (els.pickupNote.value || "").trim(),
    kvkk_accepted: true,
    ts: new Date().toISOString()
  };

  els.btnCall.disabled = true; // çift tık engeli
  setCallLoading(true, "Çağrı iletiliyor...");
  try{
    const data = await postJsonWithTimeout(BACKEND_URL, payload, API_TIMEOUT_MS);

    if(data && data.ok){
      els.callOk.classList.remove("hidden");
      toast("Başarılı", `Çağrı oluşturuldu. Job: ${data.job_id}`);
      setCallLoading(false, `Job: ${data.job_id}`);
    }else{
      const err = (data && (data.error || data.message)) ? (data.error || data.message) : "Bilinmeyen hata";
      els.callErr.textContent = err;
      els.callErr.classList.remove("hidden");
      setCallLoading(false, "Hata oluştu.");
    }
  }catch(e){
    const msg = (e && e.name === "AbortError") ? "Zaman aşımı. Lütfen tekrar deneyin." : (e.message || "İstek başarısız.");
    els.callErr.textContent = msg;
    els.callErr.classList.remove("hidden");
    setCallLoading(false, "İstek başarısız.");
  }finally{
    // tekrar validasyonla butonu doğru duruma getir
    els.btnCall.disabled = !validateAll();
  }
});

/** =========================
 *  START FLOW
 *  ========================= */
els.btnInfo.addEventListener("click", () => {
  toast("Nasıl çalışır?", "Başla → konum izni → hizmet seç → haritada hedef seç → ücret/mesafe çıksın → KVKK onayla → Çağır.");
});

els.btnStart.addEventListener("click", async () => {
  // Landing -> Main
  els.landing.classList.add("hidden");
  els.main.classList.remove("hidden");

  // Init map and UI
  buildServiceCards();
  initMap();

  // Request geo when map opened (spec)
  els.pillGeo.textContent = "Konum: isteniyor";
  try{
    const pos = await requestGeolocation();
    setPickup(pos.coords.latitude, pos.coords.longitude);
    toast("Konum alındı", "Haritada hedef noktayı tıklayarak seçin.");
  }catch(err){
    els.pillGeo.textContent = "Konum: alınamadı";
    toast("Konum alınamadı", "Harita varsayılan merkezde açıldı. Devam edebilirsiniz.");
  }

  // UI baseline
  els.pickupText.textContent = fmtLatLng(pickup);
  els.dropText.textContent = fmtLatLng(dropoff);
  updateComputedUI();
  validateAll();
});
</script>
</body>
</html>
