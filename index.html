<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900}
header span{color:#f5c400}
#map{height:30vh}
#panel{padding:12px}
.card{background:#111;border-radius:14px;padding:12px;margin-bottom:10px}
button{width:100%;padding:16px;border-radius:26px;border:0;font-size:16px;font-weight:900;background:#f5c400;color:#000}
#overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span></header>
<div id="map"></div>

<div id="panel">
  <div class="card">ğŸ“ Nereden</div>
  <div class="card">ğŸ Nereye</div>
  <button onclick="callTaxi()">TAKSÄ° Ã‡AÄIR</button>
</div>

<div id="overlay">
  <div>
    <h2>SÃ¼rÃ¼cÃ¼ aranÄ±yorâ€¦</h2>
    <p>LÃ¼tfen bekleyin</p>
  </div>
</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

let jobId=null, token=null;

const map=L.map("map").setView([40.195,29.060],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

async function callTaxi(){
  document.getElementById("overlay").style.display="flex";

  const res = await fetch(BACKEND,{
    method:"POST",
    body:JSON.stringify({
      action:"createJob",
      service:"taxi",
      customer_name:"Test KullanÄ±cÄ±",
      customer_phone:"05555555555",
      pickup_address:"Bursa",
      dropoff_address:"NilÃ¼fer",
      price:120
    })
  }).then(r=>r.json());

  jobId = res.job_id;
  token = res.track_token;

  poll();
}

async function poll(){
  if(!jobId) return;

  const j = await fetch(
    `${BACKEND}?action=getPublicJob&job_id=${jobId}&token=${token}`
  ).then(r=>r.json());

  if(j.status==="assigned"){
    window.location.href =
      `track.html?job_id=${jobId}&token=${token}`;
  }else{
    setTimeout(poll,3000);
  }
}
</script>

</body>
</html>
