<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{
  margin:0;
  height:100%;
  overflow:hidden;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:#f5f6fa;
}
.app{
  height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  height:56px;
  display:flex;
  align-items:center;
  padding:0 16px;
  font-weight:700;
  background:#fff;
  border-bottom:1px solid #ddd;
}
#map{
  height:40vh;
  min-height:220px;
}
.cards{
  flex:1;
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:12px;
  box-shadow:0 4px 14px rgba(0,0,0,.06);
}
.row{
  display:flex;
  gap:8px;
}
.btn{
  flex:1;
  padding:12px;
  border-radius:12px;
  border:none;
  font-weight:600;
  cursor:pointer;
}
.btn.primary{
  background:#000;
  color:#fff;
}
.btn.light{
  background:#f0f0f0;
}
input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:14px;
}
.notice{
  position:absolute;
  top:70px;
  left:50%;
  transform:translateX(-50%);
  background:#fff;
  padding:12px 16px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.2);
  z-index:1000;
}
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
.modal{
  background:#fff;
  border-radius:16px;
  padding:16px;
  width:90%;
  max-width:360px;
}
.modal h3{
  margin:0 0 10px 0;
}
</style>
</head>

<body>
<div class="app">

<header>SepetTaxi</header>

<div id="map"></div>

<div id="locationNotice" class="notice">
  Konum izni gerekli
  <button class="btn light" onclick="acceptLocation()">AnladÄ±m</button>
</div>

<div class="cards">

  <div class="card">
    <b>Hizmet</b>
    <div class="row" style="margin-top:8px">
      <button class="btn light" onclick="selectService('taxi')">ðŸš• Taxi</button>
      <button class="btn light" onclick="selectService('courier')">ðŸ“¦ Kurye</button>
    </div>
  </div>

  <div class="card">
    <input id="fromInput" placeholder="Nereden" readonly>
  </div>

  <div class="card">
    <input id="toInput" placeholder="Nereye" readonly>
  </div>

  <button class="btn primary" onclick="createJob()">Ã‡aÄŸÄ±r</button>

</div>
</div>

<!-- ZORUNLU KAYIT -->
<div class="modal-bg" id="registerModal">
  <div class="modal">
    <h3>KayÄ±t Ol</h3>
    <input id="regName" placeholder="Ad Soyad">
    <input id="regPhone" placeholder="Telefon" style="margin-top:8px">
    <button class="btn primary" style="margin-top:12px" onclick="saveUser()">Devam Et</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbzJ0blcuIXlOES8qswE5-xBwN5L4DAtDzkEgDPefH4t6uG6EOQT1-ir_zpeiRnAswAeSg/exec";

/* ================= STATE ================= */
let map, marker;
let currentService = null;
let currentLocation = null;
let user = JSON.parse(localStorage.getItem("sepettaxi_user") || "null");

/* ================= MAP ================= */
map = L.map("map",{zoomControl:false});
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
map.setView([39.92,32.85],13);

/* ================= LOCATION FLOW ================= */
function acceptLocation(){
  document.getElementById("locationNotice").remove();

  if(!navigator.geolocation){
    alert("TarayÄ±cÄ± konum desteklemiyor");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      currentLocation = {lat,lng};

      map.setView([lat,lng],15);
      marker = L.marker([lat,lng]).addTo(map);

      reverseGeocode(lat,lng);
    },
    ()=>{
      alert("Konum izni verilmedi");
    },
    {enableHighAccuracy:true}
  );
}

function reverseGeocode(lat,lng){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
    .then(r=>r.json())
    .then(data=>{
      document.getElementById("fromInput").value = data.display_name;
      document.getElementById("toInput").value   = data.display_name;
    })
    .catch(()=>{});
}

/* ================= SERVICE ================= */
function selectService(service){
  currentService = service;
  if(!user){
    document.getElementById("registerModal").style.display="flex";
  }
}

/* ================= REGISTER ================= */
function saveUser(){
  const name  = document.getElementById("regName").value.trim();
  const phone = document.getElementById("regPhone").value.trim();

  if(!name || !phone){
    alert("Ad ve telefon zorunlu");
    return;
  }

  user = {name,phone};
  localStorage.setItem("sepettaxi_user",JSON.stringify(user));
  document.getElementById("registerModal").style.display="none";
}

/* ================= CREATE JOB ================= */
function createJob(){
  if(!currentService){
    alert("Hizmet seÃ§iniz");
    return;
  }
  if(!user){
    alert("KayÄ±t gerekli");
    return;
  }
  if(!currentLocation){
    alert("Konum alÄ±namadÄ±");
    return;
  }

  fetch(`${API_URL}?path=createJob`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      service_type:currentService,
      user_name:user.name,
      user_phone:user.phone,
      pickup_lat:currentLocation.lat,
      pickup_lng:currentLocation.lng,
      pickup_address:document.getElementById("fromInput").value,
      dropoff_address:document.getElementById("toInput").value
    })
  }).then(()=>{
    alert("Talep alÄ±ndÄ±");
  });
}
</script>
</body>
</html>
