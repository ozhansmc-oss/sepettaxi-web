<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
:root{
 --y:#f5c400;--bg:#050506;--panel:#0f0f10;--line:rgba(255,255,255,.12);
 --mut:rgba(255,255,255,.6);
}
html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:system-ui;overflow:hidden}

/* TOPBAR */
.topbar{
 position:fixed;top:0;left:0;right:0;height:56px;
 display:flex;align-items:center;justify-content:space-between;
 padding:0 14px;border-bottom:1px solid var(--line);
 background:#050506;z-index:5000
}
.brand{font-weight:900;font-size:18px}
.brand b{color:var(--y)}
.iconBtn{
 width:36px;height:36px;border-radius:12px;
 border:1px solid var(--line);background:#111;color:#fff
}

/* DRAWER */
.drawerBack{position:fixed;inset:0;display:none;background:rgba(0,0,0,.6);z-index:6000}
.drawer{position:absolute;right:0;top:0;height:100%;width:300px;background:#0f0f10;padding:14px}
.drawerItem{
 padding:12px;border-radius:14px;border:1px solid var(--line);
 background:#141416;margin-bottom:10px;cursor:pointer
}

/* MAP + PANEL */
.wrap{position:fixed;inset:56px 0 0 0}
#map{height:100%;width:100%}
.sheet{
 position:absolute;left:0;right:0;bottom:0;height:55%;
 background:linear-gradient(180deg,#0f0f10,#050506);
 border-top:1px solid var(--line);
 border-radius:22px 22px 0 0;
 display:flex;flex-direction:column
}
.sheetBody{flex:1;overflow-y:auto;padding:14px}
.sheetFooter{
 position:sticky;bottom:0;padding:12px;
 background:linear-gradient(180deg,rgba(15,15,16,.6),rgba(15,15,16,.95))
}

/* UI */
.seg{display:flex;gap:10px}
.seg button{
 flex:1;height:42px;border-radius:14px;
 border:1px solid var(--line);background:#141416;color:#fff;font-weight:900
}
.seg .active{background:rgba(245,196,0,.15);border-color:#f5c400}

.label{font-size:12px;color:var(--mut);margin:8px 0}
.input{
 width:100%;height:44px;border-radius:14px;
 border:1px solid var(--line);background:#111;color:#fff;padding:0 12px
}
.metrics{display:none;gap:10px;margin-top:10px}
.metric{flex:1;border:1px solid var(--line);border-radius:14px;padding:10px}
.metric b{font-size:18px}

.cta{display:flex;gap:10px}
.btn{
 flex:1;height:50px;border-radius:16px;
 border:1px solid var(--line);background:#111;color:#fff;font-weight:900
}
.btn.primary{background:#f5c400;color:#000}

/* MODAL */
.modalBack{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:8000}
.modal{
 position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
 width:92%;max-width:420px;background:#0f0f10;
 border:1px solid var(--line);border-radius:22px;padding:14px
}

/* SEARCH */
.search{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:9000}
.searchCard{
 position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
 background:#141416;border:1px solid var(--line);
 border-radius:22px;padding:16px
}
</style>
</head>

<body>

<div class="topbar">
 <div class="brand">Sepet<b>Taxi</b></div>
 <button class="iconBtn" id="btnMenu">≡</button>
</div>

<div class="drawerBack" id="drawerBack">
 <div class="drawer">
  <div class="drawerItem" onclick="go('driver.html')">Sürücü Girişi</div>
  <div class="drawerItem" onclick="go('admin.html')">Admin</div>
  <div class="drawerItem" onclick="go('contracts/user.html')">Kullanıcı Sözleşmesi</div>
  <div class="drawerItem" onclick="go('contracts/driver.html')">Sürücü Sözleşmesi</div>
  <div class="drawerItem" onclick="go('contracts/privacy.html')">Gizlilik</div>
 </div>
</div>

<div class="wrap">
 <div id="map"></div>

 <div class="sheet">
  <div class="sheetBody">

   <div class="seg">
    <button id="segTaxi" class="active">Taksi</button>
    <button id="segCourier">Kurye</button>
   </div>

   <div class="label">Nereden</div>
   <input class="input" id="fromInput">

   <div class="label">Nereye</div>
   <input class="input" id="toInput">

   <div class="metrics" id="metrics">
    <div class="metric"><small>Mesafe</small><b id="mDist">—</b></div>
    <div class="metric"><small>Ücret</small><b id="mPrice">—</b></div>
   </div>

  </div>

  <div class="sheetFooter">
   <div class="cta">
    <button class="btn primary" id="btnCall">Çağır</button>
   </div>
  </div>
 </div>
</div>

<div class="modalBack" id="regBack">
 <div class="modal">
  <h3>Zorunlu Kayıt</h3>
  <input class="input" id="rFirst" placeholder="Ad">
  <input class="input" id="rLast" placeholder="Soyad">
  <input class="input" id="rPhone" placeholder="Telefon">
  <div class="cta" style="margin-top:10px">
   <button class="btn primary" id="btnSaveReg">Kaydet</button>
  </div>
 </div>
</div>

<div class="search" id="search">
 <div class="searchCard">Sürücü aranıyor…</div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxWzv0E6VTtozNwdcM0LjzG005OB42AB3eB0k8pGFKLH7oyxuaND9Dqi4-aN7ccP8Kw/exec";
let map,fromM,toM,service="taxi";
let customer=loadCustomer();

const $=id=>document.getElementById(id);
const go=u=>location.href=u;

function loadCustomer(){
 try{return JSON.parse(localStorage.getItem("sepettaxi_customer"))}catch(e){return null}
}
function saveCustomer(c){localStorage.setItem("sepettaxi_customer",JSON.stringify(c))}

function initMap(){
 map=L.map("map",{zoomControl:false,attributionControl:false}).setView([40.195,29.06],13);
 L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
 map.on("click",e=>{
  if(!fromM){fromM=L.marker(e.latlng).addTo(map);$("fromInput").value="Seçildi"}
  else{toM=L.marker(e.latlng).addTo(map);$("toInput").value="Seçildi";calc()}
 });
 setTimeout(()=>map.invalidateSize(),300);
}

function calc(){
 $("metrics").style.display="flex";
 $("mDist").textContent="5.5 km";
 $("mPrice").textContent="90 TL";
}

async function api(action,payload){
 const f=new URLSearchParams();
 f.append("action",action);
 Object.keys(payload||{}).forEach(k=>f.append(k,payload[k]));
 const r=await fetch(API_URL,{method:"POST",body:f});
 return await r.json();
}

$("segTaxi").onclick=()=>selectService("taxi");
$("segCourier").onclick=()=>selectService("courier");

function selectService(t){
 service=t;
 $("segTaxi").classList.toggle("active",t==="taxi");
 $("segCourier").classList.toggle("active",t==="courier");
 if(!customer)$("regBack").style.display="block";
}

$("btnSaveReg").onclick=()=>{
 customer={first:$("rFirst").value,last:$("rLast").value,phone:$("rPhone").value};
 if(!customer.first||!customer.last||!customer.phone)return alert("Eksik bilgi");
 saveCustomer(customer);
 $("regBack").style.display="none";
}

$("btnCall").onclick=async()=>{
 if(!customer)return $("regBack").style.display="block";
 $("search").style.display="block";
 const r=await api("createJob",{service_type:service});
 if(r&&r.job_id)location.href="track.html?job_id="+r.job_id;
};

$("btnMenu").onclick=()=>$("drawerBack").style.display="block";
$("drawerBack").onclick=e=>{if(e.target.id==="drawerBack")e.target.style.display="none"};

window.onload=initMap;
</script>
</body>
</html>
