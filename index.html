<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
:root{
  --y:#f5c400; --panel:#0f0f10; --card:#141416; --line:rgba(255,255,255,.12);
  --mut:rgba(255,255,255,.72); --mut2:rgba(255,255,255,.45);
  --shadow:0 18px 60px rgba(0,0,0,.55); --r:18px; --bad:#ff4d4d;
}
.app{height:100%;display:flex;flex-direction:column}
.topbar{
  height:56px;flex:0 0 56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;border-bottom:1px solid var(--line);background:rgba(5,5,6,.92);
  backdrop-filter:blur(10px);z-index:60;position:relative;
}
.brand{display:flex;align-items:center;gap:10px;font-weight:950}
.brand .dot{width:10px;height:10px;border-radius:99px;background:var(--y);box-shadow:0 0 0 6px rgba(245,196,0,.12)}
.iconbtn{
  width:40px;height:40px;border-radius:12px;border:1px solid var(--line);
  background:rgba(255,255,255,.04);color:#fff;display:grid;place-items:center;cursor:pointer;
}
.main{height:calc(100% - 56px);display:flex;flex-direction:column}
.viewport{height:100%;display:flex;flex-direction:column}
#map{flex:1 1 50%;min-height:45%;background:#0b0b0c;position:relative}
.sheet{
  flex:1 1 50%;max-height:55%;border-top:1px solid var(--line);
  background:linear-gradient(180deg, rgba(15,15,16,.98), rgba(10,10,11,.98));
  padding:12px;overflow:hidden;
}
.leaflet-control-zoom{display:none!important}
.card{
  background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:var(--r);
  padding:12px;box-shadow:var(--shadow);
}
.seg{display:flex;gap:8px;margin-top:8px}
.seg button{
  flex:1;padding:10px 10px;border-radius:14px;border:1px solid var(--line);
  background:rgba(255,255,255,.03);color:#fff;font-weight:900;cursor:pointer;
}
.seg button.active{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.10);box-shadow:0 0 0 3px rgba(245,196,0,.12) inset;}
.field{
  margin-top:10px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.03);
  padding:10px 12px;cursor:pointer;display:flex;justify-content:space-between;gap:10px;
}
.field .lbl{font-size:11px;color:var(--mut2);margin-bottom:4px}
.field .val{font-size:13px;font-weight:900;line-height:1.25}
.field .mini{font-size:11px;color:var(--mut2)}
.field.selecting{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.08)}
.metrics{display:none;gap:10px;margin-top:10px}
.metric{flex:1;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.03);padding:10px 12px}
.metric .k{font-size:11px;color:var(--mut2)}
.metric .v{margin-top:4px;font-size:16px;font-weight:950}
.cta{display:flex;gap:10px;margin-top:10px}
.btn{
  flex:1;border:0;border-radius:18px;padding:14px 14px;font-weight:950;cursor:pointer;background:var(--y);color:#000;
  box-shadow:0 10px 30px rgba(245,196,0,.22);
}
.btn:disabled{opacity:.45;cursor:not-allowed;box-shadow:none}
.ghost{
  width:54px;flex:0 0 54px;border:1px solid var(--line);background:rgba(255,255,255,.03);
  color:#fff;border-radius:18px;height:50px;cursor:pointer;
}
.hint{margin-top:10px;color:var(--mut2);font-size:12px;line-height:1.35}

/* Drawer */
.scrim{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:200;display:none}
.drawer{
  position:fixed;top:0;bottom:0;left:0;width:290px;background:rgba(12,12,13,.98);
  border-right:1px solid var(--line);transform:translateX(-105%);transition:transform .22s ease;
  z-index:210;padding:14px;display:flex;flex-direction:column;gap:10px;
}
.drawer.open{transform:translateX(0)} .scrim.show{display:block}
.drawer .item{border:1px solid var(--line);border-radius:16px;padding:12px;background:rgba(255,255,255,.03);cursor:pointer}
.drawer .item b{display:block} .drawer .item span{display:block;margin-top:4px;font-size:12px;color:var(--mut2)}
.drawer .foot{margin-top:auto;color:var(--mut2);font-size:11px;padding:10px 2px}

/* Modal (always above map) */
.modalWrap{
  position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.65);padding:16px;
}
.modal{
  width:min(520px, 100%);background:rgba(15,15,16,.98);border:1px solid var(--line);
  border-radius:22px;box-shadow:var(--shadow);padding:14px;max-height:85vh;overflow:auto;
}
.modal h2{margin:0 0 8px 0;font-size:16px}
.modal p{margin:0 0 12px 0;color:var(--mut);font-size:13px;line-height:1.35}
.in{width:100%;padding:12px 12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff;font-weight:800;outline:none}
.checks{display:flex;gap:10px;align-items:flex-start;margin-top:10px}
.checks input{margin-top:3px}
.checks label{font-size:12px;color:var(--mut);line-height:1.35}
.err{color:var(--bad);font-size:12px;display:none;margin-top:10px}
.actions{display:flex;gap:10px;margin-top:12px}
.actions .btn2{flex:1;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff;font-weight:900;cursor:pointer}
.actions .primary{background:var(--y);border-color:transparent;color:#000}

/* Searching overlay */
.searching{
  position:fixed;inset:0;z-index:9998;display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.62);backdrop-filter:blur(14px);
}
.searchBox{
  width:min(520px, 92vw);border-radius:26px;border:1px solid rgba(255,255,255,.14);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  box-shadow:0 30px 90px rgba(0,0,0,.65);padding:18px;text-align:center;
}
.badge{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;border:1px solid rgba(245,196,0,.35);background:rgba(245,196,0,.12);font-weight:950}
.spinner{width:18px;height:18px;border-radius:999px;border:2px solid rgba(245,196,0,.25);border-top-color:rgba(245,196,0,.95);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.t1{margin-top:10px;font-size:18px;font-weight:950}
.t2{margin-top:6px;color:var(--mut);font-size:13px;line-height:1.35}

/* status pill on map */
.statusline{position:absolute;left:12px;right:12px;top:12px;z-index:80;display:flex;justify-content:center;pointer-events:none}
.statuspill{pointer-events:none;border:1px solid var(--line);background:rgba(0,0,0,.45);backdrop-filter:blur(8px);padding:8px 12px;border-radius:999px;font-size:12px;color:var(--mut)}

/* Force leaflet below modal */
.leaflet-pane,.leaflet-control,.leaflet-top,.leaflet-bottom{z-index:10!important}
</style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand"><div class="dot"></div><div>Sepet<span style="color:var(--y)">Taxi</span></div></div>
    <div class="iconbtn" id="menuBtn" title="Menü">☰</div>
  </div>

  <div class="main">
    <div class="viewport">
      <div id="map">
        <div class="statusline"><div class="statuspill" id="statusHint">Konum alınıyor…</div></div>
      </div>

      <div class="sheet">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="font-weight:950">Hizmet</div>
            <div style="font-size:12px;color:var(--mut2)">Haritadan adres seç</div>
          </div>

          <div class="seg">
            <button id="btnTaxi" class="active" type="button">Taksi</button>
            <button id="btnCourier" type="button">Kurye</button>
          </div>

          <div class="field" id="fromField">
            <div>
              <div class="lbl">Nereden</div>
              <div class="val" id="fromText">Konum alınıyor…</div>
              <div class="mini" id="fromMini">Haritaya dokunarak seçebilirsin</div>
            </div>
            <div style="opacity:.7;font-size:12px;white-space:nowrap">Seç</div>
          </div>

          <div class="field" id="toField">
            <div>
              <div class="lbl">Nereye</div>
              <div class="val" id="toText">Haritadan seç</div>
              <div class="mini" id="toMini">Haritaya dokun</div>
            </div>
            <div style="opacity:.7;font-size:12px;white-space:nowrap">Seç</div>
          </div>

          <div class="metrics" id="metricsRow">
            <div class="metric"><div class="k">Mesafe</div><div class="v" id="kmText">—</div></div>
            <div class="metric"><div class="k">Ücret</div><div class="v" id="priceText">—</div></div>
          </div>

          <div class="cta">
            <button class="btn" id="callBtn" type="button" disabled>Taksi Çağır</button>
            <button class="ghost" id="resetBtn" type="button" title="Sıfırla">⟲</button>
          </div>

          <div class="hint" id="hintLine">
            Hizmet seçince zorunlu kayıt açılır. Kayıt tamamlanınca kaybolur, sonra akış devam eder.
          </div>
        </div>

        <div class="card" style="margin-top:10px;border-color:rgba(245,196,0,.35);background:linear-gradient(180deg, rgba(245,196,0,.10), rgba(255,255,255,.02))">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div style="font-weight:950">Sürücü müsün?</div>
              <div style="margin-top:4px;color:var(--mut2);font-size:12px">Sürücü paneline giriş yap ve iş al.</div>
            </div>
            <button class="btn2" id="driverGo" type="button" style="width:auto;padding:10px 12px;border-radius:14px;border:1px solid rgba(245,196,0,.35);background:rgba(245,196,0,.14);color:#fff;font-weight:900;cursor:pointer">Sürücü Ol</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Drawer -->
<div class="scrim" id="scrim"></div>
<div class="drawer" id="drawer">
  <div class="item" id="menuDriver"><b>Sürücü Girişi</b><span>driver.html</span></div>
  <div class="item" id="menuTrack"><b>Son İş Takibi</b><span>track.html?job_id=...</span></div>
  <div class="item" id="menuAdmin"><b>Admin</b><span>admin.html</span></div>
  <div class="item" id="menuSupport"><b>Destek</b><span>WhatsApp / e-posta</span></div>
  <div class="foot">© SepetTaxi • Scroll kapalı • 50/50 map + kart</div>
</div>

<!-- Mandatory Registration Modal -->
<div class="modalWrap" id="regWrap" aria-hidden="true">
  <div class="modal">
    <h2>Zorunlu Kayıt</h2>
    <p>Çağrı açmadan önce bilgilerini doğrulamamız gerekiyor. Kayıt tamamlanınca bu ekran tamamen kapanır ve akış devam eder.</p>

    <input class="in" id="firstName" placeholder="Ad" autocomplete="given-name" />
    <input class="in" id="lastName" placeholder="Soyad" autocomplete="family-name" />
    <input class="in" id="phone" placeholder="Telefon (05xx…)" inputmode="tel" autocomplete="tel" />

    <div class="checks">
      <input id="terms" type="checkbox" />
      <label for="terms">Hizmet taahhüdünü ve koşulları okudum, kabul ediyorum.</label>
    </div>

    <div class="err" id="regErr">Lütfen tüm alanları doldur ve taahhüdü onayla.</div>

    <div class="actions">
      <button class="btn2" id="regCancel" type="button">Vazgeç</button>
      <button class="btn2 primary" id="regOk" type="button">Kaydı Tamamla</button>
    </div>
  </div>
</div>

<!-- Searching Overlay -->
<div class="searching" id="searching">
  <div class="searchBox">
    <div class="badge"><span class="spinner"></span><span id="searchingBadgeText">Sürücü aranıyor</span></div>
    <div class="t1">Eşleştirme yapılıyor</div>
    <div class="t2">Konumun doğrulandı. En yakın uygun sürücüye yönlendiriyoruz…</div>
  </div>
</div>

<script>
/* ===== SepetTaxi Index FINAL ===== */
const API = "https://script.google.com/macros/s/AKfycbxHqb_E0gCqHmxWuzmdHqLb_IR7pHUGixIRd3Hh3MnVqegTPJEdJ4zM5Gb0Tc96Qb8C/exec";
  const resp = await apiJSONP({ action:"ping" });

let map, pickupMarker=null, dropMarker=null;
let pickup=null, dropoff=null;
let selecting=null; // "pickup" | "dropoff"
let serviceType="taxi";
let lastKM=null, lastPrice=null;

const $ = (id)=>document.getElementById(id);

function setHint(t){ $("statusHint").textContent = t; }
function go(url){ window.location.href = url; }

function loadCustomer(){
  try{ const s = localStorage.getItem("sepettaxi_customer"); return s ? JSON.parse(s) : null; }catch(_){ return null; }
}
function saveCustomer(c){ localStorage.setItem("sepettaxi_customer", JSON.stringify(c)); }
function isRegistered(){
  const c = loadCustomer();
  return !!(c && c.first && c.last && c.phone && c.terms === true);
}

function toRad(d){ return d*Math.PI/180; }
function haversineKm(a,b){
  const R=6371;
  const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const q=s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
  return 2*R*Math.asin(Math.sqrt(q));
}
function calcPrice(km, type){
  const base = (type==="courier") ? 79 : 89;
  const perKm = (type==="courier") ? 18 : 22;
  const p = Math.round(base + km*perKm);
  return Math.max(base, p);
}

async function reverseGeocode(lat,lng){
  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}&accept-language=tr`;
  const res = await fetch(url, { headers: { "Accept":"application/json" } });
  if(!res.ok) throw new Error("reverse_failed");
  const j = await res.json();
  return (j && (j.display_name || j.name)) ? (j.display_name || j.name) : `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
}

function initMap(){
  map = L.map("map", { zoomControl:false, attributionControl:true }).setView([41.0082, 28.9784], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  map.on("click", async (e)=>{
    if(!selecting) return;
    const lat=e.latlng.lat, lng=e.latlng.lng;
    try{
      setHint("Adres bulunuyor…");
      const addr = await reverseGeocode(lat,lng);
      if(selecting==="pickup") setPickup(lat,lng,addr,true);
      else setDropoff(lat,lng,addr,true);
      selecting=null; refreshSelectingUI();
      setHint("Adres seçildi. Devam edebilirsin.");
      updateComputed();
    }catch(_){
      const fallback = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      if(selecting==="pickup") setPickup(lat,lng,fallback,true);
      else setDropoff(lat,lng,fallback,true);
      selecting=null; refreshSelectingUI();
      setHint("Adres çözümlenemedi. Koordinat kaydedildi.");
      updateComputed();
    }
  });

  setTimeout(()=>map.invalidateSize(), 150);
  window.addEventListener("resize", ()=>setTimeout(()=>map.invalidateSize(),150));
}

function setPickup(lat,lng,addr,pan){
  pickup={lat,lng,address:addr};
  $("fromText").textContent = addr;
  $("fromMini").textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  if(!pickupMarker) pickupMarker = L.marker([lat,lng]).addTo(map);
  else pickupMarker.setLatLng([lat,lng]);
  if(pan) map.panTo([lat,lng], {animate:true,duration:0.35});
}
function setDropoff(lat,lng,addr,pan){
  dropoff={lat,lng,address:addr};
  $("toText").textContent = addr;
  $("toMini").textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  if(!dropMarker) dropMarker = L.marker([lat,lng]).addTo(map);
  else dropMarker.setLatLng([lat,lng]);
  if(pan) map.panTo([lat,lng], {animate:true,duration:0.35});
}

function refreshSelectingUI(){
  $("fromField").classList.toggle("selecting", selecting==="pickup");
  $("toField").classList.toggle("selecting", selecting==="dropoff");
}

function startSelecting(which){
  selecting = which;
  refreshSelectingUI();
  setHint(which==="pickup" ? "Nereden seçimi aktif. Haritaya dokun." : "Nereye seçimi aktif. Haritaya dokun.");
}

function showReg(){
  $("regWrap").style.display="flex";
  $("regWrap").setAttribute("aria-hidden","false");
  $("regErr").style.display="none";
  const c = loadCustomer();
  $("firstName").value = c?.first || "";
  $("lastName").value = c?.last || "";
  $("phone").value = c?.phone || "";
  $("terms").checked = !!c?.terms;
}
function hideReg(){
  $("regWrap").style.display="none";
  $("regWrap").setAttribute("aria-hidden","true");
}

function setService(type){
  serviceType = type;
  $("btnTaxi").classList.toggle("active", type==="taxi");
  $("btnCourier").classList.toggle("active", type==="courier");
  $("callBtn").textContent = (type==="courier") ? "Kurye Çağır" : "Taksi Çağır";
  $("searchingBadgeText").textContent = "Sürücü aranıyor";
  // Kilit: zorunlu kayıt hizmet seçerken açılır (ilk load’da otomatik değil)
  if(!isRegistered()) showReg();
  updateComputed();
}

function updateComputed(){
  const reg = isRegistered();
  const readyPoints = !!(pickup && dropoff);

  if(reg && readyPoints){
    const km = Math.max(0.1, haversineKm(pickup, dropoff));
    lastKM = km;
    lastPrice = calcPrice(km, serviceType);
    $("metricsRow").style.display="flex";
    $("kmText").textContent = km.toFixed(1) + " km";
    $("priceText").textContent = lastPrice + " ₺";
  }else{
    $("metricsRow").style.display="none";
    lastKM=null; lastPrice=null;
  }

  $("callBtn").disabled = !(reg && readyPoints);
}

function resetAll(){
  pickup=null; dropoff=null; selecting=null;
  refreshSelectingUI();
  if(pickupMarker){ map.removeLayer(pickupMarker); pickupMarker=null; }
  if(dropMarker){ map.removeLayer(dropMarker); dropMarker=null; }
  $("fromText").textContent="Konum alınıyor…";
  $("fromMini").textContent="Haritaya dokunarak seçebilirsin";
  $("toText").textContent="Haritadan seç";
  $("toMini").textContent="Haritaya dokun";
  setHint("Konum alınıyor…");
  requestGeolocation();
  updateComputed();
}

function qs(params){
  const u = new URLSearchParams();
  Object.keys(params).forEach(k=>{
    if(params[k]===undefined || params[k]===null) return;
    u.set(k, String(params[k]));
  });
  return u.toString();
}

function apiJSONP(params){
  return new Promise((resolve, reject)=>{
    const cb = "cb_" + Math.random().toString(16).slice(2);
    params.callback = cb;
    const u = new URLSearchParams(params);
    const s = document.createElement("script");
    window[cb] = (data)=>{
      try{ resolve(data); } finally{
        delete window[cb];
        s.remove();
      }
    };
    s.onerror = ()=>{
      delete window[cb];
      s.remove();
      reject(new Error("JSONP load failed"));
    };
    s.src = API + (API.includes("?") ? "&" : "?") + u.toString();
    document.head.appendChild(s);
  });
}


function showSearching(){ $("searching").style.display="flex"; }
function hideSearching(){ $("searching").style.display="none"; }

function requestGeolocation(){
  if(!navigator.geolocation){
    setHint("Cihaz konumu desteklemiyor. Haritadan Nereden seç.");
    $("fromText").textContent="Haritadan seç";
    return;
  }
  navigator.geolocation.getCurrentPosition(async (pos)=>{
    const lat=pos.coords.latitude, lng=pos.coords.longitude;
    map.setView([lat,lng], 16);
    try{
      setHint("Konum doğrulanıyor…");
      const addr = await reverseGeocode(lat,lng);
      setPickup(lat,lng,addr,false);
      setHint("Konum alındı. Nereye seçebilirsin.");
      updateComputed();
    }catch(_){
      setPickup(lat,lng,`${lat.toFixed(6)}, ${lng.toFixed(6)}`,false);
      setHint("Konum alındı (adres yok). Haritadan da seçebilirsin.");
      updateComputed();
    }
  }, ()=>{
    setHint("Konum izni verilmedi. Haritadan Nereden/Nereye seçebilirsin.");
    $("fromText").textContent="Haritadan seç";
  }, { enableHighAccuracy:true, timeout:9000, maximumAge:0 });
}

function openDrawer(){ $("scrim").classList.add("show"); $("drawer").classList.add("open"); }
function closeDrawer(){ $("scrim").classList.remove("show"); $("drawer").classList.remove("open"); }

function bindUI(){
  $("menuBtn").addEventListener("click", openDrawer);
  $("scrim").addEventListener("click", closeDrawer);

  $("menuDriver").addEventListener("click", ()=>go("driver.html"));
  $("menuAdmin").addEventListener("click", ()=>go("admin.html"));
  $("menuTrack").addEventListener("click", ()=>{
    const last = localStorage.getItem("sepettaxi_last_job_id");
    if(!last) return alert("Henüz bir iş yok.");
    go("track.html?job_id="+encodeURIComponent(last));
  });
  $("menuSupport").addEventListener("click", ()=>alert("Destek: sonraki adımda WhatsApp/e-posta linkleri."));

  $("driverGo").addEventListener("click", ()=>go("driver.html"));

  $("btnTaxi").addEventListener("click", ()=>setService("taxi"));
  $("btnCourier").addEventListener("click", ()=>setService("courier"));

  $("fromField").addEventListener("click", ()=>startSelecting("pickup"));
  $("toField").addEventListener("click", ()=>startSelecting("dropoff"));

  $("resetBtn").addEventListener("click", resetAll);

  $("regCancel").addEventListener("click", ()=>{
    hideReg();
    setHint("Kayıt olmadan çağrı açılamaz. Hizmet seçince tekrar açılır.");
    updateComputed();
  });

  $("regOk").addEventListener("click", ()=>{
    const first=$("firstName").value.trim();
    const last=$("lastName").value.trim();
    const phone=$("phone").value.trim();
    const terms=$("terms").checked;
    if(!first || !last || !phone || !terms){
      $("regErr").style.display="block";
      return;
    }
    saveCustomer({ first,last,phone,terms:true,created_at:Date.now() });
    hideReg(); // kilit: kayıt bitince tamamen kaybolur
    setHint("Kayıt tamamlandı. Şimdi adres seçip çağrı açabilirsin.");
    updateComputed();
  });

  $("callBtn").addEventListener("click", async ()=>{
    if(!isRegistered()){ showReg(); return; }
    if(!(pickup && dropoff)){ setHint("Lütfen Nereden ve Nereye seç."); return; }
    if(!lastKM || !lastPrice) updateComputed();

    const c = loadCustomer() || {};
    try{
      $("callBtn").disabled = true;
      showSearching();
      setHint("Çağrı oluşturuluyor…");

      const resp = await apiGET({
        action:"createJob",
        service_type: serviceType,
        customer_first: c.first || "",
        customer_last: c.last || "",
        customer_phone: c.phone || "",
        from_address: pickup.address,
        to_address: dropoff.address,
        pickup_lat: pickup.lat,
        pickup_lng: pickup.lng,
        dropoff_lat: dropoff.lat,
        dropoff_lng: dropoff.lng,
        distance_km: Number(lastKM.toFixed(3)),
        price: lastPrice,
        package_type: "",
        receiver_name: "",
        receiver_phone: ""
      });

      if(!resp || resp.ok !== true){ throw new Error(resp?.error || "create_failed"); }
      const jobId = resp.data?.job_id;
      if(!jobId) throw new Error("no_job_id");

      localStorage.setItem("sepettaxi_last_job_id", String(jobId));
      localStorage.setItem("sepettaxi_last_service", serviceType);

      setHint("Çağrı oluşturuldu. Takip ekranına yönlendiriliyorsun…");
      setTimeout(()=>go(`track.html?job_id=${encodeURIComponent(jobId)}`), 650);
    }catch(e){
      console.error(e);
      hideSearching();
      $("callBtn").disabled = false;
      setHint("Backend hatası. Lütfen tekrar dene.");
      alert("Backend hatası: " + (e.message || e));
    }
  });
}

(function boot(){
try{
    const resp = await apiJSONP({ action:"ping" });
    console.log("PING OK:", resp);
  }catch(e){
    console.error("PING FAIL:", e);
    alert("Backend bağlantı hatası");
    return;
  }  
  initMap();
  bindUI();
  requestGeolocation();

  // kilit: ilk load’da kayıt otomatik açılmasın. Hizmet seçimiyle açılacak.
  // default service type sadece UI ayarı:
  setService("taxi");
  hideReg(); // setService modal açabilir -> burada kilit gereği kapatıyoruz (ilk load)
  setHint("Konum alınıyor… GPS izni vermezsen haritadan seçebilirsin.");
  updateComputed();
})();
</script>
</body>
</html>
