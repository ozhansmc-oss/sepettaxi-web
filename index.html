<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#050506;color:#fff;overflow:hidden}
  :root{
    --y:#f5c400;
    --bg:#050506;
    --panel:#0f0f10;
    --card:#141416;
    --line:rgba(255,255,255,.10);
    --mut:rgba(255,255,255,.65);
    --mut2:rgba(255,255,255,.42);
    --ok:#3ddc84;
    --bad:#ff5a6a;
  }

  /* Topbar (global, single hamburger) */
  .topbar{
    position:fixed;left:0;right:0;top:0;height:56px;
    display:flex;align-items:center;justify-content:space-between;
    padding:0 12px;z-index:50;
    background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.10));
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
  .logo{
    width:28px;height:28px;border-radius:10px;
    background:radial-gradient(circle at 30% 30%, #ffe27a, #f5c400 55%, #b78d00 100%);
    box-shadow:0 8px 18px rgba(245,196,0,.18);
  }
  .actions{display:flex;align-items:center;gap:10px}
  .iconbtn{
    width:40px;height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
    background:rgba(20,20,22,.55);
    display:grid;place-items:center;
    color:#fff;
  }
  .iconbtn:active{transform:scale(.98)}
  .dot{width:8px;height:8px;border-radius:50%;background:var(--y);box-shadow:0 0 0 3px rgba(245,196,0,.18)}
  .hamb{display:flex;flex-direction:column;gap:4px}
  .hamb span{width:18px;height:2px;background:#fff;border-radius:2px;opacity:.9}

  /* Layout (no scroll; map 50% + bottom card 50%) */
  .wrap{position:fixed;inset:56px 0 0 0;display:flex;flex-direction:column}
  #map{flex:1 1 50%;min-height:50%}
  .sheet{
    flex:1 1 50%;
    background:linear-gradient(180deg, rgba(20,20,22,.92), rgba(10,10,12,.98));
    border-top:1px solid rgba(255,255,255,.08);
    padding:12px;
  }

  .row{display:flex;gap:10px}
  .pill{
    flex:1;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    border-radius:16px;
    padding:10px 12px;
    display:flex;gap:10px;align-items:center;
  }
  .pill .tag{
    font-size:12px;color:rgba(255,255,255,.62);
    padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    white-space:nowrap;
  }
  .pill .val{font-weight:800;font-size:13px;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .hint{margin:10px 2px 0;color:rgba(255,255,255,.58);font-size:12px}

  .serviceTabs{margin-top:10px;display:flex;gap:10px}
  .tab{
    flex:1;border-radius:18px;padding:12px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    display:flex;align-items:center;justify-content:space-between;
    font-weight:900;
  }
  .tab small{font-weight:800;color:rgba(255,255,255,.58)}
  .tab.active{
    border-color:rgba(245,196,0,.45);
    background:rgba(245,196,0,.10);
    box-shadow:0 10px 22px rgba(245,196,0,.10);
  }

  .metrics{display:flex;gap:10px;margin-top:10px}
  .metric{
    flex:1;background:rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;padding:12px;
  }
  .metric .k{font-size:12px;color:rgba(255,255,255,.55)}
  .metric .v{margin-top:4px;font-size:18px;font-weight:950}

  .btn{
    margin-top:10px;width:100%;
    border:0;border-radius:18px;padding:14px 14px;
    font-weight:950;
    background:linear-gradient(135deg, #f5c400, #ffd34d);
    color:#1a1400;
  }
  .btn[disabled]{opacity:.45}
  .btn:active{transform:scale(.99)}

  /* premium searching overlay */
  .overlay{
    position:fixed;inset:0;z-index:80;
    display:none;align-items:center;justify-content:center;
    background:rgba(0,0,0,.45);
    backdrop-filter: blur(10px);
  }
  .ovCard{
    width:min(360px,92vw);
    background:rgba(20,20,22,.86);
    border:1px solid rgba(255,255,255,.12);
    border-radius:26px;
    padding:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.55);
    position:relative;overflow:hidden;
  }
  .glow{
    position:absolute;inset:-80px -80px auto auto;
    width:180px;height:180px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, rgba(245,196,0,.42), rgba(245,196,0,0) 70%);
    filter:blur(2px);
  }
  .ovTitle{font-size:16px;font-weight:950}
  .ovSub{margin-top:6px;color:rgba(255,255,255,.62);font-size:13px}
  .loader{
    margin-top:14px;height:10px;border-radius:999px;
    background:rgba(255,255,255,.08);overflow:hidden;
    border:1px solid rgba(255,255,255,.10);
  }
  .bar{
    height:100%;width:42%;
    background:linear-gradient(90deg, rgba(245,196,0,.20), rgba(245,196,0,.95), rgba(245,196,0,.20));
    animation:slide 1.15s infinite linear;
  }
  @keyframes slide{0%{transform:translateX(-120%)}100%{transform:translateX(320%)}}
  .badge{
    margin-top:10px;display:inline-flex;align-items:center;gap:8px;
    padding:8px 10px;border-radius:999px;
    border:1px solid rgba(245,196,0,.35);
    background:rgba(245,196,0,.12);
    font-weight:950;font-size:12px;color:#fff;
  }

  /* Drawer */
  .drawer{
    position:fixed;top:56px;right:0;bottom:0;width:min(360px,88vw);
    background:rgba(15,15,16,.92);
    border-left:1px solid rgba(255,255,255,.10);
    backdrop-filter: blur(14px);
    transform:translateX(110%);
    transition:transform .22s ease;
    z-index:90;
    padding:14px;
  }
  .drawer.open{transform:translateX(0)}
  .dTitle{font-weight:950;font-size:14px;margin:4px 4px 12px}
  .dItem{
    display:flex;align-items:center;justify-content:space-between;
    padding:12px;border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    margin-bottom:10px;
    text-decoration:none;color:#fff;
    font-weight:900;
  }
  .dItem small{font-weight:800;color:rgba(255,255,255,.58)}
  .dWarn{color:rgba(255,255,255,.55);font-size:12px;margin-top:10px}

  /* Modal register (mandatory) */
  .modal{
    position:fixed;inset:0;z-index:95;display:none;
    background:rgba(0,0,0,.55);backdrop-filter:blur(10px);
    align-items:center;justify-content:center;
    padding:16px;
  }
  .mCard{
    width:min(420px,94vw);
    background:rgba(20,20,22,.92);
    border:1px solid rgba(255,255,255,.12);
    border-radius:26px;
    padding:16px;
  }
  .mHead{display:flex;align-items:center;justify-content:space-between}
  .mHead b{font-size:15px;font-weight:950}
  .xbtn{border:0;background:transparent;color:#fff;font-size:22px;line-height:1}
  .fld{margin-top:10px}
  .fld label{display:block;font-size:12px;color:rgba(255,255,255,.58);margin:0 0 6px 2px}
  .inp{
    width:100%;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    color:#fff;
    padding:12px 12px;
    font-weight:800;
    outline:none;
  }
  .mBtnRow{display:flex;gap:10px;margin-top:12px}
  .mBtn{
    flex:1;border:0;border-radius:16px;padding:12px;font-weight:950;
    background:rgba(255,255,255,.08);color:#fff;
    border:1px solid rgba(255,255,255,.12);
  }
  .mBtn.primary{
    background:linear-gradient(135deg, #f5c400, #ffd34d);
    color:#1a1400;border:0;
  }

  /* Debug panel (hidden by default) */
  .dbg{
    position:fixed;left:10px;right:10px;bottom:10px;z-index:110;
    display:none;
    background:rgba(0,0,0,.65);
    border:1px solid rgba(255,255,255,.12);
    border-radius:16px;
    padding:10px;
    font-size:12px;
    color:rgba(255,255,255,.85);
    white-space:pre-wrap;
    max-height:28vh;
    overflow:auto;
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="brand">
    <div class="logo"></div>
    <div>SepetTaxi</div>
  </div>
  <div class="actions">
    <button class="iconbtn" id="locBtn" title="Konumu Yenile"><div class="dot"></div></button>
    <button class="iconbtn" id="menuBtn" title="Menü">
      <div class="hamb"><span></span><span></span><span></span></div>
    </button>
  </div>
</div>

<div class="wrap">
  <div id="map"></div>

  <div class="sheet">
    <div class="row">
      <div class="pill" id="fromPill">
        <div class="tag">Nereden</div>
        <div class="val" id="fromTxt">Haritadan seç</div>
      </div>
      <div class="pill" id="toPill">
        <div class="tag">Nereye</div>
        <div class="val" id="toTxt">Haritadan seç</div>
      </div>
    </div>

    <div class="hint" id="statusHint">Konum alınıyor… İzin vermezsen haritadan seçim yapabilirsin.</div>

    <div class="serviceTabs">
      <div class="tab active" id="tabTaxi"><div>Taksi</div><small>TAG benzeri</small></div>
      <div class="tab" id="tabCourier"><div>Kurye</div><small>Moto</small></div>
    </div>

    <div class="metrics">
      <div class="metric">
        <div class="k">Mesafe</div>
        <div class="v" id="kmTxt">—</div>
      </div>
      <div class="metric">
        <div class="k">Ücret</div>
        <div class="v" id="priceTxt">—</div>
      </div>
    </div>

    <button class="btn" id="callBtn" disabled>Taksi Çağır</button>

    <div class="hint">Haritada dokun → ilk dokunuş “Nereden”, ikinci dokunuş “Nereye”.</div>
  </div>
</div>

<!-- premium searching overlay -->
<div class="overlay" id="overlay">
  <div class="ovCard">
    <div class="glow"></div>
    <div class="ovTitle" id="ovTitle">Sürücü aranıyor</div>
    <div class="ovSub" id="ovSub">Yakındaki sürücüler otomatik eşleştiriliyor…</div>
    <div class="loader"><div class="bar"></div></div>
    <div class="badge">Canlı eşleştirme</div>
  </div>
</div>

<!-- drawer -->
<div class="drawer" id="drawer">
  <div class="dTitle">Menü</div>
  <a class="dItem" href="driver.html">
    <div>Sürücü girişi</div><small>Driver panel</small>
  </a>
  <a class="dItem" href="admin.html">
    <div>Admin</div><small>PIN</small>
  </a>
  <div class="dWarn">Not: Admin erişimi PIN ile korumalıdır.</div>
</div>

<!-- mandatory register modal -->
<div class="modal" id="regModal">
  <div class="mCard">
    <div class="mHead">
      <b>Zorunlu Kayıt</b>
      <button class="xbtn" id="regClose" title="Kapat">×</button>
    </div>

    <div class="fld">
      <label>Ad</label>
      <input class="inp" id="cFirst" placeholder="Örn. Özhan" />
    </div>
    <div class="fld">
      <label>Soyad</label>
      <input class="inp" id="cLast" placeholder="Örn. Samurcu" />
    </div>
    <div class="fld">
      <label>Telefon</label>
      <input class="inp" id="cPhone" placeholder="05xx..." inputmode="tel" />
    </div>

    <div id="courierFields" style="display:none">
      <div class="fld">
        <label>Paket tipi</label>
        <input class="inp" id="pType" placeholder="Evrak / Küçük paket / Hassas…" />
      </div>
      <div class="fld">
        <label>Alıcı adı</label>
        <input class="inp" id="rName" placeholder="Ad Soyad" />
      </div>
      <div class="fld">
        <label>Alıcı telefon</label>
        <input class="inp" id="rPhone" placeholder="05xx..." inputmode="tel" />
      </div>
      <div class="fld">
        <label>Not</label>
        <input class="inp" id="pNote" placeholder="Kapı no / teslim talimatı…" />
      </div>
    </div>

    <div class="mBtnRow">
      <button class="mBtn" id="regCancel">Vazgeç</button>
      <button class="mBtn primary" id="regOk">Kaydet</button>
    </div>
  </div>
</div>

<div class="dbg" id="dbg"></div>

<script>
/* =========================
   CONFIG (LIVE BACKEND)
========================= */
const API = "https://script.google.com/macros/s/AKfycbxxvr6OPG5R-emW8WlquzZ1psFEn6Lbvt4dDHpdN8XWO494N7uCv3s4DhLreIhO59b-/exec";

/* Turn on only if you need raw debugging on-screen */
const DEBUG_PANEL = false;

/* =========================
   STATE
========================= */
let map, markerFrom, markerTo, line;
let from = null, to = null;
let serviceType = "taxi";
let lastDistanceKm = 0;
let lastPrice = 0;

/* =========================
   HELPERS
========================= */
const $ = id => document.getElementById(id);

function dbg(text){
  if(!DEBUG_PANEL) return;
  const el = $("dbg");
  el.style.display = "block";
  el.textContent = String(text || "");
}

function hint(t){ $("statusHint").textContent = t; }

function drawer(open){
  $("drawer").classList.toggle("open", !!open);
}

function overlay(show, title, sub){
  $("overlay").style.display = show ? "flex" : "none";
  if(title) $("ovTitle").textContent = title;
  if(sub) $("ovSub").textContent = sub;
}

function updatePills(){
  $("fromTxt").textContent = from ? from.address : "Haritadan seç";
  $("toTxt").textContent = to ? to.address : "Haritadan seç";
}

function updateMetrics(){
  if(from && to){
    $("kmTxt").textContent = (lastDistanceKm ? lastDistanceKm.toFixed(2) : "—") + " km";
    $("priceTxt").textContent = (lastPrice ? Math.round(lastPrice) : "—") + " ₺";
  }else{
    $("kmTxt").textContent = "—";
    $("priceTxt").textContent = "—";
  }
  $("callBtn").disabled = !(from && to);
}

function setService(type, {forceRegisterPrompt=false} = {}){
  serviceType = type;
  $("tabTaxi").classList.toggle("active", type==="taxi");
  $("tabCourier").classList.toggle("active", type==="courier");
  $("callBtn").textContent = (type==="courier") ? "Kurye Çağır" : "Taksi Çağır";
  $("courierFields").style.display = (type==="courier") ? "block" : "none";

  // ZORUNLU KAYIT: hizmet seçimi anında
  if(forceRegisterPrompt && !loadCustomer()){
    openRegister();
  }

  computeDistanceAndPrice().then(updateMetrics);
}

/* =========================
   STORAGE (Customer)
========================= */
function loadCustomer(){
  try{
    const s = localStorage.getItem("sepettaxi_customer");
    return s ? JSON.parse(s) : null;
  }catch(_){ return null; }
}
function saveCustomer(obj){
  localStorage.setItem("sepettaxi_customer", JSON.stringify(obj));
}

/* =========================
   MAP + GEO
========================= */
function initMap(){
  map = L.map("map", { zoomControl:false }).setView([40.195,29.060], 13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution:"" }).addTo(map);

  map.on("click", async (ev)=>{
    const latlng = ev.latlng;
    const addr = await reverseGeocode(latlng.lat, latlng.lng);

    if(!from){
      from = { lat:latlng.lat, lng:latlng.lng, address: addr || `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}` };
      if(markerFrom) markerFrom.remove();
      markerFrom = L.marker(latlng).addTo(map);
      hint("Nereye seç: Haritadan hedef noktaya dokun.");
    }else{
      to = { lat:latlng.lat, lng:latlng.lng, address: addr || `${latlng.lat.toFixed(5)}, ${latlng.lng.toFixed(5)}` };
      if(markerTo) markerTo.remove();
      markerTo = L.marker(latlng).addTo(map);
      drawLine();
      await computeDistanceAndPrice();
    }

    updatePills();
    updateMetrics();
  });

  hint("Konum alınıyor… İzin vermezsen haritadan seçim yapabilirsin.");
  locateOnce();
}

function drawLine(){
  if(line) line.remove();
  if(from && to){
    line = L.polyline([[from.lat,from.lng],[to.lat,to.lng]], { weight:5, opacity:.9 }).addTo(map);
    map.fitBounds(line.getBounds(), { padding:[40,40] });
  }
}

async function reverseGeocode(lat,lng){
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`;
    const r = await fetch(url, { headers:{ "Accept":"application/json" }});
    const j = await r.json();
    return j && j.display_name ? j.display_name : "";
  }catch(_){ return ""; }
}

function locateOnce(){
  if(!navigator.geolocation){
    hint("Konum desteklenmiyor. Haritadan seçim yap.");
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    map.setView([lat,lng], 15);
    hint("Konum alındı. Haritadan ‘Nereden’ seçebilirsin.");
  }, _=>{
    hint("Konum alınamadı. Haritadan seçim yapabilirsin.");
  }, { enableHighAccuracy:true, timeout:8000, maximumAge:0 });
}

function haversineKm(aLat,aLng,bLat,bLng){
  const R=6371, toRad=x=>x*Math.PI/180;
  const dLat=toRad(bLat-aLat), dLng=toRad(bLng-aLng);
  const sa=Math.sin(dLat/2), sb=Math.sin(dLng/2);
  const q=sa*sa + Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*sb*sb;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(q)));
}

async function computeDistanceAndPrice(){
  if(!(from && to)){
    lastDistanceKm = 0; lastPrice = 0; return;
  }
  lastDistanceKm = haversineKm(from.lat, from.lng, to.lat, to.lng);
  if(serviceType==="courier"){
    lastPrice = Math.max(70, 40 + lastDistanceKm*18);
  }else{
    lastPrice = Math.max(90, 50 + lastDistanceKm*22);
  }
}

/* =========================
   API (robust JSON handling)
========================= */
async function apiPost(payload){
  // Ekranda kanıt: giden payload
  const pretty = JSON.stringify(payload, null, 2);
  document.getElementById("statusHint").textContent = "Gönderilen payload hazır.";
  alert("GİDEN PAYLOAD:\n" + pretty);

  const r = await fetch(API, {
    method: "POST",
    cache: "no-store",
    headers: {
      "Content-Type": "text/plain;charset=utf-8",
      "Accept": "application/json"
    },
    body: JSON.stringify(payload) // ⚠️ MUTLAKA stringify
  });

  const text = await r.text();
  alert("GELEN YANIT (RAW):\n" + text.slice(0, 1200));

  // HTML geldiyse (backend’e gitmiyor / fallback)
  const t = (text || "").trim();
  if(t.startsWith("<")) throw new Error("HTML döndü (JSON bekleniyordu).");

  // JSON parse
  let obj;
  try{ obj = JSON.parse(text); }catch(e){ throw new Error("JSON parse edilemedi."); }
  return obj;
}

/* =========================
   MANDATORY REGISTER
========================= */
function openRegister(){
  $("regModal").style.display = "flex";
}
function closeRegister(){
  $("regModal").style.display = "none";
}
function validateRegister(){
  const first = $("cFirst").value.trim();
  const last  = $("cLast").value.trim();
  const phone = $("cPhone").value.trim();

  if(!first || !last || !phone){
    return { ok:false, error:"Lütfen ad, soyad ve telefonu gir." };
  }

  const base = { customer_first:first, customer_last:last, customer_phone:phone };

  if(serviceType==="courier"){
    const package_type = $("pType").value.trim();
    const receiver_name = $("rName").value.trim();
    const receiver_phone = $("rPhone").value.trim();
    const package_note = $("pNote").value.trim();
    if(!package_type || !receiver_name || !receiver_phone){
      return { ok:false, error:"Kurye için paket tipi, alıcı adı ve alıcı telefonu zorunlu." };
    }
    return { ok:true, customer:base, courier:{ package_type, receiver_name, receiver_phone, package_note } };
  }

  return { ok:true, customer:base, courier:null };
}

/* =========================
   CREATE JOB (working)
========================= */
async function createJob(){
  if(!(from && to)) return;

  // mandatory customer must exist before createJob
  const c = loadCustomer();
  if(!c){
    openRegister();
    return;
  }

  overlay(true, "Sürücü aranıyor", "Yakındaki sürücüler otomatik eşleştiriliyor…");

  try{
    await computeDistanceAndPrice();

const payload = {
  action: "createJob",              // ⬅️ KRİTİK (ilk satır)
  service_type: serviceType,

  customer_first: c.customer_first,
  customer_last: c.customer_last,
  customer_phone: c.customer_phone,

  from_address: from.address,
  to_address: to.address,

  pickup_lat: from.lat,
  pickup_lng: from.lng,
  dropoff_lat: to.lat,
  dropoff_lng: to.lng,

  distance_km: lastDistanceKm,
  price: lastPrice
};

    if(serviceType==="courier" && c.courier){
      payload.package_type = c.courier.package_type;
      payload.receiver_name = c.courier.receiver_name;
      payload.receiver_phone = c.courier.receiver_phone;
      payload.package_note = c.courier.package_note;
    }

    const res = await apiPost(payload);
    if(!res || !res.ok) throw new Error((res && res.error) ? res.error : "API error");

    // success → track
    window.location.href = `track.html?job_id=${encodeURIComponent(res.job_id)}`;

  }catch(e){
    overlay(false);
    hint("Hata: " + (e && e.message ? e.message : e));
    alert("İşlem başarısız:\n" + (e && e.message ? e.message : e));
  }
}

/* =========================
   EVENTS
========================= */
$("menuBtn").onclick = ()=> drawer(!$("drawer").classList.contains("open"));
$("locBtn").onclick = ()=> locateOnce();

$("tabTaxi").onclick = ()=> setService("taxi", { forceRegisterPrompt:true });
$("tabCourier").onclick = ()=> setService("courier", { forceRegisterPrompt:true });

$("callBtn").onclick = ()=> createJob();

// modal
$("regClose").onclick = closeRegister;
$("regCancel").onclick = closeRegister;
$("regOk").onclick = ()=>{
  const v = validateRegister();
  if(!v.ok){ alert(v.error); return; }

  const obj = { ...v.customer, service_type: serviceType };
  if(v.courier) obj.courier = v.courier;

  saveCustomer(obj);
  closeRegister();
  hint("Kayıt tamam. Adresleri seçip çağırabilirsin.");
};

// close drawer when clicking outside
document.addEventListener("click",(ev)=>{
  const d = $("drawer");
  if(!d.classList.contains("open")) return;
  const inside = d.contains(ev.target) || $("menuBtn").contains(ev.target);
  if(!inside) drawer(false);
});

/* =========================
   BOOT
========================= */
initMap();
setService("taxi", { forceRegisterPrompt: false }); // boot default
updatePills();
updateMetrics();

// Eğer müşteri yoksa: ilk hizmet seçimine dokununca zorunlu kayıt açılacak (kilitli karar)
</script>
</body>
</html>
