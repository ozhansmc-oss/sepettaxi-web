<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400}
/* â€¦ same minimal CSS like before â€¦ */
</style>
</head>
<body>

<!-- LANDING -->
<div id="landing">
  <div>
    <h1>Sepet<span>Taxi</span></h1>
    <button onclick="start()">BAÅžLA</button>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <header>Sepet<span>Taxi</span></header>
  <div id="map"></div>
  <div id="panel">
    <div>
      <b>Hizmet SeÃ§</b>
      <div>
        <button id="svcTaxi">ðŸš• Taksi</button>
        <button id="svcCourier">ðŸ“¦ Kurye</button>
      </div>
    </div>
    <div><input id="fromAddr" readonly placeholder="Nereden"></div>
    <div><input id="toAddr" readonly placeholder="Nereye"></div>

    <div id="courierBox" style="display:none">
      <input id="pkgType" placeholder="Paket TÃ¼rÃ¼">
      <input id="rcvName" placeholder="AlÄ±cÄ± AdÄ±">
      <input id="rcvPhone" placeholder="05XXXXXXXXX">
    </div>

    <div>
      <div>Mesafe: <span id="dist">â€”</span></div>
      <div>Ãœcret: <span id="price">â€”</span> TL</div>
    </div>
  </div>

  <button id="callBtn" disabled onclick="callDriver()">Ã‡AÄžIR</button>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";
let map,fromM,toM,service=null,registered=false,user=null;

// â€¦ Initialize Map and Geo â€¦
function start(){
  document.getElementById("landing").style.display="none";
  document.getElementById("app").style.display="block";
  initMap();
}

function initMap(){
  map=L.map("map").setView([41,29],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  navigator.geolocation.getCurrentPosition(p=>{
    fromM=L.marker([p.coords.latitude,p.coords.longitude]).addTo(map);
    map.setView([p.coords.latitude,p.coords.longitude],15);
  });
  map.on("click",e=>{
    if(!fromM) fromM=L.marker(e.latlng).addTo(map);
    else if(!toM) toM=L.marker(e.latlng).addTo(map);
    else toM.setLatLng(e.latlng);
    calc();
    updateCTA();
  });
}

document.getElementById("svcTaxi").onclick=()=>pickService("taxi");
document.getElementById("svcCourier").onclick=()=>pickService("courier");

function pickService(t){
  service=t;
  document.getElementById("courierBox").style.display = t==="courier"?"block":"none";
  updateCTA(); calc();
}

function calc(){
  if(!service||!fromM||!toM) return;
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=haversine(a.lat,a.lng,b.lat,b.lng);
  document.getElementById("dist").textContent = km.toFixed(2);
  const brut = Math.round(service==="taxi"?Math.max(120,60+km*22):Math.max(80,40+km*15));
  document.getElementById("price").textContent = brut;
}

function updateCTA(){
  const ok = service && fromM && toM && document.getElementById("dist").textContent!=="â€”";
  document.getElementById("callBtn").disabled = !ok;
}

function callDriver(){
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const payload = {
    action:"createJob",
    service_type: service,
    from_addr: document.getElementById("fromAddr").value,
    to_addr: document.getElementById("toAddr").value,
    from_lat: a.lat, from_lng: a.lng,
    to_lat: b.lat, to_lng: b.lng,
    distance_km: parseFloat(document.getElementById("dist").textContent),
    price_brut: parseInt(document.getElementById("price").textContent,10),
    customer: user||{},
    courier: service==="courier"?{
      pkg_type:document.getElementById("pkgType").value,
      recv_name:document.getElementById("rcvName").value,
      recv_phone:document.getElementById("rcvPhone").value
    }:{}
  };

  fetch(BACKEND_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(d=>{
    if(d.job_id) pollJob(d.job_id);
  });
}

function pollJob(jobId){
  const iv = setInterval(()=>{
    fetch(`${BACKEND_URL}?action=getJob&job_id=${jobId}`)
    .then(r=>r.json())
    .then(j=>{
      if(j.driver_id){
        clearInterval(iv);
        location.href=`track.html?job_id=${encodeURIComponent(jobId)}`;
      }
    });
  },2500);
}

function haversine(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
</script>

</body>
</html>
