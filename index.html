<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SepetTaxi</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2a;
      --panel2:#0f1726;
      --text:#eef3ff;
      --muted:#a9b6d8;
      --line:rgba(255,255,255,.12);
      --btn:#1b2a45;
      --btn2:#223557;
      --accent:#60a5fa;
      --good:#22c55e;
      --warn:#fbbf24;
      --bad:#fb7185;
      --r:14px;
      --shadow: 0 16px 34px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
    }

    /* Screens */
    .screen{position:fixed; inset:0; display:none;}
    .screen.active{display:block;}

    /* Screen 1: Landing (only banner + button) */
    .landing{
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      background:
        radial-gradient(900px 700px at 15% 10%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(900px 700px at 85% 20%, rgba(34,197,94,.14), transparent 55%),
        var(--bg);
    }
    .banner{
      width:min(860px, 100%);
      border:1px solid var(--line);
      border-radius:18px;
      background: linear-gradient(180deg, rgba(17,26,42,.92), rgba(15,23,38,.72));
      box-shadow: var(--shadow);
      padding:22px;
    }
    .banner h1{margin:0 0 8px; font-size:22px; line-height:1.2}
    .banner p{margin:0 0 16px; color:var(--muted); line-height:1.5}
    .btn{
      border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      padding:12px 14px;
      border-radius: 12px;
      font-weight:800;
      cursor:pointer;
      transition: background .15s ease, transform .06s ease, border-color .15s ease;
    }
    .btn:hover{background: var(--btn2); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(96,165,250,.50));
      border-color: rgba(96,165,250,.45);
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.good{
      background: linear-gradient(135deg, rgba(34,197,94,.92), rgba(34,197,94,.55));
      border-color: rgba(34,197,94,.45);
    }
    .btn.ghost{background: transparent}

    /* Screen 2: Map + service cards (top map, bottom cards) */
    .app{
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .topbar{
      position:absolute;
      top:10px; left:10px; right:10px;
      z-index:500;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(15,23,38,.78);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 26px rgba(0,0,0,.30);
    }
    .brand{display:flex; gap:10px; align-items:center; min-width:180px;}
    .logo{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(34,197,94,.55));
      border:1px solid rgba(255,255,255,.18);
      font-weight:900;
    }
    .brand b{font-size:14px}
    .brand span{display:block; font-size:12px; color:var(--muted); margin-top:1px}
    .status{
      display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(17,26,42,.65);
      border-radius: 999px;
      padding:7px 10px;
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text)}
    .miniBtn{
      padding:9px 10px;
      border-radius: 12px;
      font-weight:800;
      font-size:12px;
    }

    #map{
      flex: 1;
      height:100%;
      width:100%;
    }

    .addressBar{
      position:absolute;
      top:62px; left:10px; right:10px;
      z-index:450;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(15,23,38,.70);
      backdrop-filter: blur(10px);
    }
    .addrText{min-width:0}
    .addrText b{display:block; font-size:12px}
    .addrText span{
      display:block;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 70vw;
    }

    .bottom{
      position:absolute;
      left:0; right:0; bottom:0;
      z-index:600;
      padding:10px;
      pointer-events:none;
    }
    .panel{
      pointer-events:auto;
      width:min(980px, calc(100% - 0px));
      margin:0 auto;
      border:1px solid var(--line);
      background: rgba(15,23,38,.82);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .panelHead b{font-size:13px}
    .panelHead span{font-size:12px; color:var(--muted)}
    .panelBody{padding:12px}
    .services{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .card{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(17,26,42,.60);
      border-radius: 14px;
      padding:12px;
      cursor:pointer;
      transition: background .15s ease, border-color .15s ease, transform .08s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card:hover{background: rgba(17,26,42,.88); border-color: rgba(255,255,255,.18)}
    .card:active{transform: translateY(1px)}
    .card .left{display:flex; gap:10px; align-items:center}
    .ico{
      width:36px; height:36px;
      border-radius: 12px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(96,165,250,.12);
      font-weight:900;
    }
    .card b{font-size:13px}
    .card small{display:block; color:var(--muted); font-size:11px; margin-top:2px}
    .tag{font-size:11px; color:var(--muted); border:1px solid rgba(255,255,255,.12); padding:5px 8px; border-radius:999px}
    .card.selected{border-color: rgba(96,165,250,.48); background: rgba(96,165,250,.10)}
    .card.disabled{opacity:.45; cursor:not-allowed}

    /* Form section (appears after service selected) */
    .formGrid{display:grid; gap:10px; grid-template-columns: 1fr 1fr}
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.55);
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color: rgba(96,165,250,.55)}
    .hint{font-size:11px; color:var(--muted)}
    .rowActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .summary{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .sumBox{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(11,18,32,.40);
      border-radius: 12px;
      padding:10px 12px;
      font-size:12px;
      display:flex; justify-content:space-between; gap:10px;
    }
    .sumBox span{color:var(--muted)}
    .divider{height:1px; background: rgba(255,255,255,.10); margin:12px 0}

    /* Suggestions dropdown */
    .suggestWrap{position:relative}
    .suggest{
      position:absolute; left:0; right:0; top:100%;
      background: rgba(15,23,38,.95);
      border:1px solid rgba(255,255,255,.14);
      border-radius: 12px;
      margin-top:6px;
      overflow:hidden;
      z-index: 9999;
      box-shadow: 0 18px 34px rgba(0,0,0,.35);
      max-height: 220px;
      display:none;
    }
    .suggest.show{display:block}
    .suggest button{
      width:100%;
      text-align:left;
      padding:10px 12px;
      border:0;
      background: transparent;
      color: var(--text);
      cursor:pointer;
      font-size:12px;
    }
    .suggest button:hover{background: rgba(96,165,250,.12)}
    .suggest .sub{display:block; color:var(--muted); font-size:11px; margin-top:2px}

    /* Modal: Register/OTP */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 2000;
      padding:16px;
    }
    .modalBack.show{display:flex; align-items:center; justify-content:center}
    .modal{
      width:min(520px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(15,23,38,.92);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modalHead b{font-size:13px}
    .modalBody{padding:14px}
    .checks{display:flex; flex-direction:column; gap:8px; margin-top:6px}
    .check{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(11,18,32,.35);
      border-radius: 12px;
      padding:10px 12px;
    }
    .check input{margin-top:2px}
    .check span{font-size:12px; color:var(--muted); line-height:1.4}
    .toast{
      position:fixed; left:50%; bottom:14px;
      transform: translateX(-50%);
      background: rgba(15,23,38,.92);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 3000;
      font-size:12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      max-width: min(720px, calc(100vw - 28px));
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}

    /* Screen 4: Tracking (simple) */
    .trackingOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 2500;
    }
    .trackingOverlay.show{display:block}
    .trackPanel{
      position:absolute; left:10px; right:10px; top:10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(15,23,38,.88);
      border-radius: 14px;
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .trackPanel b{font-size:13px}
    .trackPanel span{font-size:12px; color:var(--muted)}
    .trackActions{display:flex; gap:8px; flex-wrap:wrap}

    @media (max-width: 760px){
      .services{grid-template-columns: 1fr}
      .formGrid{grid-template-columns: 1fr}
      .summary{grid-template-columns: 1fr}
      .addrText span{max-width: 62vw}
    }
  </style>
</head>

<body>

  <!-- SCREEN 1 -->
  <section class="screen landing active" id="screen1">
    <div class="banner">
      <h1>SepetTaxi</h1>
      <p>Taksi, Kurye ve Havalimanƒ± Transferi. Devam etmek i√ßin ‚ÄúDevam Et‚Äù butonuna bas.</p>
      <button class="btn primary" id="btnGo">Devam Et</button>
    </div>
  </section>

  <!-- SCREEN 2/3 (same page: map + service + flow) -->
  <section class="screen app" id="screen2">
    <div id="map"></div>

    <div class="topbar">
      <div class="brand">
        <div class="logo">ST</div>
        <div>
          <b>SepetTaxi</b>
          <span id="who">Durum: Misafir</span>
        </div>
      </div>
      <div class="status">
        <div class="pill"><b>Hizmet:</b> <span id="svcPill">Se√ßilmedi</span></div>
        <button class="btn miniBtn ghost" id="btnReset">Sƒ±fƒ±rla</button>
      </div>
    </div>

    <div class="addressBar">
      <div class="addrText">
        <b>Mevcut Konum</b>
        <span id="curAddr">Konum alƒ±nƒ±yor‚Ä¶</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn miniBtn" id="btnLocate">Konum Al</button>
      </div>
    </div>

    <div class="bottom">
      <div class="panel" id="panel">
        <div class="panelHead">
          <div>
            <b id="panelTitle">Hizmet Se√ßimi</b>
            <span id="panelSub">Taksi / Kurye / Transfer kartlarƒ±ndan birine tƒ±kla.</span>
          </div>
          <span class="pill" id="authPill"><b>Doƒürulama:</b> <span id="authState">Gerekli</span></span>
        </div>

        <div class="panelBody">
          <!-- Service cards -->
          <div class="services" id="serviceCards">
            <div class="card" data-svc="taxi">
              <div class="left">
                <div class="ico">üöï</div>
                <div>
                  <b>Taksi</b>
                  <small>Nereden/Nereye ‚Üí √úcret ‚Üí √áaƒüƒ±r</small>
                </div>
              </div>
              <span class="tag">Hƒ±zlƒ±</span>
            </div>

            <div class="card" data-svc="courier">
              <div class="left">
                <div class="ico">üõµ</div>
                <div>
                  <b>Kurye</b>
                  <small>Kilitli akƒ±≈ü: paket + alƒ±cƒ± + teslim</small>
                </div>
              </div>
              <span class="tag">Paket</span>
            </div>

            <div class="card" data-svc="transfer">
              <div class="left">
                <div class="ico">‚úàÔ∏è</div>
                <div>
                  <b>Transfer</b>
                  <small>Kilitli akƒ±≈ü: ara√ß + valiz + zaman</small>
                </div>
              </div>
              <span class="tag">Rezervasyon</span>
            </div>
          </div>

          <!-- Flow area (after service selected) -->
          <div id="flowArea" style="display:none;">
            <div class="divider"></div>

            <div class="formGrid">
              <div class="field">
                <label>üìç Nereden</label>
                <input id="pickupText" type="text" placeholder="Mevcut konumdan otomatik dolar" />
                <div class="hint">Konum alƒ±nƒ±nca ‚ÄúNereden‚Äù otomatik a√ßƒ±k adres olur.</div>
              </div>

              <div class="field suggestWrap">
                <label>üìç Nereye</label>
                <input id="dropText" type="text" placeholder="Haritadan se√ß veya yaz (otomatik doldurma)" autocomplete="off"/>
                <div class="suggest" id="dropSuggest"></div>
                <div class="hint">Haritaya tƒ±klayarak hedef se√ßebilirsin veya yazƒ±nca √∂neriler gelir.</div>
              </div>
            </div>

            <!-- Taxi: only these -->
            <div id="taxiExtra" style="display:none;"></div>

            <!-- Courier extra (minimal placeholders, your locked flow) -->
            <div id="courierExtra" style="display:none;">
              <div class="divider"></div>
              <div class="formGrid">
                <div class="field">
                  <label>Paket T√ºr√º</label>
                  <select id="pkgType">
                    <option value="">Se√ß</option>
                    <option>Belge</option>
                    <option>Koli</option>
                    <option>Gƒ±da</option>
                    <option>Diƒüer</option>
                  </select>
                </div>
                <div class="field">
                  <label>Aƒüƒ±rlƒ±k (kg)</label>
                  <input id="pkgWeight" type="number" min="0" step="0.1" placeholder="√ñrn: 2.5"/>
                </div>
                <div class="field">
                  <label>Alƒ±cƒ± Ad Soyad</label>
                  <input id="recvName" type="text" placeholder="√ñrn: Ahmet Yƒ±lmaz"/>
                </div>
                <div class="field">
                  <label>Alƒ±cƒ± Telefon</label>
                  <input id="recvPhone" type="tel" inputmode="numeric" maxlength="11" placeholder="05xxxxxxxxx"/>
                </div>
              </div>
              <div class="hint">Kurye akƒ±≈üƒ± kilitli: paket + alƒ±cƒ± + teslim. Buradaki alanlar temel iskelet.</div>
            </div>

            <!-- Transfer extra (minimal placeholders, your locked flow) -->
            <div id="transferExtra" style="display:none;">
              <div class="divider"></div>
              <div class="formGrid">
                <div class="field">
                  <label>Ara√ß Tipi</label>
                  <select id="trVehicle">
                    <option value="">Se√ß</option>
                    <option value="sedan">Binek</option>
                    <option value="vip">VIP</option>
                    <option value="van">Minib√ºs</option>
                  </select>
                </div>
                <div class="field">
                  <label>Valiz Sayƒ±sƒ±</label>
                  <input id="trLuggage" type="number" min="0" step="1" placeholder="√ñrn: 2"/>
                </div>
                <div class="field">
                  <label>Rezervasyon</label>
                  <select id="trMode">
                    <option value="now">Hemen</option>
                    <option value="later">ƒ∞leri Tarih</option>
                  </select>
                </div>
                <div class="field" id="trLater" style="display:none;">
                  <label>Tarih / Saat</label>
                  <input id="trDatetime" type="datetime-local"/>
                </div>
              </div>
              <div class="hint">Transfer akƒ±≈üƒ± kilitli: ara√ß + valiz + zaman + havalimanƒ± (isteƒüe g√∂re eklenir).</div>
            </div>

            <div class="summary">
              <div class="sumBox"><b>Mesafe</b> <span id="sumDist">‚Äî</span></div>
              <div class="sumBox"><b>√úcret</b> <span id="sumPrice">‚Äî</span></div>
              <div class="sumBox"><b>Durum</b> <span id="sumStatus">Hazƒ±r</span></div>
            </div>

            <div class="rowActions">
              <button class="btn" id="btnCalc">√úcret Hesapla</button>
              <button class="btn good" id="btnCall">√áaƒüƒ±r</button>
              <button class="btn ghost" id="btnBack">Hizmeti Deƒüi≈ütir</button>
            </div>

            <div class="hint" id="recentHint" style="margin-top:10px;"></div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- Register/OTP Modal (opens only when user clicks service and is new) -->
  <div class="modalBack" id="authModal">
    <div class="modal">
      <div class="modalHead">
        <b id="authTitle">Kayƒ±t</b>
        <button class="btn miniBtn ghost" id="authClose">Kapat</button>
      </div>
      <div class="modalBody">
        <div id="stepRegister">
          <div class="field">
            <label>Ad Soyad</label>
            <input id="name" type="text" placeholder="√ñrn: √ñzhan Samurcu"/>
          </div>
          <div class="field" style="margin-top:10px;">
            <label>Telefon (11 hane)</label>
            <input id="phone" type="tel" inputmode="numeric" maxlength="11" placeholder="05xxxxxxxxx"/>
            <div class="hint">Sadece rakam. √ñrn: 05320000000</div>
          </div>
          <div class="checks">
            <div class="check">
              <input id="kvkk" type="checkbox"/>
              <span><b>KVKK</b> metnini okudum ve kabul ediyorum.</span>
            </div>
            <div class="check">
              <input id="terms" type="checkbox"/>
              <span><b>Hizmet S√∂zle≈ümesi</b> ≈üartlarƒ±nƒ± okudum ve kabul ediyorum.</span>
            </div>
          </div>
          <div class="rowActions" style="margin-top:12px;">
            <button class="btn primary" id="sendOtp">Doƒürulama Kodu G√∂nder</button>
            <button class="btn" id="demoVerify">Demo: Doƒürula</button>
          </div>
          <div class="hint" style="margin-top:8px;">
            Canlƒ±da: sendOtp / verifyOtp API ile ger√ßek SMS doƒürulama baƒülanƒ±r.
          </div>
        </div>

        <div id="stepOtp" style="display:none;">
          <div class="field">
            <label>SMS Kodu</label>
            <input id="otp" type="text" inputmode="numeric" maxlength="6" placeholder="6 haneli kod"/>
          </div>
          <div class="rowActions" style="margin-top:12px;">
            <button class="btn good" id="verifyOtp">Doƒürula</button>
            <button class="btn" id="backReg">Geri</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tracking (simple overlay - optional screen) -->
  <div class="trackingOverlay" id="trackOverlay">
    <div class="trackPanel">
      <div>
        <b>Taksi Konumu</b>
        <span id="trackInfo">JOB: ‚Äî</span>
      </div>
      <div class="trackActions">
        <button class="btn miniBtn" id="trackClose">Kapat</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * CONFIG (ONLY ONE LINE)
     ***********************/
    const API_URL = "https://script.google.com/macros/s/AKfycbxGK3XXKVX-65ZfRCtGhMdIoOgV6RAx7tSldcBW3ugRzB7_T3Bv2DLsCazrpLgYPwg0/exec"; // BURAYA Apps Script /exec URL (tek satƒ±r)

    /***********************
     * SIMPLE HELPERS
     ***********************/
    const $ = (id)=>document.getElementById(id);
    const toast = (msg)=>{
      const t=$("toast");
      t.textContent=msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 2200);
    };
    const digitsOnly = (s)=> (s||"").replace(/\D/g,"");
    const validPhone = (p)=> /^\d{11}$/.test(p||"");

    /***********************
     * STATE
     ***********************/
    const state = {
      authed: false,
      user: null,           // {name, phone}
      service: null,        // taxi | courier | transfer
      map: null,
      markerMe: null,
      markerTo: null,
      coordsMe: null,       // {lat,lng}
      coordsTo: null,       // {lat,lng}
      curAddr: "",
      distKm: null,
      price: null,
      pendingServiceClick: null
    };

    /***********************
     * STORAGE (recent destinations)
     ***********************/
    function loadSession(){
      try{
        const u = localStorage.getItem("st_user");
        const a = localStorage.getItem("st_authed");
        if(a==="1" && u){
          state.user = JSON.parse(u);
          state.authed = true;
        }
      }catch(_){}
      renderAuth();
    }
    function saveSession(){
      localStorage.setItem("st_authed","1");
      localStorage.setItem("st_user", JSON.stringify(state.user));
    }
    function resetAll(){
      localStorage.removeItem("st_authed");
      localStorage.removeItem("st_user");
      localStorage.removeItem("st_recent_to");
      location.reload();
    }
    function addRecentDestination(text){
      if(!text) return;
      const key="st_recent_to";
      let arr=[];
      try{ arr = JSON.parse(localStorage.getItem(key) || "[]"); }catch(_){}
      arr = arr.filter(x => x !== text);
      arr.unshift(text);
      arr = arr.slice(0,6);
      localStorage.setItem(key, JSON.stringify(arr));
      renderRecentHint();
    }
    function getRecentDestinations(){
      try{ return JSON.parse(localStorage.getItem("st_recent_to") || "[]"); }catch(_){ return []; }
    }
    function renderRecentHint(){
      const arr = getRecentDestinations();
      const el = $("recentHint");
      if(!state.service){ el.textContent=""; return; }
      if(arr.length===0){
        el.textContent = "ƒ∞pucu: Nereye kutusuna yazmaya ba≈ülayƒ±nca √∂neriler gelir. Haritaya tƒ±klayarak hedef de se√ßebilirsin.";
        return;
      }
      el.textContent = "Son gidilenler: " + arr.join(" ‚Ä¢ ");
    }

    /***********************
     * AUTH UI
     ***********************/
    function renderAuth(){
      $("who").textContent = state.authed ? `Durum: Doƒürulandƒ± (${state.user.name})` : "Durum: Misafir";
      $("authState").textContent = state.authed ? "Tamam" : "Gerekli";
      $("authPill").style.borderColor = state.authed ? "rgba(34,197,94,.40)" : "rgba(251,191,36,.40)";
      // Disable service cards if not authed? (Your rule: click opens register)
      // We keep clickable but gate in handler.
    }

    function openAuthModal(){
      $("authModal").classList.add("show");
      $("authTitle").textContent = "Kayƒ±t";
      $("stepRegister").style.display="block";
      $("stepOtp").style.display="none";
    }
    function closeAuthModal(){
      $("authModal").classList.remove("show");
      state.pendingServiceClick = null;
    }
    function toOtpStep(){
      $("authTitle").textContent = "Doƒürulama";
      $("stepRegister").style.display="none";
      $("stepOtp").style.display="block";
    }

    /***********************
     * MAP + GEO + REVERSE
     ***********************/
    async function reverseGeocode(lat,lng){
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      if(!res.ok) throw new Error("Adres alƒ±namadƒ±");
      const data = await res.json();
      return data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    }

    async function searchGeocode(q){
      // For autocomplete suggestions
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=6&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      if(!res.ok) throw new Error("Arama hatasƒ±");
      const data = await res.json();
      return (data||[]).map(x => ({
        display: x.display_name,
        lat: parseFloat(x.lat),
        lng: parseFloat(x.lon)
      }));
    }

    function initMap(){
      if(state.map) return;

      state.map = L.map("map", { zoomControl:true });
      state.map.setView([40.195, 29.06], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(state.map);

      // click to set destination (only after service selected)
      state.map.on("click", async (e)=>{
        if(!state.service) return;
        state.coordsTo = { lat: e.latlng.lat, lng: e.latlng.lng };
        if(!state.markerTo){
          state.markerTo = L.marker([state.coordsTo.lat, state.coordsTo.lng]).addTo(state.map);
        }else{
          state.markerTo.setLatLng([state.coordsTo.lat, state.coordsTo.lng]);
        }
        $("sumStatus").textContent = "Adres alƒ±nƒ±yor‚Ä¶";
        try{
          const addr = await reverseGeocode(state.coordsTo.lat, state.coordsTo.lng);
          $("dropText").value = addr;
          addRecentDestination(addr);
          hideSuggest();
          $("sumStatus").textContent = "Hazƒ±r";
          toast("Hedef se√ßildi.");
        }catch(_){
          $("sumStatus").textContent = "Hazƒ±r";
          toast("Hedef se√ßildi (adres alƒ±namadƒ±).");
        }
      });
    }

    function locate(){
      initMap();
      $("curAddr").textContent = "Konum alƒ±nƒ±yor‚Ä¶";
      $("sumStatus").textContent = "Konum alƒ±nƒ±yor‚Ä¶";

      if(!navigator.geolocation){
        $("curAddr").textContent = "Konum desteƒüi yok.";
        $("sumStatus").textContent = "Hazƒ±r";
        toast("Tarayƒ±cƒ± konum desteƒüi yok.");
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        state.coordsMe = {lat,lng};

        state.map.setView([lat,lng], 16);

        if(!state.markerMe){
          state.markerMe = L.marker([lat,lng]).addTo(state.map);
        }else{
          state.markerMe.setLatLng([lat,lng]);
        }

        try{
          const addr = await reverseGeocode(lat,lng);
          state.curAddr = addr;
          $("curAddr").textContent = addr;
          // Rule: "Nereden" automatically filled with open address
          $("pickupText").value = addr;
          $("sumStatus").textContent = "Hazƒ±r";
          toast("Konum alƒ±ndƒ±.");
        }catch(_){
          $("curAddr").textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          $("pickupText").value = $("curAddr").textContent;
          $("sumStatus").textContent = "Hazƒ±r";
          toast("Konum alƒ±ndƒ± (adres alƒ±namadƒ±).");
        }
      }, (err)=>{
        console.error(err);
        $("curAddr").textContent = "Konum izni verilmedi / alƒ±namadƒ±.";
        $("sumStatus").textContent = "Hazƒ±r";
        toast("Konum izni verilmedi veya alƒ±namadƒ±.");
      }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
    }

    /***********************
     * SERVICE FLOW
     ***********************/
    function setService(svc){
      state.service = svc;
      $("svcPill").textContent = svc ? svc.toUpperCase() : "Se√ßilmedi";

      // rule: when one selected, other services "close"
      [...document.querySelectorAll("#serviceCards .card")].forEach(el=>{
        const is = el.dataset.svc === svc;
        el.classList.toggle("selected", is);
        el.style.display = is ? "flex" : "none";
      });

      $("panelTitle").textContent = svc === "taxi" ? "Taksi" : (svc === "courier" ? "Kurye" : "Transfer");
      $("panelSub").textContent = "Nereden/Nereye se√ß ‚Üí √úcret ‚Üí √áaƒüƒ±r";

      $("flowArea").style.display = "block";

      // show extra per service
      $("courierExtra").style.display = (svc==="courier") ? "block" : "none";
      $("transferExtra").style.display = (svc==="transfer") ? "block" : "none";
      $("taxiExtra").style.display = (svc==="taxi") ? "block" : "none";

      // reset computed
      state.distKm = null;
      state.price = null;
      $("sumDist").textContent = "‚Äî";
      $("sumPrice").textContent = "‚Äî";
      $("sumStatus").textContent = "Hazƒ±r";
      renderRecentHint();

      // ensure we have location; if not, try locate
      if(!state.coordsMe) locate();
      else {
        // enforce rule again
        if(state.curAddr) $("pickupText").value = state.curAddr;
      }
    }

    function backToServices(){
      state.service = null;
      $("svcPill").textContent = "Se√ßilmedi";
      $("panelTitle").textContent = "Hizmet Se√ßimi";
      $("panelSub").textContent = "Taksi / Kurye / Transfer kartlarƒ±ndan birine tƒ±kla.";
      $("flowArea").style.display = "none";

      // show all services again
      [...document.querySelectorAll("#serviceCards .card")].forEach(el=>{
        el.classList.remove("selected");
        el.style.display = "flex";
      });

      // destination marker stays but is okay; you can keep or reset:
      // Reset destination:
      state.coordsTo = null;
      if(state.markerTo){
        state.map.removeLayer(state.markerTo);
        state.markerTo = null;
      }
      $("dropText").value = "";
      hideSuggest();
    }

    /***********************
     * AUTOCOMPLETE (Nereye)
     ***********************/
    let suggestTimer = null;

    function hideSuggest(){ $("dropSuggest").classList.remove("show"); $("dropSuggest").innerHTML=""; }
    function showSuggest(items){
      const box = $("dropSuggest");
      box.innerHTML = "";
      items.forEach(it=>{
        const b = document.createElement("button");
        b.type="button";
        b.innerHTML = `${escapeHtml(it.display)}<span class="sub">${it.lat.toFixed(5)}, ${it.lng.toFixed(5)}</span>`;
        b.addEventListener("click", async ()=>{
          $("dropText").value = it.display;
          state.coordsTo = { lat: it.lat, lng: it.lng };
          addRecentDestination(it.display);

          if(!state.markerTo){
            state.markerTo = L.marker([it.lat,it.lng]).addTo(state.map);
          }else{
            state.markerTo.setLatLng([it.lat,it.lng]);
          }
          state.map.setView([it.lat,it.lng], 15);
          hideSuggest();
          toast("Hedef se√ßildi.");
        });
        box.appendChild(b);
      });
      if(items.length>0) box.classList.add("show");
      else hideSuggest();
    }

    function escapeHtml(s){
      return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    async function handleDropInput(){
      if(!state.service) return;
      const q = $("dropText").value.trim();

      // show recents quickly if short
      if(q.length < 3){
        const rec = getRecentDestinations().filter(x => x.toLowerCase().includes(q.toLowerCase())).slice(0,6);
        if(rec.length){
          showSuggest(rec.map(x => ({display:x, lat:(state.coordsTo?.lat||0), lng:(state.coordsTo?.lng||0)})));
          // NOTE: recents don't have coords here; user can still click map or type for real coords.
          // Better: we keep only for quick fill; coords-to must be set by map click or search results.
          // We‚Äôll treat ‚Äúrecent click‚Äù as text-only and require coords for pricing.
        } else hideSuggest();
        return;
      }

      clearTimeout(suggestTimer);
      suggestTimer = setTimeout(async ()=>{
        try{
          const results = await searchGeocode(q);
          showSuggest(results);
        }catch(e){
          console.error(e);
          hideSuggest();
        }
      }, 250);
    }

    /***********************
     * DISTANCE + PRICE
     ***********************/
    function haversineKm(lat1, lon1, lat2, lon2){
      const toRad = (x)=> x * Math.PI/180;
      const R = 6371;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a =
        Math.sin(dLat/2)*Math.sin(dLat/2) +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    // NOTE: FAZ 5 kilitli ‚Äî burada sadece "baƒülama noktasƒ±" var.
    function computePrice(service, km){
      // Senin FAZ 5‚Äôte kilitlediƒüin fiyat fonksiyonunu buraya baƒülayacaƒüƒ±z.
      // ≈ûimdilik minimal placeholder:
      const base = service==="taxi" ? 45 : (service==="courier" ? 55 : 140);
      const perKm = service==="taxi" ? 18 : (service==="courier" ? 20 : 24);
      return Math.round((base + perKm*km) * 10) / 10;
    }

    function calc(){
      if(!state.service) return toast("√ñnce hizmet se√ß.");
      if(!state.coordsMe) return toast("Konum alƒ±nmadƒ±.");
      if(!state.coordsTo) return toast("Nereye se√ß: haritaya tƒ±kla veya √∂nerilerden se√ß.");

      const km = haversineKm(state.coordsMe.lat, state.coordsMe.lng, state.coordsTo.lat, state.coordsTo.lng);
      state.distKm = km;
      state.price = computePrice(state.service, km);

      $("sumDist").textContent = `${km.toFixed(2)} km`;
      $("sumPrice").textContent = `${state.price.toFixed(1)} TL`;
      $("sumStatus").textContent = "Hazƒ±r";
      toast("√úcret hesaplandƒ±.");
    }

    /***********************
     * API (createJob + optional tracking)
     ***********************/
    async function apiPost(action, payload){
      if(!API_URL) throw new Error("API_URL bo≈ü. /exec URL‚Äônizi yapƒ±≈ütƒ±rƒ±n.");
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ action, ...payload })
      });
      const data = await res.json().catch(()=> ({}));
      return data;
    }

    async function callService(){
      if(!state.authed) return toast("√ñnce kayƒ±t/doƒürulama.");
      if(!state.service) return toast("√ñnce hizmet se√ß.");
      if(!state.coordsMe || !state.curAddr) return toast("Konum al.");
      if(!state.coordsTo) return toast("Nereye se√ß.");

      if(state.distKm==null || state.price==null){
        toast("√ñnce √ºcret hesapla.");
        return;
      }

      // Minimal validations per locked flows
      if(state.service==="courier"){
        const rp = digitsOnly($("recvPhone").value);
        if(!$("recvName").value.trim()) return toast("Kurye: Alƒ±cƒ± adƒ± zorunlu.");
        if(!validPhone(rp)) return toast("Kurye: Alƒ±cƒ± telefonu 11 hane.");
      }
      if(state.service==="transfer"){
        if(!$("trVehicle").value) return toast("Transfer: Ara√ß tipi se√ß.");
        if($("trMode").value==="later" && !$("trDatetime").value) return toast("Transfer: Tarih/saat zorunlu.");
      }

      $("sumStatus").textContent = "G√∂nderiliyor‚Ä¶";

      const payload = {
        user: state.user,
        service_type: state.service,
        pickup: {
          address: $("pickupText").value.trim(),
          lat: state.coordsMe.lat,
          lng: state.coordsMe.lng
        },
        dropoff: {
          address: $("dropText").value.trim(),
          lat: state.coordsTo.lat,
          lng: state.coordsTo.lng
        },
        pricing: {
          distance_km: state.distKm,
          estimated_price: state.price
        },
        details: {
          courier: state.service==="courier" ? {
            pkg_type: $("pkgType").value,
            pkg_weight: $("pkgWeight").value,
            receiver_name: $("recvName").value.trim(),
            receiver_phone: digitsOnly($("recvPhone").value)
          } : null,
          transfer: state.service==="transfer" ? {
            vehicle: $("trVehicle").value,
            luggage: $("trLuggage").value,
            schedule_mode: $("trMode").value,
            schedule_time: $("trDatetime").value || null
          } : null
        }
      };

      try{
        // If API not wired yet, still allow demo
        if(!API_URL){
          const demoJob = "JOB-" + Date.now();
          $("sumStatus").textContent = "Olu≈üturuldu (demo)";
          toast("√áaƒürƒ± olu≈üturuldu (demo).");
          openTracking(demoJob);
          return;
        }

        // Expected backend shape: { ok:true, job_id:"JOB-..." } or { error:"..." }
        const data = await apiPost("createJob", payload);

        if(data && data.ok){
          $("sumStatus").textContent = "Olu≈üturuldu";
          const jobId = data.job_id || ("JOB-" + Date.now());
          toast("√áaƒürƒ± olu≈üturuldu.");
          openTracking(jobId); // Screen 4 (optional)
          // Eƒüer senin FAZ 3‚Äôte track.html ayrƒ± sayfa ise:
          // window.location.href = `track.html?job_id=${encodeURIComponent(jobId)}`;
        }else{
          $("sumStatus").textContent = "Hata";
          toast(data?.error || "√áaƒürƒ± olu≈üturulamadƒ±.");
        }
      }catch(e){
        console.error(e);
        $("sumStatus").textContent = "Hata";
        toast(e.message || "API hatasƒ±");
      }
    }

    /***********************
     * TRACKING (optional screen)
     * - Here it's a simple overlay. If your FAZ 3 uses separate track.html, redirect above.
     ***********************/
    function openTracking(jobId){
      $("trackInfo").textContent = `JOB: ${jobId} ‚Ä¢ Taksi konumu izleniyor (FAZ 3 baƒülanacak)`;
      $("trackOverlay").classList.add("show");
      // Burada FAZ 3‚Äôte kilitli olan "driver marker update" mekanizmasƒ±nƒ± baƒülayacaƒüƒ±z.
    }
    function closeTracking(){
      $("trackOverlay").classList.remove("show");
    }

    /***********************
     * EVENTS
     ***********************/
    function goToScreen2(){
      $("screen1").classList.remove("active");
      $("screen2").classList.add("active");
      initMap();
      locate();
    }

    function onServiceClick(svc){
      // Rule: when user clicks a service, if new user => register opens, and service becomes active only after verification
      if(!state.authed){
        state.pendingServiceClick = svc;
        openAuthModal();
        return;
      }
      setService(svc);
    }

    function verifyDemo(){
      const name = $("name").value.trim();
      const phone = digitsOnly($("phone").value);
      if(!name) return toast("Ad Soyad zorunlu.");
      if(!validPhone(phone)) return toast("Telefon 11 hane olmalƒ±.");
      if(!$("kvkk").checked) return toast("KVKK onayƒ± zorunlu.");
      if(!$("terms").checked) return toast("S√∂zle≈üme onayƒ± zorunlu.");

      state.user = { name, phone };
      state.authed = true;
      saveSession();
      renderAuth();
      toast("Doƒürulandƒ± (demo).");
      $("authModal").classList.remove("show");

      // After verification: service selection becomes active automatically for the clicked one
      if(state.pendingServiceClick){
        const svc = state.pendingServiceClick;
        state.pendingServiceClick = null;
        setService(svc);
      }
    }

    async function sendOtp(){
      // iskelet: canlƒ±da sendOtp endpointine baƒülanƒ±r
      const name = $("name").value.trim();
      const phone = digitsOnly($("phone").value);
      if(!name) return toast("Ad Soyad zorunlu.");
      if(!validPhone(phone)) return toast("Telefon 11 hane olmalƒ±.");
      if(!$("kvkk").checked) return toast("KVKK onayƒ± zorunlu.");
      if(!$("terms").checked) return toast("S√∂zle≈üme onayƒ± zorunlu.");

      if(!API_URL){
        toast("API_URL bo≈ü (demo). OTP adƒ±mƒ±na ge√ßildi.");
        toOtpStep();
        return;
      }

      try{
        const data = await apiPost("sendOtp", { phone, name });
        if(data && data.ok){
          toast("Kod g√∂nderildi.");
          toOtpStep();
        }else{
          toast(data?.error || "Kod g√∂nderilemedi.");
        }
      }catch(e){
        console.error(e);
        toast(e.message || "OTP hatasƒ±");
      }
    }

    async function verifyOtp(){
      const name = $("name").value.trim();
      const phone = digitsOnly($("phone").value);
      const otp = digitsOnly($("otp").value).slice(0,6);

      if(!validPhone(phone)) return toast("Telefon hatalƒ±.");
      if(otp.length !== 6) return toast("Kod 6 hane olmalƒ±.");

      if(!API_URL){
        // demo fallback
        return verifyDemo();
      }

      try{
        const data = await apiPost("verifyOtp", { phone, otp, name });
        if(data && data.ok){
          state.user = { name, phone };
          state.authed = true;
          saveSession();
          renderAuth();
          toast("Doƒürulandƒ±.");
          closeAuthModal();
          if(state.pendingServiceClick){
            const svc = state.pendingServiceClick;
            state.pendingServiceClick = null;
            setService(svc);
          }
        }else{
          toast(data?.error || "Kod doƒürulanamadƒ±.");
        }
      }catch(e){
        console.error(e);
        toast(e.message || "OTP hatasƒ±");
      }
    }

    function wire(){
      $("btnGo").addEventListener("click", goToScreen2);
      $("btnLocate").addEventListener("click", locate);
      $("btnReset").addEventListener("click", resetAll);

      // service cards
      $("serviceCards").addEventListener("click", (e)=>{
        const card = e.target.closest(".card");
        if(!card) return;
        onServiceClick(card.dataset.svc);
      });

      // flow buttons
      $("btnBack").addEventListener("click", backToServices);
      $("btnCalc").addEventListener("click", calc);
      $("btnCall").addEventListener("click", callService);

      // drop input
      $("dropText").addEventListener("input", handleDropInput);
      $("dropText").addEventListener("focus", handleDropInput);
      document.addEventListener("click", (e)=>{
        if(!e.target.closest(".suggestWrap")) hideSuggest();
      });

      // transfer mode
      $("trMode").addEventListener("change", ()=>{
        $("trLater").style.display = ($("trMode").value==="later") ? "block" : "none";
      });

      // auth modal
      $("authClose").addEventListener("click", closeAuthModal);
      $("demoVerify").addEventListener("click", verifyDemo);
      $("sendOtp").addEventListener("click", sendOtp);
      $("verifyOtp").addEventListener("click", verifyOtp);
      $("backReg").addEventListener("click", ()=>{
        $("authTitle").textContent = "Kayƒ±t";
        $("stepRegister").style.display="block";
        $("stepOtp").style.display="none";
      });

      // input filters
      $("phone").addEventListener("input", (e)=> e.target.value = digitsOnly(e.target.value).slice(0,11));
      $("recvPhone").addEventListener("input", (e)=> e.target.value = digitsOnly(e.target.value).slice(0,11));
      $("otp").addEventListener("input", (e)=> e.target.value = digitsOnly(e.target.value).slice(0,6));

      // tracking overlay
      $("trackClose").addEventListener("click", closeTracking);
    }

    /***********************
     * INIT
     ***********************/
    window.addEventListener("DOMContentLoaded", ()=>{
      wire();
      loadSession();
      renderRecentHint();
      // Screen1 starts. Screen2 opens on "Devam Et".
    });
  </script>
</body>
</html>
