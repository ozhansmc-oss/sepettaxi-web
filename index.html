<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SepetTaxi ‚Äì Talep Olu≈ütur</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{--black:#000;--yellow:#FFD400}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,Arial,sans-serif;background:#fff;color:#000}
    header{padding:14px 16px;font-size:20px;font-weight:800;border-bottom:1px solid #eee}
    header span{color:var(--yellow)}
    #map{height:42vh;width:100%}

    .content{padding:16px;background:#fff;border-top-left-radius:22px;border-top-right-radius:22px;margin-top:-20px;position:relative;z-index:2}
    .card{background:#fff;border:1px solid #eee;border-radius:18px;padding:14px;margin-bottom:12px}
    .services{display:flex;gap:10px}
    .service{flex:1;padding:14px;border-radius:14px;text-align:center;border:1px solid #ddd;cursor:pointer;font-weight:800;user-select:none}
    .service.active{background:#000;color:#fff;border-color:#000}

    .row{display:flex;justify-content:space-between;gap:10px;margin-top:8px;font-size:15px}
    .row div:last-child{text-align:right;max-width:65%;word-break:break-word}
    .price{font-size:26px;font-weight:900}

    button{width:100%;padding:16px;border:none;border-radius:18px;font-size:17px;font-weight:900;cursor:pointer;background:var(--yellow);color:#000}
    button:disabled{background:#ccc;cursor:not-allowed}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.60);display:none;align-items:center;justify-content:center;z-index:999}
    .modal.active{display:flex}
    .modal-box{background:#fff;border-radius:20px;padding:20px;width:92%;max-width:440px}
    .modal-box h3{margin:0 0 12px 0}
    input{width:100%;padding:12px;margin-top:10px;border-radius:12px;border:1px solid #ccc;font-size:15px}
    label{display:block;margin-top:12px;font-size:14px}
    .muted{font-size:12px;color:#666;margin-top:8px}
    .modal-actions{margin-top:14px;display:flex;gap:10px}
    .btn-secondary{background:#eee}
  </style>
</head>

<body>
  <header>Sepet<span>Taxi</span></header>

  <div id="map"></div>

  <div class="content">
    <div class="card">
      <div class="services">
        <div class="service active" data-service="taxi">Taksi</div>
        <div class="service" data-service="motor">Motor Kurye</div>
        <div class="service" data-service="carCourier">Ara√ßlƒ± Kurye</div>
      </div>
    </div>

    <div class="card">
      <div class="row"><div>üìç Nereden</div><div id="fromText">Konum alƒ±nƒ±yor‚Ä¶</div></div>
      <div class="row"><div>üèÅ Nereye</div><div id="toText">Haritadan se√ß</div></div>
    </div>

    <div class="card">
      <div class="row"><div>üìè Mesafe</div><div id="distance">‚Äì</div></div>
      <div class="row"><div>üí∞ √úcret</div><div class="price" id="price">‚Äì</div></div>
    </div>

    <button id="continueBtn" disabled>Devam Et</button>
  </div>

  <!-- Kayƒ±t & Talep Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-box">
      <h3>Kayƒ±t & Talep</h3>

      <input id="name" placeholder="Ad Soyad" autocomplete="name" />
      <input id="phone" placeholder="Telefon (05XXXXXXXXX)" maxlength="11" inputmode="numeric" />

      <label><input type="checkbox" id="kvkk" /> KVKK Aydƒ±nlatma Metni</label>
      <label><input type="checkbox" id="contract" /> Hizmet S√∂zle≈ümesi</label>

      <div class="muted">
        Talebi g√∂nderebilmek i√ßin t√ºm alanlar ve onaylar zorunludur.
      </div>

      <div class="modal-actions">
        <button class="btn-secondary" id="cancelBtn" type="button">Vazge√ß</button>
        <button id="submitBtn" type="button">Talebi G√∂nder</button>
      </div>
    </div>
  </div>

<script>
/* ===================== CONFIG ===================== */
/* BURAYA KENDƒ∞ WEB APP URL‚Äôƒ∞Nƒ∞ YAPI≈ûTIR (tƒ±rnak i√ßinde) */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwugtsgIPPuFxkiqMS-xI8rC-zXzha6uHQThxSPz9joqGUhdq2PZdeQeBt9XtO2NY1UQA/exec";

/* ===================== DOM ===================== */
const el = {
  fromText: document.getElementById("fromText"),
  toText: document.getElementById("toText"),
  distance: document.getElementById("distance"),
  price: document.getElementById("price"),
  continueBtn: document.getElementById("continueBtn"),

  modal: document.getElementById("registerModal"),
  name: document.getElementById("name"),
  phone: document.getElementById("phone"),
  kvkk: document.getElementById("kvkk"),
  contract: document.getElementById("contract"),
  cancelBtn: document.getElementById("cancelBtn"),
  submitBtn: document.getElementById("submitBtn"),
};

/* ===================== STATE ===================== */
let selectedService = "taxi";
let pickup = null;
let dropoff = null;
let pickupMarker = null;
let dropoffMarker = null;

/* ===================== MAP ===================== */
const map = L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

map.locate({ setView:true, maxZoom:16 });

map.on("locationfound", async (e) => {
  pickup = e.latlng;

  if (pickupMarker) map.removeLayer(pickupMarker);
  pickupMarker = L.marker(pickup).addTo(map);

  el.fromText.textContent = await reverseGeocode(pickup.lat, pickup.lng);
});

map.on("locationerror", () => {
  el.fromText.textContent = "Konum izni gerekli";
});

map.on("click", async (e) => {
  if (!pickup) return;

  dropoff = e.latlng;

  if (dropoffMarker) map.removeLayer(dropoffMarker);
  dropoffMarker = L.marker(dropoff).addTo(map);

  el.toText.textContent = await reverseGeocode(dropoff.lat, dropoff.lng);
  calculate();
});

/* ===================== SERVICE SELECT ===================== */
document.querySelectorAll(".service").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".service").forEach(x => x.classList.remove("active"));
    btn.classList.add("active");
    selectedService = btn.dataset.service;
    if (dropoff) calculate();
  });
});

/* ===================== GEO + PRICE ===================== */
async function reverseGeocode(lat, lng) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
    const res = await fetch(url, { headers: { "Accept-Language": "tr" } });
    const data = await res.json();
    return data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  } catch {
    return `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  }
}

function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a =
    Math.sin(dLat/2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) ** 2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function calculatePrice(service, km) {
  const table = {
    taxi: { base: 40, perKm: 18 },
    motor: { base: 35, perKm: 12 },
    carCourier: { base: 50, perKm: 15 },
  };
  const p = table[service];
  return Math.round(p.base + (km * p.perKm));
}

function calculate() {
  if (!pickup || !dropoff) return;

  const rawKm = haversine(pickup.lat, pickup.lng, dropoff.lat, dropoff.lng);
  const km = Number(rawKm.toFixed(1));
  const price = calculatePrice(selectedService, km);

  el.distance.textContent = `${km} km`;
  el.price.textContent = `${price} ‚Ç∫`;
  el.continueBtn.disabled = false;
}

/* ===================== MODAL FLOW ===================== */
el.continueBtn.addEventListener("click", () => {
  el.modal.classList.add("active");
});

el.cancelBtn.addEventListener("click", () => {
  el.modal.classList.remove("active");
});

el.modal.addEventListener("click", (evt) => {
  if (evt.target === el.modal) el.modal.classList.remove("active");
});

/* ===================== SUBMIT JOB (FINAL) ===================== */
el.submitBtn.addEventListener("click", submitJob);

function onlyDigits11(val) {
  const digits = (val || "").replace(/\D/g, "");
  return digits.length === 11 ? digits : null;
}

async function submitJob() {
  // Guard: hesaplama yapƒ±lmadan talep yok
  if (!pickup || !dropoff) {
    alert("√ñnce haritadan Nereye se√ßip mesafe/√ºcret hesaplayƒ±n.");
    return;
  }
  if (el.continueBtn.disabled) {
    alert("√ñnce mesafe ve √ºcret hesaplanmalƒ±.");
    return;
  }

  const nameVal = (el.name.value || "").trim();
  const phoneVal = onlyDigits11(el.phone.value);

  if (nameVal.length < 3) {
    alert("Ad Soyad giriniz.");
    return;
  }
  if (!phoneVal) {
    alert("Telefon 11 haneli olmalƒ± (sadece rakam).");
    return;
  }
  if (!el.kvkk.checked || !el.contract.checked) {
    alert("KVKK ve s√∂zle≈üme onayƒ± zorunlu.");
    return;
  }

  // ‚úÖ job HER ZAMAN burada tanƒ±mlƒ± (scope garanti)
  const km = Number(String(el.distance.textContent).replace(" km", ""));
  const pr = Number(String(el.price.textContent).replace(" ‚Ç∫", ""));

  const job = {
    job_id: "JOB-" + Date.now(),
    created_at: new Date().toISOString(),
    service: selectedService,
    name: nameVal,
    phone: phoneVal,
    pickup_address: el.fromText.textContent,
    pickup_lat: pickup.lat,
    pickup_lng: pickup.lng,
    dropoff_address: el.toText.textContent,
    dropoff_lat: dropoff.lat,
    dropoff_lng: dropoff.lng,
    distance_km: km,
    price: pr,
    status: "pending"
  };

  // UI kilitle
  el.submitBtn.disabled = true;
  el.submitBtn.textContent = "G√∂nderiliyor‚Ä¶";

  try {
    if (!BACKEND_URL || BACKEND_URL.includes("PASTE_YOUR_APPS_SCRIPT_URL_HERE")) {
      alert("BACKEND_URL bo≈ü. Apps Script URL‚Äôini index.html i√ßine yapƒ±≈ütƒ±rƒ±n.");
      return;
    }

    const res = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(job)
    });

    // Apps Script bazen text d√∂ner; √∂nce text alƒ±p parse ediyoruz (en stabil y√∂ntem)
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch { json = { success:false, error:"Invalid JSON", raw:text }; }

    if (json && json.success) {
      alert("Talep ba≈üarƒ±yla alƒ±ndƒ±\nJob ID: " + (json.job_id || job.job_id));
      el.modal.classList.remove("active");
    } else {
      alert("Backend hata verdi: " + (json?.error ? json.error : JSON.stringify(json)));
    }
  } catch (e) {
    alert("Backend'e ula≈üƒ±lamadƒ±: " + e.toString());
  } finally {
    el.submitBtn.disabled = false;
    el.submitBtn.textContent = "Talebi G√∂nder";
  }
}
</script>

</body>
</html>
