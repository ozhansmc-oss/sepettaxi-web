<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:system-ui;overflow:hidden}
:root{
  --y:#f5c400;--line:rgba(255,255,255,.12);
  --card:#141416;--mut:rgba(255,255,255,.65)
}
.app{height:100%;display:flex;flex-direction:column}

/* TOPBAR */
.topbar{
  height:56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;border-bottom:1px solid var(--line);
  background:#050506;z-index:50
}
.brand{font-weight:900}
.iconbtn{
  width:40px;height:40px;border-radius:12px;
  border:1px solid var(--line);display:grid;place-items:center;
  cursor:pointer
}

/* MAP */
#map{height:50vh}

/* SHEET */
.sheet{height:50vh;border-top:1px solid var(--line);padding:12px;background:#0f0f10}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:16px;padding:12px;margin-bottom:10px
}
.seg{display:flex;gap:8px}
.seg button{
  flex:1;padding:10px;border-radius:12px;border:1px solid var(--line);
  background:#1a1a1a;color:#fff;font-weight:800
}
.seg button.active{background:rgba(245,196,0,.2);border-color:#f5c400}

.field{
  border:1px solid var(--line);border-radius:14px;
  padding:10px;margin-top:8px;cursor:pointer
}
.lbl{font-size:11px;color:var(--mut)}
.val{font-weight:800;font-size:13px;margin-top:2px}

.metrics{display:none;gap:10px;margin-top:10px}
.metric{flex:1;border:1px solid var(--line);border-radius:14px;padding:10px}
.metric .v{font-weight:900;font-size:16px}

.btn{
  width:100%;margin-top:10px;padding:14px;border-radius:16px;
  border:0;background:#f5c400;color:#000;font-weight:900
}
.btn:disabled{opacity:.4}

/* DRAWER */
.scrim{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  z-index:98;display:none
}
.drawer{
  position:fixed;top:0;bottom:0;left:0;width:260px;
  background:#0f0f10;border-right:1px solid var(--line);
  z-index:99;transform:translateX(-100%);
  transition:.25s;padding:12px
}
.drawer.open{transform:translateX(0)}
.scrim.show{display:block}

/* MODAL */
.modalWrap{
  position:fixed;inset:0;background:rgba(0,0,0,.65);
  z-index:120;display:none;align-items:center;justify-content:center
}
.modal{
  background:#141416;border-radius:18px;
  border:1px solid var(--line);padding:14px;width:90%;max-width:420px
}
.modal input{width:100%;padding:12px;border-radius:12px;margin-top:8px}
.err{color:#ff4d4d;font-size:12px;display:none}

/* SEARCHING */
.searching{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  z-index:150;display:none;align-items:center;justify-content:center
  /* === CRITICAL MOBILE FIX (MODAL MAP ÜSTÜNDE) === */

/* Leaflet harita katmanlarını aşağı çek */
.leaflet-pane,
.leaflet-control,
.leaflet-top,
.leaflet-bottom {
  z-index: 10 !important;
}

/* Modal her şeyin üstünde olsun */
.modalWrap {
  position: fixed !important;
  inset: 0 !important;
  z-index: 9999 !important;
  display: none;
  align-items: center;
  justify-content: center;
}

/* Modal içerik ekrana sığsın */
.modal {
  max-height: 85vh;
  overflow-y: auto;
}
</style>
</head>

<body>
<div class="app">

<div class="topbar">
  <div class="brand">SepetTaxi</div>
  <div class="iconbtn" id="menuBtn">☰</div>
</div>

<div id="map"></div>

<div class="sheet">
  <div class="card">
    <div class="seg">
      <button id="btnTaxi" class="active">Taksi</button>
      <button id="btnCourier">Kurye</button>
    </div>

    <div class="field" id="fromField">
      <div class="lbl">Nereden</div>
      <div class="val" id="fromText">Konum alınıyor…</div>
    </div>

    <div class="field" id="toField">
      <div class="lbl">Nereye</div>
      <div class="val" id="toText">Haritadan seç</div>
    </div>

    <div class="metrics" id="metrics">
      <div class="metric"><div>Mesafe</div><div class="v" id="kmText"></div></div>
      <div class="metric"><div>Ücret</div><div class="v" id="priceText"></div></div>
    </div>

    <button class="btn" id="callBtn" disabled>Çağır</button>
  </div>
</div>
</div>

<!-- DRAWER -->
<div class="scrim" id="scrim"></div>
<div class="drawer" id="drawer">
  <div class="field" onclick="location.href='driver.html'">Sürücü Girişi</div>
</div>

<!-- REGISTER -->
<div class="modalWrap" id="regWrap">
<div class="modal">
  <b>Zorunlu Kayıt</b>
  <input id="first" placeholder="Ad">
  <input id="last" placeholder="Soyad">
  <input id="phone" placeholder="Telefon">
  <label style="font-size:12px"><input type="checkbox" id="terms"> Kabul ediyorum</label>
  <div class="err" id="regErr">Tüm alanlar zorunlu</div>
  <button class="btn" id="regOk">Kaydı Tamamla</button>
</div>
</div>

<!-- SEARCHING -->
<div class="searching" id="searching">
  <div style="background:#141416;padding:20px;border-radius:18px">
    Sürücü aranıyor…
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const API="https://script.google.com/macros/s/AKfycbxHqb_E0gCqHmxWuzmdHqLb_IR7pHUGixIRd3Hh3MnVqegTPJEdJ4zM5Gb0Tc96Qb8C/exec";

/* ===== STATE ===== */
let map,pickup=null,dropoff=null,selecting=null;
let service="taxi";

/* ===== MAP ===== */
map=L.map("map",{zoomControl:false}).setView([41,29],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

map.on("click",async e=>{
  if(!selecting) return;
  const {lat,lng}=e.latlng;
  let addr=`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`,{
      headers:{"User-Agent":"SepetTaxi"}
    });
    const j=await r.json();
    if(j.display_name) addr=j.display_name;
  }catch{}
  if(selecting==="from"){pickup={lat,lng,addr};fromText.textContent=addr}
  else{dropoff={lat,lng,addr};toText.textContent=addr}
  selecting=null;compute();
});

/* ===== GEO ===== */
navigator.geolocation?.getCurrentPosition(async p=>{
  const {latitude,longitude}=p.coords;
  map.setView([latitude,longitude],16);
  pickup={lat:latitude,lng:longitude,addr:"Mevcut konum"};
  fromText.textContent="Mevcut konum";
},()=>{fromText.textContent="Haritadan seç"});

/* ===== UI ===== */
fromField.onclick=()=>selecting="from";
toField.onclick=()=>selecting="to";

menuBtn.onclick=()=>{
  drawer.classList.add("open");
  scrim.classList.add("show");
};
scrim.onclick=()=>{
  drawer.classList.remove("open");
  scrim.classList.remove("show");
};

btnTaxi.onclick=()=>setService("taxi");
btnCourier.onclick=()=>setService("courier");

function setService(s){
  service=s;
  btnTaxi.classList.toggle("active",s==="taxi");
  btnCourier.classList.toggle("active",s==="courier");
  if(!localStorage.sepettaxi_user) regWrap.style.display="flex";
  document.body.style.overflow = "hidden"; 
}
  
regOk.onclick=()=>{
  if(!first.value||!last.value||!phone.value||!terms.checked){
    regErr.style.display="block";return;
  }
  localStorage.sepettaxi_user="1";
  regWrap.style.display="none";
  document.body.style.overflow = "hidden";
  compute();
};

function compute(){
  if(!pickup||!dropoff||!localStorage.sepettaxi_user){
    metrics.style.display="none";
    callBtn.disabled=true;return;
  }
  metrics.style.display="flex";
  kmText.textContent="— km";
  priceText.textContent="— ₺";
  callBtn.disabled=false;
}

callBtn.onclick=async()=>{
  searching.style.display="flex";
  const r=await fetch(API+"?action=createJob");
  const j=await r.json();
  location.href="track.html?job_id="+j.job_id;
};
</script>
</body>
</html>
