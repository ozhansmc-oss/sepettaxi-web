<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}

/* LANDING */
#landing{
  height:100vh;
  background:#000 url("assets/landing.png") center/cover no-repeat;
  display:flex;
  align-items:center;
  justify-content:center;
}
.overlay{
  background:rgba(0,0,0,.6);
  width:100%;height:100%;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}
h1{font-size:42px}
h1 span{color:#f5c400}
.primary-btn{
  background:#f5c400;
  color:#000;
  border:none;
  border-radius:28px;
  padding:16px 42px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
}

/* APP */
#app{display:none;background:#111;min-height:100vh}
.app-header{
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:bold;
}
.app-header span{color:#f5c400}

#map{
  height:38vh;
  margin:12px 16px;
  border-radius:16px;
}

.container{padding:16px}
.card{
  background:#1b1b1b;
  border-radius:14px;
  padding:16px;
  margin-bottom:12px;
}
.input{
  width:100%;
  background:#000;
  border:1px solid #333;
  color:#fff;
  padding:14px;
  border-radius:10px;
}
.row{display:flex;gap:12px}
.row .card{flex:1;text-align:center}
.big{font-size:22px;font-weight:bold}
.call-btn{
  width:100%;
  background:#f5c400;
  color:#000;
  border:none;
  border-radius:28px;
  padding:18px;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
}

/* SERVICE CARDS */
.service-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-bottom:12px;
}
.service-card{
  background:#1b1b1b;
  border-radius:14px;
  padding:18px;
  text-align:center;
  cursor:pointer;
  border:2px solid transparent;
}
.service-card.active{border-color:#f5c400}

/* REGISTER MODAL â€“ FIXED, NO SCROLL */
#registerModal{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#registerModal.active{display:flex}
.modal{
  background:#111;
  border-radius:16px;
  padding:20px;
  width:92%;
  max-width:420px;
  max-height:90vh;
  overflow-y:auto;
}
.error{
  color:#ff5c5c;
  font-size:13px;
  display:none;
}
</style>
</head>

<body>

<!-- LANDING -->
<section id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button class="primary-btn" onclick="startApp()">BaÅŸla</button>
  </div>
</section>

<!-- APP -->
<section id="app">
  <div class="app-header">Sepet<span>Taxi</span></div>
  <div id="map"></div>

  <div class="container">

    <!-- SERVICE CARDS -->
    <div class="service-grid">
      <div class="service-card" id="taxiCard" onclick="selectService('taxi')">
        ðŸš• <b>Taksi</b>
      </div>
      <div class="service-card" id="courierCard" onclick="selectService('courier')">
        ðŸ“¦ <b>Kurye</b>
      </div>
    </div>

    <div class="card">
      <div>Nereden</div>
      <input id="fromInput" class="input" readonly>
    </div>

    <div class="card">
      <div>Nereye</div>
      <input id="toInput" class="input" readonly>
    </div>

    <!-- COURIER EXTRA -->
    <div id="courierFields" style="display:none">
      <div class="card">
        <div>Paket TÃ¼rÃ¼</div>
        <input id="packageType" class="input">
      </div>
      <div class="card">
        <div>AlÄ±cÄ± AdÄ±</div>
        <input id="receiverName" class="input">
      </div>
      <div class="card">
        <div>AlÄ±cÄ± Telefon</div>
        <input id="receiverPhone" class="input">
      </div>
    </div>

    <div class="row">
      <div class="card">
        <div>Mesafe</div>
        <div id="distance" class="big">â€”</div>
      </div>
      <div class="card">
        <div>Ãœcret</div>
        <div id="price" class="big">â€”</div>
      </div>
    </div>

    <button class="call-btn" onclick="createJob()">Ã‡aÄŸÄ±r</button>
  </div>
</section>

<!-- REGISTER MODAL -->
<div id="registerModal">
  <div class="modal">
    <div class="card">
      <div>Ad</div>
      <input id="firstName" class="input">
    </div>
    <div class="card">
      <div>Soyad</div>
      <input id="lastName" class="input">
    </div>
    <div class="card">
      <div>Telefon</div>
      <input id="phone" class="input" placeholder="05XXXXXXXXX">
    </div>
    <label>
      <input type="checkbox" id="kvkk"> KVKK ve sÃ¶zleÅŸmeyi kabul ediyorum
    </label>
    <div class="error" id="regErr">Bilgileri doÄŸru girin</div>
    <button class="call-btn" onclick="register()">KaydÄ± Tamamla</button>
  </div>
</div>

<script>
let map, fromMarker, toMarker;
let user=null;
let serviceType="";
  
  const BACKEND_URL = "https://script.google.com/macros/s/AKfycbz4seYfFW8fWiNne1T1BiE0-huu8iuYY8yAXY1a0b93LBaUwMSxu51Np5Toa4XlBjc-Fg/exec";

/* START */
function startApp(){
  landing.style.display="none";
  app.style.display="block";
  initMap();
}

/* MAP + LIVE LOCATION */
function initMap(){
  map=L.map("map").setView([41,29],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19}).addTo(map);

  navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude}=pos.coords;
    if(!fromMarker){
      fromMarker=L.marker([latitude,longitude],{draggable:true}).addTo(map);
      map.setView([latitude,longitude],15);
    } else {
      fromMarker.setLatLng([latitude,longitude]);
    }
    reverse(latitude,longitude,fromInput);
    calculate();
  });

  map.on("click",e=>{
    if(!toMarker) toMarker=L.marker(e.latlng,{draggable:true}).addTo(map);
    else toMarker.setLatLng(e.latlng);
    reverse(e.latlng.lat,e.latlng.lng,toInput);
    calculate();
  });
}

/* SERVICE */
function selectService(type){
  if(!user){
    openRegister();
    return;
  }
  serviceType=type;
  taxiCard.classList.toggle("active",type==="taxi");
  courierCard.classList.toggle("active",type==="courier");
  courierFields.style.display=type==="courier"?"block":"none";
  fromInput.removeAttribute("readonly");
  toInput.removeAttribute("readonly");
  calculate();
}

/* REGISTER MODAL */
function openRegister(){
  document.body.style.overflow="hidden";
  registerModal.classList.add("active");
}
function closeRegister(){
  document.body.style.overflow="";
  registerModal.classList.remove("active");
}

function register(){
  const f=firstName.value.trim();
  const l=lastName.value.trim();
  const p=phone.value.trim();
  if(f.length<2||l.length<2||!/^05\d{9}$/.test(p)||!kvkk.checked){
    regErr.style.display="block";return;
  }
  user={first_name:f,last_name:l,phone:p};
  regErr.style.display="none";
  closeRegister();
}

/* CALC */
function calculate(){
  if(!user||!serviceType||!fromMarker||!toMarker) return;
  const a=fromMarker.getLatLng(), b=toMarker.getLatLng();
  const km=haversine(a.lat,a.lng,b.lat,b.lng);
  distance.textContent=km.toFixed(2)+" km";
  const priceVal = serviceType==="courier"
    ? Math.max(80,40+km*15)
    : Math.max(120,60+km*22);
  price.textContent=Math.round(priceVal)+" TL";
}

function createJob(){
  if(!user || !serviceType || !fromMarker || !toMarker){
    alert("Eksik bilgi var");
    return;
  }

  const payload = {
    service_type: serviceType,
    first_name: user.first_name,
    last_name: user.last_name,
    phone: user.phone,
    from: fromInput.value,
    to: toInput.value,
    distance: distance.textContent,
    price: price.textContent,
    package_type: packageType?.value || "",
    receiver_name: receiverName?.value || "",
    receiver_phone: receiverPhone?.value || ""
  };

  fetch(BACKEND_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(res => {
    alert("Talep alÄ±ndÄ± âœ”\nJob ID: " + res.job_id);
  })
  .catch(err => {
    console.error(err);
    alert("Backend baÄŸlantÄ± hatasÄ±");
  });
}


/* HELPERS */
function haversine(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function reverse(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
    .then(r=>r.json())
    .then(d=>{if(d?.display_name)input.value=d.display_name});
}
</script>

</body>
</html>
