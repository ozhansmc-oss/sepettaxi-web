<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  font-family:Arial,Helvetica,sans-serif;
  background:#000;color:#fff;
}

/* HEADER */
header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:900;
  border-bottom:1px solid #222;
}
header span{color:#f5c400}

/* MAP */
#map{height:32vh}

/* PANEL */
#panel{
  height:calc(68vh - 56px);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* CARD */
.card{
  background:#121212;
  border:1px solid #222;
  border-radius:16px;
  padding:12px;
}

/* SERVICES */
.services{display:flex;gap:12px}
.service{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:1px solid #333;
  text-align:center;
  font-weight:900;
  cursor:pointer;
}
.service.active{
  border-color:#f5c400;
  box-shadow:0 0 0 1px rgba(245,196,0,.4) inset;
}

/* INPUT */
.input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #333;
  background:#000;
  color:#fff;
  font-size:15px;
}

/* STATS */
.stats{display:flex;gap:12px}
.stat{flex:1;text-align:center}
.big{font-size:18px;font-weight:900}

/* CALL */
#callBar{
  background:#f5c400;
  color:#000;
  padding:16px;
  border-radius:20px;
  text-align:center;
  font-weight:900;
  cursor:pointer;
  display:none;
}

/* DRIVER CARD */
#driverCard{
  background:#0d0d0d;
  border:1px solid #333;
  border-radius:18px;
  padding:16px;
  text-align:center;
}
#driverCard a{
  color:#f5c400;
  font-size:16px;
  font-weight:900;
  text-decoration:none;
}

/* REGISTER OVERLAY */
#register{
  position:fixed;inset:0;
  backdrop-filter: blur(6px);
  background:rgba(0,0,0,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}
#register .box{
  width:92%;
  max-width:420px;
  background:#111;
  border-radius:20px;
  padding:20px;
}
#register h3{
  margin:0 0 14px;
  text-align:center;
}
#register .cta{
  background:#f5c400;
  color:#000;
  padding:16px;
  border-radius:16px;
  text-align:center;
  font-weight:900;
  margin-top:14px;
  cursor:pointer;
}
.err{
  color:#ff9b9b;
  font-size:13px;
  display:none;
  margin-top:8px;
}

/* OVERLAY */
#overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:120;
}
#overlay .box{
  background:#111;
  padding:22px;
  border-radius:18px;
  text-align:center;
}
.spinner{
  width:36px;height:36px;
  border-radius:50%;
  border:4px solid #333;
  border-top-color:#f5c400;
  margin:12px auto;
  animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span></header>

<div id="map"></div>

<div id="panel">

  <div class="card services">
    <div id="svcTaxi" class="service" onclick="pickService('taxi')">ðŸš• Taksi</div>
    <div id="svcCourier" class="service" onclick="pickService('courier')">ðŸ“¦ Kurye</div>
  </div>

  <div class="card">
    <input id="fromAddr" class="input" readonly placeholder="Nereden (konum alÄ±nÄ±yor)">
  </div>

  <div class="card">
    <input id="toAddr" class="input" readonly placeholder="Nereye (haritaya dokun)">
  </div>

  <div class="card stats">
    <div class="stat">Mesafe<br><span id="dist" class="big">â€”</span></div>
    <div class="stat">Ãœcret<br><span id="price" class="big">â€”</span></div>
  </div>

  <div id="callBar" onclick="callDriver()">TAKSÄ° Ã‡AÄžIR</div>

  <div id="driverCard">
    ðŸš— SÃ¼rÃ¼cÃ¼ mÃ¼sÃ¼n?
    <a href="driver.html">Hemen BaÅŸvur</a>
  </div>

</div>

<!-- REGISTER -->
<div id="register">
  <div class="box">
    <h3>KayÄ±t Ol</h3>
    <input id="fn" class="input" placeholder="Ad">
    <br><br>
    <input id="ln" class="input" placeholder="Soyad">
    <br><br>
    <input id="ph" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <label style="font-size:13px">
      <input type="checkbox" id="kvkk"> KVKK kabul ediyorum
    </label>
    <div id="regErr" class="err">LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru doldur</div>
    <div class="cta" onclick="saveUser()">KAYDI TAMAMLA</div>
  </div>
</div>

<!-- SEARCHING -->
<div id="overlay">
  <div class="box">
    <b>SÃ¼rÃ¼cÃ¼ aranÄ±yorâ€¦</b>
    <div class="spinner"></div>
    <small>Takip ekranÄ±na yÃ¶nlendiriliyorsun</small>
  </div>
</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";
let map,fromM,toM,service=null,user=null,registered=false;

/* MAP */
map=L.map("map").setView([40.19,29.06],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
navigator.geolocation.getCurrentPosition(p=>{
  fromM=L.marker([p.coords.latitude,p.coords.longitude]).addTo(map);
  map.setView(fromM.getLatLng(),15);
  reverse(p.coords.latitude,p.coords.longitude,fromAddr);
});
map.on("click",e=>{
  toM?toM.setLatLng(e.latlng):toM=L.marker(e.latlng).addTo(map);
  reverse(e.latlng.lat,e.latlng.lng,toAddr);
  calc();
});

/* SERVICE */
function pickService(t){
  if(!registered){ register.style.display="flex"; return; }
  service=t;
  svcTaxi.classList.toggle("active",t==="taxi");
  svcCourier.classList.toggle("active",t==="courier");
  callBar.style.display="block";
  callBar.innerText=t==="taxi"?"TAKSÄ° Ã‡AÄžIR":"KURYE Ã‡AÄžIR";
  calc();
}

/* REGISTER */
function saveUser(){
  if(fn.value.length<2||ln.value.length<2||!/^05\d{9}$/.test(ph.value)||!kvkk.checked){
    regErr.style.display="block";return;
  }
  user={f:fn.value,l:ln.value,p:ph.value};
  registered=true;
  register.style.display="none";
}

/* CALC */
function calc(){
  if(!service||!fromM||!toM)return;
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=h(a.lat,a.lng,b.lat,b.lng);
  dist.textContent=km.toFixed(2)+" km";
  price.textContent=Math.max(120,60+km*22).toFixed(0)+" TL";
}

/* CALL */
async function callDriver(){
  overlay.style.display="flex";
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=h(a.lat,a.lng,b.lat,b.lng);
  const r=await fetch(BACKEND+"?"+new URLSearchParams({
    action:"createJob",
    service_type:service,
    customer_first:user.f,
    customer_last:user.l,
    customer_phone:user.p,
    from_address:fromAddr.value,
    to_address:toAddr.value,
    distance_km:km,
    price:120,
    final_price:120
  }));
  const j=await r.json();
  location.href="track.html?job_id="+j.job_id+"&token="+j.track_token;
}

/* UTIL */
function h(a,b,c,d){
  const R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function reverse(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
  .then(r=>r.json()).then(d=>input.value=d.display_name||"");
}
</script>

</body>
</html>
