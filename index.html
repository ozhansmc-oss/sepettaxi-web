<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
.screen{display:none;min-height:100vh;padding:20px;box-sizing:border-box}
.active{display:flex;flex-direction:column}
.center{justify-content:center;align-items:center;text-align:center}
h1{margin-bottom:10px}
button{width:100%;padding:16px;margin-top:14px;border-radius:14px;border:none;font-size:16px;background:#fff;color:#000;font-weight:bold;cursor:pointer}
input{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:none;font-size:15px}
.list-item{padding:18px;border-bottom:1px solid #333;font-size:18px;display:flex;justify-content:space-between;cursor:pointer}
.small{color:#aaa;font-size:14px}
label{margin-top:10px}
#map{height:50vh;border-radius:12px;margin-top:10px}
</style>
</head>

<body>

<script>
/* ===== CONFIG ===== */
const API_URL = "https://script.google.com/macros/s/AKfycbyXfyQG4ZYPmsLF94hbYt9nKSIdta6wW9pfEDX4blNFCAsgbyR72kGwzZ5yO_zRzme2/exec";

const PRICES = {
  taksi: { open: 30, km: 12 },
  kurye:{ open: 25, km: 10 }
};

/* ===== STATE ===== */
let service = null;
let map, fromLL=null, toLL=null, mFrom, mTo;
let distanceKm=0, price=0;
let user = { name:"", phone:"" };

/* ===== HELPERS ===== */
const $ = id => document.getElementById(id);
function go(n){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  $("s"+n).classList.add("active");
  if(n===3) setTimeout(initMap,300);
}
</script>

<!-- ========== 1) KAYIT ========== -->
<div id="s1" class="screen active center">
  <h1>SepetTaxi</h1>

  <input id="inp_name" placeholder="Ad Soyad">
  <input id="inp_phone" placeholder="Telefon (05xx)">

  <label><input type="checkbox" id="chk_kvkk"> KVKK kabul</label>
  <label><input type="checkbox" id="chk_contract"> Hizmet sÃ¶zleÅŸmesi</label>

  <button onclick="register()">Devam Et</button>
  <p class="small" id="msg"></p>
</div>

<!-- ========== 2) HÄ°ZMET ========== -->
<div id="s2" class="screen">
  <h2>Hizmet SeÃ§</h2>
  <div class="list-item" onclick="selectService('taksi')">ðŸš• Taksi <span>â€º</span></div>
  <div class="list-item" onclick="selectService('kurye')">ðŸ›µ Kurye <span>â€º</span></div>
</div>

<!-- ========== 3) ADRES / HARÄ°TA ========== -->
<div id="s3" class="screen">
  <h2>Adres SeÃ§</h2>
  <input id="from" placeholder="Nereden (otomatik)">
  <input id="to" placeholder="Nereye (haritadan seÃ§)">
  <div id="map"></div>
  <button onclick="calculate()">Ãœcreti Hesapla</button>
</div>

<!-- ========== 4) ONAY ========== -->
<div id="s4" class="screen center">
  <h2 id="priceText">0 TL</h2>
  <p class="small" id="infoText"></p>
  <button onclick="createJob()">Ã‡aÄŸÄ±r</button>
</div>

<script>
/* ===== REGISTER ===== */
function register(){
  const name = $("inp_name").value.trim();
  const phone = $("inp_phone").value.trim();
  const kvkk = $("chk_kvkk").checked;
  const contract = $("chk_contract").checked;

  if(!name || !phone){ alert("Ad ve telefon zorunlu"); return; }
  if(!kvkk || !contract){ alert("KVKK ve sÃ¶zleÅŸme kabul edilmeli"); return; }

  $("msg").innerText = "Kaydediliyor...";

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"registerUser",
      user_name:name,
      user_phone:phone
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.ok){
      user.name = name;
      user.phone = phone;
      go(2);
    }else{
      $("msg").innerText = res.error || "KayÄ±t hatasÄ±";
    }
  })
  .catch(()=> $("msg").innerText="BaÄŸlantÄ± hatasÄ±");
}

/* ===== SERVICE ===== */
function selectService(s){
  service = s;
  go(3);
}

/* ===== MAP ===== */
function initMap(){
  if(map) return;

  map = L.map("map").setView([40.195,29.060],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  navigator.geolocation.getCurrentPosition(async pos=>{
    fromLL=[pos.coords.latitude,pos.coords.longitude];
    mFrom=L.marker(fromLL).addTo(map).bindPopup("Konumun").openPopup();
    map.setView(fromLL,14);
    $("from").value = await reverse(fromLL);
  });

  map.on("click", async e=>{
    toLL=[e.latlng.lat,e.latlng.lng];
    if(mTo) map.removeLayer(mTo);
    mTo=L.marker(toLL).addTo(map).bindPopup("VarÄ±ÅŸ").openPopup();
    $("to").value = await reverse(toLL);
  });
}

async function reverse(ll){
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll[0]}&lon=${ll[1]}`);
  const d=await r.json();
  return d.display_name || ll.join(",");
}

/* ===== CALC ===== */
function hav(a,b){
  const R=6371;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLng=(b[1]-a[1])*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function calculate(){
  if(!fromLL || !toLL){ alert("BaÅŸlangÄ±Ã§ ve varÄ±ÅŸ seÃ§"); return; }
  distanceKm = hav(fromLL,toLL);
  price = Math.round(PRICES[service].open + distanceKm*PRICES[service].km);

  $("priceText").innerText = price + " TL";
  $("infoText").innerText = distanceKm.toFixed(2) + " km - " + service.toUpperCase();
  go(4);
}

/* ===== CREATE JOB ===== */
function createJob(){
  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      action:"createJob",
      service_type:service,
      user_name:user.name,
      user_phone:user.phone,
      pickup_address:$("from").value,
      pickup_lat:String(fromLL[0]),
      pickup_lng:String(fromLL[1]),
      dropoff_address:$("to").value,
      dropoff_lat:String(toLL[0]),
      dropoff_lng:String(toLL[1])
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.ok){
      alert("Ã‡aÄŸrÄ± oluÅŸturuldu");
      // window.location.href = "track.html?job_id=" + res.job_id;
    }else{
      alert(res.error || "Ä°ÅŸ oluÅŸturulamadÄ±");
    }
  })
  .catch(()=> alert("BaÄŸlantÄ± hatasÄ±"));
}
</script>

</body>
</html>
