<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--line:#222;--muted:#9a9a9a;--card1:#141414;--card2:#0f0f0f;--ok:#2ecc71;--bad:#e74c3c}

/* LANDING */
#landing{position:fixed;inset:0;background:#000 url("assets/landing.png") center/cover no-repeat;z-index:1000}
#landing .overlay{position:absolute;inset:0;background:rgba(0,0,0,.65);display:flex;flex-direction:column;align-items:center;justify-content:center}
#landing h1{font-size:40px;margin:0 0 18px 0}
#landing span{color:var(--y)}
#landing button{background:var(--y);color:#000;border:0;border-radius:28px;padding:14px 46px;font-size:17px;font-weight:900;cursor:pointer}

/* HEADER */
header{
  position:relative;
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:900;
  border-bottom:1px solid var(--line)
}
header span{color:var(--y)}

#driverCtas{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  display:flex;
  gap:8px;
  align-items:center;
}
.pill{
  background:#0f0f0f;
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  opacity:.82;
  display:flex;
  gap:6px;
  align-items:center;
  white-space:nowrap;
}
.pill a{color:#aaa;text-decoration:none}
.pill:hover{opacity:1}

/* APP LAYOUT */
#app{display:none;height:100%}
#map{height:45vh;border-bottom:1px solid var(--line)}
@media(min-width:900px){ #map{height:50vh} }

#panel{
  height:calc(55vh - 56px);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  overflow:hidden; /* default scroll yok */
}
@media(min-width:900px){ #panel{height:calc(50vh - 56px)} }

.card{background:linear-gradient(180deg,var(--card1),var(--card2));border-radius:14px;padding:10px;border:1px solid rgba(255,255,255,.04)}
.cardTitle{display:flex;justify-content:space-between;align-items:center;gap:10px}
.badge{font-size:11px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px;white-space:nowrap}
.badge.ok{color:#bff5c9;border-color:rgba(46,204,113,.4)}
.badge.bad{color:#ffd0d0;border-color:rgba(231,76,60,.35)}

.serviceRow{display:flex;gap:8px}
.serviceBtn{
  flex:1;padding:11px;border-radius:12px;border:1px solid var(--line);
  background:#0b0b0b;color:#bdbdbd;cursor:pointer;user-select:none;
  display:flex;align-items:center;justify-content:center;gap:8px
}
.serviceBtn.active{border-color:var(--y);color:#fff;background:rgba(245,196,0,.1)}

.input{width:100%;padding:11px;border-radius:12px;border:1px solid #1f1f1f;background:#000;color:#fff}
.input:focus{outline:1px solid rgba(245,196,0,.35)}
.helper{font-size:11px;color:var(--muted);line-height:1.25}

.row{display:flex;gap:8px;align-items:center}
.row .grow{flex:1}
.miniBtn{
  border:1px solid var(--line);
  background:#0f0f0f;color:#ddd;
  border-radius:10px;
  padding:10px 10px;
  font-size:12px;cursor:pointer;white-space:nowrap
}
.miniBtn:hover{opacity:.95}
.miniBtn.active{border-color:var(--y);background:rgba(245,196,0,.12);color:#fff}

.stats{display:flex;gap:8px}
.stat{flex:1;background:#0b0b0b;border-radius:14px;padding:10px;text-align:center;border:1px solid rgba(255,255,255,.04)}
.stat .lbl{font-size:11px;color:#aaa}
.stat .val{font-size:18px;font-weight:900}

#courierBox{display:none}
#taxiBox{display:block}

.chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.chip{
  border:1px solid var(--line);
  background:#0b0b0b;
  color:#ddd;
  padding:8px 10px;
  border-radius:999px;
  font-size:12px;
  cursor:pointer;
  user-select:none
}
.chip.active{border-color:var(--y);background:rgba(245,196,0,.12);color:#fff}

#stickyBar{position:fixed;left:0;right:0;bottom:0;padding:10px;background:#000;border-top:1px solid var(--line);z-index:500}
#ctaBtn{border-radius:30px;padding:16px;text-align:center;font-weight:900;user-select:none}
#ctaBtn.enabled{background:var(--y);color:#000;cursor:pointer}
#ctaBtn.disabled{background:#2a2a2a;color:#999}

#searching{
  position:fixed;inset:0;background:rgba(0,0,0,.95);
  display:none;align-items:center;justify-content:center;flex-direction:column;z-index:600;
  padding:16px;text-align:center
}
#searching .spin{margin-top:10px;opacity:.85;font-size:12px;color:#bbb}
#searching .small{margin-top:10px;font-size:12px;color:#bbb;opacity:.9;max-width:520px;line-height:1.35}
#searching .btns{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;justify-content:center}
#searching button{
  border:1px solid var(--line);background:#0f0f0f;color:#ddd;border-radius:999px;
  padding:10px 14px;font-size:12px;cursor:pointer
}
#searching button:hover{opacity:.95}

#toast{
  position:fixed;left:50%;top:12px;transform:translateX(-50%);
  background:#111;padding:10px 12px;border-radius:999px;font-size:12px;display:none;
  border:1px solid var(--line);z-index:1200;max-width:92vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}

/* REGISTER MODAL */
#regModal{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1100;
  background:rgba(0,0,0,.82);padding:16px
}
#regCard{
  width:min(520px, 96vw);
  background:linear-gradient(180deg,var(--card1),var(--card2));
  border:1px solid rgba(255,255,255,.06);
  border-radius:16px;
  padding:14px
}
#regCard h2{margin:0 0 8px 0;font-size:16px}
#regCard .sub{font-size:12px;color:#bbb;line-height:1.3;margin-bottom:10px}
.kvkk{
  display:flex;gap:10px;align-items:flex-start;margin-top:8px;
  padding:10px;border:1px solid rgba(255,255,255,.06);border-radius:12px;background:#0b0b0b
}
.kvkk input{margin-top:2px}
.kvkk .txt{font-size:11px;color:#bdbdbd;line-height:1.35}
#regActions{display:flex;gap:8px;margin-top:10px}
#regActions button{
  flex:1;border:1px solid var(--line);background:#0f0f0f;color:#ddd;border-radius:12px;
  padding:12px 10px;font-size:13px;font-weight:800;cursor:pointer
}
#regActions button.primary{background:var(--y);color:#000;border-color:transparent}
#regActions button:disabled{opacity:.45;cursor:not-allowed}
.smallHint{font-size:11px;color:#bbb;margin-top:6px}
</style>
</head>

<body>
<div id="toast"></div>

<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button id="startBtn" type="button">BA≈ûLA</button>
  </div>
</div>

<!-- Register Modal -->
<div id="regModal" aria-hidden="true">
  <div id="regCard">
    <h2>Zorunlu Kayƒ±t</h2>
    <div class="sub">SepetTaxi‚Äôyi kullanmak i√ßin temel bilgileri alƒ±yoruz. Kayƒ±t olmadan √ßaƒürƒ± olu≈üturulamaz.</div>

    <div class="row">
      <div class="grow">
        <input id="regFirst" class="input" placeholder="Ad">
      </div>
      <div class="grow">
        <input id="regLast" class="input" placeholder="Soyad">
      </div>
    </div>

    <div style="height:8px"></div>

    <input id="regPhone" class="input" inputmode="numeric" placeholder="Telefon (11 hane, √∂rn: 05XXXXXXXXX)" maxlength="11">

    <div class="kvkk">
      <input id="regKvkk" type="checkbox">
      <div class="txt">
        KVKK kapsamƒ±nda ki≈üisel verilerimin, hizmetin sunulmasƒ± ve operasyonel ileti≈üim amacƒ±yla i≈ülenmesini kabul ediyorum.
      </div>
    </div>

    <div class="smallHint" id="regErr" style="display:none;color:#ffd0d0"></div>

    <div id="regActions">
      <button id="regCancel" type="button">Vazge√ß</button>
      <button id="regSave" class="primary" type="button">Kaydƒ± Tamamla</button>
    </div>
  </div>
</div>

<div id="app">
  <header>
    <div id="driverCtas">
      <div class="pill">üöó <a href="driver.html">S√ºr√ºc√º m√ºs√ºn?</a></div>
      <div class="pill">üìù <a href="driver-register.html">S√ºr√ºc√º Ol</a></div>
    </div>
    Sepet<span>Taxi</span>
  </header>

  <div id="map"></div>

  <div id="panel">
    <div class="card">
      <div class="cardTitle">
        <b>Hizmet Se√ß</b>
        <div id="regBadge" class="badge bad">Kayƒ±t: Gerekli</div>
      </div>
      <div class="serviceRow">
        <div id="btnTaxi" class="serviceBtn active">üöï Taksi</div>
        <div id="btnCourier" class="serviceBtn">üì¶ Kurye</div>
      </div>
      <div id="helperText" class="helper">Varƒ±≈ü i√ßin haritaya dokun veya adres yaz.</div>
    </div>

    <!-- TAXI -->
    <div id="taxiBox">
      <div class="card">
        <div class="row">
          <input id="fromInput" class="input grow" placeholder="Nereden (konum veya adres)" autocomplete="off" list="fromList">
          <button id="pickFromBtn" class="miniBtn" type="button" title="Haritadan se√ß">Nereden Se√ß</button>
        </div>
        <datalist id="fromList"></datalist>
        <div class="helper">Konum otomatik alƒ±nƒ±r. ƒ∞stersen adres yazarak deƒüi≈ütirebilirsin.</div>
      </div>

      <div class="card">
        <div class="row">
          <input id="toInput" class="input grow" placeholder="Nereye (adres yaz veya haritadan se√ß)" autocomplete="off" list="toList">
          <button id="pickToBtn" class="miniBtn active" type="button" title="Haritadan se√ß">Nereye Se√ß</button>
        </div>
        <datalist id="toList"></datalist>
        <div class="helper">Haritaya dokunursan se√ßili alan (Nereye/Nereden) g√ºncellenir.</div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="lbl">Mesafe</div>
          <div id="distVal" class="val">‚Äî</div>
        </div>
        <div class="stat">
          <div class="lbl">√úcret</div>
          <div id="priceVal" class="val">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- COURIER -->
    <div id="courierBox">
      <div class="card">
        <div class="cardTitle">
          <b>Kurye Detaylarƒ±</b>
          <div class="badge" id="courierHint">Zorunlu alanlar</div>
        </div>

        <div class="row" style="margin-top:8px">
          <input id="cFromInput" class="input grow" placeholder="Alƒ±nacak adres (nereden)" autocomplete="off" list="cFromList">
          <button id="cPickFromBtn" class="miniBtn active" type="button">Nereden Se√ß</button>
        </div>
        <datalist id="cFromList"></datalist>

        <div style="height:8px"></div>

        <div class="row">
          <input id="cToInput" class="input grow" placeholder="Teslim adresi (nereye)" autocomplete="off" list="cToList">
          <button id="cPickToBtn" class="miniBtn" type="button">Nereye Se√ß</button>
        </div>
        <datalist id="cToList"></datalist>

        <div class="helper" style="margin-top:6px">Adres yazabilir veya haritadan se√ßebilirsin. Se√ßilen adres haritada i≈üaretlenir.</div>

        <div class="chips" id="pkgChips" aria-label="Paket tipi">
          <div class="chip active" data-pkg="Zarf">Zarf</div>
          <div class="chip" data-pkg="K√º√ß√ºk Paket">K√º√ß√ºk Paket</div>
          <div class="chip" data-pkg="Orta Paket">Orta Paket</div>
          <div class="chip" data-pkg="B√ºy√ºk Paket">B√ºy√ºk Paket</div>
        </div>

        <div style="height:8px"></div>

        <div class="row">
          <input id="recvName" class="input grow" placeholder="Alƒ±cƒ± Ad Soyad">
          <input id="recvPhone" class="input grow" inputmode="numeric" maxlength="11" placeholder="Alƒ±cƒ± Telefon (11 hane)">
        </div>

        <div style="height:8px"></div>

        <input id="cNote" class="input" placeholder="Not (opsiyonel)">

        <div class="stats" style="margin-top:10px">
          <div class="stat">
            <div class="lbl">Mesafe</div>
            <div id="cDistVal" class="val">‚Äî</div>
          </div>
          <div class="stat">
            <div class="lbl">√úcret</div>
            <div id="cPriceVal" class="val">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="stickyBar">
  <div id="ctaBtn" class="disabled">TAKSƒ∞ √áAƒûIR</div>
</div>

<div id="searching">
  <div><b id="searchTitle">S√ºr√ºc√º aranƒ±yor‚Ä¶</b></div>
  <div class="spin" id="searchSpin">Atama bekleniyor</div>
  <div class="small" id="searchInfo">Otomatik atama modunda ilk m√ºsait s√ºr√ºc√ºye y√∂nlendiriyoruz.</div>
  <div class="btns">
    <button id="cancelBtn" type="button">ƒ∞ptal</button>
    <button id="retryBtn" type="button" style="display:none">Tekrar Dene</button>
    <button id="goTrackBtn" type="button" style="display:none">Takibe Git</button>
  </div>
</div>

<!-- Global config -->
<script src="config.js"></script>

<script>
/* =========================
   CORE STATE
========================= */
let map, userMarker, destMarker, routeLine, cFromMarker, cToMarker, cRouteLine;
let userLatLng = null;
let destLatLng = null;
let service = "taxi"; // taxi | courier

let pickMode = "to";     // taxi map click target: "from" or "to"
let cPickMode = "from";  // courier map click target: "from" or "to"

let currentJobId = "";
let currentTrackToken = "";
let pollTimer = null;
let pollStartedAt = 0;

let customer = { first:"", last:"", phone:"", kvkk:false, registered:false };

let cFromLatLng = null, cToLatLng = null;
let pkgType = "Zarf";

/* =========================
   DOM HELPERS
========================= */
const $ = (id)=>document.getElementById(id);

function logError(tag, e){
  console.error("[SepetTaxi]", tag, e);
}

/* =========================
   UTIL UI
========================= */
function toast(msg, ms=2400){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>{ t.style.display="none"; }, ms);
}
function showSearching(on){
  $("searching").style.display = on ? "flex" : "none";
}
function setCTAEnabled(on){
  const cta = $("ctaBtn");
  cta.className = on ? "enabled" : "disabled";
}
function setCTALabel(){
  $("ctaBtn").textContent = (service==="taxi") ? "TAKSƒ∞ √áAƒûIR" : "KURYE √áAƒûIR";
}
function setRegBadge(){
  const b = $("regBadge");
  if(customer.registered){
    b.textContent = "Kayƒ±t: Hazƒ±r";
    b.classList.remove("bad"); b.classList.add("ok");
  }else{
    b.textContent = "Kayƒ±t: Gerekli";
    b.classList.remove("ok"); b.classList.add("bad");
  }
}

/* =========================
   REGISTER
========================= */
function loadCustomer(){
  try{
    const raw = localStorage.getItem("SEPT_customer");
    if(raw){
      const c = JSON.parse(raw);
      if(c && typeof c === "object"){
        customer = Object.assign(customer, c);
      }
    }
  }catch(e){ logError("loadCustomer", e); }
  setRegBadge();
}
function saveCustomer(){
  try{
    localStorage.setItem("SEPT_customer", JSON.stringify(customer));
  }catch(e){ logError("saveCustomer", e); }
  setRegBadge();
}
function openRegister(){
  $("regErr").style.display = "none";
  $("regFirst").value = customer.first || "";
  $("regLast").value  = customer.last  || "";
  $("regPhone").value = customer.phone || "";
  $("regKvkk").checked = !!customer.kvkk;

  $("regModal").style.display = "flex";
  $("regModal").setAttribute("aria-hidden","false");
}
function closeRegister(){
  $("regModal").style.display = "none";
  $("regModal").setAttribute("aria-hidden","true");
}
function validatePhone11(v){
  const s = String(v||"").replace(/\D/g,"");
  return (s.length===11 && s.startsWith("0"));
}
function ensureRegistered(){
  if(customer.registered) return true;
  openRegister();
  return false;
}
function showRegErr(msg){
  const el = $("regErr");
  el.textContent = msg;
  el.style.display = "block";
}
function commitRegister(){
  const first = $("regFirst").value.trim();
  const last  = $("regLast").value.trim();
  const phoneRaw = $("regPhone").value.trim();
  const phone = phoneRaw.replace(/\D/g,"");
  const kvkk = $("regKvkk").checked;

  if(!first || !last){
    showRegErr("L√ºtfen ad ve soyad girin.");
    return false;
  }
  if(!validatePhone11(phone)){
    showRegErr("Telefon 11 haneli olmalƒ± ve 0 ile ba≈ülamalƒ±. √ñrn: 05XXXXXXXXX");
    return false;
  }
  if(!kvkk){
    showRegErr("Devam etmek i√ßin KVKK onayƒ±nƒ± i≈üaretleyin.");
    return false;
  }

  customer.first = first;
  customer.last = last;
  customer.phone = phone;
  customer.kvkk = true;
  customer.registered = true;

  saveCustomer();
  closeRegister();
  toast("Kayƒ±t tamamlandƒ±.");
  refreshCTA();
  return true;
}

/* =========================
   SERVICE SWITCH + CTA
========================= */
function setService(next){
  service = next;
  $("btnTaxi").classList.toggle("active", service==="taxi");
  $("btnCourier").classList.toggle("active", service==="courier");

  $("taxiBox").style.display   = (service==="taxi") ? "block" : "none";
  $("courierBox").style.display= (service==="courier") ? "block" : "none";

  $("helperText").textContent = (service==="taxi")
    ? "Varƒ±≈ü i√ßin haritaya dokun veya adres yaz."
    : "Kurye i√ßin adresleri se√ß ve detaylarƒ± doldur.";

  setCTALabel();
  refreshCTA();
}

function refreshCTA(){
  // kayƒ±t yoksa CTA kilit
  if(!customer.registered){
    setCTAEnabled(false);
    return;
  }

  if(service==="taxi"){
    setCTAEnabled(!!(userLatLng && destLatLng));
  }else{
    const ok =
      !!(cFromLatLng && cToLatLng) &&
      !!pkgType &&
      ($("recvName").value.trim().length>=3) &&
      validatePhone11($("recvPhone").value.trim());
    setCTAEnabled(ok);
  }
}

/* =========================
   BACKEND API (v2.4 router)
========================= */
function backendUrl(){
  const u = (window.SEPT && window.SEPT.BACKEND_URL) ? window.SEPT.BACKEND_URL : "";
  if(!u) throw new Error("BACKEND_URL yok (config.js y√ºklenmemi≈ü olabilir).");
  return u;
}
async function apiPost(action, payload){
  const url = backendUrl();
  const body = Object.assign({ action }, payload || {});
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  });
  const txt = await res.text();
  let data = {};
  try{ data = JSON.parse(txt); }catch(e){ data = { ok:false, error:"JSON parse", raw:txt }; }
  return data;
}
async function apiGet(action, params){
  const url = new URL(backendUrl());
  url.searchParams.set("action", action);
  Object.entries(params||{}).forEach(([k,v])=>url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method:"GET" });
  const txt = await res.text();
  let data = {};
  try{ data = JSON.parse(txt); }catch(e){ data = { ok:false, error:"JSON parse", raw:txt }; }
  return data;
}

/* =========================
   GEOCODING (Nominatim)
   - reverse + search (debounced)
========================= */
const NOMINATIM_BASE = "https://nominatim.openstreetmap.org";

async function reverseGeocode(lat,lng){
  const url = new URL(NOMINATIM_BASE + "/reverse");
  url.searchParams.set("format","jsonv2");
  url.searchParams.set("lat", lat);
  url.searchParams.set("lon", lng);
  url.searchParams.set("zoom","18");
  url.searchParams.set("addressdetails","1");

  const r = await fetch(url.toString(), {
    headers:{
      "Accept":"application/json",
      "Accept-Language":"tr"
    }
  });
  const j = await r.json();
  return (j && j.display_name) ? j.display_name : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

async function searchGeocode(q){
  const url = new URL(NOMINATIM_BASE + "/search");
  url.searchParams.set("format","jsonv2");
  url.searchParams.set("q", q);
  url.searchParams.set("limit","6");
  url.searchParams.set("addressdetails","1");
  url.searchParams.set("accept-language","tr");
  // Bursa odaklƒ± bias (opsiyonel)
  // url.searchParams.set("viewbox","28.85,40.35,29.30,40.10");
  // url.searchParams.set("bounded","0");

  const r = await fetch(url.toString(), {
    headers:{
      "Accept":"application/json",
      "Accept-Language":"tr"
    }
  });
  const j = await r.json();
  return Array.isArray(j) ? j : [];
}

function debounce(fn, ms=420){
  let t=null;
  return (...args)=>{
    clearTimeout(t);
    t=setTimeout(()=>fn(...args), ms);
  };
}

function setDatalist(listId, items){
  const dl = $(listId);
  dl.innerHTML = "";
  items.forEach(it=>{
    const opt = document.createElement("option");
    opt.value = it.display_name;
    opt.dataset.lat = it.lat;
    opt.dataset.lon = it.lon;
    dl.appendChild(opt);
  });
}

async function applyAddressTo(type, displayName, lat, lng){
  const ll = L.latLng(parseFloat(lat), parseFloat(lng));
  if(type==="from"){
    userLatLng = ll;
    $("fromInput").value = displayName;
    if(!userMarker) userMarker = L.marker(userLatLng).addTo(map);
    else userMarker.setLatLng(userLatLng);
    fitIfReady();
    computeDistanceAndPrice();
  }else if(type==="to"){
    destLatLng = ll;
    $("toInput").value = displayName;
    if(!destMarker) destMarker = L.marker(destLatLng).addTo(map);
    else destMarker.setLatLng(destLatLng);
    fitIfReady();
    computeDistanceAndPrice();
  }else if(type==="cfrom"){
    cFromLatLng = ll;
    $("cFromInput").value = displayName;
    if(!cFromMarker) cFromMarker = L.marker(cFromLatLng).addTo(map);
    else cFromMarker.setLatLng(cFromLatLng);
    fitIfReadyCourier();
    computeCourierDistanceAndPrice();
  }else if(type==="cto"){
    cToLatLng = ll;
    $("cToInput").value = displayName;
    if(!cToMarker) cToMarker = L.marker(cToLatLng).addTo(map);
    else cToMarker.setLatLng(cToLatLng);
    fitIfReadyCourier();
    computeCourierDistanceAndPrice();
  }
  refreshCTA();
}

/* =========================
   MAP INIT
========================= */
function initMap(){
  if(map) return;

  map = L.map("map", { zoomControl:true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  // Fallback (Bursa civarƒ±)
  map.setView([40.195, 29.060], 12);

  map.on("click", async (e)=>{
    try{
      // Harita tƒ±klamasƒ±: aktif servise g√∂re, aktif se√ßime g√∂re
      const lat = e.latlng.lat, lng = e.latlng.lng;
      const addr = await reverseGeocode(lat,lng);

      if(service==="taxi"){
        if(pickMode==="from"){
          await applyAddressTo("from", addr, lat, lng);
        }else{
          await applyAddressTo("to", addr, lat, lng);
        }
      }else{
        if(cPickMode==="from"){
          await applyAddressTo("cfrom", addr, lat, lng);
        }else{
          await applyAddressTo("cto", addr, lat, lng);
        }
      }
    }catch(err){
      logError("mapClick", err);
      toast("Adres √ß√∂z√ºmlenemedi. Tekrar deneyin.");
    }
  });
}

function fitIfReady(){
  if(!map) return;
  if(userLatLng && destLatLng){
    const bounds = L.latLngBounds([userLatLng, destLatLng]);
    map.fitBounds(bounds.pad(0.25));
  }else if(userLatLng){
    map.setView(userLatLng, 15);
  }
}
function fitIfReadyCourier(){
  if(!map) return;
  if(cFromLatLng && cToLatLng){
    const bounds = L.latLngBounds([cFromLatLng, cToLatLng]);
    map.fitBounds(bounds.pad(0.25));
  }else if(cFromLatLng){
    map.setView(cFromLatLng, 15);
  }
}

/* =========================
   GEOLOCATION
========================= */
function getLocation(){
  if(!navigator.geolocation){
    toast("Tarayƒ±cƒ± konum desteƒüi yok.");
    return;
  }
  toast("Konum alƒ±nƒ±yor‚Ä¶");

  navigator.geolocation.getCurrentPosition(
    async (pos)=>{
      userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);

      if(!userMarker) userMarker = L.marker(userLatLng).addTo(map);
      else userMarker.setLatLng(userLatLng);

      try{
        const addr = await reverseGeocode(userLatLng.lat, userLatLng.lng);
        $("fromInput").value = addr;
      }catch(e){
        $("fromInput").value = `${userLatLng.lat.toFixed(5)}, ${userLatLng.lng.toFixed(5)}`;
      }

      toast("Konum alƒ±ndƒ±.");
      fitIfReady();
      computeDistanceAndPrice();
      refreshCTA();
    },
    (err)=>{
      console.warn(err);
      toast("Konum izni verilmedi veya alƒ±namadƒ±.");
    },
    { enableHighAccuracy:true, timeout:12000, maximumAge:8000 }
  );
}

/* =========================
   DISTANCE & PRICE
========================= */
function haversineKm(a,b){
  const R = 6371;
  const dLat = (b.lat-a.lat) * Math.PI/180;
  const dLon = (b.lng-a.lng) * Math.PI/180;
  const lat1 = a.lat*Math.PI/180, lat2 = b.lat*Math.PI/180;
  const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

function computeDistanceAndPrice(){
  if(!(userLatLng && destLatLng)){
    $("distVal").textContent = "‚Äî";
    $("priceVal").textContent = "‚Äî";
    refreshCTA();
    return;
  }

  if(routeLine) routeLine.remove();
  routeLine = L.polyline([userLatLng, destLatLng]).addTo(map);

  const km = Math.max(0.1, haversineKm(userLatLng, destLatLng));
  $("distVal").textContent = `${km.toFixed(1)} km`;

  const base = 35;
  const perKm = 18;
  const price = Math.round(base + km * perKm);
  $("priceVal").textContent = `${price} ‚Ç∫`;

  refreshCTA();
  return { km, price };
}

function computeCourierDistanceAndPrice(){
  if(!(cFromLatLng && cToLatLng)){
    $("cDistVal").textContent = "‚Äî";
    $("cPriceVal").textContent = "‚Äî";
    refreshCTA();
    return;
  }

  if(cRouteLine) cRouteLine.remove();
  cRouteLine = L.polyline([cFromLatLng, cToLatLng]).addTo(map);

  const km = Math.max(0.1, haversineKm(cFromLatLng, cToLatLng));
  $("cDistVal").textContent = `${km.toFixed(1)} km`;

  // demo kurye fiyat: a√ßƒ±lƒ±≈ü + km
  const base = 45;
  const perKm = 16;
  const price = Math.round(base + km * perKm);
  $("cPriceVal").textContent = `${price} ‚Ç∫`;

  refreshCTA();
  return { km, price };
}

/* =========================
   JOB FLOW (createJob -> poll checkJob -> redirect track)
========================= */
function stopPolling(){
  if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
}

function gotoTrack(){
  if(!currentJobId) return;
  const url = new URL(window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, "/track.html"));
  url.searchParams.set("job_id", currentJobId);
  if(currentTrackToken) url.searchParams.set("track_token", currentTrackToken);
  window.location.href = url.toString();
}

function setSearchingUI(state){
  // state: "creating" | "searching" | "timeout" | "assigned" | "error"
  $("retryBtn").style.display = "none";
  $("goTrackBtn").style.display = "none";
  $("cancelBtn").style.display = "inline-block";

  if(state==="creating"){
    $("searchTitle").textContent = "ƒ∞≈ü olu≈üturuluyor‚Ä¶";
    $("searchSpin").textContent = "Baƒülanƒ±yor";
    $("searchInfo").textContent = "Talebiniz sisteme iletiliyor‚Ä¶";
  }
  if(state==="searching"){
    $("searchTitle").textContent = "S√ºr√ºc√º aranƒ±yor‚Ä¶";
    $("searchSpin").textContent = "Atama bekleniyor";
    $("searchInfo").textContent = "Otomatik atama modunda ilk m√ºsait s√ºr√ºc√ºye y√∂nlendiriyoruz.";
  }
  if(state==="timeout"){
    $("searchTitle").textContent = "Atama gecikti";
    $("searchSpin").textContent = "S√ºr√ºc√º bulunamadƒ±";
    $("searchInfo").textContent = "Hen√ºz m√ºsait s√ºr√ºc√º bulunamadƒ±. Tekrar deneyebilir veya takibe ge√ßebilirsiniz.";
    $("retryBtn").style.display = "inline-block";
    $("goTrackBtn").style.display = "inline-block";
  }
  if(state==="assigned"){
    $("searchTitle").textContent = "S√ºr√ºc√º atandƒ±";
    $("searchSpin").textContent = "Y√∂nlendiriliyor";
    $("searchInfo").textContent = "Takip ekranƒ±na y√∂nlendiriliyorsunuz‚Ä¶";
  }
  if(state==="error"){
    $("searchTitle").textContent = "Hata";
    $("searchSpin").textContent = "ƒ∞≈ülem ba≈üarƒ±sƒ±z";
    $("searchInfo").textContent = "Bir sorun olu≈ütu. L√ºtfen tekrar deneyin.";
    $("retryBtn").style.display = "inline-block";
  }
}

async function pollJob(){
  if(!currentJobId) return;

  const elapsed = Date.now() - pollStartedAt;
  const TIMEOUT_MS = 45000; // 45s (daha net)

  if(elapsed > TIMEOUT_MS){
    stopPolling();
    setSearchingUI("timeout");
    return;
  }

  const r = await apiGet("checkJob", { job_id: currentJobId });

  if(r && r.ok){
    const st = String(r.status||"");
    if(st==="assigned" || st==="on_route"){
      stopPolling();
      setSearchingUI("assigned");
      setTimeout(gotoTrack, 650);
      return;
    }
    if(st==="cancelled"){
      stopPolling();
      $("searchTitle").textContent = "ƒ∞ptal edildi";
      $("searchSpin").textContent = "ƒ∞≈ü iptal edildi";
      $("searchInfo").textContent = "ƒ∞≈ü iptal edildi.";
      setTimeout(()=>showSearching(false), 900);
      return;
    }
    if(st==="completed"){
      stopPolling();
      $("searchTitle").textContent = "Tamamlandƒ±";
      $("searchSpin").textContent = "ƒ∞≈ü tamamlandƒ±";
      $("searchInfo").textContent = "ƒ∞≈ü tamamlandƒ±.";
      setTimeout(()=>showSearching(false), 900);
      return;
    }
    // pending
    setSearchingUI("searching");
    return;
  }

  console.warn("checkJob error", r);
}

/* =========================
   CREATE JOBS
========================= */
async function createTaxiJob(){
  if(!ensureRegistered()) return;

  if(!(userLatLng && destLatLng)){
    toast("L√ºtfen varƒ±≈ü noktasƒ± se√ßin.");
    return;
  }

  const calc = computeDistanceAndPrice() || {};
  const km = calc.km || 0;
  const price = calc.price || 0;

  const fromAddr = $("fromInput").value || `${userLatLng.lat},${userLatLng.lng}`;
  const toAddr   = $("toInput").value   || `${destLatLng.lat},${destLatLng.lng}`;

  showSearching(true);
  setSearchingUI("creating");

  try{
    const payload = {
      service_type: "taxi",
      customer_first: customer.first,
      customer_last: customer.last,
      customer_phone: customer.phone,
      from_address: fromAddr,
      to_address: toAddr,
      pickup_lat: userLatLng.lat,
      pickup_lng: userLatLng.lng,
      dropoff_lat: destLatLng.lat,
      dropoff_lng: destLatLng.lng,
      distance_km: km,
      price: price,
      final_price: price
    };

    const res = await apiPost("createJob", payload);

    if(!(res && res.ok)){
      console.warn("createJob fail", res);
      setSearchingUI("error");
      $("searchInfo").textContent = (res && res.error) ? String(res.error) : "createJob ba≈üarƒ±sƒ±z";
      return;
    }

    currentJobId = String(res.job_id || "");
    currentTrackToken = String(res.track_token || "");
    sessionStorage.setItem("SEPT_job_id", currentJobId);
    sessionStorage.setItem("SEPT_track_token", currentTrackToken);

    setSearchingUI("searching");

    pollStartedAt = Date.now();
    stopPolling();
    const pollMs = (window.SEPT && window.SEPT.POLL_MS) ? parseInt(window.SEPT.POLL_MS,10) : 3000;
    pollTimer = setInterval(pollJob, Math.max(1500, pollMs));
    pollJob();
  }catch(e){
    logError("createTaxiJob", e);
    setSearchingUI("error");
    $("searchInfo").textContent = "Backend‚Äôe ula≈üƒ±lamadƒ±. (config.js BACKEND_URL kontrol edin)";
  }
}

async function createCourierJob(){
  if(!ensureRegistered()) return;

  const recv = $("recvName").value.trim();
  const rph  = $("recvPhone").value.trim();

  if(!(cFromLatLng && cToLatLng)){
    toast("Kurye i√ßin nereden/nereye se√ßin.");
    return;
  }
  if(!recv || recv.length<3){
    toast("Alƒ±cƒ± adƒ±nƒ± girin.");
    return;
  }
  if(!validatePhone11(rph)){
    toast("Alƒ±cƒ± telefonu 11 hane olmalƒ±.");
    return;
  }

  const calc = computeCourierDistanceAndPrice() || {};
  const km = calc.km || 0;
  const price = calc.price || 0;

  const fromAddr = $("cFromInput").value || `${cFromLatLng.lat},${cFromLatLng.lng}`;
  const toAddr   = $("cToInput").value   || `${cToLatLng.lat},${cToLatLng.lng}`;

  showSearching(true);
  setSearchingUI("creating");

  try{
    const payload = {
      service_type: "courier",
      customer_first: customer.first,
      customer_last: customer.last,
      customer_phone: customer.phone,
      from_address: fromAddr,
      to_address: toAddr,
      pickup_lat: cFromLatLng.lat,
      pickup_lng: cFromLatLng.lng,
      dropoff_lat: cToLatLng.lat,
      dropoff_lng: cToLatLng.lng,
      distance_km: km,
      price: price,
      final_price: price,
      package_type: pkgType,
      receiver_name: recv,
      receiver_phone: rph.replace(/\D/g,""),
      note: $("cNote").value.trim()
    };

    const res = await apiPost("createJob", payload);

    if(!(res && res.ok)){
      console.warn("createJob courier fail", res);
      setSearchingUI("error");
      $("searchInfo").textContent = (res && res.error) ? String(res.error) : "createJob ba≈üarƒ±sƒ±z";
      return;
    }

    currentJobId = String(res.job_id || "");
    currentTrackToken = String(res.track_token || "");
    sessionStorage.setItem("SEPT_job_id", currentJobId);
    sessionStorage.setItem("SEPT_track_token", currentTrackToken);

    // kurye i√ßin de aynƒ± takip mantƒ±ƒüƒ±
    setSearchingUI("searching");

    pollStartedAt = Date.now();
    stopPolling();
    const pollMs = (window.SEPT && window.SEPT.POLL_MS) ? parseInt(window.SEPT.POLL_MS,10) : 3000;
    pollTimer = setInterval(pollJob, Math.max(1500, pollMs));
    pollJob();
  }catch(e){
    logError("createCourierJob", e);
    setSearchingUI("error");
    $("searchInfo").textContent = "Backend‚Äôe ula≈üƒ±lamadƒ±. (config.js BACKEND_URL kontrol edin)";
  }
}

/* =========================
   CTA CLICK
========================= */
function onCTA(){
  if($("ctaBtn").classList.contains("disabled")) return;
  if(service==="courier"){
    createCourierJob();
  }else{
    createTaxiJob();
  }
}

/* =========================
   CANCEL / RETRY
========================= */
function cancelFlow(){
  stopPolling();
  currentJobId = "";
  currentTrackToken = "";
  showSearching(false);
}
function retryFlow(){
  stopPolling();
  // job olu≈üturulmu≈üsa aynƒ± job ile tekrar poll etmek yerine yeni i≈ü a√ßmak daha doƒüru.
  // Biz: overlay kapanƒ±r, kullanƒ±cƒ± tekrar CTA'ya basar.
  showSearching(false);
  toast("Tekrar deneyebilirsiniz.");
}

/* =========================
   INPUT SEARCH BINDINGS
========================= */
function bindSearch(inputId, listId, applyType){
  const inp = $(inputId);

  const run = debounce(async ()=>{
    const q = inp.value.trim();
    if(q.length < 4) return;
    try{
      const items = await searchGeocode(q);
      setDatalist(listId, items);
    }catch(e){
      logError("searchGeocode:"+inputId, e);
    }
  }, 420);

  inp.addEventListener("input", ()=>{
    run();
  });

  inp.addEventListener("change", async ()=>{
    const q = inp.value.trim();
    if(!q) return;
    try{
      const items = await searchGeocode(q);
      if(items && items[0]){
        await applyAddressTo(applyType, items[0].display_name, items[0].lat, items[0].lon);
      }
    }catch(e){
      logError("applyFromChange:"+inputId, e);
      toast("Adres bulunamadƒ±.");
    }
  });

  inp.addEventListener("keydown", async (ev)=>{
    if(ev.key==="Enter"){
      ev.preventDefault();
      inp.blur();
    }
  });
}

/* =========================
   START
========================= */
function start(){
  $("landing").style.display = "none";
  $("app").style.display = "block";

  initMap();

  setTimeout(()=>{ map.invalidateSize(); }, 60);

  loadCustomer();
  getLocation();

  // ba≈ülangƒ±√ßta kayƒ±t varsa sorun yok; yoksa hizmet se√ßimiyle modal a√ßƒ±lacak
  setService("taxi");
}

document.addEventListener("DOMContentLoaded", ()=>{
  // start
  $("startBtn").addEventListener("click", start);

  // service switching => kayƒ±t zorunlu
  $("btnTaxi").addEventListener("click", ()=>{
    setService("taxi");
    ensureRegistered();
  });
  $("btnCourier").addEventListener("click", ()=>{
    setService("courier");
    ensureRegistered();
  });

  // CTA
  $("ctaBtn").addEventListener("click", onCTA);

  // searching controls
  $("cancelBtn").addEventListener("click", cancelFlow);
  $("retryBtn").addEventListener("click", retryFlow);
  $("goTrackBtn").addEventListener("click", gotoTrack);

  // register modal actions
  $("regCancel").addEventListener("click", ()=>{
    closeRegister();
    toast("Kayƒ±t olmadan devam edilemez.");
    refreshCTA();
  });
  $("regSave").addEventListener("click", commitRegister);
  $("regPhone").addEventListener("input", ()=>{
    $("regPhone").value = $("regPhone").value.replace(/[^\d]/g,"").slice(0,11);
  });

  // pick buttons (taxi)
  $("pickFromBtn").addEventListener("click", ()=>{
    pickMode="from";
    $("pickFromBtn").classList.add("active");
    $("pickToBtn").classList.remove("active");
    toast("Haritadan 'Nereden' se√ßebilirsiniz.");
  });
  $("pickToBtn").addEventListener("click", ()=>{
    pickMode="to";
    $("pickToBtn").classList.add("active");
    $("pickFromBtn").classList.remove("active");
    toast("Haritadan 'Nereye' se√ßebilirsiniz.");
  });

  // pick buttons (courier)
  $("cPickFromBtn").addEventListener("click", ()=>{
    cPickMode="from";
    $("cPickFromBtn").classList.add("active");
    $("cPickToBtn").classList.remove("active");
    toast("Kurye: haritadan 'Nereden' se√ßebilirsiniz.");
  });
  $("cPickToBtn").addEventListener("click", ()=>{
    cPickMode="to";
    $("cPickToBtn").classList.add("active");
    $("cPickFromBtn").classList.remove("active");
    toast("Kurye: haritadan 'Nereye' se√ßebilirsiniz.");
  });

  // bind address inputs
  bindSearch("fromInput", "fromList", "from");
  bindSearch("toInput", "toList", "to");
  bindSearch("cFromInput", "cFromList", "cfrom");
  bindSearch("cToInput", "cToList", "cto");

  // courier chips
  $("pkgChips").addEventListener("click", (e)=>{
    const chip = e.target.closest(".chip");
    if(!chip) return;
    const v = chip.getAttribute("data-pkg");
    if(!v) return;
    pkgType = v;
    [...$("pkgChips").querySelectorAll(".chip")].forEach(x=>x.classList.toggle("active", x===chip));
    refreshCTA();
  });

  // courier inputs validation
  $("recvPhone").addEventListener("input", ()=>{
    $("recvPhone").value = $("recvPhone").value.replace(/[^\d]/g,"").slice(0,11);
    refreshCTA();
  });
  $("recvName").addEventListener("input", refreshCTA);
});
</script>

</body>
</html>
