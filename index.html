<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  background:#050506;color:#fff;overflow:hidden;
}
:root{
  --y:#f5c400;
  --bg:#050506;
  --panel:#0f0f10;
  --card:#141416;
  --line:rgba(255,255,255,.10);
  --mut:rgba(255,255,255,.62);
  --mut2:rgba(255,255,255,.42);
  --ok:#39d98a;
  --warn:#ffcc66;
  --bad:#ff4d4d;
}

/* ===== LANDING ===== */
#landing{
  position:fixed;inset:0;z-index:80;
  background:#000 url("assets/landing.png") center/cover no-repeat;
  display:flex;align-items:center;justify-content:center;
  animation:landingOut 1.05s ease forwards;
  animation-delay:1.05s;
}
@keyframes landingOut{
  to{opacity:0;filter:blur(8px);pointer-events:none}
}

/* ===== APP SHELL ===== */
#app{position:fixed;inset:0;display:flex;flex-direction:column}

/* TOP BAR */
#topbar{
  height:56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,#0b0b0c,#070708);
}
#topbar .logo{font-weight:900;font-size:18px;letter-spacing:.2px}
#topbar .logo span{color:var(--y)}
#topbar .iconBtn{
  width:38px;height:38px;border-radius:12px;
  display:grid;place-items:center;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  color:#fff;opacity:.92;
  user-select:none;
}
#topbar .iconBtn:active{transform:scale(.98)}

/* ===== STAGE ===== */
#stage{position:relative;flex:1;overflow:hidden}

/* MAP + UI STATES */
#mapWrap{
  position:absolute;left:0;right:0;top:0;
  height:50%;
  transition:height .28s ease;
}
#stage.focus #mapWrap{height:40%}
#map{width:100%;height:100%}

/* subtle top vignette */
#mapVignette{
  position:absolute;inset:0;pointer-events:none;z-index:3;
  background:
    radial-gradient(120% 80% at 50% 0%, rgba(0,0,0,.55), rgba(0,0,0,.08) 55%, rgba(0,0,0,.45)),
    linear-gradient(180deg, rgba(0,0,0,.45), rgba(0,0,0,0) 55%);
  mix-blend-mode:normal;
}

/* scroll only on map */
#mapScrollCatcher{position:absolute;inset:0;z-index:4}

/* Center pin selector */
#centerPin{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-100%);
  z-index:5;pointer-events:none;
  width:28px;height:28px;
  filter:drop-shadow(0 10px 18px rgba(0,0,0,.55));
}
#centerPin svg{width:28px;height:28px}
.pinPulse{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-10%);
  width:10px;height:10px;border-radius:50%;
  background:rgba(245,196,0,.85);
  box-shadow:0 0 0 0 rgba(245,196,0,.35);
  animation:pulse 1.6s ease infinite;
  z-index:4;pointer-events:none;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(245,196,0,.35)}
  70%{box-shadow:0 0 0 18px rgba(245,196,0,0)}
  100%{box-shadow:0 0 0 0 rgba(245,196,0,0)}
}

/* BOTTOM UI */
#ui{
  position:absolute;left:0;right:0;bottom:0;
  height:50%;
  transition:height .28s ease;
  background:linear-gradient(180deg, rgba(5,5,6,.78), rgba(5,5,6,.97) 36%, rgba(5,5,6,.99));
  border-top:1px solid var(--line);
  padding:12px;
  display:flex;flex-direction:column;gap:10px;
}
#stage.focus #ui{height:60%}

/* Cards */
.card{
  background:rgba(20,20,22,.92);
  border:1px solid rgba(255,255,255,.10);
  border-radius:16px;
  padding:12px;
  box-shadow:0 18px 40px rgba(0,0,0,.35);
}

/* Service segment */
.segment{display:flex;gap:10px}
.seg{
  flex:1;padding:12px;border-radius:14px;text-align:left;
  background:rgba(10,10,11,.78);
  border:1px solid rgba(255,255,255,.10);
  opacity:.62;
  transition:all .18s ease;
}
.seg b{display:block;font-size:14px}
.seg small{display:block;color:var(--mut2);margin-top:2px}
.seg.active{
  opacity:1;
  border-color:rgba(245,196,0,.62);
  background:linear-gradient(180deg, rgba(245,196,0,.16), rgba(10,10,11,.82));
  box-shadow:0 0 0 1px rgba(245,196,0,.22), 0 0 18px rgba(245,196,0,.12);
}

/* Address block */
.addrRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
.addrLeft{display:flex;align-items:center;gap:10px;min-width:0}
.dot{width:9px;height:9px;border-radius:50%;background:var(--y);flex:0 0 auto}
.dot.to{background:#7CFF9B}
.addrText{min-width:0}
.addrLabel{font-size:12px;color:var(--mut2);margin-bottom:2px}
.addrVal{
  font-size:14px;font-weight:700;color:#fff;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.addrVal.muted{color:var(--mut)}
.pickBtn{
  height:34px;padding:0 12px;border-radius:12px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.03);
  color:#fff;font-weight:800;font-size:13px;
  user-select:none;
}
.pickBtn:active{transform:scale(.99)}
.hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0;border-radius:1px}

/* Stats */
.stats{display:flex;gap:10px}
.stat{
  flex:1;text-align:left;border-radius:14px;
  background:rgba(10,10,11,.78);
  border:1px solid rgba(255,255,255,.10);
  padding:10px 12px;
  position:relative;overflow:hidden;
}
.stat .k{font-size:12px;color:var(--mut2)}
.stat .v{font-size:20px;font-weight:900;margin-top:2px;letter-spacing:.2px}
.locked .v{filter:blur(6px);opacity:.55}
.lockBadge{
  position:absolute;right:10px;top:10px;
  font-size:12px;color:#000;font-weight:900;
  background:linear-gradient(180deg,#ffd84d,#f5c400);
  padding:4px 8px;border-radius:999px;
}

/* CTA */
#cta{
  margin-top:auto;
  height:54px;border:none;border-radius:18px;
  background:linear-gradient(180deg,#ffd84d,#f5c400);
  color:#000;font-size:18px;font-weight:950;
  letter-spacing:.2px;
  box-shadow:0 18px 40px rgba(245,196,0,.15), 0 10px 24px rgba(0,0,0,.45);
}
#cta:disabled{
  opacity:.45;filter:saturate(.6);box-shadow:none;
}

/* Mini status line */
#miniStatus{
  font-size:12px;color:var(--mut2);
  padding:0 4px;margin-top:-2px;
}

/* ===== SHEET (Map pick confirm) ===== */
#pickSheet{
  position:fixed;left:0;right:0;bottom:-280px;
  z-index:60;
  transition:transform .24s ease;
  transform:translateY(0);
  padding:12px;
}
#pickSheet.show{transform:translateY(-280px)}
.sheetCard{
  background:rgba(15,15,16,.94);
  border:1px solid rgba(255,255,255,.12);
  border-radius:18px;
  padding:12px;
  box-shadow:0 24px 60px rgba(0,0,0,.55);
  backdrop-filter:blur(16px);
}
.sheetTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.sheetTitle{font-weight:950}
.sheetSub{font-size:12px;color:var(--mut2);margin-top:4px}
.sheetAddr{
  margin-top:10px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:10px;
  font-size:13px;color:#fff;
  max-height:54px;overflow:hidden;
}
.sheetActions{display:flex;gap:10px;margin-top:10px}
.btn{
  flex:1;height:44px;border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  color:#fff;font-weight:950;
}
.btn.primary{
  background:linear-gradient(180deg,#ffd84d,#f5c400);
  color:#000;border:none;
}
.btn:active{transform:scale(.99)}

/* ===== REGISTER MODAL ===== */
#regModal{
  position:fixed;inset:0;z-index:70;
  display:none;align-items:flex-end;justify-content:center;
  background:rgba(0,0,0,.55);
}
#regModal.show{display:flex}
#regCard{
  width:100%;
  max-width:520px;
  border-radius:22px 22px 0 0;
  background:rgba(15,15,16,.96);
  border:1px solid rgba(255,255,255,.10);
  padding:14px 14px 16px;
  box-shadow:0 -20px 60px rgba(0,0,0,.65);
  backdrop-filter:blur(16px);
}
.handle{width:44px;height:5px;border-radius:999px;background:rgba(255,255,255,.18);margin:4px auto 10px}
.regTitle{font-weight:950;font-size:16px}
.regDesc{font-size:12px;color:var(--mut2);margin-top:4px;line-height:1.35}
.fields{display:flex;gap:10px;margin-top:12px}
.field{flex:1}
input{
  width:100%;height:46px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  color:#fff;font-weight:800;
  padding:0 12px;outline:none;
}
input::placeholder{color:rgba(255,255,255,.35);font-weight:700}
.regActions{display:flex;gap:10px;margin-top:10px}
.smallBtn{
  height:46px;border-radius:14px;border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);color:#fff;font-weight:900;flex:1;
}
.smallBtn.primary{
  background:linear-gradient(180deg,#ffd84d,#f5c400);
  color:#000;border:none;
}

/* ===== PREMIUM SEARCHING OVERLAY ===== */
#searchOverlay{
  position:fixed;inset:0;z-index:75;
  display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.48);
}
#searchOverlay.show{display:flex}
#searchCard{
  width:min(520px, calc(100% - 28px));
  border-radius:22px;
  background:rgba(15,15,16,.78);
  border:1px solid rgba(255,255,255,.12);
  padding:16px;
  backdrop-filter:blur(18px);
  box-shadow:0 30px 80px rgba(0,0,0,.65);
}
.searchTop{display:flex;align-items:center;justify-content:space-between}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
}
.badge{
  width:10px;height:10px;border-radius:50%;
  background:var(--y);
  box-shadow:0 0 0 0 rgba(245,196,0,.35);
  animation:pulse 1.25s ease infinite;
}
.searchTitle{font-weight:950}
.searchSub{margin-top:8px;color:var(--mut);font-size:13px;line-height:1.35}
.progress{
  margin-top:12px;height:10px;border-radius:999px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.10);
  overflow:hidden;
}
.bar{
  width:28%;height:100%;
  background:linear-gradient(90deg, rgba(245,196,0,.25), rgba(245,196,0,1), rgba(245,196,0,.25));
  filter:saturate(1.2);
  animation:indet 1.15s ease-in-out infinite;
}
@keyframes indet{
  0%{transform:translateX(-40%)}
  100%{transform:translateX(260%)}
}
.searchMeta{margin-top:10px;font-size:12px;color:var(--mut2)}
.searchMeta b{color:#fff}
.cancelRow{display:flex;gap:10px;margin-top:12px}
.cancelBtn{
  flex:1;height:44px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  color:#fff;font-weight:950;
}
.cancelBtn:active{transform:scale(.99)}

/* Toast */
#toast{
  position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
  z-index:90;
  background:rgba(15,15,16,.92);
  border:1px solid rgba(255,255,255,.12);
  color:#fff;
  padding:10px 12px;border-radius:14px;
  max-width:min(520px, calc(100% - 28px));
  display:none;
  backdrop-filter:blur(14px);
}
#toast.show{display:block}
</style>
</head>

<body>
<div id="landing"></div>

<div id="app">
  <div id="topbar">
    <div class="iconBtn" id="menuBtn" title="Men√º">‚ò∞</div>
    <div class="logo">Sepet<span>Taxi</span></div>
    <div class="iconBtn" id="bellBtn" title="Bildirim">üîî</div>
  </div>

  <div id="stage">
    <div id="mapWrap">
      <div id="map"></div>
      <div id="mapVignette"></div>

      <div class="pinPulse" id="pinPulse" style="display:none"></div>
      <div id="centerPin" style="display:none">
        <svg viewBox="0 0 24 24" fill="none">
          <path d="M12 22s7-6.3 7-13a7 7 0 1 0-14 0c0 6.7 7 13 7 13z" fill="#f5c400" opacity=".95"/>
          <circle cx="12" cy="9" r="2.6" fill="#111"/>
        </svg>
      </div>

      <!-- scroll sadece harita √ºst√ºnde -->
      <div id="mapScrollCatcher" aria-hidden="true"></div>
    </div>

    <div id="ui">
      <div class="card segment">
        <div class="seg active" id="segTaxi"><b>Taksi</b><small>Hƒ±zlƒ± ula≈üƒ±m</small></div>
        <div class="seg" id="segCourier"><b>Kurye</b><small>Moto teslimat</small></div>
      </div>

      <div class="card" style="padding:12px">
        <div class="addrRow">
          <div class="addrLeft">
            <div class="dot"></div>
            <div class="addrText">
              <div class="addrLabel">Nereden</div>
              <div class="addrVal muted" id="fromText">Haritadan se√ßin</div>
            </div>
          </div>
          <button class="pickBtn" id="pickFromBtn">Se√ß</button>
        </div>

        <div class="hr"></div>

        <div class="addrRow">
          <div class="addrLeft">
            <div class="dot to"></div>
            <div class="addrText">
              <div class="addrLabel">Nereye</div>
              <div class="addrVal muted" id="toText">Haritadan se√ßin</div>
            </div>
          </div>
          <button class="pickBtn" id="pickToBtn">Se√ß</button>
        </div>

        <div id="miniStatus">Haritayƒ± hareket ettirip merkez pinden konum se√ßin.</div>
      </div>

      <div class="stats">
        <div class="stat locked" id="statDist">
          <div class="k">Mesafe</div>
          <div class="v" id="distVal">‚Äî km</div>
          <div class="lockBadge" id="distLock">Kayƒ±t</div>
        </div>
        <div class="stat locked" id="statPrice">
          <div class="k">√úcret</div>
          <div class="v" id="priceVal">‚Äî TL</div>
          <div class="lockBadge" id="priceLock">Kayƒ±t</div>
        </div>
      </div>

      <button id="cta" disabled>Taksi √áaƒüƒ±r</button>
    </div>
  </div>
</div>

<!-- Pick Sheet -->
<div id="pickSheet">
  <div class="sheetCard">
    <div class="sheetTop">
      <div>
        <div class="sheetTitle" id="sheetTitle">Konum se√ß</div>
        <div class="sheetSub" id="sheetSub">Haritayƒ± hareket ettirin. Merkez pine oturunca ‚ÄúOnayla‚Äù.</div>
      </div>
      <div class="iconBtn" id="sheetClose" title="Kapat">‚úï</div>
    </div>

    <div class="sheetAddr" id="sheetAddr">Adres bulunuyor‚Ä¶</div>

    <div class="sheetActions">
      <button class="btn" id="sheetCancel">Vazge√ß</button>
      <button class="btn primary" id="sheetOk">Onayla</button>
    </div>
  </div>
</div>

<!-- Register Modal -->
<div id="regModal">
  <div id="regCard">
    <div class="handle"></div>
    <div class="regTitle">Kayƒ±t</div>
    <div class="regDesc">
      √áaƒürƒ±dan √∂nce kayƒ±t zorunludur. Mesafe ve √ºcret, kayƒ±t sonrasƒ± g√∂r√ºn√ºr.
    </div>

    <div class="fields">
      <div class="field"><input id="firstName" placeholder="Ad" autocomplete="given-name" /></div>
      <div class="field"><input id="lastName" placeholder="Soyad" autocomplete="family-name" /></div>
    </div>
    <div class="fields">
      <div class="field"><input id="phone" placeholder="Telefon (05xx‚Ä¶)" inputmode="tel" autocomplete="tel" /></div>
    </div>

    <div class="regActions">
      <button class="smallBtn" id="regCancel">Kapat</button>
      <button class="smallBtn primary" id="regOk">Devam Et</button>
    </div>
  </div>
</div>

<!-- Searching Overlay -->
<div id="searchOverlay">
  <div id="searchCard">
    <div class="searchTop">
      <div class="pill">
        <div class="badge"></div>
        <div style="font-weight:950">S√ºr√ºc√º aranƒ±yor</div>
      </div>
      <div style="opacity:.8;font-weight:900" id="svcPill">Taksi</div>
    </div>

    <div class="searchTitle" style="margin-top:10px">Yakƒ±n s√ºr√ºc√ºlerle e≈üle≈üiyoruz</div>
    <div class="searchSub" id="searchSub">L√ºtfen bekleyin‚Ä¶ Konum ve rota hazƒ±rlanƒ±yor.</div>

    <div class="progress"><div class="bar"></div></div>

    <div class="searchMeta">
      Durum: <b id="searchStatus">searching</b>
      ¬∑ ƒ∞≈ü No: <b id="jobIdTxt">‚Äî</b>
    </div>

    <div class="cancelRow">
      <button class="cancelBtn" id="cancelSearch">ƒ∞ptal</button>
    </div>
  </div>
</div>

<div id="toast"></div>

<script>
/* =========================
   BACKEND CONFIG
   ========================= */
const API =
  "https://script.google.com/macros/s/AKfycbxoeXl9XfxWtsqqCfftNV578KD_woNSKfT3KmSYwZuCv8iPSPd8-cZXNoYMh6Qx-yrlWA/exec";

/* =========================
   STATE
   ========================= */
let currentService = "taxi";
let focused = false;

let picking = null; // "from" | "to" | null
let from = null;    // {lat,lng,address}
let to = null;      // {lat,lng,address}
let routeLine = null;

let distanceKm = null;
let estimatedPrice = null;

let registered = false;
let user = { first:"", last:"", phone:"" };

let activeJobId = null;
let pollTimer = null;

/* =========================
   HELPERS
   ========================= */
const $ = (id)=>document.getElementById(id);

function toast(msg, ms=2200){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>t.classList.remove("show"), ms);
}

function safePhone(p){
  const s = (p||"").replace(/[^\d]/g,"");
  if(!s) return "";
  if(s.startsWith("90")) return s;
  if(s.startsWith("0")) return "9"+s; // 90 + 0xxxxxxxxxx -> 90 0... (ok for storage)
  return s;
}

function enableCTAIfReady(){
  const ok = !!(from && to && registered && distanceKm != null && estimatedPrice != null);
  $("cta").disabled = !ok;
}

function setService(s){
  currentService = s;
  $("segTaxi").classList.toggle("active", s==="taxi");
  $("segCourier").classList.toggle("active", s==="courier");
  $("cta").textContent = (s==="taxi") ? "Taksi √áaƒüƒ±r" : "Kurye √áaƒüƒ±r";
  $("svcPill").textContent = (s==="taxi") ? "Taksi" : "Kurye";
}

/* Count-up */
function animateNumber(el, toValue, suffix, dur=650){
  const fromValue = 0;
  const start = performance.now();
  const fmt = (v)=>{
    if(Number.isFinite(toValue) && toValue < 10 && suffix===" km") return v.toFixed(1);
    return Math.round(v).toString();
  };
  function tick(now){
    const t = Math.min(1, (now-start)/dur);
    const eased = 1 - Math.pow(1-t, 3);
    const v = fromValue + (toValue-fromValue)*eased;
    el.textContent = fmt(v) + suffix;
    if(t < 1) requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

/* Reverse geocode via Nominatim */
async function reverseGeocode(lat, lng){
  const url =
    "https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=" +
    encodeURIComponent(lat) + "&lon=" + encodeURIComponent(lng);

  const r = await fetch(url, {
    headers:{
      "Accept":"application/json",
      "User-Agent":"SepetTaxi/1.0 (web)"
    }
  });
  if(!r.ok) throw new Error("reverse geocode failed");
  const j = await r.json();
  return j.display_name || "Adres bulunamadƒ±";
}

/* Haversine distance (km) */
function haversineKm(a,b){
  const R = 6371;
  const dLat = (b.lat-a.lat) * Math.PI/180;
  const dLng = (b.lng-a.lng) * Math.PI/180;
  const sa = Math.sin(dLat/2)**2 + Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.min(1, Math.sqrt(sa)));
}

/* Simple price model (UI seviyesinde) */
function estimatePriceTL(service, km){
  // Taksi: taban + km*birim
  // Kurye: daha d√º≈ü√ºk taban + km*birim
  // (Bu deƒüerleri backend ile birebir istersen sonra kilitleriz)
  const base = (service==="taxi") ? 60 : 45;
  const perKm = (service==="taxi") ? 18 : 14;
  const v = base + perKm * km;
  return Math.round(v / 5) * 5; // 5 TL yuvarlama
}

/* =========================
   BACKEND CALLS (GET + POST fallback)
   ========================= */
async function apiGet(action, params={}){
  const qs = new URLSearchParams({action, ...params}).toString();
  const r = await fetch(API + "?" + qs, { method:"GET" });
  const j = await r.json().catch(()=> ({}));
  return j;
}
async function apiPost(action, data={}){
  const r = await fetch(API, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action, ...data })
  });
  const j = await r.json().catch(()=> ({}));
  return j;
}
async function api(action, data){
  // √∂nce GET dene (Apps Script‚Äôte bazen daha stabil), olmazsa POST
  try{
    const g = await apiGet(action, data || {});
    if(!g || g.error) throw new Error(g?.error || "GET failed");
    return g;
  }catch(e){
    const p = await apiPost(action, data || {});
    if(p && !p.error) return p;
    throw new Error(p?.error || e.message || "API failed");
  }
}

/* =========================
   MAP INIT
   ========================= */
const map = L.map("map", { zoomControl:false }).setView([41.0369, 28.9850], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution:"" }).addTo(map);

// from/to markers (premium small)
const fromMarker = L.circleMarker([0,0], {radius:7, color:"#f5c400", weight:2, fillColor:"#f5c400", fillOpacity:1});
const toMarker   = L.circleMarker([0,0], {radius:7, color:"#7CFF9B", weight:2, fillColor:"#7CFF9B", fillOpacity:1});

function drawRoute(){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  if(!(from && to)) return;

  const pts = [[from.lat, from.lng],[to.lat,to.lng]];
  routeLine = L.polyline(pts, {
    color:"#f5c400", weight:4, opacity:0.95, dashArray:"10 10"
  }).addTo(map);

  const bounds = L.latLngBounds(pts).pad(0.25);
  map.fitBounds(bounds, { animate:true, duration:0.55 });
}

function refreshStats(){
  const distEl = $("distVal");
  const priceEl = $("priceVal");

  if(!(from && to)){
    distanceKm = null; estimatedPrice=null;
    distEl.textContent="‚Äî km";
    priceEl.textContent="‚Äî TL";
    enableCTAIfReady();
    return;
  }

  distanceKm = Math.max(0.1, haversineKm(from,to));
  estimatedPrice = estimatePriceTL(currentService, distanceKm);

  if(!registered){
    // locked view (blur)
    distEl.textContent = distanceKm.toFixed(1) + " km";
    priceEl.textContent = estimatedPrice + " TL";
    $("statDist").classList.add("locked");
    $("statPrice").classList.add("locked");
    $("distLock").style.display="";
    $("priceLock").style.display="";
  }else{
    $("statDist").classList.remove("locked");
    $("statPrice").classList.remove("locked");
    $("distLock").style.display="none";
    $("priceLock").style.display="none";
    animateNumber(distEl, distanceKm, " km", 680);
    animateNumber(priceEl, estimatedPrice, " TL", 720);
  }

  enableCTAIfReady();
}

/* =========================
   2-STATE SCROLL (MAP ONLY)
   ========================= */
const stage = $("stage");
const catcher = $("mapScrollCatcher");

function setFocus(on){
  focused = !!on;
  stage.classList.toggle("focus", focused);
  setTimeout(()=>map.invalidateSize(), 320);
}

catcher.addEventListener("wheel", (e)=>{
  e.preventDefault();
  if(e.deltaY > 0 && !focused) setFocus(true);
  if(e.deltaY < 0 && focused) setFocus(false);
},{passive:false});

// mobile swipe
let sy = 0;
catcher.addEventListener("touchstart", (e)=>{ sy = e.touches[0].clientY; }, {passive:true});
catcher.addEventListener("touchmove", (e)=>{
  const dy = e.touches[0].clientY - sy;
  if(dy < -24 && !focused) setFocus(true);
  if(dy > 24 && focused) setFocus(false);
},{passive:true});

/* =========================
   PICK FLOW (CENTER PIN + REVERSE GEOCODE)
   ========================= */
function openPick(which){
  picking = which;
  $("sheetTitle").textContent = which==="from" ? "Nereden se√ß" : "Nereye se√ß";
  $("sheetSub").textContent = "Haritayƒ± hareket ettirin. Merkez pine oturunca ‚ÄúOnayla‚Äù.";
  $("sheetAddr").textContent = "Adres bulunuyor‚Ä¶";

  $("centerPin").style.display="";
  $("pinPulse").style.display="";
  $("pickSheet").classList.add("show");

  // focus map for selection
  setFocus(true);
  updateCenterAddressDebounced();
}

function closePick(){
  picking = null;
  $("pickSheet").classList.remove("show");
  $("centerPin").style.display="none";
  $("pinPulse").style.display="none";
  $("sheetAddr").textContent = "";
  // leave focus as-is (user‚Äôs control)
}

let addrDebounce = null;
function updateCenterAddressDebounced(){
  clearTimeout(addrDebounce);
  addrDebounce = setTimeout(updateCenterAddress, 240);
}
async function updateCenterAddress(){
  if(!picking) return;
  const c = map.getCenter();
  try{
    const txt = await reverseGeocode(c.lat, c.lng);
    $("sheetAddr").textContent = txt;
  }catch(e){
    $("sheetAddr").textContent = "Adres bulunamadƒ±. Tekrar deneyin.";
  }
}
map.on("moveend", ()=>{ if(picking) updateCenterAddressDebounced(); });

async function confirmPick(){
  if(!picking) return;
  const c = map.getCenter();
  $("sheetAddr").textContent = "Adres doƒürulanƒ±yor‚Ä¶";
  let addr = "";
  try{
    addr = await reverseGeocode(c.lat, c.lng);
  }catch(e){
    addr = "Adres bulunamadƒ±";
  }

  const obj = { lat:+c.lat.toFixed(6), lng:+c.lng.toFixed(6), address:addr };

  if(picking==="from"){
    from = obj;
    $("fromText").textContent = addr;
    $("fromText").classList.remove("muted");
    fromMarker.setLatLng([from.lat, from.lng]).addTo(map);
  }else{
    to = obj;
    $("toText").textContent = addr;
    $("toText").classList.remove("muted");
    toMarker.setLatLng([to.lat, to.lng]).addTo(map);
  }

  closePick();
  drawRoute();
  refreshStats();

  // if both selected but not registered ‚Üí prompt (soft)
  if(from && to && !registered){
    setTimeout(()=>showRegister(true), 420);
  }
}

/* =========================
   REGISTER FLOW
   ========================= */
function showRegister(show){
  $("regModal").classList.toggle("show", !!show);
}
function validateRegister(){
  const f = $("firstName").value.trim();
  const l = $("lastName").value.trim();
  const p = safePhone($("phone").value.trim());
  if(f.length < 2) return {ok:false, msg:"Ad en az 2 karakter olmalƒ±."};
  if(l.length < 2) return {ok:false, msg:"Soyad en az 2 karakter olmalƒ±."};
  if(p.length < 10) return {ok:false, msg:"Telefon ge√ßerli deƒüil."};
  return {ok:true, f,l,p};
}

/* =========================
   SEARCH OVERLAY
   ========================= */
function showSearch(show, statusText){
  $("searchOverlay").classList.toggle("show", !!show);
  if(statusText) $("searchStatus").textContent = statusText;
}
function stopPolling(){
  if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
}

/* =========================
   JOB POLL (assigned -> redirect)
   ========================= */
async function pollJob(){
  if(!activeJobId) return;
  try{
    const j = await api("getJob", { job_id: activeJobId });
    const st = (j.status || j.job?.status || "searching").toLowerCase();
    $("searchStatus").textContent = st;

    // user feedback text
    const msg =
      st==="searching" ? "Yakƒ±n s√ºr√ºc√ºlerle e≈üle≈üiyoruz. L√ºtfen bekleyin‚Ä¶" :
      st==="assigned" ? "S√ºr√ºc√º atandƒ±. Takip ekranƒ±na y√∂nlendiriyoruz‚Ä¶" :
      st==="on_the_way" ? "S√ºr√ºc√º yolda. Takip ekranƒ±na y√∂nlendiriyoruz‚Ä¶" :
      st==="arrived" ? "S√ºr√ºc√º geldi. Takip ekranƒ±na y√∂nlendiriyoruz‚Ä¶" :
      st==="completed" ? "ƒ∞≈ü tamamlandƒ±." :
      "Durum g√ºncelleniyor‚Ä¶";
    $("searchSub").textContent = msg;

    if(st==="assigned" || st==="on_the_way" || st==="arrived"){
      stopPolling();
      // redirect to track
      const url = "track.html?job_id=" + encodeURIComponent(activeJobId) + "&service=" + encodeURIComponent(currentService);
      location.href = url;
    }
  }catch(e){
    // ignore intermittent
  }
}

/* =========================
   UI EVENTS
   ========================= */
$("segTaxi").onclick = ()=>{ setService("taxi"); refreshStats(); };
$("segCourier").onclick = ()=>{ setService("courier"); refreshStats(); };

$("pickFromBtn").onclick = ()=>openPick("from");
$("pickToBtn").onclick = ()=>openPick("to");

$("sheetClose").onclick = closePick;
$("sheetCancel").onclick = closePick;
$("sheetOk").onclick = confirmPick;

$("regCancel").onclick = ()=>showRegister(false);
$("regOk").onclick = ()=>{
  const v = validateRegister();
  if(!v.ok){ toast(v.msg); return; }
  registered = true;
  user = { first:v.f, last:v.l, phone:v.p };
  showRegister(false);
  toast("Kayƒ±t tamamlandƒ±.");
  refreshStats();
};

$("statDist").onclick = ()=>{ if(!registered) showRegister(true); };
$("statPrice").onclick = ()=>{ if(!registered) showRegister(true); };

$("cancelSearch").onclick = async ()=>{
  stopPolling();
  showSearch(false);
  toast("ƒ∞≈ü iptal edildi.");
  activeJobId = null;
};

/* CTA -> createJob */
$("cta").onclick = async ()=>{
  if(!(from && to)) { toast("Adresleri se√ßin."); return; }
  if(!registered){ showRegister(true); return; }
  if(distanceKm==null || estimatedPrice==null){ toast("Hesaplama yapƒ±lamadƒ±."); return; }

  // show premium overlay
  showSearch(true, "searching");
  $("jobIdTxt").textContent = "‚Äî";

  try{
    const payload = {
      service_type: currentService,
      customer_first: user.first,
      customer_last: user.last,
      customer_phone: user.phone,
      from_address: from.address,
      to_address: to.address,
      pickup_lat: from.lat, pickup_lng: from.lng,
      dropoff_lat: to.lat, dropoff_lng: to.lng,
      distance_km: +distanceKm.toFixed(2),
      price: estimatedPrice
    };

    const res = await api("createJob", payload);

    const jobId =
      res.job_id || res.jobId || res.id ||
      res.data?.job_id || res.data?.jobId ||
      res.job?.job_id || res.job?.id;

    if(!jobId) throw new Error("job_id d√∂nmedi");

    activeJobId = String(jobId);
    $("jobIdTxt").textContent = activeJobId;

    // start polling
    stopPolling();
    pollTimer = setInterval(pollJob, 2500);
    // immediate poll
    setTimeout(pollJob, 600);

  }catch(e){
    stopPolling();
    showSearch(false);
    toast("Backend hatasƒ±: " + (e.message || "Bilinmeyen"));
  }
};

/* =========================
   INITIAL: try geolocate
   ========================= */
(function init(){
  // default service
  setService("taxi");

  // attempt geolocation to center map (silent)
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition((pos)=>{
      const {latitude, longitude} = pos.coords;
      map.setView([latitude, longitude], 15, {animate:true});
    }, ()=>{}, { enableHighAccuracy:true, timeout:4500 });
  }

  // Keep CTA disabled until ready
  enableCTAIfReady();
})();
</script>
</body>
</html>
