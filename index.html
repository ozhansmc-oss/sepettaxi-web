<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
<style>
    #map{
  pointer-events: auto !important;
  z-index: 1;
  *{box-sizing:border-box}
  :root{
    --y:#f5c400;
    --bg:#050506;
    --panel:#0f0f10;
    --card:#141416;
    --line:rgba(255,255,255,.10);
    --mut:rgba(255,255,255,.65);
    --mut2:rgba(255,255,255,.42);
    --good:#31d07b;
    --bad:#ff3b3b;
    --r:16px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#000;color:#fff;overflow:hidden}
  #landing{
    position:fixed;inset:0;z-index:2000;
    background:#000 url("assets/landing.png") center/cover no-repeat;
    display:flex;align-items:flex-end;justify-content:center;
    padding:28px;
  }
  #landing .btn{
    width:min(520px,92vw);height:56px;border-radius:999px;
    background:linear-gradient(180deg,#ffd84a,#f5c400);
    color:#0b0b0b;font-weight:900;font-size:20px;
    border:none;cursor:pointer;
    box-shadow:0 18px 60px rgba(245,196,0,.25);
  }

  /* TOPBAR */
  #topbar{
    position:fixed;left:0;right:0;top:0;height:62px;z-index:900;
    display:flex;align-items:center;justify-content:space-between;
    padding:0 14px;
    background:linear-gradient(180deg,rgba(0,0,0,.92),rgba(0,0,0,.55));
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .burger, .bell{
    width:44px;height:44px;border-radius:12px;
    display:grid;place-items:center;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    cursor:pointer;
  }
  .brand{
    display:flex;align-items:center;gap:10px;
    font-weight:900;letter-spacing:.2px;
    user-select:none;
  }
  .brand span{font-size:24px}
  .brand .y{color:var(--y)}
  .icon{width:22px;height:22px;opacity:.92}

  /* LAYOUT */
  #wrap{position:fixed;inset:0}
  #map{position:absolute;left:0;right:0;top:62px;height:calc(50vh - 31px);z-index:1}
  #panel{
    position:absolute;left:0;right:0;top:calc(50vh + 31px);bottom:0;z-index:2;
    background:linear-gradient(180deg,rgba(7,7,8,.82),rgba(7,7,8,.98));
    border-top:1px solid rgba(255,255,255,.08);
    padding:12px 14px 16px;
  }
  .handle{width:42px;height:5px;border-radius:999px;background:rgba(255,255,255,.18);margin:4px auto 10px}
  .row{display:flex;gap:10px}
  .card{
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    border-radius:18px;
    padding:12px;
    box-shadow:0 12px 40px rgba(0,0,0,.35);
  }
  .service{
    flex:1;display:flex;align-items:center;gap:12px;
    padding:14px;border-radius:18px;cursor:pointer;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    transition:.15s;
  }
  .service.active{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.08)}
  .svcIcon{
    width:44px;height:44px;border-radius:14px;
    display:grid;place-items:center;
    background:rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.10);
  }
  .svcTitle{font-weight:900;font-size:20px;line-height:1}
  .svcSub{font-size:13px;color:var(--mut);margin-top:4px}
  .field{
    display:flex;align-items:center;gap:10px;
    padding:12px 12px;
    border-radius:16px;
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.10);
    margin-top:10px;
  }
  .field .mini{opacity:.9}
  .field input{
    width:100%;
    background:transparent;border:none;outline:none;
    color:#fff;font-size:16px;
  }
  .field input::placeholder{color:rgba(255,255,255,.45)}
  .hint{margin:10px 2px 0;color:var(--mut2);font-size:12.5px}
  .metrics{display:flex;gap:10px;margin-top:10px}
  .metric{flex:1;padding:12px;border-radius:16px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.10)}
  .metric .k{color:var(--mut2);font-size:12.5px}
  .metric .v{font-size:22px;font-weight:900;margin-top:2px}
  .cta{
    width:100%;height:58px;margin-top:12px;
    border:none;border-radius:999px;
    background:linear-gradient(180deg,#ffd84a,#f5c400);
    color:#0b0b0b;font-weight:900;font-size:22px;
    cursor:pointer;opacity:.45;pointer-events:none;
    box-shadow:0 18px 60px rgba(245,196,0,.25);
  }
  .cta.on{opacity:1;pointer-events:auto}
  .smallRow{display:flex;gap:10px;margin-top:10px}
  .btnGhost{
    flex:1;height:44px;border-radius:14px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.10);
    color:#fff;font-weight:700;cursor:pointer;
  }

  /* Map buttons (right) */
  .mapBtns{position:absolute;right:14px;top:86px;z-index:800;display:flex;flex-direction:column;gap:10px}
  .mapBtn{
    width:46px;height:46px;border-radius:14px;
    background:rgba(0,0,0,.55);
    border:1px solid rgba(255,255,255,.16);
    backdrop-filter: blur(8px);
    display:grid;place-items:center;cursor:pointer;
  }

  /* Drawer menu */
  #drawerBack{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:1200;display:none}
  #drawer{
    position:fixed;left:12px;top:74px;width:min(340px,88vw);
    background:rgba(10,10,10,.92);border:1px solid rgba(255,255,255,.10);
    border-radius:18px;z-index:1300;display:none;
    box-shadow:0 30px 90px rgba(0,0,0,.55);
    overflow:hidden;
  }
  #drawer .item{padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer}
  #drawer .item:last-child{border-bottom:none}
  #drawer .item .t{font-weight:800}
  #drawer .item .s{font-size:12.5px;color:var(--mut2);margin-top:4px}

  /* Modal */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.68);z-index:1600;display:none;align-items:center;justify-content:center;padding:18px}
  .modal{
    width:min(520px,92vw);
    background:rgba(14,14,15,.96);
    border:1px solid rgba(255,255,255,.12);
    border-radius:22px;
    box-shadow:0 30px 100px rgba(0,0,0,.65);
    padding:16px;
  }
  .modal h3{margin:6px 4px 10px;font-size:18px}
  .modal p{margin:0 4px 12px;color:var(--mut);font-size:13.5px;line-height:1.35}
  .modal .row{gap:8px}
  .modal input{
    width:100%;height:48px;border-radius:14px;
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
    color:#fff;padding:0 12px;font-size:15px;outline:none;
  }
  .modal .ok{
    width:100%;height:52px;border-radius:999px;border:none;
    background:linear-gradient(180deg,#ffd84a,#f5c400);
    color:#0b0b0b;font-weight:900;font-size:18px;cursor:pointer;margin-top:10px;
  }
  .modal .x{float:right;width:42px;height:42px;border-radius:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);color:#fff;cursor:pointer}

  /* Courier fields */
  #courierBox{display:none;margin-top:10px}
  .chk{display:flex;gap:10px;align-items:flex-start;margin-top:10px}
  .chk input{margin-top:3px;transform:scale(1.1)}
  .chk label{font-size:12.5px;color:var(--mut);line-height:1.35}

  /* Searching overlay */
  #searchBack{
    position:fixed;inset:0;z-index:1800;display:none;
    background:rgba(0,0,0,.65);
    backdrop-filter: blur(10px);
  }
  #searchCard{
    position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    width:min(520px,92vw);
    background:rgba(14,14,16,.92);
    border:1px solid rgba(255,255,255,.12);
    border-radius:22px;
    padding:18px;
    box-shadow:0 30px 100px rgba(0,0,0,.6);
    text-align:center;
  }
  .badge{
    display:inline-flex;align-items:center;gap:10px;
    padding:10px 14px;border-radius:999px;
    background:rgba(245,196,0,.10);
    border:1px solid rgba(245,196,0,.35);
    color:#ffe08b;font-weight:900;
  }
  .pulse{
    width:10px;height:10px;border-radius:50%;
    background:var(--y);
    box-shadow:0 0 0 0 rgba(245,196,0,.45);
    animation:pulse 1.4s infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(245,196,0,.45)}
    70%{box-shadow:0 0 0 18px rgba(245,196,0,0)}
    100%{box-shadow:0 0 0 0 rgba(245,196,0,0)}
  }
  #searchCard .t1{font-size:20px;font-weight:900;margin-top:12px}
  #searchCard .t2{font-size:13.5px;color:var(--mut);margin-top:6px;line-height:1.35}
  .driver-float{
  width:34px;
  height:34px;
  border-radius:14px;
  background:rgba(0,0,0,.55);
  border:1px solid rgba(255,255,255,.20);
  display:grid;
  place-items:center;
  box-shadow:0 18px 40px rgba(0,0,0,.45);
  animation: floaty 2.6s ease-in-out infinite;
}

@keyframes floaty{
  0%,100%{transform:translateY(0)}
  50%{transform:translateY(-3px)}
}
  
</style>
</head>

<body>
  <!-- Landing -->
  <div id="landing">
    <button class="btn" id="startBtn">Ba≈üla</button>
  </div>

  <!-- Topbar -->
  <div id="topbar">
    <div class="burger" id="burgerBtn" title="Men√º">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
    </div>
    <div class="brand"><span>Sepet</span><span class="y">Taxi</span></div>
    <div class="bell" id="bellBtn" title="Bildirim">
      <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 22a2.2 2.2 0 0 0 2.2-2.2H9.8A2.2 2.2 0 0 0 12 22Zm7-6V11a7 7 0 1 0-14 0v5l-2 2v1h18v-1l-2-2Z" stroke="white" stroke-width="1.7" stroke-linejoin="round"/></svg>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawerBack"></div>
  <div id="drawer">
    <div class="item" onclick="go('driver-apply.html')">
      <div class="t">S√ºr√ºc√º Ol</div>
      <div class="s">Ba≈üvuru formu</div>
    </div>
    <div class="item" onclick="go('driver.html')">
      <div class="t">S√ºr√ºc√º Giri≈üi</div>
      <div class="s">ƒ∞≈ü havuzu ve aktif i≈üler</div>
    </div>
    <div class="item" onclick="go('legal/hakkimizda.htm')">
      <div class="t">Hakkƒ±mƒ±zda</div>
      <div class="s">≈ûirket ve hizmet bilgisi</div>
    </div>
    <div class="item" onclick="go('legal/kvkk.html')">
      <div class="t">KVKK</div>
      <div class="s">Aydƒ±nlatma metni</div>
    </div>
    <div class="item" onclick="go('legal/musteri-sozlesmesi.html')">
      <div class="t">M√º≈üteri S√∂zle≈ümesi</div>
      <div class="s">Hizmet ko≈üullarƒ±</div>
    </div>
  </div>

  <div id="wrap">
    <div id="map"></div>
    <div class="mapBtns">
      <div class="mapBtn" id="locBtn" title="Konumuma git">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 2v3m0 14v3M2 12h3m14 0h3" stroke="white" stroke-width="2" stroke-linecap="round"/><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8Z" stroke="white" stroke-width="2"/></svg>
      </div>
      <div class="mapBtn" id="pickBtn" title="Nereden se√ß">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 21s7-4.4 7-11a7 7 0 1 0-14 0c0 6.6 7 11 7 11Z" stroke="white" stroke-width="1.8"/><path d="M12 10.2a2 2 0 1 0 0 4 2 2 0 0 0 0-4Z" fill="white"/></svg>
      </div>
      <div class="mapBtn" id="dropBtn" title="Nereye se√ß">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M7 7h10M9 3h6M6 21h12" stroke="white" stroke-width="1.8" stroke-linecap="round"/><path d="M9 7l3 11 3-11" stroke="white" stroke-width="1.8" stroke-linecap="round"/></svg>
      </div>
    </div>

    <div id="panel">
      <div class="handle"></div>

      <div class="row">
        <div class="service" id="svcTaxi">
          <div class="svcIcon">üöï</div>
          <div>
            <div class="svcTitle">Taksi</div>
            <div class="svcSub">Hƒ±zlƒ± ve g√ºvenilir ula≈üƒ±m</div>
          </div>
        </div>
        <div class="service" id="svcCourier">
          <div class="svcIcon">üèçÔ∏è</div>
          <div>
            <div class="svcTitle">Kurye</div>
            <div class="svcSub">Hƒ±zlƒ± kurye teslimatƒ±</div>
          </div>
        </div>
      </div>

      <div class="field">
        <div class="mini">üìç</div>
        <input id="fromInput" placeholder="Nereden (haritadan se√ßin)" readonly />
      </div>

      <div class="field">
        <div class="mini">üéØ</div>
        <input id="toInput" placeholder="Nereye (haritadan se√ßin)" readonly />
      </div>

      <div id="courierBox" class="card">
        <div style="font-weight:900;margin-bottom:8px">Kurye Detaylarƒ±</div>

        <div class="field" style="margin-top:0">
          <div class="mini">üì¶</div>
          <input id="pkgType" placeholder="G√∂nderi t√ºr√º (Evrak / Paket / Kƒ±rƒ±labilir...)" />
        </div>

        <div class="field">
          <div class="mini">üìù</div>
          <input id="pkgContent" placeholder="ƒ∞√ßerik a√ßƒ±klamasƒ± (zorunlu)" />
        </div>

        <div class="field">
          <div class="mini">üë§</div>
          <input id="recvName" placeholder="Alƒ±cƒ± adƒ± soyadƒ± (zorunlu)" />
        </div>

        <div class="field">
          <div class="mini">üìû</div>
          <input id="recvPhone" placeholder="Alƒ±cƒ± telefonu (zorunlu)" inputmode="tel" />
        </div>

        <div class="field">
          <div class="mini">üí¨</div>
          <input id="deliveryNote" placeholder="Teslimat notu (opsiyonel)" />
        </div>

        <div class="chk">
          <input type="checkbox" id="declAccept" />
          <label for="declAccept">
            <b>G√∂nderi i√ßeriƒüi taahh√ºd√º:</b> G√∂nderimin yasal olduƒüunu, tehlikeli/yasaklƒ± √ºr√ºn i√ßermediƒüini ve t√ºm hukuki sorumluluƒüun bana ait olduƒüunu kabul ederim.
          </label>
        </div>
      </div>

      <div class="metrics">
        <div class="metric">
          <div class="k">Mesafe</div>
          <div class="v" id="kmText">‚Äî</div>
        </div>
        <div class="metric">
          <div class="k">√úcret</div>
          <div class="v" id="priceText">‚Äî</div>
        </div>
      </div>

      <button class="cta" id="callBtn">√áaƒüƒ±r</button>

      <div class="smallRow">
        <button class="btnGhost" id="helpBtn">WhatsApp</button>
        <button class="btnGhost" id="mailBtn">E-posta</button>
      </div>

      <div class="hint" id="statusHint">Konum alƒ±nƒ±yor‚Ä¶</div>
    </div>
  </div>

  <!-- Register Modal (Service select tetikler) -->
  <div class="modalBack" id="regBack">
    <div class="modal">
      <button class="x" id="regClose">‚úï</button>
      <h3>Zorunlu Kayƒ±t</h3>
      <p>Devam etmek i√ßin ad-soyad ve telefon numaranƒ±zƒ± doƒürulayƒ±n.</p>

      <div class="row">
        <input id="rFirst" placeholder="Ad" />
        <input id="rLast" placeholder="Soyad" />
      </div>
      <div style="height:8px"></div>
      <input id="rPhone" placeholder="Telefon (05xx‚Ä¶)" inputmode="tel" />

      <button class="ok" id="regOk">Devam Et</button>
    </div>
  </div>

  <!-- Searching overlay -->
  <div id="searchBack">
    <div id="searchCard">
      <div class="badge"><span class="pulse"></span> S√ºr√ºc√º aranƒ±yor</div>
      <div class="t1">En yakƒ±n s√ºr√ºc√ºye baƒülanƒ±yoruz</div>
      <div class="t2">Konum ve uygunluk durumuna g√∂re en hƒ±zlƒ± e≈üle≈üme yapƒ±lƒ±r.</div>
      <div class="t2" id="searchMsg" style="margin-top:10px;color:rgba(255,255,255,.75)">L√ºtfen bekleyin‚Ä¶</div>
    </div>
  </div>

<script>
/* ========= CONFIG ========= */
const API = "PASTE_YOUR_GAS_WEBAPP_URL_HERE"; // √ñNEMLƒ∞: GAS Web App URL buraya
const RADIUS_KM = 5;

/* ========= STATE ========= */
let map, pickupMarker=null, dropMarker=null;
let pickup=null, drop=null; // {lat,lng,address}
let selecting = "pickup"; // pickup/drop
let serviceType = ""; // taxi/courier
let customer = loadCustomer(); // {customer_id, first,last,phone}
let driverMarkers = new Map();
let myLatLng = null;
let jobPollTimer = null;

/* ========= INIT ========= */
document.getElementById("startBtn").onclick = () => {
  document.getElementById("landing").style.display = "none";
  initMap();
  initUI();
  ensureLocation();
};

function initUI(){
  const burgerBtn = document.getElementById("burgerBtn");
  const drawer = document.getElementById("drawer");
  const drawerBack = document.getElementById("drawerBack");
  burgerBtn.onclick = () => { drawer.style.display="block"; drawerBack.style.display="block"; };
  drawerBack.onclick = () => { drawer.style.display="none"; drawerBack.style.display="none"; };

  document.getElementById("svcTaxi").onclick = () => selectService("taxi");
  document.getElementById("svcCourier").onclick = () => selectService("courier");

  document.getElementById("pickBtn").onclick = () => { selecting="pickup"; flashHint("Haritadan NEREDEN se√ßin"); };
  document.getElementById("dropBtn").onclick = () => { selecting="drop"; flashHint("Haritadan NEREYE se√ßin"); };
  document.getElementById("locBtn").onclick = () => { if(myLatLng) map.setView(myLatLng, 16); };

  document.getElementById("callBtn").onclick = callNow;

  // register modal
  document.getElementById("regClose").onclick = () => hideReg();
  document.getElementById("regOk").onclick = doRegister;

  // support buttons
  document.getElementById("helpBtn").onclick = () => window.open("https://wa.me/90XXXXXXXXXX","_blank"); // deƒüi≈ütir
  document.getElementById("mailBtn").onclick = () => window.location.href = "mailto:info@sepettaxi.com"; // deƒüi≈ütir
}

function initMap(){
  map = L.map("map", { zoomControl:false, attributionControl:false });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
  map.setView([41.015, 28.979], 13);

  map.on("click", async (e) => {
    if (!serviceType){
      flashHint("√ñnce Taksi veya Kurye se√ßin");
      return;
    }
    if (!customer){
      showReg(); // hizmet se√ßimi kayƒ±t tetikler; map click olursa da tetikle
      
    }
    const {lat,lng} = e.latlng;
    const addr = await reverseGeocode(lat,lng);
    if (selecting === "pickup"){
      pickup = {lat,lng,address:addr};
      if (pickupMarker) map.removeLayer(pickupMarker);
      pickupMarker = L.marker([lat,lng], {icon: pinIcon("pickup")}).addTo(map);
      document.getElementById("fromInput").value = addr;
      selecting = "drop";
      flashHint("≈ûimdi NEREYE se√ßin");
    } else {
      drop = {lat,lng,address:addr};
      if (dropMarker) map.removeLayer(dropMarker);
      dropMarker = L.marker([lat,lng], {icon: pinIcon("drop")}).addTo(map);
      document.getElementById("toInput").value = addr;
      selecting = "pickup";
      await recalc();
    }
  });
}

async function ensureLocation(){
  try{
    flashHint("Konum alƒ±nƒ±yor‚Ä¶");
    navigator.geolocation.getCurrentPosition(async (pos)=>{
      myLatLng = [pos.coords.latitude, pos.coords.longitude];
      map.setView(myLatLng, 16);

      // set pickup auto if not chosen
      if (!pickup){
        const addr = await reverseGeocode(myLatLng[0], myLatLng[1]);
        pickup = {lat: myLatLng[0], lng: myLatLng[1], address: addr};
        pickupMarker = L.marker(myLatLng, {icon: pinIcon("pickup")}).addTo(map);
        document.getElementById("fromInput").value = addr;
      }
      flashHint("Haritadan nereye gideceƒüinizi se√ßin");
      // start driver pool poll once service selected & registered
      setInterval(()=> refreshNearbyDrivers(), 4500);
    }, ()=> {
      flashHint("Konum izni gerekli. Tarayƒ±cƒ±dan izin verin.");
    }, { enableHighAccuracy:true, timeout:12000 });
  }catch(_){
    flashHint("Konum alƒ±namadƒ±");
  }
}

function selectService(type){
  serviceType = type;
  document.getElementById("svcTaxi").classList.toggle("active", type==="taxi");
  document.getElementById("svcCourier").classList.toggle("active", type==="courier");

  document.getElementById("courierBox").style.display = (type==="courier") ? "block" : "none";
  document.getElementById("callBtn").textContent = (type==="courier") ? "Kurye √áaƒüƒ±r" : "Taksi √áaƒüƒ±r";

  // Zorunlu kayƒ±t hizmet se√ßimi ile tetiklenir
  if (!customer) showReg();

  refreshNearbyDrivers();
  recalc();
}

async function recalc(){
  if (!pickup || !drop){
    setMetric("kmText","‚Äî");
    setMetric("priceText","‚Äî");
    updateCTA(false);
    return;
  }

  const km = haversineKm(pickup.lat,pickup.lng,drop.lat,drop.lng);
  const price = calcPrice(serviceType, km);

  animateNumber("kmText", km, " km", 1);
  animateNumber("priceText", price, " TL", 0);

  // courier required check
  const ok = validateReadyForCall();
  updateCTA(ok);
}

function validateReadyForCall(){
  if (!serviceType || !pickup || !drop || !customer) return false;
  if (serviceType === "courier"){
    const pkgType = document.getElementById("pkgType").value.trim();
    const pkgContent = document.getElementById("pkgContent").value.trim();
    const recvName = document.getElementById("recvName").value.trim();
    const recvPhone = document.getElementById("recvPhone").value.trim();
    const accept = document.getElementById("declAccept").checked;
    if (!pkgType || !pkgContent || !recvName || !recvPhone || !accept) return false;
  }
  return true;
}

function updateCTA(on){
  const b = document.getElementById("callBtn");
  b.classList.toggle("on", !!on);
}

async function callNow(){
  if (!customer){
    showReg();
    return;
  }
  if (!validateReadyForCall()){
    flashHint(serviceType==="courier"
      ? "Kurye i√ßin t√ºm alanlarƒ± doldurun ve taahh√ºd√º onaylayƒ±n."
      : "Nereden ve Nereye se√ßin.");
    return;
  }

  const km = haversineKm(pickup.lat,pickup.lng,drop.lat,drop.lng);
  const price = calcPrice(serviceType, km);

  const payload = {
    action:"createJob",
    service_type: serviceType,
    customer_id: customer.customer_id,
    customer_first: customer.first,
    customer_last: customer.last,
    customer_phone: customer.phone,
    from_address: pickup.address,
    to_address: drop.address,
    pickup_lat: pickup.lat,
    pickup_lng: pickup.lng,
    dropoff_lat: drop.lat,
    dropoff_lng: drop.lng,
    distance_km: round(km,1),
    price: Math.round(price),
  };

  if (serviceType==="courier"){
    payload.package_type = document.getElementById("pkgType").value.trim();
    payload.package_content_text = document.getElementById("pkgContent").value.trim();
    payload.content_declaration_accept = true;
    payload.receiver_name = document.getElementById("recvName").value.trim();
    payload.receiver_phone = document.getElementById("recvPhone").value.trim();
    payload.delivery_note = document.getElementById("deliveryNote").value.trim();
  }

  showSearching("ƒ∞≈ü olu≈üturuluyor‚Ä¶");
  const res = await postJSON(payload);
  if (!res.ok){
    hideSearching();
    flashHint("Hata: " + (res.error || "createJob ba≈üarƒ±sƒ±z"));
    return;
  }

  const jobId = res.job_id;
  showSearching("S√ºr√ºc√º aranƒ±yor‚Ä¶");
  pollJob(jobId);
}

function pollJob(jobId){
  if (jobPollTimer) clearInterval(jobPollTimer);
  jobPollTimer = setInterval(async ()=>{
    const st = await getJSON({action:"getJobStatus", job_id: jobId});
    if (!st.ok) return;
    if (st.status === "assigned" && st.driver_id){
      clearInterval(jobPollTimer);
      window.location.href = "track.html?job_id=" + encodeURIComponent(jobId);
    }
  }, 2000);
}

async function refreshNearbyDrivers(){
  if (!myLatLng) return;
  if (!serviceType) return;
  if (!customer) return; // kayƒ±t olmadan g√∂stermeyelim

  const res = await getJSON({action:"getNearbyDrivers", lat: myLatLng[0], lng: myLatLng[1], radius_km: RADIUS_KM});
  if (!res.ok) return;

  // update markers
  const seen = new Set();
  for (const d of (res.drivers||[])){
    seen.add(d.driver_id);
    const key = d.driver_id;
    const icon = driverIcon(serviceType); // m√º≈üteri se√ßimine g√∂re: taksi/motor hissi
    if (!driverMarkers.has(key)){
      const m = L.marker([d.lat,d.lng], {icon}).addTo(map);
      driverMarkers.set(key, m);
    }else{
      const m = driverMarkers.get(key);
      smoothMoveMarker(m, [d.lat,d.lng]);
      m.setIcon(icon);
    }
  }
  // remove stale markers
  for (const [id,m] of driverMarkers.entries()){
    if (!seen.has(id)){
      map.removeLayer(m);
      driverMarkers.delete(id);
    }
  }
}

/* ========= REGISTER ========= */
function showReg(){
  document.getElementById("regBack").style.display = "flex";
  if (customer){
    document.getElementById("rFirst").value = customer.first||"";
    document.getElementById("rLast").value = customer.last||"";
    document.getElementById("rPhone").value = customer.phone||"";
  }
}
function hideReg(){
  document.getElementById("regBack").style.display = "none";
}
async function doRegister(){
  const first = document.getElementById("rFirst").value.trim();
  const last  = document.getElementById("rLast").value.trim();
  const phone = document.getElementById("rPhone").value.trim();
  if (!first || !last || !phone){
    flashHint("Kayƒ±t i√ßin ad, soyad ve telefon gerekli.");
    return;
  }
  const res = await postJSON({action:"registerCustomer", first,last,phone});
  if (!res.ok){
    flashHint("Kayƒ±t hatasƒ±: " + (res.error||""));
    return;
  }
  customer = { customer_id: res.customer_id, first: res.first, last: res.last, phone: res.phone };
  localStorage.setItem("sepettaxi_customer", JSON.stringify(customer));
  hideReg();
  flashHint("Kayƒ±t tamamlandƒ±. Adres se√ßebilirsiniz.");
  recalc();
  refreshNearbyDrivers();
  // üîë kayƒ±t sonrasƒ± akƒ±≈üƒ± kaldƒ±ƒüƒ± yerden devam ettir
if (pickup && !drop){
  flashHint("≈ûimdi NEREYE se√ßin");
}
if (!pickup){
  flashHint("Haritadan NEREDEN se√ßin");
}
function loadCustomer(){
  try{
    const s = localStorage.getItem("sepettaxi_customer");
    return s ? JSON.parse(s) : null;
  }catch(_){ return null; }
}

/* ========= HELPERS ========= */
function go(url){ window.location.href = url; }
function flashHint(t){
  document.getElementById("statusHint").textContent = t;
}
function setMetric(id, text){ document.getElementById(id).textContent = text; }
function round(n, d){ const p=Math.pow(10,d); return Math.round(n*p)/p; }

function calcPrice(type, km){
  // Basit, stabil; sonra backend tarafƒ±na da ta≈üƒ±nabilir
  const baseTaxi = 60, perKmTaxi = 13;
  const baseCourier = 75, perKmCourier = 14;
  if (type==="courier") return baseCourier + km*perKmCourier;
  return baseTaxi + km*perKmTaxi;
}

async function reverseGeocode(lat,lng){
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`;
    const r = await fetch(url, { headers: { "Accept":"application/json" }});
    const j = await r.json();
    return (j && j.display_name) ? j.display_name : `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  }catch(_){
    return `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  }
}

function pinIcon(kind){
  const color = (kind==="pickup") ? "#f5c400" : "#31d07b";
  const html = `
    <div style="
      width:18px;height:18px;border-radius:50%;
      background:${color};
      border:2px solid rgba(0,0,0,.6);
      box-shadow:0 10px 24px rgba(0,0,0,.45);
    "></div>`;
  return L.divIcon({html, className:"", iconSize:[18,18], iconAnchor:[9,9]});
}

function driverIcon(mode){
  const sym = (mode==="courier") ? "üèçÔ∏è" : "üöï";
  const html = `
    <div class="driver-float">${sym}</div>
  `;
  return L.divIcon({
    html,
    className:"",
    iconSize:[34,34],
    iconAnchor:[17,17]
  });
}

function smoothMoveMarker(marker, latlng){
  // √ßok basit interpolasyon
  const start = marker.getLatLng();
  const end = L.latLng(latlng[0], latlng[1]);
  const steps = 12;
  let i=0;
  const t = setInterval(()=>{
    i++;
    const k = i/steps;
    const lat = start.lat + (end.lat-start.lat)*k;
    const lng = start.lng + (end.lng-start.lng)*k;
    marker.setLatLng([lat,lng]);
    if (i>=steps) clearInterval(t);
  }, 35);
}

function haversineKm(lat1,lng1,lat2,lng2){
  const R = 6371;
  const toRad = d => d*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a =
    Math.sin(dLat/2)*Math.sin(dLat/2) +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
    Math.sin(dLng/2)*Math.sin(dLng/2);
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function animateNumber(elId, value, suffix, decimals){
  const el = document.getElementById(elId);
  const startText = el.textContent.replace(/[^\d.,]/g,"");
  const start = Number(startText.replace(",",".")) || 0;
  const end = Number(value);
  const dur = 520;
  const t0 = performance.now();

  function step(t){
    const k = Math.min(1,(t-t0)/dur);
    const v = start + (end-start)*easeOut(k);
    el.textContent = v.toFixed(decimals) + suffix;
    if (k<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
function easeOut(t){ return 1 - Math.pow(1-t,3); }

function showSearching(msg){
  document.getElementById("searchMsg").textContent = msg || "L√ºtfen bekleyin‚Ä¶";
  document.getElementById("searchBack").style.display = "block";
}
function hideSearching(){
  document.getElementById("searchBack").style.display = "none";
}

/* ========= API ========= */
function buildQS(obj){
  const u = new URLSearchParams();
  Object.keys(obj).forEach(k => u.set(k, obj[k]));
  return u.toString();
}
async function getJSON(params){
  if (!API || API.includes("PASTE_")) return {ok:false, error:"API URL missing"};
  const url = API + "?" + buildQS(params);
  const r = await fetch(url, { method:"GET" });
  return await r.json();
}
async function postJSON(body){
  if (!API || API.includes("PASTE_")) return {ok:false, error:"API URL missing"};
  const r = await fetch(API, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  return await r.json();
}
</script>
</body>
</html>
