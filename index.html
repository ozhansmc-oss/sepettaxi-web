<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>SepetTaxi</title>
  <meta name="theme-color" content="#f5c400" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#050506;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{overflow:hidden}

    :root{
      --y:#f5c400;
      --bg:#050506;
      --panel:#0f0f10;
      --card:#141416;
      --line:rgba(255,255,255,.10);
      --mut:rgba(255,255,255,.68);
      --mut2:rgba(255,255,255,.42);
      --good:#2bd576;
      --bad:#ff4d4f;
      --shadow:0 14px 40px rgba(0,0,0,.55);
      --r:18px;
    }

    /* ====== LAYOUT ====== */
    .app{
      position:fixed; inset:0;
      display:flex; flex-direction:column;
      background:radial-gradient(1200px 700px at 50% 0%, rgba(245,196,0,.12), transparent 60%),
                 linear-gradient(180deg, rgba(255,255,255,.02), transparent 30%);
    }

    /* topbar */
    .topbar{
      height:56px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(20,20,22,.78), rgba(10,10,12,.35));
      backdrop-filter: blur(10px);
      z-index:30;
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--y);box-shadow:0 0 0 3px rgba(245,196,0,.18)}
    .brand span b{color:var(--y)}
    .iconbtn{
      width:40px;height:40px;border-radius:12px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(20,20,22,.65);
      color:#fff; cursor:pointer;
    }
    .hamburger{
      width:18px;height:12px;position:relative;
    }
    .hamburger:before,.hamburger:after,.hamburger i{
      content:""; position:absolute; left:0; right:0; height:2px; border-radius:2px; background:#fff;
    }
    .hamburger:before{top:0}
    .hamburger i{top:5px;opacity:.85}
    .hamburger:after{bottom:0;opacity:.75}

    /* map + sheet */
    .main{
      flex:1;
      display:flex; flex-direction:column;
      min-height:0;
    }
    #map{
      height:50vh;
      min-height:240px;
      background:#0b0b0c;
      position:relative;
      z-index:1;
    }

    .sheet{
      height:calc(50vh - 56px);
      min-height:260px;
      padding:12px 12px 14px;
      background:linear-gradient(180deg, rgba(15,15,16,.94), rgba(10,10,12,.98));
      border-top:1px solid var(--line);
      z-index:10;
    }

    .card{
      height:100%;
      background:radial-gradient(900px 500px at 50% 0%, rgba(245,196,0,.10), transparent 55%),
                 rgba(20,20,22,.78);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      padding:12px;
      display:flex; flex-direction:column;
      gap:10px;
      overflow:hidden;
    }

    .row{display:flex;gap:10px;align-items:center}
    .seg{
      display:flex;
      gap:10px;
      width:100%;
    }
    .seg button{
      flex:1;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .seg button.active{
      border-color: rgba(245,196,0,.55);
      background: linear-gradient(180deg, rgba(245,196,0,.22), rgba(245,196,0,.10));
      box-shadow: 0 10px 30px rgba(245,196,0,.08);
    }

    .field{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      padding:10px 10px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .field .meta{min-width:0}
    .label{font-size:12px;color:var(--mut2);margin-bottom:4px}
    .value{
      font-size:14px;
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pickbtn{
      height:34px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      flex:0 0 auto;
    }
    .pickbtn.on{
      border-color: rgba(245,196,0,.55);
      background: rgba(245,196,0,.16);
    }

    .hint{
      font-size:12px;
      color:var(--mut);
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      display:inline-flex;
      align-self:flex-start;
      gap:8px;
      align-items:center;
    }
    .pulse{
      width:10px;height:10px;border-radius:50%;
      background:rgba(245,196,0,.35);
      position:relative;
    }
    .pulse:after{
      content:""; position:absolute; inset:-6px;
      border-radius:50%;
      border:1px solid rgba(245,196,0,.35);
      animation:p 1.4s infinite ease-out;
    }
    @keyframes p{
      0%{transform:scale(.65);opacity:.0}
      20%{opacity:.6}
      100%{transform:scale(1.35);opacity:0}
    }

    .metrics{
      display:none; /* kayıt öncesi gizli */
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(245,196,0,.22);
      background:rgba(245,196,0,.10);
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .metrics .m{
      min-width:0;
      display:flex;flex-direction:column;gap:4px;
    }
    .metrics .m .k{font-size:12px;color:rgba(255,255,255,.70)}
    .metrics .m .v{font-size:16px;font-weight:950;color:#fff;letter-spacing:.2px}

    .cta{
      height:48px;
      border-radius:16px;
      border:1px solid rgba(245,196,0,.22);
      background:rgba(245,196,0,.16);
      color:#111;
      font-weight:950;
      cursor:not-allowed;
      opacity:.45;
    }
    .cta.on{
      cursor:pointer;
      opacity:1;
      background:linear-gradient(180deg, rgba(245,196,0,.95), rgba(245,196,0,.72));
      box-shadow:0 14px 40px rgba(245,196,0,.10);
    }

    /* overlays */
    .centerBadge{
      position:fixed;
      top:70px;
      left:50%;
      transform:translateX(-50%);
      z-index:40;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      display:flex; align-items:center; gap:10px;
      color:#fff;
      font-weight:850;
    }

    /* premium searching */
    .searching{
      position:fixed; inset:0;
      display:none;
      z-index:6000;
      background:rgba(0,0,0,.62);
      backdrop-filter: blur(18px);
      align-items:center; justify-content:center;
    }
    .searching .box{
      width:min(360px, 90vw);
      border-radius:24px;
      border:1px solid rgba(255,255,255,.12);
      background:radial-gradient(800px 500px at 50% 0%, rgba(245,196,0,.16), transparent 55%),
                 rgba(15,15,16,.85);
      box-shadow:0 20px 70px rgba(0,0,0,.65);
      padding:18px;
    }
    .searching .ttl{font-size:16px;font-weight:950;margin-bottom:6px}
    .searching .sub{font-size:13px;color:rgba(255,255,255,.72);margin-bottom:14px}
    .loader{
      height:10px;border-radius:999px; overflow:hidden;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
    }
    .loader > i{
      display:block;height:100%;
      width:40%;
      background:linear-gradient(90deg, rgba(245,196,0,.2), rgba(245,196,0,.95), rgba(245,196,0,.2));
      animation:move 1.1s infinite ease-in-out;
    }
    @keyframes move{
      0%{transform:translateX(-60%)}
      100%{transform:translateX(260%)}
    }

    /* drawer */
    .drawerMask{
      position:fixed; inset:0;
      z-index:5000;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
    }
    .drawer{
      position:absolute;
      top:0; right:0;
      width:min(320px, 86vw);
      height:100%;
      background:rgba(15,15,16,.92);
      border-left:1px solid rgba(255,255,255,.10);
      padding:12px;
      transform:translateX(12px);
    }
    .drawer .title{font-weight:950;margin:8px 6px 10px}
    .drawer a,.drawer button{
      width:100%;
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:#fff;
      text-decoration:none;
      font-weight:800;
      cursor:pointer;
      margin-bottom:10px;
    }

    /* registration modal (FULL FIXED – phone safe) */
    .modalMask{
      position:fixed; inset:0;
      z-index:7000;
      display:none;
      background:rgba(0,0,0,.62);
      backdrop-filter: blur(10px);
      align-items:center; justify-content:center;
      padding:16px;
    }
    .modal{
      width:min(420px, 92vw);
      border-radius:24px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(15,15,16,.92);
      box-shadow:0 24px 90px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .modalHd{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:center; justify-content:space-between;
      background:radial-gradient(700px 400px at 50% 0%, rgba(245,196,0,.14), transparent 60%);
    }
    .modalHd .t{font-weight:950}
    .x{
      width:38px;height:38px;border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      color:#fff; cursor:pointer;
    }
    .modalBd{padding:14px 16px; display:flex; flex-direction:column; gap:10px}
    .in{
      height:46px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:#fff;
      padding:0 12px;
      outline:none;
      font-weight:800;
    }
    .modalBd small{color:rgba(255,255,255,.65);line-height:1.35}
    .modalBd .ok{
      height:46px;border-radius:14px;
      border:1px solid rgba(245,196,0,.25);
      background:linear-gradient(180deg, rgba(245,196,0,.95), rgba(245,196,0,.72));
      font-weight:950;color:#111; cursor:pointer;
    }

    /* Leaflet touch polish: hide zoom controls (as requested before) */
    .leaflet-control-zoom{display:none !important;}
    .leaflet-container{background:#0b0b0c}
  </style>
</head>

<body>
  <div class="app">

    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <span>Sepet<b>Taxi</b></span>
      </div>
      <button id="btnMenu" class="iconbtn" aria-label="Menü">
        <div class="hamburger"><i></i></div>
      </button>
    </div>

    <div class="main">
      <div id="map"></div>

      <div class="sheet">
        <div class="card">

          <div class="centerBadge" id="statusBadge">
            <span class="pulse"></span>
            <span id="statusText">Konum alınıyor…</span>
          </div>

          <div class="row" style="justify-content:space-between;align-items:flex-end">
            <div style="font-weight:950">Hizmet</div>
            <div style="font-size:12px;color:var(--mut2)">Haritadan adres seç</div>
          </div>

          <div class="seg">
            <button id="btnTaxi" class="active" type="button">Taksi</button>
            <button id="btnCourier" type="button">Kurye</button>
          </div>

          <div class="field">
            <div class="meta">
              <div class="label">Nereden</div>
              <div id="fromText" class="value">Konum alınıyor…</div>
              <div id="fromSub" class="label" style="margin-top:4px">Haritaya dokunarak seçebilirsin</div>
            </div>
            <button id="pickFrom" class="pickbtn" type="button">Seç</button>
          </div>

          <div class="field">
            <div class="meta">
              <div class="label">Nereye</div>
              <div id="toText" class="value">Haritadan seç</div>
              <div id="toSub" class="label" style="margin-top:4px">Haritaya dokun</div>
            </div>
            <button id="pickTo" class="pickbtn" type="button">Seç</button>
          </div>

          <div id="metrics" class="metrics">
            <div class="m">
              <div class="k">Mesafe</div>
              <div class="v" id="kmText">—</div>
            </div>
            <div class="m" style="text-align:right">
              <div class="k">Ücret</div>
              <div class="v" id="priceText">—</div>
            </div>
          </div>

          <button id="btnCall" class="cta" type="button">Çağır</button>

        </div>
      </div>
    </div>
  </div>

  <!-- Drawer -->
  <div id="drawerMask" class="drawerMask">
    <div class="drawer">
      <div class="title">Menü</div>
      <a href="driver.html">Sürücü girişi <span>›</span></a>
      <a href="admin.html">Admin <span>›</span></a>
      <a href="mailto:destek@sepettaxi.com">Destek E-posta <span>›</span></a>
      <a href="https://wa.me/" target="_blank" rel="noopener">Destek WhatsApp <span>›</span></a>
      <button id="btnCloseDrawer" type="button">Kapat <span>×</span></button>
    </div>
  </div>

  <!-- Registration Modal -->
  <div id="regMask" class="modalMask">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHd">
        <div class="t">Zorunlu Kayıt</div>
        <button id="regX" class="x" type="button">×</button>
      </div>
      <div class="modalBd">
        <small>Devam etmek için bilgilerini kaydetmemiz gerekiyor. Kayıt tamamlanınca bu ekran tamamen kaybolur.</small>
        <input id="inFirst" class="in" placeholder="Ad" autocomplete="given-name" />
        <input id="inLast" class="in" placeholder="Soyad" autocomplete="family-name" />
        <input id="inPhone" class="in" placeholder="Telefon (05xx...)" inputmode="tel" autocomplete="tel" />
        <button id="regOk" class="ok" type="button">Kaydı Tamamla</button>
      </div>
    </div>
  </div>

  <!-- Searching -->
  <div id="searching" class="searching">
    <div class="box">
      <div class="ttl">Sürücü aranıyor</div>
      <div class="sub">En yakın sürücüye yönlendiriyoruz. Lütfen bekleyin…</div>
      <div class="loader"><i></i></div>
    </div>
  </div>

  <script>
    // ===== BACKEND =====
    const API = "https://script.google.com/macros/s/AKfycbxHqb_E0gCqHmxWuzmdHqLb_IR7pHUGixIRd3Hh3MnVqegTPJEdJ4zM5Gb0Tc96Qb8C/exec";

    // ===== JSONP (CORS-FREE) =====
    function apiJSONP(params){
      return new Promise((resolve, reject)=>{
        const cb = "cb_" + Math.random().toString(16).slice(2);
        params.callback = cb;

        const u = new URLSearchParams(params);
        const s = document.createElement("script");

        window[cb] = (data)=>{
          try{ resolve(data); }
          finally{
            delete window[cb];
            s.remove();
          }
        };

        s.onerror = ()=>{
          delete window[cb];
          s.remove();
          reject(new Error("JSONP load failed"));
        };

        s.src = API + (API.includes("?") ? "&" : "?") + u.toString();
        document.head.appendChild(s);
      });
    }

    // ===== STATE =====
    const S = {
      service: "taxi",
      registered: false,
      customer: null,

      map: null,
      marker: null,

      mode: null, // "from" | "to" | null
      from: { lat:null, lng:null, addr:"" },
      to: { lat:null, lng:null, addr:"" },

      km: null,
      price: null
    };

    // ===== STORAGE =====
    function loadCustomer(){
      try{
        const s = localStorage.getItem("sepettaxi_customer");
        return s ? JSON.parse(s) : null;
      }catch(_){ return null; }
    }
    function saveCustomer(c){
      localStorage.setItem("sepettaxi_customer", JSON.stringify(c));
    }

    // ===== UI HELPERS =====
    function el(id){ return document.getElementById(id); }
    function setStatus(t){ el("statusText").textContent = t; }
    function showDrawer(on){
      el("drawerMask").style.display = on ? "block" : "none";
    }
    function showReg(on){
      el("regMask").style.display = on ? "flex" : "none";
      // modal açıkken scroll zaten kapalı; ama ekstra güvenlik:
      document.body.style.overflow = "hidden";
    }
    function hideRegPermanently(){
      el("regMask").style.display = "none"; // <- senin sorduğun: regWrap.style.display = "none" muadili burası
      document.body.style.overflow = "hidden";
    }
    function showSearching(on){
      el("searching").style.display = on ? "flex" : "none";
    }

    function setService(srv){
      S.service = srv;
      el("btnTaxi").classList.toggle("active", srv==="taxi");
      el("btnCourier").classList.toggle("active", srv==="courier");
      el("btnCall").textContent = (srv==="courier") ? "Kurye Çağır" : "Taksi Çağır";
      // hizmet seçimi anında zorunlu kayıt
      if(!S.registered){
        showReg(true);
      }
      refreshComputed();
    }

    function setPickMode(m){
      S.mode = m;
      el("pickFrom").classList.toggle("on", m==="from");
      el("pickTo").classList.toggle("on", m==="to");
      if(m==="from") setStatus("Nereden seçmek için haritaya dokun");
      else if(m==="to") setStatus("Nereye seçmek için haritaya dokun");
      else setStatus("Konum alındı. İstersen haritadan da seçebilirsin");
    }

    function setFrom(addr, lat, lng){
      S.from = { addr, lat, lng };
      el("fromText").textContent = addr || "Haritadan seç";
      refreshComputed();
    }
    function setTo(addr, lat, lng){
      S.to = { addr, lat, lng };
      el("toText").textContent = addr || "Haritadan seç";
      refreshComputed();
    }

    // ===== GEO + MAP =====
    function initMap(){
      const fallback = [40.195, 29.060]; // Bursa merkez fallback
      S.map = L.map("map", { zoomControl:false }).setView(fallback, 15);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: ""
      }).addTo(S.map);

      S.marker = L.marker(fallback, { draggable:false }).addTo(S.map);

      S.map.on("click", (ev)=>{
        const lat = ev.latlng.lat;
        const lng = ev.latlng.lng;
        reverseGeocode(lat, lng, function(addr){
          const nice = addr || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;

          if(S.mode === "from"){
            setFrom(nice, lat, lng);
            setPickMode(null);
          }else if(S.mode === "to"){
            setTo(nice, lat, lng);
            setPickMode(null);
          }else{
            // default: if from boşsa from, değilse to
            if(!S.from.lat) setFrom(nice, lat, lng);
            else setTo(nice, lat, lng);
          }

          S.marker.setLatLng([lat,lng]);
        });
      });
    }

    function requestGeolocation(){
      if(!navigator.geolocation){
        setStatus("Konum izni yok. Haritadan seçebilirsin.");
        return;
      }

      setStatus("Konum alınıyor…");
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          S.map.setView([lat,lng], 17);
          S.marker.setLatLng([lat,lng]);

          reverseGeocode(lat, lng, function(addr){
            const nice = addr || "Mevcut konum";
            // nereden otomatik dolsun
            setFrom(nice, lat, lng);
            setStatus("Konum alındı. Haritadan da seçebilirsin.");
          });
        },
        (_err)=>{
          setStatus("Konum alınamadı. Haritadan seçebilirsin.");
        },
        { enableHighAccuracy:true, timeout:9000, maximumAge:5000 }
      );
    }

    function reverseGeocode(lat, lng, cb){
      const url = "https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=" +
                  encodeURIComponent(lat) + "&lon=" + encodeURIComponent(lng);
      fetch(url, {
        headers: { "Accept":"application/json" }
      })
      .then(r=>r.json())
      .then(j=>{
        cb(j && j.display_name ? j.display_name : "");
      })
      .catch(()=>cb(""));
    }

    // ===== PRICING =====
    function haversineKm(a,b,c,d){
      const R = 6371;
      const toRad = x => x * Math.PI/180;
      const dLat = toRad(c-a);
      const dLng = toRad(d-b);
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const q = s1*s1 + Math.cos(toRad(a))*Math.cos(toRad(c))*s2*s2;
      return 2*R*Math.atan2(Math.sqrt(q), Math.sqrt(1-q));
    }

    function calcPrice(km){
      // Basit, stabil: daha sonra backend’e devredebiliriz.
      const base = (S.service==="courier") ? 65 : 55;
      const perKm = (S.service==="courier") ? 14 : 16;
      const p = base + (km * perKm);
      return Math.round(p);
    }

    function refreshComputed(){
      const hasFrom = !!S.from.lat && !!S.from.lng;
      const hasTo = !!S.to.lat && !!S.to.lng;

      // kayıt öncesi metrikler kapalı
      const metrics = el("metrics");
      if(!S.registered){
        metrics.style.display = "none";
        S.km = null; S.price = null;
      }else if(hasFrom && hasTo){
        const km = haversineKm(S.from.lat, S.from.lng, S.to.lat, S.to.lng);
        S.km = Math.max(0, km);
        S.price = calcPrice(S.km);

        el("kmText").textContent = (S.km).toFixed(1) + " km";
        el("priceText").textContent = (S.price) + " ₺";
        metrics.style.display = "flex";
      }else{
        metrics.style.display = "none";
        S.km = null; S.price = null;
      }

      // CTA enable rules:
      // - hizmet seçili (var)
      // - kayıt tamam
      // - from & to tamam
      // - km/price kayıt sonrası hesaplanmış
      const ok = S.registered && hasFrom && hasTo && (S.km !== null) && (S.price !== null);
      el("btnCall").classList.toggle("on", ok);
      el("btnCall").disabled = !ok;
      el("btnCall").style.cursor = ok ? "pointer" : "not-allowed";
    }

    // ===== JOB FLOW =====
    function createJob(){
      const ok = el("btnCall").classList.contains("on");
      if(!ok) return;

      showSearching(true);

      const c = S.customer || {};
      const payload = {
        action:"createJob",
        service_type: S.service,

        customer_first: c.first || "",
        customer_last: c.last || "",
        customer_phone: c.phone || "",

        from_address: S.from.addr || "",
        to_address: S.to.addr || "",

        pickup_lat: String(S.from.lat),
        pickup_lng: String(S.from.lng),
        dropoff_lat: String(S.to.lat),
        dropoff_lng: String(S.to.lng),

        distance_km: String((S.km||0).toFixed(2)),
        price: String(S.price || 0)
      };

      apiJSONP(payload)
        .then((resp)=>{
          if(!resp || !resp.ok){
            showSearching(false);
            alert("İş oluşturulamadı: " + (resp && resp.error ? resp.error : "Bilinmeyen hata"));
            return;
          }
          const jobId = resp.data && resp.data.job_id ? resp.data.job_id : "";
          if(!jobId){
            showSearching(false);
            alert("job_id alınamadı");
            return;
          }
          // kilitli akış: track yönlendirme
          location.href = "track.html?job_id=" + encodeURIComponent(jobId);
        })
        .catch((e)=>{
          showSearching(false);
          console.error(e);
          alert("Bağlantı hatası");
        });
    }

    // ===== BIND UI =====
    function bindUI(){
      // menu
      el("btnMenu").addEventListener("click", ()=> showDrawer(true));
      el("drawerMask").addEventListener("click", (ev)=>{
        if(ev.target === el("drawerMask")) showDrawer(false);
      });
      el("btnCloseDrawer").addEventListener("click", ()=> showDrawer(false));

      // service
      el("btnTaxi").addEventListener("click", ()=> setService("taxi"));
      el("btnCourier").addEventListener("click", ()=> setService("courier"));

      // pickers
      el("pickFrom").addEventListener("click", ()=>{
        setPickMode(S.mode==="from" ? null : "from");
      });
      el("pickTo").addEventListener("click", ()=>{
        setPickMode(S.mode==="to" ? null : "to");
      });

      // call
      el("btnCall").addEventListener("click", createJob);

      // registration
      el("regX").addEventListener("click", ()=>{
        // zorunlu kayıt: kapatmaya izin yok -> bilgi ver
        alert("Devam etmek için kayıt tamamlanmalı.");
      });
      el("regOk").addEventListener("click", ()=>{
        const first = (el("inFirst").value || "").trim();
        const last  = (el("inLast").value || "").trim();
        const phone = (el("inPhone").value || "").trim();

        if(first.length < 2 || last.length < 2 || phone.length < 10){
          alert("Lütfen ad/soyad/telefon bilgilerini doğru gir.");
          return;
        }

        const c = { first, last, phone, ts: Date.now() };
        S.customer = c;
        S.registered = true;
        saveCustomer(c);

        hideRegPermanently();
        refreshComputed();
      });
    }

    // ===== BOOT (NO await, NO async) =====
    function boot(){
      // start map first so UI feels instant
      initMap();
      bindUI();

      // load customer
      const c = loadCustomer();
      if(c && c.first && c.last && c.phone){
        S.customer = c;
        S.registered = true;
        hideRegPermanently();
      }else{
        S.registered = false;
        // hizmet zaten default taxi: zorunlu kayıt aç
        showReg(true);
      }

      // ping backend once (no await)
      apiJSONP({ action:"ping" })
        .then((r)=>{
          if(r && r.ok){
            // ok
          }else{
            console.warn("Ping not ok", r);
          }
        })
        .catch((e)=> console.warn("Ping fail", e));

      requestGeolocation();
      refreshComputed();
    }

    boot();
  </script>
</body>
</html>
