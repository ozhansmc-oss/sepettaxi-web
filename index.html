<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
:root{--y:#f5c400;--line:#222;--bad:#ff5a5f}

/* MAP */
#map{position:absolute;inset:0}
.leaflet-control-zoom,.leaflet-control-attribution{display:none!important}

/* BOTTOM */
.sheet{position:fixed;left:0;right:0;bottom:0;padding:10px;z-index:1000}
.card{background:#141416;border-radius:18px;padding:12px;border:1px solid var(--line)}
.cards2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.svc{padding:12px;border-radius:14px;border:1px solid var(--line);cursor:pointer}
.svc.active{border-color:var(--y);background:rgba(245,196,0,.12)}

.field{margin-top:10px;border:1px solid var(--line);border-radius:14px}
.field input{width:100%;padding:12px;background:transparent;border:0;color:#fff}

.cta{margin-top:10px;width:100%;padding:14px;border-radius:16px;
background:linear-gradient(180deg,var(--y),#d9aa00);border:0;font-weight:900}
.cta:disabled{opacity:.35}

/* MODAL */
.modalMask{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;
align-items:center;justify-content:center;z-index:2000}
.modalMask.on{display:flex}
.modal{background:#141416;border-radius:18px;padding:14px;width:90%;max-width:420px}
.modal h3{margin:0 0 10px}
.modal label{font-size:12px;opacity:.7}
.modal input,.modal select{width:100%;padding:10px;margin-top:4px;
background:#0f0f10;border:1px solid var(--line);color:#fff;border-radius:10px}
.err{font-size:12px;color:var(--bad);display:none;margin-top:6px}

/* OVERLAY */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;
align-items:center;justify-content:center;z-index:3000}
.overlay.on{display:flex}
.spin{width:44px;height:44px;border-radius:50%;
border:4px solid rgba(255,255,255,.2);border-top-color:var(--y);
animation:rot 1s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div id="map"></div>

<div class="sheet">
  <div class="card">
    <div class="cards2">
      <div class="svc active" id="svcTaxi">ðŸš• Taksi</div>
      <div class="svc" id="svcCourier">ðŸ“¦ Kurye</div>
    </div>

    <div class="field">
      <input id="fromAddr" placeholder="Nereden" readonly>
      <input id="toAddr" placeholder="Nereye" readonly>
    </div>

    <button class="cta" id="btnCall">Taksi Ã‡aÄŸÄ±r</button>
  </div>
</div>

<!-- KURYE MODAL -->
<div class="modalMask" id="courierMask">
  <div class="modal">
    <h3>Kurye DetaylarÄ±</h3>

    <label>Paket TÃ¼rÃ¼</label>
    <select id="cType">
      <option value="">SeÃ§iniz</option>
      <option value="evrak">Evrak</option>
      <option value="kucuk_paket">KÃ¼Ã§Ã¼k Paket</option>
      <option value="buyuk_paket">BÃ¼yÃ¼k Paket</option>
      <option value="diger">DiÄŸer</option>
    </select>

    <label style="margin-top:8px">Paket Ä°Ã§eriÄŸi</label>
    <input id="cContent" placeholder="Ã–rn: Resmi evrak">

    <label style="margin-top:8px">AlÄ±cÄ± Ad Soyad</label>
    <input id="cName">

    <label style="margin-top:8px">AlÄ±cÄ± Telefon</label>
    <input id="cPhone">

    <label style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <input type="checkbox" id="cAccept">
      Ä°Ã§eriÄŸin yasal olduÄŸunu onaylÄ±yorum
    </label>

    <div class="err" id="cErr">TÃ¼m alanlar ve onay zorunludur.</div>

    <button class="cta" id="cSave" style="margin-top:10px">Onayla</button>
  </div>
</div>

<!-- SEARCH -->
<div class="overlay" id="searchOverlay">
  <div><div class="spin"></div><div style="margin-top:8px">Kurye aranÄ±yor</div></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbz5Qk4OSBwQ1NCf09EGfczk7I8d3pRUSihE6xpb69mFRSf-MfNactwUxEQrNBYh6GcM/exec";
const LS="sepettaxi_customer";

let service="taxi";
let courier=null;

/* API */
async function api(action,p){
  const r=await fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action,...p})
  });
  const j=await r.json();
  if(!j.ok) throw new Error(j.error);
  return j;
}

/* MAP */
const map=L.map("map",{zoomControl:false}).setView([40.195,29.06],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/* USER */
function getUser(){try{return JSON.parse(localStorage.getItem(LS))}catch(_){return null}}

/* SERVICE */
svcTaxi.onclick=()=>{
  service="taxi";
  svcTaxi.classList.add("active");
  svcCourier.classList.remove("active");
  btnCall.textContent="Taksi Ã‡aÄŸÄ±r";
  btnCall.disabled=false;
};

svcCourier.onclick=()=>{
  service="courier";
  svcCourier.classList.add("active");
  svcTaxi.classList.remove("active");
  btnCall.textContent="Kurye Ã‡aÄŸÄ±r";
  btnCall.disabled=true;
  courierMask.classList.add("on");
};

/* COURIER MODAL */
cSave.onclick=()=>{
  const t=cType.value,c=cContent.value.trim(),
        n=cName.value.trim(),p=cPhone.value.trim(),
        a=cAccept.checked;
  if(!t||!c||!n||!p||!a){
    cErr.style.display="block";return;
  }
  courier={
    package_type:t,
    package_content_text:c,
    receiver_name:n,
    receiver_phone:p,
    content_declaration_accept:true
  };
  cErr.style.display="none";
  courierMask.classList.remove("on");
  btnCall.disabled=false;
};

/* CALL */
btnCall.onclick=async()=>{
  const u=getUser();
  if(!u){alert("Ã–nce kayÄ±t gerekli");return;}
  searchOverlay.classList.add("on");

  const payload={
    service_type:service,
    customer_id:u.customer_id,
    pickup_lat:map.getCenter().lat,
    pickup_lng:map.getCenter().lng,
    dropoff_lat:map.getCenter().lat,
    dropoff_lng:map.getCenter().lng,
    ...(service==="courier"?courier:{})
  };

  const r=await api("createJob",payload);
  location.href="track.html?job_id="+r.job_id;
};
</script>
</body>
</html>
