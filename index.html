<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400}

/* HEADER */
header{
  height:56px;background:#000;border-bottom:1px solid #111;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:900;position:relative
}
header span{color:var(--y)}
#burger{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  width:40px;height:36px;border-radius:12px;
  border:1px solid #222;background:#111;color:#fff;cursor:pointer
}

/* MAP */
#map{height:32vh}

/* PANEL */
#panel{
  height:calc(68vh - 56px);
  padding:10px;display:flex;flex-direction:column;gap:10px;
  padding-bottom:120px
}
.card{
  background:#0f0f0f;border-radius:16px;padding:12px;border:1px solid #111
}
.service-row{display:flex;gap:10px}
.service{
  flex:1;padding:12px;border-radius:14px;text-align:center;
  border:1px solid #222;color:#aaa;cursor:pointer
}
.service.active{
  border-color:var(--y);color:#fff;
  box-shadow:0 0 0 1px rgba(245,196,0,.3)
}
.input{
  width:100%;padding:12px;border-radius:14px;
  border:1px solid #222;background:#000;color:#fff
}

/* STATS */
.stats{display:flex;gap:10px}
.stat{
  flex:1;background:#111;border-radius:14px;padding:12px;text-align:center
}
.stat .lbl{font-size:12px;color:#aaa}
.stat .val{font-size:20px;font-weight:900}

/* CALL */
#callBar{
  position:fixed;bottom:0;left:0;right:0;
  background:#000;padding:12px;border-top:1px solid #111
}
#callBtn{
  background:var(--y);color:#000;border-radius:30px;
  padding:16px;text-align:center;font-weight:900;cursor:pointer
}
#hint{font-size:11px;color:#888;text-align:center;margin-top:6px}

/* DRIVER SIDE */
#driverSide{
  position:fixed;right:10px;top:90px;
  background:#0f0f0f;border:1px solid #222;border-radius:16px;
  padding:10px;width:160px;z-index:50
}
#driverSide button{
  width:100%;padding:10px;margin-top:8px;
  border-radius:12px;border:1px solid #222;
  background:#111;color:#fff;font-weight:900;cursor:pointer
}

/* REGISTER */
#register{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  display:none;align-items:center;justify-content:center;z-index:200
}
#register .box{
  background:#0f0f0f;border:1px solid #222;
  border-radius:16px;padding:16px;width:90%;max-width:360px
}
.err{color:#ff5c5c;font-size:12px;display:none}
</style>
</head>

<body>

<header>
  Sepet<span>Taxi</span>
  <button id="burger">‚ò∞</button>
</header>

<div id="map"></div>

<div id="panel">

  <div class="card">
    <b>Hizmet Se√ß</b>
    <div class="service-row" style="margin-top:8px">
      <div id="svcTaxi" class="service">üöï Taksi</div>
      <div id="svcCourier" class="service">üì¶ Kurye</div>
    </div>
    <div style="font-size:11px;color:#777;margin-top:6px">
      Hizmet se√ßmeden √∂nce kayƒ±t zorunludur.
    </div>
  </div>

  <div class="card">
    <input id="fromAddr" class="input" readonly placeholder="Nereden">
  </div>

  <div class="card">
    <input id="toAddr" class="input" readonly placeholder="Nereye (haritadan se√ß)">
  </div>

  <div class="stats">
    <div class="stat">
      <div class="lbl">Mesafe</div>
      <div id="dist" class="val">‚Äî</div>
    </div>
    <div class="stat">
      <div class="lbl">√úcret</div>
      <div id="price" class="val">‚Äî</div>
    </div>
  </div>

</div>

<div id="driverSide">
  <b>üöó S√ºr√ºc√º m√ºs√ºn?</b>
  <button onclick="location.href='driver-register.html'">S√ºr√ºc√º Ol</button>
  <button onclick="location.href='driver.html'">S√ºr√ºc√º Giri≈üi</button>
</div>

<div id="callBar">
  <div id="callBtn">√áAƒûIR</div>
  <div id="hint">Haritadan ‚ÄúNereye‚Äù se√ßmeden √ßaƒürƒ± olu≈üturulmaz.</div>
</div>

<!-- REGISTER -->
<div id="register">
  <div class="box">
    <h3>Zorunlu Kayƒ±t</h3>
    <input id="fn" class="input" placeholder="Ad">
    <br><br>
    <input id="ln" class="input" placeholder="Soyad">
    <br><br>
    <input id="ph" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <br><br>
    <label style="font-size:12px">
      <input type="checkbox" id="kvkk"> KVKK kabul
    </label>
    <div id="regErr" class="err">Bilgiler hatalƒ±</div>
    <br>
    <div id="regOk" style="background:var(--y);color:#000;border-radius:14px;padding:12px;text-align:center;font-weight:900;cursor:pointer">
      KAYDI TAMAMLA
    </div>
  </div>
</div>

<script>
/* CONFIG */
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

/* STATE */
let map,fromM=null,toM=null,service=null;
let registered=false,customer=null;

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
  initMap();
  svcTaxi.onclick=()=>pickService("taxi");
  svcCourier.onclick=()=>pickService("courier");
  callBtn.onclick=callDriver;
  regOk.onclick=saveCustomer;
});

/* MAP */
function initMap(){
  map=L.map("map").setView([40.195,29.060],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  navigator.geolocation.getCurrentPosition(p=>{
    fromM=L.marker([p.coords.latitude,p.coords.longitude]).addTo(map);
    map.setView([p.coords.latitude,p.coords.longitude],15);
    reverse(p.coords.latitude,p.coords.longitude,fromAddr);
  });

  map.on("click",e=>{
    if(!toM) toM=L.marker(e.latlng).addTo(map);
    else toM.setLatLng(e.latlng);
    reverse(e.latlng.lat,e.latlng.lng,toAddr);
    calc();
  });
}

/* SERVICE */
function pickService(t){
  if(!registered){ openRegister(); return; }
  service=t;
  svcTaxi.classList.toggle("active",t==="taxi");
  svcCourier.classList.toggle("active",t==="courier");
  calc();
}

/* REGISTER */
function openRegister(){
  register.style.display="flex";
}
function saveCustomer(){
  if(fn.value.length<2||ln.value.length<2||!/^05\d{9}$/.test(ph.value)||!kvkk.checked){
    regErr.style.display="block";return;
  }
  customer={first:fn.value,last:ln.value,phone:ph.value};
  registered=true;
  register.style.display="none";
}

/* CALC */
function calc(){
  if(!service||!fromM||!toM) return;
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=h(a.lat,a.lng,b.lat,b.lng);
  dist.textContent=km.toFixed(2)+" km";
  price.textContent=
    Math.round(service==="taxi"?Math.max(120,60+km*22):Math.max(80,40+km*15))+" TL";
}

/* CALL */
async function callDriver(){
  if(!registered){ openRegister(); return; }
  if(!service||!fromM||!toM) return alert("Eksik bilgi");

  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=h(a.lat,a.lng,b.lat,b.lng);
  const pr=Math.round(Math.max(120,60+km*22));

  const payload={
    action:"createJob",
    service_type:service,
    from_addr:fromAddr.value,
    to_addr:toAddr.value,
    from_lat:a.lat,from_lng:a.lng,
    to_lat:b.lat,to_lng:b.lng,
    distance_km:km,
    price_brut:pr,
    customer
  };

  const r=await fetch(BACKEND_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(payload)
  });
  const d=await r.json();
  if(d.ok && d.job_id){
  window.location.href =
    "track.html?job_id=" + encodeURIComponent(d.job_id);
  return;
}

/* HELPERS */
function h(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function reverse(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
    .then(r=>r.json()).then(d=>{if(d.display_name) input.value=d.display_name});
}
</script>

</body>
</html>
