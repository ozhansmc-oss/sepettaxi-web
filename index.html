<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400" />

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  *{box-sizing:border-box}
  :root{
    --y:#f5c400; --bg:#050506; --panel:#0f0f10; --card:#141416;
    --line:rgba(255,255,255,.10); --mut:rgba(255,255,255,.65); --mut2:rgba(255,255,255,.42);
    --ok:#2bd576; --bad:#ff4d4d;
  }
  html,body{height:100%; margin:0; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; overflow:hidden}
  a{color:inherit}

  /* Layout: Topbar fixed, Map 50%, Bottom 50% */
  #app{height:100%; display:flex; flex-direction:column}
  header{
    height:56px; flex:0 0 56px;
    display:flex; align-items:center; justify-content:center;
    position:relative;
    background:#000; border-bottom:1px solid rgba(255,255,255,.08);
    user-select:none;
  }
  .brand{font-weight:900; letter-spacing:.3px}
  .brand span{color:var(--y)}
  .iconBtn{
    position:absolute; top:50%; transform:translateY(-50%);
    width:42px; height:42px; border-radius:12px;
    display:flex; align-items:center; justify-content:center;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    cursor:pointer;
  }
  .iconBtn:active{transform:translateY(-50%) scale(.98)}
  #hamb{left:10px}
  #support{right:10px}

  #main{flex:1; display:flex; flex-direction:column; min-height:0}
  #mapWrap{flex:0 0 calc((100vh - 56px) * 0.5); position:relative}
  #map{height:100%; width:100%}

  /* center pin */
  .centerPin{
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-100%);
    z-index:500;
    pointer-events:none;
    filter:drop-shadow(0 10px 12px rgba(0,0,0,.55));
  }
  .pinTop{
    width:28px; height:28px; border-radius:14px;
    background:var(--y); border:2px solid #000;
    display:flex; align-items:center; justify-content:center;
  }
  .pinDot{
    width:8px; height:8px; border-radius:4px; background:#000;
    opacity:.9;
  }
  .pinStem{
    width:6px; height:16px; background:var(--y); margin:0 auto; border-radius:0 0 6px 6px;
    border:2px solid #000; border-top:none;
  }

  /* Bottom panel */
  #panel{
    flex:1; min-height:0;
    background:linear-gradient(180deg, rgba(10,10,12,.86), rgba(10,10,12,.98));
    border-top:1px solid rgba(255,255,255,.08);
    padding:12px;
    display:flex; flex-direction:column; gap:10px;
  }

  .seg{
    display:flex; gap:8px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    padding:6px; border-radius:16px;
  }
  .seg button{
    flex:1; border:0; border-radius:12px;
    padding:10px 12px;
    background:transparent; color:rgba(255,255,255,.70);
    font-weight:800; cursor:pointer;
  }
  .seg button.active{
    background:rgba(245,196,0,.18);
    border:1px solid rgba(245,196,0,.35);
    color:#fff;
  }

  .card{
    background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.08);
    border-radius:18px;
    padding:12px;
  }
  .row{display:flex; gap:10px; align-items:center}
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10);
    color:rgba(255,255,255,.85); font-weight:700; font-size:13px;
  }
  .pill .dot{
    width:10px; height:10px; border-radius:5px; background:rgba(255,255,255,.35);
  }
  .pill.ok .dot{background:var(--ok)}
  .pill.warn .dot{background:var(--y)}
  .pill.bad .dot{background:var(--bad)}

  .field{
    display:flex; flex-direction:column; gap:6px;
  }
  .field label{font-size:12px; color:rgba(255,255,255,.55); font-weight:700}
  .field .fakeInput{
    display:flex; align-items:center; justify-content:space-between;
    gap:10px;
    padding:12px 12px;
    border-radius:14px;
    background:rgba(0,0,0,.25);
    border:1px solid rgba(255,255,255,.10);
    font-weight:800;
    min-height:44px;
  }
  .fakeInput .val{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:75%}
  .hint{font-size:12px; color:rgba(255,255,255,.52); margin-top:6px}
  .mini{font-size:12px; color:rgba(255,255,255,.45)}

  .btn{
    border:0;
    width:100%;
    padding:14px 14px;
    border-radius:16px;
    font-weight:900;
    cursor:pointer;
    background:var(--y);
    color:#000;
    transition:transform .18s ease, opacity .18s ease, filter .18s ease;
  }
  .btn:active{transform:scale(.985)}
  .btn[disabled]{opacity:.45; cursor:not-allowed; filter:saturate(.2)}
  .btn.pop{animation:pop .22s ease}
  @keyframes pop{from{transform:scale(.98)}to{transform:scale(1)}}

  /* Drawer */
  #drawerBackdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    backdrop-filter:blur(6px);
    opacity:0; pointer-events:none;
    transition:opacity .20s ease;
    z-index:2000;
  }
  #drawer{
    position:fixed; top:0; left:0; bottom:0; width:78%;
    max-width:340px;
    background:rgba(12,12,14,.92);
    border-right:1px solid rgba(255,255,255,.10);
    transform:translateX(-100%);
    transition:transform .22s ease;
    z-index:2001;
    padding:14px;
    display:flex; flex-direction:column; gap:10px;
  }
  #drawerBackdrop.open{opacity:1; pointer-events:auto}
  #drawer.open{transform:translateX(0)}
  .menuTitle{font-weight:900; letter-spacing:.2px}
  .menuItem{
    padding:12px 12px; border-radius:14px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.08);
    display:flex; justify-content:space-between; align-items:center;
    cursor:pointer;
    font-weight:800;
  }
  .menuItem small{color:rgba(255,255,255,.55); font-weight:700}
  .sep{height:1px; background:rgba(255,255,255,.08); margin:4px 0}

  /* Modals */
  .modalBackdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.58);
    backdrop-filter:blur(7px);
    display:none; align-items:flex-end; justify-content:center;
    z-index:3000;
  }
  .modal{
    width:100%;
    max-width:520px;
    border-radius:22px 22px 0 0;
    background:rgba(14,14,16,.96);
    border:1px solid rgba(255,255,255,.10);
    border-bottom:none;
    padding:14px;
  }
  .handle{width:54px; height:6px; border-radius:999px; background:rgba(255,255,255,.18); margin:6px auto 10px}
  .modal h3{margin:4px 0 10px; font-size:16px}
  .inp{
    width:100%; padding:12px 12px; border-radius:14px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(0,0,0,.25);
    color:#fff; font-weight:800;
    outline:none;
  }
  .modalRow{display:flex; gap:10px}
  .modalRow .field{flex:1}

  /* Searching overlay - premium */
  #searchOverlay{
    position:fixed; inset:0; z-index:4000;
    display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55);
    backdrop-filter:blur(14px);
  }
  .searchCard{
    width:86%; max-width:360px;
    padding:16px;
    border-radius:22px;
    background:rgba(18,18,20,.82);
    border:1px solid rgba(255,255,255,.10);
    box-shadow:0 18px 40px rgba(0,0,0,.45);
    text-align:center;
  }
  .badge{
    display:inline-flex; align-items:center; gap:10px;
    padding:10px 14px;
    border-radius:999px;
    background:rgba(245,196,0,.16);
    border:1px solid rgba(245,196,0,.32);
    font-weight:900;
  }
  .pulseDot{
    width:10px; height:10px; border-radius:5px; background:var(--y);
    box-shadow:0 0 0 rgba(245,196,0,.55);
    animation:pulse 1.25s ease-in-out infinite;
  }
  @keyframes pulse{
    0%{box-shadow:0 0 0 0 rgba(245,196,0,.45)}
    70%{box-shadow:0 0 0 16px rgba(245,196,0,0)}
    100%{box-shadow:0 0 0 0 rgba(245,196,0,0)}
  }
  .sub{margin-top:10px; color:rgba(255,255,255,.70); font-weight:700}
  .tiny{margin-top:6px; color:rgba(255,255,255,.45); font-size:12px}

  /* small icons */
  .hambLines{width:18px; height:14px; display:flex; flex-direction:column; justify-content:space-between}
  .hambLines i{display:block; height:2px; background:#fff; opacity:.9; border-radius:2px}
  .qMark{font-weight:900; font-size:18px}

</style>
</head>

<body>
<div id="app">
  <header>
    <div id="hamb" class="iconBtn" title="Menü">
      <div class="hambLines"><i></i><i></i><i></i></div>
    </div>
    <div class="brand">Sepet<span>Taxi</span></div>
    <div id="support" class="iconBtn" title="Destek">
      <div class="qMark">?</div>
    </div>
  </header>

  <div id="main">
    <div id="mapWrap">
      <div id="map"></div>
      <div class="centerPin" aria-hidden="true">
        <div class="pinTop"><div class="pinDot"></div></div>
        <div class="pinStem"></div>
      </div>
    </div>

    <div id="panel">
      <div class="seg" aria-label="Hizmet seçimi">
        <button id="btnTaxi" class="active">Taksi</button>
        <button id="btnCourier">Kurye (Moto)</button>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div id="statusPill" class="pill warn"><span class="dot"></span><span id="statusText">Konumunuz alınıyor</span></div>
          <div class="mini" id="gpsHint"></div>
        </div>

        <div style="height:10px"></div>

        <div class="field">
          <label>Nereden</label>
          <div class="fakeInput" id="fromBox">
            <div class="val" id="fromVal">Haritadan seçin</div>
            <div class="mini">Seç</div>
          </div>
        </div>

        <div style="height:8px"></div>

        <div class="field">
          <label>Nereye</label>
          <div class="fakeInput" id="toBox">
            <div class="val" id="toVal">Haritadan seçin</div>
            <div class="mini">Seç</div>
          </div>
        </div>

        <div class="hint" id="selectHint">Haritayı hareket ettirip merkez pinden konum seçin.</div>
      </div>

      <button id="callBtn" class="btn" disabled>Çağır</button>
      <div class="mini" id="belowNote">Ücret ve mesafe, kayıt sonrası gösterilir.</div>
    </div>
  </div>
</div>

<!-- Drawer -->
<div id="drawerBackdrop"></div>
<div id="drawer">
  <div class="menuTitle">Menü</div>
  <div class="menuItem" onclick="location.href='driver.html'">
    <div>Sürücü Modu</div>
    <small>iş havuzu</small>
  </div>
  <div class="menuItem" onclick="location.href='driver-apply.html'">
    <div>Sürücü Ol</div>
    <small>başvuru</small>
  </div>
  <div class="sep"></div>
  <div class="menuItem" onclick="location.href='about.html'">
    <div>Hakkımızda</div>
    <small>kurumsal</small>
  </div>
  <div class="menuItem" onclick="location.href='terms.html'">
    <div>Kullanıcı Şartları</div>
    <small>yakında</small>
  </div>
  <div class="menuItem" onclick="location.href='privacy.html'">
    <div>Gizlilik / KVKK</div>
    <small>yakında</small>
  </div>
  <div class="sep"></div>
  <div class="menuItem" id="menuSupport">
    <div>Destek</div>
    <small>WhatsApp / E-posta</small>
  </div>
</div>

<!-- Register modal -->
<div id="regBackdrop" class="modalBackdrop">
  <div class="modal">
    <div class="handle"></div>
    <h3>Kayıt</h3>
    <div class="modalRow">
      <div class="field">
        <label>Ad</label>
        <input id="regFirst" class="inp" placeholder="Örn. Özhan" autocomplete="given-name">
      </div>
      <div class="field">
        <label>Soyad</label>
        <input id="regLast" class="inp" placeholder="Örn. Samurcu" autocomplete="family-name">
      </div>
    </div>
    <div style="height:10px"></div>
    <div class="field">
      <label>Telefon</label>
      <input id="regPhone" class="inp" placeholder="05xx..." inputmode="tel" autocomplete="tel">
      <div class="mini">Kayıt, çağrıdan önce zorunludur. Ücret/mesafe kayıt sonrası gösterilir.</div>
    </div>
    <div style="height:12px"></div>
    <button id="regOk" class="btn" disabled>Devam Et</button>
    <div style="height:8px"></div>
    <div class="mini" style="text-align:center; opacity:.7">Kayıt, aynı hesapla hem müşteri hem sürücü kullanımını destekler.</div>
  </div>
</div>

<!-- Searching overlay -->
<div id="searchOverlay">
  <div class="searchCard">
    <div class="badge"><span class="pulseDot"></span><span>Sürücü aranıyor</span></div>
    <div class="sub" id="searchSub">Yakın sürücülerle eşleşiyoruz</div>
    <div class="tiny" id="searchTiny">Lütfen bekleyin</div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const API = (localStorage.getItem("SEPETTAXI_API") || "https://script.google.com/macros/s/AKfycbxoeXl9XfxWtsqqCfftNV578KD_woNSKfT3KmSYwZuCv8iPSPd8-cZXNoYMh6Qx-yrlWA/exec").trim(); // set once in browser if needed
// If you want hardcode: const API = "https://script.google.com/macros/s/XXXX/exec";

/* ===================== STATE ===================== */
let map, userLatLng=null, serviceType="taxi";
let picking = "from"; // "from" then "to"
let from = null, to = null; // {lat,lng,address}
let lastCenter = null;
let registered = false;
let customer = {first:"", last:"", phone:"", user_id:""};

function $(id){ return document.getElementById(id); }

function setStatus(type, text){
  const pill = $("statusPill");
  pill.classList.remove("ok","warn","bad");
  pill.classList.add(type);
  $("statusText").textContent = text;
}

function toastStatus(text){
  setStatus("warn", text);
}

function enableCallIfReady(){
  const ready = !!(from && to);
  const btn = $("callBtn");
  btn.disabled = !ready;
  if(ready){ btn.classList.add("pop"); setTimeout(()=>btn.classList.remove("pop"), 250); }
}

function saveCustomer(){
  localStorage.setItem("stx_customer", JSON.stringify(customer));
  localStorage.setItem("stx_registered", "1");
}
function loadCustomer(){
  try{
    const reg = localStorage.getItem("stx_registered")==="1";
    if(!reg) return;
    const c = JSON.parse(localStorage.getItem("stx_customer")||"{}");
    if(c && c.phone){
      customer = c;
      registered = true;
    }
  }catch(e){}
}

function normalizePhone(p){
  p = (p||"").replace(/[^\d+]/g,"");
  // basic TR normalize
  if(p.startsWith("0")) p = "+9" + p; // 0xxx -> +90xxx (rough)
  if(p.startsWith("90")) p = "+" + p;
  if(!p.startsWith("+")) p = "+90" + p;
  return p;
}

function ensureAPI(){
  if(!API){
    alert("API URL tanımlı değil. Tarayıcıda localStorage'a SEPETTAXI_API olarak ekleyin veya index.html içinde API sabitleyin.");
    throw new Error("API missing");
  }
}

/* ===================== MAP ===================== */
function initMap(){
  map = L.map('map', { zoomControl:false, attributionControl:false });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

  map.on("move", ()=>{
    lastCenter = map.getCenter();
  });

  // tap-from/to selects center point
  $("fromBox").addEventListener("click", async ()=>{
    picking = "from";
    await pickFromCenter();
  });
  $("toBox").addEventListener("click", async ()=>{
    picking = "to";
    await pickFromCenter();
  });

  // also allow double tap to pick
  map.on("click", async ()=>{
    await pickFromCenter();
  });
}

async function pickFromCenter(){
  const c = map.getCenter();
  setStatus("warn", picking==="from" ? "Nereden alalım?" : "Nereye gideceksiniz?");
  const addr = await reverseGeocode(c.lat, c.lng);
  const obj = {lat:c.lat, lng:c.lng, address:addr||"Seçilen konum"};
  if(picking==="from"){
    from = obj; $("fromVal").textContent = obj.address;
    picking = "to";
  }else{
    to = obj; $("toVal").textContent = obj.address;
  }
  enableCallIfReady();
}

async function reverseGeocode(lat,lng){
  try{
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`;
    const r = await fetch(url, { headers: { "Accept":"application/json" }});
    const j = await r.json();
    return (j && (j.display_name || j.name)) ? j.display_name : "";
  }catch(e){
    return "";
  }
}

function getGeo(){
  return new Promise((resolve)=>{
    if(!navigator.geolocation){ resolve(null); return; }
    navigator.geolocation.getCurrentPosition(
      (pos)=> resolve({lat:pos.coords.latitude, lng:pos.coords.longitude}),
      ()=> resolve(null),
      { enableHighAccuracy:true, timeout:8000, maximumAge:15000 }
    );
  });
}

/* ===================== UI EVENTS ===================== */
function setService(type){
  serviceType = type;
  $("btnTaxi").classList.toggle("active", type==="taxi");
  $("btnCourier").classList.toggle("active", type==="courier_moto");
  // reset selection? No (keep, user may switch)
}

function openDrawer(open){
  $("drawerBackdrop").classList.toggle("open", open);
  $("drawer").classList.toggle("open", open);
}
$("hamb").addEventListener("click", ()=> openDrawer(true));
$("drawerBackdrop").addEventListener("click", ()=> openDrawer(false));

$("support").addEventListener("click", ()=>{
  openSupport();
});
$("menuSupport").addEventListener("click", ()=>{
  openSupport();
});

function openSupport(){
  openDrawer(false);
  const phone = customer.phone || "";
  const msg = encodeURIComponent(`Merhaba SepetTaxi destek. Telefon: ${phone}\nSorunum: `);
  // WhatsApp link placeholder number: set your business number
  const waNumber = (localStorage.getItem("SEPETTAXI_SUPPORT_WA")||"").trim(); // example: +905xxxxxxxxx
  const wa = waNumber ? `https://wa.me/${waNumber.replace(/[^\d]/g,'')}?text=${msg}` : null;

  const mail = `mailto:destek@sepettaxi.com?subject=SepetTaxi%20Destek&body=${msg}`;

  if(wa){
    if(confirm("WhatsApp ile canlı destek açılsın mı? (İptal: E-posta)")){
      location.href = wa; return;
    }
  }
  location.href = mail;
}

/* ===================== REGISTER FLOW ===================== */
function showReg(open){
  $("regBackdrop").style.display = open ? "flex" : "none";
}
$("regBackdrop").addEventListener("click",(e)=>{
  if(e.target.id==="regBackdrop") showReg(false);
});

function validateReg(){
  const f = $("regFirst").value.trim();
  const l = $("regLast").value.trim();
  const p = normalizePhone($("regPhone").value.trim());
  const ok = f.length>=2 && l.length>=2 && p.length>=10;
  $("regOk").disabled = !ok;
  return ok;
}
["regFirst","regLast","regPhone"].forEach(id=> $(id).addEventListener("input", validateReg));

$("regOk").addEventListener("click", ()=>{
  if(!validateReg()) return;
  customer.first = $("regFirst").value.trim();
  customer.last = $("regLast").value.trim();
  customer.phone = normalizePhone($("regPhone").value.trim());
  customer.user_id = customer.user_id || ("u_" + Math.random().toString(16).slice(2) + Date.now());
  registered = true;
  saveCustomer();
  showReg(false);
  // continue call
  createJob();
});

/* ===================== JOB FLOW ===================== */
function showSearching(open, sub, tiny){
  $("searchOverlay").style.display = open ? "flex" : "none";
  if(sub) $("searchSub").textContent = sub;
  if(tiny) $("searchTiny").textContent = tiny;
}

async function apiCall(action, payload){
  ensureAPI();
  const url = API + (API.includes("?") ? "&" : "?") + "action=" + encodeURIComponent(action);
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload||{})
  });
  const j = await r.json();
  if(j && j.error) throw new Error(j.error);
  return j;
}

$("callBtn").addEventListener("click", ()=>{
  if(!from || !to) return;
  if(!registered){
    showReg(true);
    // prefill phone if exists
    if(customer.phone) $("regPhone").value = customer.phone;
    validateReg();
    return;
  }
  createJob();
});

async function createJob(){
  try{
    setStatus("warn", "Yakın sürücüler aranıyor");
    showSearching(true, "Yakın sürücülerle eşleşiyoruz", "Lütfen bekleyin");
    const payload = {
      service_type: serviceType,
      customer_first: customer.first,
      customer_last: customer.last,
      customer_phone: customer.phone,
      from_address: from.address,
      to_address: to.address,
      pickup_lat: from.lat, pickup_lng: from.lng,
      dropoff_lat: to.lat, dropoff_lng: to.lng,
      package_type: (serviceType==="courier_moto") ? prompt("Paket türü (Evrak/Küçük Paket/Yemek/Diğer)", "Evrak") || "Diğer" : "",
      receiver_name: (serviceType==="courier_moto") ? (prompt("Alıcı adı", "") || "") : "",
      receiver_phone: (serviceType==="courier_moto") ? normalizePhone(prompt("Alıcı telefonu", "") || "") : ""
    };

    // Kurye zorunluları
    if(serviceType==="courier_moto"){
      if(!payload.package_type || !payload.receiver_name || !payload.receiver_phone){
        showSearching(false);
        alert("Kurye için Paket türü, Alıcı adı ve Alıcı telefonu zorunludur.");
        return;
      }
    }

    const res = await apiCall("createJob", payload);
    // res: {job_id, distance_km, price}
    // Fiyat/mesafe kayıt sonrası görünür: artık registered true -> gösterilebilir.
    showSearching(false);
    // Track redirect
    location.href = `track.html?job_id=${encodeURIComponent(res.job_id)}`;
  }catch(e){
    showSearching(false);
    alert("Hata: " + e.message);
  }
}

/* ===================== INIT ===================== */
(async function boot(){
  loadCustomer();

  initMap();

  $("btnTaxi").addEventListener("click", ()=> setService("taxi"));
  $("btnCourier").addEventListener("click", ()=> setService("courier_moto"));

  // get geo
  setStatus("warn", "Konumunuz alınıyor");
  const geo = await getGeo();
  if(geo){
    userLatLng = geo;
    map.setView([geo.lat, geo.lng], 16);
    setStatus("ok", "Nereden alalım?");
    $("gpsHint").textContent = "GPS hazır";
  }else{
    // fallback Istanbul center
    map.setView([41.0082, 28.9784], 12);
    setStatus("warn", "Konum izni gerekli");
    $("gpsHint").textContent = "GPS yok";
  }

  // allow API set hint
  if(!API){
    $("belowNote").textContent = "API tanımlı değil. SEPETTAXI_API ayarlayın.";
  }
})();
</script>
</body>
</html>
