<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
:root{
  --y:#f5c400;
  --bg:#050506;
  --panel:#0f0f10;
  --card:#141416;
  --line:rgba(255,255,255,.12);
  --mut:rgba(255,255,255,.65);
}
html,body{
  margin:0;height:100%;
  background:var(--bg);color:#fff;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
  overflow:hidden;
}

/* TOPBAR */
#topbar{
  position:fixed;top:0;left:0;right:0;
  height:56px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;
  z-index:1500;
  background:linear-gradient(to bottom,rgba(0,0,0,.7),rgba(0,0,0,0));
}
#topbar .btn{
  width:42px;height:42px;border-radius:14px;
  background:rgba(15,15,16,.75);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;
}
#topbar .brand{
  display:flex;align-items:center;gap:8px;
  font-weight:900;
}
#topbar .mark{
  width:26px;height:26px;border-radius:8px;
  background:var(--y);color:#000;
  display:flex;align-items:center;justify-content:center;
  font-weight:900;
}
#topStatus{font-size:11px;color:var(--mut)}

/* MAP */
#map-wrap{height:50vh}
#map{height:100%;width:100%}
.leaflet-control-zoom{display:none!important}

/* SEARCHING BADGE */
#searchingBadge{
  position:fixed;top:64px;left:50%;
  transform:translateX(-50%);
  background:rgba(15,15,16,.8);
  border:1px solid rgba(255,255,255,.15);
  border-radius:999px;
  padding:8px 14px;
  display:none;align-items:center;gap:10px;
  backdrop-filter:blur(10px);
  box-shadow:0 12px 40px rgba(0,0,0,.6);
  z-index:1600;
  font-size:13px;font-weight:800;
}
#searchingBadge.show{display:flex}
.dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--y);
  animation:pulse 1s infinite;
}
@keyframes pulse{
  0%{opacity:.4}50%{opacity:1}100%{opacity:.4}
}

/* BOTTOM SHEET */
#bottom{
  position:fixed;bottom:0;left:0;right:0;
  height:50vh;
  background:var(--panel);
  border-radius:18px 18px 0 0;
  padding:10px 12px;
  z-index:1000;
  overflow:hidden;
}
.card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:16px;
  padding:10px 12px;
  margin-bottom:8px;
}
.h1{font-size:16px;font-weight:900;margin:0 0 6px}
.p{font-size:12px;color:var(--mut);margin:0}
.row{display:flex;gap:8px}
.chip{
  flex:1;
  border:1px solid var(--line);
  border-radius:999px;
  padding:8px;
  text-align:center;
  font-size:13px;
}
.chip.on{border-color:var(--y)}
.field{
  width:100%;padding:10px 12px;
  border-radius:12px;
  background:#0b0b0c;
  border:1px solid var(--line);
  color:#fff;
}
.btnMain{
  width:100%;padding:12px;
  border-radius:14px;
  border:none;
  background:var(--y);color:#000;
  font-weight:900;
}
.btnMain:disabled{opacity:.4}

/* DRAWER */
#drawerBack{
  position:fixed;inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(6px);
  display:none;z-index:1800;
}
#drawer{
  position:fixed;top:0;left:0;bottom:0;
  width:260px;
  background:#0b0b0c;
  padding:14px;
  transform:translateX(-100%);
  transition:.2s;
  z-index:1900;
}
#drawer.open{transform:translateX(0)}
.menuItem{
  padding:12px;
  border-radius:12px;
  border:1px solid var(--line);
  margin-bottom:10px;
}
</style>
</head>

<body>

<header id="topbar">
  <div class="btn" id="hamb">‚ò∞</div>
  <div class="brand">
    <div class="mark">S</div>
    <div>
      SepetTaxi
      <div id="topStatus">Konum alƒ±nƒ±yor‚Ä¶</div>
    </div>
  </div>
  <div style="width:42px"></div>
</header>

<div id="searchingBadge"><span class="dot"></span> S√ºr√ºc√º aranƒ±yor‚Ä¶</div>

<div id="map-wrap"><div id="map"></div></div>

<section id="bottom">
  <div class="card">
    <div class="h1">Hizmet Se√ß</div>
    <div class="row">
      <div class="chip on" id="chipTaxi">üöï Taksi</div>
      <div class="chip" id="chipCourier">üèçÔ∏è Kurye</div>
    </div>
  </div>

  <div class="card">
    <input class="field" id="fromInput" placeholder="Nereden" readonly>
    <input class="field" id="toInput" placeholder="Nereye" readonly style="margin-top:6px">
    <div class="p" id="calcInfo" style="margin-top:6px">Mesafe ve √ºcret se√ßince g√∂r√ºn√ºr</div>
  </div>

  <button class="btnMain" id="callBtn" disabled>√áaƒüƒ±r</button>
</section>

<div id="drawerBack"></div>
<aside id="drawer">
  <div class="menuItem" onclick="location.href='driver.html'">S√ºr√ºc√º Giri≈üi</div>
  <div class="menuItem" onclick="location.href='driver.html'">S√ºr√ºc√º Ol</div>
  <div class="menuItem" onclick="window.open('https://wa.me/90XXXXXXXXXX','_blank')">Destek</div>
</aside>

<script>
const API="https://script.google.com/macros/s/AKfycbxv2oWIgjckH09LB3tKOGIKox32G_RBgp6udb-sSM4uDIrL59iA8Ctsdl1cy5AC92rFZA/exec";
const $=id=>document.getElementById(id);

let service="taxi",picking="from";
let from={},to={};
let map,fromMarker,toMarker,line;

map=L.map("map",{zoomControl:false}).setView([40.195,29.060],13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
map.dragging.disable();

map.on("click",async e=>{
  const lat=e.latlng.lat,lng=e.latlng.lng;
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
  const j=await r.json();
  const addr=j.display_name||"Se√ßilen konum";
  if(picking==="from"){
    from={addr,lat,lng};$("fromInput").value=addr;
    if(fromMarker)map.removeLayer(fromMarker);
    fromMarker=L.marker([lat,lng]).addTo(map);
    picking="to";
  }else{
    to={addr,lat,lng};$("toInput").value=addr;
    if(toMarker)map.removeLayer(toMarker);
    toMarker=L.marker([lat,lng]).addTo(map);
  }
  map.dragging.enable();
  calc();
});

function calc(){
  if(!from.lat||!to.lat)return;
  const km=haversine(from.lat,from.lng,to.lat,to.lng);
  const price=Math.round(70+km*14);
  $("calcInfo").innerText=`${km.toFixed(1)} km ‚Ä¢ ${price} ‚Ç∫`;
  $("callBtn").disabled=false;
  if(line)map.removeLayer(line);
  line=L.polyline([[from.lat,from.lng],[to.lat,to.lng]]).addTo(map);
}

function haversine(a,b,c,d){
  const R=6371,toRad=x=>x*Math.PI/180;
  const dLat=toRad(c-a),dLng=toRad(d-b);
  return 2*R*Math.asin(Math.sqrt(
    Math.sin(dLat/2)**2+
    Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLng/2)**2
  ));
}

$("chipTaxi").onclick=()=>{service="taxi";$("chipTaxi").classList.add("on");$("chipCourier").classList.remove("on")};
$("chipCourier").onclick=()=>{service="courier";$("chipCourier").classList.add("on");$("chipTaxi").classList.remove("on")};

$("hamb").onclick=()=>{$("drawerBack").style.display="block";$("drawer").classList.add("open")};
$("drawerBack").onclick=()=>{$("drawerBack").style.display="none";$("drawer").classList.remove("open")};

$("callBtn").onclick=()=>{
  $("searchingBadge").classList.add("show");
  fetch(API,{method:"POST",body:JSON.stringify({
    action:"createJob",service_type:service,
    from_address:from.addr,to_address:to.addr,
    pickup_lat:from.lat,pickup_lng:from.lng,
    dropoff_lat:to.lat,dropoff_lng:to.lng
  })})
  .then(r=>r.json())
  .then(d=>location.href="track.html?job_id="+d.job_id);
};

navigator.geolocation.getCurrentPosition(
  p=>{$("topStatus").innerText="Konum hazƒ±r";},
  ()=>{$("topStatus").innerText="Konum yok, haritadan se√ß";}
);
</script>

</body>
</html>
