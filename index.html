<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="config.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial;background:#000;color:#fff}
.hidden{display:none}

/* LANDING */
#landing{
  position:fixed;inset:0;
  background:#000 url("assets/landing.png") center/cover no-repeat;
  display:flex;align-items:flex-end;justify-content:center;
  padding:40px;z-index:50
}
#startBtn{
  width:100%;max-width:360px;
  padding:18px;border-radius:30px;
  border:0;font-size:18px;font-weight:900;
  background:#f5c400;color:#000;cursor:pointer
}

/* APP */
#app{display:none;height:100%}
#map{height:55vh}

/* CARDS */
.cards{padding:12px;display:grid;gap:10px}
.card{
  background:#111;border-radius:16px;padding:16px;
  border:1px solid #222;cursor:pointer
}
.card h3{margin:0 0 6px 0;color:#f5c400}

/* MODAL */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:100
}
.modal.active{display:flex}
.modalBox{
  background:#111;border-radius:18px;
  padding:20px;width:90%;max-width:360px
}
.modalBox h2{margin-top:0}
.modalBox input, .modalBox select{
  width:100%;padding:12px;margin-bottom:10px;
  border-radius:12px;border:0;background:#222;color:#fff
}
.modalBox button{
  width:100%;padding:14px;border-radius:22px;
  border:0;font-weight:900;cursor:pointer
}
.primary{background:#f5c400;color:#000}
.secondary{background:#222;color:#fff;margin-top:8px}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing">
  <button id="startBtn">BAÅžLA</button>
</div>

<!-- APP -->
<div id="app">
  <div id="map"></div>

  <div class="cards">
    <div class="card" onclick="selectService('taxi')">
      <h3>ðŸš• Taksi Ã‡aÄŸÄ±r</h3>
      <div>HÄ±zlÄ± ve gÃ¼venli yolculuk</div>
    </div>

    <div class="card" onclick="selectService('courier')">
      <h3>ðŸ“¦ Kurye</h3>
      <div>Paket ve evrak teslimi</div>
    </div>

    <div class="card" onclick="openDriverModal()">
      <h3>ðŸš— SÃ¼rÃ¼cÃ¼ mÃ¼sÃ¼n?</h3>
      <div>SepetTaxi sÃ¼rÃ¼cÃ¼sÃ¼ ol</div>
    </div>
  </div>
</div>

<!-- REGISTER MODAL -->
<div id="registerModal" class="modal">
  <div class="modalBox">
    <h2>KayÄ±t Ol</h2>
    <input id="rFirst" placeholder="Ad">
    <input id="rLast" placeholder="Soyad">
    <input id="rPhone" placeholder="05XXXXXXXXX" maxlength="11">
    <button class="primary" onclick="completeRegister()">Devam Et</button>
    <button class="secondary" onclick="closeRegister()">VazgeÃ§</button>
  </div>
</div>

<!-- DRIVER APPLY MODAL -->
<div id="driverModal" class="modal">
  <div class="modalBox">
    <h2>SÃ¼rÃ¼cÃ¼ BaÅŸvurusu</h2>
    <input id="dName" placeholder="Ad Soyad">
    <input id="dPhone" placeholder="05XXXXXXXXX" maxlength="11">
    <select id="dVehicle">
      <option value="taxi">Taksi</option>
      <option value="courier">Kurye</option>
    </select>
    <button class="primary" onclick="sendDriverApply()">BaÅŸvuruyu GÃ¶nder</button>
    <button class="secondary" onclick="closeDriverModal()">VazgeÃ§</button>
  </div>
</div>

<script>
/* ===== GLOBAL STATE ===== */
let map,userRegistered=false,selectedService=null;
let userLatLng=null;

/* ===== LANDING ===== */
document.getElementById("startBtn").onclick=()=>{
  document.getElementById("landing").style.display="none";
  document.getElementById("app").style.display="block";
  initMap();
};

/* ===== MAP ===== */
function initMap(){
  map=L.map("map").setView([40.195,29.060],12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  navigator.geolocation.getCurrentPosition(p=>{
    userLatLng={lat:p.coords.latitude,lng:p.coords.longitude};
    map.setView([userLatLng.lat,userLatLng.lng],15);
    L.marker([userLatLng.lat,userLatLng.lng]).addTo(map);
  });
}

/* ===== SERVICE SELECT ===== */
function selectService(type){
  selectedService=type;
  if(!userRegistered){
    openRegister();
    return;
  }
  if(type==="taxi"){
    alert("Taksi akÄ±ÅŸÄ± baÅŸlatÄ±lÄ±r (adres â†’ fiyat â†’ Ã§aÄŸÄ±r)");
  }else{
    alert("Kurye akÄ±ÅŸÄ± baÅŸlatÄ±lÄ±r (gÃ¶nderici/alÄ±cÄ± â†’ fiyat â†’ Ã§aÄŸÄ±r)");
  }
}

/* ===== REGISTER ===== */
function openRegister(){ document.getElementById("registerModal").classList.add("active"); }
function closeRegister(){ document.getElementById("registerModal").classList.remove("active"); }

function completeRegister(){
  const f=document.getElementById("rFirst").value.trim();
  const l=document.getElementById("rLast").value.trim();
  const p=document.getElementById("rPhone").value.trim();
  if(!f||!l||p.length!==11){ alert("Bilgiler eksik"); return; }
  userRegistered=true;
  closeRegister();
  selectService(selectedService);
}

/* ===== DRIVER APPLY ===== */
function openDriverModal(){ document.getElementById("driverModal").classList.add("active"); }
function closeDriverModal(){ document.getElementById("driverModal").classList.remove("active"); }

async function sendDriverApply(){
  const name=dName.value.trim();
  const phone=dPhone.value.trim();
  const vehicle=dVehicle.value;
  if(!name||phone.length!==11){ alert("Bilgiler eksik"); return; }

  await fetch(window.SEPT.BACKEND_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body:JSON.stringify({
      action:"ensureDriver",
      name,phone,vehicle_type:vehicle,status:"pending"
    })
  });

  alert("BaÅŸvurun alÄ±ndÄ±. Admin onayÄ± bekleniyor.");
  closeDriverModal();
}
</script>

</body>
</html>
