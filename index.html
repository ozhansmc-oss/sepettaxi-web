<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
#map{height:100%;width:100%;background:#111;display:flex;align-items:center;justify-content:center;color:#666}

#bottom{
  position:absolute;left:0;right:0;bottom:0;
  background:#0f0f10;border-top:1px solid #222;
  padding:14px
}
button{
  width:100%;padding:14px;border:0;border-radius:10px;
  background:#f5c400;color:#000;font-size:16px;font-weight:bold
}

#searchingOverlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,.85);
  display:none;align-items:center;justify-content:center;
  z-index:999
}
</style>
</head>

<body>

<div id="map">Harita</div>

<div id="bottom">
  <button onclick="callDriver()">Taksi Çağır</button>
</div>

<div id="searchingOverlay">
  <div>Sürücü aranıyor…</div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "https://script.google.com/macros/s/AKfycbwAKdSbXtKupy7Bp0gRIrB68bScvIvVjpSPFUYrDf6marNE43qm_DEHO_dPdTTroIDC/exec"; // .../exec

let searchingTimer = null;

/* ================= CALL DRIVER ================= */
function callDriver(){
  fetch(API + "?action=createJob"
    + "&service_type=taxi"
    + "&pickup_lat=40.22"
    + "&pickup_lng=28.94"
    + "&dropoff_lat=40.23"
    + "&dropoff_lng=28.95"
  )
  .then(r=>r.json())
  .then(res=>{
    if(!res.ok || !res.job_id) return;

    // JOB ID'YI SABİTLE
    localStorage.setItem("sepettaxi_job_id", res.job_id);

    // Overlay aç
    document.getElementById("searchingOverlay").style.display="flex";

    // Polling başlat
    searchingTimer = setInterval(pollJobStatus, 3000);
  })
  .catch(()=>{});
}

/* ================= POLLING ================= */
function pollJobStatus(){
  const jobId = localStorage.getItem("sepettaxi_job_id");
  if(!jobId) return;

  fetch(API + "?action=getJob&job_id=" + jobId)
    .then(r=>r.json())
    .then(d=>{
      if(!d.ok || !d.data) return;

      const st = String(d.data.status||"").toUpperCase();
      if(st === "ASSIGNED"){
        onDriverAssigned(d.data);
      }
    })
    .catch(()=>{});
}

/* ================= ASSIGNED ================= */
function onDriverAssigned(job){
  if(searchingTimer){
    clearInterval(searchingTimer);
    searchingTimer = null;
  }

  document.getElementById("searchingOverlay").style.display="none";

  // Track ekranına geç
  window.location.href = "track.html?job_id=" + job.job_id;
}
</script>

</body>
</html>
