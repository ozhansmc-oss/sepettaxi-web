<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;overflow:hidden}
:root{--y:#f5c400;--line:rgba(255,255,255,.12);--mut:rgba(255,255,255,.6)}

.topbar{
position:fixed;left:0;right:0;top:0;height:56px;z-index:50;
display:flex;align-items:center;justify-content:space-between;padding:0 14px;
background:linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.15));
backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06)
}
.brand{display:flex;align-items:center;gap:10px;font-weight:950}
.logo{
width:28px;height:28px;border-radius:10px;
background:radial-gradient(circle at 30% 30%, #ffe27a, #f5c400 55%, #b78d00 100%);
}
.iconbtn{
width:40px;height:40px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
background:rgba(20,20,22,.55);color:#fff;font-weight:900
}

.wrap{position:fixed;inset:56px 0 0 0;display:flex;flex-direction:column}
#map{flex:1}

.sheet{
background:linear-gradient(180deg, rgba(20,20,22,.92), rgba(10,10,12,.98));
border-top:1px solid rgba(255,255,255,.08);
padding:12px 14px
}

.row{display:flex;gap:10px}
.pill{
flex:1;padding:10px 12px;border-radius:16px;
border:1px solid rgba(255,255,255,.10);
background:rgba(255,255,255,.04)
}
.tag{font-size:11px;color:rgba(255,255,255,.6)}
.val{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.tabs{display:flex;gap:10px;margin-top:10px}
.tab{
flex:1;text-align:center;padding:12px;border-radius:16px;
border:1px solid rgba(255,255,255,.10);
background:rgba(255,255,255,.04);font-weight:900
}
.tab.active{border-color:rgba(245,196,0,.45);background:rgba(245,196,0,.12)}

.metrics{display:flex;gap:10px;margin-top:10px}
.metric{
flex:1;padding:12px;border-radius:16px;
border:1px solid rgba(255,255,255,.10);
background:rgba(255,255,255,.04)
}
.metric .k{font-size:11px;color:rgba(255,255,255,.55)}
.metric .v{font-size:18px;font-weight:950;margin-top:4px}

.btn{
width:100%;margin-top:10px;padding:14px;border-radius:18px;
border:0;font-weight:950;background:linear-gradient(135deg,#f5c400,#ffd34d);
color:#1a1400
}
.btn[disabled]{opacity:.45}

.driverBox{
margin-top:10px;padding:12px;border-radius:18px;
border:1px dashed rgba(245,196,0,.45);
background:rgba(245,196,0,.08);
display:flex;align-items:center;justify-content:space-between
}
.driverBox b{font-size:14px}
.driverBox a{color:#fff;font-weight:900;text-decoration:none}

.drawer{
position:fixed;top:56px;right:0;bottom:0;width:300px;
background:rgba(15,15,16,.95);backdrop-filter:blur(14px);
border-left:1px solid rgba(255,255,255,.10);
transform:translateX(110%);transition:.25s;z-index:90;padding:14px
}
.drawer.open{transform:translateX(0)}
.drawer a{
display:block;padding:12px;border-radius:16px;
border:1px solid rgba(255,255,255,.10);
background:rgba(255,255,255,.04);
margin-bottom:10px;color:#fff;text-decoration:none;font-weight:900
}

.modal{
position:fixed;inset:0;z-index:95;display:none;
background:rgba(0,0,0,.55);backdrop-filter:blur(10px);
align-items:center;justify-content:center;padding:16px
}
.mCard{
width:min(420px,94vw);
background:rgba(20,20,22,.92);
border:1px solid rgba(255,255,255,.12);
border-radius:26px;padding:16px
}
.inp{
width:100%;padding:12px;border-radius:14px;
border:1px solid rgba(255,255,255,.12);
background:rgba(255,255,255,.04);color:#fff;font-weight:800;margin-bottom:10px
}
</style>
</head>

<body>

<div class="topbar">
  <div class="brand"><div class="logo"></div>SepetTaxi</div>
  <button class="iconbtn" id="menuBtn">≡</button>
</div>

<div class="wrap">
  <div id="map"></div>

  <div class="sheet">
    <div class="row">
      <div class="pill"><div class="tag">Nereden</div><div class="val" id="fromTxt">Konum alınıyor…</div></div>
      <div class="pill"><div class="tag">Nereye</div><div class="val" id="toTxt">Haritadan seç</div></div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabTaxi">Taksi</div>
      <div class="tab" id="tabCourier">Kurye</div>
    </div>

    <div class="metrics">
      <div class="metric"><div class="k">Mesafe</div><div class="v" id="kmTxt">—</div></div>
      <div class="metric"><div class="k">Ücret</div><div class="v" id="priceTxt">—</div></div>
    </div>

    <button class="btn" id="callBtn" disabled>Çağır</button>

    <div class="driverBox">
      <b>Sürücü müsün?</b>
      <a href="driver-register.html">Sürücü Ol →</a>
    </div>
  </div>
</div>

<div class="drawer" id="drawer">
  <a href="#">Geçmiş Hizmetler</a>
  <a href="#">Sözleşmeler</a>
  <a href="#">KVKK</a>
  <a href="#">Hakkımızda</a>
  <a href="#">Destek</a>
</div>

<div class="modal" id="regModal">
  <div class="mCard">
    <h3>Zorunlu Kayıt</h3>
    <input class="inp" id="cFirst" placeholder="Ad">
    <input class="inp" id="cLast" placeholder="Soyad">
    <input class="inp" id="cPhone" placeholder="Telefon">
    <button class="btn" id="regOk">Kaydet</button>
  </div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbxxvr6OPG5R-emW8WlquzZ1psFEn6Lbvt4dDHpdN8XWO494N7uCv3s4DhLreIhO59b-/exec";
let map,from=null,to=null,service="taxi",dist=0,price=0;
const $=i=>document.getElementById(i);

function saveCustomer(o){localStorage.setItem("sepettaxi_customer",JSON.stringify(o))}
function loadCustomer(){try{return JSON.parse(localStorage.getItem("sepettaxi_customer"))}catch(_){return null}}

function initMap(){
  map=L.map("map").setView([40.195,29.060],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  navigator.geolocation?.getCurrentPosition(p=>{
    map.setView([p.coords.latitude,p.coords.longitude],15);
    rev(p.coords.latitude,p.coords.longitude).then(a=>{
      from={lat:p.coords.latitude,lng:p.coords.longitude,addr:a};
      $("fromTxt").textContent=a;
    });
  });

  map.on("click",async e=>{
    const a=await rev(e.latlng.lat,e.latlng.lng);
    if(!from){from={lat:e.latlng.lat,lng:e.latlng.lng,addr:a};$("fromTxt").textContent=a}
    else{to={lat:e.latlng.lat,lng:e.latlng.lng,addr:a};$("toTxt").textContent=a;calc()}
    ui();
  });
}

async function rev(lat,lng){
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`);
    const j=await r.json();return j.display_name||"";
  }catch(_){return ""}
}

function hav(a,b,c,d){
  const R=6371,t=x=>x*Math.PI/180;
  return 2*R*Math.asin(Math.sqrt(Math.sin(t(c-a)/2)**2+Math.cos(t(a))*Math.cos(t(c))*Math.sin(t(d-b)/2)**2));
}
function calc(){dist=hav(from.lat,from.lng,to.lat,to.lng);price=service==="courier"?Math.max(70,40+dist*18):Math.max(90,50+dist*22)}

function ui(){
  $("kmTxt").textContent=dist?dist.toFixed(2)+" km":"—";
  $("priceTxt").textContent=price?Math.round(price)+" ₺":"—";
  $("callBtn").disabled=!(from&&to);
}

function postForm(d){
  return fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/x-www-form-urlencoded"},
    body:Object.keys(d).map(k=>k+"="+encodeURIComponent(d[k])).join("&")
  }).then(r=>r.json());
}

$("menuBtn").onclick=()=>$("drawer").classList.toggle("open");
$("tabTaxi").onclick=()=>{service="taxi";$("tabTaxi").classList.add("active");$("tabCourier").classList.remove("active");calc();ui()};
$("tabCourier").onclick=()=>{service="courier";$("tabCourier").classList.add("active");$("tabTaxi").classList.remove("active");calc();ui()};

$("callBtn").onclick=async ()=>{
  const c=loadCustomer();
  if(!c){$("regModal").style.display="flex";return}
  const r=await postForm({
    action:"createJob",
    service_type:service,
    customer_first:c.customer_first,
    customer_last:c.customer_last,
    customer_phone:c.customer_phone,
    from_address:from.addr,
    to_address:to.addr,
    pickup_lat:from.lat,
    pickup_lng:from.lng,
    dropoff_lat:to.lat,
    dropoff_lng:to.lng,
    distance_km:dist,
    price:price
  });
  if(r.ok)location.href="track.html?job_id="+r.job_id;
};

$("regOk").onclick=()=>{
  saveCustomer({
    customer_first:$("cFirst").value,
    customer_last:$("cLast").value,
    customer_phone:$("cPhone").value
  });
  $("regModal").style.display="none";
};

initMap();
</script>

</body>
</html>
