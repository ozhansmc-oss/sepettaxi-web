<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial;background:#000;color:#fff;overflow:hidden}

/* LANDING */
#landing{position:fixed;inset:0;background:#000 url("assets/landing.png") center/cover no-repeat;z-index:50}
#landing .overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;flex-direction:column;align-items:center;justify-content:center}
#landing h1{font-size:38px;margin:0 0 18px}
#landing span{color:#f5c400}
#landing button{background:#f5c400;color:#000;border:0;border-radius:26px;padding:14px 42px;font-size:17px;font-weight:900;cursor:pointer}

/* APP */
#app{display:none;height:100%}
header{height:56px;background:#000;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}

/* MAP + PANEL */
#map{height:32vh}
#panel{height:calc(68vh - 56px);padding:10px;display:flex;flex-direction:column;gap:8px}

/* UI */
.card{background:#141414;border:1px solid #222;border-radius:14px;padding:10px}
.title{font-weight:900;margin-bottom:8px}
.service-row{display:flex;gap:8px}
.service{flex:1;padding:10px;border-radius:12px;text-align:center;border:1px solid #333;font-size:14px;font-weight:900;cursor:pointer;background:#0b0b0b}
.service.active{border-color:#f5c400;box-shadow:0 0 0 1px rgba(245,196,0,.35) inset}
.service small{display:block;font-weight:700;color:#aaa;margin-top:4px}

.input{width:100%;padding:12px;border-radius:12px;border:1px solid #333;background:#000;color:#fff;font-size:14px}
.row{display:flex;gap:8px}
.row .mini{flex:1;text-align:center}
.big{font-size:18px;font-weight:900}

/* Call bar (altta, kÃ¼Ã§Ã¼k, kontrollÃ¼) */
#callBar{
  display:none;
  margin-top:auto;
  background:#f5c400;color:#000;border-radius:16px;
  padding:14px;
  text-align:center;
  font-weight:900;
  cursor:pointer;
}

/* DRIVER CTA (kÃ¼Ã§Ã¼k) */
#driverCta{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);background:#0d0d0d;border:1px solid #2a2a2a;border-radius:18px;padding:6px 14px;font-size:12px;z-index:10}
#driverCta a{color:#f5c400;text-decoration:none;font-weight:900}

/* REGISTER */
#register{position:fixed;inset:0;background:rgba(0,0,0,.86);display:none;align-items:center;justify-content:center;z-index:100}
#register .box{width:90%;max-width:360px;background:#111;border:1px solid #222;border-radius:16px;padding:14px}
#register .err{color:#ff9b9b;font-size:12px;display:none;margin-top:8px}
#register .cta{background:#f5c400;color:#000;border-radius:14px;padding:14px;text-align:center;font-weight:900;margin-top:10px;cursor:pointer}

/* LOADING / SEARCHING DRIVER */
#overlay{
  position:fixed;inset:0;
  display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.78);
  z-index:120;
}
#overlay .box{
  width:90%;max-width:420px;
  background:#0f0f0f;border:1px solid #222;border-radius:18px;
  padding:16px;text-align:center;
}
.spinner{
  width:38px;height:38px;border-radius:50%;
  border:4px solid #2a2a2a;border-top-color:#f5c400;
  margin:12px auto;
  animation:spin 0.9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.muted{color:#aaa;font-size:13px;line-height:1.35}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button onclick="start()">BAÅžLA</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>Sepet<span>Taxi</span></header>
  <div id="map"></div>

  <div id="panel">

    <div class="card">
      <div class="title">Hizmet SeÃ§</div>
      <div class="service-row">
        <div id="svcTaxi" class="service" onclick="pickService('taxi')">
          ðŸš• Taksi
          <small>Hemen Ã§aÄŸÄ±r</small>
        </div>
        <div id="svcCourier" class="service" onclick="pickService('courier')">
          ðŸ“¦ Kurye
          <small>GÃ¶nderi teslim</small>
        </div>
      </div>
    </div>

    <div class="card">
      <input id="fromAddr" class="input" readonly placeholder="Nereden (Konum otomatik)">
    </div>

    <div class="card">
      <input id="toAddr" class="input" readonly placeholder="Nereye (Haritadan seÃ§)">
    </div>

    <div id="courierBox" class="card" style="display:none">
      <div class="title">Kurye Bilgileri</div>
      <input id="pkgType" class="input" placeholder="Paket TÃ¼rÃ¼ (Ã¶rn: evrak, paket)">
      <div style="height:8px"></div>
      <input id="recvName" class="input" placeholder="AlÄ±cÄ± AdÄ± SoyadÄ±">
      <div style="height:8px"></div>
      <input id="recvPhone" class="input" placeholder="AlÄ±cÄ± Telefon (05XXXXXXXXX)" maxlength="11" inputmode="tel">
    </div>

    <div class="row">
      <div class="card mini">
        <div class="muted">Mesafe</div>
        <div id="dist" class="big">â€”</div>
      </div>
      <div class="card mini">
        <div class="muted">Ãœcret</div>
        <div id="price" class="big">â€”</div>
      </div>
    </div>

    <div id="callBar" onclick="callDriver()">Ã‡AÄžIR</div>
  </div>
</div>

<div id="driverCta">ðŸš— SÃ¼rÃ¼cÃ¼ mÃ¼sÃ¼n? <a href="driver.html">TÄ±kla</a></div>

<!-- REGISTER -->
<div id="register">
  <div class="box">
    <div class="title">Zorunlu KayÄ±t</div>
    <input id="fn" class="input" placeholder="Ad">
    <div style="height:8px"></div>
    <input id="ln" class="input" placeholder="Soyad">
    <div style="height:8px"></div>
    <input id="ph" class="input" placeholder="05XXXXXXXXX" maxlength="11" inputmode="tel">
    <div style="height:10px"></div>
    <label style="font-size:12px;color:#ddd"><input type="checkbox" id="kvkk"> KVKK kabul ediyorum</label>
    <div id="regErr" class="err">Bilgiler hatalÄ±. Telefon 11 hane ve 05 ile baÅŸlamalÄ±.</div>
    <div class="cta" onclick="saveUser()">KAYDI TAMAMLA</div>
  </div>
</div>

<!-- SEARCHING DRIVER OVERLAY -->
<div id="overlay">
  <div class="box">
    <div style="font-weight:900;font-size:18px">SÃ¼rÃ¼cÃ¼ aranÄ±yorâ€¦</div>
    <div class="spinner"></div>
    <div class="muted">
      Talebiniz alÄ±ndÄ±. En yakÄ±n sÃ¼rÃ¼cÃ¼ye yÃ¶nlendiriyoruz.<br>
      Takip ekranÄ±na yÃ¶nlendiriliyorsunuzâ€¦
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG (SABÄ°T)
   ========================= */
const BACKEND = "https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";
const TRACK_REL = "track.html"; // aynÄ± klasÃ¶rde

let map, fromM, toM;
let service = null;
let registered = false;
let user = null;

/* =========================
   START
   ========================= */
function start(){
  landing.style.display="none";
  app.style.display="block";
  initMap();
}

/* =========================
   MAP
   ========================= */
function initMap(){
  map = L.map("map").setView([40.19, 29.06], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  // Geolocation
  navigator.geolocation.getCurrentPosition(
    p=>{
      const {latitude,longitude}=p.coords;
      fromM = L.marker([latitude,longitude]).addTo(map);
      map.setView([latitude,longitude],15);
      reverse(latitude,longitude,fromAddr);
    },
    _=>{
      // izin yoksa bile harita Ã§alÄ±ÅŸsÄ±n
      fromAddr.value = "Konum izni verilmedi (haritadan seÃ§ebilirsiniz)";
    },
    { enableHighAccuracy:true, timeout:8000 }
  );

  // Click -> to marker
  map.on("click", e=>{
    toM ? toM.setLatLng(e.latlng) : (toM=L.marker(e.latlng).addTo(map));
    reverse(e.latlng.lat, e.latlng.lng, toAddr);
    calc();
  });
}

/* =========================
   SERVICE
   ========================= */
function pickService(t){
  // KayÄ±t zorunlu
  if(!registered){
    openRegister();
    return;
  }

  service = t;
  svcTaxi.classList.toggle("active", t==="taxi");
  svcCourier.classList.toggle("active", t==="courier");

  courierBox.style.display = (t==="courier") ? "block" : "none";

  // callBar aktif
  callBar.style.display = "block";
  callBar.innerText = (t==="taxi") ? "TAKSÄ° Ã‡AÄžIR" : "KURYE Ã‡AÄžIR";

  calc();
}

/* =========================
   REGISTER
   ========================= */
function openRegister(){
  app.style.pointerEvents="none";
  register.style.display="flex";
}
function cleanPhone(v){ return (v||"").replace(/\D/g,""); }
function saveUser(){
  const f = (fn.value||"").trim();
  const l = (ln.value||"").trim();
  const p = cleanPhone(ph.value);

  if(f.length<2 || l.length<2 || !/^05\d{9}$/.test(p) || !kvkk.checked){
    regErr.style.display="block";
    return;
  }
  regErr.style.display="none";
  user = { f, l, p };
  registered = true;

  register.style.display="none";
  app.style.pointerEvents="auto";
}

/* =========================
   CALC
   ========================= */
function calc(){
  if(!service || !fromM || !toM) return;

  const a = fromM.getLatLng(), b = toM.getLatLng();
  const km = haversine(a.lat,a.lng,b.lat,b.lng);
  dist.textContent = km.toFixed(2) + " km";

  const pr = (service==="taxi")
    ? Math.max(120, 60 + km*22)
    : Math.max(80,  40 + km*15);

  price.textContent = Math.round(pr) + " TL";
}

/* =========================
   CALL -> createJob -> redirect track
   ========================= */
async function callDriver(){
  // validasyon
  if(!registered) return openRegister();
  if(!service) return alert("Hizmet seÃ§melisin.");
  if(!fromM) return alert("Konum alÄ±namadÄ±. Konum izni ver veya yeniden dene.");
  if(!toM || !toAddr.value || toAddr.value.length<3) return alert("Nereye seÃ§melisin (haritadan tÄ±kla).");

  // Kurye alanlarÄ±
  const package_type = (pkgType?.value||"").trim();
  const receiver_name = (recvName?.value||"").trim();
  const receiver_phone = cleanPhone(recvPhone?.value||"");

  if(service==="courier"){
    if(package_type.length<2) return alert("Kurye iÃ§in Paket TÃ¼rÃ¼ zorunlu.");
    if(receiver_name.length<2) return alert("Kurye iÃ§in AlÄ±cÄ± AdÄ± zorunlu.");
    if(!/^05\d{9}$/.test(receiver_phone)) return alert("Kurye iÃ§in AlÄ±cÄ± Telefon 05XXXXXXXXX olmalÄ±.");
  }

  // deÄŸerler
  const a = fromM.getLatLng(), b = toM.getLatLng();
  const km = haversine(a.lat,a.lng,b.lat,b.lng);
  const basePrice = (service==="taxi")
    ? Math.max(120, 60 + km*22)
    : Math.max(80,  40 + km*15);

  // Overlay gÃ¶ster
  overlay.style.display="flex";
  callBar.style.pointerEvents="none";
  callBar.style.opacity=".7";

  try{
    const params = new URLSearchParams({
      action: "createJob",
      service_type: service,
      customer_first: user.f,
      customer_last: user.l,
      customer_phone: user.p,
      from_address: fromAddr.value || "",
      to_address: toAddr.value || "",
      distance_km: String(km.toFixed(3)),
      price: String(Math.round(basePrice)),
      final_price: String(Math.round(basePrice)),
      package_type,
      receiver_name,
      receiver_phone
    });

    // GET only (CORS safe)
    const url = BACKEND + (BACKEND.includes("?") ? "&" : "?") + params.toString();
    const r = await fetch(url, { method:"GET" });
    const j = await r.json();

    if(!j.ok){
      throw new Error(j.error || "createJob baÅŸarÄ±sÄ±z");
    }

    const job_id = j.job_id;
    const token = j.track_token;

    // 1-1.5 sn sonra track'e git (animasyon gÃ¶zÃ¼ksÃ¼n)
    setTimeout(()=>{
      const base = location.href.replace(/\/[^\/]*$/, "/"); // klasÃ¶r baz
      const trackUrl = base + TRACK_REL + "?job_id=" + encodeURIComponent(job_id) + "&token=" + encodeURIComponent(token);
      location.href = trackUrl;
    }, 1200);

  }catch(e){
    console.error(e);
    overlay.style.display="none";
    callBar.style.pointerEvents="auto";
    callBar.style.opacity="1";
    alert("Talep gÃ¶nderilemedi: " + (e.message||e));
  }
}

/* =========================
   UTIL
   ========================= */
function haversine(a,b,c,d){
  const R=6371, dLat=(c-a)*Math.PI/180, dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function reverse(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
    .then(r=>r.json())
    .then(d=>{ if(d && d.display_name) input.value=d.display_name; })
    .catch(_=>{});
}
</script>

</body>
</html>
