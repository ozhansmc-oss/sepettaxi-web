<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  font-family:Arial,Helvetica,sans-serif;
  background:#000;color:#fff;overflow:hidden
}

/* ===== LANDING ===== */
#landing{
  position:fixed;inset:0;
  background:#000 url("assets/landing.png") center/cover no-repeat;
  z-index:2000
}
#landing .overlay{
  position:absolute;inset:0;
  background:rgba(0,0,0,.65);
  display:flex;flex-direction:column;
  align-items:center;justify-content:center
}
#landing h1{font-size:40px;margin-bottom:18px}
#landing span{color:#f5c400}
#landing button{
  background:#f5c400;color:#000;border:0;
  border-radius:28px;padding:14px 46px;
  font-size:17px;font-weight:900;
  box-shadow:0 10px 30px rgba(245,196,0,.4)
}

/* ===== HEADER ===== */
header{
  height:56px;background:#000;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:900;
  position:relative;
  z-index:100
}
header span{color:#f5c400}
#hamburger{
  position:absolute;left:14px;
  font-size:22px;cursor:pointer;
}

/* ===== HAMBURGER MENU ===== */
#menuBackdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.5);
  z-index:900;display:none
}
#sideMenu{
  position:fixed;top:0;left:-260px;
  width:240px;height:100%;
  background:#0f0f0f;
  z-index:1000;
  padding:16px;
  transition:.25s
}
#sideMenu.open{left:0}
#menuBackdrop.open{display:block}
.menuItem{
  padding:14px;border-radius:12px;
  margin-bottom:10px;
  background:#141414;
  cursor:pointer
}

/* ===== APP ===== */
#app{display:none;height:100%}

/* ===== MAP ===== */
#map{height:32vh}

/* ===== PANEL ===== */
#panel{
  height:calc(68vh - 56px);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding-bottom:90px
}
.card{
  background:linear-gradient(180deg,#141414,#0f0f0f);
  border-radius:14px;
  padding:10px
}

/* ===== SERVICES ===== */
.service-row{display:flex;gap:8px}
.service{
  flex:1;padding:10px;border-radius:12px;
  text-align:center;font-size:13px;
  border:1px solid #222;color:#aaa
}
.service.active{
  border-color:#f5c400;color:#fff
}

/* ===== INPUT ===== */
.input{
  width:100%;padding:10px 12px;
  border-radius:12px;border:1px solid #1f1f1f;
  background:#000;color:#fff
}

/* ===== STATS ===== */
.stats{display:flex;gap:8px}
.stat{
  flex:1;background:#111;
  border-radius:14px;padding:12px;
  text-align:center
}
.stat .lbl{font-size:11px;color:#aaa}
.stat .val{font-size:18px;font-weight:900}

/* ===== STICKY CTA ===== */
#stickyBar{
  position:fixed;bottom:0;left:0;right:0;
  background:#000;padding:10px;z-index:200
}
#callBar{
  background:#f5c400;color:#000;
  border-radius:30px;padding:16px;
  text-align:center;font-weight:900
}

/* ===== REGISTER ===== */
#register{
  position:fixed;inset:0;
  background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;
  z-index:1500
}
#register .box{
  width:88%;max-width:340px;
  background:#0f0f0f;
  border-radius:16px;padding:14px
}
.err{color:#ff5c5c;font-size:12px;display:none}
.app-locked{filter:blur(4px);pointer-events:none}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button onclick="start()">BA≈ûLA</button>
  </div>
</div>

<!-- HAMBURGER -->
<div id="menuBackdrop" onclick="closeMenu()"></div>
<div id="sideMenu">
  <div class="menuItem" onclick="goDriverRegister()">üöó S√ºr√ºc√º Ol</div>
  <div class="menuItem" onclick="goDriver()">üßë‚Äç‚úàÔ∏è S√ºr√ºc√º m√ºs√ºn?</div>
</div>

<!-- APP -->
<div id="app">
  <header>
    <div id="hamburger" onclick="toggleMenu()">‚ò∞</div>
    Sepet<span>Taxi</span>
  </header>

  <div id="map"></div>

  <div id="panel">
    <div class="card">
      <b>Hizmet Se√ß</b>
      <div class="service-row">
        <div id="svcTaxi" class="service" onclick="pickService('taxi')">üöï Taksi</div>
        <div id="svcCourier" class="service" onclick="pickService('courier')">üì¶ Kurye</div>
      </div>
    </div>

    <div class="card"><input id="fromAddr" class="input" readonly placeholder="Nereden"></div>
    <div class="card"><input id="toAddr" class="input" readonly placeholder="Nereye"></div>

    <div id="courierBox" class="card" style="display:none">
      <input class="input" placeholder="Paket T√ºr√º">
      <input class="input" placeholder="Alƒ±cƒ± Adƒ±">
      <input class="input" placeholder="Alƒ±cƒ± Telefon" maxlength="11">
    </div>

    <div class="stats">
      <div class="stat"><div class="lbl">Mesafe</div><div id="dist" class="val">‚Äî</div></div>
      <div class="stat"><div class="lbl">√úcret</div><div id="price" class="val">‚Äî</div></div>
    </div>
  </div>
</div>

<!-- CTA -->
<div id="stickyBar">
  <div id="callBar" onclick="callDriver()">√áAƒûIR</div>
</div>

<!-- REGISTER -->
<div id="register">
  <div class="box">
    <input id="fn" class="input" placeholder="Ad">
    <input id="ln" class="input" placeholder="Soyad">
    <input id="ph" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <label style="font-size:12px">
      <input type="checkbox" id="kvkk"> KVKK kabul
    </label>
    <div id="regErr" class="err">Bilgiler hatalƒ±</div>
    <div id="callBar" style="margin-top:10px" onclick="saveUser()">KAYDI TAMAMLA</div>
  </div>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

let map,fromM,toM,service=null,registered=false;
let menuOpen=false;

function start(){
  landing.style.display="none";
  app.style.display="block";
  initMap();
}

function toggleMenu(){menuOpen?closeMenu():openMenu()}
function openMenu(){
  sideMenu.classList.add("open");
  menuBackdrop.classList.add("open");
  menuOpen=true;
}
function closeMenu(){
  sideMenu.classList.remove("open");
  menuBackdrop.classList.remove("open");
  menuOpen=false;
}
function goDriverRegister(){closeMenu();location.href="driver-register.html"}
function goDriver(){closeMenu();location.href="driver.html"}

function initMap(){
  map=L.map("map").setView([41,29],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  navigator.geolocation.getCurrentPosition(p=>{
    fromM=L.marker([p.coords.latitude,p.coords.longitude]).addTo(map);
    map.setView([p.coords.latitude,p.coords.longitude],15);
    reverse(p.coords.latitude,p.coords.longitude,fromAddr);
  });
  map.on("click",e=>{
    toM?toM.setLatLng(e.latlng):toM=L.marker(e.latlng).addTo(map);
    reverse(e.latlng.lat,e.latlng.lng,toAddr);
    calc();
  });
}

function pickService(t){
  if(!registered){openRegister();return;}
  service=t;
  svcTaxi.classList.toggle("active",t==="taxi");
  svcCourier.classList.toggle("active",t==="courier");
  courierBox.style.display=t==="courier"?"block":"none";
  calc();
}

function openRegister(){
  app.classList.add("app-locked");
  register.style.display="flex";
}

function saveUser(){
  if(fn.value.length<2||ln.value.length<2||!/^05\d{9}$/.test(ph.value)||!kvkk.checked){
    regErr.style.display="block";return;
  }
  registered=true;
  register.style.display="none";
  app.classList.remove("app-locked");
}

function calc(){
  if(!service||!fromM||!toM)return;
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=h(a.lat,a.lng,b.lat,b.lng);
  dist.textContent=km.toFixed(2)+" km";
  price.textContent=Math.round(service==="taxi"?Math.max(120,60+km*22):Math.max(80,40+km*15))+" TL";
}

<script>
async function callDriver(){
  if(!registered || !service || !fromM || !toM){
    alert("Bilgiler eksik");
    return;
  }

  const a = fromM.getLatLng();
  const b = toM.getLatLng();
  const km = h(a.lat,a.lng,b.lat,b.lng);
  const price = Math.round(
    service==="taxi"
      ? Math.max(120,60+km*22)
      : Math.max(80,40+km*15)
  );

  const payload = {
    action: "createJob",
    service_type: service,
    customer_first: fn?.value || "",
    customer_last: ln?.value || "",
    customer_phone: ph?.value || "",
    from_address: fromAddr.value,
    to_address: toAddr.value,
    pickup_lat: a.lat,
    pickup_lng: a.lng,
    dropoff_lat: b.lat,
    dropoff_lng: b.lng,
    distance_km: km,
    price: price,
    final_price: price
  };

  try{
    const res = await fetch(BACKEND_URL,{
      method:"POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    }).then(r=>r.json());

    if(!res.ok){
      alert("ƒ∞≈ü olu≈üturulamadƒ±");
      return;
    }

    // üîí TRACK Bƒ∞LGƒ∞LERƒ∞
    sessionStorage.setItem("SEPT_job_id",res.job_id);
    sessionStorage.setItem("SEPT_track_token",res.track_token);
    sessionStorage.setItem("SEPT_pickup_lat",a.lat);
    sessionStorage.setItem("SEPT_pickup_lng",a.lng);
    sessionStorage.setItem("SEPT_drop_lat",b.lat);
    sessionStorage.setItem("SEPT_drop_lng",b.lng);

    // ‚ûú TRACK
    location.href =
      "track.html?job_id="+encodeURIComponent(res.job_id)+
      "&track_token="+encodeURIComponent(res.track_token);

  }catch(e){
    alert("Baƒülantƒ± hatasƒ±");
  }
}
</script>


function h(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function reverse(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
  .then(r=>r.json()).then(d=>{if(d.display_name)input.value=d.display_name});
}
</script>

</body>
</html>
