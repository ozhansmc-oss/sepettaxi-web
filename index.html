<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SepetTaxi MVP</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f1620;
      --card2:#101a27;
      --text:#e9eef5;
      --muted:#9fb0c3;
      --line:rgba(255,255,255,.10);
      --accent:#ffffff;
      --danger:#ff5a6a;
      --ok:#43d17a;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background:var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit}
    .hidden{display:none !important;}
    .app{min-height:100vh; display:flex; flex-direction:column;}
    .safe{padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);}

    /* Landing */
    .landing{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;
    }
    .hero{
      width:min(720px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:28px;
      box-shadow:var(--shadow);
      padding:26px;
    }
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:18px;
    }
    .logo{
      width:44px; height:44px; border-radius:14px;
      background:rgba(255,255,255,.12);
      border:1px solid var(--line);
      display:flex; align-items:center; justify-content:center;
      font-weight:800;
    }
    .title{
      font-size:clamp(24px, 3.2vw, 34px);
      line-height:1.15;
      margin:8px 0 10px 0;
      letter-spacing:-0.3px;
    }
    .subtitle{
      color:var(--muted);
      margin:0 0 18px 0;
      line-height:1.5;
      font-size:15px;
    }
    .ctaRow{display:flex; gap:12px; flex-wrap:wrap;}
    .btn{
      appearance:none; border:none; cursor:pointer;
      border-radius:16px;
      padding:14px 16px;
      font-weight:700;
      font-size:15px;
      width:100%;
    }
    .btnPrimary{background:var(--accent); color:#0b0f14;}
    .btnGhost{background:transparent; color:var(--text); border:1px solid var(--line);}
    .fine{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.45;
    }

    /* Main layout */
    .main{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header.topbar{
      padding:14px 16px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(11,15,20,.75);
      backdrop-filter: blur(10px);
      position:sticky; top:0; z-index:5;
    }
    .topbarRow{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .topbarTitle{font-weight:800; letter-spacing:-.2px;}
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.04);
      white-space:nowrap;
    }

    #map{
      width:100%;
      height:40vh; /* default mobile */
      background:#0a0f16;
      border-bottom:1px solid var(--line);
    }
    @media (min-width: 700px){
      #map{height:45vh;}
      .btn{width:auto;}
      .ctaRow .btn{min-width:180px;}
    }
    @media (min-width: 1024px){
      #map{height:50vh;}
    }

    .panel{
      flex:1;
      padding:14px 14px 18px;
      overflow:auto;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
      padding:14px;
      margin-bottom:12px;
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:15px;
      letter-spacing:-.2px;
    }
    .muted{color:var(--muted); font-size:13px; line-height:1.45;}
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 420px){
      .grid{grid-template-columns:1fr;}
    }

    .service{
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.035);
      padding:12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .08s ease, background .08s ease;
      min-height:86px;
      display:flex; flex-direction:column; justify-content:space-between;
      user-select:none;
    }
    .service:hover{transform:translateY(-1px); border-color:rgba(255,255,255,.18);}
    .service.disabled{opacity:.35; cursor:not-allowed; transform:none;}
    .service.selected{
      border-color:rgba(255,255,255,.38);
      background:rgba(255,255,255,.08);
    }
    .serviceName{font-weight:800; font-size:14px;}
    .serviceMeta{color:var(--muted); font-size:12px; margin-top:2px;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .rowRight{margin-left:auto;}
    .miniBtn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--text);
      font-weight:750;
      cursor:pointer;
    }
    .miniBtn:disabled{opacity:.45; cursor:not-allowed;}
    .miniBtn.primary{background:var(--accent); color:#0b0f14; border-color:transparent;}
    .miniBtn.danger{border-color:rgba(255,90,106,.4);}

    .field{display:flex; flex-direction:column; gap:6px; margin-top:10px;}
    label{font-size:12px; color:var(--muted);}
    input, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:74px; resize:vertical;}
    .err{color:var(--danger); font-size:12px; margin-top:6px;}
    .ok{color:var(--ok); font-size:12px; margin-top:6px;}
    .divider{height:1px; background:var(--line); margin:12px 0;}
    .kvkk{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      margin-top:12px;
    }
    .kvkk input{width:18px; height:18px; margin-top:2px;}
    details{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background:rgba(255,255,255,.03);
      margin-top:10px;
    }
    summary{cursor:pointer; font-weight:800; font-size:13px;}
    details .muted{margin-top:8px;}

    .statusBar{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .chip{
      border:1px solid var(--line);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      color:var(--muted);
      background:rgba(255,255,255,.04);
    }
    .chip strong{color:var(--text); font-weight:800;}
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.45;
    }

    .toast{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:18px;
      width:min(560px, calc(100% - 24px));
      z-index:50;
      background:rgba(15,22,32,.92);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:12px 14px;
      display:none;
    }
    .toast.show{display:block;}
    .toastTitle{font-weight:850; margin:0 0 4px 0;}
    .toastMsg{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}
    .spinner{
      display:inline-block;
      width:14px; height:14px;
      border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.95);
      border-radius:50%;
      animation: spin 0.7s linear infinite;
      vertical-align:-2px;
      margin-right:8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>

<body class="safe">
  <!-- LANDING -->
  <section id="landing" class="landing">
    <div class="hero">
      <div class="brand">
        <div class="logo">ST</div>
        <div class="pill">MVP v1 • Tek Endpoint</div>
      </div>
      <h1 class="title">SepetTaxi ile tek dokunuşla hizmet çağır.</h1>
      <p class="subtitle">
        Konumunu alır, mesafeyi ve ücreti net gösterir. Onay sonrası çağrın sisteme düşer.
      </p>
      <div class="ctaRow">
        <button id="btnStart" class="btn btnPrimary">Başla</button>
        <button id="btnInfo" class="btn btnGhost" type="button">Nasıl çalışır?</button>
      </div>
      <p class="fine">
        Başla’ya basınca konum izni istenir. Konum paylaşmazsan harita varsayılan merkezde açılır.
      </p>
    </div>
  </section>

  <!-- MAIN -->
  <section id="main" class="main hidden">
    <header class="topbar">
      <div class="topbarRow">
        <div class="topbarTitle">SepetTaxi</div>
        <div class="pill" id="pillGeo">Konum: bekleniyor</div>
      </div>
    </header>

    <div id="map" aria-label="Harita"></div>

    <div class="panel">
      <!-- SERVICES -->
      <div class="card">
        <h3>Hizmet Seçimi</h3>
        <div class="muted">Tek seçim. Değiştirmek için “Seçimi Değiştir”.</div>

        <div class="divider"></div>

        <div class="grid" id="serviceGrid">
          <!-- Filled by JS -->
        </div>

        <div class="row" style="margin-top:12px;">
          <button id="btnChangeService" class="miniBtn danger hidden" type="button">Seçimi Değiştir</button>
          <div class="rowRight"></div>
          <span class="chip" id="chipService">Hizmet: <strong>-</strong></span>
        </div>

        <p class="hint">
          Hedef noktayı harita üzerinde seçmek için haritaya tıklayın. (Pickup = mevcut konum.)
        </p>
      </div>

      <!-- ROUTE + PRICE -->
      <div class="card">
        <h3>Mesafe & Ücret</h3>
        <div class="muted">Mesafe ve ücret oluşmadan “Çağır” aktif olmaz.</div>

        <div class="statusBar">
          <span class="chip">Pickup: <strong id="pickupText">-</strong></span>
          <span class="chip">Hedef: <strong id="dropText">-</strong></span>
          <span class="chip">Mesafe: <strong id="distText">-</strong></span>
          <span class="chip">Ücret: <strong id="priceText">-</strong></span>
        </div>

        <div class="field">
          <label for="pickupNote">Adres/Not (opsiyonel)</label>
          <textarea id="pickupNote" placeholder="Bina adı, kat, kapı no, tarif..."></textarea>
        </div>

        <p class="hint" id="calcHint">
          Hizmet seçin + haritada hedef seçin. Sistem mesafe ve ücreti otomatik hesaplar.
        </p>
      </div>

      <!-- REQUIRED REGISTRATION (only after service selected) -->
      <div id="regCard" class="card hidden">
        <h3>Zorunlu Kayıt</h3>
        <div class="muted">Hizmet seçimi sonrası görünür. Telefon daha önce yoksa kaydedilir; varsa tekrar yazılmaz.</div>

        <div class="field">
          <label for="name">Ad Soyad</label>
          <input id="name" type="text" inputmode="text" autocomplete="name" placeholder="Örn: Özhan Samurcu"/>
        </div>

        <div class="field">
          <label for="phone">Telefon (11 hane, 0 ile başlar)</label>
          <input id="phone" type="tel" inputmode="tel" autocomplete="tel" placeholder="0XXXXXXXXXX"/>
          <div id="phoneErr" class="err hidden">Telefon formatı hatalı. Örn: 05320000000</div>
        </div>

        <details>
          <summary>KVKK Aydınlatma Metni</summary>
          <div class="muted">
            Bu MVP’de amaç, hizmet talebinizi operasyonel olarak iletmektir. Kişisel verileriniz (ad, telefon, konum verisi)
            yalnızca hizmetin sağlanması ve çağrı kaydının oluşturulması amacıyla işlenir. Detaylı metin nihai sürümde
            kurumsal metinle güncellenecektir.
          </div>
        </details>

        <details>
          <summary>Hizmet Sözleşmesi</summary>
          <div class="muted">
            SepetTaxi, hizmet talebinizi sisteme ileten dijital bir aracıdır. Ücret, mesafe/parametre bazlı hesaplanan
            tahmini bedeldir. Operasyonel onay ve hizmet koşulları nihai sürümde detaylandırılacaktır.
          </div>
        </details>

        <div class="kvkk">
          <input id="kvkkCheck" type="checkbox"/>
          <div>
            <div style="font-weight:850;">Okudum, onaylıyorum.</div>
            <div class="muted">KVKK ve sözleşme onayı zorunludur.</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button id="btnCall" class="miniBtn primary" type="button" disabled>Çağır</button>
          <span id="callState" class="muted"></span>
        </div>

        <div id="callOk" class="ok hidden">Çağrı başarıyla oluşturuldu.</div>
        <div id="callErr" class="err hidden"></div>
      </div>
    </div>
  </section>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <div class="toastTitle" id="toastTitle">Bilgi</div>
    <p class="toastMsg" id="toastMsg"></p>
  </div>

<script>
/** =========================
 *  CONFIG
 *  ========================= */
const BACKEND_URL = "PASTE_YOUR_EXEC_URL_HERE"; // örn: https://script.google.com/macros/s/XXXX/exec

// Hizmet fiyat parametreleri (MVP)
const SERVICE_RULES = {
  taxi:   { label: "Taksi",        base: 60, perKm: 18, min: 90, meta: "Şehir içi hızlı" },
  courier:{ label: "Kurye",        base: 55, perKm: 16, min: 85, meta: "Motorlu kurye" },
  van:    { label: "Araçlı Kurye", base: 75, perKm: 20, min: 120, meta: "Hacimli gönderi" },
  transfer:{label: "Transfer",     base: 120, perKm: 28, min: 180, meta: "Planlı / VIP" }
};

// Timeouts (sonsuz işlem yok)
const GEO_TIMEOUT_MS = 12000;
const API_TIMEOUT_MS = 15000;

let map, userMarker, dropMarker;
let pickup = null;   // {lat, lng}
let dropoff = null;  // {lat, lng}
let selectedService = null;
let computed = {distanceKm: null, price: null};

const els = {
  landing: document.getElementById("landing"),
  main: document.getElementById("main"),
  btnStart: document.getElementById("btnStart"),
  btnInfo: document.getElementById("btnInfo"),
  pillGeo: document.getElementById("pillGeo"),
  serviceGrid: document.getElementById("serviceGrid"),
  btnChangeService: document.getElementById("btnChangeService"),
  chipService: document.getElementById("chipService"),
  pickupText: document.getElementById("pickupText"),
  dropText: document.getElementById("dropText"),
  distText: document.getElementById("distText"),
  priceText: document.getElementById("priceText"),
  calcHint: document.getElementById("calcHint"),
  regCard: document.getElementById("regCard"),
  name: document.getElementById("name"),
  phone: document.getElementById("phone"),
  phoneErr: document.getElementById("phoneErr"),
  kvkkCheck: document.getElementById("kvkkCheck"),
  btnCall: document.getElementById("btnCall"),
  callState: document.getElementById("callState"),
  callOk: document.getElementById("callOk"),
  callErr: document.getElementById("callErr"),
  pickupNote: document.getElementById("pickupNote"),
  toast: document.getElementById("toast"),
  toastTitle: document.getElementById("toastTitle"),
  toastMsg: document.getElementById("toastMsg")
};

function toast(title, msg){
  els.toastTitle.textContent = title;
  els.toastMsg.textContent = msg;
  els.toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>els.toast.classList.remove("show"), 4200);
}

function setChipService(text){
  const strong = els.chipService.querySelector("strong");
  strong.textContent = text;
}

function fmtLatLng(p){
  if(!p) return "-";
  return `${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}`;
}

function fmtKm(km){
  if(km == null) return "-";
  return `${km.toFixed(2)} km`;
}

function fmtPrice(p){
  if(p == null) return "-";
  return `${Math.round(p)} TL`;
}

/** =========================
 *  UI BUILD
 *  ========================= */
function buildServiceCards(){
  els.serviceGrid.innerHTML = "";
  const entries = Object.entries(SERVICE_RULES);
  for(const [key, rule] of entries){
    const div = document.createElement("div");
    div.className = "service";
    div.dataset.service = key;
    div.innerHTML = `
      <div>
        <div class="serviceName">${rule.label}</div>
        <div class="serviceMeta">${rule.meta}</div>
      </div>
      <div class="serviceMeta">Taban: ${rule.base} • km: ${rule.perKm} • min: ${rule.min}</div>
    `;
    div.addEventListener("click", () => onSelectService(key));
    els.serviceGrid.appendChild(div);
  }
}

function lockOtherServices(selectedKey){
  const cards = [...els.serviceGrid.querySelectorAll(".service")];
  for(const c of cards){
    const k = c.dataset.service;
    c.classList.toggle("selected", k === selectedKey);
    const disabled = (k !== selectedKey);
    c.classList.toggle("disabled", disabled);
  }
  els.btnChangeService.classList.remove("hidden");
}

function unlockServices(){
  const cards = [...els.serviceGrid.querySelectorAll(".service")];
  for(const c of cards){
    c.classList.remove("selected");
    c.classList.remove("disabled");
  }
  els.btnChangeService.classList.add("hidden");
}

/** =========================
 *  MAP + GEO
 *  ========================= */
function initMap(){
  map = L.map("map", { zoomControl:true });
  const tiles = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap"
  });
  tiles.addTo(map);

  // Default center (Bursa)
  map.setView([40.195, 29.060], 13);

  map.on("click", (e) => {
    dropoff = {lat: e.latlng.lat, lng: e.latlng.lng};
    if(!dropMarker){
      dropMarker = L.marker([dropoff.lat, dropoff.lng]).addTo(map).bindPopup("Hedef").openPopup();
    }else{
      dropMarker.setLatLng([dropoff.lat, dropoff.lng]);
    }
    els.dropText.textContent = fmtLatLng(dropoff);
    computeIfPossible();
  });
}

function requestGeolocation(){
  return new Promise((resolve, reject) => {
    if(!navigator.geolocation){
      reject(new Error("Tarayıcı konum desteği yok."));
      return;
    }

    let done = false;
    const timer = setTimeout(() => {
      if(done) return;
      done = true;
      reject(new Error("Konum alınamadı (zaman aşımı)."));
    }, GEO_TIMEOUT_MS);

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        if(done) return;
        done = true;
        clearTimeout(timer);
        resolve(pos);
      },
      (err) => {
        if(done) return;
        done = true;
        clearTimeout(timer);
        reject(new Error(err.message || "Konum alınamadı."));
      },
      { enableHighAccuracy:true, timeout:GEO_TIMEOUT_MS, maximumAge: 5000 }
    );
  });
}

function setPickup(lat, lng){
  pickup = {lat, lng};
  els.pickupText.textContent = fmtLatLng(pickup);
  els.pillGeo.textContent = "Konum: alındı";
  if(!userMarker){
    userMarker = L.marker([lat, lng]).addTo(map).bindPopup("Pickup (Siz)").openPopup();
  }else{
    userMarker.setLatLng([lat, lng]);
  }
  map.setView([lat, lng], 15);
}

/** =========================
 *  SERVICE SELECTION
 *  ========================= */
function onSelectService(serviceKey){
  if(selectedService) return; // tek seçim kilidi

  selectedService = serviceKey;
  lockOtherServices(serviceKey);
  setChipService(SERVICE_RULES[serviceKey].label);

  // Zorunlu kayıt alanları sadece hizmet seçilince görünür
  els.regCard.classList.remove("hidden");

  // Kullanıcıya yönlendirme
  toast("Hizmet seçildi", "Hedef noktayı haritada tıklayarak seçin. Mesafe ve ücret otomatik hesaplanır.");

  // hesap şartları değişti
  computed = {distanceKm:null, price:null};
  updateComputedUI();
  validateAll();
}

els.btnChangeService.addEventListener("click", () => {
  selectedService = null;
  unlockServices();
  setChipService("-");
  // kayıt alanları gizlenir (spec)
  els.regCard.classList.add("hidden");
  // hesaplar sıfırlanır
  computed = {distanceKm:null, price:null};
  updateComputedUI();
  validateAll();
});

/** =========================
 *  DISTANCE + PRICE
 *  ========================= */
function haversineKm(a, b){
  const R = 6371;
  const toRad = (x)=> x * Math.PI / 180;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lng - a.lng);
  const lat1 = toRad(a.lat);
  const lat2 = toRad(b.lat);
  const s = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
  return R * c;
}

function computeIfPossible(){
  if(!pickup || !dropoff || !selectedService) {
    computed = {distanceKm:null, price:null};
    updateComputedUI();
    validateAll();
    return;
  }
  const km = haversineKm(pickup, dropoff);
  const rule = SERVICE_RULES[selectedService];
  let price = rule.base + (km * rule.perKm);
  price = Math.max(price, rule.min);

  computed = {distanceKm: km, price};
  updateComputedUI();
  validateAll();
}

function updateComputedUI(){
  els.distText.textContent = fmtKm(computed.distanceKm);
  els.priceText.textContent = fmtPrice(computed.price);

  // “Ücret mesafe çıktıktan sonra çağır aktif olsun” kilidi
  if(computed.distanceKm != null && computed.price != null){
    els.calcHint.textContent = "Mesafe ve ücret hazır. Kayıt bilgilerini tamamlayın ve çağırın.";
  }else{
    els.calcHint.textContent = "Hizmet seçin + haritada hedef seçin. Sistem mesafe ve ücreti otomatik hesaplar.";
  }
}

/** =========================
 *  VALIDATION
 *  ========================= */
function isPhoneValid(v){
  return /^0[0-9]{10}$/.test((v||"").trim());
}

function validatePhone(){
  const ok = isPhoneValid(els.phone.value);
  els.phoneErr.classList.toggle("hidden", ok || els.phone.value.trim()==="");
  return ok;
}

function validateAll(){
  const hasService = !!selectedService;
  const hasComputed = computed.distanceKm != null && computed.price != null; // kilit
  const nameOk = (els.name.value || "").trim().length >= 2;
  const phoneOk = validatePhone();
  const kvkkOk = !!els.kvkkCheck.checked;

  // reg card only exists after service selection per spec; but still gate call button
  const canCall = hasService && hasComputed && nameOk && phoneOk && kvkkOk;

  els.btnCall.disabled = !canCall;
  return canCall;
}

els.phone.addEventListener("input", () => { validatePhone(); validateAll(); });
els.name.addEventListener("input", validateAll);
els.kvkkCheck.addEventListener("change", validateAll);

/** =========================
 *  API CALL (single endpoint)
 *  ========================= */
async function postJsonWithTimeout(url, payload, timeoutMs){
  const controller = new AbortController();
  const t = setTimeout(() => controller.abort(), timeoutMs);
  try{
    const res = await fetch(url, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { data = { ok:false, error:"Backend JSON dönmedi", raw:text }; }
    return data;
  } finally {
    clearTimeout(t);
  }
}

function setCallLoading(isLoading, msg){
  if(isLoading){
    els.callState.innerHTML = `<span class="spinner"></span>${msg||"İşleniyor..."}`;
  }else{
    els.callState.textContent = msg||"";
  }
}

els.btnCall.addEventListener("click", async () => {
  els.callOk.classList.add("hidden");
  els.callErr.classList.add("hidden");
  els.callErr.textContent = "";

  if(!validateAll()){
    toast("Eksik bilgi", "Çağır için hizmet + hedef + ücret/mesafe + kayıt + KVKK gerekli.");
    return;
  }
  if(!BACKEND_URL || BACKEND_URL.includes("https://script.google.com/macros/s/AKfycbwIwaxcYtzl7pOCUJvXwCxjKBlJUBwV3m6akrP7MmFsynmXMqymjxdIxWbpqSWqfYzJ/exec")){
    els.callErr.textContent = "BACKEND_URL tanımlı değil. /exec URL’nizi index.html içine yapıştırın.";
    els.callErr.classList.remove("hidden");
    return;
  }

  // Payload (tek çağrı: create_request)
  const payload = {
    action: "create_request",
    client: { name: els.name.value.trim(), phone: els.phone.value.trim() },
    service: selectedService,
    pickup: { lat: pickup.lat, lng: pickup.lng },
    dropoff: { lat: dropoff.lat, lng: dropoff.lng },
    distance_km: Number(computed.distanceKm.toFixed(3)),
    price: Math.round(computed.price),
    note: (els.pickupNote.value || "").trim(),
    kvkk_accepted: true,
    ts: new Date().toISOString()
  };

  els.btnCall.disabled = true; // çift tık engeli
  setCallLoading(true, "Çağrı iletiliyor...");
  try{
    const data = await postJsonWithTimeout(BACKEND_URL, payload, API_TIMEOUT_MS);

    if(data && data.ok){
      els.callOk.classList.remove("hidden");
      toast("Başarılı", `Çağrı oluşturuldu. Job: ${data.job_id}`);
      setCallLoading(false, `Job: ${data.job_id}`);
    }else{
      const err = (data && (data.error || data.message)) ? (data.error || data.message) : "Bilinmeyen hata";
      els.callErr.textContent = err;
      els.callErr.classList.remove("hidden");
      setCallLoading(false, "Hata oluştu.");
    }
  }catch(e){
    const msg = (e && e.name === "AbortError") ? "Zaman aşımı. Lütfen tekrar deneyin." : (e.message || "İstek başarısız.");
    els.callErr.textContent = msg;
    els.callErr.classList.remove("hidden");
    setCallLoading(false, "İstek başarısız.");
  }finally{
    // tekrar validasyonla butonu doğru duruma getir
    els.btnCall.disabled = !validateAll();
  }
});

/** =========================
 *  START FLOW
 *  ========================= */
els.btnInfo.addEventListener("click", () => {
  toast("Nasıl çalışır?", "Başla → konum izni → hizmet seç → haritada hedef seç → ücret/mesafe çıksın → KVKK onayla → Çağır.");
});

els.btnStart.addEventListener("click", async () => {
  // Landing -> Main
  els.landing.classList.add("hidden");
  els.main.classList.remove("hidden");

  // Init map and UI
  buildServiceCards();
  initMap();

  // Request geo when map opened (spec)
  els.pillGeo.textContent = "Konum: isteniyor";
  try{
    const pos = await requestGeolocation();
    setPickup(pos.coords.latitude, pos.coords.longitude);
    toast("Konum alındı", "Haritada hedef noktayı tıklayarak seçin.");
  }catch(err){
    els.pillGeo.textContent = "Konum: alınamadı";
    toast("Konum alınamadı", "Harita varsayılan merkezde açıldı. Devam edebilirsiniz.");
  }

  // UI baseline
  els.pickupText.textContent = fmtLatLng(pickup);
  els.dropText.textContent = fmtLatLng(dropoff);
  updateComputedUI();
  validateAll();
});
</script>
</body>
</html>
