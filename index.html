<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
:root{--y:#f5c400}
#landing{position:fixed;inset:0;z-index:9;background:#000 url("assets/landing.png") center/cover no-repeat}
#landingTap{position:absolute;inset:0}
#app{display:none;height:100%}
#map{height:48vh}
#panel{height:52vh;padding:14px;background:#050506}
#svcRow{display:flex;gap:12px}
.svc{flex:1;padding:14px;border-radius:16px;border:1px solid #222;cursor:pointer}
.svc.active{border-color:var(--y)}
#cta{margin-top:14px;height:56px;border-radius:999px;background:var(--y);color:#000;font-size:22px;
display:flex;align-items:center;justify-content:center;font-weight:900;cursor:pointer}
#cta.disabled{background:#222;color:#777;cursor:not-allowed}
.stat{margin-top:10px;font-size:18px}
</style>
</head>

<body>

<div id="landing">
  <div id="landingTap"></div>
</div>

<div id="app">
  <div id="map"></div>

  <div id="panel">
    <div id="svcRow">
      <div class="svc" id="svcTaxi">ðŸš• Taksi</div>
      <div class="svc" id="svcCourier">ðŸ›µ Kurye</div>
    </div>

    <div class="stat">Mesafe: <span id="kmVal">â€”</span></div>
    <div class="stat">Ãœcret: <span id="priceVal">â€”</span></div>

    <div id="cta" class="disabled">Hizmet SeÃ§</div>
  </div>
</div>

<script>
/* ================= BACKEND ================= */
const API = "https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

/* ================= STATE ================= */
let map, fromLatLng=null, toLatLng=null;
let service=null;
let lastKM=0, lastPrice=0;

/* ================= INIT ================= */
document.getElementById("landingTap").onclick = ()=>{
  document.getElementById("landing").style.display="none";
  document.getElementById("app").style.display="block";
  initMap();
};

document.getElementById("svcTaxi").onclick = ()=>selectService("taxi");
document.getElementById("svcCourier").onclick = ()=>selectService("courier");
document.getElementById("cta").onclick = onCTA;

/* ================= MAP ================= */
function initMap(){
  map = L.map("map").setView([41.01,29.0],13);
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png").addTo(map);

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      fromLatLng={lat:p.coords.latitude,lng:p.coords.longitude};
      L.marker(fromLatLng).addTo(map);
      map.setView(fromLatLng,16);
    });
  }

  map.on("click",e=>{
    toLatLng={lat:e.latlng.lat,lng:e.latlng.lng};
    L.marker(toLatLng).addTo(map);
    recalc();
  });
}

/* ================= LOGIC ================= */
function selectService(s){
  service=s;
  document.getElementById("svcTaxi").classList.toggle("active",s==="taxi");
  document.getElementById("svcCourier").classList.toggle("active",s==="courier");
  recalc();
}

function recalc(){
  if(!service || !fromLatLng || !toLatLng) return;

  const R=6371;
  const dLat=(toLatLng.lat-fromLatLng.lat)*Math.PI/180;
  const dLng=(toLatLng.lng-fromLatLng.lng)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(fromLatLng.lat*Math.PI/180)*Math.cos(toLatLng.lat*Math.PI/180)*
    Math.sin(dLng/2)**2;
  lastKM=R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  lastKM=Number(lastKM.toFixed(2));

  lastPrice = service==="taxi"
    ? Math.round(60+lastKM*22)
    : Math.round(40+lastKM*15);

  document.getElementById("kmVal").textContent=lastKM+" km";
  document.getElementById("priceVal").textContent=lastPrice+" TL";

  document.getElementById("cta").textContent=
    service==="taxi" ? "Taksi Ã‡aÄŸÄ±r" : "Kurye Devam";
  document.getElementById("cta").classList.remove("disabled");
}

/* ================= CTA ================= */
async function onCTA(){
  if(service!=="taxi") return alert("Kurye akÄ±ÅŸÄ± sonraki adÄ±m");

  const payload={
    action:"createJob",
    service_type:"taxi",
    pickup_lat:fromLatLng.lat,
    pickup_lng:fromLatLng.lng,
    dropoff_lat:toLatLng.lat,
    dropoff_lng:toLatLng.lng,
    distance_km:lastKM,
    price:lastPrice
  };

  try{
    const res=await fetch(API,{
      method:"POST",
      headers:{"Content-Type":"text/plain;charset=utf-8"},
      body:JSON.stringify(payload)
    });
    const data=await res.json();
    if(data.ok && data.job_id){
      location.href="track.html?job_id="+data.job_id;
    }else{
      alert("Ä°ÅŸ oluÅŸturulamadÄ±");
    }
  }catch(e){
    alert("Backend hatasÄ±");
  }
}
</script>
</body>
</html>
