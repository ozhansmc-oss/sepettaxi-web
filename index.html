<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"><!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
.screen{display:none;min-height:100vh;padding:20px;box-sizing:border-box}
.active{display:flex;flex-direction:column}
.center{justify-content:center;align-items:center;text-align:center}
button{width:100%;padding:16px;margin-top:14px;border-radius:14px;border:none;font-size:16px;background:#fff;color:#000;font-weight:bold;cursor:pointer}
input{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:none;font-size:15px}
.list-item{padding:18px;border-bottom:1px solid #333;font-size:18px;display:flex;justify-content:space-between;cursor:pointer}
#map{height:50vh;border-radius:12px;margin-top:10px}
.small{color:#aaa;font-size:14px}
label{margin-top:8px}
</style>
</head>

<body>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyXfyQG4ZYPmsLF94hbYt9nKSIdta6wW9pfEDX4blNFCAsgbyR72kGwzZ5yO_zRzme2/exec";

const PRICES = {
  taksi:{open:30, km:12},
  kurye:{open:25, km:10}
};

let service = "taksi";
let map, fromLL=null, toLL=null, markerFrom, markerTo;
let distance=0, price=0;

function $(id){ return document.getElementById(id); }

function go(n){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  $("s"+n).classList.add("active");
  if(n===3) setTimeout(initMap,300);
}
</script>

<!-- 1) KAYIT + KVKK -->
<div id="s1" class="screen active center">
  <h1>SepetTaxi</h1>

  <input id="inp_name" placeholder="Ad Soyad">
  <input id="inp_phone" placeholder="Telefon (05xx)">

  <label><input type="checkbox" id="chk_kvkk"> KVKK kabul</label>
  <label><input type="checkbox" id="chk_soz"> Hizmet sÃ¶zleÅŸmesi</label>

  <button id="btn_register" onclick="register()">Devam Et</button>
  <p class="small" id="msg1"></p>
</div>

<!-- 2) HÄ°ZMET -->
<div id="s2" class="screen">
  <h2>Hizmet SeÃ§</h2>
  <div class="list-item" onclick="choose('taksi')">ðŸš• Taksi <span>â€º</span></div>
  <div class="list-item" onclick="choose('kurye')">ðŸ›µ Kurye <span>â€º</span></div>
</div>

<!-- 3) ADRES -->
<div id="s3" class="screen">
  <h2>Adres SeÃ§</h2>
  <input id="from" placeholder="Nereden (otomatik)">
  <input id="to" placeholder="Nereye (haritadan seÃ§)">
  <div id="map"></div>
  <button onclick="calc()">Ãœcreti Hesapla</button>
</div>

<!-- 4) ONAY -->
<div id="s4" class="screen center">
  <h2 id="priceText">0 TL</h2>
  <p class="small" id="infoText"></p>
  <button onclick="createJob()">Ã‡aÄŸÄ±r</button>
</div>

<script>
function register(){
  const n = $("inp_name").value.trim();
  const p = $("inp_phone").value.trim();
  const kv = $("chk_kvkk").checked;
  const sz = $("chk_soz").checked;

  if(!n || !p){
    alert("Ad ve telefon zorunlu");
    return;
  }
  if(!kv || !sz){
    alert("KVKK ve sÃ¶zleÅŸme kabul edilmelidir");
    return;
  }

  $("btn_register").disabled = true;
  $("btn_register").innerText = "Kaydediliyor...";
  $("msg1").innerText = "";

  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"registerUser",
      user_name:n,
      user_phone:p
    })
  })
  .then(r=>r.json())
  .then(res=>{
    console.log("registerUser:", res);
    if(res.ok){
      go(2);
    }else{
      $("msg1").innerText = "Backend hata: " + (res.error || "Bilinmiyor");
      $("btn_register").disabled = false;
      $("btn_register").innerText = "Devam Et";
    }
  })
  .catch(err=>{
    console.error("registerUser fetch error:", err);
    $("msg1").innerText = "BaÄŸlantÄ± hatasÄ±";
    $("btn_register").disabled = false;
    $("btn_register").innerText = "Devam Et";
  });
}

function choose(t){
  service = t;
  go(3);
}

function initMap(){
  if(map) return;

  map = L.map("map").setView([40.195,29.060],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  navigator.geolocation.getCurrentPosition(async pos=>{
    fromLL=[pos.coords.latitude,pos.coords.longitude];
    markerFrom=L.marker(fromLL).addTo(map).bindPopup("Konumun").openPopup();
    map.setView(fromLL,14);
    $("from").value = await rev(fromLL);
  }, ()=>{
    alert("Konum izni verilmedi");
  });

  map.on("click", async e=>{
    toLL=[e.latlng.lat,e.latlng.lng];
    if(markerTo) map.removeLayer(markerTo);
    markerTo=L.marker(toLL).addTo(map).bindPopup("VarÄ±ÅŸ").openPopup();
    $("to").value = await rev(toLL);
  });
}

async function rev(ll){
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll[0]}&lon=${ll[1]}`);
  const d=await r.json();
  return d.display_name || ll.join(",");
}

function hav(a,b){
  const R=6371;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLng=(b[1]-a[1])*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function calc(){
  if(!fromLL || !toLL){
    alert("BaÅŸlangÄ±Ã§ ve varÄ±ÅŸ seÃ§ilmeli");
    return;
  }
  distance = hav(fromLL,toLL);
  price = Math.round(PRICES[service].open + distance*PRICES[service].km);

  $("priceText").innerText = price + " TL";
  $("infoText").innerText = distance.toFixed(2)+" km â€“ "+service.toUpperCase();
  go(4);
}

function createJob(){
  const n = $("inp_name").value.trim();
  const p = $("inp_phone").value.trim();

  if(!fromLL || !toLL){
    alert("Konum seÃ§ilmeli");
    return;
  }

  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"createJob",
      service_type:service,
      user_name:n,
      user_phone:p,
      pickup_address:$("from").value,
      pickup_lat:String(fromLL[0]),
      pickup_lng:String(fromLL[1]),
      dropoff_address:$("to").value,
      dropoff_lat:String(toLL[0]),
      dropoff_lng:String(toLL[1])
    })
  })
  .then(r=>r.json())
  .then(res=>{
    console.log("createJob:", res);
    if(res.ok){
      alert("Ã‡aÄŸrÄ± oluÅŸturuldu");
      // Ä°stersen: window.location.href = "track.html?job_id="+res.job_id;
    }else{
      alert("Backend hata: " + (res.error || "Bilinmiyor"));
    }
  })
  .catch(err=>{
    console.error("createJob fetch error:", err);
    alert("BaÄŸlantÄ± hatasÄ±");
  });
}
</script>

</body>
</html>


<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
.screen{display:none;min-height:100vh;padding:20px;box-sizing:border-box}
.active{display:flex;flex-direction:column}
.center{justify-content:center;align-items:center;text-align:center}
button{width:100%;padding:16px;margin-top:14px;border-radius:14px;border:none;font-size:16px;background:#fff;color:#000;font-weight:bold}
input{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:none;font-size:15px}
.list-item{padding:18px;border-bottom:1px solid #333;font-size:18px;display:flex;justify-content:space-between;cursor:pointer}
#map{height:50vh;border-radius:12px;margin-top:10px}
.small{color:#aaa;font-size:14px}
label{margin-top:8px}
</style>
</head>

<body>

<script>
/* =========================
   BACKEND â€“ GÃ–MÃœLÃœ
========================= */


/* =========================
   FÄ°YAT
========================= */
const PRICES = {
  taksi:{open:30, km:12},
  kurye:{open:25, km:10}
};

/* =========================
   STATE
========================= */
let service = "taksi";
let map, fromLL=null, toLL=null, markerFrom, markerTo;
let distance=0, price=0;
</script>

<!-- 1. KAYIT + KVKK -->
<div id="s1" class="screen active center">
  <h1>SepetTaxi</h1>
  <input id="name" placeholder="Ad Soyad">
  <input id="phone" placeholder="Telefon (05xx)">
  <label><input type="checkbox" id="kvkk"> KVKK kabul</label>
  <label><input type="checkbox" id="soz"> Hizmet sÃ¶zleÅŸmesi</label>
  <button onclick="register()">Devam Et</button>
</div>

<!-- 2. HÄ°ZMET -->
<div id="s2" class="screen">
  <h2>Hizmet SeÃ§</h2>
  <div class="list-item" onclick="choose('taksi')">ðŸš• Taksi <span>â€º</span></div>
  <div class="list-item" onclick="choose('kurye')">ðŸ›µ Kurye <span>â€º</span></div>
</div>

<!-- 3. ADRES -->
<div id="s3" class="screen">
  <h2>Adres SeÃ§</h2>
  <input id="from" placeholder="Nereden (otomatik)">
  <input id="to" placeholder="Nereye (haritadan seÃ§)">
  <div id="map"></div>
  <button onclick="calc()">Ãœcreti Hesapla</button>
</div>

<!-- 4. ONAY -->
<div id="s4" class="screen center">
  <h2 id="priceText">0 TL</h2>
  <p class="small" id="infoText"></p>
  <button onclick="createJob()">Ã‡aÄŸÄ±r</button>
</div>

<script>
/* =========================
   NAV
========================= */
function go(n){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById("s"+n).classList.add("active");
  if(n===3) setTimeout(initMap,300);
}

/* =========================
   KAYIT
========================= */
function register(){
  const n = name.value.trim();
  const p = phone.value.trim();
  if(!n || !p || !kvkk.checked || !soz.checked){
    alert("Bilgiler eksik"); return;
  }
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"registerUser",
      user_name:n,
      user_phone:p
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.ok) go(2);
    else alert(res.error || "KayÄ±t hatasÄ±");
  })
  .catch(()=>alert("BaÄŸlantÄ± hatasÄ±"));
}

/* =========================
   HÄ°ZMET
========================= */
function choose(t){ service=t; go(3); }

/* =========================
   HARÄ°TA
========================= */
function initMap(){
  if(map) return;
  map = L.map("map").setView([40.195,29.060],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  navigator.geolocation.getCurrentPosition(async pos=>{
    fromLL=[pos.coords.latitude,pos.coords.longitude];
    markerFrom=L.marker(fromLL).addTo(map).bindPopup("Konumun").openPopup();
    map.setView(fromLL,14);
    from.value = await rev(fromLL);
  });

  map.on("click", async e=>{
    toLL=[e.latlng.lat,e.latlng.lng];
    if(markerTo) map.removeLayer(markerTo);
    markerTo=L.marker(toLL).addTo(map).bindPopup("VarÄ±ÅŸ").openPopup();
    to.value = await rev(toLL);
  });
}

async function rev(ll){
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll[0]}&lon=${ll[1]}`);
  const d=await r.json();
  return d.display_name || ll.join(",");
}

/* =========================
   HESAP
========================= */
function hav(a,b){
  const R=6371;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLng=(b[1]-a[1])*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function calc(){
  if(!fromLL || !toLL){ alert("Konum seÃ§"); return; }
  distance = hav(fromLL,toLL);
  price = Math.round(PRICES[service].open + distance*PRICES[service].km);
  priceText.innerText = price + " TL";
  infoText.innerText = distance.toFixed(2)+" km â€“ "+service.toUpperCase();
  go(4);
}

/* =========================
   JOB
========================= */
function createJob(){
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"createJob",
      service_type:service,
      user_name:name.value,
      user_phone:phone.value,
      pickup_address:from.value,
      pickup_lat:String(fromLL[0]),
      pickup_lng:String(fromLL[1]),
      dropoff_address:to.value,
      dropoff_lat:String(toLL[0]),
      dropoff_lng:String(toLL[1])
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.ok){
      alert("Ã‡aÄŸrÄ± oluÅŸturuldu");
      // Ä°stersen: window.location.href = "track.html?job_id="+res.job_id;
    } else {
      alert(res.error || "Ã‡aÄŸrÄ± hatasÄ±");
    }
  })
  .catch(()=>alert("BaÄŸlantÄ± hatasÄ±"));
}
</script>

</body>
</html>
