<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SepetTaxi</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --text:#0b0f14;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#ffffff;
      --soft:#f6f7f9;
      --shadow: 0 14px 34px rgba(0,0,0,.10);
      --shadow2: 0 8px 18px rgba(0,0,0,.10);
      --radius: 18px;
      --radius2: 14px;
      --accent:#0b0f14;
      --accentText:#ffffff;
      --danger:#b91c1c;
      --ok:#166534;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif;color:var(--text);background:var(--bg)}
    body{overflow:hidden}
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      background:var(--bg);
    }

    /* TOP BAR */
    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      z-index:10;
      flex:0 0 auto;
    }
    .brand{font-weight:800; letter-spacing:.2px}
    .geoPill{
      display:flex;align-items:center;gap:8px;
      padding:9px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      font-size:12px;color:var(--muted);
      max-width:55%;
    }
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:#16a34a}
    .dot.warn{background:#f59e0b}
    .dot.bad{background:#ef4444}
    .geoText{white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* MAP AREA (TOP) */
    .mapArea{
      position:relative;
      flex:0 0 auto;
      height:38vh;             /* kilit: harita Ã¼stte, ekranÄ± kaplamaz */
      min-height:260px;
      border-bottom:1px solid var(--line);
      background:#eef2f7;
    }
    #map{height:100%; width:100%}

    .mapOverlay{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      background:rgba(11,15,20,.20);
      backdrop-filter: blur(2px);
      z-index:500;
      pointer-events:auto; /* pasifken tÄ±klamayÄ± engeller */
      transition:opacity .18s ease;
    }
    .mapOverlay.hidden{
      opacity:0;
      pointer-events:none;
    }
    .mapOverlayCard{
      width:min(520px, 100%);
      border-radius:18px;
      border:1px solid rgba(229,231,235,.9);
      background:rgba(255,255,255,.92);
      box-shadow: var(--shadow2);
      padding:12px 14px;
    }
    .overlayTitle{font-weight:850; font-size:14px}
    .overlayText{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35}
    .overlayAction{
      margin-top:10px;
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .btn{
      border:none; border-radius:16px;
      padding:12px 14px;
      font-weight:800; font-size:14px;
      cursor:pointer;
    }
    .btn.primary{background:var(--accent); color:var(--accentText)}
    .btn.ghost{
      background:rgba(246,247,249,.9);
      border:1px solid rgba(229,231,235,.95);
      color:var(--text);
    }
    .btn:disabled{opacity:.5; cursor:not-allowed}

    /* CONTENT AREA (CARDS UNDER MAP) */
    .content{
      flex:1 1 auto;
      overflow:auto;
      padding:14px 14px calc(14px + env(safe-area-inset-bottom));
      background:var(--bg);
    }
    .section{margin-bottom:12px}
    .sectionTitle{font-size:12px; color:var(--muted); margin:2px 2px 10px; font-weight:700}
    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .chip{
      display:flex; align-items:center; gap:8px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--soft);
      cursor:pointer;
      user-select:none;
      font-weight:750;
      font-size:13px;
    }
    .chip.active{
      background:var(--accent);
      color:var(--accentText);
      border-color:rgba(0,0,0,.15);
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background:var(--card);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      padding:12px;
    }
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius: var(--radius2);
      border:1px solid rgba(229,231,235,.85);
      background:rgba(246,247,249,.75);
      margin-bottom:10px;
    }
    .row:last-child{margin-bottom:0}
    .rowLeft{min-width:0}
    .rowTitle{font-size:12px; color:var(--muted); margin-bottom:2px}
    .rowValue{
      font-size:14px; font-weight:800;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 65vw;
    }
    .rowRight{
      font-size:12px; color:var(--muted);
      flex:0 0 auto;
    }

    .twoCols{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .mini{
      border:1px solid rgba(229,231,235,.85);
      background:rgba(246,247,249,.75);
      border-radius: var(--radius2);
      padding:10px 12px;
    }
    .miniLabel{font-size:12px; color:var(--muted)}
    .miniValue{margin-top:4px; font-size:16px; font-weight:900}

    .inlineForm{
      margin-top:10px;
      display:none;
      gap:10px;
    }
    .field{
      border:1px solid rgba(229,231,235,.85);
      background:rgba(246,247,249,.75);
      border-radius: var(--radius2);
      padding:10px 12px;
    }
    .field label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px; font-weight:700}
    .field input, .field textarea{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:14px;
      font-weight:750;
      color:var(--text);
      padding:0;
    }
    .field textarea{min-height:44px; resize:none; font-weight:650}

    .actions{
      margin-top:12px;
      display:flex; gap:10px;
    }
    .actions .btn{flex:1}
    .btn.danger{
      background:#fff;
      border:1px solid rgba(239,68,68,.35);
      color:var(--danger);
    }

    .hint{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    /* BOTTOM SHEET */
    .sheetMask{
      position:fixed; inset:0;
      background: rgba(11,15,20,.45);
      opacity:0; pointer-events:none;
      transition:opacity .18s ease;
      z-index:900;
    }
    .sheetMask.open{opacity:1; pointer-events:auto}
    .sheet{
      position:fixed; left:0; right:0; bottom:0;
      transform: translateY(110%);
      transition: transform .22s ease;
      z-index:1000;
      background:rgba(255,255,255,.96);
      backdrop-filter: blur(14px);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      box-shadow: 0 -18px 44px rgba(0,0,0,.18);
      border-top:1px solid rgba(229,231,235,.9);
      padding:10px 14px calc(14px + env(safe-area-inset-bottom));
    }
    .sheet.open{transform: translateY(0)}
    .grab{
      width:44px; height:5px; border-radius:999px;
      background: rgba(107,114,128,.35);
      margin:6px auto 10px;
    }
    .sheetTitle{font-size:14px; font-weight:950; margin:2px 2px 10px}
    .sheetCard{
      border:1px solid rgba(229,231,235,.9);
      background:rgba(246,247,249,.85);
      border-radius:16px;
      padding:10px 12px;
      margin-bottom:10px;
    }
    .sheetLine1{font-size:12px; color:var(--muted); font-weight:700}
    .sheetLine2{margin-top:4px; font-size:14px; font-weight:950}
    .sheetFields{display:grid; gap:10px; margin-top:10px}
    .kvkk{
      display:flex; gap:10px; align-items:flex-start;
      margin-top:10px;
      font-size:12px; color:var(--muted); line-height:1.35;
    }
    .kvkk input{margin-top:2px}
    .sheetActions{display:flex; gap:10px; margin-top:12px}
    .toast{margin-top:10px; font-size:12px; line-height:1.35; color:var(--muted)}
    .toast.error{color:var(--danger)}
    .toast.ok{color:var(--ok)}

    /* Desktop */
    @media (min-width: 980px){
      body{overflow:auto}
      .app{max-width:980px; margin:0 auto; height:100vh; border-left:1px solid var(--line); border-right:1px solid var(--line)}
      .mapArea{height:360px}
      .rowValue{max-width:520px}
    }
  </style>
</head>

<body>
<div class="app">
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">SepetTaxi</div>
    <div class="geoPill" id="geoPill" title="Konum durumu">
      <span class="dot warn" id="geoDot"></span>
      <span class="geoText" id="geoText">Konum alÄ±nÄ±yorâ€¦</span>
    </div>
  </div>

  <!-- MAP (TOP) -->
  <div class="mapArea">
    <div id="map"></div>

    <!-- Map passive overlay (phase 1) -->
    <div class="mapOverlay" id="mapOverlay">
      <div class="mapOverlayCard">
        <div class="overlayTitle" id="overlayTitle">Hizmet seÃ§in</div>
        <div class="overlayText" id="overlayText">
          Taxi veya Kurye seÃ§tiÄŸinizde harita aktif olacak ve <b>Nereden â†’ Nereye</b> seÃ§imi yapabileceksiniz.
        </div>
        <div class="overlayAction">
          <button class="btn ghost" id="btnGeoRetry" type="button">Konum Ä°zni</button>
          <button class="btn primary" id="btnOverlayOk" type="button">AnladÄ±m</button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENT (CARDS UNDER MAP) -->
  <div class="content">
    <div class="section">
      <div class="sectionTitle">Hizmet</div>
      <div class="chips">
        <div class="chip" id="chipTaxi" data-service="taxi">ðŸš• Taxi</div>
        <div class="chip" id="chipCourier" data-service="courier">ðŸ“¦ Kurye</div>
      </div>
    </div>

    <div class="section">
      <div class="card">
        <div class="row" id="rowPickup">
          <div class="rowLeft">
            <div class="rowTitle">Nereden?</div>
            <div class="rowValue" id="pickupText">SeÃ§im bekleniyor</div>
          </div>
          <div class="rowRight" id="pickupHint">Harita Ã¼stte</div>
        </div>

        <div class="row" id="rowDropoff">
          <div class="rowLeft">
            <div class="rowTitle">Nereye?</div>
            <div class="rowValue" id="dropoffText">SeÃ§im bekleniyor</div>
          </div>
          <div class="rowRight" id="dropoffHint">Harita Ã¼stte</div>
        </div>

        <div class="twoCols">
          <div class="mini">
            <div class="miniLabel">Mesafe</div>
            <div class="miniValue" id="distanceText">â€”</div>
          </div>
          <div class="mini">
            <div class="miniLabel">Tahmini Ãœcret</div>
            <div class="miniValue" id="priceText">â€”</div>
          </div>
        </div>

        <!-- Kurye minimal alanlarÄ± -->
        <div class="inlineForm" id="courierInline">
          <div class="field">
            <label>AlÄ±cÄ± AdÄ±</label>
            <input id="recvName" type="text" placeholder="Ã–rn. Ahmet Y." autocomplete="name">
          </div>
          <div class="field">
            <label>AlÄ±cÄ± Telefonu</label>
            <input id="recvPhone" type="tel" placeholder="05XXXXXXXXX" inputmode="tel" autocomplete="tel">
          </div>
          <div class="field">
            <label>Not (opsiyonel)</label>
            <textarea id="courierNote" placeholder="Ã–rn. KapÄ±dan teslim"></textarea>
          </div>
        </div>

        <div class="actions">
          <button class="btn danger" id="btnReset" type="button">SÄ±fÄ±rla</button>
          <button class="btn primary" id="btnContinue" type="button" disabled>Devam Et</button>
        </div>

        <div class="hint" id="hintText">Ã–nce <b>Taxi</b> veya <b>Kurye</b> seÃ§in.</div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Sheet -->
<div class="sheetMask" id="sheetMask"></div>
<div class="sheet" id="sheet">
  <div class="grab"></div>
  <div class="sheetTitle" id="sheetTitle">Devam</div>

  <div class="sheetCard">
    <div class="sheetLine1" id="sheetLine1">Ã–zet</div>
    <div class="sheetLine2" id="sheetLine2">â€”</div>
  </div>

  <div id="sheetBody"></div>
  <div class="sheetActions" id="sheetActions"></div>
  <div class="toast" id="toast"></div>
</div>

<script>
(() => {
  "use strict";

  // === BACKEND (KÄ°LÄ°TLÄ°) ===
  const API_URL = "https://script.google.com/macros/s/AKfycbwuWCke3krudZ4Jr3nkChyIPFtb1eUXgGbj6dSODPUuye_K-fO70o-Ou9wspGAa0WkH-g/exec";

  // === STATE ===
  const state = {
    service: null,          // 'taxi' | 'courier'
    user: loadUser(),       // {name, phone, kvkkAccepted, kvkkVersion, source}
    mapEnabled: false,      // kilit: ilk aÃ§Ä±lÄ±ÅŸta pasif
    picking: "pickup",      // 'pickup' | 'dropoff' | 'done'
    pickup: null,
    dropoff: null,
    distanceKm: null,
    price: null,
    courier: { receiver_name:"", receiver_phone:"", note:"" }
  };

  // === ELEMENTS ===
  const el = {
    geoDot: document.getElementById("geoDot"),
    geoText: document.getElementById("geoText"),
    btnGeoRetry: document.getElementById("btnGeoRetry"),
    mapOverlay: document.getElementById("mapOverlay"),
    overlayTitle: document.getElementById("overlayTitle"),
    overlayText: document.getElementById("overlayText"),
    btnOverlayOk: document.getElementById("btnOverlayOk"),

    chipTaxi: document.getElementById("chipTaxi"),
    chipCourier: document.getElementById("chipCourier"),

    pickupText: document.getElementById("pickupText"),
    dropoffText: document.getElementById("dropoffText"),
    pickupHint: document.getElementById("pickupHint"),
    dropoffHint: document.getElementById("dropoffHint"),

    distanceText: document.getElementById("distanceText"),
    priceText: document.getElementById("priceText"),

    courierInline: document.getElementById("courierInline"),
    recvName: document.getElementById("recvName"),
    recvPhone: document.getElementById("recvPhone"),
    courierNote: document.getElementById("courierNote"),

    btnReset: document.getElementById("btnReset"),
    btnContinue: document.getElementById("btnContinue"),
    hintText: document.getElementById("hintText"),

    sheetMask: document.getElementById("sheetMask"),
    sheet: document.getElementById("sheet"),
    sheetTitle: document.getElementById("sheetTitle"),
    sheetLine1: document.getElementById("sheetLine1"),
    sheetLine2: document.getElementById("sheetLine2"),
    sheetBody: document.getElementById("sheetBody"),
    sheetActions: document.getElementById("sheetActions"),
    toast: document.getElementById("toast"),
  };

  // === MAP ===
  let map, pickupMarker, dropoffMarker, routeLine;

  initMap();
  wireUI();
  requestGeo();

  // =========================
  // UI
  // =========================
  function wireUI(){
    el.chipTaxi.addEventListener("click", () => selectService("taxi"));
    el.chipCourier.addEventListener("click", () => selectService("courier"));

    el.btnReset.addEventListener("click", resetAll);
    el.btnContinue.addEventListener("click", openConfirmSheet);

    el.recvName.addEventListener("input", () => { state.courier.receiver_name = el.recvName.value.trim(); updateUI(); });
    el.recvPhone.addEventListener("input", () => { state.courier.receiver_phone = normalizePhoneTR(el.recvPhone.value); updateUI(); });
    el.courierNote.addEventListener("input", () => { state.courier.note = el.courierNote.value.trim(); });

    el.btnGeoRetry.addEventListener("click", requestGeo);
    el.btnOverlayOk.addEventListener("click", () => {
      // overlay kalabilir (pasif mod), sadece kullanÄ±cÄ± mesajÄ± kapatÄ±r
      // ama map pasiflik kuralÄ± sÃ¼rer: hizmet seÃ§meden map aÃ§Ä±lmaz.
      el.mapOverlay.querySelector(".mapOverlayCard").style.display = "none";
      setTimeout(()=>{ el.mapOverlay.querySelector(".mapOverlayCard").style.display = ""; }, 2000);
    });

    // sheet close
    el.sheetMask.addEventListener("click", closeSheet);

    // initial render
    renderServiceUI();
    updateUI();
    refreshMapOverlay();
  }

  function selectService(service){
    state.service = service;
    renderServiceUI();

    // Kurye alanlarÄ±
    el.courierInline.style.display = (service === "courier") ? "grid" : "none";

    // Kural: yeni mÃ¼ÅŸteri kaydÄ± hizmet seÃ§meye baÅŸladÄ±ÄŸÄ±nda
    if(!state.user){
      openRegisterSheet(service);
      // kayÄ±t tamamlanÄ±nca map aÃ§Ä±lacak
      updateUI();
      refreshMapOverlay();
      return;
    }

    // kayÄ±tlÄ± kullanÄ±cÄ±: map etkileÅŸimi bu noktada aÃ§Ä±lÄ±r
    enableMapForPicking();
    updateUI();
    refreshMapOverlay();
  }

  function renderServiceUI(){
    el.chipTaxi.classList.toggle("active", state.service === "taxi");
    el.chipCourier.classList.toggle("active", state.service === "courier");
  }

  function updateUI(){
    // Pickup/dropoff metinleri (adres yok â€” sade)
    el.pickupText.textContent  = state.pickup  ? "SeÃ§ildi" : "SeÃ§im bekleniyor";
    el.dropoffText.textContent = state.dropoff ? "SeÃ§ildi" : "SeÃ§im bekleniyor";

    el.pickupHint.textContent  = state.mapEnabled ? (state.pickup ? "SÃ¼rÃ¼kle" : "Haritaya dokun") : "Harita Ã¼stte";
    el.dropoffHint.textContent = state.mapEnabled ? (state.dropoff ? "SÃ¼rÃ¼kle" : "Haritaya dokun") : "Harita Ã¼stte";

    el.distanceText.textContent = state.distanceKm ? `${state.distanceKm} km` : "â€”";
    el.priceText.textContent    = (state.price && state.service) ? `${state.price} â‚º` : "â€”";

    // Devam et aktifliÄŸi
    const serviceOk = !!state.service;
    const userOk = !!state.user;
    const pointsOk = !!state.pickup && !!state.dropoff;
    const calcOk = !!state.distanceKm && !!state.price;

    let courierOk = true;
    if(state.service === "courier"){
      courierOk = !!state.courier.receiver_name && isPhoneTR(normalizePhoneTR(el.recvPhone.value || ""));
    }

    el.btnContinue.disabled = !(serviceOk && userOk && pointsOk && calcOk && courierOk);

    // Profesyonel rehber metin (buton altÄ±)
    if(!state.service){
      el.hintText.innerHTML = "Ã–nce <b>Taxi</b> veya <b>Kurye</b> seÃ§in.";
    } else if(!state.user){
      el.hintText.innerHTML = "<b>KayÄ±t</b> tamamlandÄ±ktan sonra konum seÃ§imine geÃ§eceÄŸiz.";
    } else if(!state.mapEnabled){
      el.hintText.innerHTML = "Harita, hizmet seÃ§imi sonrasÄ± aktif olur.";
    } else if(!state.pickup){
      el.hintText.innerHTML = "Haritada <b>Nereden</b> seÃ§mek iÃ§in dokunun.";
    } else if(!state.dropoff){
      el.hintText.innerHTML = "Haritada <b>Nereye</b> seÃ§mek iÃ§in dokunun.";
    } else if(state.service === "courier" && !courierOk){
      el.hintText.innerHTML = "<b>Kurye</b> iÃ§in alÄ±cÄ± adÄ± ve telefonu gerekli.";
    } else {
      el.hintText.innerHTML = "Devam ederek onay adÄ±mÄ±na geÃ§ebilirsiniz.";
    }
  }

  function refreshMapOverlay(){
    // Harita pasifliÄŸi kuralÄ±:
    // - hizmet seÃ§ilmeden: pasif + overlay
    // - hizmet seÃ§ildi ama user yok: pasif + overlay
    // - hizmet + user tamam: aktif (overlay gizli)
    const shouldBlock = !(state.service && state.user);
    if(shouldBlock){
      el.mapOverlay.classList.remove("hidden");
      el.overlayTitle.textContent = !state.service ? "Hizmet seÃ§in" : "KayÄ±t gerekli";
      el.overlayText.innerHTML = !state.service
        ? 'Taxi veya Kurye seÃ§tiÄŸinizde harita aktif olur ve <b>Nereden â†’ Nereye</b> seÃ§imi yaparsÄ±nÄ±z.'
        : 'Devam etmek iÃ§in kÄ±sa kayÄ±t gerekli. KayÄ±t tamamlanÄ±nca harita aktif olur.';
      state.mapEnabled = false;
      setMapInteractivity(false);
    } else {
      el.mapOverlay.classList.add("hidden");
      enableMapForPicking();
    }
  }

  // =========================
  // MAP
  // =========================
  function initMap(){
    map = L.map("map", { zoomControl: false, dragging:true, scrollWheelZoom:true }).setView([40.195, 29.060], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap",
      maxZoom: 19
    }).addTo(map);

    map.on("click", (e) => {
      if(!state.mapEnabled) return;

      if(state.picking === "pickup"){
        setPickup(e.latlng);
        state.picking = "dropoff";
        updateUI();
        return;
      }
      if(state.picking === "dropoff"){
        setDropoff(e.latlng);
        state.picking = "done";
        computeDistanceAndPrice();
        fitToPoints();
        updateUI();
        return;
      }
      // done: update dropoff (simple)
      setDropoff(e.latlng);
      computeDistanceAndPrice();
      fitToPoints();
      updateUI();
    });

    // start with interactivity OFF per rule
    setMapInteractivity(false);
  }

  function setMapInteractivity(on){
    // Leaflet controls
    if(on){
      map.dragging.enable();
      map.touchZoom.enable();
      map.doubleClickZoom.enable();
      map.scrollWheelZoom.enable();
      map.boxZoom.enable();
      map.keyboard.enable();
      if(map.tap) map.tap.enable();
    }else{
      map.dragging.disable();
      map.touchZoom.disable();
      map.doubleClickZoom.disable();
      map.scrollWheelZoom.disable();
      map.boxZoom.disable();
      map.keyboard.disable();
      if(map.tap) map.tap.disable();
    }
  }

  function enableMapForPicking(){
    state.mapEnabled = true;
    setMapInteractivity(true);
  }

  function setPickup(latlng){
    state.pickup = { lat:+latlng.lat, lng:+latlng.lng };
    if(!pickupMarker){
      pickupMarker = L.marker(latlng, { draggable:true }).addTo(map);
      pickupMarker.on("dragend", () => {
        const p = pickupMarker.getLatLng();
        state.pickup = { lat:+p.lat, lng:+p.lng };
        if(state.dropoff){ computeDistanceAndPrice(); fitToPoints(); }
        updateUI();
      });
    } else {
      pickupMarker.setLatLng(latlng);
    }
    drawRoute();
  }

  function setDropoff(latlng){
    state.dropoff = { lat:+latlng.lat, lng:+latlng.lng };
    if(!dropoffMarker){
      dropoffMarker = L.marker(latlng, { draggable:true }).addTo(map);
      dropoffMarker.on("dragend", () => {
        const d = dropoffMarker.getLatLng();
        state.dropoff = { lat:+d.lat, lng:+d.lng };
        if(state.pickup){ computeDistanceAndPrice(); fitToPoints(); }
        updateUI();
      });
    } else {
      dropoffMarker.setLatLng(latlng);
    }
    drawRoute();
  }

  function drawRoute(){
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
    if(state.pickup && state.dropoff){
      routeLine = L.polyline(
        [[state.pickup.lat,state.pickup.lng],[state.dropoff.lat,state.dropoff.lng]],
        { weight:4, opacity:.7 }
      ).addTo(map);
    }
  }

  function fitToPoints(){
    if(state.pickup && state.dropoff){
      const b = L.latLngBounds(
        [state.pickup.lat,state.pickup.lng],
        [state.dropoff.lat,state.dropoff.lng]
      ).pad(0.15);
      map.fitBounds(b, { animate:true });
    }
  }

  function computeDistanceAndPrice(){
    if(!state.pickup || !state.dropoff) return;
    const distM = map.distance([state.pickup.lat,state.pickup.lng],[state.dropoff.lat,state.dropoff.lng]);
    state.distanceKm = +(distM/1000).toFixed(2);
    state.price = estimatePrice(state.service, state.distanceKm);
    drawRoute();
  }

  function estimatePrice(service, km){
    // Tahmini Ãœcret (A) â€” temiz ilk sÃ¼rÃ¼m tarife
    let base = 55, perKm = 18;
    if(service === "courier"){ base = 45; perKm = 14; }
    return Math.max(0, Math.round(base + perKm*km));
  }

  // =========================
  // GEO
  // =========================
  function requestGeo(){
    setGeoStatus("Konum alÄ±nÄ±yorâ€¦", "warn");
    if(!navigator.geolocation){
      setGeoStatus("Konum desteklenmiyor", "bad");
      return;
    }
    navigator.geolocation.getCurrentPosition((pos)=>{
      setGeoStatus("Konum alÄ±ndÄ±", "ok");
      map.setView([pos.coords.latitude, pos.coords.longitude], 15);
    }, ()=>{
      setGeoStatus("Konum izni gerekli", "warn");
    }, { enableHighAccuracy:true, timeout:9000, maximumAge:15000 });
  }

  function setGeoStatus(text, level){
    el.geoText.textContent = text;
    el.geoDot.classList.remove("ok","warn","bad");
    el.geoDot.classList.add(level);
  }

  // =========================
  // SHEET: REGISTER & CONFIRM
  // =========================
  function openRegisterSheet(service){
    el.sheetTitle.textContent = "KayÄ±t";
    el.sheetLine1.textContent = "Devam etmek iÃ§in";
    el.sheetLine2.textContent = (service === "taxi" ? "ðŸš• Taxi" : "ðŸ“¦ Kurye") + " seÃ§iminizi tamamlayÄ±n";

    el.sheetBody.innerHTML = `
      <div class="sheetFields">
        <div class="field">
          <label>Telefon</label>
          <input id="regPhone" type="tel" placeholder="05XXXXXXXXX" inputmode="tel" autocomplete="tel">
        </div>
        <div class="field">
          <label>Ad Soyad</label>
          <input id="regName" type="text" placeholder="Ad Soyad" autocomplete="name">
        </div>
        <div class="kvkk">
          <input id="regKvkk" type="checkbox">
          <div>
            KVKK ve Hizmet ÅžartlarÄ±nÄ± kabul ediyorum.
            <span style="display:block;margin-top:6px">
              <a href="javascript:void(0)" id="kvkkToggle" style="color:var(--text);font-weight:900;text-decoration:none;border-bottom:1px solid rgba(0,0,0,.25)">Metni GÃ¶r</a>
            </span>
          </div>
        </div>
      </div>

      <div class="sheetCard" id="kvkkBox" style="display:none">
        <div class="sheetLine1">KVKK & Hizmet ÅžartlarÄ± (Ã–zet)</div>
        <div style="margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45">
          SepetTaxi, talebinizi oluÅŸturmak ve operasyonu yÃ¼rÃ¼tmek amacÄ±yla ad/telefon ve konum verilerinizi iÅŸler.
          Devam ederek bu verilerin hizmet sunumu kapsamÄ±nda kullanÄ±lmasÄ±nÄ± kabul edersiniz.
        </div>
      </div>
    `;

    el.sheetActions.innerHTML = "";
    const btnBack = mkBtn("VazgeÃ§", "ghost", () => {
      closeSheet();
      // hizmet seÃ§imini iptal et
      state.service = null;
      renderServiceUI();
      el.courierInline.style.display = "none";
      refreshMapOverlay();
      updateUI();
    });

    const btnOk = mkBtn("Kaydol & Devam", "primary", async () => {
      const phone = normalizePhoneTR(document.getElementById("regPhone").value);
      const name  = (document.getElementById("regName").value || "").trim();
      const kvkk  = !!document.getElementById("regKvkk").checked;

      if(!isPhoneTR(phone)){ setToast("Telefon formatÄ±: 05XXXXXXXXX", true); return; }
      if(!name){ setToast("Ad Soyad gerekli.", true); return; }
      if(!kvkk){ setToast("KVKK ve ÅŸartlarÄ± kabul etmelisiniz.", true); return; }

      state.user = { name, phone, kvkkAccepted:true, kvkkVersion:"v1", source:"web" };
      saveUser(state.user);

      // Sessiz register_user
      try{
        setToast("Kaydediliyorâ€¦", false, "ok");
        await safePost(API_URL, { action:"register_user", user:{ name, phone, kvkkAccepted:true, kvkkVersion:"v1", source:"web" } });
      }catch(_){ /* upsert jobâ€™da da olur */ }

      closeSheet();
      setToast("");

      // kayÄ±t tamamlandÄ± â†’ map aktif
      refreshMapOverlay();
      updateUI();
    });

    el.sheetActions.appendChild(btnBack);
    el.sheetActions.appendChild(btnOk);

    setToast("");
    openSheet();

    setTimeout(() => {
      const t = document.getElementById("kvkkToggle");
      const b = document.getElementById("kvkkBox");
      if(t && b) t.addEventListener("click", ()=>{ b.style.display = (b.style.display==="none") ? "block" : "none"; });
    }, 0);
  }

  function openConfirmSheet(){
    if(!state.service){
      updateUI(); return;
    }
    if(!state.user){
      openRegisterSheet(state.service); return;
    }

    // validasyon
    if(state.service === "courier"){
      const ok = !!state.courier.receiver_name && isPhoneTR(normalizePhoneTR(el.recvPhone.value||""));
      if(!ok){ updateUI(); return; }
    }
    if(!(state.pickup && state.dropoff && state.price && state.distanceKm)){
      updateUI(); return;
    }

    el.sheetTitle.textContent = "Onay";
    el.sheetLine1.textContent = "Ã–zet";
    el.sheetLine2.textContent = `${state.service === "taxi" ? "ðŸš• Taxi" : "ðŸ“¦ Kurye"} â€¢ ${state.distanceKm} km â€¢ ${state.price} â‚º (Tahmini)`;

    el.sheetBody.innerHTML = `
      <div class="sheetCard">
        <div class="sheetLine1">Nereden â†’ Nereye</div>
        <div class="sheetLine2">SeÃ§ildi</div>
        <div style="margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45">
          Konumlar haritadan seÃ§ildi. Ãœcret, seÃ§ilen mesafeye gÃ¶re <b>tahmini</b> hesaplanÄ±r.
        </div>
      </div>
      ${state.service === "courier" ? `
        <div class="sheetCard">
          <div class="sheetLine1">Kurye Bilgileri</div>
          <div class="sheetLine2">${escapeHtml(state.courier.receiver_name)} â€¢ ${escapeHtml(normalizePhoneTR(el.recvPhone.value||""))}</div>
          ${state.courier.note ? `<div style="margin-top:6px;font-size:12px;color:var(--muted)">${escapeHtml(state.courier.note)}</div>` : ``}
        </div>
      ` : ``}
    `;

    el.sheetActions.innerHTML = "";
    const btnBack = mkBtn("Geri", "ghost", closeSheet);
    const btnGo   = mkBtn("Ã‡aÄŸrÄ± OluÅŸtur", "primary", createJob);

    el.sheetActions.appendChild(btnBack);
    el.sheetActions.appendChild(btnGo);

    setToast("");
    openSheet();
  }

  async function createJob(){
    // UI kilidi
    el.sheetActions.querySelectorAll("button").forEach(b=>b.disabled=true);
    setToast("GÃ¶nderiliyorâ€¦", false, "ok");

    const payload = {
      action:"create_job",
      user:{
        name: state.user.name,
        phone: state.user.phone,
        email: state.user.email || "",
        kvkkAccepted:true,
        kvkkVersion: state.user.kvkkVersion || "v1",
        source:"web"
      },
      job:{
        service_type: state.service,
        pickup:{ lat: state.pickup.lat, lng: state.pickup.lng, address:"" },
        dropoff:{ lat: state.dropoff.lat, lng: state.dropoff.lng, address:"" },
        distance_km: state.distanceKm,
        estimated_price: state.price,
        currency:"TRY",
        courier_payload: (state.service==="courier") ? {
          receiver_name: state.courier.receiver_name,
          receiver_phone: normalizePhoneTR(el.recvPhone.value||""),
          note: state.courier.note || ""
        } : null,
        notes:""
      }
    };

    try{
      const data = await safePost(API_URL, payload);
      if(!data || !data.ok) throw new Error((data && (data.message||data.error)) ? (data.message||data.error) : "Ä°ÅŸ oluÅŸturulamadÄ±");

      closeSheet();
      setToast("");

      // A: "SÃ¼rÃ¼cÃ¼ aranÄ±yor" alt kartta metin
      el.hintText.innerHTML = `Talebiniz alÄ±ndÄ±. <b>Uygun sÃ¼rÃ¼cÃ¼ aranÄ±yorâ€¦</b> (Ä°ÅŸ: ${escapeHtml(data?.job?.job_id || "â€”")})`;
      el.btnContinue.disabled = true;

    }catch(err){
      setToast((err && err.message) ? err.message : String(err), true);
      el.sheetActions.querySelectorAll("button").forEach(b=>b.disabled=false);
    }
  }

  function openSheet(){
    el.sheetMask.classList.add("open");
    el.sheet.classList.add("open");
  }
  function closeSheet(){
    el.sheetMask.classList.remove("open");
    el.sheet.classList.remove("open");
    setToast("");
  }
  function setToast(text, isError=false, kind){
    el.toast.textContent = text || "";
    el.toast.className = "toast" + (isError ? " error" : (kind==="ok" ? " ok" : ""));
  }
  function mkBtn(text, variant, onClick){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "btn " + (variant === "primary" ? "primary" : "ghost");
    b.textContent = text;
    b.addEventListener("click", onClick);
    return b;
  }

  // =========================
  // RESET
  // =========================
  function resetAll(){
    state.picking = "pickup";
    state.pickup = null;
    state.dropoff = null;
    state.distanceKm = null;
    state.price = null;

    state.courier = { receiver_name:"", receiver_phone:"", note:"" };
    el.recvName.value = "";
    el.recvPhone.value = "";
    el.courierNote.value = "";

    if(pickupMarker){ map.removeLayer(pickupMarker); pickupMarker = null; }
    if(dropoffMarker){ map.removeLayer(dropoffMarker); dropoffMarker = null; }
    if(routeLine){ map.removeLayer(routeLine); routeLine = null; }

    updateUI();
  }

  // =========================
  // HTTP
  // =========================
  async function safePost(url, payload){
    const res = await fetch(API_URL, {
  method: "POST",
  mode: "no-cors",
  body: JSON.stringify(payload)
});
    const txt = await res.text();
    try{ return JSON.parse(txt); }catch(_){ return { ok:false, message:"GeÃ§ersiz yanÄ±t", raw:txt }; }
  }

  // =========================
  // STORAGE
  // =========================
  function loadUser(){
    try{
      const s = localStorage.getItem("sepettaxi_user_v1");
      if(!s) return null;
      const u = JSON.parse(s);
      return (u && u.phone && u.name) ? u : null;
    }catch(_){ return null; }
  }
  function saveUser(u){
    try{ localStorage.setItem("sepettaxi_user_v1", JSON.stringify(u)); }catch(_){}
  }

  // =========================
  // HELPERS
  // =========================
  function normalizePhoneTR(raw){
    let s = String(raw||"").trim();
    s = s.replace(/\s+/g,"").replace(/-/g,"").replace(/[()]/g,"");
    s = s.replace(/^\+/,"");
    s = s.replace(/\D/g,"");
    if(s.startsWith("90")) s = s.slice(2);
    if(!s.startsWith("0")) s = "0"+s;
    return s;
  }
  function isPhoneTR(phone){ return /^0\d{10}$/.test(phone); }
  function escapeHtml(str){
    return String(str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
  }

  // initial overlay based on state
  refreshMapOverlay();
  updateUI();
})();
</script>
</body>
</html>
