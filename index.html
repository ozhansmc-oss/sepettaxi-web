<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* === SENÄ°N CSS â€“ DEÄžÄ°ÅžMEDÄ° === */
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--line:#222;--muted:#9a9a9a;--card1:#141414;--card2:#0f0f0f}
#landing{position:fixed;inset:0;background:#000 url("assets/landing.png") center/cover no-repeat;z-index:1000}
#landing .overlay{position:absolute;inset:0;background:rgba(0,0,0,.65);display:flex;flex-direction:column;align-items:center;justify-content:center}
#landing h1{font-size:40px;margin:0 0 18px 0}
#landing span{color:var(--y)}
#landing button{background:var(--y);color:#000;border:0;border-radius:28px;padding:14px 46px;font-size:17px;font-weight:900}
#app{display:none;height:100%}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid var(--line)}
header span{color:var(--y)}
#map{height:32vh}
#panel{height:calc(68vh - 56px);padding:10px;display:flex;flex-direction:column;gap:8px;padding-bottom:220px}
.card{background:linear-gradient(180deg,var(--card1),var(--card2));border-radius:14px;padding:10px;border:1px solid rgba(255,255,255,.04)}
.serviceRow{display:flex;gap:8px}
.serviceBtn{flex:1;padding:11px;border-radius:12px;text-align:center;border:1px solid var(--line);background:#0b0b0b;color:#bbb}
.serviceBtn.active{border-color:var(--y);color:#fff;background:rgba(245,196,0,.1)}
.input{width:100%;padding:11px;border-radius:12px;border:1px solid #1f1f1f;background:#000;color:#fff}
#courierBox{display:none}
#stickyBar{position:fixed;left:0;right:0;bottom:0;padding:10px;background:#000}
#ctaBtn{border-radius:30px;padding:16px;text-align:center;font-weight:900}
#ctaBtn.enabled{background:var(--y);color:#000}
#ctaBtn.disabled{background:#333;color:#888}
#register{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:500}
#register .box{background:#0f0f0f;border-radius:16px;padding:14px;width:90%;max-width:340px}
#searching{position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:600}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button onclick="start()">BAÅžLA</button>
  </div>
</div>

<!-- APP -->
<div id="app">
<header>Sepet<span>Taxi</span></header>
<div id="map"></div>

<div id="panel">
  <div class="card">
    <div class="serviceRow">
      <div id="svcTaxi" class="serviceBtn" onclick="pickService('taxi')">ðŸš• Taksi</div>
      <div id="svcCourier" class="serviceBtn" onclick="pickService('courier')">ðŸ“¦ Kurye</div>
    </div>
  </div>

  <div class="card">
    <input id="fromAddr" class="input" readonly placeholder="Nereden">
  </div>

  <div class="card">
    <input id="toAddr" class="input" readonly placeholder="Nereye (haritaya dokun)">
  </div>

  <div id="courierBox" class="card">
    <input id="pkgType" class="input" placeholder="Paket TÃ¼rÃ¼">
    <input id="rcvName" class="input" placeholder="AlÄ±cÄ± AdÄ±">
    <input id="rcvPhone" class="input" placeholder="AlÄ±cÄ± Telefon" maxlength="11">
  </div>
</div>
</div>

<div id="stickyBar">
  <div id="ctaBtn" class="disabled" onclick="ctaClick()">Ã‡AÄžIR</div>
</div>

<div id="searching">
  <div>SÃ¼rÃ¼cÃ¼ aranÄ±yorâ€¦</div>
</div>

<div id="register">
  <div class="box">
    <input id="fn" class="input" placeholder="Ad">
    <input id="ln" class="input" placeholder="Soyad">
    <input id="ph" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <button onclick="saveUser()">KAYDI TAMAMLA</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

/* ================= STATE ================= */
let map,fromM,toM,service=null,registered=false,user=null,jobId=null;

/* ================= MAP ================= */
function start(){
  landing.style.display="none";
  app.style.display="block";
  map=L.map("map").setView([40.195,29.060],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  navigator.geolocation.getCurrentPosition(p=>{
    fromM=L.marker([p.coords.latitude,p.coords.longitude]).addTo(map);
  });
  map.on("click",e=>{
    toM ? toM.setLatLng(e.latlng) : (toM=L.marker(e.latlng).addTo(map));
    toAddr.value=`${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
    setCta();
  });
}

function pickService(s){
  if(!registered){ register.style.display="flex"; return; }
  service=s;
  svcTaxi.classList.toggle("active",s==="taxi");
  svcCourier.classList.toggle("active",s==="courier");
  courierBox.style.display=s==="courier"?"block":"none";
  setCta();
}

function saveUser(){
  if(fn.value.length<2||ln.value.length<2||!/^05\d{9}$/.test(ph.value)) return;
  user={name:fn.value+" "+ln.value,phone:ph.value};
  registered=true;
  register.style.display="none";
}

function canCall(){
  if(!registered||!service||!fromM||!toM) return false;
  if(service==="courier"){
    if(pkgType.value.length<2||rcvName.value.length<2||!/^05\d{9}$/.test(rcvPhone.value)) return false;
  }
  return true;
}

function setCta(){
  ctaBtn.className=canCall()?"enabled":"disabled";
}

async function ctaClick(){
  if(!canCall()) return;
  searching.style.display="flex";
  const payload={
    action:"createJob",
    service,
    pickup_lat:fromM.getLatLng().lat,
    pickup_lng:fromM.getLatLng().lng,
    dropoff_lat:toM.getLatLng().lat,
    dropoff_lng:toM.getLatLng().lng,
    customer_name:user.name,
    customer_phone:user.phone,
    package_type:service==="courier"?pkgType.value:"",
    receiver_name:service==="courier"?rcvName.value:"",
    receiver_phone:service==="courier"?rcvPhone.value:""
  };
  const r=await fetch(BACKEND_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
  const d=await r.json();
  if(d&&d.job_id) location.href=`track.html?job_id=${d.job_id}`;
}
</script>

<script>
/* === SUBDOMAIN ROUTING === */
(function(){
  const h=location.hostname;
  if(h.startsWith("admin.")) location.href="/admin.html";
  if(h.startsWith("driver.")) location.href="/driver.html";
})();
</script>

</body>
</html>
