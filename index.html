<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--line:#222;--muted:#9a9a9a;--card1:#141414;--card2:#0f0f0f}

/* LANDING */
#landing{position:fixed;inset:0;background:#000 url("assets/landing.png") center/cover no-repeat;z-index:1000}
#landing .overlay{position:absolute;inset:0;background:rgba(0,0,0,.65);display:flex;flex-direction:column;align-items:center;justify-content:center}
#landing h1{font-size:40px;margin:0 0 18px 0}
#landing span{color:var(--y)}
#landing button{background:var(--y);color:#000;border:0;border-radius:28px;padding:14px 46px;font-size:17px;font-weight:900;cursor:pointer}

/* HEADER */
header{
  position:relative;
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:900;
  border-bottom:1px solid var(--line)
}
header span{color:var(--y)}

#driverCtas{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  display:flex;
  gap:8px;
  align-items:center;
}
.pill{
  background:#0f0f0f;
  border:1px solid var(--line);
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  opacity:.82;
  display:flex;
  gap:6px;
  align-items:center;
  white-space:nowrap;
}
.pill a{color:#aaa;text-decoration:none}
.pill:hover{opacity:1}

/* MAP & PANEL */
#app{display:none;height:100%}

#map{height:40vh;border-bottom:1px solid var(--line)}
@media(min-width:900px){ #map{height:45vh} }

#panel{
  height:calc(60vh - 56px);
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:8px;
  padding-bottom:220px
}
@media(min-width:900px){ #panel{height:calc(55vh - 56px)} }

.card{background:linear-gradient(180deg,var(--card1),var(--card2));border-radius:14px;padding:10px;border:1px solid rgba(255,255,255,.04)}
.cardTitle{display:flex;justify-content:space-between;align-items:center}
.badge{font-size:11px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px}

.serviceRow{display:flex;gap:8px}
.serviceBtn{
  flex:1;padding:11px;border-radius:12px;border:1px solid var(--line);
  background:#0b0b0b;color:#bdbdbd;cursor:pointer;user-select:none;
}
.serviceBtn.active{border-color:var(--y);color:#fff;background:rgba(245,196,0,.1)}

.input{width:100%;padding:11px;border-radius:12px;border:1px solid #1f1f1f;background:#000;color:#fff}
.helper{font-size:11px;color:var(--muted)}

.stats{display:flex;gap:8px}
.stat{flex:1;background:#0b0b0b;border-radius:14px;padding:12px;text-align:center}
.stat .lbl{font-size:11px;color:#aaa}
.stat .val{font-size:18px;font-weight:900}

#courierBox{display:none}

#stickyBar{position:fixed;left:0;right:0;bottom:0;padding:10px;background:#000;border-top:1px solid var(--line)}
#ctaBtn{border-radius:30px;padding:16px;text-align:center;font-weight:900;user-select:none}
#ctaBtn.enabled{background:var(--y);color:#000;cursor:pointer}
#ctaBtn.disabled{background:#2a2a2a;color:#999}

#searching{
  position:fixed;inset:0;background:rgba(0,0,0,.95);
  display:none;align-items:center;justify-content:center;flex-direction:column;z-index:600
}
#searching .spin{margin-top:10px;opacity:.8;font-size:12px;color:#bbb}
#searching .small{margin-top:10px;font-size:12px;color:#bbb;opacity:.85;max-width:420px;text-align:center;line-height:1.35}
#searching .btns{display:flex;gap:8px;margin-top:14px}
#searching button{
  border:1px solid var(--line);background:#0f0f0f;color:#ddd;border-radius:999px;
  padding:8px 12px;font-size:12px;cursor:pointer
}
#searching button:hover{opacity:.95}

#toast{
  position:fixed;left:50%;top:12px;transform:translateX(-50%);
  background:#111;padding:10px 12px;border-radius:999px;font-size:12px;display:none;
  border:1px solid var(--line);z-index:1200
}
</style>
</head>

<body>
<div id="toast"></div>

<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button id="startBtn" type="button">BAÅLA</button>
  </div>
</div>

<div id="app">
  <header>
    <div id="driverCtas">
      <div class="pill">ğŸš— <a href="driver.html">SÃ¼rÃ¼cÃ¼ mÃ¼sÃ¼n?</a></div>
      <div class="pill">ğŸ“ <a href="driver-register.html">SÃ¼rÃ¼cÃ¼ Ol</a></div>
    </div>
    Sepet<span>Taxi</span>
  </header>

  <div id="map"></div>

  <div id="panel">
    <div class="card">
      <div class="cardTitle">
        <b>Hizmet SeÃ§</b>
        <div id="regBadge" class="badge">KayÄ±t: Bekliyor</div>
      </div>
      <div class="serviceRow">
        <div id="btnTaxi" class="serviceBtn active">ğŸš• Taksi</div>
        <div id="btnCourier" class="serviceBtn">ğŸ“¦ Kurye</div>
      </div>
      <div id="helperText" class="helper">Haritada varÄ±ÅŸ noktasÄ±na dokun.</div>
    </div>

    <div id="taxiBox">
      <div class="card">
        <input id="fromInput" class="input" placeholder="Nereden (otomatik konum)" readonly>
        <div class="helper">BaÅŸlangÄ±Ã§ konumu otomatik alÄ±nÄ±r.</div>
      </div>

      <div class="card">
        <input id="toInput" class="input" placeholder="Nereye (haritadan seÃ§)" readonly>
        <div class="helper">VarÄ±ÅŸ iÃ§in haritaya dokun.</div>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="lbl">Mesafe</div>
          <div id="distVal" class="val">â€”</div>
        </div>
        <div class="stat">
          <div class="lbl">Ãœcret</div>
          <div id="priceVal" class="val">â€”</div>
        </div>
      </div>
    </div>

    <div id="courierBox">
      <div class="card">
        <b>Kurye</b>
        <div class="helper">Kurye akÄ±ÅŸÄ± ayrÄ± sayfada Ã§alÄ±ÅŸÄ±r. Devam etmek iÃ§in aÅŸaÄŸÄ±dan ilerle.</div>
      </div>
    </div>
  </div>
</div>

<div id="stickyBar">
  <div id="ctaBtn" class="disabled">TAKSÄ° Ã‡AÄIR</div>
</div>

<div id="searching">
  <div><b>SÃ¼rÃ¼cÃ¼ aranÄ±yorâ€¦</b></div>
  <div class="spin" id="searchSpin">Atama bekleniyor</div>
  <div class="small" id="searchInfo">Otomatik atama modunda ilk mÃ¼sait sÃ¼rÃ¼cÃ¼ye yÃ¶nlendiriyoruz.</div>
  <div class="btns">
    <button id="cancelBtn" type="button">Ä°ptal</button>
    <button id="goTrackBtn" type="button" style="display:none">Takibe Git</button>
  </div>
</div>

<!-- Global config -->
<script src="config.js"></script>

<script>
/* =========================
   CORE STATE
========================= */
let map, userMarker, destMarker, routeLine;
let userLatLng = null;
let destLatLng = null;
let service = "taxi"; // taxi | courier

let currentJobId = "";
let currentTrackToken = "";
let pollTimer = null;
let pollStartedAt = 0;

const $ = (id)=>document.getElementById(id);

/* =========================
   UTIL UI
========================= */
function toast(msg, ms=2400){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=>{ t.style.display="none"; }, ms);
}
function showSearching(on){
  $("searching").style.display = on ? "flex" : "none";
}
function setCTAEnabled(on){
  const cta = $("ctaBtn");
  cta.className = on ? "enabled" : "disabled";
}
function setCTALabel(){
  $("ctaBtn").textContent = (service==="taxi") ? "TAKSÄ° Ã‡AÄIR" : "KURYE DEVAM";
}
function setService(next){
  service = next;
  $("btnTaxi").classList.toggle("active", service==="taxi");
  $("btnCourier").classList.toggle("active", service==="courier");

  $("taxiBox").style.display   = (service==="taxi") ? "block" : "none";
  $("courierBox").style.display= (service==="courier") ? "block" : "none";

  $("helperText").textContent = (service==="taxi")
    ? "Haritada varÄ±ÅŸ noktasÄ±na dokun."
    : "Kurye akÄ±ÅŸÄ± iÃ§in devam et.";

  setCTALabel();

  if(service==="taxi"){
    setCTAEnabled(!!(userLatLng && destLatLng));
  }else{
    setCTAEnabled(true);
  }
}

/* =========================
   BACKEND API (v2.4 router)
========================= */
function backendUrl(){
  const u = (window.SEPT && window.SEPT.BACKEND_URL) ? window.SEPT.BACKEND_URL : "";
  if(!u) throw new Error("BACKEND_URL yok (config.js yÃ¼klenmemiÅŸ olabilir).");
  return u;
}
async function apiPost(action, payload){
  const url = backendUrl();
  const body = Object.assign({ action }, payload || {});
  const res = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(body)
  });
  const txt = await res.text();
  let data = {};
  try{ data = JSON.parse(txt); }catch(e){ data = { ok:false, error:"JSON parse", raw:txt }; }
  return data;
}
async function apiGet(action, params){
  const url = new URL(backendUrl());
  url.searchParams.set("action", action);
  Object.entries(params||{}).forEach(([k,v])=>url.searchParams.set(k, v));
  const res = await fetch(url.toString(), { method:"GET" });
  const txt = await res.text();
  let data = {};
  try{ data = JSON.parse(txt); }catch(e){ data = { ok:false, error:"JSON parse", raw:txt }; }
  return data;
}

/* =========================
   MAP INIT
========================= */
function initMap(){
  if(map) return;

  map = L.map("map", { zoomControl:true });
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap"
  }).addTo(map);

  // Fallback (Bursa civarÄ±)
  map.setView([40.195, 29.060], 12);

  map.on("click", (e)=>{
    if(service!=="taxi") return;
    destLatLng = e.latlng;

    if(!destMarker) destMarker = L.marker(destLatLng).addTo(map);
    else destMarker.setLatLng(destLatLng);

    $("toInput").value = `${destLatLng.lat.toFixed(5)}, ${destLatLng.lng.toFixed(5)}`;
    computeDistanceAndPrice();
  });
}
function fitIfReady(){
  if(!map) return;
  if(userLatLng && destLatLng){
    const bounds = L.latLngBounds([userLatLng, destLatLng]);
    map.fitBounds(bounds.pad(0.25));
  }else if(userLatLng){
    map.setView(userLatLng, 15);
  }
}

/* =========================
   GEOLOCATION
========================= */
function getLocation(){
  if(!navigator.geolocation){
    toast("TarayÄ±cÄ± konum desteÄŸi yok.");
    return;
  }
  toast("Konum alÄ±nÄ±yorâ€¦");

  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      userLatLng = L.latLng(pos.coords.latitude, pos.coords.longitude);
      $("fromInput").value = `${userLatLng.lat.toFixed(5)}, ${userLatLng.lng.toFixed(5)}`;

      if(!userMarker) userMarker = L.marker(userLatLng).addTo(map);
      else userMarker.setLatLng(userLatLng);

      $("regBadge").textContent = "KayÄ±t: HazÄ±r";
      toast("Konum alÄ±ndÄ±. VarÄ±ÅŸ iÃ§in haritaya dokun.");
      fitIfReady();

      if(service==="taxi"){
        setCTAEnabled(!!(userLatLng && destLatLng));
      }
    },
    (err)=>{
      console.warn(err);
      $("regBadge").textContent = "KayÄ±t: Bekliyor";
      toast("Konum izni verilmedi veya alÄ±namadÄ±.");
    },
    { enableHighAccuracy:true, timeout:12000, maximumAge:8000 }
  );
}

/* =========================
   DISTANCE & PRICE
   (UI iÃ§in local; backend fiyatÄ± da saklÄ±yor)
========================= */
function haversineKm(a,b){
  const R = 6371;
  const dLat = (b.lat-a.lat) * Math.PI/180;
  const dLon = (b.lng-a.lng) * Math.PI/180;
  const lat1 = a.lat*Math.PI/180, lat2 = b.lat*Math.PI/180;
  const x = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}

function computeDistanceAndPrice(){
  if(!(userLatLng && destLatLng)) return;

  if(routeLine) routeLine.remove();
  routeLine = L.polyline([userLatLng, destLatLng]).addTo(map);

  const km = Math.max(0.1, haversineKm(userLatLng, destLatLng));
  $("distVal").textContent = `${km.toFixed(1)} km`;

  // Kilitli fiyat mantÄ±ÄŸÄ±nÄ± ileride aynÄ± ÅŸekilde koyacaÄŸÄ±z.
  // Åimdilik stabil demo: aÃ§Ä±lÄ±ÅŸ + km baÅŸÄ±.
  const base = 35;
  const perKm = 18;
  const price = Math.round(base + km * perKm);

  $("priceVal").textContent = `${price} â‚º`;

  setCTAEnabled(true);
  fitIfReady();
  return { km, price };
}

/* =========================
   JOB FLOW (createJob -> poll checkJob -> redirect track)
========================= */
function stopPolling(){
  if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
}
function gotoTrack(){
  if(!currentJobId) return;
  // track.htmlâ€™in kendi tarafÄ±nda job_id ile getLive/checkJob yapmasÄ± iÃ§in
  const url = new URL(window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, "/track.html"));
  url.searchParams.set("job_id", currentJobId);
  if(currentTrackToken) url.searchParams.set("track_token", currentTrackToken);
  window.location.href = url.toString();
}

async function pollJob(){
  if(!currentJobId) return;

  const elapsed = Date.now() - pollStartedAt;
  const TIMEOUT_MS = 60000; // 60s

  if(elapsed > TIMEOUT_MS){
    stopPolling();
    $("searchSpin").textContent = "Atama gecikti";
    $("searchInfo").textContent = "HenÃ¼z mÃ¼sait sÃ¼rÃ¼cÃ¼ bulunamadÄ±. LÃ¼tfen biraz sonra tekrar deneyin.";
    $("goTrackBtn").style.display = "inline-block"; // job oluÅŸtuÄŸu iÃ§in takibe gidebilir
    return;
  }

  const r = await apiGet("checkJob", { job_id: currentJobId });

  if(r && r.ok){
    const st = String(r.status||"");
    if(st==="assigned" || st==="on_route"){
      stopPolling();
      $("searchSpin").textContent = "SÃ¼rÃ¼cÃ¼ atandÄ±";
      $("searchInfo").textContent = "Takip ekranÄ±na yÃ¶nlendiriliyorsunuzâ€¦";
      setTimeout(gotoTrack, 650);
      return;
    }
    if(st==="cancelled"){
      stopPolling();
      $("searchSpin").textContent = "Ä°ptal edildi";
      $("searchInfo").textContent = "Ä°ÅŸ iptal edildi.";
      setTimeout(()=>showSearching(false), 900);
      return;
    }
    if(st==="completed"){
      stopPolling();
      $("searchSpin").textContent = "TamamlandÄ±";
      $("searchInfo").textContent = "Ä°ÅŸ tamamlandÄ±.";
      setTimeout(()=>showSearching(false), 900);
      return;
    }

    // pending vb.
    $("searchSpin").textContent = "Atama bekleniyor";
    return;
  }

  // ok deÄŸilse yine de bekle (geÃ§ici network vs.)
  console.warn("checkJob error", r);
}

async function createTaxiJob(){
  if(!(userLatLng && destLatLng)){
    toast("LÃ¼tfen varÄ±ÅŸ noktasÄ± seÃ§in.");
    return;
  }

  const calc = computeDistanceAndPrice() || {};
  const km = calc.km || 0;
  const price = calc.price || 0;

  // minimum adresler: coords string
  const fromAddr = $("fromInput").value || `${userLatLng.lat},${userLatLng.lng}`;
  const toAddr   = $("toInput").value   || `${destLatLng.lat},${destLatLng.lng}`;

  showSearching(true);
  $("searchSpin").textContent = "Ä°ÅŸ oluÅŸturuluyor";
  $("searchInfo").textContent = "Talebiniz sisteme iletiliyorâ€¦";
  $("goTrackBtn").style.display = "none";

  try{
    const payload = {
      service_type: "taxi",
      customer_phone: "", // mÃ¼ÅŸteri kayÄ±t ekranÄ± son kilitte ayrÄ±ydÄ±; ÅŸimdilik boÅŸ geÃ§iyoruz
      from_address: fromAddr,
      to_address: toAddr,
      pickup_lat: userLatLng.lat,
      pickup_lng: userLatLng.lng,
      dropoff_lat: destLatLng.lat,
      dropoff_lng: destLatLng.lng,
      distance_km: km,
      price: price,
      final_price: price
    };

    const res = await apiPost("createJob", payload);

    if(!(res && res.ok)){
      console.warn("createJob fail", res);
      $("searchSpin").textContent = "Hata";
      $("searchInfo").textContent = (res && res.error) ? String(res.error) : "createJob baÅŸarÄ±sÄ±z";
      setTimeout(()=>showSearching(false), 1400);
      return;
    }

    currentJobId = String(res.job_id || "");
    currentTrackToken = String(res.track_token || "");
    sessionStorage.setItem("SEPT_job_id", currentJobId);
    sessionStorage.setItem("SEPT_track_token", currentTrackToken);

    $("searchSpin").textContent = "SÃ¼rÃ¼cÃ¼ aranÄ±yorâ€¦";
    $("searchInfo").textContent = "Otomatik atama modunda ilk mÃ¼sait sÃ¼rÃ¼cÃ¼ye yÃ¶nlendiriyoruz.";

    pollStartedAt = Date.now();
    stopPolling();
    const pollMs = (window.SEPT && window.SEPT.POLL_MS) ? parseInt(window.SEPT.POLL_MS,10) : 3000;
    pollTimer = setInterval(pollJob, Math.max(1500, pollMs));
    pollJob(); // immediate
  }catch(e){
    console.error(e);
    $("searchSpin").textContent = "BaÄŸlantÄ± hatasÄ±";
    $("searchInfo").textContent = "Backendâ€™e ulaÅŸÄ±lamadÄ±. (config.js BACKEND_URL kontrol edin)";
    setTimeout(()=>showSearching(false), 1600);
  }
}

/* =========================
   CTA CLICK
========================= */
function onCTA(){
  if(service==="courier"){
    window.location.href = "courier.html";
    return;
  }
  if($("ctaBtn").classList.contains("disabled")) return;
  createTaxiJob();
}

/* =========================
   START
========================= */
function start(){
  $("landing").style.display = "none";
  $("app").style.display = "block";

  initMap();

  // Leaflet render fix (display:none -> block)
  setTimeout(()=>{ map.invalidateSize(); }, 60);

  getLocation();
  setService("taxi");
}

function cancelFlow(){
  stopPolling();
  currentJobId = "";
  currentTrackToken = "";
  showSearching(false);
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("startBtn").addEventListener("click", start);
  $("btnTaxi").addEventListener("click", ()=>setService("taxi"));
  $("btnCourier").addEventListener("click", ()=>setService("courier"));
  $("ctaBtn").addEventListener("click", onCTA);

  $("cancelBtn").addEventListener("click", cancelFlow);
  $("goTrackBtn").addEventListener("click", gotoTrack);
});
</script>

</body>
</html>
