<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>SepetTaxi â€“ Taksi & Kurye</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
.screen{display:none;min-height:100vh;padding:20px;box-sizing:border-box}
.active{display:flex;flex-direction:column}
.center{justify-content:center;align-items:center;text-align:center}
button{width:100%;padding:16px;margin-top:14px;border-radius:14px;border:none;font-size:16px;background:#fff;color:#000}
input{width:100%;padding:14px;margin:8px 0;border-radius:10px;border:none}
.list-item{padding:18px;border-bottom:1px solid #333;font-size:18px;display:flex;justify-content:space-between;cursor:pointer}
#map{height:50vh;border-radius:12px;margin-top:10px}
.small{color:#aaa;font-size:14px}
</style>
</head>

<body>

<script>
const API_URL = "BURAYA_EXEC_URL";

/* fiyatlar */
const PRICES = {
  taksi:{open:30,km:12},
  kurye:{open:25,km:10}
};

let service="taksi";
let map,fromLL,toLL,markerFrom,markerTo;
let distance=0, price=0;
</script>

<!-- 1. KAYIT -->
<div id="s1" class="screen active center">
  <h1>SepetTaxi</h1>
  <input id="name" placeholder="Ad Soyad">
  <input id="phone" placeholder="Telefon">
  <label><input type="checkbox" id="kvkk"> KVKK kabul</label>
  <label><input type="checkbox" id="soz"> Hizmet sÃ¶zleÅŸmesi</label>
  <button onclick="register()">Devam Et</button>
</div>

<!-- 2. HÄ°ZMET -->
<div id="s2" class="screen">
  <h2>Hizmet SeÃ§</h2>
  <div class="list-item" onclick="choose('taksi')">ğŸš• Taksi</div>
  <div class="list-item" onclick="choose('kurye')">ğŸ›µ Kurye</div>
</div>

<!-- 3. ADRES -->
<div id="s3" class="screen">
  <h2>Adres SeÃ§</h2>
  <input id="from" placeholder="Nereden">
  <input id="to" placeholder="Nereye">
  <div id="map"></div>
  <button onclick="calc()">Ãœcreti Hesapla</button>
</div>

<!-- 4. ONAY -->
<div id="s4" class="screen center">
  <h2 id="priceText">0 TL</h2>
  <p class="small" id="info"></p>
  <button onclick="createJob()">Ã‡aÄŸÄ±r</button>
</div>

<script>
function go(n){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById("s"+n).classList.add("active");
  if(n===3) setTimeout(initMap,300);
}

function register(){
  const n=name.value.trim(), p=phone.value.trim();
  if(!n||!p||!kvkk.checked||!soz.checked){
    alert("Bilgiler eksik"); return;
  }
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"registerUser",user_name:n,user_phone:p})
  }).then(r=>r.json()).then(res=>{
    if(res.ok) go(2);
    else alert(res.error);
  });
}

function choose(t){ service=t; go(3); }

function initMap(){
  if(map) return;
  map=L.map("map").setView([40.195,29.06],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  navigator.geolocation.getCurrentPosition(async pos=>{
    fromLL=[pos.coords.latitude,pos.coords.longitude];
    markerFrom=L.marker(fromLL).addTo(map);
    from.value=await rev(fromLL);
    map.setView(fromLL,14);
  });

  map.on("click",async e=>{
    toLL=[e.latlng.lat,e.latlng.lng];
    if(markerTo) map.removeLayer(markerTo);
    markerTo=L.marker(toLL).addTo(map);
    to.value=await rev(toLL);
  });
}

async function rev(ll){
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${ll[0]}&lon=${ll[1]}`);
  const d=await r.json();
  return d.display_name||ll.join(",");
}

function dist(a,b){
  const R=6371;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLng=(b[1]-a[1])*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}

function calc(){
  if(!fromLL||!toLL){ alert("Konum seÃ§"); return; }
  distance=dist(fromLL,toLL);
  price=Math.round(PRICES[service].open+distance*PRICES[service].km);
  priceText.innerText=price+" TL";
  info.innerText=distance.toFixed(2)+" km â€“ "+service.toUpperCase();
  go(4);
}

function createJob(){
  fetch(API_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:"createJob",
      service_type:service,
      user_name:name.value,
      user_phone:phone.value,
      pickup_address:from.value,
      pickup_lat:String(fromLL[0]),
      pickup_lng:String(fromLL[1]),
      dropoff_address:to.value,
      dropoff_lat:String(toLL[0]),
      dropoff_lng:String(toLL[1])
    })
  }).then(r=>r.json()).then(res=>{
    if(res.ok) alert("Ã‡aÄŸrÄ± oluÅŸturuldu");
    else alert(res.error);
  });
}
</script>

</body>
</html>
/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#000; color:#fff; }
    .screen { display:none; min-height:100vh; padding:20px; box-sizing:border-box; }
    .active { display:flex; flex-direction:column; }
    .center { justify-content:center; align-items:center; text-align:center; }

    button {
      width:100%;
      padding:16px;
      margin-top:15px;
      border-radius:14px;
      border:none;
      font-size:16px;
      cursor:pointer;
      background:#fff;
      color:#000;
    }
    button:disabled { opacity:.6; cursor:not-allowed; }

    .list-item {
      padding:18px;
      border-bottom:1px solid #333;
      font-size:18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
    }

    input {
      width:100%;
      padding:14px;
      margin:8px 0;
      border-radius:10px;
      border:none;
      font-size:15px;
    }

    .small { color:#aaa; font-size:14px; }
    h1 span { color:#FFD600; }

    #map {
      width:100%;
      height:50vh;
      border-radius:12px;
      margin-top:10px;
    }

    .pill {
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      background:#1a1a1a;
      border:1px solid #333;
      color:#ddd;
      margin-top:8px;
    }
  </style>
</head>
<body>

<script>
/* =========================
   BACKEND (KÄ°LÄ°TLÄ°)
========================= */
const API_URL = "https://script.google.com/macros/s/AKfycbyn8FCoEHg4R5nAFGsuFw8GNp5HfMD8RCsr_rJHvf-8_kOijkJEM5GSaYRwzmN6s4ck/exec"; 
   =========================
   FÄ°YAT (TRANSFER YOK)
========================= */
const PRICES = {
  taksi: { open: 30, km: 12 },
  kurye: { open: 25, km: 10 }
};

let selectedService = "taksi";
let map, markerFrom, markerTo;
let fromLatLng = null;
let toLatLng = null;
let lastPrice = 0;
let lastDistance = 0;
let cachedFromAddress = "";
let cachedToAddress = "";

/* =========================
   USER (KAYIT AYRI)
   - register.html sonrasÄ±nda localStorage set edilir
========================= */
function getUser_(){
  const user_name = (localStorage.getItem("user_name") || "").trim();
  const user_phone = (localStorage.getItem("user_phone") || "").trim();
  return { user_name, user_phone };
}
</script>

<!-- 1. AÃ‡ILIÅ -->
<div id="screen1" class="screen active center">
  <h1>SepetTa<span>x</span>i</h1>
  <p class="small">Taksi & Kurye â€“ hÄ±zlÄ± talep oluÅŸtur.</p>
  <div class="pill" id="userPill">KullanÄ±cÄ±: kontrol ediliyorâ€¦</div>
  <button onclick="startFlow()">Devam Et</button>
</div>

<!-- 2. HÄ°ZMET -->
<div id="screen2" class="screen">
  <h2>Ne yapmak istiyorsun?</h2>
  <div class="list-item" onclick="selectService('taksi')">ğŸš• Taksi Ã‡aÄŸÄ±r <span>â€º</span></div>
  <div class="list-item" onclick="selectService('kurye')">ğŸ›µ Kurye Ã‡aÄŸÄ±r <span>â€º</span></div>
</div>

<!-- 3. ADRES -->
<div id="screen3" class="screen">
  <h2>Adres SeÃ§imi</h2>

  <input id="from" placeholder="Nereden? (Otomatik alÄ±nÄ±r)" />
  <input id="to" placeholder="Nereye? (Haritadan seÃ§)" />

  <div id="map"></div>
  <button onclick="hesaplaVeDevam()">Devam Et</button>
</div>

<!-- 4. ÃœCRET -->
<div id="screen4" class="screen">
  <h2 id="priceText">0 TL</h2>
  <p class="small" id="infoText">0 km</p>

  <label><input type="radio" name="odeme" checked> Nakit</label><br>
  <label><input type="radio" name="odeme"> Kart</label><br>
  <label><input type="radio" name="odeme"> Online</label><br><br>

  <button onclick="goTo(5)">Ã–demeyi Onayla</button>
</div>

<!-- 5. GÃ–NDER -->
<div id="screen5" class="screen center">
  <h2>HazÄ±rsÄ±n</h2>
  <p id="finalText"></p>
  <button id="sendBtn" onclick="sendJob()">ğŸš• Ã‡aÄŸrÄ±yÄ± GÃ¶nder</button>
  <p class="small" id="sendStatus" style="margin-top:10px;"></p>
</div>

<script>
/* =========================
   EKRAN GEÃ‡Ä°ÅÄ°
========================= */
function goTo(n){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen'+n).classList.add('active');
  if(n === 3) setTimeout(initMap, 250);
}

function startFlow(){
  const u = getUser_();
  if(!u.user_name || !u.user_phone){
    alert("Ã–nce kayÄ±t olmalÄ±sÄ±n (register.html).");
    // Ä°stersen burada register.htmlâ€™e yÃ¶nlendirebilirsin:
    // window.location.href = "register.html";
    return;
  }
  goTo(2);
}

function selectService(type){
  selectedService = type;
  goTo(3);
}

/* =========================
   HARÄ°TA + KONUM
========================= */
function initMap(){
  if(map) return;

  map = L.map('map').setView([40.1950, 29.0600], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;

    fromLatLng = [lat,lng];
    markerFrom = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ“ Konumun").openPopup();
    map.setView([lat,lng], 14);

    cachedFromAddress = await reverseGeocode(lat,lng);
    document.getElementById("from").value = cachedFromAddress;
  }, () => {
    alert("Konum izni verilmedi. Nereden alanÄ± otomatik dolmayabilir.");
  });

  map.on("click", async function(e){
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;
    toLatLng = [lat,lng];

    if(markerTo) map.removeLayer(markerTo);
    markerTo = L.marker([lat,lng]).addTo(map).bindPopup("ğŸ¯ VarÄ±ÅŸ").openPopup();

    cachedToAddress = await reverseGeocode(lat,lng);
    document.getElementById("to").value = cachedToAddress;
  });
}

async function reverseGeocode(lat,lng){
  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
  const data = await res.json();
  return data.display_name || lat.toFixed(5)+","+lng.toFixed(5);
}

/* =========================
   MESAFE + ÃœCRET
========================= */
function distanceKm(a,b){
  const R=6371;
  const dLat=(b[0]-a[0])*Math.PI/180;
  const dLng=(b[1]-a[1])*Math.PI/180;
  const aa=Math.sin(dLat/2)**2+Math.cos(a[0]*Math.PI/180)*Math.cos(b[0]*Math.PI/180)*Math.sin(dLng/2)**2;
  return R*(2*Math.atan2(Math.sqrt(aa),Math.sqrt(1-aa)));
}

function hesaplaVeDevam(){
  if(!fromLatLng || !toLatLng) return alert("BaÅŸlangÄ±Ã§ ve varÄ±ÅŸ seÃ§ilmeli");

  lastDistance = distanceKm(fromLatLng,toLatLng);
  const pricing = PRICES[selectedService];
  lastPrice = Math.round(pricing.open + lastDistance * pricing.km);

  document.getElementById("priceText").innerText = lastPrice + " TL";
  document.getElementById("infoText").innerText = `${lastDistance.toFixed(2)} km â€“ ${selectedService.toUpperCase()}`;
  document.getElementById("finalText").innerText = `${selectedService.toUpperCase()} â€“ ${lastPrice} TL`;

  goTo(4);
}

/* =========================
   JOB OLUÅTUR (BACKEND v2.1)
========================= */
function sendJob(){
  const u = getUser_();
  if(!u.user_name || !u.user_phone){
    alert("KayÄ±t bulunamadÄ±. register.html Ã¼zerinden kayÄ±t ol.");
    return;
  }
  if(!fromLatLng || !toLatLng){
    alert("Konumlar eksik.");
    return;
  }

  const payload = {
    action: "createJob",
    service_type: selectedService,
    user_name: u.user_name,
    user_phone: u.user_phone,
    pickup_address: document.getElementById("from").value || cachedFromAddress || "",
    pickup_lat: String(fromLatLng[0]),
    pickup_lng: String(fromLatLng[1]),
    dropoff_address: document.getElementById("to").value || cachedToAddress || "",
    dropoff_lat: String(toLatLng[0]),
    dropoff_lng: String(toLatLng[1])
  };

  const btn = document.getElementById("sendBtn");
  const st = document.getElementById("sendStatus");
  btn.disabled = true;
  st.innerText = "GÃ¶nderiliyorâ€¦";

  fetch(API_URL, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.ok){
      st.innerText = "âœ… Ã‡aÄŸrÄ± oluÅŸturuldu. Ä°ÅŸ No: " + res.job_id;
      // Ä°stersen mÃ¼ÅŸteri track linkini burada gÃ¶ster:
      // st.innerHTML = `âœ… Ã‡aÄŸrÄ± oluÅŸturuldu. <br>Takip: track.html?job_id=${res.job_id}`;
      alert("âœ… Ã‡aÄŸrÄ± baÅŸarÄ±yla gÃ¶nderildi!");
    } else {
      st.innerText = "âŒ Hata: " + (res.error || "Bilinmeyen");
      btn.disabled = false;
    }
  })
  .catch(()=>{
    st.innerText = "âŒ AÄŸ hatasÄ±";
    btn.disabled = false;
  });
}

/* =========================
   AÃ‡ILIÅTA KULLANICI PÄ°LÄ°
========================= */
(function boot(){
  const u = getUser_();
  const pill = document.getElementById("userPill");
  if(u.user_name && u.user_phone){
    pill.textContent = `KullanÄ±cÄ±: ${u.user_name} (${u.user_phone})`;
  } else {
    pill.textContent = "KullanÄ±cÄ±: kayÄ±t yok (register.html gerekli)";
  }
})();
</script>

</body>
</html>
