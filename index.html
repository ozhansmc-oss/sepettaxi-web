<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}

/* HEADER */
header{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:900;
}
header span{color:#f5c400}

/* LANDING */
#landing{
  height:220px;
  background:url("assets/landing.png") center/cover no-repeat;
}

/* MAP */
#map{height:42vh}

/* WRAP */
.wrap{max-width:520px;margin:auto;padding:14px}

/* SERVICE */
.services{display:flex;gap:12px;margin-top:-40px}
.service{
  flex:1;
  background:#111;
  border:1px solid #222;
  border-radius:16px;
  padding:18px;
  text-align:center;
  font-weight:800;
  cursor:pointer;
}
.service.active{border-color:#f5c400;color:#f5c400}

/* INPUTS */
.card{background:#111;border:1px solid #222;border-radius:16px;padding:14px;margin-top:12px}
input{width:100%;padding:14px;border-radius:12px;border:0;background:#1b1b1b;color:#fff;margin-top:8px}

/* CTA */
#callBtn{
  margin-top:14px;
  padding:18px;
  width:100%;
  border-radius:16px;
  border:0;
  font-size:18px;
  font-weight:900;
  background:#f5c400;
  color:#000;
  cursor:pointer;
}

/* DRIVER CTA */
.driverCard{
  margin-top:16px;
  padding:22px;
  border-radius:18px;
  background:#151515;
  border:2px dashed #333;
  text-align:center;
  font-size:18px;
  font-weight:900;
  cursor:pointer;
}
.driverCard span{color:#f5c400}

/* REGISTER MODAL */
#register{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99;
}
.regBox{
  width:90%;
  max-width:360px;
  background:#111;
  border-radius:18px;
  padding:18px;
}
.regBox input{margin-top:10px}
.regBox label{font-size:13px;color:#aaa;display:block;margin-top:10px}
.regBox button{
  margin-top:14px;
  width:100%;
  padding:16px;
  border-radius:14px;
  border:0;
  background:#f5c400;
  color:#000;
  font-weight:900;
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span></header>

<div id="landing"></div>
<div id="map"></div>

<div class="wrap">

  <div class="services">
    <div class="service active" onclick="selectService('taxi')">ðŸš• Taksi</div>
    <div class="service" onclick="selectService('courier')">ðŸ“¦ Kurye</div>
  </div>

  <div class="card">
    <input id="fromAddr" placeholder="Nereden (haritaya dokun)">
    <input id="toAddr" placeholder="Nereye (haritaya dokun)">
  </div>

  <button id="callBtn" onclick="callFlow()">Ã‡AÄžIR</button>

  <div class="driverCard" onclick="location.href='driver_apply.html'">
    ðŸš— <span>SÃ¼rÃ¼cÃ¼ Ol</span> â€“ Hemen BaÅŸvur
  </div>

</div>

<!-- REGISTER -->
<div id="register">
  <div class="regBox">
    <input id="ad" placeholder="Ad">
    <input id="soyad" placeholder="Soyad">
    <input id="tel" placeholder="05XXXXXXXXX">
    <label><input type="checkbox" id="kvkk"> KVKK kabul</label>
    <button onclick="saveUser()">KAYDI TAMAMLA</button>
  </div>
</div>

<script>
/* ================= BACKEND ================= */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

/* ================= MAP ================= */
const map = L.map("map").setView([40.195,29.060],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let fromM=null,toM=null,step="from";
map.on("click",e=>{
  if(step==="from"){
    if(fromM) map.removeLayer(fromM);
    fromM=L.marker(e.latlng).addTo(map);
    fromAddr.value=`${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
    step="to";
  }else{
    if(toM) map.removeLayer(toM);
    toM=L.marker(e.latlng).addTo(map);
    toAddr.value=`${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
  }
});

/* ================= FLOW ================= */
let service="taxi",registered=false,user={};

function selectService(s){
  service=s;
  document.querySelectorAll(".service").forEach(x=>x.classList.remove("active"));
  event.target.classList.add("active");
}

function callFlow(){
  if(!fromM||!toM) return alert("Adres seÃ§");
  if(!registered){
    register.style.display="flex";
  }else{
    createJob();
  }
}

function saveUser(){
  if(!ad.value||!soyad.value||!/^05\d{9}$/.test(tel.value)||!kvkk.checked)
    return alert("Bilgileri kontrol et");

  user={ad:ad.value,soyad:soyad.value,tel:tel.value};
  registered=true;
  register.style.display="none";
  createJob();
}

async function createJob(){
  const res = await fetch(BACKEND_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"createJob",
      service_type:service,
      customer_first:user.ad,
      customer_last:user.soyad,
      customer_phone:user.tel,
      from_lat:fromM.getLatLng().lat,
      from_lng:fromM.getLatLng().lng,
      to_lat:toM.getLatLng().lat,
      to_lng:toM.getLatLng().lng
    })
  });
  const d = await res.json();
  location.href = `track.html?job_id=${d.job_id}&token=${d.track_token}`;
}
</script>

</body>
</html>
