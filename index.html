<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SepetTaxi â€“ MÃ¼ÅŸteri</title>

  <!-- Leaflet (Harita) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --card2:#0f1726;
      --text:#e8eefc;
      --muted:#a9b6d8;
      --line:rgba(255,255,255,.10);
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;

      --taxi:#60a5fa;
      --courier:#a78bfa;
      --transfer:#22c55e;

      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 30% -10%, rgba(96,165,250,.22), transparent 55%),
                  radial-gradient(900px 700px at 90% 10%, rgba(167,139,250,.20), transparent 55%),
                  radial-gradient(900px 700px at 60% 110%, rgba(34,197,94,.16), transparent 55%),
                  var(--bg);
      color: var(--text);
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:1120px; margin:0 auto; padding:16px;}
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:14px 14px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,26,43,.88), rgba(18,26,43,.70));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky; top:10px; z-index:50;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo{
      width:40px; height:40px; border-radius: 12px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(167,139,250,.92));
      display:grid; place-items:center;
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.18);
      font-weight:800;
    }
    .brand h1{font-size:16px; margin:0; line-height:1.1}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(15,23,38,.7);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--text); font-weight:700}
    .btn{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(15,23,38,.70);
      color: var(--text);
      padding:10px 12px;
      border-radius: 12px;
      font-weight:700;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      user-select:none;
    }
    .btn:hover{background: rgba(18,26,43,.95); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(96,165,250,.35);
      background: linear-gradient(135deg, rgba(96,165,250,.90), rgba(167,139,250,.75));
    }
    .btn.primary:hover{filter: brightness(1.05)}
    .btn.good{
      border-color: rgba(34,197,94,.35);
      background: linear-gradient(135deg, rgba(34,197,94,.85), rgba(96,165,250,.55));
    }
    .btn.ghost{background: transparent}
    .btn.small{padding:8px 10px; border-radius: 10px; font-size:12px}
    .right{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .grid{
      display:grid; gap:14px; margin-top:14px;
      grid-template-columns: 1fr;
    }

    /* Sections */
    .section{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,26,43,.82), rgba(15,23,38,.62));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sectionHead{
      padding:16px;
      border-bottom: 1px solid var(--line);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .sectionHead h2{margin:0; font-size:16px}
    .sectionHead p{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.4}
    .sectionBody{padding:16px}

    /* Landing */
    .hero{
      display:grid; gap:14px;
      grid-template-columns: 1fr;
      padding:20px;
      background:
        radial-gradient(800px 500px at 15% 20%, rgba(96,165,250,.20), transparent 55%),
        radial-gradient(800px 500px at 90% 10%, rgba(167,139,250,.18), transparent 55%),
        radial-gradient(700px 500px at 60% 110%, rgba(34,197,94,.15), transparent 55%),
        rgba(15,23,38,.35);
    }
    .heroTitle{font-size:22px; margin:0}
    .heroText{margin:8px 0 0; color:var(--muted); line-height:1.5}
    .heroActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}

    /* Forms */
    .formRow{display:grid; gap:10px; grid-template-columns: 1fr}
    .field{
      display:flex; flex-direction:column; gap:6px;
    }
    label{font-size:12px; color:var(--muted)}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(11,18,32,.55);
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{border-color: rgba(96,165,250,.55)}
    .hint{font-size:12px; color:var(--muted)}
    .checks{display:flex; flex-direction:column; gap:8px; margin-top:8px}
    .check{
      display:flex; gap:10px; align-items:flex-start;
      padding:10px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,23,38,.50);
    }
    .check input{width:auto; margin-top:2px}
    .check span{font-size:12px; color:var(--muted); line-height:1.4}

    /* Service cards */
    .cards{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    .svc{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(15,23,38,.55);
      padding:14px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      transition: transform .12s ease, border-color .2s ease, background .2s ease;
      cursor:pointer;
    }
    .svc:hover{
      transform: translateY(-2px);
      background: rgba(18,26,43,.85);
      border-color: rgba(255,255,255,.18);
    }
    .svcLeft{display:flex; gap:12px; align-items:center}
    .svcIcon{
      width:44px; height:44px; border-radius: 14px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 12px 20px rgba(0,0,0,.20);
      font-weight:900;
    }
    .svcMeta h3{margin:0; font-size:15px}
    .svcMeta p{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.4}
    .tag{
      font-size:12px; color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      padding:6px 10px; border-radius: 999px;
      background: rgba(11,18,32,.35);
      white-space:nowrap;
    }
    .taxi .svcIcon{background: linear-gradient(135deg, rgba(96,165,250,.90), rgba(96,165,250,.35))}
    .courier .svcIcon{background: linear-gradient(135deg, rgba(167,139,250,.90), rgba(167,139,250,.35))}
    .transfer .svcIcon{background: linear-gradient(135deg, rgba(34,197,94,.90), rgba(34,197,94,.35))}
    .svc.selected{border-color: rgba(255,255,255,.28); background: rgba(18,26,43,.92)}
    .svc.selected .tag{border-color: rgba(255,255,255,.24)}

    /* Map + bottom sheet */
    .mapShell{
      display:grid; gap:12px;
      grid-template-columns: 1fr;
      align-items: stretch;
    }
    #map{
      height: 56vh;
      min-height: 340px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      box-shadow: 0 18px 32px rgba(0,0,0,.25);
    }
    .addrBar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(15,23,38,.58);
    }
    .addrBar .txt{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .addrBar .txt b{font-size:12px}
    .addrBar .txt span{
      font-size:12px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 68vw;
    }

    .sheet{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      background: rgba(15,23,38,.62);
      box-shadow: 0 18px 32px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .sheetHead{
      padding:14px; border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .sheetHead h3{margin:0; font-size:14px}
    .sheetHead p{margin:4px 0 0; font-size:12px; color:var(--muted); line-height:1.4}
    .sheetBody{padding:14px}
    .summary{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
      margin-top:12px;
    }
    .mini{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px 12px;
      background: rgba(11,18,32,.38);
      display:flex; justify-content:space-between; gap:10px;
      font-size:12px;
    }
    .mini span{color:var(--muted)}
    .row2{display:grid; gap:10px; grid-template-columns: 1fr}
    .inlineActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .notice{
      margin-top:10px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(251,191,36,.10);
      color: rgba(255,255,255,.88);
      font-size:12px;
      line-height:1.45;
    }
    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(15,23,38,.85);
      box-shadow: var(--shadow);
      color: var(--text);
      font-size: 12px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
      max-width: min(520px, calc(100vw - 24px));
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}

    /* Responsive */
    @media(min-width: 860px){
      .grid{grid-template-columns: 420px 1fr}
      .hero{grid-template-columns: 1.2fr .8fr; align-items:center}
      .formRow{grid-template-columns: 1fr 1fr}
      .cards{grid-template-columns: 1fr}
      .mapShell{grid-template-columns: 1fr}
      .summary{grid-template-columns: 1fr 1fr}
      .row2{grid-template-columns: 1fr 1fr}
      .addrBar .txt span{max-width: 520px}
    }
    .hidden{display:none !important}
    .muted{color:var(--muted)}
    .hr{height:1px; background:rgba(255,255,255,.10); margin:14px 0}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ST</div>
        <div>
          <h1>SepetTaxi</h1>
          <p>MÃ¼ÅŸteri UygulamasÄ±</p>
        </div>
      </div>

      <div class="right">
        <div class="pill" id="pillAuth"><b>Durum:</b> <span class="muted" id="authState">Misafir</span></div>
        <button class="btn small ghost" id="btnReset">SÄ±fÄ±rla</button>
        <button class="btn small" id="btnProfile" title="Profil / KayÄ±t Bilgileri">Profil</button>
      </div>
    </div>

    <!-- LANDING -->
    <div class="section" id="screenLanding">
      <div class="hero">
        <div>
          <h2 class="heroTitle">Tek uygulama ile Taksi, Kurye ve HavalimanÄ± Transferi</h2>
          <p class="heroText">
            Devam etmek iÃ§in kayÄ±t ve doÄŸrulama gereklidir. SonrasÄ±nda hizmeti seÃ§ip harita Ã¼zerinden
            neredenâ€“nereye belirleyerek Ã§aÄŸrÄ±nÄ±zÄ± oluÅŸturabilirsiniz.
          </p>
          <div class="heroActions">
            <button class="btn primary" id="btnStart">Devam Et / Hizmet Al</button>
            <button class="btn" id="btnLearn">NasÄ±l Ã‡alÄ±ÅŸÄ±r?</button>
          </div>
        </div>

        <div class="section" style="margin:0; border-radius:18px;">
          <div class="sectionHead">
            <div>
              <h2>HÄ±zlÄ± Ã–zet</h2>
              <p>3 adÄ±mda Ã§aÄŸrÄ± oluÅŸturun.</p>
            </div>
          </div>
          <div class="sectionBody">
            <div class="mini"><b>1</b> <span>KayÄ±t + SMS DoÄŸrulama</span></div>
            <div class="mini"><b>2</b> <span>Hizmet seÃ§ + detay gir</span></div>
            <div class="mini"><b>3</b> <span>Harita ile onayla</span></div>
            <div class="notice">
              Not: Bu dosya <b>tasarÄ±m iskeletidir</b>. OTP ve Ã§aÄŸrÄ± oluÅŸturma iÅŸlemleri iÃ§in Apps Script API URLâ€™nizi
              aÅŸaÄŸÄ±daki <b>API_URL</b> alanÄ±na ekleyerek entegre edebilirsiniz.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">

      <!-- AUTH / REGISTER -->
      <div class="section" id="screenAuth">
        <div class="sectionHead">
          <div>
            <h2>KayÄ±t & DoÄŸrulama</h2>
            <p>KayÄ±t olmadan hizmet seÃ§imi ve harita ekranÄ± aÃ§Ä±lmaz.</p>
          </div>
          <div class="pill"><b>AdÄ±m:</b> <span id="authStepText" class="muted">KayÄ±t</span></div>
        </div>

        <div class="sectionBody">
          <!-- Register -->
          <div id="authStepRegister">
            <div class="formRow">
              <div class="field">
                <label>Ad Soyad</label>
                <input id="inpName" type="text" placeholder="Ã–rn: Ã–zhan Samurcu" autocomplete="name" />
              </div>
              <div class="field">
                <label>Telefon (11 hane)</label>
                <input id="inpPhone" type="tel" placeholder="05xxxxxxxxx" inputmode="numeric" maxlength="11" autocomplete="tel" />
                <div class="hint">YalnÄ±zca rakam. Ã–rn: 05320000000</div>
              </div>
            </div>

            <div class="checks">
              <div class="check">
                <input id="chkKvkk" type="checkbox" />
                <span><b>KVKK</b> metnini okudum ve kabul ediyorum.</span>
              </div>
              <div class="check">
                <input id="chkTerms" type="checkbox" />
                <span><b>Hizmet SÃ¶zleÅŸmesi</b> ÅŸartlarÄ±nÄ± okudum ve kabul ediyorum.</span>
              </div>
            </div>

            <div class="inlineActions">
              <button class="btn primary" id="btnSendOtp">SMS DoÄŸrulama Kodu GÃ¶nder</button>
              <button class="btn" id="btnSkipOtp" title="Sadece iskelet testleri iÃ§in">Demo: DoÄŸrula</button>
            </div>

            <div class="notice">
              OTP entegrasyonu canlÄ±ya alÄ±nÄ±rken: <b>SMS gÃ¶nderimi</b> + <b>OTP doÄŸrulama</b> Apps Script Ã¼zerinden yapÄ±lmalÄ±dÄ±r.
              Bu iskelette demo amaÃ§lÄ± â€œDemo: DoÄŸrulaâ€ butonu vardÄ±r.
            </div>
          </div>

          <!-- OTP -->
          <div id="authStepOtp" class="hidden">
            <div class="field">
              <label>SMS DoÄŸrulama Kodu</label>
              <input id="inpOtp" type="text" inputmode="numeric" maxlength="6" placeholder="6 haneli kod" />
              <div class="hint">Kodu girin ve doÄŸrulayÄ±n.</div>
            </div>
            <div class="inlineActions">
              <button class="btn good" id="btnVerifyOtp">DoÄŸrula</button>
              <button class="btn" id="btnBackToRegister">Geri</button>
              <button class="btn small ghost" id="btnResendOtp">Kodu Tekrar GÃ¶nder</button>
            </div>
          </div>

          <div class="hr"></div>

          <div class="mini">
            <b>Profil</b>
            <span id="profileMini" class="muted">KayÄ±t yapÄ±lmadÄ±</span>
          </div>
        </div>
      </div>

      <!-- MAIN APP -->
      <div class="section" id="screenApp">
        <div class="sectionHead">
          <div>
            <h2>Hizmet SeÃ§imi & Harita</h2>
            <p>DoÄŸrulama sonrasÄ± hizmeti seÃ§in; adresler ve detaylar ile Ã§aÄŸrÄ±yÄ± onaylayÄ±n.</p>
          </div>
          <div class="pill"><b>SeÃ§ili:</b> <span id="pillService" class="muted">â€”</span></div>
        </div>

        <div class="sectionBody">
          <!-- Service cards -->
          <div class="cards" id="serviceCards">
            <div class="svc taxi" data-service="taxi">
              <div class="svcLeft">
                <div class="svcIcon">ğŸš•</div>
                <div class="svcMeta">
                  <h3>Taksi</h3>
                  <p>Neredenâ€“nereye seÃ§, tahmini fiyatÄ± gÃ¶r, Ã§aÄŸrÄ±yÄ± oluÅŸtur.</p>
                </div>
              </div>
              <div class="tag">HÄ±zlÄ±</div>
            </div>

            <div class="svc courier" data-service="courier">
              <div class="svcLeft">
                <div class="svcIcon">ğŸ›µ</div>
                <div class="svcMeta">
                  <h3>Kurye</h3>
                  <p>Paket detaylarÄ±nÄ± gir, alÄ±cÄ± bilgilerini ekle, teslimat baÅŸlat.</p>
                </div>
              </div>
              <div class="tag">Paket</div>
            </div>

            <div class="svc transfer transfer" data-service="transfer">
              <div class="svcLeft">
                <div class="svcIcon">âœˆï¸</div>
                <div class="svcMeta">
                  <h3>HavalimanÄ± Transferi</h3>
                  <p>AraÃ§ seÃ§, valiz sayÄ±sÄ± ve rezervasyon zamanÄ± ile transfer oluÅŸtur.</p>
                </div>
              </div>
              <div class="tag">Rezervasyon</div>
            </div>
          </div>

          <div class="hr"></div>

          <!-- Map + Address -->
          <div class="mapShell">
            <div class="addrBar">
              <div class="txt">
                <b>Mevcut Konumunuz</b>
                <span id="currentAddress">Konum bekleniyorâ€¦</span>
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                <button class="btn small" id="btnLocate">Konum Al</button>
                <button class="btn small ghost" id="btnUseAsPickup" title="Mevcut konumu 'Nereden' yap">Nereden</button>
              </div>
            </div>

            <div id="map"></div>

            <!-- Bottom sheet -->
            <div class="sheet">
              <div class="sheetHead">
                <div>
                  <h3>Ã‡aÄŸrÄ± DetaylarÄ±</h3>
                  <p id="sheetSub" class="muted">Ã–nce hizmet seÃ§in. Sonra adresleri girin.</p>
                </div>
                <button class="btn small ghost" id="btnSwap" title="Nereden/Nereye deÄŸiÅŸtir">â‡…</button>
              </div>

              <div class="sheetBody">
                <div class="row2">
                  <div class="field">
                    <label>ğŸ“ Nereden (Pickup)</label>
                    <input id="inpPickup" type="text" placeholder="Mevcut konum veya yazÄ±n" />
                  </div>
                  <div class="field">
                    <label>ğŸ“ Nereye (Dropoff)</label>
                    <input id="inpDropoff" type="text" placeholder="Adres yazÄ±n" />
                  </div>
                </div>

                <!-- Service-specific forms -->
                <div id="svcTaxi" class="svcForm hidden">
                  <div class="hr"></div>
                  <div class="hint">Taksi iÃ§in ek bilgi gerekmiyor. Adresleri girmeniz yeterli.</div>
                </div>

                <div id="svcCourier" class="svcForm hidden">
                  <div class="hr"></div>
                  <div class="formRow">
                    <div class="field">
                      <label>Paket TÃ¼rÃ¼</label>
                      <select id="pkgType">
                        <option value="">SeÃ§in</option>
                        <option>Belge</option>
                        <option>GÄ±da</option>
                        <option>Koli</option>
                        <option>DiÄŸer</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>AÄŸÄ±rlÄ±k (kg)</label>
                      <input id="pkgWeight" type="number" min="0" step="0.1" placeholder="Ã–rn: 2.5" />
                    </div>
                  </div>
                  <div class="formRow">
                    <div class="field">
                      <label>AlÄ±cÄ± Ad Soyad</label>
                      <input id="recvName" type="text" placeholder="Ã–rn: Ahmet YÄ±lmaz" />
                    </div>
                    <div class="field">
                      <label>AlÄ±cÄ± Telefon</label>
                      <input id="recvPhone" type="tel" inputmode="numeric" maxlength="11" placeholder="05xxxxxxxxx" />
                    </div>
                  </div>
                  <div class="field">
                    <label>Paket Notu (opsiyonel)</label>
                    <textarea id="pkgNote" rows="2" placeholder="Ã–rn: KapÄ± gÃ¶revlisine bÄ±rakÄ±labilir"></textarea>
                  </div>
                </div>

                <div id="svcTransfer" class="svcForm hidden">
                  <div class="hr"></div>
                  <div class="formRow">
                    <div class="field">
                      <label>AraÃ§ Tipi</label>
                      <select id="trVehicle">
                        <option value="">SeÃ§in</option>
                        <option value="sedan">Binek</option>
                        <option value="vip">VIP</option>
                        <option value="van">MinibÃ¼s</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>Valiz SayÄ±sÄ±</label>
                      <input id="trLuggage" type="number" min="0" step="1" placeholder="Ã–rn: 2" />
                    </div>
                  </div>
                  <div class="formRow">
                    <div class="field">
                      <label>HavalimanÄ±</label>
                      <select id="trAirport">
                        <option value="">SeÃ§in</option>
                        <option value="SAW">Ä°stanbul Sabiha GÃ¶kÃ§en (SAW)</option>
                        <option value="IST">Ä°stanbul HavalimanÄ± (IST)</option>
                        <option value="ESB">Ankara EsenboÄŸa (ESB)</option>
                        <option value="ADB">Ä°zmir Adnan Menderes (ADB)</option>
                        <option value="BTZ">Bursa YeniÅŸehir (BTZ)</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>Rezervasyon</label>
                      <select id="trScheduleMode">
                        <option value="now">Hemen</option>
                        <option value="later">Ä°leri Tarih</option>
                      </select>
                    </div>
                  </div>
                  <div class="formRow" id="trLaterRow" class="hidden">
                    <div class="field">
                      <label>Tarih</label>
                      <input id="trDate" type="date" />
                    </div>
                    <div class="field">
                      <label>Saat</label>
                      <input id="trTime" type="time" />
                    </div>
                  </div>
                </div>

                <!-- Summary -->
                <div class="summary">
                  <div class="mini">
                    <b>Mesafe</b>
                    <span id="sumDistance">â€”</span>
                  </div>
                  <div class="mini">
                    <b>Tahmini Fiyat</b>
                    <span id="sumPrice">â€”</span>
                  </div>
                  <div class="mini">
                    <b>SeÃ§ilen Hizmet</b>
                    <span id="sumService">â€”</span>
                  </div>
                  <div class="mini">
                    <b>Durum</b>
                    <span id="sumStatus" class="muted">HazÄ±r</span>
                  </div>
                </div>

                <div class="inlineActions">
                  <button class="btn" id="btnCalc">Mesafe & Ãœcret Hesapla</button>
                  <button class="btn good" id="btnConfirm">Hizmeti Onayla</button>
                </div>

                <div class="notice">
                  â€œHizmeti Onaylaâ€ bir <b>job</b> oluÅŸturma iskeletidir. CanlÄ± sistemde bu adÄ±m,
                  Apps Script APIâ€™ye istek atar ve ardÄ±ndan FAZ 3 (canlÄ± takip) & FAZ 5 (Ã¶deme) akÄ±ÅŸÄ±na geÃ§er.
                </div>

              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const API_URL = "https://script.google.com/macros/s/AKfycbxGK3XXKVX-65ZfRCtGhMdIoOgV6RAx7tSldcBW3ugRzB7_T3Bv2DLsCazrpLgYPwg0/exec";


    // Basit demo fiyatlandÄ±rma (FAZ 5 kilitli mantÄ±ÄŸÄ±nÄ±zÄ± burada baÄŸlayacaksÄ±nÄ±z)
    const PRICING = {
      taxi:   { base: 45, perKm: 18 },
      courier:{ base: 55, perKm: 20 },
      transfer:{ base: 140, perKm: 24 }
    };

    /***********************
     * STATE
     ***********************/
    const state = {
      authed: false,
      user: null, // {name, phone}
      service: null, // taxi | courier | transfer
      pickup: { text:"", lat:null, lng:null },
      dropoff:{ text:"", lat:null, lng:null },
      current: { lat:null, lng:null, address:"" },
      map: null,
      marker: null,
      distKm: null,
      price: null
    };

    /***********************
     * HELPERS
     ***********************/
    const $ = (id)=>document.getElementById(id);
    const toast = (msg)=>{
      const el = $("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=>el.classList.remove("show"), 2200);
    };
    const digitsOnly = (s)=> (s||"").replace(/\D/g,"");
    const validPhone = (p)=> /^\d{11}$/.test(p);

    function setAuthUI(){
      $("authState").textContent = state.authed ? "DoÄŸrulandÄ±" : "Misafir";
      $("profileMini").textContent = state.authed
        ? `${state.user.name} â€¢ ${state.user.phone}`
        : "KayÄ±t yapÄ±lmadÄ±";

      // Auth zorunlu: app ekranÄ± kayÄ±t doÄŸrulanmadan kullanÄ±lamaz
      $("screenApp").style.opacity = state.authed ? "1" : ".55";
      $("screenApp").style.pointerEvents = state.authed ? "auto" : "none";
    }

    function setAuthStep(step){
      // step: register | otp
      if(step === "register"){
        $("authStepText").textContent = "KayÄ±t";
        $("authStepRegister").classList.remove("hidden");
        $("authStepOtp").classList.add("hidden");
      }else{
        $("authStepText").textContent = "DoÄŸrulama";
        $("authStepRegister").classList.add("hidden");
        $("authStepOtp").classList.remove("hidden");
      }
    }

    function setService(service){
      state.service = service;
      $("pillService").textContent = service ? service.toUpperCase() : "â€”";
      $("sumService").textContent = service ? service.toUpperCase() : "â€”";

      // Card selection
      [...document.querySelectorAll(".svc")].forEach(el=>{
        el.classList.toggle("selected", el.dataset.service === service);
      });

      // Forms
      ["svcTaxi","svcCourier","svcTransfer"].forEach(id=>$(id).classList.add("hidden"));
      if(service === "taxi") $("svcTaxi").classList.remove("hidden");
      if(service === "courier") $("svcCourier").classList.remove("hidden");
      if(service === "transfer") $("svcTransfer").classList.remove("hidden");

      // Sub text
      const sub = {
        taxi: "Taksi: Neredenâ€“nereye girin ve onaylayÄ±n.",
        courier: "Kurye: Paket ve alÄ±cÄ± detaylarÄ±nÄ± girin, onaylayÄ±n.",
        transfer: "Transfer: AraÃ§, valiz ve rezervasyon detaylarÄ±nÄ± girin, onaylayÄ±n."
      };
      $("sheetSub").textContent = service ? sub[service] : "Ã–nce hizmet seÃ§in. Sonra adresleri girin.";

      // Reset summary
      state.distKm = null; state.price = null;
      $("sumDistance").textContent = "â€”";
      $("sumPrice").textContent = "â€”";
      $("sumStatus").textContent = "HazÄ±r";
    }

    /***********************
     * MAP + GEO
     ***********************/
    async function reverseGeocode(lat, lng){
      // Nominatim Ã¼cretsiz servis: yoÄŸun kullanÄ±mda limit vardÄ±r. CanlÄ±da kendi servisiniz/anahtarÄ±nÄ±z Ã¶nerilir.
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`;
      const res = await fetch(url, { headers: { "Accept":"application/json" }});
      if(!res.ok) throw new Error("Adres alÄ±namadÄ±");
      const data = await res.json();
      return data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    }

    function initMap(){
      if(state.map) return;

      state.map = L.map("map", { zoomControl:true });
      // Default: Bursa civarÄ± (isteÄŸe gÃ¶re)
      state.map.setView([40.195, 29.06], 12);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap"
      }).addTo(state.map);

      state.marker = L.marker([40.195, 29.06], { draggable:true }).addTo(state.map);

      state.marker.on("dragend", async ()=>{
        const {lat, lng} = state.marker.getLatLng();
        state.current.lat = lat; state.current.lng = lng;
        $("currentAddress").textContent = "Adres gÃ¼ncelleniyorâ€¦";
        try{
          const addr = await reverseGeocode(lat, lng);
          state.current.address = addr;
          $("currentAddress").textContent = addr;
        }catch(e){
          $("currentAddress").textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }
      });
    }

    async function locate(){
      initMap();
      $("currentAddress").textContent = "Konum alÄ±nÄ±yorâ€¦";
      $("sumStatus").textContent = "Konum alÄ±nÄ±yorâ€¦";

      if(!navigator.geolocation){
        toast("TarayÄ±cÄ± konum desteÄŸi yok.");
        $("currentAddress").textContent = "Konum desteÄŸi yok.";
        $("sumStatus").textContent = "HazÄ±r";
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        state.current.lat = lat; state.current.lng = lng;
        state.map.setView([lat,lng], 16);
        state.marker.setLatLng([lat,lng]);

        try{
          const addr = await reverseGeocode(lat, lng);
          state.current.address = addr;
          $("currentAddress").textContent = addr;
          toast("Konum alÄ±ndÄ±.");
        }catch(e){
          $("currentAddress").textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
          toast("Konum alÄ±ndÄ± (adres Ã§Ã¶zÃ¼mlenemedi).");
        }finally{
          $("sumStatus").textContent = "HazÄ±r";
        }
      }, (err)=>{
        console.error(err);
        toast("Konum izni verilmedi veya alÄ±namadÄ±.");
        $("currentAddress").textContent = "Konum izni verilmedi / alÄ±namadÄ±.";
        $("sumStatus").textContent = "HazÄ±r";
      }, { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
    }

    /***********************
     * DISTANCE / PRICE (demo)
     ***********************/
    function haversineKm(lat1, lon1, lat2, lon2){
      const toRad = (x)=> x * Math.PI/180;
      const R = 6371;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a =
        Math.sin(dLat/2)*Math.sin(dLat/2) +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    // Demo amaÃ§lÄ±: pickup/dropoff adreslerinden koordinat Ã§Ã¶zmÃ¼yor.
    // CanlÄ±da: Place autocomplete/geocoding veya backend koordinatlarÄ± ile baÄŸlanmalÄ±.
    function demoCalc(){
      if(!state.service) return toast("Ã–nce hizmet seÃ§in.");
      const pickupText = $("inpPickup").value.trim();
      const dropText   = $("inpDropoff").value.trim();
      if(!pickupText || !dropText) return toast("Nereden ve Nereye zorunlu.");

      // Ä°skelet yaklaÅŸÄ±m: pickup koordinatÄ±nÄ± mevcut konumdan al (varsa)
      if(state.current.lat == null || state.current.lng == null){
        toast("Ã–nce konum alÄ±n (Nereden iÃ§in).");
        return;
      }

      // Demo: dropoff koordinatÄ± yok -> rasgele kÃ¼Ã§Ã¼k sapma ile sadece UI Ã§alÄ±ÅŸsÄ±n
      const lat1 = state.current.lat, lng1 = state.current.lng;
      const lat2 = lat1 + 0.02, lng2 = lng1 + 0.02;

      const km = haversineKm(lat1,lng1,lat2,lng2);
      state.distKm = km;

      const p = PRICING[state.service];
      const price = Math.round((p.base + p.perKm * km) * 10) / 10;
      state.price = price;

      $("sumDistance").textContent = `${km.toFixed(2)} km (demo)`;
      $("sumPrice").textContent = `${price.toFixed(1)} TL (demo)`;

      toast("HesaplandÄ± (demo).");
    }

    /***********************
     * API (skeletal)
     ***********************/
    async function apiPost(action, payload){
      if(!API_URL) throw new Error("API_URL tanÄ±mlÄ± deÄŸil.");
      const res = await fetch(API_URL, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ action, ...payload })
      });
      return await res.json();
    }

    async function createJob(){
      if(!state.authed) return toast("Ã–nce kayÄ±t/doÄŸrulama.");
      if(!state.service) return toast("Ã–nce hizmet seÃ§in.");

      const pickup = $("inpPickup").value.trim();
      const dropoff = $("inpDropoff").value.trim();
      if(!pickup || !dropoff) return toast("Nereden ve Nereye zorunlu.");

      // Hizmete gÃ¶re alan zorunluluklarÄ±
      if(state.service === "courier"){
        const recvPhone = digitsOnly($("recvPhone").value);
        if(!$("recvName").value.trim()) return toast("AlÄ±cÄ± adÄ± zorunlu.");
        if(!validPhone(recvPhone)) return toast("AlÄ±cÄ± telefonu 11 hane olmalÄ±.");
      }
      if(state.service === "transfer"){
        if(!$("trVehicle").value) return toast("AraÃ§ tipi seÃ§in.");
        if(!$("trAirport").value) return toast("HavalimanÄ± seÃ§in.");
        if($("trScheduleMode").value === "later"){
          if(!$("trDate").value || !$("trTime").value) return toast("Tarih ve saat zorunlu.");
        }
      }

      $("sumStatus").textContent = "OnaylanÄ±yorâ€¦";

      const jobPayload = {
        user: state.user,
        service: state.service,
        pickup: { text: pickup, lat: state.current.lat, lng: state.current.lng },
        dropoff:{ text: dropoff },
        // servis detaylarÄ±
        details: {
          courier: state.service==="courier" ? {
            pkgType: $("pkgType").value,
            pkgWeight: $("pkgWeight").value,
            recvName: $("recvName").value.trim(),
            recvPhone: digitsOnly($("recvPhone").value),
            note: $("pkgNote").value.trim()
          } : null,
          transfer: state.service==="transfer" ? {
            vehicle: $("trVehicle").value,
            luggage: $("trLuggage").value,
            airport: $("trAirport").value,
            scheduleMode: $("trScheduleMode").value,
            date: $("trDate").value,
            time: $("trTime").value
          } : null
        },
        pricing: {
          distance_km: state.distKm,
          estimated_price: state.price
        }
      };

      try{
        // Ä°SKELET: API_URL yoksa demo davranÄ±ÅŸ
        if(!API_URL){
          const demoId = "JOB-" + Date.now();
          $("sumStatus").textContent = "OluÅŸturuldu (demo)";
          toast(`Ã‡aÄŸrÄ± oluÅŸturuldu: ${demoId}`);
          // CanlÄ±da burada: track ekranÄ±na yÃ¶nlendirme + Ã¶deme akÄ±ÅŸÄ± (FAZ 3/5)
          return;
        }

        const data = await apiPost("createJob", jobPayload);
        if(data && data.ok){
          $("sumStatus").textContent = "OluÅŸturuldu";
          toast(`Ã‡aÄŸrÄ± oluÅŸturuldu: ${data.job_id || "JOB"}`);
          // CanlÄ±da: track.html?job_id=... gibi yÃ¶nlendirme
        }else{
          $("sumStatus").textContent = "Hata";
          toast(data?.error || "Ã‡aÄŸrÄ± oluÅŸturulamadÄ±.");
        }
      }catch(e){
        console.error(e);
        $("sumStatus").textContent = "Hata";
        toast(e.message || "API hatasÄ±");
      }
    }

    /***********************
     * AUTH FLOW (skeletal)
     ***********************/
    function demoVerify(){
      const name = $("inpName").value.trim();
      const phone = digitsOnly($("inpPhone").value);

      if(!name) return toast("Ad Soyad zorunlu.");
      if(!validPhone(phone)) return toast("Telefon 11 hane olmalÄ±.");
      if(!$("chkKvkk").checked) return toast("KVKK onayÄ± zorunlu.");
      if(!$("chkTerms").checked) return toast("Hizmet sÃ¶zleÅŸmesi onayÄ± zorunlu.");

      state.authed = true;
      state.user = { name, phone };
      localStorage.setItem("st_user", JSON.stringify(state.user));
      localStorage.setItem("st_authed", "1");

      setAuthUI();
      toast("DoÄŸrulandÄ± (demo).");

      // Harita init
      initMap();
      locate();
      // Landingâ€™i kapat
      $("screenLanding").classList.add("hidden");
    }

    function loadSession(){
      try{
        const authed = localStorage.getItem("st_authed")==="1";
        const userRaw = localStorage.getItem("st_user");
        if(authed && userRaw){
          state.user = JSON.parse(userRaw);
          state.authed = true;
        }
      }catch(_){}
      setAuthUI();
    }

    /***********************
     * EVENTS
     ***********************/
    window.addEventListener("DOMContentLoaded", ()=>{
      loadSession();
      initMap();

      // Landing actions
      $("btnStart").addEventListener("click", ()=>{
        $("screenLanding").classList.add("hidden");
        toast("KayÄ±t adÄ±mÄ±na geÃ§ildi.");
      });
      $("btnLearn").addEventListener("click", ()=>{
        toast("AkÄ±ÅŸ: KayÄ±t â†’ Hizmet seÃ§ â†’ Harita â†’ Onay");
      });

      // Reset
      $("btnReset").addEventListener("click", ()=>{
        localStorage.removeItem("st_user");
        localStorage.removeItem("st_authed");
        location.reload();
      });

      // Profile
      $("btnProfile").addEventListener("click", ()=>{
        if(state.authed) toast(`${state.user.name} â€¢ ${state.user.phone}`);
        else toast("HenÃ¼z kayÄ±t yok.");
      });

      // Phone input filter
      $("inpPhone").addEventListener("input", (e)=> e.target.value = digitsOnly(e.target.value).slice(0,11));
      $("recvPhone").addEventListener("input", (e)=> e.target.value = digitsOnly(e.target.value).slice(0,11));

      // Auth
      $("btnSendOtp").addEventListener("click", ()=>{
        // canlÄ±da: API -> sendOtp
        const name = $("inpName").value.trim();
        const phone = digitsOnly($("inpPhone").value);
        if(!name) return toast("Ad Soyad zorunlu.");
        if(!validPhone(phone)) return toast("Telefon 11 hane olmalÄ±.");
        if(!$("chkKvkk").checked) return toast("KVKK onayÄ± zorunlu.");
        if(!$("chkTerms").checked) return toast("Hizmet sÃ¶zleÅŸmesi onayÄ± zorunlu.");

        setAuthStep("otp");
        toast("Kod gÃ¶nderildi (demo).");
      });
      $("btnResendOtp").addEventListener("click", ()=> toast("Kod tekrar gÃ¶nderildi (demo)."));
      $("btnBackToRegister").addEventListener("click", ()=> setAuthStep("register"));
      $("btnVerifyOtp").addEventListener("click", ()=>{
        // canlÄ±da: API -> verifyOtp
        // burada demo:
        demoVerify();
      });
      $("btnSkipOtp").addEventListener("click", demoVerify);

      // Service selection
      $("serviceCards").addEventListener("click", (e)=>{
        const card = e.target.closest(".svc");
        if(!card) return;
        if(!state.authed) return toast("Ã–nce kayÄ±t/doÄŸrulama.");
        setService(card.dataset.service);
      });

      // Transfer schedule toggle
      $("trScheduleMode").addEventListener("change", ()=>{
        const later = $("trScheduleMode").value === "later";
        const row = $("trLaterRow");
        if(later) row.classList.remove("hidden");
        else row.classList.add("hidden");
      });

      // Map actions
      $("btnLocate").addEventListener("click", ()=>{
        if(!state.authed) return toast("Ã–nce kayÄ±t/doÄŸrulama.");
        locate();
      });
      $("btnUseAsPickup").addEventListener("click", ()=>{
        if(!state.authed) return toast("Ã–nce kayÄ±t/doÄŸrulama.");
        if(!state.current.address) return toast("Ã–nce konum alÄ±n.");
        $("inpPickup").value = state.current.address;
        toast("Nereden gÃ¼ncellendi.");
      });

      // Swap
      $("btnSwap").addEventListener("click", ()=>{
        const a = $("inpPickup").value;
        $("inpPickup").value = $("inpDropoff").value;
        $("inpDropoff").value = a;
        toast("Adresler deÄŸiÅŸtirildi.");
      });

      // Calc / confirm
      $("btnCalc").addEventListener("click", ()=>{
        if(!state.authed) return toast("Ã–nce kayÄ±t/doÄŸrulama.");
        demoCalc();
      });
      $("btnConfirm").addEventListener("click", createJob);

      // Default
      setAuthStep("register");
      setService(null);
    });
  </script>
</body>
</html>
