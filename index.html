<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Arial;background:#000;color:#fff;overflow:hidden}

/* LANDING */
#landing{
  position:fixed;inset:0;
  background:#000 url("assets/landing.png") center/cover no-repeat;
  display:flex;align-items:center;justify-content:center;
  z-index:10;
}
#landing .overlay{
  background:rgba(0,0,0,.55);
  width:100%;height:100%;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
}
#landing h1{font-size:42px;margin-bottom:20px}
#landing span{color:#f5c400}
#landing button{
  background:#f5c400;color:#000;
  border:none;border-radius:28px;
  padding:16px 46px;
  font-size:18px;font-weight:900;
}

/* APP */
#app{display:none;height:100%}
header{
  height:56px;background:#000;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:900;
}
header span{color:#f5c400}

#map{height:42%}

#panel{
  height:calc(58% - 56px);
  padding:12px;
  display:flex;flex-direction:column;
  gap:10px;
}

.card{
  background:#1b1b1b;border-radius:14px;
  padding:14px;
}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.service{
  text-align:center;padding:18px;
  border-radius:14px;
  border:2px solid transparent;
}
.service.active{border-color:#f5c400}

.input{
  width:100%;padding:12px;
  border-radius:10px;
  border:1px solid #333;
  background:#000;color:#fff;
}

.row{display:flex;gap:10px}
.row .card{flex:1;text-align:center}
.big{font-size:20px;font-weight:900}

button.call{
  margin-top:auto;
  background:#f5c400;color:#000;
  border:none;border-radius:28px;
  padding:18px;
  font-size:18px;font-weight:900;
}

/* REGISTER */
#register{
  position:fixed;inset:0;
  background:rgba(0,0,0,.8);
  display:none;align-items:center;justify-content:center;
  z-index:20;
}
#register .box{
  background:#111;border-radius:16px;
  width:90%;max-width:400px;
  padding:18px;
}
label{font-size:13px}
.err{color:#ff6b6b;font-size:13px;display:none}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button onclick="start()">BAÅžLA</button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>Sepet<span>Taxi</span></header>
  <div id="map"></div>

  <div id="panel">

    <!-- SERVICE -->
    <div class="card">
      <b>Hizmet SeÃ§</b>
      <div class="grid">
        <div id="svcTaxi" class="service" onclick="selectService('taxi')">ðŸš• Taksi</div>
        <div id="svcCourier" class="service" onclick="selectService('courier')">ðŸ“¦ Kurye</div>
      </div>
    </div>

    <!-- ADDRESS -->
    <div class="card"><input id="fromAddr" class="input" placeholder="Nereden" readonly></div>
    <div class="card"><input id="toAddr" class="input" placeholder="Nereye" readonly></div>

    <!-- COURIER EXTRA -->
    <div id="courierExtra" class="card" style="display:none">
      <input id="packageType" class="input" placeholder="Paket TÃ¼rÃ¼">
      <input id="receiverName" class="input" placeholder="AlÄ±cÄ± AdÄ±">
      <input id="receiverPhone" class="input" placeholder="AlÄ±cÄ± Telefon">
    </div>

    <!-- PRICE -->
    <div class="row">
      <div class="card"><div>Mesafe</div><div id="dist" class="big">â€”</div></div>
      <div class="card"><div>Ãœcret</div><div id="price" class="big">â€”</div></div>
    </div>

    <button class="call" onclick="callDriver()">SÃœRÃœCÃœ Ã‡AÄžIR</button>
  </div>
</div>

<!-- REGISTER -->
<div id="register">
  <div class="box">
    <input id="fname" class="input" placeholder="Ad">
    <input id="lname" class="input" placeholder="Soyad">
    <input id="phone" class="input" placeholder="05XXXXXXXXX">
    <label><input type="checkbox" id="kvkk"> KVKK kabul</label>
    <div id="regErr" class="err">Bilgiler hatalÄ±</div>
    <button class="call" onclick="saveUser()">KAYDI TAMAMLA</button>
  </div>
</div>

<script>
/* CONFIG */
const BACKEND="https://script.google.com/macros/s/AKfycbxMLho3ZDX1R4EvZz-9MrOOq44807vH0MFd_X8ypSrYB6-vAQAR_dPa-lprAGkR1xsDxQ/exec";

/* STATE */
let map,fromM,toM,service=null,user=null;

/* LANDING */
function start(){
  landing.style.display="none";
  app.style.display="block";
  initMap();
}

/* MAP */
function initMap(){
  map=L.map("map").setView([41,29],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  navigator.geolocation.getCurrentPosition(p=>{
    const {latitude,longitude}=p.coords;
    fromM=L.marker([latitude,longitude],{draggable:true}).addTo(map);
    map.setView([latitude,longitude],15);
    reverse(latitude,longitude,fromAddr);
  });
  map.on("click",e=>{
    toM ? toM.setLatLng(e.latlng) : toM=L.marker(e.latlng,{draggable:true}).addTo(map);
    reverse(e.latlng.lat,e.latlng.lng,toAddr);
    calc();
  });
}

/* SERVICE */
function selectService(t){
  if(!user){register.style.display="flex";return;}
  service=t;
  svcTaxi.classList.toggle("active",t==="taxi");
  svcCourier.classList.toggle("active",t==="courier");
  courierExtra.style.display=t==="courier"?"block":"none";
  calc();
}

/* REGISTER */
function saveUser(){
  if(fname.value.length<2||lname.value.length<2||!/^05\d{9}$/.test(phone.value)||!kvkk.checked){
    regErr.style.display="block";return;
  }
  user={f:fname.value,l:lname.value,p:phone.value};
  register.style.display="none";
}

/* PRICE */
function calc(){
  if(!service||!fromM||!toM)return;
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=h(a.lat,a.lng,b.lat,b.lng);
  dist.innerText=km.toFixed(2)+" km";
  const pr=service==="taxi"?Math.max(120,60+km*22):Math.max(80,40+km*15);
  price.innerText=Math.round(pr)+" TL";
}

/* CALL */
function callDriver(){
  if(!user||!service||!fromM||!toM){alert("Eksik bilgi");return;}
  const url=`${BACKEND}?action=createJob`
  +`&service_type=${service}`
  +`&customer_first=${user.f}`
  +`&customer_last=${user.l}`
  +`&customer_phone=${user.p}`
  +`&from_address=${fromAddr.value}`
  +`&to_address=${toAddr.value}`
  +`&distance_km=${dist.innerText.replace(" km","")}`
  +`&price=${price.innerText.replace(" TL","")}`
  +`&final_price=${price.innerText.replace(" TL","")}`;
  fetch(url).then(r=>r.json()).then(res=>{
    if(res.ok){
      location.href=`track.html?job_id=${res.job_id}&token=${res.track_token}`;
    }else alert("Hata");
  });
}

/* UTIL */
function h(a,b,c,d){
  const R=6371,dLat=(c-a)*Math.PI/180,dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function reverse(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
  .then(r=>r.json()).then(d=>{if(d.display_name)input.value=d.display_name});
}
</script>

</body>
</html>
