<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>SepetTaxi</title>
  <meta name="theme-color" content="#f5c400" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    *{box-sizing:border-box}
    :root{
      --y:#f5c400;
      --bg:#050506;
      --panel:#0f0f10;
      --card:#141416;
      --line:rgba(255,255,255,.10);
      --mut:rgba(255,255,255,.70);
      --mut2:rgba(255,255,255,.46);
      --ok:#33d17a;
      --bad:#ff4d4d;
    }
    html,body{
      margin:0;height:100%;
      background:var(--bg);color:#fff;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      overflow:hidden; /* Kƒ∞Lƒ∞TLƒ∞: scroll yok */
    }
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}

    /* ===== TOPBAR (tek hamburger) ===== */
    .topbar{
      height:56px;display:flex;align-items:center;justify-content:space-between;
      padding:0 12px;border-bottom:1px solid var(--line);
      background:rgba(5,5,6,.92);
      position:fixed;top:0;left:0;right:0;z-index:6000;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:900;letter-spacing:.2px;font-size:18px;
    }
    .brand b{color:var(--y)}
    .iconRow{display:flex;gap:10px;align-items:center}
    .iconBtn{
      width:38px;height:38px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      display:grid;place-items:center;
      color:#fff;cursor:pointer;
    }
    .iconBtn:active{transform:scale(.99)}
    .hamburger{width:18px;height:12px;position:relative}
    .hamburger i{position:absolute;left:0;right:0;height:2px;background:#fff;border-radius:99px}
    .hamburger i:nth-child(1){top:0}
    .hamburger i:nth-child(2){top:5px;opacity:.75}
    .hamburger i:nth-child(3){bottom:0}

    /* ===== DRAWER ===== */
    .drawerBack{
      position:fixed;inset:0;z-index:8000;
      background:rgba(0,0,0,.55);
      display:none;
    }
    .drawer{
      position:absolute;top:0;right:0;height:100%;width:320px;max-width:86vw;
      background:rgba(15,15,16,.96);
      border-left:1px solid var(--line);
      padding:14px;
      transform:translateX(110%);
      transition:transform .22s ease;
      backdrop-filter: blur(12px);
    }
    .drawerBack.show{display:block}
    .drawerBack.show .drawer{transform:translateX(0)}
    .drawerHead{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:10px;
    }
    .drawerHead h3{margin:0;font-size:16px}
    .menuItem{
      padding:12px;border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;cursor:pointer;
    }
    .menuItem small{display:block;color:var(--mut);margin-top:4px}

    /* ===== LAYOUT: Map 50% + Bottom 50% ===== */
    .wrap{
      position:fixed;inset:56px 0 0 0;
      display:flex;flex-direction:column;
    }
    #map{
      height:50vh;min-height:240px;
      border-bottom:1px solid var(--line);
    }
    .panel{
      height:calc(50vh - 56px);min-height:240px;
      padding:12px;
      background:linear-gradient(180deg, rgba(10,10,11,.70), rgba(10,10,11,.96));
    }
    /* Kƒ∞Lƒ∞TLƒ∞: Leaflet +/- yok */
    .leaflet-control-container{display:none}

    /* ===== Bottom Card ===== */
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:20px;
      padding:12px;
    }
    .seg{
      display:flex;gap:8px;
      margin-bottom:10px;
    }
    .segBtn{
      flex:1;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .segBtn.active{
      border-color:rgba(245,196,0,.55);
      background:rgba(245,196,0,.12);
    }
    .row{display:flex;gap:10px}
    .col{flex:1}
    .label{font-size:11px;color:var(--mut2);margin:4px 0 6px;letter-spacing:.2px}
    .input{
      width:100%;height:46px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:#fff;
      padding:0 12px;
      outline:none;
      font-size:14px;
    }
    .hint{
      margin-top:8px;
      font-size:12px;
      color:var(--mut);
      line-height:1.35;
    }
    .metrics{
      display:flex;gap:10px;margin-top:10px;
    }
    .metric{
      flex:1;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius:18px;
      padding:10px;
    }
    .metric small{color:var(--mut);font-size:11px}
    .metric b{display:block;font-size:18px;margin-top:2px}

    .cta{
      margin-top:10px;
      display:flex;gap:10px;
    }
    .btn{
      flex:1;height:52px;border-radius:18px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:#fff;font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      background:linear-gradient(180deg, rgba(245,196,0,.98), rgba(245,196,0,.78));
      color:#090909;
      border-color:rgba(0,0,0,.25);
    }
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .tiny{
      margin-top:6px;
      font-size:12px;
      color:rgba(255,255,255,.52);
    }

    /* ===== Center Map Hint Pin ===== */
    .mapHint{
      position:fixed;left:50%;
      top:calc(56px + 25vh);
      transform:translate(-50%,-50%);
      z-index:1200;
      pointer-events:none;
      display:flex;flex-direction:column;align-items:center;gap:6px;
    }
    .pin{
      width:36px;height:36px;border-radius:999px;
      border:1px solid rgba(245,196,0,.30);
      background:rgba(245,196,0,.10);
      display:grid;place-items:center;
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .pin svg{width:18px;height:18px;fill:var(--y)}
    .mapHint small{font-size:11px;color:rgba(255,255,255,.62)}

    /* ===== Markers ===== */
    .vehIcon{
      width:36px;height:36px;border-radius:999px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(20,20,22,.85);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
      font-size:16px;
    }

    /* ===== MODALS ===== */
    .modalBack{
      position:fixed;inset:0;z-index:9000;
      background:rgba(0,0,0,.62);
      display:none;
      backdrop-filter: blur(8px);
    }
    .modal{
      position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%);
      width:min(440px,92vw);
      border:1px solid var(--line);
      background:rgba(15,15,16,.94);
      border-radius:22px;
      padding:14px;
    }
    .modalHead{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:10px;
    }
    .modalHead h3{margin:0;font-size:15px}
    .closeX{
      width:36px;height:36px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      display:grid;place-items:center;
      cursor:pointer;
      font-weight:900;
    }
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid1{display:grid;grid-template-columns:1fr;gap:10px}
    .check{
      display:flex;gap:10px;align-items:flex-start;
      font-size:12px;color:var(--mut);line-height:1.35;margin-top:10px;
    }
    .modalFoot{display:flex;gap:10px;margin-top:12px}

    /* ===== Premium Searching Overlay ===== */
    .searchOverlay{
      position:fixed;inset:0;z-index:9500;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
    }
    .searchCard{
      position:absolute;left:50%;top:50%;
      transform:translate(-50%,-50%);
      width:min(380px,88vw);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(20,20,22,.82);
      border-radius:24px;
      padding:16px;
      box-shadow:0 20px 70px rgba(0,0,0,.60);
    }
    .badge{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      border:1px solid rgba(245,196,0,.35);
      background:linear-gradient(180deg, rgba(245,196,0,.18), rgba(245,196,0,.08));
      font-weight:900;
    }
    .pulse{
      width:10px;height:10px;border-radius:99px;background:var(--y);
      box-shadow:0 0 0 rgba(245,196,0,.55);
      animation:pulse 1.3s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(245,196,0,.45)}
      70%{box-shadow:0 0 0 18px rgba(245,196,0,0)}
      100%{box-shadow:0 0 0 0 rgba(245,196,0,0)}
    }
    .overlayText{margin-top:12px;color:rgba(255,255,255,.78);font-size:13px;line-height:1.4}
    .overlayMeta{margin-top:10px;color:rgba(255,255,255,.55);font-size:12px}
    .overlayActions{display:flex;gap:10px;margin-top:14px}
    .overlayActions .btn{height:46px;border-radius:16px}
    /* === CARD FOOTER FIX (CTA SABƒ∞T) === */
.card{
  display:flex;
  flex-direction:column;
  height:100%;
}

.cardBody{
  flex:1;
  overflow:hidden; /* scroll YOK */
}

.cardFooter{
  position:sticky;
  bottom:0;
  padding-top:10px;
  background:linear-gradient(
    180deg,
    rgba(15,15,16,0.6),
    rgba(15,15,16,0.95)
  );
}
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">Sepet<b>Taxi</b></div>
    <div class="iconRow">
      <button class="iconBtn" id="btnSupport" title="Destek">?</button>
      <button class="iconBtn" id="btnMenu" title="Men√º">
        <div class="hamburger"><i></i><i></i><i></i></div>
      </button>
    </div>
  </div>

  <!-- DRAWER -->
  <div class="drawerBack" id="drawerBack">
    <div class="drawer" role="dialog" aria-modal="true">
      <div class="drawerHead">
        <h3>Men√º</h3>
        <div class="closeX" id="btnCloseDrawer">√ó</div>
      </div>

      <div class="menuItem" id="goDriver">S√ºr√ºc√º Giri≈üi<small>driver.html</small></div>
      <div class="menuItem" id="goAdmin">Admin<small>admin.html</small></div>
      <div class="menuItem" id="goContracts">S√∂zle≈ümeler<small>(placeholder)</small></div>
      <div class="menuItem" id="goAbout">Hakkƒ±mƒ±zda<small>(placeholder)</small></div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="wrap">
    <div id="map"></div>

    <div class="panel">
  <div class="card">

  <!-- üîΩ √úST KISIM: i√ßerik -->
  <div class="cardBody">

    <!-- Nereden -->
    <div class="label">Nereden</div>
    <input class="input" id="fromInput" />

    <!-- Nereye -->
    <div class="label" style="margin-top:10px">Nereye</div>
    <input class="input" id="toInput" />

    <!-- Metrics -->
    <div class="metrics" id="metrics" style="display:none">
      <div class="metric">
        <small>Mesafe</small>
        <b id="mDistance">‚Äî</b>
      </div>
      <div class="metric">
        <small>√úcret</small>
        <b id="mPrice">‚Äî</b>
      </div>
    </div>

  </div>

  <!-- üîΩ ALT KISIM: SABƒ∞T CTA -->
  <div class="cardFooter">

    <div class="cta">
      <button class="btn" id="btnRegister">Kayƒ±t</button>
      <button class="btn primary" id="btnCall">Taksi √áaƒüƒ±r</button>
    </div>

    <div class="tiny" id="callNote"></div>

  </div>

</div>


        <!-- CTA -->
        <div class="cta">
          <button class="btn" id="btnRegister">Kayƒ±t</button>
          <button class="btn primary" id="btnCall">Taksi √áaƒüƒ±r</button>
        </div>
        <div class="tiny" id="callNote">Adresleri se√ßince mesafe ve √ºcret hesaplanƒ±r. √áaƒüƒ±rmak i√ßin kayƒ±t zorunludur.</div>
      </div>
    </div>
  </div>

  <!-- Map center hint -->
  <div class="mapHint">
    <div class="pin">
      <svg viewBox="0 0 24 24"><path d="M12 2c-3.9 0-7 3.1-7 7 0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z"/></svg>
    </div>
    <small>Haritaya tƒ±kla: Nereden / Nereye se√ß</small>
  </div>

  <!-- REGISTER MODAL (zorunlu kayƒ±t sadece modal) -->
  <div class="modalBack" id="regBack">
    <div class="modal">
      <div class="modalHead">
        <h3>Zorunlu Kayƒ±t</h3>
        <div class="closeX" id="regClose">√ó</div>
      </div>

      <div class="grid2">
        <div>
          <div class="label">Ad</div>
          <input class="input" id="regFirst" placeholder="√ñrn: √ñzhan" />
        </div>
        <div>
          <div class="label">Soyad</div>
          <input class="input" id="regLast" placeholder="√ñrn: Samurcu" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid1">
        <div>
          <div class="label">Telefon</div>
          <input class="input" id="regPhone" placeholder="05xx..." inputmode="tel" />
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn" id="regCancel">Vazge√ß</button>
        <button class="btn primary" id="regSave">Kaydet</button>
      </div>

      <div class="tiny">Kayƒ±t cihazƒ±nda saklanƒ±r. Kayƒ±t sonrasƒ± otomatik √ßaƒüƒ±rma yok; tekrar ‚Äú√áaƒüƒ±r‚Äùa basƒ±lƒ±r.</div>
    </div>
  </div>

  <!-- COURIER DETAILS MODAL -->
  <div class="modalBack" id="courBack">
    <div class="modal">
      <div class="modalHead">
        <h3>Kurye Detaylarƒ±</h3>
        <div class="closeX" id="courClose">√ó</div>
      </div>

      <div class="grid2">
        <div>
          <div class="label">Paket Tipi</div>
          <input class="input" id="cType" placeholder="Evrak / Kutu / Yemek" />
        </div>
        <div>
          <div class="label">Beyan Deƒüer</div>
          <input class="input" id="cValue" placeholder="√ñrn: 1000" inputmode="numeric" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid2">
        <div>
          <div class="label">Alƒ±cƒ± Ad Soyad</div>
          <input class="input" id="cRName" placeholder="√ñrn: Ahmet Yƒ±lmaz" />
        </div>
        <div>
          <div class="label">Alƒ±cƒ± Telefon</div>
          <input class="input" id="cRPhone" placeholder="05xx..." inputmode="tel" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="grid1">
        <div>
          <div class="label">ƒ∞√ßerik / Not</div>
          <input class="input" id="cNote" placeholder="Kƒ±rƒ±labilir, teslimde ara..." />
        </div>
      </div>

      <div class="check">
        <input type="checkbox" id="cTerms" />
        <div>
          Ta≈üƒ±ma taahh√ºd√ºn√º ve hizmet ≈üartlarƒ±nƒ± okudum, kabul ediyorum.
          <div style="margin-top:4px;color:rgba(255,255,255,.45)">Onay olmadan Kurye √ßaƒürƒ±lamaz.</div>
        </div>
      </div>

      <div class="modalFoot">
        <button class="btn" id="courCancel">Vazge√ß</button>
        <button class="btn primary" id="courSave">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- SEARCH OVERLAY -->
  <div class="searchOverlay" id="searchOverlay">
    <div class="searchCard">
      <div class="badge">
        <div class="pulse"></div>
        <span id="searchTitle">S√ºr√ºc√º aranƒ±yor</span>
      </div>
      <div class="overlayText" id="searchText">Yakƒ±n s√ºr√ºc√ºlerle e≈üle≈üiyoruz. L√ºtfen bekleyin‚Ä¶</div>
      <div class="overlayMeta" id="searchMeta">ƒ∞≈ü No: ‚Äî</div>
      <div class="overlayActions">
        <button class="btn" id="btnCancelSearch">Kapat</button>
        <button class="btn primary" id="btnGoTrack" style="display:none">Takip</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
========================= */
// BURAYA kendi Apps Script URL‚Äôini yaz:
const API_URL = "https://script.google.com/macros/s/AKfycbzQ5Nw3WJlOTkC5vrjQHyykHT3En-jmSkcdoBvgUC4v49n-MFFZhfKDBQ4Z1ehRLyWG/exec"; // .../exec

/* =========================
   STATE
========================= */
let map, userMarker, fromMarker, toMarker;
let picking = "from";
let serviceType = "taxi";
let lastDistanceKm = null;
let lastPrice = null;

let customer = loadCustomer();
let courierDetails = loadCourierDetails();

/* =========================
   HELPERS
========================= */
const $ = (id)=>document.getElementById(id);

function saveCustomer(c){ localStorage.setItem("sepettaxi_customer", JSON.stringify(c)); }
function loadCustomer(){
  try{ const s=localStorage.getItem("sepettaxi_customer"); return s?JSON.parse(s):null; }catch(_){ return null; }
}
function saveCourierDetails(d){ localStorage.setItem("sepettaxi_courier_details", JSON.stringify(d)); }
function loadCourierDetails(){
  try{ const s=localStorage.getItem("sepettaxi_courier_details"); return s?JSON.parse(s):null; }catch(_){ return null; }
}

function openDrawer(open){
  const back = $("drawerBack");
  if(open) back.classList.add("show");
  else back.classList.remove("show");
}
function openModal(id, open){
  $(id).style.display = open ? "block" : "none";
}

function setHint(t){ $("statusHint").textContent = t; }

function setService(type){
  serviceType = type;
  $("segTaxi").classList.toggle("active", type==="taxi");
  $("segCourier").classList.toggle("active", type==="courier");
  $("btnCall").textContent = (type==="taxi") ? "Taksi √áaƒüƒ±r" : "Kurye √áaƒüƒ±r";
  $("searchTitle").textContent = (type==="taxi") ? "S√ºr√ºc√º aranƒ±yor" : "Kurye aranƒ±yor";
  // Kurye se√ßilince detay modalƒ± a√ß (kilitli)
  if(type==="courier"){
    openCourierModal();
  }
  updateCallNote();
}

function updateCallNote(){
  const isReg = !!(customer && customer.first && customer.last && customer.phone);
  const hasRoute = !!(fromMarker && toMarker && $("fromInput").value.trim() && $("toInput").value.trim() && lastDistanceKm);

  let courierOk = true;
  if(serviceType==="courier"){
    courierOk = !!(courierDetails &&
      courierDetails.package_type &&
      courierDetails.receiver_name &&
      courierDetails.receiver_phone &&
      courierDetails.terms_ok === true
    );
  }

  if(!hasRoute){
    $("callNote").textContent = "Haritadan se√ß veya yaz: Nereden ve Nereye. Sonra mesafe ve √ºcret g√∂r√ºn√ºr.";
    return;
  }
  if(!isReg){
    $("callNote").textContent = "√áaƒüƒ±rmak i√ßin kayƒ±t zorunludur. ‚Äú√áaƒüƒ±r‚Äùa basƒ±nca kayƒ±t ekranƒ± a√ßƒ±lƒ±r.";
    return;
  }
  if(serviceType==="courier" && !courierOk){
    $("callNote").textContent = "Kurye i√ßin detaylar ve taahh√ºt onayƒ± zorunludur.";
    return;
  }
  $("callNote").textContent = (serviceType==="taxi") ? "Taksi √ßaƒürƒ±sƒ±na hazƒ±rsƒ±n." : "Kurye √ßaƒürƒ±sƒ±na hazƒ±rsƒ±n.";
}

function showSearching(show, metaText){
  $("searchOverlay").style.display = show ? "block" : "none";
  $("btnGoTrack").style.display = "none";
  $("searchMeta").textContent = metaText || "ƒ∞≈ü No: ‚Äî";
}

/* =========================
   MAP
========================= */
function initMap(){
  map = L.map("map", { zoomControl:false, attributionControl:false }).setView([40.1885, 29.0610], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  map.on("click", async (e)=>{
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    if(picking === "from"){
      setFrom(lat,lng);
      picking = "to";
      setHint("≈ûimdi 'Nereye' i√ßin haritaya tƒ±kla veya yaz.");
    }else{
      setTo(lat,lng);
      picking = "from";
      setHint("Adresler se√ßildi. Gerekirse d√ºzeltmek i√ßin tekrar haritaya tƒ±kla.");
    }

    await reverseFillInputs();
    await recompute();
  });

  // Geolocation (yoksa da sorun deƒüil)
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition((pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      setUser(lat,lng);
      map.setView([lat,lng], 16);
      setHint("Konum alƒ±ndƒ±. Haritaya tƒ±klayarak adres se√ßebilirsin.");
    }, ()=>{
      setHint("Konum alƒ±namadƒ±. Haritadan adres se√ßebilirsin.");
    }, { enableHighAccuracy:true, timeout:8000 });
  } else {
    setHint("Tarayƒ±cƒ± konum desteklemiyor. Haritadan adres se√ßebilirsin.");
  }

  // ƒ∞lk render sonrasƒ± leaflet size
  setTimeout(()=> { try{ map.invalidateSize(); }catch(_){} }, 350);
}

function divIcon(html){
  return L.divIcon({ className:"", html, iconSize:[36,36], iconAnchor:[18,18] });
}
function setUser(lat,lng){
  if(userMarker) map.removeLayer(userMarker);
  userMarker = L.marker([lat,lng], { icon: divIcon('<div class="vehIcon">üìç</div>') }).addTo(map);
}
function setFrom(lat,lng){
  if(fromMarker) map.removeLayer(fromMarker);
  fromMarker = L.marker([lat,lng], { icon: divIcon('<div class="vehIcon">üü°</div>') }).addTo(map);
}
function setTo(lat,lng){
  if(toMarker) map.removeLayer(toMarker);
  toMarker = L.marker([lat,lng], { icon: divIcon('<div class="vehIcon">‚ö´</div>') }).addTo(map);
}

/* =========================
   GEOCODE
========================= */
async function reverseGeocode(lat,lng){
  try{
    const url = "https://nominatim.openstreetmap.org/reverse?format=json&lat="+encodeURIComponent(lat)+"&lon="+encodeURIComponent(lng);
    const r = await fetch(url, { headers: { "Accept":"application/json" } });
    const j = await r.json();
    return j.display_name || "";
  }catch(_){ return ""; }
}
async function forwardGeocode(q){
  try{
    const url = "https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(q);
    const r = await fetch(url, { headers:{ "Accept":"application/json" } });
    const j = await r.json();
    if(Array.isArray(j) && j[0]){
      return { lat:Number(j[0].lat), lng:Number(j[0].lon), display:j[0].display_name || q };
    }
  }catch(_){}
  return null;
}
async function reverseFillInputs(){
  // yalnƒ±z bo≈üsa doldur (kullanƒ±cƒ± yazdƒ±ysa bozma)
  if(fromMarker && !$("fromInput").value.trim()){
    const p = fromMarker.getLatLng();
    const addr = await reverseGeocode(p.lat,p.lng);
    if(addr) $("fromInput").value = addr;
  }
  if(toMarker && !$("toInput").value.trim()){
    const p = toMarker.getLatLng();
    const addr = await reverseGeocode(p.lat,p.lng);
    if(addr) $("toInput").value = addr;
  }
}
async function onBlurGeocode(which){
  const el = which==="from" ? $("fromInput") : $("toInput");
  const val = el.value.trim();
  if(!val) return;
  const hit = await forwardGeocode(val);
  if(!hit) return;
  if(which==="from"){ setFrom(hit.lat, hit.lng); }
  else{ setTo(hit.lat, hit.lng); }
  // ƒ∞stersen normalize edebilirsin:
  // el.value = hit.display || val;
  await recompute();
}

/* =========================
   DISTANCE & PRICE
========================= */
function haversineKm(lat1, lon1, lat2, lon2){
  const R = 6371;
  const toRad = x => x*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLon = toRad(lon2-lon1);
  const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
            Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
            Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R*c;
}
function round2(n){ return Math.round(n*100)/100; }

function localPrice(distanceKm){
  // Bu sadece UI i√ßin; backend final_price d√∂nd√ºr√ºr.
  const base = (serviceType==="taxi") ? 60 : 55;
  const perKm = (serviceType==="taxi") ? 18 : 15;
  return round2(base + perKm*distanceKm);
}

async function recompute(){
  const hasRoute = !!(fromMarker && toMarker && $("fromInput").value.trim() && $("toInput").value.trim());
  if(!hasRoute){
    $("metrics").style.display = "none";
    lastDistanceKm = null; lastPrice = null;
    updateCallNote();
    return;
  }

  const a = fromMarker.getLatLng();
  const b = toMarker.getLatLng();
  const d = haversineKm(a.lat,a.lng,b.lat,b.lng);
  lastDistanceKm = round2(d);
  lastPrice = localPrice(lastDistanceKm);

  $("mDistance").textContent = lastDistanceKm.toFixed(1) + " km";
  $("mPrice").textContent = Math.round(lastPrice) + " TL";
  $("metrics").style.display = "flex";

  updateCallNote();
}

/* =========================
   BACKEND
========================= */
async function api(action, payload){
  const r = await fetch(API_URL, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action, ...payload })
  });
  return await r.json();
}

/* =========================
   MODALS
========================= */
function openRegisterModal(){
  $("regFirst").value = customer?.first || "";
  $("regLast").value  = customer?.last  || "";
  $("regPhone").value = customer?.phone || "";
  openModal("regBack", true);
}
function openCourierModal(){
  $("cType").value  = courierDetails?.package_type || "";
  $("cValue").value = courierDetails?.declared_value || "";
  $("cRName").value = courierDetails?.receiver_name || "";
  $("cRPhone").value= courierDetails?.receiver_phone || "";
  $("cNote").value  = courierDetails?.package_note || "";
  $("cTerms").checked = !!courierDetails?.terms_ok;
  openModal("courBack", true);
}

/* =========================
   CREATE JOB (Sheet‚Äôe yazar)
========================= */
async function createJob(){
  // Kayƒ±t yoksa modal (onayladƒ±ƒüƒ±n akƒ±≈ü)
  const isReg = !!(customer && customer.first && customer.last && customer.phone);
  if(!isReg){
    openRegisterModal();
    return;
  }

  // Route yoksa uyar
  const hasRoute = !!(fromMarker && toMarker && $("fromInput").value.trim() && $("toInput").value.trim() && lastDistanceKm);
  if(!hasRoute){
    alert("L√ºtfen nereden ve nereye se√ßin.");
    return;
  }

  // Kurye detay kontrol√º
  if(serviceType==="courier"){
    const courierOk = !!(courierDetails &&
      courierDetails.package_type &&
      courierDetails.receiver_name &&
      courierDetails.receiver_phone &&
      courierDetails.terms_ok === true
    );
    if(!courierOk){
      openCourierModal();
      return;
    }
  }

  showSearching(true, "ƒ∞≈ü No: hazƒ±rlanƒ±yor‚Ä¶");

  // payload
  const a = fromMarker.getLatLng();
  const b = toMarker.getLatLng();
  const payload = {
    service_type: serviceType,

    customer_first: customer.first,
    customer_last: customer.last,
    customer_phone: customer.phone,

    from_address: $("fromInput").value.trim(),
    to_address: $("toInput").value.trim(),

    pickup_lat: a.lat,
    pickup_lng: a.lng,
    dropoff_lat: b.lat,
    dropoff_lng: b.lng,

    distance_km: lastDistanceKm
  };

  if(serviceType==="courier"){
    payload.package_type   = courierDetails.package_type;
    payload.package_note   = courierDetails.package_note || "";
    payload.declared_value = courierDetails.declared_value || "";
    payload.receiver_name  = courierDetails.receiver_name;
    payload.receiver_phone = courierDetails.receiver_phone;
    payload.terms_ok       = true;
  }

  let res;
  try{
    res = await api("createJob", payload);
  }catch(e){
    showSearching(false);
    alert("Backend baƒülantƒ± hatasƒ±. API_URL doƒüru mu?");
    return;
  }

  if(!res || !res.ok){
    showSearching(false);
    alert("ƒ∞≈ü olu≈üturulamadƒ±: " + (res && (res.error || res.message) ? (res.error || res.message) : "Bilinmeyen hata"));
    return;
  }

  // Backend canonical price varsa UI g√ºncelle
  if(res.distance_km) $("mDistance").textContent = Number(res.distance_km).toFixed(1) + " km";
  if(res.final_price) $("mPrice").textContent = Math.round(Number(res.final_price)) + " TL";
  $("metrics").style.display = "flex";

  const jobId = res.job_id;
  $("searchMeta").textContent = "ƒ∞≈ü No: " + jobId;

  // Takibe git butonu
  $("btnGoTrack").style.display = "block";
  $("btnGoTrack").onclick = ()=> location.href = "track.html?job_id=" + encodeURIComponent(jobId);

  // Otomatik redirect (kilitli)
  setTimeout(()=> {
    location.href = "track.html?job_id=" + encodeURIComponent(jobId);
  }, 900);
}

/* =========================
   EVENTS
========================= */
function bindEvents(){
  // service toggle
  $("segTaxi").onclick = ()=> setService("taxi");
  $("segCourier").onclick = ()=> setService("courier");

  // drawer
  $("btnMenu").onclick = ()=> openDrawer(true);
  $("btnCloseDrawer").onclick = ()=> openDrawer(false);
  $("drawerBack").addEventListener("click",(e)=>{ if(e.target.id==="drawerBack") openDrawer(false); });

  // menu routes
  $("goDriver").onclick = ()=> location.href="driver.html";
  $("goAdmin").onclick = ()=> location.href="admin.html";
  $("goContracts").onclick = ()=> alert("S√∂zle≈ümeler: bir sonraki adƒ±mda eklenecek.");
  $("goAbout").onclick = ()=> alert("Hakkƒ±mƒ±zda: bir sonraki adƒ±mda eklenecek.");

  // support
  $("btnSupport").onclick = ()=>{
    const msg = encodeURIComponent("Merhaba, SepetTaxi destek. Yardƒ±m istiyorum.");
    alert("Destek:\n- WhatsApp: https://wa.me/90XXXXXXXXXX?text="+msg+"\n- E-posta: destek@sepettaxi.com");
  };

  // register modal open
  $("btnRegister").onclick = ()=> openRegisterModal();
  $("regClose").onclick = $("regCancel").onclick = ()=> openModal("regBack", false);
  $("regSave").onclick = ()=>{
    const c = {
      first: $("regFirst").value.trim(),
      last:  $("regLast").value.trim(),
      phone: $("regPhone").value.trim()
    };
    if(!c.first || !c.last || !c.phone){
      alert("L√ºtfen ad, soyad ve telefonu doldurun.");
      return;
    }
    customer = c;
    saveCustomer(c);
    openModal("regBack", false);
    updateCallNote();
    // Kƒ∞Lƒ∞TLƒ∞: otomatik √ßaƒüƒ±rma yok
  };

  // courier modal
  $("courClose").onclick = $("courCancel").onclick = ()=> openModal("courBack", false);
  $("courSave").onclick = ()=>{
    const d = {
      package_type: $("cType").value.trim(),
      declared_value: $("cValue").value.trim(),
      receiver_name: $("cRName").value.trim(),
      receiver_phone: $("cRPhone").value.trim(),
      package_note: $("cNote").value.trim(),
      terms_ok: $("cTerms").checked
    };
    if(!d.package_type || !d.receiver_name || !d.receiver_phone || !d.terms_ok){
      alert("Kurye i√ßin Paket Tipi, Alƒ±cƒ± bilgileri ve taahh√ºt onayƒ± zorunludur.");
      return;
    }
    courierDetails = d;
    saveCourierDetails(d);
    openModal("courBack", false);
    updateCallNote();
  };

  // call
  $("btnCall").onclick = createJob;

  // searching overlay
  $("btnCancelSearch").onclick = ()=> $("searchOverlay").style.display="none";

  // typing geocode
  $("fromInput").addEventListener("focus", ()=> picking="from");
  $("toInput").addEventListener("focus", ()=> picking="to");
  $("fromInput").addEventListener("blur", ()=> onBlurGeocode("from"));
  $("toInput").addEventListener("blur", ()=> onBlurGeocode("to"));

  // resize safety
  window.addEventListener("resize", ()=> { try{ map && map.invalidateSize(); }catch(_){} });
}

/* =========================
   BOOT
========================= */
(function boot(){
  bindEvents();
  initMap();
  setService("taxi");
  updateCallNote();

  if(customer){
    setHint("Ho≈ü geldin, " + customer.first + ". Haritadan adres se√ßerek devam edebilirsin.");
  }
})();
</script>
</body>
</html>
