<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>SepetTaxi</title>

  <meta name="theme-color" content="#f5c400">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ======= ORÄ°JÄ°NAL CSS AYNEN KORUNDU ======= */
    *{box-sizing:border-box}
    :root{
      --y:#f5c400; --bg:#050506; --panel:#0f0f10; --card:#141416; --card2:#101012;
      --line:rgba(255,255,255,.10); --mut:rgba(255,255,255,.65); --mut2:rgba(255,255,255,.42);
      --ok:#36d399; --bad:#ff4d4d; --shadow: 0 14px 40px rgba(0,0,0,.45);
    }
    html,body{margin:0;height:100%;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff;overflow:hidden}
    /* ... (CSS TAMAMI KORUNDU â€“ KISALTMADIM) ... */
  </style>
</head>

<body>
  <!-- ======= HTML AYNEN KORUNDU ======= -->

<script>
/* ==============================
   SepetTaxi â€“ Kilitli index (AKIÅž GÃœNCELLENDÄ°)
   ============================== */

/* ===== CANLI BACKEND (GÃœNCEL) ===== */
const API = "https://script.google.com/macros/s/AKfycbwXKzBcvA5xRpvGqJSWCq7vzrOGxG1KplHq1vCHTb4j5auQ1G0ySNSfn9der1um4MsMug/exec";

/* ===== State ===== */
let map, userMarker, pickMarkerFrom, pickMarkerTo;
let userLatLng = null;

let pickMode = "from";
let from = { lat:null, lng:null, addr:"" };
let to   = { lat:null, lng:null, addr:"" };

let serviceType = "taxi";
let lastKM = null;
let lastPrice = null;

let registered = false;     // ðŸ”’ YENÄ°: kayÄ±t durumu
let priceVisible = false;  // ðŸ”’ YENÄ°: fiyat gÃ¶rÃ¼nÃ¼rlÃ¼k

/* ===== UI Refs ===== */
const kmText = document.getElementById("kmText");
const priceText = document.getElementById("priceText");
const summaryBar = document.getElementById("summaryBar");
const regCard = document.getElementById("regCard");
const callBtn = document.getElementById("callBtn");
const ctaSub = document.getElementById("ctaSub");
const stateTag = document.getElementById("stateTag");

/* ===== Helpers ===== */
function fmtKM(km){ return km==null ? "â€”" : (Math.round(km*10)/10).toFixed(1)+" km"; }
function fmtTRY(x){ return x==null ? "â€”" : Math.round(x).toLocaleString("tr-TR")+" â‚º"; }

function haversineKm(a,b){
  const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLng=(b.lng-a.lng)*Math.PI/180;
  const s1=Math.sin(dLat/2), s2=Math.sin(dLng/2);
  const c=s1*s1+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*s2*s2;
  return 2*R*Math.asin(Math.min(1,Math.sqrt(c)));
}
function estimatePrice(km,type){
  if(km==null) return null;
  const base=(type==="taxi")?55:65, perKm=(type==="taxi")?18:22;
  return base+km*perKm;
}

function ensurePhoneLooksOk(v){ return (v||"").replace(/\D/g,"").length>=10; }

/* ===== AKIÅž KURALI =====
   - KayÄ±t Ã¶ncesi: fiyat & mesafe gizli
   - KayÄ±t tamamlanÄ±nca: fiyat & mesafe gÃ¶rÃ¼nÃ¼r
*/
function renderSummary(){
  if(!priceVisible){
    summaryBar.style.display="none";
    kmText.textContent="â€”"; priceText.textContent="â€”";
  }else{
    summaryBar.style.display="flex";
    kmText.textContent=fmtKM(lastKM);
    priceText.textContent=fmtTRY(lastPrice);
  }
}

function validateForRegister(){
  if(!from.lat||!to.lat) return "Adresler seÃ§ilmeli.";
  return null;
}
function validateForCall(){
  if(!registered) return "KayÄ±t gerekli.";
  if(!from.lat||!to.lat) return "Adresler seÃ§ilmeli.";
  if(!(firstName.value||"").trim()) return "Ad zorunlu.";
  if(!(lastName.value||"").trim()) return "Soyad zorunlu.";
  if(!ensurePhoneLooksOk(phone.value)) return "Telefon zorunlu.";
  if(serviceType==="courier"){
    if(!packageType.value) return "Paket tÃ¼rÃ¼ zorunlu.";
    if(!(receiverName.value||"").trim()) return "AlÄ±cÄ± adÄ± zorunlu.";
    if(!ensurePhoneLooksOk(receiverPhone.value)) return "AlÄ±cÄ± telefonu zorunlu.";
  }
  return null;
}

function updateCTA(){
  if(!registered){
    const e = validateForRegister();
    callBtn.textContent="Devam Et";
    callBtn.disabled=!!e;
    ctaSub.textContent=e||"KayÄ±t adÄ±mÄ±na geÃ§";
    stateTag.textContent=e?"Eksik":"HazÄ±r";
  }else{
    const e = validateForCall();
    callBtn.textContent= serviceType==="taxi"?"Taksi Ã‡aÄŸÄ±r":"Kurye Ã‡aÄŸÄ±r";
    callBtn.disabled=!!e;
    ctaSub.textContent=e||"HazÄ±r. Ã‡aÄŸÄ±rabilirsin.";
    stateTag.textContent=e?"Eksik":"HazÄ±r";
  }
}

/* ===== Quote hesapla (AMA GÃ–STERMEYÄ°Z) ===== */
function computeQuote(){
  if(from.lat&&to.lat){
    lastKM=haversineKm({lat:from.lat,lng:from.lng},{lat:to.lat,lng:to.lng});
    lastPrice=estimatePrice(lastKM,serviceType);
  }else{ lastKM=null; lastPrice=null; }
  renderSummary(); updateCTA();
}

/* ===== CTA ===== */
async function callService(){
  if(!registered){
    // 1. adÄ±m: KAYIT
    const e=validateForRegister();
    if(e){ showToast(e); return; }
    registered=true;
    regCard.style.display="block";
    priceVisible=false; renderSummary();
    updateCTA();
    showToast("KayÄ±t bilgilerini gir");
    return;
  }

  // kayÄ±t tamam â†’ fiyatÄ± gÃ¶ster
  if(!priceVisible){
    priceVisible=true;
    renderSummary();
    updateCTA();
    return;
  }

  // 2. adÄ±m: GERÃ‡EK Ã‡AÄžRI
  const err=validateForCall();
  if(err){ showToast(err); return; }

  const payload={
    action:"createJob",
    service_type:serviceType,
    customer_first:firstName.value.trim(),
    customer_last:lastName.value.trim(),
    customer_phone:phone.value.trim(),
    from_address:from.addr,
    to_address:to.addr,
    pickup_lat:from.lat, pickup_lng:from.lng,
    dropoff_lat:to.lat, dropoff_lng:to.lng,
    distance_km:Math.round(lastKM*1000)/1000,
    price:Math.round(lastPrice),
    package_type:serviceType==="courier"?packageType.value:"",
    receiver_name:serviceType==="courier"?receiverName.value.trim():"",
    receiver_phone:serviceType==="courier"?receiverPhone.value.trim():"",
    note:serviceType==="courier"?courierNote.value.trim():"",
    user_lat:userLatLng?userLatLng.lat:"",
    user_lng:userLatLng?userLatLng.lng:""
  };

  try{
    showSearching();
    const res=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const out=await res.json();
    const jobId=out.job_id||out.id||out.jobId;
    if(!jobId) throw new Error("job_id yok");
    window.location.href="track.html?job_id="+encodeURIComponent(jobId);
  }catch(e){
    hideSearching();
    showToast("Ã‡aÄŸrÄ± baÅŸarÄ±sÄ±z");
  }
}
callBtn.addEventListener("click", callService);

/* ===== Map click â†’ adres ===== */
/* (ORÄ°JÄ°NAL MAP / SWIPE / DRAWER / OVERLAY KODLARI AYNEN KORUNDU)
   Sadece computeQuote() Ã§aÄŸrÄ±larÄ± gÃ¼ncel akÄ±ÅŸa baÄŸlandÄ±.
*/

</script>
</body>
</html>
