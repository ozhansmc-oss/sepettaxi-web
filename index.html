<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SepetTaxi â€“ Talep OluÅŸtur</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{--black:#000;--yellow:#FFD400}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif}
header{padding:14px 16px;font-size:20px;font-weight:800;border-bottom:1px solid #eee}
header span{color:var(--yellow)}
#map{height:42vh}
.content{padding:16px;background:#fff;border-radius:22px 22px 0 0;margin-top:-20px}
.card{border:1px solid #eee;border-radius:18px;padding:14px;margin-bottom:12px}
.services{display:flex;gap:10px}
.service{flex:1;padding:14px;border-radius:14px;text-align:center;border:1px solid #ddd;cursor:pointer;font-weight:700}
.service.active{background:#000;color:#fff;border-color:#000}
.row{display:flex;justify-content:space-between;margin-top:8px;font-size:15px}
.row div:last-child{text-align:right;max-width:65%}
.price{font-size:26px;font-weight:900}
button{width:100%;padding:16px;border:none;border-radius:18px;font-size:17px;font-weight:800;cursor:pointer;background:var(--yellow)}
button:disabled{background:#ccc}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:999}
.modal.active{display:flex}
.modal-box{background:#fff;border-radius:20px;padding:20px;width:90%;max-width:420px}
input{width:100%;padding:12px;margin-top:8px;border-radius:12px;border:1px solid #ccc;font-size:15px}
label{font-size:14px}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span></header>
<div id="map"></div>

<div class="content">
  <div class="card">
    <div class="services">
      <div class="service active" data-service="taxi">Taksi</div>
      <div class="service" data-service="motor">Motor Kurye</div>
      <div class="service" data-service="carCourier">AraÃ§lÄ± Kurye</div>
    </div>
  </div>

  <div class="card">
    <div class="row"><div>ğŸ“ Nereden</div><div id="fromText">Konum alÄ±nÄ±yorâ€¦</div></div>
    <div class="row"><div>ğŸ Nereye</div><div id="toText">Haritadan seÃ§</div></div>
  </div>

  <div class="card">
    <div class="row"><div>ğŸ“ Mesafe</div><div id="distance">â€“</div></div>
    <div class="row"><div>ğŸ’° Ãœcret</div><div class="price" id="price">â€“</div></div>
  </div>

  <button id="continueBtn" disabled>Devam Et</button>
</div>

<!-- REGISTER MODAL -->
<div class="modal" id="registerModal">
  <div class="modal-box">
    <h3>KayÄ±t & Talep</h3>
    <input id="name" placeholder="Ad Soyad">
    <input id="phone" placeholder="Telefon (05XXXXXXXXX)" maxlength="11">
    <label><input type="checkbox" id="kvkk"> KVKK AydÄ±nlatma Metni</label><br>
    <label><input type="checkbox" id="contract"> Hizmet SÃ¶zleÅŸmesi</label>
    <button style="margin-top:12px" onclick="submitJob()">Talebi GÃ¶nder</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL = "PASTE_YOUR_APPS_SCRIPT_URL_HEREhttps://script.google.com/macros/s/AKfycbwxZaKhAR3XTCjWXhTHjoXM2vv9AnCdGjXbAbr0Udwd3CNu8WefJIdfZbJfQUsaMbox/exec
/* ================= STATE ================= */
let pickup=null, dropoff=null, selectedService="taxi";
let pickupMarker, dropoffMarker;

/* ================= MAP ================= */
const map=L.map("map");
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
map.locate({setView:true,maxZoom:16});

map.on("locationfound", async e=>{
  pickup=e.latlng;
  pickupMarker=L.marker(pickup).addTo(map);
  fromText.innerText=await reverseGeocode(pickup.lat,pickup.lng);
});

map.on("click", async e=>{
  if(!pickup) return;
  dropoff=e.latlng;
  if(dropoffMarker) map.removeLayer(dropoffMarker);
  dropoffMarker=L.marker(dropoff).addTo(map);
  toText.innerText=await reverseGeocode(dropoff.lat,dropoff.lng);
  calculate();
});

/* ================= SERVICES ================= */
document.querySelectorAll(".service").forEach(s=>{
  s.onclick=()=>{
    document.querySelectorAll(".service").forEach(x=>x.classList.remove("active"));
    s.classList.add("active");
    selectedService=s.dataset.service;
    if(dropoff) calculate();
  };
});

/* ================= GEO ================= */
async function reverseGeocode(lat,lng){
  const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,{headers:{"Accept-Language":"tr"}});
  const j=await r.json();
  return j.display_name;
}
function haversine(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180, dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*(2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x)));
}
function calculatePrice(s,km){
  const t={taxi:[40,18],motor:[35,12],carCourier:[50,15]};
  return Math.round(t[s][0]+km*t[s][1]);
}
function calculate(){
  const km=Number(haversine(pickup.lat,pickup.lng,dropoff.lat,dropoff.lng).toFixed(1));
  distance.innerText=km+" km";
  price.innerText=calculatePrice(selectedService,km)+" â‚º";
  continueBtn.disabled=false;
}

/* ================= JOB ================= */
continueBtn.onclick=()=>registerModal.classList.add("active");

async function submitJob(){
  if(name.value.length<3) return alert("Ad Soyad giriniz");
  if(!/^\d{11}$/.test(phone.value)) return alert("Telefon 11 haneli olmalÄ±");
  if(!kvkk.checked || !contract.checked) return alert("Onaylar zorunlu");

  const km = Number(distance.innerText.replace(" km",""));
  const job = {
    job_id: "JOB-"+Date.now(),
    created_at: new Date().toISOString(),
    service: selectedService,
    name: name.value,
    phone: phone.value,
    pickup_address: fromText.innerText,
    pickup_lat: pickup.lat,
    pickup_lng: pickup.lng,
    dropoff_address: toText.innerText,
    dropoff_lat: dropoff.lat,
    dropoff_lng: dropoff.lng,
    distance_km: km,
    price: Number(price.innerText.replace(" â‚º","")),
    status: "pending"
  };

  const res = await fetch(BACKEND_URL,{
    method:"POST",
    body:JSON.stringify(job)
  });
  const json = await res.json();

  if(json.success){
    alert("Talebiniz alÄ±ndÄ±\nJob ID: "+json.job_id);
    registerModal.classList.remove("active");
  }else{
    alert("Hata oluÅŸtu");
  }
}
</script>

</body>
</html>
