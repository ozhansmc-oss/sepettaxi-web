<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SepetTaxi — Tek Sayfa</title>

<style>
  body, html {margin:0; padding:0; width:100%; height:100%; font-family:Arial,sans-serif;}
  #app {display:flex; flex-direction:column; height:100%;}
  #map {flex:1; width:100%;}
  .panel {padding:12px; background:#fff; box-shadow:0 -2px 6px rgba(0,0,0,0.15);}
  .row {margin-bottom:8px;}
  .row label {display:block; font-size:14px; font-weight:600;}
  .row input, .row select {width:100%; padding:8px; box-sizing:border-box;}
  button {width:100%; padding:12px; font-size:16px; background:#007bff; color:#fff; border:none; cursor:pointer;}
  button:disabled {background:#888;}
  .info {font-size:14px; margin-top:8px;}
  .error {color:#d00;}
  .success {color:#080;}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</head>
<body>

<div id="app">
  <div id="map"></div>

  <div class="panel">
    <div class="row">
      <label>Hizmet Seçimi</label>
      <select id="serviceType">
        <option value="taxi">Taksi</option>
        <option value="courier">Kurye</option>
        <option value="transfer">Transfer</option>
      </select>
    </div>

    <div class="row">
      <label>Telefon (05XXXXXXXXX)</label>
      <input type="text" id="phone" placeholder="0532..." />
    </div>

    <div class="row">
      <label>Ad Soyad</label>
      <input type="text" id="name" placeholder="Ad Soyad" />
    </div>

    <div class="row">
      <input type="checkbox" id="kvkk" />
      <label for="kvkk">KVKK ve Hizmet Şartlarını okudum, kabul ediyorum</label>
    </div>

    <button id="btnSubmit">Talep Oluştur</button>

    <div class="info" id="status"></div>
  </div>

</div>

<script>
(async function(){
  const API_URL = "https://script.google.com/macros/s/AKfycbxnLQqyuBgDxYMJmNY_9ShqCFWLDF2gDVwEqNuIGDNB1IN-msQXxTWVVBpljl-_am8w5w/exec";

  let map, pickupMarker, dropoffMarker;
  let pickup = null, dropoff = null;

  function setStatus(msg, isError){
    const st = document.getElementById("status");
    st.textContent = msg;
    st.className = isError ? "error" : "success";
  }

  function initMap(){
    map = L.map("map").setView([39.92077, 32.85411], 11);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution:"&copy; OpenStreetMap"
    }).addTo(map);

    map.on("click", function(e){
      if(!pickup){
        pickup = e.latlng;
        pickupMarker = L.marker(pickup, {draggable:true}).addTo(map)
          .bindPopup("Alış Noktası").openPopup();
        setStatus("Bırakma noktasını seçin", false);
      } else if(!dropoff){
        dropoff = e.latlng;
        dropoffMarker = L.marker(dropoff, {draggable:true}).addTo(map)
          .bindPopup("Bırakma Noktası").openPopup();
        calculateDistance();
      }
    });
  }

  function calculateDistance(){
    if(pickup && dropoff){
      const distMeters = map.distance(pickup, dropoff);
      const distKm = (distMeters / 1000).toFixed(2);
      setStatus("Mesafe: " + distKm + " km", false);
    }
  }

  document.getElementById("btnSubmit").addEventListener("click", async function(){
    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const kvkkAccepted = document.getElementById("kvkk").checked;
    const serviceType = document.getElementById("serviceType").value;

    if(!pickup || !dropoff){
      return setStatus("Lütfen haritada iki nokta seçin", true);
    }
    if(!phone.match(/^05\d{9}$/)){
      return setStatus("Geçerli bir telefon girin", true);
    }
    if(!name){
      return setStatus("İsim girin", true);
    }
    if(!kvkkAccepted){
      return setStatus("KVKK kabul etmelisiniz", true);
    }

    const distMeters = map.distance(pickup, dropoff);
    const distanceKm = parseFloat((distMeters/1000).toFixed(2));
    const estimatedPrice = estimatePrice(serviceType, distanceKm);

    const body = {
      action:"create_job",
      user:{
        name, phone, kvkkAccepted, kvkkVersion:"v1", source:"web"
      },
      job:{
        service_type:serviceType,
        pickup:{lat:pickup.lat, lng:pickup.lng, address:""},
        dropoff:{lat:dropoff.lat, lng:dropoff.lng, address:""},
        distance_km:distanceKm,
        estimated_price:estimatedPrice,
        currency:"TRY",
        notes:""
      }
    };

    try{
      setStatus("Gönderiliyor...", false);
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if(data.ok){
        setStatus("Talebiniz alındı! İş ID: " + data.job.job_id, false);
      } else {
        setStatus("Hata: " + (data.message||"Bilinmeyen"), true);
      }
    }catch(err){
      setStatus("Sunucu hatası: " + err.message, true);
    }
  });

  function estimatePrice(service, km){
    let base = 10;
    let perKm = 15;
    if(service === "courier"){ base = 8; perKm = 10; }
    if(service === "transfer"){ base = 15; perKm = 18; }
    return Math.max(base + perKm * km, 0).toFixed(2);
  }

  initMap();

})();
</script>

</body>
</html>
