<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* ==== AYNI CSS â€“ DEÄžÄ°ÅžMEDÄ° ==== */
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--line:#222;--muted:#9a9a9a;--card1:#141414;--card2:#0f0f0f;--ok:#2ecc71;--bad:#e74c3c}
/* â€¦ (CSS TAMAMI SENÄ°N GÃ–NDERDÄ°ÄžÄ°NLE AYNIDIR) â€¦ */
</style>
</head>

<body>

<!-- ================= APP HTML â€“ AYNI ================= -->
<!-- (Landing, modal, map, panel, courier, taxi, searching vs.) -->
<!-- HÄ°Ã‡BÄ°R HTML ETÄ°KETÄ° DEÄžÄ°ÅžTÄ°RÄ°LMEDÄ° -->

<script src="config.js"></script>

<script>
/* =====================================================
   ðŸ”’ TRACK EMBED PATCH (TEMÄ°Z & GÃ–MÃœLÃœ)
   ===================================================== */

/* --- GOTO TRACK (GARANTÄ°LÄ°) --- */
function gotoTrack(){
  const jid = currentJobId || sessionStorage.getItem("SEPT_job_id");
  const tok = currentTrackToken || sessionStorage.getItem("SEPT_track_token");
  if(!jid){ toast("Takip bilgisi bulunamadÄ±"); return; }

  const base = location.pathname.replace(/\/[^\/]*$/, "/track.html");
  const url = new URL(base, location.origin);
  url.searchParams.set("job_id", jid);
  if(tok) url.searchParams.set("track_token", tok);
  location.href = url.toString();
}

/* =====================================================
   CREATE TAXI JOB (EMBEDDED)
   ===================================================== */
async function createTaxiJob(){
  if(!ensureRegistered()) return;
  if(!(userLatLng && destLatLng)){ toast("VarÄ±ÅŸ noktasÄ± seÃ§in"); return; }

  const calc = computeDistanceAndPrice() || {};
  showSearching(true);
  setSearchingUI("creating");

  const res = await apiPost("createJob",{
    service_type:"taxi",
    customer_first:customer.first,
    customer_last:customer.last,
    customer_phone:customer.phone,
    from_address:$("fromInput").value,
    to_address:$("toInput").value,
    pickup_lat:userLatLng.lat,
    pickup_lng:userLatLng.lng,
    dropoff_lat:destLatLng.lat,
    dropoff_lng:destLatLng.lng,
    distance_km:calc.km,
    price:calc.price,
    final_price:calc.price
  });

  if(!res.ok){ setSearchingUI("error"); return; }

  currentJobId = res.job_id;
  currentTrackToken = res.track_token;

  /* ðŸ”½ TRACK DATA GÃ–MÃœLDÃœ */
  sessionStorage.setItem("SEPT_job_id", currentJobId);
  sessionStorage.setItem("SEPT_track_token", currentTrackToken);
  sessionStorage.setItem("SEPT_pickup_lat", userLatLng.lat);
  sessionStorage.setItem("SEPT_pickup_lng", userLatLng.lng);
  sessionStorage.setItem("SEPT_drop_lat", destLatLng.lat);
  sessionStorage.setItem("SEPT_drop_lng", destLatLng.lng);

  pollStartedAt = Date.now();
  pollTimer = setInterval(pollJob,3000);
}

/* =====================================================
   CREATE COURIER JOB (EMBEDDED)
   ===================================================== */
async function createCourierJob(){
  if(!ensureRegistered()) return;
  if(!(cFromLatLng && cToLatLng)){ toast("Adresleri seÃ§in"); return; }

  const calc = computeCourierDistanceAndPrice() || {};
  showSearching(true);
  setSearchingUI("creating");

  const res = await apiPost("createJob",{
    service_type:"courier",
    customer_first:customer.first,
    customer_last:customer.last,
    customer_phone:customer.phone,
    from_address:$("cFromInput").value,
    to_address:$("cToInput").value,
    pickup_lat:cFromLatLng.lat,
    pickup_lng:cFromLatLng.lng,
    dropoff_lat:cToLatLng.lat,
    dropoff_lng:cToLatLng.lng,
    distance_km:calc.km,
    price:calc.price,
    final_price:calc.price,
    package_type:pkgType,
    receiver_name:$("recvName").value,
    receiver_phone:$("recvPhone").value.replace(/\D/g,"")
  });

  if(!res.ok){ setSearchingUI("error"); return; }

  currentJobId = res.job_id;
  currentTrackToken = res.track_token;

  /* ðŸ”½ TRACK DATA GÃ–MÃœLDÃœ */
  sessionStorage.setItem("SEPT_job_id", currentJobId);
  sessionStorage.setItem("SEPT_track_token", currentTrackToken);
  sessionStorage.setItem("SEPT_pickup_lat", cFromLatLng.lat);
  sessionStorage.setItem("SEPT_pickup_lng", cFromLatLng.lng);
  sessionStorage.setItem("SEPT_drop_lat", cToLatLng.lat);
  sessionStorage.setItem("SEPT_drop_lng", cToLatLng.lng);

  pollStartedAt = Date.now();
  pollTimer = setInterval(pollJob,3000);
}
</script>

</body>
</html>
