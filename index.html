<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900}
header span{color:#f5c400}
#map{height:34vh}
#panel{padding:10px;display:flex;flex-direction:column;gap:10px}
.card{background:#111;border-radius:14px;padding:12px}
.service-row{display:flex;gap:8px}
.service{flex:1;text-align:center;padding:12px;border-radius:12px;border:1px solid #222;color:#888}
.service.active{border-color:#f5c400;color:#fff}
.input{width:100%;padding:10px;border-radius:12px;background:#000;border:1px solid #222;color:#fff}
.stats{display:flex;gap:8px}
.stat{flex:1;background:#0f0f0f;border-radius:12px;padding:10px;text-align:center}
#call{margin:10px;background:#f5c400;color:#000;border-radius:30px;padding:16px;text-align:center;font-weight:900}
#register{position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:999}
#register .box{background:#111;padding:16px;border-radius:16px;width:90%;max-width:340px}
.err{color:#ff5c5c;font-size:12px;display:none}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span></header>
<div id="map"></div>

<div id="panel">
  <div class="card">
    <b>Hizmet Se√ß</b>
    <div class="service-row">
      <div id="svcTaxi" class="service" onclick="selectService('taxi')">üöï Taksi</div>
      <div id="svcCourier" class="service" onclick="selectService('courier')">üì¶ Kurye</div>
    </div>
    <small style="color:#777">Hizmet se√ßmeden √∂nce kayƒ±t zorunludur</small>
  </div>

  <div class="card"><input id="fromAddr" class="input" placeholder="Nereden" readonly></div>
  <div class="card"><input id="toAddr" class="input" placeholder="Nereye" readonly></div>

  <div class="stats">
    <div class="stat"><div>Mesafe</div><b id="dist">‚Äî</b></div>
    <div class="stat"><div>√úcret</div><b id="price">‚Äî</b></div>
  </div>
</div>

<div id="call" onclick="callDriver()">√áAƒûIR</div>

<!-- REGISTER -->
<div id="register">
  <div class="box">
    <input id="fn" class="input" placeholder="Ad">
    <input id="ln" class="input" placeholder="Soyad">
    <input id="ph" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <label style="font-size:12px"><input type="checkbox" id="kvkk"> KVKK kabul</label>
    <div id="regErr" class="err">Bilgiler hatalƒ±</div>
    <div id="call" onclick="completeRegister()">KAYDI TAMAMLA</div>
  </div>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

let map,fromM,toM;
let service=null;
let registered=false;

function init(){
  map=L.map("map").setView([40.2,28.9],13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  navigator.geolocation.getCurrentPosition(p=>{
    fromM=L.marker([p.coords.latitude,p.coords.longitude]).addTo(map);
    reverse(p.coords.latitude,p.coords.longitude,fromAddr);
    map.setView([p.coords.latitude,p.coords.longitude],15);
  });

  map.on("click",e=>{
    if(!registered || !service) return;
    toM?toM.setLatLng(e.latlng):toM=L.marker(e.latlng).addTo(map);
    reverse(e.latlng.lat,e.latlng.lng,toAddr);
    calc();
  });
}
init();

function selectService(t){
  if(!registered){openRegister();return;}
  service=t;
  svcTaxi.classList.toggle("active",t==="taxi");
  svcCourier.classList.toggle("active",t==="courier");
}

function openRegister(){ register.style.display="flex"; }

function completeRegister(){
  if(fn.value.length<2||ln.value.length<2||!/^05\d{9}$/.test(ph.value)||!kvkk.checked){
    regErr.style.display="block";return;
  }
  registered=true;
  register.style.display="none";
}

function calc(){
  if(!service||!fromM||!toM) return;
  const a=fromM.getLatLng(),b=toM.getLatLng();
  const km=h(a.lat,a.lng,b.lat,b.lng);
  dist.textContent=km.toFixed(2)+" km";
  price.textContent=Math.round(service==="taxi"?Math.max(120,60+km*22):Math.max(80,40+km*15))+" TL";
}

<script>
async function callDriver(){

  /* 1Ô∏è‚É£ ZORUNLU KONTROLLER */
  if(!registered){
    openRegister();
    return;
  }
  if(!service){
    alert("Hizmet se√ßmelisin");
    return;
  }
  if(!fromM || !toM){
    alert("Nereden / Nereye eksik");
    return;
  }

  /* 2Ô∏è‚É£ MESAFE & √úCRET */
  const a = fromM.getLatLng();
  const b = toM.getLatLng();
  const km = h(a.lat,a.lng,b.lat,b.lng);

  const price =
    service==="taxi"
      ? Math.round(Math.max(120,60+km*22))
      : Math.round(Math.max(80,40+km*15));

  /* 3Ô∏è‚É£ PAYLOAD */
  const payload = {
    action: "createJob",
    service_type: service,
    from_addr: fromAddr.value,
    to_addr: toAddr.value,
    from_lat: a.lat,
    from_lng: a.lng,
    to_lat: b.lat,
    to_lng: b.lng,
    distance_km: Number(km.toFixed(2)),
    price_brut: price,
    customer: {
      first: fn.value,
      last: ln.value,
      phone: ph.value
    }
  };

  /* 4Ô∏è‚É£ UI Kƒ∞Lƒ∞T */
  call.innerText = "G√∂nderiliyor...";
  call.style.pointerEvents = "none";

  /* 5Ô∏è‚É£ BACKEND */
  try{
    const res = await fetch(BACKEND_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if(!data.ok || !data.job_id){
      throw new Error("createJob failed");
    }

    alert("ƒ∞≈ü olu≈üturuldu: " + data.job_id);

    // Bƒ∞R SONRAKƒ∞ Kƒ∞Lƒ∞TLƒ∞ ADIM:
    // window.location.href = "track.html?job_id="+data.job_id;

  }catch(err){
    console.error(err);
    alert("Backend hatasƒ± ‚Äì console kontrol et");
  }finally{
    call.innerText = "√áAƒûIR";
    call.style.pointerEvents = "auto";
  }
}
</script>


function h(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function reverse(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
  .then(r=>r.json()).then(d=>{if(d.display_name)input.value=d.display_name});
}
</script>

</body>
</html>
