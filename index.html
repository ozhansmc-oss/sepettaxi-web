<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff;overflow:hidden}
:root{--y:#f5c400;--line:#222;--card:#101010;--card2:#141414;--mut:#9a9a9a}

/* ===== LANDING ===== */
#landing{position:fixed;inset:0;background:#000 url("assets/landing.png") center/cover no-repeat;z-index:1000}
#landing .overlay{position:absolute;inset:0;background:rgba(0,0,0,.65);display:flex;flex-direction:column;align-items:center;justify-content:center}
#landing h1{font-size:40px;margin:0 0 18px}
#landing span{color:var(--y)}
#landing button{background:var(--y);color:#000;border:0;border-radius:28px;padding:14px 46px;font-size:17px;font-weight:900;box-shadow:0 10px 30px rgba(245,196,0,.35);cursor:pointer}

/* ===== APP ===== */
#app{display:none;height:100%}
header{
  height:56px;background:#000;border-bottom:1px solid #111;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:900;position:relative
}
header span{color:var(--y)}
#burgerBtn{
  position:absolute;right:10px;top:50%;transform:translateY(-50%);
  width:42px;height:36px;border-radius:12px;border:1px solid #222;
  background:#0b0b0b;color:#fff;cursor:pointer;
  display:flex;align-items:center;justify-content:center;font-size:18px
}

/* ===== MAP ===== */
#map{height:32vh}

/* ===== PANEL ===== */
#panel{
  height:calc(68vh - 56px);
  padding:10px;
  display:flex;flex-direction:column;gap:10px;
  padding-bottom:86px; /* CTA alanƒ± */
  overflow:auto;
}

/* ===== CARDS ===== */
.card{
  background:linear-gradient(180deg,var(--card2),var(--card));
  border-radius:14px;padding:12px;
  box-shadow:0 8px 20px rgba(0,0,0,.6);
  border:1px solid #111
}
.row{display:flex;gap:8px}

/* ===== SERVICE ===== */
.service-row{display:flex;gap:10px;margin-top:10px}
.service{
  flex:1;padding:12px;border-radius:14px;text-align:center;font-size:13px;
  border:1px solid #222;color:#aaa;transition:.18s;cursor:pointer;background:#0a0a0a;
  user-select:none
}
.service.active{
  border-color:var(--y);color:#fff;
  box-shadow:0 0 0 1px rgba(245,196,0,.22),0 8px 18px rgba(245,196,0,.18)
}
.service.disabled{
  opacity:.35;
  pointer-events:none;
}

/* ===== INPUT ===== */
.input{
  width:100%;
  padding:11px 12px;border-radius:12px;border:1px solid #1f1f1f;
  background:#000;color:#fff;font-size:13px
}
.input::placeholder{color:#666}
.label{font-size:11px;color:#aaa;margin:0 0 6px 2px}
.small{font-size:11px;color:#888}

/* ===== STATS ===== */
.stats{display:flex;gap:10px}
.stat{
  flex:1;background:#111;border-radius:14px;padding:12px;text-align:center;border:1px solid #141414
}
.stat .lbl{font-size:11px;color:#aaa}
.stat .val{font-size:18px;font-weight:900}

/* ===== STICKY CTA ===== */
#stickyBar{
  position:fixed;bottom:0;left:0;right:0;
  background:linear-gradient(180deg,rgba(0,0,0,.5),#000);
  padding:10px;z-index:200;border-top:1px solid #111
}
#callBtn{
  height:56px;
  display:flex;align-items:center;justify-content:center;
  background:var(--y);color:#000;border-radius:18px;
  font-weight:900;
  box-shadow:0 10px 26px rgba(245,196,0,.25);
  transition:transform .12s;
  cursor:pointer;
  user-select:none
}
#callBtn:active{transform:scale(.98)}
#callHint{margin-top:6px;font-size:11px;color:#8a8a8a;text-align:center}

/* ===== RIGHT DRIVER CTA ===== */
#driverSide{
  position:fixed;right:12px;top:92px;z-index:210;
  width:170px;border-radius:16px;border:1px solid #222;background:#0b0b0b;
  padding:10px;box-shadow:0 10px 24px rgba(0,0,0,.55)
}
#driverSide .t{font-size:12px;font-weight:900;margin-bottom:8px}
#driverSide .btn{
  width:100%;padding:10px;border-radius:12px;border:1px solid #222;background:#121212;color:#fff;
  cursor:pointer;font-weight:900;font-size:12px;margin-bottom:8px
}
#driverSide .btn:last-child{margin-bottom:0}
#driverSide .btn.primary{border-color:rgba(245,196,0,.35)}

/* Mobilde saƒü kartlar alta alƒ±nsƒ±n */
@media (max-width: 560px){
  #driverSide{
    right:10px; top:auto; bottom:86px;
    width:160px;
  }
}

/* ===== MODALS ===== */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.86);
  display:none;align-items:center;justify-content:center;z-index:600
}
.modal .box{
  width:90%;max-width:380px;background:#0f0f0f;border:1px solid #222;
  border-radius:16px;padding:14px 14px 16px;box-shadow:0 20px 50px rgba(0,0,0,.8);
  position:relative
}
.modal .x{
  position:absolute;right:10px;top:10px;
  width:34px;height:34px;border-radius:12px;border:1px solid #222;background:#111;color:#fff;cursor:pointer
}
.modal h3{margin:0 0 10px;font-size:16px}
.err{color:#ff5c5c;font-size:12px;display:none;margin-top:8px}

/* ===== HAMBURGER DRAWER ===== */
#drawer{
  position:fixed;top:0;right:-320px;width:300px;height:100%;
  background:#0b0b0b;border-left:1px solid #222;z-index:800;
  transition:right .2s;box-shadow:-20px 0 60px rgba(0,0,0,.6)
}
#drawer.open{right:0}
#drawer .top{
  height:56px;display:flex;align-items:center;justify-content:space-between;
  padding:0 12px;border-bottom:1px solid #111;background:#0b0b0b
}
#drawer .top b{font-size:14px}
#drawerClose{
  width:40px;height:34px;border-radius:12px;border:1px solid #222;background:#111;color:#fff;cursor:pointer
}
#drawer .content{padding:12px}
.drawerBtn{
  width:100%;padding:12px;border-radius:14px;border:1px solid #222;
  background:#121212;color:#fff;text-align:left;font-weight:900;cursor:pointer;margin-bottom:10px
}
.drawerBtn span{color:var(--y)}
.drawerBtn:last-child{margin-bottom:0}

.app-locked{filter:blur(3px) brightness(.7);pointer-events:none;transition:.2s}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing">
  <div class="overlay">
    <h1>Sepet<span>Taxi</span></h1>
    <button id="startBtn">BA≈ûLA</button>
  </div>
</div>

<!-- DRAWER -->
<div id="drawer" aria-hidden="true">
  <div class="top">
    <b>Men√º</b>
    <button id="drawerClose">‚úï</button>
  </div>
  <div class="content">
    <button class="drawerBtn" id="menuDriverApply">üöó <span>S√ºr√ºc√º Ol</span></button>
    <button class="drawerBtn" id="menuDriverLogin">üîë <span>S√ºr√ºc√º Giri≈üi</span></button>
  </div>
</div>

<!-- APP -->
<div id="app">
  <header>
    Sepet<span>Taxi</span>
    <button id="burgerBtn" title="Men√º">‚ò∞</button>
  </header>

  <div id="map"></div>

  <div id="panel">
    <div class="card">
      <b>Hizmet Se√ß</b>
      <div class="service-row">
        <div id="svcTaxi" class="service">üöï Taksi</div>
        <div id="svcCourier" class="service">üì¶ Kurye</div>
      </div>
      <div class="small" style="margin-top:10px">Hizmeti se√ßmeden √∂nce kayƒ±t zorunludur.</div>
    </div>

    <div class="card">
      <div class="label">Nereden</div>
      <input id="fromAddr" class="input" readonly placeholder="Konum alƒ±nƒ±yor...">
    </div>

    <div class="card">
      <div class="label">Nereye</div>
      <input id="toAddr" class="input" readonly placeholder="Haritadan se√ß">
      <div class="small" style="margin-top:8px">Haritaya tƒ±klayƒ±p ‚ÄúNereye‚Äù se√ßebilirsin.</div>
    </div>

    <div id="courierBox" class="card" style="display:none">
      <div class="label">Kurye Detaylarƒ± (Zorunlu)</div>
      <div class="row">
        <input id="pkgType" class="input" placeholder="Paket T√ºr√º">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="recvName" class="input" placeholder="Alƒ±cƒ± Adƒ±">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="recvPhone" class="input" placeholder="Alƒ±cƒ± Telefon (05...)" maxlength="11">
      </div>
      <div class="row" style="margin-top:8px">
        <input id="contentNote" class="input" placeholder="ƒ∞√ßerik Notu (opsiyonel)">
      </div>
    </div>

    <div class="stats">
      <div class="stat">
        <div class="lbl">Mesafe</div>
        <div id="dist" class="val">‚Äî</div>
      </div>
      <div class="stat">
        <div class="lbl">√úcret</div>
        <div id="price" class="val">‚Äî</div>
      </div>
    </div>
  </div>
</div>

<!-- RIGHT DRIVER CTA -->
<div id="driverSide">
  <div class="t">üöó S√ºr√ºc√º m√ºs√ºn?</div>
  <button class="btn primary" id="sideDriverApply">S√ºr√ºc√º Ol</button>
  <button class="btn" id="sideDriverLogin">S√ºr√ºc√º Giri≈üi</button>
</div>

<!-- STICKY CTA -->
<div id="stickyBar">
  <div id="callBtn">Hƒ∞ZMET SE√á</div>
  <div id="callHint">Haritadan ‚ÄúNereye‚Äù se√ßmeden √ßaƒürƒ± olu≈üturulmaz.</div>
</div>

<!-- REGISTER (CUSTOMER) -->
<div id="regModal" class="modal">
  <div class="box">
    <button class="x" id="regClose">‚úï</button>
    <h3>Zorunlu Kayƒ±t</h3>
    <input id="cFirst" class="input" placeholder="Ad">
    <div style="height:8px"></div>
    <input id="cLast" class="input" placeholder="Soyad">
    <div style="height:8px"></div>
    <input id="cPhone" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <div style="height:10px"></div>
    <label class="small"><input type="checkbox" id="kvkk"> KVKK kabul</label>
    <div id="regErr" class="err">Bilgiler hatalƒ±. (Ad/Soyad min 2, telefon 05 ile ba≈ülayƒ±p 11 hane, KVKK zorunlu)</div>
    <div style="height:12px"></div>
    <div id="regOkBtn" style="background:var(--y);color:#000;border-radius:14px;padding:12px;text-align:center;font-weight:900;cursor:pointer">KAYDI TAMAMLA</div>
  </div>
</div>

<!-- DRIVER APPLY MODAL -->
<div id="drvApplyModal" class="modal">
  <div class="box">
    <button class="x" id="drvApplyClose">‚úï</button>
    <h3>S√ºr√ºc√º Ol (Aday)</h3>
    <input id="dName" class="input" placeholder="Ad Soyad">
    <div style="height:8px"></div>
    <input id="dPhone" class="input" placeholder="05XXXXXXXXX" maxlength="11">
    <div style="height:8px"></div>
    <input id="dVehicle" class="input" placeholder="Ara√ß Bilgisi (Plaka/Model)">
    <div id="drvApplyErr" class="err">Bilgiler hatalƒ±.</div>
    <div style="height:12px"></div>
    <div id="drvApplyBtn" style="background:#121212;border:1px solid #222;color:#fff;border-radius:14px;padding:12px;text-align:center;font-weight:900;cursor:pointer">BA≈ûVUR</div>
    <div class="small" id="drvApplyDone" style="display:none;margin-top:10px;color:#9be69b"></div>
  </div>
</div>

<!-- DRIVER LOGIN MODAL -->
<div id="drvLoginModal" class="modal">
  <div class="box">
    <button class="x" id="drvLoginClose">‚úï</button>
    <h3>S√ºr√ºc√º Giri≈üi</h3>
    <input id="dLoginId" class="input" placeholder="Driver ID (√∂rn: DRV-ABC1234)">
    <div id="drvLoginErr" class="err">Driver ID zorunlu.</div>
    <div style="height:12px"></div>
    <div id="drvLoginBtn" style="background:var(--y);color:#000;border-radius:14px;padding:12px;text-align:center;font-weight:900;cursor:pointer">Gƒ∞Rƒ∞≈û YAP</div>
    <div style="height:10px"></div>
    <div class="small">Giri≈ü sonrasƒ± driver ekranƒ±na y√∂nlendirilirsin.</div>
  </div>
</div>

<script>
/* ============ CONFIG ============ */
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";

/* ============ STATE ============ */
let map, fromM=null, toM=null;
let service=null;
let registered=false;
let customer=null;
let pendingService=null;
let lastKM=0;
let lastPrice=0;

const $ = (id)=>document.getElementById(id);

/* ============ INIT ============ */
document.addEventListener("DOMContentLoaded", ()=>{
  $("startBtn").addEventListener("click", start);

  $("svcTaxi").addEventListener("click", ()=>pickService("taxi"));
  $("svcCourier").addEventListener("click", ()=>pickService("courier"));

  $("callBtn").addEventListener("click", callDriver);

  // drawer
  $("burgerBtn").addEventListener("click", openDrawer);
  $("drawerClose").addEventListener("click", closeDrawer);
  $("menuDriverApply").addEventListener("click", ()=>{ closeDrawer(); openDriverApply(); });
  $("menuDriverLogin").addEventListener("click", ()=>{ closeDrawer(); openDriverLogin(); });

  // side driver
  $("sideDriverApply").addEventListener("click", openDriverApply);
  $("sideDriverLogin").addEventListener("click", openDriverLogin);

  // modals close
  $("regClose").addEventListener("click", ()=>showModal("regModal", false));
  $("drvApplyClose").addEventListener("click", ()=>showModal("drvApplyModal", false));
  $("drvLoginClose").addEventListener("click", ()=>showModal("drvLoginModal", false));

  // register
  $("regOkBtn").addEventListener("click", saveCustomer);

  // driver apply/login
  $("drvApplyBtn").addEventListener("click", submitDriverApply);
  $("drvLoginBtn").addEventListener("click", submitDriverLogin);

  // load stored customer
  const cRaw = localStorage.getItem("st_customer");
  if(cRaw){
    try{
      const c = JSON.parse(cRaw);
      if(c && c.first && c.last && /^05\\d{9}$/.test(c.phone)){
        customer = c; registered = true;
      }
    }catch(_){}
  }

  syncCTA();
});

/* ============ UI ============ */
function start(){
  $("landing").style.display="none";
  $("app").style.display="block";
  initMap();
  syncCTA();
}

function lockApp(on){
  if(on) $("app").classList.add("app-locked");
  else $("app").classList.remove("app-locked");
}

function showModal(id, on){
  $(id).style.display = on ? "flex" : "none";
  lockApp(on);
}

function openRegister(){
  $("regErr").style.display="none";
  showModal("regModal", true);
}
function openDrawer(){ $("drawer").classList.add("open"); }
function closeDrawer(){ $("drawer").classList.remove("open"); }

/* CTA text/hint */
function syncCTA(){
  let text = "Hƒ∞ZMET SE√á";
  if(service==="taxi") text = "TAKSƒ∞ √áAƒûIR";
  if(service==="courier") text = "KURYE √áAƒûIR";
  $("callBtn").textContent = text;

  if(!registered){
    $("callHint").textContent = "Hizmet se√ßmek i√ßin kayƒ±t zorunludur.";
    return;
  }
  if(!service){
    $("callHint").textContent = "√ñnce hizmet se√ß.";
    return;
  }
  if(!toM){
    $("callHint").textContent = "Haritadan ‚ÄúNereye‚Äù se√ßmeden √ßaƒürƒ± olu≈üturulmaz.";
    return;
  }
  $("callHint").textContent = "Hazƒ±r. √áaƒürƒ± olu≈üturabilirsin.";
}

function setServiceUI(){
  const taxi = $("svcTaxi");
  const cr = $("svcCourier");
  taxi.classList.toggle("active", service==="taxi");
  cr.classList.toggle("active", service==="courier");

  // diƒüerini pasif yap
  taxi.classList.toggle("disabled", service==="courier");
  cr.classList.toggle("disabled", service==="taxi");

  $("courierBox").style.display = (service==="courier") ? "block" : "none";
}

/* ============ MAP ============ */
function initMap(){
  map = L.map("map").setView([40.99,29.02], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      const lat=p.coords.latitude, lng=p.coords.longitude;
      fromM = L.marker([lat,lng]).addTo(map);
      map.setView([lat,lng], 15);
      reverse(lat,lng,$("fromAddr"));
      calc(); // from geldi, eƒüer to+service yoksa zaten hesaplamaz
    }, _=>{
      $("fromAddr").placeholder="Konum alƒ±namadƒ±";
    }, { enableHighAccuracy:true, timeout:12000 });
  }else{
    $("fromAddr").placeholder="Konum desteklenmiyor";
  }

  map.on("click", e=>{
    // to marker
    if(!toM) toM = L.marker(e.latlng).addTo(map);
    else toM.setLatLng(e.latlng);

    reverse(e.latlng.lat, e.latlng.lng, $("toAddr"));
    calc();
    syncCTA();
  });
}

/* ============ REGISTER ============ */
function saveCustomer(){
  const first = $("cFirst").value.trim();
  const last  = $("cLast").value.trim();
  const phone = $("cPhone").value.replace(/\\D/g,"");
  const kvkk  = $("kvkk").checked;

  const ok =
    first.length >= 2 &&
    last.length  >= 2 &&
    /^05\\d{9}$/.test(phone) &&
    kvkk;

  if(!ok){
    $("regErr").style.display = "block";
    return;
  }

  customer = { first, last, phone };
  registered = true;
  localStorage.setItem("st_customer", JSON.stringify(customer));

  $("regErr").style.display = "none";
  showModal("regModal", false);

  if(pendingService){
    const s = pendingService;
    pendingService = null;
    pickService(s, true);
  }else{
    syncCTA();
  }
}

/* ============ SERVICE ============ */
function pickService(t, skipRegisterCheck=false){
  if(!registered && !skipRegisterCheck){
    pendingService = t;
    openRegister();
    return;
  }

  service = t;
  setServiceUI();

  // servis deƒüi≈üince hesap deƒüerleri tazelensin
  calc();
  syncCTA();
}

/* ============ CALC ============ */
function calc(){
  if(!service || !fromM || !toM){
    $("dist").textContent="‚Äî";
    $("price").textContent="‚Äî";
    lastKM=0; lastPrice=0;
    return;
  }

  const a = fromM.getLatLng();
  const b = toM.getLatLng();
  const km = haversine(a.lat, a.lng, b.lat, b.lng);

  lastKM = Number(km.toFixed(2));

  let price;
  if(service==="taxi"){
    price = Math.round(Math.max(120, 60 + km*22));
  }else{
    price = Math.round(Math.max(80, 40 + km*15));
  }
  lastPrice = price;

  $("dist").textContent = lastKM.toFixed(2) + " km";
  $("price").textContent = price + " TL";
}

/* ============ CALL DRIVER (createJob -> track) ============ */
async function callDriver(){
  if(!registered){ openRegister(); return; }
  if(!service){ toast("√ñnce hizmet se√ß."); return; }
  if(!fromM){ toast("Konum alƒ±namadƒ±."); return; }
  if(!toM){ toast("Haritadan ‚ÄòNereye‚Äô se√ß."); return; }

  if(service==="courier"){
    const pkg = $("pkgType").value.trim();
    const rn  = $("recvName").value.trim();
    const rp  = $("recvPhone").value.replace(/\\D/g,"");
    if(pkg.length<2 || rn.length<2 || !/^05\\d{9}$/.test(rp)){
      toast("Kurye i√ßin paket/alƒ±cƒ± bilgileri zorunlu.");
      return;
    }
  }

  const a = fromM.getLatLng();
  const b = toM.getLatLng();

  // CORS workaround: client job_id √ºretir
  const job_id = genJobId();

  const payload = {
    action: "createJob",
    job_id,
    service_type: service,
    from_addr: $("fromAddr").value || "",
    to_addr: $("toAddr").value || "",
    from_lat: a.lat, from_lng: a.lng,
    to_lat: b.lat,   to_lng: b.lng,
    distance_km: Number(lastKM || 0),
    price_brut: Number(lastPrice || 0),
    customer: {
      first: customer.first,
      last: customer.last,
      phone: customer.phone
    },
    courier: (service==="courier") ? {
      pkg_type: $("pkgType").value.trim(),
      recv_name: $("recvName").value.trim(),
      recv_phone: $("recvPhone").value.replace(/\\D/g,""),
      content_note: $("contentNote").value.trim()
    } : {}
  };

  $("callBtn").textContent = "G√ñNDERƒ∞Lƒ∞YOR...";
  $("callBtn").style.pointerEvents = "none";

  try{
    // no-cors => response okunmaz, ama request gider
    await fetch(BACKEND_URL, {
      method:"POST",
      mode:"no-cors",
      headers:{ "Content-Type":"text/plain;charset=UTF-8" },
      body: JSON.stringify(payload)
    });

    // Track‚Äôe ge√ß (job_id bizde)
    window.location.href = `track.html?job_id=${encodeURIComponent(job_id)}`;
  }catch(e){
    console.error(e);
    toast("Backend eri≈üimi ba≈üarƒ±sƒ±z. Deploy ayarƒ±nƒ± kontrol et.");
  }finally{
    $("callBtn").style.pointerEvents = "auto";
    syncCTA();
  }
}

/* ============ DRIVER APPLY / LOGIN ============ */
function openDriverApply(){
  $("drvApplyErr").style.display="none";
  $("drvApplyDone").style.display="none";
  showModal("drvApplyModal", true);
}
function openDriverLogin(){
  $("drvLoginErr").style.display="none";
  showModal("drvLoginModal", true);
}
function genDriverId(){
  const s = Math.random().toString(36).toUpperCase().slice(2,8);
  return "DRV-" + s;
}
async function submitDriverApply(){
  const name = $("dName").value.trim();
  const phone = $("dPhone").value.replace(/\\D/g,"");
  const vehicle = $("dVehicle").value.trim();

  if(name.length<3 || !/^05\\d{9}$/.test(phone) || vehicle.length<2){
    $("drvApplyErr").style.display="block";
    return;
  }

  $("drvApplyErr").style.display="none";
  const driver_id = genDriverId();

  try{
    await fetch(BACKEND_URL, {
      method:"POST",
      mode:"no-cors",
      headers:{ "Content-Type":"text/plain;charset=UTF-8" },
      body: JSON.stringify({
        action:"upsertDriver",
        driver_id,
        name,
        phone,
        vehicle,
        approved:"true"
      })
    });

    localStorage.setItem("st_driver_id", driver_id);
    $("drvApplyDone").style.display="block";
    $("drvApplyDone").textContent = `Ba≈üvuru alƒ±ndƒ±. Driver ID: ${driver_id}`;
  }catch(e){
    console.error(e);
    $("drvApplyErr").style.display="block";
  }
}

function submitDriverLogin(){
  const id = $("dLoginId").value.trim().toUpperCase();
  if(!id || !/^DRV-/.test(id)){
    $("drvLoginErr").style.display="block";
    return;
  }
  localStorage.setItem("st_driver_id", id);
  showModal("drvLoginModal", false);
  window.location.href = "driver.html";
}

/* ============ HELPERS ============ */
function genJobId(){
  const s = Math.random().toString(36).toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,10);
  return "JOB-" + s.padEnd(10,"X");
}

function haversine(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2 +
    Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180) *
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function reverse(lat,lng,input){
  fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}`)
    .then(r=>r.json())
    .then(d=>{ if(d && d.display_name) input.value = d.display_name; })
    .catch(_=>{});
}

function toast(msg){
  $("callHint").textContent = msg;
  setTimeout(()=>{ syncCTA(); }, 2400);
}
</script>

</body>
</html>
