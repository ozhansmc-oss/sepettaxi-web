<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SepetTaxi â€“ Taksi Ã‡aÄŸÄ±r</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0b1220;color:#fff}
header{padding:12px;background:#111c33;font-weight:bold}
.card{margin:12px;padding:12px;background:#111c33;border-radius:10px}
button{padding:10px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-weight:bold}
input{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:none}
#map{height:50vh;border-radius:10px}
</style>
</head>

<body>
<header>ğŸš• SepetTaxi â€“ Taksi</header>

<div class="card">
  <h3>KayÄ±t</h3>
  <input id="name" placeholder="Ad Soyad">
  <input id="phone" placeholder="Telefon (05xxxxxxxxx)">
  <button onclick="saveUser()">Kaydet</button>
</div>

<div class="card">
  <h3>Konum</h3>
  <button onclick="getGPS()">ğŸ“ GPS AlÄ±ÅŸ</button>
  <button onclick="pickMode='pickup'">ğŸŸ¢ Haritadan AlÄ±ÅŸ</button>
  <button onclick="pickMode='dropoff'">ğŸ”´ Haritadan VarÄ±ÅŸ</button>
  <div id="map"></div>
</div>

<div class="card">
  <h3>Ãœcret</h3>
  Mesafe: <span id="km">-</span> km<br>
  Net Fiyat: <b><span id="price">-</span> TL</b><br><br>
  <button onclick="calc()">Net Fiyat Hesapla</button>
</div>

<div class="card">
  <button onclick="createJob()">ğŸš• Taksi Ã‡aÄŸÄ±r</button>
  <div id="status"></div>
</div>

<script>
const API="https://script.google.com/macros/s/AKfycbw_5YZ423wGwaZ6bu3F0a_oxrX_i_ycLS9-DQb0lRDcVCTOwvIGWFKpIPaWVAxVP9jx/exec";
let map=L.map('map').setView([40.195,29.060],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let pickup=null, dropoff=null, pickMode=null, km=0, price=0;

map.on('click',e=>{
 if(!pickMode) return;
 if(pickMode==='pickup'){pickup=e.latlng;L.marker(e.latlng).addTo(map).bindPopup("AlÄ±ÅŸ").openPopup();}
 if(pickMode==='dropoff'){dropoff=e.latlng;L.marker(e.latlng).addTo(map).bindPopup("VarÄ±ÅŸ").openPopup();}
 pickMode=null;
});

function getGPS(){
 navigator.geolocation.getCurrentPosition(p=>{
  pickup={lat:p.coords.latitude,lng:p.coords.longitude};
  L.marker([pickup.lat,pickup.lng]).addTo(map).bindPopup("AlÄ±ÅŸ (GPS)").openPopup();
 });
}

function dist(a,b){
 const R=6371,dLat=(b.lat-a.lat)*Math.PI/180,dLon=(b.lng-a.lng)*Math.PI/180;
 const x=Math.sin(dLat/2)**2+Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*Math.sin(dLon/2)**2;
 return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

function calc(){
 if(!pickup||!dropoff){alert("Konum seÃ§");return;}
 km=dist(pickup,dropoff);
 price=Math.round(60+km*18);
 document.getElementById("km").innerText=km.toFixed(2);
 document.getElementById("price").innerText=price;
}

function saveUser(){
 localStorage.setItem("user",JSON.stringify({
  name:name.value, phone:phone.value
 }));
 alert("Kaydedildi");
}

function createJob(){
 const u=JSON.parse(localStorage.getItem("user"));
 if(!u||!price){alert("Eksik");return;}
 fetch(API,{
  method:"POST",
  body:JSON.stringify({
   action:"createJob",
   service_type:"taxi",
   customer_type:"individual",
   user_name:u.name,
   user_phone:u.phone,
   pickup_lat:pickup.lat,
   pickup_lng:pickup.lng,
   dropoff_lat:dropoff.lat,
   dropoff_lng:dropoff.lng,
   net_price:price
  })
 }).then(()=>status.innerText="JOB oluÅŸturuldu");
}
</script>
</body>
</html>
