<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#f5c400">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="config.js"></script>
<script src="log.js"></script>

<style>
*{box-sizing:border-box}
:root{
  --y:#f5c400;
  --bg:#000;
  --panel:#0f0f10;
  --line:rgba(255,255,255,.12);
  --mut:rgba(255,255,255,.6);
  --r:18px;
}
html,body{
  margin:0;height:100%;
  background:#000;color:#fff;
  font-family:Arial,Helvetica,sans-serif;
  overflow:hidden
}

/* LANDING */
#landing{
  position:fixed;inset:0;z-index:9999;
  background:#000 url("assets/landing.png") center/cover no-repeat;
}
#landingTap{
  position:absolute;inset:0;
  display:flex;align-items:flex-end;justify-content:center;
  padding:24px;
}
#landingTap div{
  width:64px;height:64px;border-radius:50%;
  border:1px solid rgba(255,255,255,.3);
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.45)
}
#landingTap div:after{
  content:"";
  border-left:14px solid var(--y);
  border-top:10px solid transparent;
  border-bottom:10px solid transparent;
  margin-left:4px;
}

/* APP */
#app{display:none;height:100%}
#mapWrap{height:50vh;position:relative}
#map{height:100%;width:100%}

/* TOPBAR */
#topbar{
  position:absolute;top:0;left:0;right:0;height:60px;
  display:flex;align-items:center;
  padding:0 14px;
  background:linear-gradient(180deg,rgba(0,0,0,.85),rgba(0,0,0,.15));
  z-index:500
}
#burger{
  width:44px;height:44px;border-radius:14px;
  background:rgba(255,255,255,.08);
  border:1px solid var(--line);
  color:#fff;font-size:20px
}
#logo{
  position:absolute;left:50%;transform:translateX(-50%);
  font-weight:900;font-size:22px
}
#logo span{color:var(--y)}
#miniDriver{
  margin-left:auto;
  padding:0 12px;height:44px;border-radius:14px;
  border:1px solid rgba(245,196,0,.3);
  display:flex;align-items:center;gap:8px;
  cursor:pointer
}
#miniDriver b{font-size:13px}

/* MAP CONTROLS */
#mapControls{
  position:absolute;right:12px;top:80px;
  display:flex;flex-direction:column;gap:12px;
  z-index:400
}
.mapCtl{
  width:52px;height:52px;border-radius:16px;
  background:rgba(0,0,0,.55);
  border:1px solid var(--line);
  color:#fff;font-size:20px
}
.mapCtl.on{border-color:var(--y)}

/* PANEL */
#panel{
  height:50vh;
  padding:14px;
  background:#050506;
  overflow:auto
}

/* SERVICES */
#svcRow{display:flex;gap:12px}
.svc{
  flex:1;
  min-height:76px;
  border-radius:18px;
  border:1px solid var(--line);
  display:flex;align-items:center;gap:12px;
  padding:12px;
  cursor:pointer
}
.svc.active{border-color:var(--y)}
.svc img{width:48px;height:48px}
.svc b{font-size:18px}
.svc small{display:block;color:var(--mut);font-size:12px}

/* ADDRESS */
.addrBox{
  margin-top:12px;
  border-radius:18px;
  border:1px solid var(--line);
}
.addrRow{
  display:flex;align-items:center;gap:10px;
  padding:12px
}
.addrRow + .addrRow{border-top:1px solid var(--line)}
.addrRow span{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* STATS */
#stats{display:flex;gap:12px;margin-top:12px}
.stat{
  flex:1;border-radius:18px;
  border:1px solid var(--line);
  padding:12px
}
.stat small{color:var(--mut)}
.stat b{display:block;font-size:24px;margin-top:6px}

/* CTA */
#cta{
  margin-top:14px;
  height:64px;border-radius:999px;
  background:linear-gradient(180deg,#ffdf6a,var(--y));
  color:#000;font-size:24px;font-weight:900;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer
}
#cta.disabled{
  background:rgba(255,255,255,.12);
  color:rgba(255,255,255,.5);
  cursor:not-allowed
}

/* MODALS */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.75);
  display:none;align-items:center;justify-content:center;
  z-index:1000
}
.box{
  width:100%;max-width:420px;
  background:#111;border-radius:18px;
  padding:16px
}
.box h3{margin:0 0 10px}
.box input{
  width:100%;padding:12px;
  border-radius:14px;border:1px solid var(--line);
  background:#000;color:#fff;margin-top:8px
}
.box button{
  width:100%;margin-top:12px;
  padding:14px;border-radius:14px;
  background:var(--y);color:#000;font-weight:900
}
.err{display:none;color:#ff6b6b;font-size:12px;margin-top:8px}
</style>
</head>

<body>

<!-- LANDING -->
<div id="landing">
  <div id="landingTap"><div></div></div>
</div>

<!-- APP -->
<div id="app">
  <div id="mapWrap">
    <div id="map"></div>

    <div id="topbar">
      <button id="burger">☰</button>
      <div id="logo">Sepet<span>Taxi</span></div>
      <div id="miniDriver"><b>Sürücü Ol</b></div>
    </div>

    <div id="mapControls">
      <button id="btnLocate" class="mapCtl">⌖</button>
      <button id="btnPick" class="mapCtl">✎</button>
    </div>
  </div>

  <div id="panel">
    <div id="svcRow">
      <div class="svc active" id="svcTaxi">
        <img src="https://maps.gstatic.com/mapfiles/ms2/micons/yellow-dot.png">
        <div><b>Taksi</b><small>Hızlı ulaşım</small></div>
      </div>
      <div class="svc" id="svcCourier">
        <img src="https://maps.gstatic.com/mapfiles/ms2/micons/motorcycling.png">
        <div><b>Kurye</b><small>Hızlı teslimat</small></div>
      </div>
    </div>

    <div class="addrBox">
      <div class="addrRow"><span id="fromTxt">Konum alınıyor…</span></div>
      <div class="addrRow"><span id="toTxt">Gideceğiniz yeri seçin</span></div>
    </div>

    <div id="stats">
      <div class="stat"><small>Mesafe</small><b id="kmVal">—</b></div>
      <div class="stat"><small>Ücret</small><b id="priceVal">—</b></div>
    </div>

    <div id="cta" class="disabled">Gideceğiniz yeri seçin</div>
  </div>
</div>

<!-- REGISTER -->
<div class="modal" id="regModal">
  <div class="box">
    <h3>Zorunlu Kayıt</h3>
    <input id="rName" placeholder="Ad Soyad">
    <input id="rPhone" placeholder="05XXXXXXXXX" maxlength="11">
    <div class="err" id="regErr">Bilgiler hatalı</div>
    <button id="regOk">Kaydı Tamamla</button>
  </div>
</div>

<script>
/* ===== STATE ===== */
let map, fromLL=null, toLL=null;
let service="taxi";
let registered=false, customer=null;
let km=0, price=0, pickMode=false;

/* ===== DOM ===== */
const $=i=>document.getElementById(i);

/* ===== INIT ===== */
$("landingTap").onclick=()=>{
  $("landing").style.display="none";
  $("app").style.display="block";
  initMap();
};

/* ===== MAP ===== */
function initMap(){
  map=L.map("map",{zoomControl:false});
  L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{maxZoom:19}).addTo(map);

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(p=>{
      fromLL={lat:p.coords.latitude,lng:p.coords.longitude};
      L.marker(fromLL).addTo(map);
      map.setView(fromLL,16);
      $("fromTxt").textContent="Mevcut Konum";
    });
  }

  map.on("click",e=>{
    if(!pickMode)return;
    toLL={lat:e.latlng.lat,lng:e.latlng.lng};
    L.marker(toLL).addTo(map);
    $("toTxt").textContent="Seçilen Konum";
    pickMode=false;
    calc();
    renderCTA();
  });
}

/* ===== SERVICE ===== */
$("svcTaxi").onclick=()=>setService("taxi");
$("svcCourier").onclick=()=>setService("courier");

function setService(s){
  service=s;
  $("svcTaxi").classList.toggle("active",s==="taxi");
  $("svcCourier").classList.toggle("active",s==="courier");
  renderCTA();
}

/* ===== CONTROLS ===== */
$("btnLocate").onclick=()=>{ if(fromLL) map.setView(fromLL,16); };
$("btnPick").onclick=()=>{ pickMode=!pickMode; };

/* ===== CALC ===== */
function hav(a,b,c,d){
  const R=6371;
  const dLat=(c-a)*Math.PI/180;
  const dLon=(d-b)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function calc(){
  if(!fromLL||!toLL){km=price=0;return;}
  km=hav(fromLL.lat,fromLL.lng,toLL.lat,toLL.lng);
  price=service==="taxi"
    ? Math.max(120,60+km*22)
    : Math.max(80,40+km*15);
  $("kmVal").textContent=km.toFixed(1)+" km";
  $("priceVal").textContent=Math.round(price)+" TL";
}

/* ===== CTA ===== */
function renderCTA(){
  const c=$("cta");
  if(!registered){
    c.textContent="Kayıt Ol";
    c.classList.remove("disabled");
    return;
  }
  if(!toLL){
    c.textContent="Gideceğiniz yeri seçin";
    c.classList.add("disabled");
    return;
  }
  c.textContent=service==="taxi"?"Taksi Çağır":"Kurye Detayları";
  c.classList.remove("disabled");
}

$("cta").onclick=()=>{
  if($("cta").classList.contains("disabled"))return;
  if(!registered){ $("regModal").style.display="flex"; return; }
  if(service==="courier"){
    localStorage.setItem("st_temp_route",JSON.stringify({from:fromLL,to:toLL,km,price}));
    location.href="courier.html";
    return;
  }
  alert("Taksi çağrıldı (backend bağlantılı)");
};

/* ===== REGISTER ===== */
$("regOk").onclick=()=>{
  const n=$("rName").value.trim();
  const p=$("rPhone").value.trim();
  if(n.length<3||!/^05\d{9}$/.test(p)){
    $("regErr").style.display="block";return;
  }
  customer={n,p};
  registered=true;
  $("regModal").style.display="none";
  renderCTA();
};
</script>
</body>
</html>
