<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;
  height:100%;
  font-family:Arial,Helvetica,sans-serif;
  background:#000;
  color:#fff;
  overflow:hidden;
}

/* MAP â€“ ZEMÄ°N */
#map{
  position:fixed;
  inset:0;
  z-index:1;
}

/* TOP BAR */
#topBar{
  position:fixed;
  top:0;left:0;right:0;
  height:64px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:900;
  background:linear-gradient(rgba(0,0,0,.85),rgba(0,0,0,.35));
  z-index:10;
}
#topBar span{color:#f5c400}

/* PANEL */
#panel{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:110px;
  width:94%;
  max-width:420px;
  background:#0f0f0f;
  border-radius:22px;
  padding:14px;
  z-index:10;
}

/* SERVICES */
.services{
  display:flex;
  gap:10px;
}
.service{
  flex:1;
  padding:14px;
  border-radius:14px;
  text-align:center;
  font-weight:900;
  background:#151515;
  border:2px solid #222;
  cursor:pointer;
}
.service.active{
  border-color:#f5c400;
  color:#f5c400;
}

/* INPUT */
input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:0;
  background:#1b1b1b;
  color:#fff;
  margin-top:10px;
}

/* CALL */
#callBtn{
  margin-top:12px;
  width:100%;
  padding:18px;
  border-radius:18px;
  border:0;
  background:#f5c400;
  color:#000;
  font-size:18px;
  font-weight:900;
}

/* DRIVER CTA */
#driverCta{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:24px;
  width:94%;
  max-width:420px;
  padding:22px;
  border-radius:22px;
  background:#141414;
  border:2px dashed #333;
  text-align:center;
  font-size:18px;
  font-weight:900;
  z-index:10;
}
#driverCta span{color:#f5c400}

/* REGISTER MODAL */
#register{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:99;
}
.regBox{
  width:90%;
  max-width:360px;
  background:#111;
  border-radius:20px;
  padding:18px;
}
.regBox input{margin-top:10px}
.regBox label{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:13px;
  color:#aaa;
  margin-top:10px;
}
.regBox button{
  margin-top:16px;
  width:100%;
  padding:16px;
  border-radius:14px;
  border:0;
  background:#f5c400;
  color:#000;
  font-weight:900;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="topBar">Sepet<span>Taxi</span></div>

<div id="panel">
  <div class="services">
    <div class="service active" onclick="selectService('taxi',this)">ðŸš• Taksi</div>
    <div class="service" onclick="selectService('courier',this)">ðŸ“¦ Kurye</div>
  </div>

  <input id="fromAddr" placeholder="Nereden (haritaya dokun)">
  <input id="toAddr" placeholder="Nereye (haritaya dokun)">

  <button id="callBtn" onclick="callFlow()">Ã‡AÄžIR</button>
</div>

<div id="driverCta" onclick="location.href='driver_apply.html'">
  ðŸš— <span>SÃ¼rÃ¼cÃ¼ Ol</span> â€“ Hemen BaÅŸvur
</div>

<!-- REGISTER -->
<div id="register">
  <div class="regBox">
    <input id="ad" placeholder="Ad">
    <input id="soyad" placeholder="Soyad">
    <input id="tel" placeholder="05XXXXXXXXX">
    <label><input type="checkbox" id="kvkk"> KVKK kabul</label>
    <button onclick="saveUser()">KAYDI TAMAMLA</button>
  </div>
</div>

<script>
/* BACKEND */
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

/* MAP */
const map=L.map("map").setView([40.195,29.060],14);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let fromM=null,toM=null,step="from";
map.on("click",e=>{
  if(step==="from"){
    if(fromM) map.removeLayer(fromM);
    fromM=L.marker(e.latlng).addTo(map);
    fromAddr.value="SeÃ§ildi";
    step="to";
  }else{
    if(toM) map.removeLayer(toM);
    toM=L.marker(e.latlng).addTo(map);
    toAddr.value="SeÃ§ildi";
  }
});

let service="taxi",registered=false,user={};

function selectService(s,el){
  service=s;
  document.querySelectorAll(".service").forEach(x=>x.classList.remove("active"));
  el.classList.add("active");
}

function callFlow(){
  if(!fromM||!toM) return alert("Adres seÃ§");
  if(!registered){
    register.style.display="flex";
  }else{
    createJob();
  }
}

function saveUser(){
  if(!ad.value||!soyad.value||!/^05\d{9}$/.test(tel.value)||!kvkk.checked)
    return alert("Bilgileri kontrol et");

  user={ad:ad.value,soyad:soyad.value,tel:tel.value};
  registered=true;
  register.style.display="none";
  createJob();
}

async function createJob(){
  const r=await fetch(BACKEND_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"createJob",
      service_type:service,
      customer_first:user.ad,
      customer_last:user.soyad,
      customer_phone:user.tel,
      from_lat:fromM.getLatLng().lat,
      from_lng:fromM.getLatLng().lng,
      to_lat:toM.getLatLng().lat,
      to_lng:toM.getLatLng().lng
    })
  });
  const d=await r.json();
  location.href=`track.html?job_id=${d.job_id}&token=${d.track_token}`;
}
</script>

</body>
</html>
