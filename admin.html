<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SepetTaxi – Admin</title>

<style>
:root{
  --bg:#0b0b0b; --card:#151515; --border:rgba(255,255,255,.12);
  --text:#fff; --muted:#a8a8a8; --ok:#7CFF9B; --err:#FF7C7C;
}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
.container{max-width:980px;margin:0 auto;padding:20px}
.card{background:var(--card);border-radius:18px;padding:20px;margin-bottom:16px;
  box-shadow:0 0 0 1px var(--border) inset}
h1{margin:0 0 6px;font-size:22px}
h2{margin:0 0 10px;font-size:18px}
.badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px}
.ok{color:var(--ok)} .err{color:var(--err)}
select,button{width:100%;padding:14px;border-radius:14px;border:1px solid var(--border);
  background:#0f0f0f;color:#fff;font-size:15px}
button{background:#fff;color:#000;font-weight:700;border:none;margin-top:10px;cursor:pointer}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.job{border:1px solid var(--border);border-radius:14px;padding:14px;margin-top:10px}
</style>
</head>

<body>
<div class="container">

<div class="card">
  <h1>SepetTaxi – Admin Paneli</h1>
  <span class="badge" id="backend">Backend kontrol ediliyor…</span>
</div>

<div class="card">
  <h2>1) İş Seç</h2>
  <select id="jobSelect"></select>
</div>

<div class="card">
  <h2>2) Sürücü Seç</h2>
  <select id="driverSelect"></select>
</div>

<div class="card">
  <h2>3) Ata</h2>
  <button onclick="assign()">Sürücüye Ata</button>
  <div id="msg"></div>
</div>

<div class="card">
  <h2>Bekleyen İşler</h2>
  <div id="jobsBox">Yükleniyor…</div>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE =
"https://script.google.com/macros/s/AKfycbw_hDjwwc8cO3qHE_y7znohPf_4agoogg_FUD96MWvpGI4GF3tUEp54klAFOIfLZegD/exec";

/* ================= HELPERS ================= */
async function get(params){
  const u = new URL(API_BASE);
  Object.keys(params).forEach(k=>u.searchParams.set(k,params[k]));
  const r = await fetch(u.toString());
  return await r.json();
}
async function post(action, body){
  const r = await fetch(`${API_BASE}?action=${action}`,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  return await r.json();
}

/* ================= PING ================= */
(async()=>{
  const b = document.getElementById("backend");
  try{
    const r = await get({action:"ping"});
    if(r.ok){ b.textContent="Backend bağlı"; b.classList.add("ok"); }
    else throw "";
  }catch{
    b.textContent="Backend yok"; b.classList.add("err");
  }
})();

/* ================= LOAD DATA ================= */
async function load(){
  await loadJobs();
  await loadDrivers();
}
load();

async function loadJobs(){
  const box = document.getElementById("jobsBox");
  const sel = document.getElementById("jobSelect");
  box.innerHTML = "Yükleniyor…";
  sel.innerHTML = "";

  const r = await get({action:"listJobs"});
  if(!r.ok || !r.jobs || r.jobs.length===0){
    box.textContent="İş yok"; return;
  }

  const pending = r.jobs.filter(j=>j.status==="pending");
  if(pending.length===0){ box.textContent="Bekleyen iş yok"; return; }

  box.innerHTML="";
  pending.forEach(j=>{
    const d=document.createElement("div");
    d.className="job";
    d.innerHTML=`<b>${j.job_id}</b> – ${j.service_type} – ${j.pickup_address} → ${j.dropoff_address}`;
    box.appendChild(d);

    const o=document.createElement("option");
    o.value=j.job_id;
    o.textContent=`${j.job_id} (${j.service_type})`;
    sel.appendChild(o);
  });
}

async function loadDrivers(){
  const sel=document.getElementById("driverSelect");
  sel.innerHTML="";
  const r = await get({action:"listDrivers"});
  if(!r.ok || !r.drivers) return;

  r.drivers.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.driver_id;
    o.textContent=`${d.driver_id} – ${d.name||""}`;
    sel.appendChild(o);
  });
}

/* ================= ASSIGN ================= */
async function assign(){
  const msg=document.getElementById("msg");
  msg.textContent="";
  const job_id=document.getElementById("jobSelect").value;
  const driver_id=document.getElementById("driverSelect").value;
  if(!job_id||!driver_id){
    msg.innerHTML=`<div class="err">İş ve sürücü seç</div>`; return;
  }
  const r = await post("assignJob",{job_id,driver_id});
  if(r.ok){
    msg.innerHTML=`<div class="ok">Atandı</div>`;
    load();
  }else{
    msg.innerHTML=`<div class="err">${r.error||"Hata"}</div>`;
  }
}
</script>
</body>
</html>
