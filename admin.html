<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Admin</title>
<meta name="theme-color" content="#050506">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:system-ui,Arial}
body{overflow:hidden}

:root{
  --y:#f5c400;
  --line:rgba(255,255,255,.1);
  --card:#141416;
}

.top{
  height:56px;
  display:flex;align-items:center;justify-content:center;
  border-bottom:1px solid var(--line);
  background:#0f0f10;
  font-weight:900;
}
.top span{color:var(--y)}

.main{
  height:calc(100vh - 56px);
  overflow-y:auto;
  padding:12px;
}

.card{
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
  margin-bottom:12px;
  background:#0f0f10;
}

input,button,select{
  width:100%;
  height:44px;
  border-radius:12px;
  border:1px solid var(--line);
  background:var(--card);
  color:#fff;
  margin-bottom:10px;
  padding:0 12px;
  font-weight:800;
}

button.primary{
  background:var(--y);
  color:#111;
}

.job{
  border:1px solid rgba(245,196,0,.3);
  background:rgba(245,196,0,.1);
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.job b{color:var(--y)}
.small{font-size:12px;opacity:.75}
</style>
</head>

<body>
<div class="top">Sepet<span>Taxi</span> • Admin</div>

<div class="main">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h3>Admin Giriş</h3>
    <input id="adminPin" placeholder="Admin PIN">
    <button id="btnLogin" class="primary">Giriş</button>
  </div>

  <!-- PANEL -->
  <div id="panel" style="display:none">

    <div class="card">
      <h3>Canlı İşler</h3>
      <button id="btnRefresh">Yenile</button>
    </div>

    <div id="jobs"></div>

  </div>

</div>

<script>
/* BACKEND */
const API="https://script.google.com/macros/s/AKfycbwAKdSbXtKupy7Bp0gRIrB68bScvIvVjpSPFUYrDf6marNE43qm_DEHO_dPdTTroIDC/exec";

/* JSONP */
function apiJSONP(p){
  return new Promise((res,rej)=>{
    const cb="cb_"+Math.random().toString(16).slice(2);
    p.callback=cb;
    window[cb]=(d)=>{res(d);delete window[cb];s.remove();}
    const s=document.createElement("script");
    s.src=API+(API.includes("?")?"&":"?")+new URLSearchParams(p);
    s.onerror=()=>{delete window[cb];s.remove();rej();}
    document.head.appendChild(s);
  });
}

/* STATE */
let admin=null;

/* STORAGE */
function saveAdmin(a){ localStorage.setItem("sepettaxi_admin", JSON.stringify(a)); }
function loadAdmin(){
  try{ return JSON.parse(localStorage.getItem("sepettaxi_admin")); }
  catch(_){ return null; }
}
function clearAdmin(){ localStorage.removeItem("sepettaxi_admin"); }

/* LOGIN */
btnLogin.onclick=()=>{
  const pin=adminPin.value.trim();
  if(pin.length<3){ alert("PIN gir"); return; }

  apiJSONP({ action:"adminLogin", pin })
    .then(r=>{
      if(!r.ok){ alert("Giriş başarısız"); return; }
      admin={ admin_id:r.data.admin_id, token:r.data.token };
      saveAdmin(admin);
      initAdmin();
    });
};

/* INIT */
function initAdmin(){
  loginCard.style.display="none";
  panel.style.display="block";
  refreshJobs();
}

/* JOBS */
btnRefresh.onclick=refreshJobs;

function refreshJobs(){
  apiJSONP({ action:"listOpenJobs" })
    .then(r=>{
      if(!r.ok){ jobs.innerHTML="Hata"; return; }
      jobs.innerHTML="";
      r.data.jobs.forEach(j=>{
        const d=document.createElement("div");
        d.className="job";
        d.innerHTML=`
          <div><b>${j.service_type}</b> • ${j.status}</div>
          <div class="small">${j.from_address || ""}</div>
          <div class="small">${j.to_address || ""}</div>
          <input placeholder="Sürücü ID" id="drv_${j.job_id}">
          <button>Manuel Ata</button>
        `;
        d.querySelector("button").onclick=()=>{
          const driver_id=d.querySelector("input").value.trim();
          if(!driver_id) return alert("Sürücü ID gir");
          assign(j.job_id, driver_id);
        };
        jobs.appendChild(d);
      });
    });
}

function assign(job_id, driver_id){
  apiJSONP({
    action:"adminAssign",
    admin_id:admin.admin_id,
    token:admin.token,
    job_id,
    driver_id
  }).then(r=>{
    if(r.ok){
      alert("Atandı");
      refreshJobs();
    }else{
      alert("Atama başarısız");
    }
  });
}

/* BOOT */
const saved=loadAdmin();
if(saved){
  admin=saved;
  initAdmin();
}
</script>
</body>
</html>
