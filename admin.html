<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi â€“ Admin</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}
.container{padding:12px}
.card{background:#111;border:1px solid #222;border-radius:14px;padding:12px;margin-bottom:10px}
.input,select{width:100%;padding:10px;border-radius:12px;border:1px solid #222;background:#000;color:#fff}
.btn{background:#f5c400;color:#000;border-radius:14px;padding:12px;font-weight:900;text-align:center;cursor:pointer}
.btn.secondary{background:#333;color:#fff}
.small{font-size:12px;color:#aaa}
.item{padding:10px;border-radius:12px;border:1px solid #222;background:#0f0f0f;margin-top:8px}
.row{display:flex;gap:8px;align-items:center}
.badge{padding:2px 8px;border:1px solid #333;border-radius:999px;font-size:12px}
.hidden{display:none}
.kpis{display:flex;gap:8px;margin-top:10px}
.kpi{flex:1;background:#0f0f0f;border:1px solid #222;border-radius:12px;padding:10px}
.kpi .t{font-size:11px;color:#aaa}
.kpi .v{font-size:18px;font-weight:900;margin-top:4px}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border-bottom:1px solid #222;padding:8px;font-size:13px;text-align:left}
th{color:#aaa;font-weight:900}
</style>
</head>
<body>

<header>Sepet<span>Taxi</span> â€“ Admin</header>

<div class="container">

  <!-- LOGIN -->
  <div id="login" class="card">
    <div class="small">Admin PIN</div>
    <input id="pin" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢">
    <div class="btn" style="margin-top:10px" onclick="doLogin()">GÄ°RÄ°Åž</div>
    <div class="small" id="loginErr" style="margin-top:8px;color:#ff5c5c"></div>
  </div>

  <!-- PANEL -->
  <div id="panel" class="hidden">

    <div class="card row">
      <div class="btn secondary" onclick="logout()">Ã‡IKIÅž</div>
      <div class="btn" onclick="reloadAll()">YENÄ°LE</div>
      <div class="small" id="exp"></div>
    </div>

    <!-- FINANCE DASHBOARD -->
    <div class="card">
      <div style="font-weight:900">ðŸ“Š Finans Dashboard</div>
      <div class="small" style="margin-top:6px">Filtrele ve raporu Ã¼ret.</div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="small">BaÅŸlangÄ±Ã§</div>
          <input id="fStart" class="input" type="date">
        </div>
        <div style="flex:1">
          <div class="small">BitiÅŸ</div>
          <input id="fEnd" class="input" type="date">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div style="flex:1">
          <div class="small">Periyot</div>
          <select id="fPeriod">
            <option value="day">GÃ¼n</option>
            <option value="month">Ay</option>
          </select>
        </div>
        <div style="flex:1">
          <div class="small">Hizmet</div>
          <select id="fService">
            <option value="">Hepsi</option>
            <option value="taxi">Taksi</option>
            <option value="courier">Kurye</option>
          </select>
        </div>
        <div style="flex:1">
          <div class="small">Status</div>
          <select id="fStatus">
            <option value="">Hepsi</option>
            <option value="completed">completed</option>
            <option value="assigned">assigned</option>
            <option value="searching">searching</option>
            <option value="picked">picked</option>
            <option value="arrived">arrived</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div class="btn" style="flex:1" onclick="loadFinance()">RAPORU GETÄ°R</div>
      </div>

      <div class="kpis" id="kpis" style="display:none">
        <div class="kpi"><div class="t">BrÃ¼t</div><div class="v" id="kBrut">â€”</div></div>
        <div class="kpi"><div class="t">Komisyon</div><div class="v" id="kCom">â€”</div></div>
        <div class="kpi"><div class="t">SÃ¼rÃ¼cÃ¼ Net</div><div class="v" id="kNet">â€”</div></div>
        <div class="kpi"><div class="t">Ä°ÅŸ Adedi</div><div class="v" id="kCnt">â€”</div></div>
      </div>

      <div id="svcTableWrap" style="display:none">
        <div class="small" style="margin-top:10px">Servis KÄ±rÄ±lÄ±mÄ±</div>
        <table>
          <thead><tr><th>Servis</th><th>BrÃ¼t</th><th>Komisyon</th><th>Net</th><th>Adet</th></tr></thead>
          <tbody id="svcRows"></tbody>
        </table>
      </div>

      <div id="periodTableWrap" style="display:none">
        <div class="small" style="margin-top:10px">Periyot KÄ±rÄ±lÄ±mÄ±</div>
        <table>
          <thead><tr><th>Periyot</th><th>BrÃ¼t</th><th>Komisyon</th><th>Net</th><th>Adet</th></tr></thead>
          <tbody id="periodRows"></tbody>
        </table>
      </div>

      <div class="small" id="financeErr" style="margin-top:10px;color:#ff5c5c"></div>
    </div>

    <!-- JOBS -->
    <div class="card">
      <div style="font-weight:900">Ä°ÅŸler</div>
      <div class="row" style="margin-top:10px">
        <input id="jLimit" class="input" value="50" placeholder="limit">
        <input id="jStatus" class="input" placeholder="status (opsiyonel)">
        <input id="jService" class="input" placeholder="service_type (opsiyonel)">
      </div>
      <div class="row" style="margin-top:10px">
        <div class="btn" style="flex:1" onclick="loadJobs()">Ä°ÅžLERÄ° GETÄ°R</div>
      </div>
      <div id="jobs"></div>
    </div>

    <!-- DRIVERS -->
    <div class="card">
      <div style="font-weight:900">SÃ¼rÃ¼cÃ¼ler</div>
      <div class="row" style="margin-top:10px">
        <div class="btn" style="flex:1" onclick="loadDrivers()">SÃœRÃœCÃœLERÄ° GETÄ°R</div>
      </div>
      <div id="drivers"></div>
    </div>

  </div>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";
const tokenKey="SEPET_ADMIN_TOKEN";
const expKey="SEPET_ADMIN_EXP";
const $=id=>document.getElementById(id);

function getToken(){ return localStorage.getItem(tokenKey)||""; }
function setToken(t,exp){ localStorage.setItem(tokenKey,t); localStorage.setItem(expKey,exp||""); }
function clearToken(){ localStorage.removeItem(tokenKey); localStorage.removeItem(expKey); }

function qs(o){
  const u=new URL(BACKEND_URL);
  Object.entries(o).forEach(([k,v])=>u.searchParams.set(k,v));
  return u.toString();
}

async function doLogin(){
  loginErr.textContent="";
  const p=pin.value.trim();
  if(!p){ loginErr.textContent="PIN gerekli"; return; }
  const r=await fetch(qs({action:"adminAuth",pin:p}));
  const j=await r.json().catch(()=>({}));
  if(!j.ok){ loginErr.textContent="HatalÄ± PIN"; return; }
  setToken(j.token, j.expires_at);
  await showPanel();
}

async function showPanel(){
  const t=getToken();
  if(!t) return;
  const ok=await fetch(qs({action:"adminCheck",token:t})).then(r=>r.json()).then(x=>x.ok).catch(()=>false);
  if(!ok){ logout(); return; }
  login.classList.add("hidden");
  panel.classList.remove("hidden");
  exp.textContent="Token expiry: "+(localStorage.getItem(expKey)||"");
  initFinanceDefaults();
  reloadAll();
}

function logout(){
  const t=getToken();
  fetch(BACKEND_URL,{method:"POST",body:JSON.stringify({action:"adminRevoke",token:t})}).catch(()=>{});
  clearToken();
  panel.classList.add("hidden");
  login.classList.remove("hidden");
}

function reloadAll(){
  loadJobs();
  loadDrivers();
  loadFinance();
}

/* ===== FINANCE ===== */
function initFinanceDefaults(){
  const today=new Date();
  const end = today.toISOString().slice(0,10);
  const start = new Date(Date.now()-30*24*3600*1000).toISOString().slice(0,10);
  if(!fEnd.value) fEnd.value=end;
  if(!fStart.value) fStart.value=start;
}

function fmtTL(n){ return (Math.round(Number(n)||0)).toLocaleString("tr-TR")+" TL"; }

async function loadFinance(){
  financeErr.textContent="";
  const t=getToken();
  const start=fStart.value || "";
  const end=fEnd.value || "";
  const period=fPeriod.value || "day";
  const service=fService.value || "";
  const status=fStatus.value || "";

  const u=qs({action:"getFinance",token:t,start,end,period,service_type:service,status});
  const j=await fetch(u).then(r=>r.json()).catch(()=>({ok:false,error:"fetch failed"}));
  if(!j.ok){
    financeErr.textContent=j.error||"Rapor alÄ±namadÄ±";
    return;
  }

  // KPIs
  kpis.style.display="flex";
  kBrut.textContent=fmtTL(j.totals.brut);
  kCom.textContent=fmtTL(j.totals.commission);
  kNet.textContent=fmtTL(j.totals.net);
  kCnt.textContent=(Number(j.totals.count)||0).toLocaleString("tr-TR");

  // By service
  svcTableWrap.style.display="block";
  svcRows.innerHTML="";
  (j.by_service||[]).forEach(s=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${s.service_type||"â€”"}</td><td>${fmtTL(s.brut)}</td><td>${fmtTL(s.commission)}</td><td>${fmtTL(s.net)}</td><td>${(s.count||0)}</td>`;
    svcRows.appendChild(tr);
  });

  // By period
  periodTableWrap.style.display="block";
  periodRows.innerHTML="";
  (j.by_period||[]).forEach(p=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${p.key}</td><td>${fmtTL(p.brut)}</td><td>${fmtTL(p.commission)}</td><td>${fmtTL(p.net)}</td><td>${(p.count||0)}</td>`;
    periodRows.appendChild(tr);
  });
}

/* ===== JOBS ===== */
async function loadJobs(){
  const t=getToken();
  const u=qs({action:"listJobs",token:t,limit:jLimit.value||50,status:jStatus.value||"",service_type:jService.value||""});
  const j=await fetch(u).then(r=>r.json()).catch(()=>({ok:false}));
  jobs.innerHTML="";
  (j.items||[]).forEach(it=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`<b>${it.job_id}</b> <span class="badge">${it.status}</span>
      <div class="small">${it.service_type} â€¢ ${fmtTL(it.price_brut)} â€¢ Kom: ${fmtTL(it.commission_amount)} â€¢ Net: ${fmtTL(it.price_driver_net)} â€¢ Driver: ${it.driver_id||"â€”"}</div>`;
    jobs.appendChild(d);
  });
}

/* ===== DRIVERS ===== */
async function loadDrivers(){
  const t=getToken();
  const u=qs({action:"listDrivers",token:t});
  const j=await fetch(u).then(r=>r.json()).catch(()=>({ok:false}));
  drivers.innerHTML="";
  (j.items||[]).forEach(it=>{
    const d=document.createElement("div");
    d.className="item";
    d.innerHTML=`<b>${it.driver_id}</b> <span class="badge">${it.approved}</span>
      <div class="small">${it.name||""} â€¢ ${it.phone||""} â€¢ ${it.vehicle||""}</div>`;
    drivers.appendChild(d);
  });
}

showPanel();
</script>
</body>
</html>
