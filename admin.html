<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SepetTaxi Admin</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#0f0f0f;
  color:#fff
}
header{
  height:56px;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:bold
}
header span{color:#f5c400}

.container{padding:16px}

button{
  background:#f5c400;
  color:#000;
  border:none;
  border-radius:10px;
  padding:10px 16px;
  font-weight:bold;
  cursor:pointer
}

.card{
  background:#1b1b1b;
  border-radius:14px;
  padding:16px;
  margin-bottom:12px
}

.row{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap
}

.badge{
  padding:4px 10px;
  border-radius:8px;
  font-size:12px;
  font-weight:bold
}
.pending{background:#555}
.assigned{background:#f5c400;color:#000}
.completed{background:#2ecc71;color:#000}
.cancelled{background:#e74c3c}

.small{
  font-size:12px;
  opacity:.8;
  margin:4px 0
}

input{
  background:#000;
  border:1px solid #333;
  color:#fff;
  padding:8px;
  border-radius:8px
}

.actions{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px
}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> Admin</header>

<div class="container">
  <button onclick="loadJobs()">ðŸ”„ Yenile</button>
  <div id="jobs"></div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL =
"https://script.google.com/macros/s/AKfycbz4seYfFW8fWiNne1T1BiE0-huu8iuYY8yAXY1a0b93LBaUwMSxu51Np5Toa4XlBjc-Fg/exec";

/* ================= LOAD JOBS (JSONP) ================= */
function loadJobs(){
  const old=document.getElementById("jsonp");
  if(old) old.remove();

  const s=document.createElement("script");
  s.id="jsonp";
  s.src=BACKEND_URL+"?action=list&callback=renderJobs";
  document.body.appendChild(s);
}

/* ================= RENDER ================= */
function renderJobs(list){
  const wrap=document.getElementById("jobs");
  wrap.innerHTML="";

  if(!list || !list.length){
    wrap.innerHTML="<div class='card'>Aktif iÅŸ yok</div>";
    return;
  }

  list.forEach(j=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <div class="row">
        <b>${j.job_id}</b>
        <span class="badge ${j.status}">${j.status}</span>
      </div>

      <div class="small">${j.created_at}</div>
      <div><b>${j.service_type.toUpperCase()}</b> â€“ ${j.customer_first} ${j.customer_last}</div>
      <div>${j.from_address} â†’ ${j.to_address}</div>
      <div>${j.distance_km} | <b>${j.price}</b></div>

      <div class="actions">
        <input id="drv-${j.job_id}" placeholder="driver_id">
        <button onclick="assign('${j.job_id}')">Ata</button>
        <button onclick="setStatus('${j.job_id}','completed')">TamamlandÄ±</button>
        <button onclick="setStatus('${j.job_id}','cancelled')">Ä°ptal</button>
      </div>
    `;
    wrap.appendChild(div);
  });
}

/* ================= ACTIONS ================= */
function assign(jobId){
  const drv=document.getElementById("drv-"+jobId).value.trim();
  if(!drv) return alert("driver_id gir");
  update(jobId,"assigned",drv);
}

function setStatus(jobId,status){
  update(jobId,status,"");
}

/* ================= UPDATE (POST) ================= */
function update(jobId,status,driverId){
  fetch(BACKEND_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"update",
      job_id:jobId,
      status:status,
      driver_id:driverId
    })
  })
  .then(()=>loadJobs())
  .catch(()=>alert("GÃ¼ncelleme hatasÄ±"));
}

/* ================= INIT ================= */
loadJobs();
</script>

</body>
</html>
