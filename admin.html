<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>SepetTaxi – Admin Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;background:#0b0b0b;color:#fff;font-family:Arial}
.wrap{max-width:900px;margin:30px auto;padding:20px}
.card{background:#151515;border-radius:14px;padding:20px;margin-bottom:20px}
h1,h2{margin:0 0 10px}
.badge{display:inline-block;padding:6px 12px;border-radius:20px;font-size:12px}
.ok{background:#0a3}
.err{background:#a00}
.small{color:#aaa;font-size:12px}

.table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #222;font-size:14px;text-align:left}

input,button{
  padding:12px;
  border-radius:10px;
  border:none;
  font-size:14px
}
input{background:#111;color:#fff;width:100%}
button{background:#fff;color:#000;cursor:pointer}

.flex{display:flex;gap:10px}
</style>
</head>
<body>

<div class="wrap">

<div class="card">
  <h1>SepetTaxi – Admin Panel</h1>
  <span id="conn" class="badge">Kontrol ediliyor…</span>
</div>

<div class="card">
  <h2>Günlük Operasyon Özeti</h2>
  <div id="summary" class="small">Yükleniyor…</div>
</div>

<div class="card">
  <h2>Bekleyen / Atanmış İşler</h2>
  <table class="table">
    <thead>
      <tr>
        <th>Job</th>
        <th>Kullanıcı</th>
        <th>Servis</th>
        <th>Durum</th>
      </tr>
    </thead>
    <tbody id="jobs">
      <tr><td colspan="4">Yükleniyor…</td></tr>
    </tbody>
  </table>
</div>

<div class="card">
  <h2>Sürücüler</h2>
  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Ad</th>
        <th>Telefon</th>
        <th>Araç</th>
        <th>Durum</th>
      </tr>
    </thead>
    <tbody id="drivers">
      <tr><td colspan="5">Yükleniyor…</td></tr>
    </tbody>
  </table>
</div>

<div class="card">
  <h2>Manuel İş Atama</h2>
  <div class="flex">
    <input id="jobId" placeholder="JOB-XXXX">
    <input id="driverId" placeholder="DRV-001">
    <button onclick="assignJob()">İşi Ata</button>
  </div>
  <div id="assignMsg" class="small"></div>
</div>

</div>

<script>
// ⛔ BURAYI DEĞİŞTİRME – SADECE EXEC URL
const API = "https://script.google.com/macros/s/AKfycbx1kDpZJfR9Cb_jzcQbrIoZ_TTPp-8umroP_vGqLmQVm1qPgagjNLQype_zSmmyICRC/exec";

// GET tabanlı, Apps Script doGet uyumlu
async function api(action, params = {}) {
  const q = new URLSearchParams({ action, ...params }).toString();
  const r = await fetch(API + "?" + q);
  return r.json();
}

async function init() {
  // PING
  try {
    const p = await api("ping");
    const c = document.getElementById("conn");
    if (p.ok) {
      c.innerText = "Backend bağlı";
      c.className = "badge ok";
    } else {
      c.innerText = "Backend hata";
      c.className = "badge err";
    }
  } catch {
    const c = document.getElementById("conn");
    c.innerText = "Bağlantı yok";
    c.className = "badge err";
    return;
  }

  // SUMMARY
  const s = await api("dailySummary");
  document.getElementById("summary").innerText =
    `Bugün: ${s.today} | Aktif: ${s.active} | Pending: ${s.pending}`;

  // JOBS
  const j = await api("listJobs");
  const jobRows = j.jobs
    .filter(x => x.status === "pending" || x.status === "assigned")
    .map(x => `
      <tr>
        <td>${x.job_id}</td>
        <td>${x.user_name}<br>${x.user_phone}</td>
        <td>${x.service}</td>
        <td>${x.status}</td>
      </tr>
    `).join("");

  document.getElementById("jobs").innerHTML =
    jobRows || `<tr><td colspan="4">İş yok</td></tr>`;

  // DRIVERS
  const d = await api("listDrivers");
  document.getElementById("drivers").innerHTML =
    d.drivers.map(x => `
      <tr>
        <td>${x.driver_id}</td>
        <td>${x.name}</td>
        <td>${x.phone}</td>
       <td>${x.vehicle_type}</td>
       <td>${x.status}</td>
      </tr>
    `).join("");
}

async function assignJob() {
  const job = document.getElementById("jobId").value;
  const drv = document.getElementById("driverId").value;
  const r = await api("assignJob", { job_id: job, driver_id: drv });
  document.getElementById("assignMsg").innerText =
    r.ok ? "Atama başarılı" : "Atama hatası";
  init();
}

init();
</script>
</body>
</html>
