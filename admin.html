<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Admin</title>
<meta name="theme-color" content="#f5c400">
<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;overflow:hidden}
:root{--y:#f5c400;--line:rgba(255,255,255,.12);--mut:rgba(255,255,255,.65)}
.wrap{height:100%;display:flex;flex-direction:column}
.top{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:1000}
.main{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.card{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:18px;padding:12px}
.tabs{display:flex;gap:8px}
.tab{flex:1;padding:10px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03);text-align:center;font-weight:1000;cursor:pointer}
.tab.active{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.10)}
.input,select{width:100%;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:#fff;outline:none}
.btn{width:100%;padding:12px;border-radius:16px;border:0;font-weight:1000;background:linear-gradient(135deg,#f5c400,#ffd34d);color:#1a1400;cursor:pointer}
.btn.secondary{background:rgba(255,255,255,.06);border:1px solid var(--line);color:#fff}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.small{font-size:12px;color:var(--mut)}
.list{display:flex;flex-direction:column;gap:10px}
.item{padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
.row{display:flex;gap:10px}
.hr{height:1px;background:var(--line);margin:10px 0}
.badge{padding:6px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;font-weight:1000;color:#fff}
.badge.y{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.10)}
</style>
</head>
<body>
<script>
const API = "https://script.google.com/macros/s/AKfycbzXbm934CXIjTSL9RxmL8kkCjGERoeiQPDfY-OUk2Lexqqr_UvppoJ2yT0t562aJZdxRg/exec";
function postForm(data){
  const body=new URLSearchParams(data);
  return fetch(API,{method:"POST",body}).then(r=>r.json());
}
function money(n){ return (Number(n)||0).toFixed(2).replace(".00","")+" ₺"; }
</script>

<div class="wrap">
  <div class="top">
    <div class="brand">SepetTaxi · Admin</div>
    <div class="badge y" id="authBadge">Giriş</div>
  </div>
  <div class="main" id="main"></div>
</div>

<script>
let token = localStorage.getItem("sepettaxi_admin_token") || "";

function viewLogin(){
  authBadge.textContent="Giriş";
  main.innerHTML=`
    <div class="card">
      <div style="font-weight:1000">Admin PIN</div>
      <div style="margin-top:10px"><input class="input" id="pin" placeholder="PIN" type="password"></div>
      <div style="margin-top:10px"><button class="btn" id="btn">Giriş</button></div>
      <div class="small" id="hint" style="margin-top:10px"></div>
    </div>
  `;
  btn.onclick=async ()=>{
    hint.textContent="Kontrol…";
    const r=await postForm({action:"adminLogin",pin:pin.value});
    if(!r.ok){ hint.textContent="Hata: "+r.message; return; }
    token=r.token;
    localStorage.setItem("sepettaxi_admin_token",token);
    viewHome();
  };
}

function viewHome(){
  authBadge.textContent="Yetkili";
  main.innerHTML=`
    <div class="card">
      <div class="tabs">
        <div class="tab active" id="tabCand">Başvurular</div>
        <div class="tab" id="tabJobs">İşler</div>
        <div class="tab" id="tabDash">Dashboard</div>
      </div>
      <div class="hr"></div>
      <div id="panel"></div>
    </div>
    <div class="card">
      <button class="btn secondary" id="logout">Çıkış</button>
    </div>
  `;
  logout.onclick=()=>{
    localStorage.removeItem("sepettaxi_admin_token");
    token=""; viewLogin();
  };
  tabCand.onclick=()=>setTab("cand");
  tabJobs.onclick=()=>setTab("jobs");
  tabDash.onclick=()=>setTab("dash");
  setTab("cand");
}

function setTab(t){
  ["tabCand","tabJobs","tabDash"].forEach(id=>document.getElementById(id).classList.remove("active"));
  if(t==="cand"){ tabCand.classList.add("active"); renderCandidates(); }
  if(t==="jobs"){ tabJobs.classList.add("active"); renderJobs(); }
  if(t==="dash"){ tabDash.classList.add("active"); renderDash(); }
}

async function renderCandidates(){
  panel.innerHTML=`<div class="small">Yükleniyor…</div>`;
  const r=await postForm({action:"adminListCandidates",token});
  if(!r.ok){ panel.innerHTML=`<div class="small">Hata: ${r.message}</div>`; return; }
  const c=r.candidates||[];
  if(!c.length){ panel.innerHTML=`<div class="small">Bekleyen başvuru yok.</div>`; return; }

  panel.innerHTML=`
    <div class="small">Bekleyen: ${c.length}</div>
    <div class="list" id="lst" style="margin-top:10px"></div>
  `;
  lst.innerHTML=c.map(d=>`
    <div class="item">
      <div style="font-weight:1000">${d.first||""} ${d.last||""}</div>
      <div class="small">${d.driver_id} · ${d.phone||""}</div>
      <div class="small">Araç: ${d.vehicle||"—"} · Rol: ${(d.role||"—")}</div>
      <div class="row" style="margin-top:10px">
        <select class="input" id="role_${d.driver_id}">
          <option value="">Rol seç</option>
          <option value="taxi">Taksi</option>
          <option value="courier">Kurye</option>
        </select>
        <button class="btn secondary" onclick="reject('${d.driver_id}')">Reddet</button>
      </div>
      <div style="margin-top:10px">
        <button class="btn" onclick="approve('${d.driver_id}')">Onayla</button>
      </div>
    </div>
  `).join("");
}

async function approve(driverId){
  const roleSel = document.getElementById("role_"+driverId);
  const role = (roleSel && roleSel.value) ? roleSel.value : "";
  const r=await postForm({action:"adminApproveDriver",token,driver_id:driverId,role});
  if(!r.ok){ alert("Onaylanamadı: "+r.message); return; }
  renderCandidates();
}

async function reject(driverId){
  const reason = prompt("Red nedeni (opsiyonel):","Eksik evrak");
  const r=await postForm({action:"adminRejectDriver",token,driver_id:driverId,reason:reason||""});
  if(!r.ok){ alert("Reddedilemedi: "+r.message); return; }
  renderCandidates();
}

async function renderJobs(){
  panel.innerHTML=`<div class="small">Yükleniyor…</div>`;
  const [jobsRes, drvRes] = await Promise.all([
    postForm({action:"adminListJobs",token}),
    postForm({action:"adminListDrivers",token})
  ]);
  if(!jobsRes.ok){ panel.innerHTML=`<div class="small">Hata: ${jobsRes.message}</div>`; return; }
  if(!drvRes.ok){ panel.innerHTML=`<div class="small">Hata: ${drvRes.message}</div>`; return; }

  const jobs=jobsRes.jobs||[];
  const drivers=(drvRes.drivers||[]).filter(d=>String(d.active).toLowerCase()==="true" || String(d.status).toLowerCase()==="approved");

  panel.innerHTML=`
    <div class="small">Toplam iş: ${jobs.length}</div>
    <div class="list" id="jobsList" style="margin-top:10px"></div>
  `;

  jobsList.innerHTML=jobs.slice().reverse().slice(0,50).map(j=>{
    const st=(j.status||"");
    const drv=(j.driver_id||"");
    const options = drivers
      .filter(d=>{
        const r=(d.role||"").toLowerCase();
        return !j.service_type ? true : (r===(j.service_type||"").toLowerCase() || r==="");
      })
      .map(d=>`<option value="${d.driver_id}">${d.driver_id} · ${d.first||""} ${d.last||""}</option>`)
      .join("");

    return `
      <div class="item">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:1000">${j.job_id}</div>
            <div class="small">${(j.service_type||"").toUpperCase()} · ${money(j.price)}</div>
            <div class="small">Durum: <span class="badge y">${st}</span> · Sürücü: ${drv||"—"}</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="small">Manuel atama (opsiyonel)</div>
        <div class="row" style="margin-top:8px">
          <select class="input" id="as_${j.job_id}">
            <option value="">Sürücü seç</option>
            ${options}
          </select>
          <button class="btn secondary" onclick="assign('${j.job_id}')">Ata</button>
        </div>
      </div>
    `;
  }).join("");
}

async function assign(jobId){
  const sel=document.getElementById("as_"+jobId);
  const driverId = sel.value;
  if(!driverId){ alert("Sürücü seç"); return; }
  const r=await postForm({action:"adminAssignJob",token,job_id:jobId,driver_id:driverId});
  if(!r.ok){ alert("Atanamadı: "+r.message); return; }
  renderJobs();
}

async function renderDash(){
  panel.innerHTML=`<div class="small">Yükleniyor…</div>`;
  const r=await postForm({action:"adminStats",token});
  if(!r.ok){ panel.innerHTML=`<div class="small">Hata: ${r.message}</div>`; return; }
  const s=r.stats||{};
  panel.innerHTML=`
    <div class="row">
      <div class="card" style="flex:1">
        <div class="small">Searching</div>
        <div style="font-size:22px;font-weight:1000;margin-top:6px">${s.searching||0}</div>
      </div>
      <div class="card" style="flex:1">
        <div class="small">Active</div>
        <div style="font-size:22px;font-weight:1000;margin-top:6px">${s.active||0}</div>
      </div>
      <div class="card" style="flex:1">
        <div class="small">Completed</div>
        <div style="font-size:22px;font-weight:1000;margin-top:6px">${s.completed||0}</div>
      </div>
    </div>
    <div class="hr"></div>
    <div class="row">
      <div class="card" style="flex:1">
        <div class="small">Toplam Ciro</div>
        <div style="font-size:20px;font-weight:1000;margin-top:6px">${money(s.total_revenue||0)}</div>
      </div>
      <div class="card" style="flex:1">
        <div class="small">Toplam Komisyon</div>
        <div style="font-size:20px;font-weight:1000;margin-top:6px">${money(s.total_commission||0)}</div>
      </div>
    </div>
  `;
}

/* BOOT */
(async function(){
  if(!token){ viewLogin(); return; }
  // token var ama doğru mu bilmiyoruz; basitçe home'a girip çağrı hatasında login'e düşürüyoruz.
  const test = await postForm({action:"adminStats",token});
  if(!test.ok){ token=""; localStorage.removeItem("sepettaxi_admin_token"); viewLogin(); return; }
  viewHome();
})();
</script>
</body>
</html>
