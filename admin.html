<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi – Admin</title>
<meta name="theme-color" content="#f5c400">
<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;overflow:hidden}
:root{--y:#f5c400;--line:rgba(255,255,255,.12);--mut:rgba(255,255,255,.65)}
.wrap{height:100%;display:flex;flex-direction:column}
.top{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:1000}
.main{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.card{background:rgba(255,255,255,.04);border:1px solid var(--line);border-radius:18px;padding:12px}
.tabs{display:flex;gap:8px}
.tab{flex:1;padding:10px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03);text-align:center;font-weight:1000;cursor:pointer}
.tab.active{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.10)}
.input,select{width:100%;padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.04);color:#fff;outline:none}
.btn{width:100%;padding:12px;border-radius:16px;border:0;font-weight:1000;background:linear-gradient(135deg,#f5c400,#ffd34d);color:#1a1400;cursor:pointer}
.btn.secondary{background:rgba(255,255,255,.06);border:1px solid var(--line);color:#fff}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.small{font-size:12px;color:var(--mut)}
.list{display:flex;flex-direction:column;gap:10px}
.item{padding:12px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.03)}
.row{display:flex;gap:10px}
.hr{height:1px;background:var(--line);margin:10px 0}
.badge{padding:6px 8px;border-radius:999px;border:1px solid var(--line);font-size:11px;font-weight:1000;color:#fff}
.badge.y{border-color:rgba(245,196,0,.55);background:rgba(245,196,0,.10)}
</style>
</head>
<body>

<script>
const API = "https://script.google.com/macros/s/AKfycbzXbm934CXIjTSL9RxmL8kkCjGERoeiQPDfY-OUk2Lexqqr_UvppoJ2yT0t562aJZdxRg/exec";
function postForm(data){
  return fetch(API,{method:"POST",body:new URLSearchParams(data)}).then(r=>r.json());
}
</script>

<div class="wrap">
  <div class="top">
    <div class="brand">SepetTaxi · Admin</div>
    <div class="badge y" id="authBadge">Giriş</div>
  </div>
  <div class="main" id="main"></div>
</div>

<script>
let token = localStorage.getItem("sepettaxi_admin_token") || "";

function viewLogin(){
  authBadge.textContent="Giriş";
  main.innerHTML=`
    <div class="card">
      <div style="font-weight:1000">Admin PIN</div>
      <input class="input" id="pin" placeholder="PIN" type="password" style="margin-top:10px">
      <button class="btn" id="btn" style="margin-top:10px">Giriş</button>
      <div class="small" id="hint" style="margin-top:10px"></div>
    </div>`;
  btn.onclick=async ()=>{
    hint.textContent="Kontrol…";
    const r=await postForm({action:"adminLogin",pin:pin.value});
    if(!r.ok){ hint.textContent="Hata: "+r.message; return; }
    token=r.token;
    localStorage.setItem("sepettaxi_admin_token",token);
    viewHome();
  };
}

function viewHome(){
  authBadge.textContent="Yetkili";
  main.innerHTML=`
    <div class="card">
      <div class="tabs">
        <div class="tab active" id="tabCand">Başvurular</div>
      </div>
      <div class="hr"></div>
      <div id="panel"></div>
    </div>
    <div class="card">
      <button class="btn secondary" id="logout">Çıkış</button>
    </div>`;
  logout.onclick=()=>{localStorage.clear();location.reload();}
  tabCand.onclick=renderCandidates;
  renderCandidates();
}

async function renderCandidates(){
  panel.innerHTML=`<div class="small">Yükleniyor…</div>`;
  const r=await postForm({action:"adminListCandidates",token});
  if(!r.ok){ panel.innerHTML=`<div class="small">${r.message}</div>`; return; }

  panel.innerHTML = r.candidates.map(d=>`
    <div class="item">
      <b>${d.first||""} ${d.last||""}</b>
      <div class="small">${d.driver_id} · ${d.phone||""}</div>

      <select class="input" id="role_${d.driver_id}" style="margin-top:10px">
        <option value="">Rol seç</option>
        <option value="taxi">Taksi</option>
        <option value="courier">Kurye</option>
      </select>

      <button class="btn" style="margin-top:10px"
        onclick="approve('${d.driver_id}')">Onayla</button>
    </div>
  `).join("");
}

async function approve(driverId){
  const sel=document.getElementById("role_"+driverId);
  if(!sel.value){ alert("Rol seç"); return; }

  const r=await postForm({
    action:"adminApproveDriver",
    token,
    driver_id:driverId,
    vehicle:sel.value
  });

  if(!r.ok){ alert(r.message); return; }
  renderCandidates();
}

(async function(){
  if(!token){ viewLogin(); return; }
  const t=await postForm({action:"adminStats",token});
  if(!t.ok){ localStorage.clear(); viewLogin(); return; }
  viewHome();
})();
</script>
</body>
</html>
