<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Admin</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}
.container{padding:12px}
.card{background:#111;border:1px solid #222;border-radius:14px;padding:12px;margin-bottom:10px}
.row{display:flex;gap:8px;align-items:center}
.input{flex:1;width:100%;padding:10px;border-radius:12px;border:1px solid #222;background:#000;color:#fff}
.btn{background:#f5c400;color:#000;border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;text-align:center}
.btn.secondary{background:#333;color:#fff}
.small{font-size:12px;color:#aaa}
.item{padding:10px;border-radius:12px;border:1px solid #222;background:#0f0f0f;margin-top:8px;cursor:pointer}
.item b{color:#fff}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #333;font-size:12px;color:#ddd;margin-left:8px}
</style>
</head>
<body>

<header>Sepet<span>Taxi</span> – Admin</header>

<div class="container">
  <div class="card">
    <div class="row">
      <input id="limit" class="input" value="50" placeholder="limit">
      <input id="status" class="input" placeholder="status (searching/assigned/...)">
      <input id="service" class="input" placeholder="service (taxi/courier)">
    </div>
    <div class="row" style="margin-top:10px">
      <div class="btn" onclick="load()">YENİLE</div>
      <div class="btn secondary" onclick="openDrivers()">SÜRÜCÜLER</div>
    </div>
    <div class="small" style="margin-top:8px" id="info">—</div>
  </div>

  <div class="card">
    <div style="font-weight:900">İşler</div>
    <div id="list"></div>
  </div>

  <div class="card" id="detail" style="display:none">
    <div style="font-weight:900">Detay</div>
    <div class="small" id="dText" style="margin-top:8px">—</div>
    <div class="row" style="margin-top:10px">
      <div class="btn" onclick="openTrack()">TRACK</div>
      <div class="btn secondary" onclick="hideDetail()">KAPAT</div>
    </div>
  </div>

  <div class="card" id="driversBox" style="display:none">
    <div style="font-weight:900">Sürücüler</div>
    <div id="drivers"></div>
  </div>
</div>

<script>
const BACKEND_URL="https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";
const $=id=>document.getElementById(id);
let selectedJob="";

function qs(o){
  const u=new URL(BACKEND_URL);
  Object.entries(o).forEach(([k,v])=>u.searchParams.set(k,v));
  return u.toString();
}

async function load(){
  const p={
    action:"listJobs",
    limit: (limit.value||"50").trim(),
    status: (status.value||"").trim(),
    service_type: (service.value||"").trim()
  };
  const r=await fetch(qs(p));
  const j=await r.json().catch(()=>({}));
  if(!j.ok){ info.textContent="Hata"; return; }
  info.textContent = `Toplam: ${j.items.length}`;
  list.innerHTML="";
  j.items.forEach(it=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `<b>${it.job_id}</b><span class="badge">${it.status}</span><div class="small">${it.service_type} • ${it.price_brut} TL • Driver: ${it.driver_id||"—"}</div>`;
    div.onclick=()=>select(it.job_id);
    list.appendChild(div);
  });
}

async function select(jobId){
  selectedJob=jobId;
  const r=await fetch(qs({action:"getJob",job_id:jobId}));
  const j=await r.json().catch(()=>({}));
  if(!j.ok) return;
  detail.style.display="block";
  dText.innerText =
    `job: ${j.job_id}\n`+
    `status: ${j.status}\n`+
    `service: ${j.service_type}\n`+
    `brut: ${j.price_brut} / com: ${j.commission_amount} / net: ${j.price_driver_net}\n`+
    `from: ${j.from_addr}\n`+
    `to: ${j.to_addr}\n`+
    `driver: ${j.driver_id || "—"}\n`+
    (j.service_type==="courier" ? (`\nPaket: ${j.pkg_type}\nAlıcı: ${j.recv_name} (${j.recv_phone})\nNot: ${j.content_note}`) : "");
}
function hideDetail(){ detail.style.display="none"; selectedJob=""; }
function openTrack(){
  if(!selectedJob) return;
  location.href = `track.html?role=customer&job=${encodeURIComponent(selectedJob)}`;
}

async function openDrivers(){
  driversBox.style.display="block";
  const r=await fetch(qs({action:"listDrivers"}));
  const j=await r.json().catch(()=>({}));
  if(!j.ok) return;
  drivers.innerHTML="";
  j.items.forEach(d=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML = `<b>${d.driver_id}</b><span class="badge">${d.approved}</span><div class="small">${d.name||""} • ${d.phone||""} • ${d.vehicle||""}</div>`;
    drivers.appendChild(div);
  });
}

load();
</script>
</body>
</html>
