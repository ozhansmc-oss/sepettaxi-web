<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Admin</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#0b0b0b;color:#fff}
.hidden{display:none}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #222}
header span{color:#f5c400}

#loginWrap{height:100vh;display:flex;align-items:center;justify-content:center}
.loginCard{background:#111;border-radius:18px;padding:20px;width:100%;max-width:340px;border:1px solid #222}
.loginCard h1{text-align:center;margin:0 0 14px 0}
.loginCard h1 span{color:#f5c400}
.loginCard input{width:100%;padding:14px;border-radius:14px;border:0;background:#222;color:#fff;margin-bottom:10px}
.loginCard button{width:100%;padding:14px;border-radius:18px;border:0;font-weight:900;background:#f5c400;color:#000;cursor:pointer}
.err{color:#ff6b6b;font-size:13px;text-align:center;display:none}

.wrap{padding:14px;max-width:1200px;margin:auto}
.card{background:#111;border-radius:16px;padding:14px;margin-bottom:14px;border:1px solid #222}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}
.kpi{background:#0f0f0f;border-radius:14px;padding:12px;text-align:center;border:1px solid #1f1f1f}
.kpi .lbl{font-size:12px;color:#aaa}
.kpi .val{font-size:22px;font-weight:900;margin-top:6px}

table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:8px;border-bottom:1px solid #222;text-align:left;vertical-align:top}
th{color:#f5c400;font-weight:900}
tr:hover{background:#151515}

.badge{padding:4px 8px;border-radius:999px;font-size:11px;background:#222;color:#aaa}
.ok{background:#1f6f3f;color:#9fffc7}
.cancel{background:#6f1f1f;color:#ffb0b0}
.pending{background:#444}

.topbar{display:flex;justify-content:space-between;align-items:center}
.logout{background:#222;color:#ccc;border:0;border-radius:14px;padding:8px 14px;cursor:pointer}

select{background:#222;color:#fff;border:0;border-radius:10px;padding:8px;width:180px}
.btnSmall{background:#f5c400;border:0;border-radius:12px;padding:8px 10px;font-weight:900;cursor:pointer;margin-top:6px}
.small{font-size:12px;color:#aaa}
</style>
</head>

<body>

<div id="loginWrap">
  <div class="loginCard">
    <h1>Sepet<span>Taxi</span></h1>
    <input id="aid" placeholder="Admin ID">
    <input id="pin" type="password" placeholder="PIN">
    <button onclick="login()">GİRİŞ</button>
    <div id="err" class="err">Hatalı giriş</div>
  </div>
</div>

<div id="adminWrap" class="hidden">
<header>Sepet<span>Taxi</span> – Admin</header>

<div class="wrap">
  <div class="card topbar">
    <b>Yönetim Paneli</b>
    <button class="logout" onclick="logout()">Çıkış</button>
  </div>

  <div class="card">
    <div class="grid">
      <div class="kpi"><div class="lbl">Toplam İş</div><div id="kTotal" class="val">—</div></div>
      <div class="kpi"><div class="lbl">Aktif</div><div id="kActive" class="val">—</div></div>
      <div class="kpi"><div class="lbl">Tamamlanan</div><div id="kCompleted" class="val">—</div></div>
      <div class="kpi"><div class="lbl">İptal</div><div id="kCancelled" class="val">—</div></div>
      <div class="kpi"><div class="lbl">Toplam Ciro</div><div id="kRevenue" class="val">—</div></div>
      <div class="kpi"><div class="lbl">Platform Geliri</div><div id="kCommission" class="val">—</div></div>
      <div class="kpi"><div class="lbl">Bugün Tamamlanan</div><div id="kTodayC" class="val">—</div></div>
      <div class="kpi"><div class="lbl">Bugün Ciro</div><div id="kTodayR" class="val">—</div></div>
    </div>
  </div>

  <div class="card">
    <b>İş Detayları (Pending işlere manuel atama)</b>
    <div style="overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Job</th>
            <th>Durum</th>
            <th>Sürücü / Atama</th>
            <th>Mesafe</th>
            <th>Ücret</th>
            <th>Komisyon</th>
            <th>Tarih</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <b>Son Olaylar (Timeline)</b>
    <div id="tl" class="small" style="margin-top:10px"></div>
  </div>
</div>
</div>

<!-- ================= LOG CORE ================= -->
<script>
(function(){
  const L={INFO:'INFO',WARN:'WARN',ERROR:'ERROR',FLOW:'FLOW'};
  function log(l,t,m,d){
    const p=`[SepetTaxi][${l}][${t}]`;
    if(l===L.ERROR) console.error(p,m,d||'');
    else if(l===L.WARN) console.warn(p,m,d||'');
    else console.log(p,m,d||'');
  }
  window.logInfo=(t,m,d)=>log(L.INFO,t,m,d);
  window.logWarn=(t,m,d)=>log(L.WARN,t,m,d);
  window.logError=(t,m,d)=>log(L.ERROR,t,m,d);
  window.logFlow=(t,m,d)=>log(L.FLOW,t,m,d);
})();
</script>

<script>
const ADMIN_ID="admin";
const ADMIN_PIN="1234";

const BACKEND_URL =
  (window.SEPT && window.SEPT.BACKEND_URL) ||
  "https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const COMMISSION=0.15;

logFlow("INIT","admin.html loaded",{BACKEND_URL});

function login(){
  const aid=aidInput.value.trim();
  const pin=pinInput.value.trim();
  if(aid===ADMIN_ID && pin===ADMIN_PIN){
    sessionStorage.setItem("admin_auth","ok");
    logInfo("ADMIN","login ok",{aid});
    showAdmin();
  }else{
    err.style.display="block";
    logWarn("ADMIN","login failed",{aid});
  }
}
function logout(){
  sessionStorage.removeItem("admin_auth");
  location.reload();
}
function showAdmin(){
  loginWrap.classList.add("hidden");
  adminWrap.classList.remove("hidden");
  loadAll();
  setInterval(loadAll,5000);
}
if(sessionStorage.getItem("admin_auth")==="ok") showAdmin();

function toNum(v){
  const n=Number(String(v||0).replace(/[^\d.]/g,""));
  return isFinite(n)?n:0;
}

async function loadAll(){
  try{
    const [jobs,drivers,sum,tline]=await Promise.all([
      fetch(`${BACKEND_URL}?action=getJobs`).then(r=>r.json()),
      fetch(`${BACKEND_URL}?action=getDrivers`).then(r=>r.json()),
      fetch(`${BACKEND_URL}?action=dailySummary`).then(r=>r.json()),
      fetch(`${BACKEND_URL}?action=getTimeline&limit=30`).then(r=>r.json())
    ]);
    renderKpi(sum);
    renderTable(jobs||[],drivers||[]);
    renderTimeline(tline);
    logFlow("API","admin loadAll ok");
  }catch(e){
    logError("API","admin loadAll failed",e);
  }
}

function renderKpi(sum){
  if(!sum||!sum.ok) return;
  kTotal.innerText=sum.total;
  kActive.innerText=sum.active;
  kCompleted.innerText=sum.completed;
  kCancelled.innerText=sum.cancelled;
  kRevenue.innerText=(sum.revenue||0).toFixed(0)+" TL";
  kCommission.innerText=(sum.commission||0).toFixed(0)+" TL";
  kTodayC.innerText=sum.todayCompleted;
  kTodayR.innerText=(sum.todayRevenue||0).toFixed(0)+" TL";
}

async function assign(job_id,driver_id){
  if(!driver_id){ alert("Sürücü seç"); return; }
  logInfo("ADMIN","assign",{job_id,driver_id});
  await fetch(BACKEND_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({action:"assignDriver",job_id,driver_id,actor:"admin"})
  });
  loadAll();
}

function renderTable(jobs,drivers){
  rows.innerHTML="";
  const avail=drivers.filter(d=>d.status==="available");
  jobs.slice().reverse().forEach(j=>{
    const price=toNum(j.final_price||j.price||0);
    const comm=price*COMMISSION;
    const st=j.status||"";
    let drv=j.driver_id||"-";
    if(st==="pending"){
      const opts=avail.map(d=>`<option value="${d.driver_id}">${d.driver_id}</option>`).join("");
      drv=`<select id="sel_${j.job_id}"><option value="">Seç</option>${opts}</select>
           <button class="btnSmall" onclick="assign('${j.job_id}',document.getElementById('sel_${j.job_id}').value)">ATA</button>`;
    }
    rows.innerHTML+=`
      <tr>
        <td>${j.job_id}</td>
        <td><span class="badge ${st}">${st}</span></td>
        <td>${drv}</td>
        <td>${toNum(j.distance_km||0).toFixed(2)} km</td>
        <td>${price.toFixed(0)} TL</td>
        <td>${comm.toFixed(0)} TL</td>
        <td>${(j.created_at||"").slice(0,16).replace("T"," ")}</td>
      </tr>`;
  });
}

function renderTimeline(t){
  if(!t||!t.ok){ tl.innerText="Timeline yok."; return; }
  tl.innerHTML=t.items.map(x=>`• <b>${x.job_id}</b> ${x.event} ${x.status}`).join("<br>");
}
</script>
</body>
</html>
