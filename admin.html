<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi – Admin</title>
<meta name="theme-color" content="#f5c400" />

<style>
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#050506;color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;overflow:hidden}
  :root{--y:#f5c400;--line:rgba(255,255,255,.10);--mut:rgba(255,255,255,.65)}
  .top{
    position:fixed;left:0;right:0;top:0;height:56px;
    display:flex;align-items:center;justify-content:space-between;
    padding:0 12px;z-index:10;
    background:linear-gradient(180deg, rgba(0,0,0,.72), rgba(0,0,0,.10));
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .title{font-weight:900}
  .wrap{position:fixed;inset:56px 0 0 0;display:flex;flex-direction:column}
  .panel{
    padding:12px;
    border-bottom:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg, rgba(20,20,22,.92), rgba(10,10,12,.98));
  }
  .card{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    border-radius:18px;
    padding:12px;
  }
  .inp{
    width:100%;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(255,255,255,.04);
    color:#fff;
    padding:12px;
    font-weight:800;
    outline:none;
    margin-top:8px;
  }
  .btn{
    width:100%;
    border:0;border-radius:16px;
    padding:12px;font-weight:900;
    margin-top:10px;
    background:linear-gradient(135deg,#f5c400,#ffd34d);
    color:#1a1400;
  }
  .btn2{
    border-radius:14px;
    padding:10px 12px;font-weight:900;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(255,255,255,.06);
    color:#fff;
  }
  .tabs{display:flex;gap:10px;margin-top:10px}
  .tab{flex:1;text-align:center;padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);font-weight:900}
  .tab.active{border-color:rgba(245,196,0,.45);background:rgba(245,196,0,.10)}
  .list{flex:1;overflow:auto;padding:12px}
  .item{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);border-radius:18px;padding:12px;margin-bottom:10px}
  .mut{color:rgba(255,255,255,.62);font-size:12px;margin-top:6px;line-height:1.35}
  .row{display:flex;gap:10px;align-items:center;margin-top:10px}
</style>
</head>
<body>

<div class="top">
  <div class="title">Admin</div>
  <button class="btn2" id="logoutBtn">Çıkış</button>
</div>

<div class="wrap">
  <div class="panel" id="loginPanel">
    <div class="card">
      <div><b>Admin PIN</b></div>
      <input class="inp" id="pin" placeholder="PIN" inputmode="numeric" />
      <button class="btn" id="loginBtn">Giriş</button>
      <div class="mut" id="loginHint">PIN, Apps Script properties içindeki ADMIN_PIN ile eşleşmelidir.</div>
    </div>
  </div>

  <div class="panel" id="mainPanel" style="display:none">
    <div class="tabs">
      <div class="tab active" id="tJobs">Jobs</div>
      <div class="tab" id="tDrivers">Drivers</div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn2" id="refreshBtn" style="flex:1">Yenile</button>
      <button class="btn2" id="clearBtn" style="flex:1">Token Sil</button>
    </div>
  </div>

  <div class="list" id="list"></div>
</div>

<script>
const API = "PUT_YOUR_APPS_SCRIPT_WEBAPP_EXEC_URL_HERE";
const $ = id => document.getElementById(id);

function saveAdminToken(t){ localStorage.setItem("sepettaxi_admin_token", t); }
function loadAdminToken(){ return localStorage.getItem("sepettaxi_admin_token") || ""; }
function clearAdminToken(){ localStorage.removeItem("sepettaxi_admin_token"); }

async function apiPost(payload){
  const r = await fetch(API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
  return await r.json();
}
async function apiGet(params){
  const u = new URL(API);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,v));
  const r = await fetch(u.toString());
  return await r.json();
}

let tab = "jobs";

function setUI(logged){
  $("loginPanel").style.display = logged ? "none":"block";
  $("mainPanel").style.display = logged ? "block":"none";
  $("list").innerHTML = "";
}

function setTab(name){
  tab = name;
  $("tJobs").classList.toggle("active", tab==="jobs");
  $("tDrivers").classList.toggle("active", tab==="drivers");
  refresh();
}

$("tJobs").onclick = ()=> setTab("jobs");
$("tDrivers").onclick = ()=> setTab("drivers");

function renderJobs(items){
  const el = $("list");
  el.innerHTML = "";
  items.slice(0,200).forEach(j=>{
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div><b>${(j.service_type||"").toUpperCase()} • ${j.job_id}</b></div>
      <div class="mut">
        <div><b>Durum:</b> ${j.status}</div>
        <div><b>Driver:</b> ${j.driver_id||"-"}</div>
        <div><b>Nereden:</b> ${j.from_address||"-"}</div>
        <div><b>Nereye:</b> ${j.to_address||"-"}</div>
        <div><b>Mesafe:</b> ${Number(j.distance_km||0).toFixed(2)} km • <b>Ücret:</b> ${(j.final_price||j.price||"-")} ₺</div>
        <div><b>Oluşturma:</b> ${j.created_at||"-"}</div>
      </div>
    `;
    el.appendChild(div);
  });
}

function renderDrivers(items){
  const el = $("list");
  el.innerHTML = "";
  items.slice(0,200).forEach(d=>{
    const div = document.createElement("div");
    div.className = "item";
    const active = String(d.active).toUpperCase()==="TRUE";
    div.innerHTML = `
      <div><b>${d.driver_id} • ${String(d.vehicle_type||"").toUpperCase()}</b></div>
      <div class="mut">
        <div><b>Ad:</b> ${d.first||""} ${d.last||""}</div>
        <div><b>Tel:</b> ${d.phone||"-"} • <b>Plaka:</b> ${d.plate||"-"}</div>
        <div><b>Aktif:</b> ${active ? "TRUE":"FALSE"} • <b>Radius:</b> ${d.radius_km||5} km</div>
        <div><b>Son konum:</b> ${d.last_lat||"-"}, ${d.last_lng||"-"}</div>
        <div><b>Son seen:</b> ${d.last_seen_at||"-"}</div>
      </div>
      <div class="row">
        <button class="btn2" data-act="on" style="flex:1">Aktif</button>
        <button class="btn2" data-act="off" style="flex:1">Pasif</button>
      </div>
    `;
    div.querySelector('[data-act="on"]').onclick = ()=> setActive(d.driver_id, true);
    div.querySelector('[data-act="off"]').onclick = ()=> setActive(d.driver_id, false);
    el.appendChild(div);
  });
}

async function setActive(driver_id, active){
  const token = loadAdminToken();
  const res = await apiPost({ action:"adminSetDriverActive", token, driver_id, active: active ? "TRUE":"FALSE" });
  if(!res.ok) return alert("İşlem başarısız: " + (res.error||""));
  refresh();
}

async function refresh(){
  const token = loadAdminToken();
  if(!token) return;
  if(tab==="jobs"){
    const res = await apiGet({ action:"adminJobs", token });
    if(!res.ok) return alert("Yetkisiz: " + (res.error||""));
    renderJobs(res.jobs||[]);
  }else{
    const res = await apiGet({ action:"adminDrivers", token });
    if(!res.ok) return alert("Yetkisiz: " + (res.error||""));
    renderDrivers(res.drivers||[]);
  }
}

$("loginBtn").onclick = async ()=>{
  const pin = $("pin").value.trim();
  const res = await apiPost({ action:"adminLogin", pin });
  if(!res.ok) return alert("Giriş yok: " + (res.error||""));
  saveAdminToken(res.token);
  setUI(true);
  refresh();
};

$("refreshBtn").onclick = refresh;
$("clearBtn").onclick = ()=>{ clearAdminToken(); setUI(false); };
$("logoutBtn").onclick = ()=>{ clearAdminToken(); setUI(false); };

(function boot(){
  const t = loadAdminToken();
  if(t){ setUI(true); refresh(); }
  else setUI(false);
})();
</script>
</body>
</html>
