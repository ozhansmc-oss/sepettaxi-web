<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>SepetTaxi – Admin</title>
<meta name="theme-color" content="#050506" />
<style>
  *{box-sizing:border-box}
  :root{--y:#f5c400;--bg:#050506;--line:rgba(255,255,255,.10);--mut:rgba(255,255,255,.66)}
  html,body{margin:0;height:100%;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;overflow:hidden}
  header{height:56px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--line);background:rgba(5,5,6,.92);position:fixed;top:0;left:0;right:0;z-index:5000;font-weight:900}
  header b{color:var(--y)}
  .wrap{position:fixed;inset:56px 0 0 0;padding:12px;display:flex;flex-direction:column;gap:10px}
  .card{border:1px solid var(--line);background:rgba(255,255,255,.04);border-radius:18px;padding:12px}
  .label{font-size:11px;color:rgba(255,255,255,.42);margin-bottom:6px}
  .input{width:100%;height:44px;border-radius:14px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:#fff;padding:0 12px;outline:none}
  .row{display:flex;gap:10px}
  .btn{height:46px;border-radius:16px;border:1px solid var(--line);background:rgba(255,255,255,.06);color:#fff;font-weight:900;cursor:pointer;flex:1}
  .btn.primary{background:linear-gradient(180deg, rgba(245,196,0,.98), rgba(245,196,0,.78));color:#090909;border-color:rgba(0,0,0,.25)}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .list{overflow:auto;flex:1}
  .job{padding:10px;border:1px solid var(--line);border-radius:16px;background:rgba(255,255,255,.04);margin-bottom:10px}
  .job b{display:block}
  .job small{color:var(--mut)}
</style>
</head>
<body>
<header>Admin <b>Paneli</b></header>
<div class="wrap">
  <div class="card">
    <div class="label">Admin PIN</div>
    <input class="input" id="pin" placeholder="PIN" inputmode="numeric" />
    <div style="height:10px"></div>
    <div class="row">
      <button class="btn" id="btnLogout">Çıkış</button>
      <button class="btn primary" id="btnLogin">Giriş</button>
      <button class="btn primary" id="btnRefresh" disabled>Yenile</button>
    </div>
    <div style="margin-top:8px;color:var(--mut);font-size:12px" id="st">Durum: —</div>
  </div>

  <div class="list" id="list"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzQ5Nw3WJlOTkC5vrjQHyykHT3En-jmSkcdoBvgUC4v49n-MFFZhfKDBQ4Z1ehRLyWG/exec";
let token = localStorage.getItem("sepettaxi_admin_token") || "";

function $(id){ return document.getElementById(id); }
async function api(action, payload){
  const r = await fetch(API_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ action, ...payload }) });
  return await r.json();
}

function setState(){
  $("btnRefresh").disabled = !token;
  $("st").textContent = token ? "Durum: Yetkili" : "Durum: Giriş gerekli";
}

async function login(){
  const pin = $("pin").value.trim();
  if(!pin){ alert("PIN gir"); return; }
  const res = await api("adminLogin",{ pin });
  if(!res || !res.ok){ alert("Giriş hatası: "+(res.error||res.message||"")); return; }
  token = res.token;
  localStorage.setItem("sepettaxi_admin_token", token);
  setState();
  refresh();
}

function logout(){
  token = "";
  localStorage.removeItem("sepettaxi_admin_token");
  setState();
  $("list").innerHTML = "";
}

function jobCard(j){
  const div = document.createElement("div");
  div.className = "job";
  div.innerHTML = `
    <b>${j.service_type==="courier" ? "Kurye" : "Taksi"} – ${Number(j.final_price).toFixed(0)} ₺</b>
    <small>${j.job_id} • ${j.status}</small>
    <small style="display:block;margin-top:6px">${j.from_address}</small>
    <small style="display:block;margin-top:4px">${j.to_address}</small>
    <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
      <button class="btn">searching</button>
      <button class="btn">assigned</button>
      <button class="btn">active</button>
      <button class="btn">done</button>
      <button class="btn">cancelled</button>
    </div>
  `;
  const btns = div.querySelectorAll("button");
  btns.forEach(btn=>{
    btn.onclick = async ()=>{
      const st = btn.textContent.trim();
      const res = await api("adminSetStatus",{ token, job_id: j.job_id, status: st });
      if(!res || !res.ok){ alert("Status set edilemedi: "+(res.error||res.message||"")); return; }
      refresh();
    };
  });
  return div;
}

async function refresh(){
  if(!token){ alert("Yetki yok"); return; }
  $("list").innerHTML = "Yükleniyor…";
  const res = await api("adminListJobs",{ token });
  if(!res || !res.ok){
    $("list").innerHTML = "Liste alınamadı: " + (res.error||res.message||"");
    return;
  }
  const jobs = res.jobs || [];
  $("list").innerHTML = "";
  if(!jobs.length){
    $("list").innerHTML = "<div style='color:rgba(255,255,255,.65)'>Job yok.</div>";
    return;
  }
  jobs.forEach(j=> $("list").appendChild(jobCard(j)));
}

$("btnLogin").onclick = login;
$("btnLogout").onclick = logout;
$("btnRefresh").onclick = refresh;

setState();
if(token) refresh();
</script>
</body>
</html>
