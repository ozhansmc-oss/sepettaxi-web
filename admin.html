<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>SepetTaxi – Admin</title>
<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#000;color:#fff}
:root{--y:#f5c400}
header{height:56px;display:flex;align-items:center;justify-content:center;font-weight:900;border-bottom:1px solid #111}
header span{color:var(--y)}
.wrap{padding:12px;display:flex;flex-direction:column;gap:10px}
.card{background:#0f0f0f;border:1px solid #222;border-radius:16px;padding:12px}
.row{display:flex;gap:10px;align-items:center}
.input{width:100%;padding:12px;border-radius:14px;border:1px solid #222;background:#000;color:#fff}
.btn{padding:12px;border-radius:14px;border:1px solid #222;background:#121212;color:#fff;font-weight:900;cursor:pointer}
.btn.primary{background:var(--y);border-color:transparent;color:#000}
.small{font-size:12px;color:#aaa}
.tabs{display:flex;gap:8px}
.tab{flex:1;text-align:center;padding:12px;border-radius:14px;border:1px solid #222;background:#121212;cursor:pointer;font-weight:900}
.tab.active{border-color:rgba(245,196,0,.5)}
.list{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:12px;color:#ddd}
</style>
</head>
<body>
<header>Sepet<span>Taxi</span> – Admin</header>

<div class="wrap">
  <div class="card" id="loginCard">
    <div style="font-weight:900;margin-bottom:8px">Admin Giriş</div>
    <div class="row">
      <input id="pin" class="input" placeholder="PIN">
      <button id="login" class="btn primary">GİR</button>
    </div>
    <div class="small" id="loginMsg" style="margin-top:8px"></div>
  </div>

  <div class="card" id="panelCard" style="display:none">
    <div class="tabs">
      <div class="tab active" id="tJobs">Jobs</div>
      <div class="tab" id="tDrivers">Drivers</div>
      <div class="tab" id="tFinance">Finance</div>
    </div>

    <div style="height:10px"></div>

    <div id="jobsBox">
      <div class="row">
        <button class="btn" id="reloadJobs">Yenile</button>
        <input class="input" id="filterStatus" placeholder="status (opsiyonel)">
        <input class="input" id="filterSvc" placeholder="service_type (opsiyonel)">
      </div>
      <div style="height:10px"></div>
      <div class="list" id="jobsList">—</div>
    </div>

    <div id="driversBox" style="display:none">
      <button class="btn" id="reloadDrivers">Yenile</button>
      <div style="height:10px"></div>
      <div class="list" id="driversList">—</div>
    </div>

    <div id="financeBox" style="display:none">
      <div class="row">
        <input class="input" id="fStart" placeholder="start YYYY-MM-DD">
        <input class="input" id="fEnd" placeholder="end YYYY-MM-DD">
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <input class="input" id="fPeriod" placeholder="period day|month (day)">
        <button class="btn primary" id="reloadFinance">Getir</button>
      </div>
      <div style="height:10px"></div>
      <div class="list" id="financeOut">—</div>
    </div>
  </div>
</div>

<script>
const BACKEND_URL = "https://script.google.com/macros/s/AKfycbzTe03o0iBuNcXI2EwWWrCwbhUOMWKqm84izCod51H7yqo679U9pH0rujL1PpxEYehfhg/exec";
const TOKEN_KEY = "st_admin_token";

let token = localStorage.getItem(TOKEN_KEY) || "";

const $ = (id)=>document.getElementById(id);

$("login").onclick = login;

$("tJobs").onclick = ()=>tab("jobs");
$("tDrivers").onclick = ()=>tab("drivers");
$("tFinance").onclick = ()=>tab("finance");

$("reloadJobs").onclick = loadJobs;
$("reloadDrivers").onclick = loadDrivers;
$("reloadFinance").onclick = loadFinance;

boot();

async function boot(){
  if(token){
    const ok = await adminCheck();
    if(ok){
      $("loginCard").style.display="none";
      $("panelCard").style.display="block";
      loadJobs();
      return;
    }
    token=""; localStorage.removeItem(TOKEN_KEY);
  }
}

async function login(){
  const pin = $("pin").value.trim();
  $("loginMsg").textContent = "Giriş yapılıyor...";
  try{
    const url = `${BACKEND_URL}?action=adminAuth&pin=${encodeURIComponent(pin)}`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data || !data.ok || !data.token) throw new Error("auth failed");
    token = data.token;
    localStorage.setItem(TOKEN_KEY, token);
    $("loginMsg").textContent = "OK";
    $("loginCard").style.display="none";
    $("panelCard").style.display="block";
    loadJobs();
  }catch(e){
    $("loginMsg").textContent = "PIN hatalı / backend hatası.";
    console.error(e);
  }
}

async function adminCheck(){
  try{
    const res = await fetch(`${BACKEND_URL}?action=adminCheck&token=${encodeURIComponent(token)}`);
    const data = await res.json();
    return !!(data && data.ok);
  }catch(_){
    return false;
  }
}

function tab(which){
  $("tJobs").classList.toggle("active", which==="jobs");
  $("tDrivers").classList.toggle("active", which==="drivers");
  $("tFinance").classList.toggle("active", which==="finance");

  $("jobsBox").style.display = (which==="jobs") ? "block" : "none";
  $("driversBox").style.display = (which==="drivers") ? "block" : "none";
  $("financeBox").style.display = (which==="finance") ? "block" : "none";
}

async function loadJobs(){
  $("jobsList").textContent = "Yükleniyor...";
  const status = $("filterStatus").value.trim();
  const svc = $("filterSvc").value.trim();
  const url = `${BACKEND_URL}?action=listJobs&token=${encodeURIComponent(token)}&limit=80`
    + (status?`&status=${encodeURIComponent(status)}`:"")
    + (svc?`&service_type=${encodeURIComponent(svc)}`:"");
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(!data || !data.ok) throw new Error("unauthorized");
    $("jobsList").textContent = JSON.stringify(data.items||[], null, 2);
  }catch(e){
    $("jobsList").textContent = "Yüklenemedi (token / backend).";
    console.error(e);
  }
}

async function loadDrivers(){
  $("driversList").textContent = "Yükleniyor...";
  try{
    const res = await fetch(`${BACKEND_URL}?action=listDrivers&token=${encodeURIComponent(token)}`);
    const data = await res.json();
    if(!data || !data.ok) throw new Error("unauthorized");
    $("driversList").textContent = JSON.stringify(data.items||[], null, 2);
  }catch(e){
    $("driversList").textContent = "Yüklenemedi (token / backend).";
    console.error(e);
  }
}

async function loadFinance(){
  $("financeOut").textContent = "Yükleniyor...";
  const start = $("fStart").value.trim();
  const end = $("fEnd").value.trim();
  const period = ($("fPeriod").value.trim() || "day");
  const url = `${BACKEND_URL}?action=getFinance&token=${encodeURIComponent(token)}&period=${encodeURIComponent(period)}`
    + (start?`&start=${encodeURIComponent(start)}`:"")
    + (end?`&end=${encodeURIComponent(end)}`:"");
  try{
    const res = await fetch(url);
    const data = await res.json();
    if(!data || !data.ok) throw new Error("unauthorized");
    $("financeOut").textContent = JSON.stringify(data, null, 2);
  }catch(e){
    $("financeOut").textContent = "Yüklenemedi (token / backend).";
    console.error(e);
  }
}
</script>
</body>
</html>
