<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Admin Rapor</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#0b0b0b;color:#fff}
header{
  height:56px;display:flex;align-items:center;justify-content:center;
  font-weight:900;border-bottom:1px solid #222
}
header span{color:#f5c400}
.wrap{padding:14px;max-width:1200px;margin:auto}
.card{
  background:#111;border-radius:16px;padding:14px;margin-bottom:14px;
  border:1px solid #222
}
.grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px
}
.kpi{
  background:#0f0f0f;border-radius:14px;padding:12px;text-align:center;
  border:1px solid #1f1f1f
}
.kpi .lbl{font-size:12px;color:#aaa}
.kpi .val{font-size:22px;font-weight:900;margin-top:6px}

table{
  width:100%;border-collapse:collapse;font-size:12px
}
th,td{
  padding:8px;border-bottom:1px solid #222;text-align:left
}
th{color:#f5c400;font-weight:900}
tr:hover{background:#151515}

.badge{
  padding:4px 8px;border-radius:999px;font-size:11px;
  background:#222;color:#aaa
}
.ok{background:#1f6f3f;color:#9fffc7}
.cancel{background:#6f1f1f;color:#ffb0b0}
.pending{background:#444}

.small{font-size:11px;color:#aaa}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> – Admin Rapor</header>

<div class="wrap">

<!-- KPI -->
<div class="card">
  <div class="grid">
    <div class="kpi"><div class="lbl">Toplam İş</div><div id="kTotal" class="val">—</div></div>
    <div class="kpi"><div class="lbl">Tamamlanan</div><div id="kCompleted" class="val">—</div></div>
    <div class="kpi"><div class="lbl">İptal</div><div id="kCancelled" class="val">—</div></div>
    <div class="kpi"><div class="lbl">Toplam Ciro</div><div id="kRevenue" class="val">—</div></div>
    <div class="kpi"><div class="lbl">Platform Geliri</div><div id="kCommission" class="val">—</div></div>
  </div>
</div>

<!-- DAILY -->
<div class="card">
  <b>Bugün</b>
  <div class="grid" style="margin-top:10px">
    <div class="kpi"><div class="lbl">İş</div><div id="dJobs" class="val">—</div></div>
    <div class="kpi"><div class="lbl">Ciro</div><div id="dRevenue" class="val">—</div></div>
    <div class="kpi"><div class="lbl">İptal</div><div id="dCancel" class="val">—</div></div>
  </div>
</div>

<!-- TABLE -->
<div class="card">
  <b>İş Detayları</b>
  <div style="overflow:auto;margin-top:10px">
    <table>
      <thead>
        <tr>
          <th>Job</th>
          <th>Durum</th>
          <th>Sürücü</th>
          <th>Mesafe</th>
          <th>Ücret</th>
          <th>Komisyon</th>
          <th>Tarih</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const COMMISSION = 0.15;

load();

async function load(){
  const jobs = await fetch(`${BACKEND}?action=getJobs`).then(r=>r.json());

  let total=0, completed=0, cancelled=0;
  let revenue=0, commission=0;

  const today = new Date().toISOString().slice(0,10);
  let dJobs=0,dRev=0,dCancel=0;

  rows.innerHTML="";

  jobs.slice().reverse().forEach(j=>{
    total++;

    const price = Number(j.final_price||0);
    const comm = price * COMMISSION;

    if(j.status==="completed"){
      completed++;
      revenue+=price;
      commission+=comm;
    }
    if(j.status==="cancelled") cancelled++;

    if(String(j.created_at||"").startsWith(today)){
      dJobs++;
      if(j.status==="completed") dRev+=price;
      if(j.status==="cancelled") dCancel++;
    }

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${j.job_id}</td>
      <td>
        <span class="badge ${
          j.status==="completed"?"ok":
          j.status==="cancelled"?"cancel":"pending"
        }">${j.status}</span>
      </td>
      <td>${j.driver_id||"-"}</td>
      <td>${Number(j.distance_km||0).toFixed(2)} km</td>
      <td>${price.toFixed(0)} TL</td>
      <td>${comm.toFixed(0)} TL</td>
      <td class="small">${(j.created_at||"").slice(0,16).replace("T"," ")}</td>
    `;
    rows.appendChild(tr);
  });

  kTotal.innerText = total;
  kCompleted.innerText = completed;
  kCancelled.innerText = cancelled;
  kRevenue.innerText = revenue.toFixed(0)+" TL";
  kCommission.innerText = commission.toFixed(0)+" TL";

  dJobs.innerText = dJobs;
  dRevenue.innerText = dRev.toFixed(0)+" TL";
  dCancel.innerText = dCancel;
}
</script>

</body>
</html>
