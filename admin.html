<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SepetTaxi – Admin B1</title>

<style>
body{margin:0;font-family:Arial;background:#000;color:#fff}
header{height:56px;display:flex;align-items:center;justify-content:center;border-bottom:1px solid #222;font-weight:900}
header span{color:#f5c400}
.wrap{max-width:1100px;margin:auto;padding:16px}
.job{background:#121212;border:1px solid #222;border-radius:14px;padding:14px;margin-bottom:12px;cursor:pointer}
.row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.badge{padding:6px 10px;border-radius:10px;font-weight:900;font-size:13px}
.pending{background:#444}
.assigned{background:#555}
.on_route{background:#f5c400;color:#000}
.completed{background:#2ecc71;color:#000}
.muted{color:#aaa;font-size:13px}
button{padding:12px 14px;border-radius:12px;border:none;font-weight:900;cursor:pointer}
.btn{background:#f5c400;color:#000}
.btn.ghost{background:#000;color:#fff;border:1px solid #333}
.modalBack{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center}
.modalBack.show{display:flex}
.modal{background:#121212;border-radius:16px;padding:16px;width:90%;max-width:520px}
select{width:100%;padding:12px;border-radius:12px;background:#000;color:#fff;border:1px solid #333;margin-bottom:10px}
</style>
</head>

<body>

<header>Sepet<span>Taxi</span> – Admin B1</header>

<div class="wrap">
  <div id="jobs"></div>
</div>

<!-- MODAL -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <h3>İş Detayı</h3>

    <div class="muted">Job ID</div>
    <b id="mJob"></b><br><br>

    <div class="muted">Durum</div>
    <select id="mStatus">
      <option value="pending">pending</option>
      <option value="assigned">assigned</option>
      <option value="on_route">on_route</option>
      <option value="completed">completed</option>
    </select>

    <div class="muted">Sürücü Ata</div>
    <select id="mDriver"></select>

    <button class="btn" onclick="assign()">Ata</button>
    <button class="btn" onclick="updateStatus()">Durum Güncelle</button>

    <hr style="margin:14px 0;border-color:#222">

    <button class="btn ghost" onclick="copyTrackLink()">Track Link Kopyala</button>

    <br><br>
    <button class="btn ghost" onclick="closeModal()">Kapat</button>
  </div>
</div>

<script>
/* =============================
   SABİT BACKEND (GÖMÜLÜ)
   ============================= */
const BACKEND =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

const TRACK_BASE =
"https://ozhansmc-oss.github.io/sepettaxi-web/track.html";

let JOBS=[];
let DRIVERS=[];
let current=null;

/* =============================
   LOAD
   ============================= */
async function load(){
  const j = await (await fetch(`${BACKEND}?action=getJobs`)).json();
  JOBS = j;

  const d = await (await fetch(`${BACKEND}?action=getDrivers`)).json();
  DRIVERS = d;

  render();
}

function render(){
  jobs.innerHTML="";
  JOBS.forEach(j=>{
    const div=document.createElement("div");
    div.className="job";
    div.innerHTML=`
      <div class="row">
        <div>
          <b>${j.job_id}</b><br>
          <span class="muted">${j.service_type} · ${j.distance_km||0} km · ${j.estimated_price||0}</span>
        </div>
        <span class="badge ${j.status}">${j.status}</span>
      </div>
    `;
    div.onclick=()=>open(j.job_id);
    jobs.appendChild(div);
  });
}

/* =============================
   MODAL
   ============================= */
function open(id){
  current = JOBS.find(x=>x.job_id===id);
  mJob.innerText=current.job_id;
  mStatus.value=current.status;

  mDriver.innerHTML=`<option value="">Sürücü seç</option>`;
  DRIVERS.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.driver_id;
    o.textContent=d.driver_name||d.driver_id;
    mDriver.appendChild(o);
  });

  modalBack.classList.add("show");
}

function closeModal(){
  modalBack.classList.remove("show");
  current=null;
}

/* =============================
   ACTIONS
   ============================= */
async function assign(){
  if(!mDriver.value) return alert("Sürücü seç");
  await fetch(`${BACKEND}?action=assignDriver&job_id=${current.job_id}&driver_id=${mDriver.value}`);
  closeModal();
  load();
}

async function updateStatus(){
  await fetch(`${BACKEND}?action=updateStatus&job_id=${current.job_id}&status=${mStatus.value}`);
  closeModal();
  load();
}

/* =============================
   TRACK LINK
   ============================= */
function copyTrackLink(){
  if(!current.track_token){
    alert("Bu job için token yok");
    return;
  }
  const link =
    TRACK_BASE +
    "?job_id=" + encodeURIComponent(current.job_id) +
    "&token=" + encodeURIComponent(current.track_token);

  navigator.clipboard.writeText(link)
    .then(()=>alert("Track link kopyalandı"))
    .catch(()=>prompt("Kopyala:",link));
}

/* INIT */
load();
</script>

</body>
</html>
