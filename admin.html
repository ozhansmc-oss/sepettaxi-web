<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>SepetTaxi – Admin</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f6f8}
header{background:#0f172a;color:#fff;padding:14px 16px;font-weight:bold}
.container{padding:14px}
.summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.card{background:#fff;border-radius:10px;padding:12px}
.card h3{margin:0;font-size:14px;color:#334155}
.card b{font-size:22px}
.controls{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
select,button,input{padding:8px;border-radius:6px;border:1px solid #cbd5e1}
button{background:#2563eb;color:#fff;border:none;cursor:pointer}
button.secondary{background:#475569}
.jobs{display:grid;grid-template-columns:1fr;gap:12px}
.job{background:#fff;border-radius:10px;padding:12px}
.row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:999px;font-size:12px;color:#000}
.pending{background:#fde68a}
.accepted{background:#bfdbfe}
.on_the_way{background:#bbf7d0}
.completed{background:#e5e7eb}
.small{font-size:12px;color:#475569}
.actions{display:flex;gap:6px;flex-wrap:wrap}
.link{color:#2563eb;text-decoration:none;font-size:12px}
@media(min-width:900px){.jobs{grid-template-columns:repeat(2,1fr)}}
</style>
</head>

<body>

<header>SepetTaxi – Admin (Operasyon & Ödeme)</header>

<div class="container">

  <!-- ÖZET -->
  <div class="summary">
    <div class="card"><h3>Bugün</h3><b id="s_today">0</b></div>
    <div class="card"><h3>Aktif</h3><b id="s_active">0</b></div>
    <div class="card"><h3>Toplam</h3><b id="s_total">0</b></div>
  </div>

  <!-- KONTROLLER -->
  <div class="controls">
    <select id="filter">
      <option value="">Tümü</option>
      <option value="pending">Bekliyor</option>
      <option value="accepted">Kabul</option>
      <option value="on_the_way">Yolda</option>
      <option value="completed">Bitti</option>
    </select>
    <button onclick="loadAll()">Yenile</button>
  </div>

  <!-- JOBS -->
  <div id="jobs" class="jobs"></div>

</div>

<script>
/* ================== AYAR ================== */
const API_URL = "https://script.google.com/macros/s/AKfycbxGK3XXKVX-65ZfRCtGhMdIoOgV6RAx7tSldcBW3ugRzB7_T3Bv2DLsCazrpLgYPwg0/exec";
/* ========================================= */

function badgeClass(s){
  if(s==="pending") return "badge pending";
  if(s==="accepted") return "badge accepted";
  if(s==="on_the_way") return "badge on_the_way";
  if(s==="completed") return "badge completed";
  return "badge";
}

function statusLabel(s){
  if(s==="pending") return "Bekliyor";
  if(s==="accepted") return "Kabul";
  if(s==="on_the_way") return "Yolda";
  if(s==="completed") return "Bitti";
  return s;
}

/* ===== STATS ===== */
function loadStats(){
  fetch(API_URL + "?action=adminStats")
    .then(r=>r.json())
    .then(d=>{
      document.getElementById("s_today").innerText  = d.today ?? 0;
      document.getElementById("s_active").innerText = d.active ?? 0;
      document.getElementById("s_total").innerText  = d.total ?? 0;
    });
}

/* ===== JOBS ===== */
function loadJobs(){
  const f = document.getElementById("filter").value;
  fetch(API_URL + "?action=getJobs" + (f ? "&status="+f : ""))
    .then(r=>r.json())
    .then(list=>{
      const el = document.getElementById("jobs");
      el.innerHTML = "";

      list.forEach(j=>{
        el.innerHTML += `
          <div class="job">
            <div class="row">
              <div>
                <b>${j.service_type || "-"}</b><br>
                <span class="small">${j.job_id}</span>
              </div>
              <span class="${badgeClass(j.status)}">${statusLabel(j.status)}</span>
            </div>

            <div class="small" style="margin-top:6px">
              Oluştu: ${j.created_at || "-"} |
              Kabul: ${j.accepted_at || "-"} |
              Yolda: ${j.on_the_way_at || "-"} |
              Bitti: ${j.completed_at || "-"}
            </div>

            <div class="row" style="margin-top:8px">
              <div class="actions">
                <button class="secondary" onclick="setStatus('${j.job_id}','accepted')">Kabul</button>
                <button class="secondary" onclick="setStatus('${j.job_id}','on_the_way')">Yolda</button>
                <button onclick="setStatus('${j.job_id}','completed')">Bitti</button>
                <a class="link" target="_blank" href="track.html?job_id=${j.job_id}">Canlı Takip</a>
              </div>
              <div class="small">Driver: ${j.driver_id || "-"}</div>
            </div>

            <div class="row" style="margin-top:8px">
              <input placeholder="Driver ID" id="d_${j.job_id}">
              <button onclick="assignDriver('${j.job_id}')">Ata</button>
            </div>

            <div class="row" style="margin-top:8px">
              <input placeholder="Tutar ₺" id="p_${j.job_id}">
              <select id="m_${j.job_id}">
                <option value="cash">Nakit</option>
                <option value="card">Kart</option>
              </select>
              <button onclick="payJob('${j.job_id}')">Paid</button>
            </div>
          </div>
        `;
      });
    });
}

/* ===== ACTIONS ===== */
function setStatus(jobId,status){
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"updateStatus",job_id:jobId,status})
  }).then(loadAll);
}

function assignDriver(jobId){
  const d = document.getElementById("d_"+jobId).value;
  if(!d) return alert("Driver ID gir");
  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action:"updateStatus",job_id:jobId,status:"accepted",driver_id:d})
  }).then(loadAll);
}

function payJob(jobId){
  const amount = document.getElementById("p_"+jobId).value;
  const method = document.getElementById("m_"+jobId).value;
  if(!amount) return alert("Tutar gir");

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"savePayment",
      job_id:jobId,
      driver_id:"",
      amount,
      method
    })
  }).then(()=>alert("Ödeme kaydedildi"));
}

function loadAll(){
  loadStats();
  loadJobs();
}

/* INIT */
loadAll();
setInterval(loadAll,30000);
</script>

</body>
</html>
