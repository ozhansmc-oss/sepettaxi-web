<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>SepetTaxi | Admin</title>
<meta name="theme-color" content="#f5c400">
<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;background:#050506;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
:root{--y:#f5c400;--line:rgba(255,255,255,.1)}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:16px}
.card{
  width:100%;max-width:420px;
  background:#141416;border:1px solid var(--line);border-radius:18px;padding:16px
}
h1{margin:0 0 12px;font-size:18px}
input{
  width:100%;padding:12px;border-radius:14px;
  border:1px solid var(--line);background:#000;color:#fff;font-weight:800
}
button{
  width:100%;padding:14px;border-radius:16px;
  border:0;background:var(--y);color:#000;font-weight:900;cursor:pointer
}
.list{margin-top:12px}
.item{
  padding:10px;border-radius:12px;border:1px solid var(--line);
  margin-bottom:8px;font-size:13px
}
.badge{font-weight:900}
.ok{color:#2bd576}
.no{color:#ff4d4d}
.top{
  display:flex;justify-content:space-between;align-items:center;margin-bottom:10px
}
.small{font-size:12px;opacity:.6}
</style>
</head>
<body>

<div class="wrap">
  <div class="card" id="loginCard">
    <h1>Admin Giriş</h1>
    <input id="pin" placeholder="Admin PIN" type="password">
    <div style="height:12px"></div>
    <button onclick="login()">Giriş</button>
    <div class="small" style="margin-top:8px">Yetkisiz erişimler loglanır.</div>
  </div>

  <div class="card" id="panelCard" style="display:none">
    <div class="top">
      <h1>Admin Panel</h1>
      <button onclick="logout()" style="width:auto;padding:8px 12px">Çıkış</button>
    </div>

    <button onclick="loadDrivers()">Sürücüleri Listele</button>

    <div class="list" id="list"></div>
  </div>
</div>

<script>
/* ========= CONFIG ========= */
const API = "https://script.google.com/macros/s/AKfycbxoeXl9XfxWtsqqCfftNV578KD_woNSKfT3KmSYwZuCv8iPSPd8-cZXNoYMh6Qx-yrlWA/exec";

/* ========= STATE ========= */
const ADMIN_KEY = "stx_admin_pin";

/* ========= API ========= */
async function api(action, payload){
  const pin = localStorage.getItem(ADMIN_KEY) || "";
  const r = await fetch(API, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ action, pin, ...(payload||{}) })
  });
  const j = await r.json();
  if(j.error) throw new Error(j.error);
  return j;
}

/* ========= AUTH ========= */
async function login(){
  const p = document.getElementById("pin").value.trim();
  if(!p){ alert("PIN gir"); return; }
  localStorage.setItem(ADMIN_KEY, p);
  try{
    await api("adminPing");
    showPanel();
  }catch(e){
    localStorage.removeItem(ADMIN_KEY);
    alert("PIN yanlış");
  }
}

function logout(){
  localStorage.removeItem(ADMIN_KEY);
  location.reload();
}

function showPanel(){
  document.getElementById("loginCard").style.display="none";
  document.getElementById("panelCard").style.display="block";
}

/* ========= DATA ========= */
async function loadDrivers(){
  const list = document.getElementById("list");
  list.innerHTML = "Yükleniyor…";
  try{
    const r = await api("adminListDrivers");
    list.innerHTML = "";
    r.drivers.forEach(d=>{
      const div = document.createElement("div");
      div.className="item";
      div.innerHTML = `
        <div><b>${d.first} ${d.last}</b> (${d.phone})</div>
        <div class="small">
          Onay: <span class="badge ${d.approved?'ok':'no'}">${d.approved?'EVET':'HAYIR'}</span> ·
          Sözleşme: <span class="badge ${d.contract_accepted?'ok':'no'}">${d.contract_accepted?'EVET':'HAYIR'}</span>
        </div>
        <div style="margin-top:6px">
          <button onclick="approve('${d.driver_id}')">Onayla</button>
          <button onclick="reject('${d.driver_id}')">Reddet</button>
        </div>
      `;
      list.appendChild(div);
    });
  }catch(e){
    list.innerHTML = "Hata: " + e.message;
  }
}

async function approve(id){
  if(!confirm("Sürücü onaylansın mı?")) return;
  await api("adminApproveDriver",{driver_id:id});
  loadDrivers();
}
async function reject(id){
  const r = prompt("Reddetme nedeni","");
  if(!r) return;
  await api("adminRejectDriver",{driver_id:id,reason:r});
  loadDrivers();
}

/* ========= INIT ========= */
(async function(){
  const pin = localStorage.getItem(ADMIN_KEY);
  if(pin){
    try{
      await api("adminPing");
      showPanel();
    }catch(e){
      localStorage.removeItem(ADMIN_KEY);
    }
  }
})();
</script>
</body>
</html>
