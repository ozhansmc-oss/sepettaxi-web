<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SepetTaxi – Admin (B1)</title>

<style>
:root{
  --bg:#000;--card:#141414;--card2:#1b1b1b;--text:#fff;--muted:#bdbdbd;
  --line:#2a2a2a;--accent:#f5c400;--ok:#27c24c;--warn:#ffb020;
  --chip:#222;--r:16px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
header{height:56px;background:#000;border-bottom:1px solid var(--line);
display:flex;align-items:center;justify-content:center;position:sticky;top:0;z-index:20}
header .brand{font-weight:900}
header .brand span{color:var(--accent)}
.wrap{max-width:1100px;margin:auto;padding:14px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:12px}
.kpi{grid-column:span 4}
.kpi .label{color:var(--muted);font-size:12px}
.kpi .value{font-size:26px;font-weight:900}
.panel{grid-column:span 12}
.job{display:grid;grid-template-columns:1.2fr .9fr .8fr .8fr .9fr .9fr;
gap:10px;padding:12px;border-radius:14px;background:var(--card2);
border:1px solid var(--line);margin-bottom:10px;cursor:pointer}
.colTitle{color:var(--muted);font-size:11px}
.colVal{font-weight:800;font-size:13px}
.chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;
border-radius:999px;background:var(--chip);font-size:12px;font-weight:900}
.dot{width:8px;height:8px;border-radius:99px}
.st-pending .dot{background:var(--warn)}
.st-assigned .dot{background:#5aa7ff}
.st-on_route .dot{background:var(--accent)}
.st-completed .dot{background:var(--ok)}
.empty{padding:18px;border:1px dashed var(--line);border-radius:14px;
color:var(--muted);text-align:center}
.modalBack{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
align-items:flex-end;justify-content:center;padding:10px}
.modalBack.show{display:flex}
.modal{background:#141414;border-radius:20px;max-width:720px;width:100%;
border:1px solid var(--line)}
.modalHead{padding:12px;border-bottom:1px solid var(--line);
display:flex;justify-content:space-between}
.modalBody{padding:12px}
.btn{padding:10px 12px;border-radius:12px;border:0;font-weight:900;cursor:pointer}
.btn.main{background:#fff;color:#000}
.btn.ghost{background:transparent;color:#fff;border:1px solid var(--line)}
.select{width:100%;padding:10px;border-radius:12px;background:#0f0f0f;
color:#fff;border:1px solid var(--line)}
</style>
</head>

<body>

<header>
  <div class="brand">Sepet<span>Taxi</span> – Admin B1</div>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card kpi"><div class="label">Bugünkü İş</div><div id="kToday" class="value">0</div></div>
    <div class="card kpi"><div class="label">Aktif İş</div><div id="kActive" class="value">0</div></div>
    <div class="card kpi"><div class="label">Tamamlanan</div><div id="kDone" class="value">0</div></div>

    <div class="card panel">
      <div id="list"></div>
      <div id="empty" class="empty" style="display:none">Kayıt yok</div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modalBack" class="modalBack">
  <div class="modal">
    <div class="modalHead">
      <b>İş Detayı</b>
      <button class="btn ghost" onclick="closeModal()">Kapat</button>
    </div>
    <div class="modalBody">
      <div><b id="mJob"></b></div>
      <div id="mRoute"></div><br>

      <select id="driverSelect" class="select"></select><br><br>
      <button class="btn main" onclick="assign()">Sürücü Ata</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const BACKEND_URL =
"https://script.google.com/macros/s/AKfycbzzwdIUkPheKBoJS3U13pvrFMi9VutO-M0gM-LRfDnUnrk6JwrBAevMKp9a4Ecy6Dcy/exec";

/* ================= STATE ================= */
let jobs=[],drivers=[],current=null;

/* ================= API ================= */
const api=(a,p={})=>fetch(BACKEND_URL,{
  method:"POST",body:JSON.stringify({action:a,...p})
}).then(r=>r.json());

/* ================= LOAD ================= */
async function load(){
  drivers=(await api("getDrivers")).filter(d=>d.status==="approved");
  jobs=await api("getJobs");

  let t=0,a=0,d=0;
  const today=new Date().toDateString();

  jobs.forEach(j=>{
    if(new Date(j.created_at).toDateString()===today) t++;
    if(["pending","assigned","on_route"].includes(j.status)) a++;
    if(j.status==="completed") d++;
  });

  kToday.textContent=t;
  kActive.textContent=a;
  kDone.textContent=d;

  render();
}

function render(){
  list.innerHTML="";
  if(jobs.length===0){empty.style.display="block";return}
  empty.style.display="none";

  jobs.forEach(j=>{
    const el=document.createElement("div");
    el.className="job";
    el.innerHTML=`
      <div><div class="colTitle">Job</div><div class="colVal">${j.job_id}</div></div>
      <div><div class="colTitle">Hizmet</div><div class="colVal">${j.service_type}</div></div>
      <div><div class="colTitle">Mesafe</div><div class="colVal">${j.distance_km||0} km</div></div>
      <div><div class="colTitle">Fiyat</div><div class="colVal">${j.final_price||j.price}</div></div>
      <div class="chip st-${j.status}"><span class="dot"></span>${j.status}</div>
      <div><div class="colTitle">Sürücü</div><div class="colVal">${j.driver_id||"—"}</div></div>
    `;
    el.onclick=()=>open(j);
    list.appendChild(el);
  });
}

function open(j){
  current=j;
  mJob.textContent=j.job_id;
  mRoute.textContent=`${j.from_address} → ${j.to_address}`;
  driverSelect.innerHTML="<option value=''>Sürücü seç</option>";
  drivers.forEach(d=>{
    const o=document.createElement("option");
    o.value=d.driver_id;
    o.textContent=`${d.first_name} ${d.last_name}`;
    driverSelect.appendChild(o);
  });
  modalBack.classList.add("show");
}

function closeModal(){modalBack.classList.remove("show")}

async function assign(){
  if(!driverSelect.value) return alert("Sürücü seç");
  await api("assignDriver",{job_id:current.job_id,driver_id:driverSelect.value});
  closeModal();
  load();
}

load();
</script>
</body>
</html>
