<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SepetTaxi â€“ Admin</title>

<style>
body{margin:0;font-family:Arial;background:#f6f7f9}
.header{background:#0f172a;color:#fff;padding:14px;font-weight:bold}
.container{padding:14px}
.summary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:12px}
.box{background:#fff;border-radius:10px;padding:10px;text-align:center}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
select,button,input{padding:8px;border-radius:6px;border:1px solid #ddd}
button{cursor:pointer;background:#2563eb;color:#fff;border:none}
button.gray{background:#6b7280}
button.green{background:#059669}
.jobs{display:grid;grid-template-columns:1fr;gap:12px}
.card{background:#fff;border-radius:10px;padding:12px}
.row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:12px;font-size:12px}
.pending{background:#fde68a}
.accepted{background:#bfdbfe}
.on_the_way{background:#bbf7d0}
.completed{background:#e5e7eb}
.small{font-size:12px;color:#374151}
@media(min-width:900px){.jobs{grid-template-columns:repeat(2,1fr)}}
</style>
</head>

<body>

<div class="header">SepetTaxi â€“ Admin (Operasyon & Ã–deme)</div>

<div class="container">

  <!-- Ã–ZET -->
  <div class="summary">
    <div class="box"><b id="s_today">0</b><br>BugÃ¼n</div>
    <div class="box"><b id="s_active">0</b><br>Aktif</div>
    <div class="box"><b id="s_total">0</b><br>Toplam</div>
  </div>

  <!-- FÄ°LTRE -->
  <div class="controls">
    <select id="filter" onchange="loadJobs()">
      <option value="">TÃ¼mÃ¼</option>
      <option value="pending">Bekliyor</option>
      <option value="accepted">Kabul</option>
      <option value="on_the_way">Yolda</option>
      <option value="completed">TamamlandÄ±</option>
    </select>
    <button class="gray" onclick="loadJobs()">Yenile</button>
  </div>

  <div id="jobs" class="jobs"></div>
</div>

<script>
/* ================== AYAR ================== */
const OPS_API_URL = "https://script.google.com/macros/s/AKfycbwylTGMdtaTej82k5T66RfUBmenSWLIZNURDHZN5ASjtznrkQGw3m_lklKcOil-qZ8m/exec";
const FINANCE_API_URL = "https://script.google.com/macros/s/AKfycbwylTGMdtaTej82k5T66RfUBmenSWLIZNURDHZN5ASjtznrkQGw3m_lklKcOil-qZ8m/exec";
/* ========================================= */

function post(url,data){
  return fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(data)
  }).then(r=>r.json());
}

function loadJobs(){
  const f = document.getElementById("filter").value;
  fetch(OPS_API_URL + "?action=getJobs" + (f ? "&status="+f : ""))
    .then(r=>r.json())
    .then(list=>{
      document.getElementById("jobs").innerHTML="";
      updateSummary(list);

      list.forEach(j=>{
        document.getElementById("jobs").innerHTML += `
          <div class="card">
            <div class="row">
              <div>
                <b>${j.service_type}</b><br>
                <span class="small">${j.job_id}</span>
              </div>
              <span class="badge ${j.status}">${j.status}</span>
            </div>

            <div class="small" style="margin-top:4px">
              OluÅŸtu: ${j.created_at || "-"} |
              Kabul: ${j.accepted_at || "-"} |
              Bitti: ${j.completed_at || "-"}
            </div>

            <div class="row" style="margin-top:8px">
              <div class="small">Driver: ${j.driver_id || "-"}</div>
              <div>
                ${j.status!=="completed"
                  ? `<button onclick="setStatus('${j.job_id}','completed')">TamamlandÄ±</button>`
                  : `<span class="small">âœ” TamamlandÄ±</span>`
                }
              </div>
            </div>

            <!-- FAZ 5 â€“ Ã–DEME OLUÅžTUR -->
            ${j.status==="completed" ? `
            <div class="row" style="margin-top:10px">
              <button class="green"
                onclick="createPaymentFromAdmin(
                  '${j.job_id}',
                  '${j.estimated_price || j.fixed_price || 0}'
                )">
                ðŸ’° Ã–deme OluÅŸtur
              </button>
            </div>
            ` : ``}
          </div>
        `;
      });
    });
}

function setStatus(jobId,status){
  post(OPS_API_URL,{
    action:"updateStatus",
    job_id:jobId,
    status:status
  }).then(loadJobs);
}

/* ========= FAZ 5 â€“ ADMIN â†’ FINANCE ========= */
function createPaymentFromAdmin(jobId,gross){
  if(!gross || gross<=0){
    return alert("Bu iÅŸ iÃ§in brÃ¼t tutar yok");
  }
  if(!confirm("Bu iÅŸ iÃ§in Ã¶deme oluÅŸturulsun mu?")) return;

  post(FINANCE_API_URL,{
    action:"createPayment",
    job_id:jobId,
    gross_amount:Number(gross),
    payment_method:"cash"
  })
  .then(res=>{
    if(res.status==="payment_created"){
      alert("Ã–deme oluÅŸturuldu. Finance ekranÄ±nda gÃ¶rÃ¼necek.");
    }else{
      alert("Hata: "+JSON.stringify(res));
    }
  });
}

function updateSummary(list){
  document.getElementById("s_total").innerText = list.length;
  document.getElementById("s_active").innerText =
    list.filter(j=>["pending","accepted","on_the_way"].includes(j.status)).length;
  document.getElementById("s_today").innerText =
    list.filter(j=>j.created_at &&
      new Date(j.created_at).toDateString()===new Date().toDateString()
    ).length;
}

/* INIT */
loadJobs();
setInterval(loadJobs,30000);
</script>

</body>
</html>
